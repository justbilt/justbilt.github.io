<?xml version="1.0" encoding="utf-8"?>
<feed xmlns="http://www.w3.org/2005/Atom">
  <title>I&#39;m bilt.</title>
  <subtitle>A game developer</subtitle>
  <link href="/atom.xml" rel="self"/>
  
  <link href="http://blog.justbilt.com/"/>
  <updated>2017-04-09T13:06:00.000Z</updated>
  <id>http://blog.justbilt.com/</id>
  
  <author>
    <name>justbilt</name>
    <email>wangbilt@gmail.com</email>
  </author>
  
  <generator uri="http://hexo.io/">Hexo</generator>
  
  <entry>
    <title>多说, 再见 !</title>
    <link href="http://blog.justbilt.com/2017/03/25/bye-duoshuo-bye-comment/"/>
    <id>http://blog.justbilt.com/2017/03/25/bye-duoshuo-bye-comment/</id>
    <published>2017-03-25T01:30:30.000Z</published>
    <updated>2017-04-09T13:06:00.000Z</updated>
    
    <content type="html">&lt;p&gt;大约是在前几天刷微博的时候看到有人说多说要关站了, 赶紧去备份评论 balabala … , 难以置信, 赶紧去我的邮箱找了下, 果然找到了这封邮件:&lt;/p&gt;
&lt;p&gt;&lt;img src=&quot;https://ww3.sinaimg.cn/large/006tNbRwly1fdyu57rth7j30pi08bab4.jpg&quot; alt=&quot;&quot;&gt;&lt;/p&gt;
&lt;p&gt;震惊 !!! 依然难以置信 !!!&lt;/p&gt;
&lt;p&gt;我急忙把这个消息转发到了公司的微信群里, 却很快就被其他消息淹没, 没有激起一点浪花.&lt;/p&gt;
&lt;p&gt;&lt;img src=&quot;https://ww2.sinaimg.cn/large/006tNbRwly1fdyuh2osr9j30bu0j2gmh.jpg&quot; alt=&quot;&quot;&gt;&lt;/p&gt;
&lt;p&gt;他们可能也很奇怪, 多说是什么鬼, 关闭了和我有什么关系 ? 嗯哪, 毕竟写博和读博都只是小众的需求.&lt;/p&gt;
&lt;p&gt;将时间拨回 2013 年, 那时我刚把博客从 WordPress 切换到 hexo, 那时 hexo 的默认评论还是 disqus 呢, 由于众所周知的原因, 速度非常慢. 经过一番查找, 选择了多说, 速度快, 还支持国内的各种社交账号登录, 免费, 很良心.&lt;/p&gt;
&lt;p&gt;&lt;img src=&quot;https://ww4.sinaimg.cn/large/006tNbRwly1fdyujgpr90j30um0kk0wp.jpg&quot; alt=&quot;&quot;&gt;&lt;/p&gt;
&lt;p&gt;我在新博客写的第一篇文章是 &lt;a href=&quot;/2013/11/03/elbow/&quot;&gt;&amp;lt;&amp;lt;弯管(拐角)对方向的改变&amp;gt;&amp;gt;&lt;/a&gt; ,时间 &lt;code&gt;2013/11/03&lt;/code&gt;, 收到的第一条评论是:&lt;/p&gt;
&lt;p&gt;&lt;img src=&quot;https://ww4.sinaimg.cn/large/006tNbRwly1fdyuxow26aj30nf022weq.jpg&quot; alt=&quot;&quot;&gt;&lt;/p&gt;
&lt;p&gt;是 firedragonpzy 兄发来的[给力], 这么多年过去了, 不知他现在做什么?　&lt;/p&gt;
&lt;p&gt;最后一篇有多说评论的文章是 &lt;a href=&quot;/2017/02/24/some-change-for-blog/&quot;&gt;&amp;lt;&amp;lt;最近博客的一些变化&amp;gt;&amp;gt;&lt;/a&gt;, 时间 &lt;code&gt;2017/02/24&lt;/code&gt;, 是回复山人的吐槽:&lt;/p&gt;
&lt;p&gt;&lt;img src=&quot;https://ww4.sinaimg.cn/large/006tNbRwly1fdyv73hz7fj30ng040aai.jpg&quot; alt=&quot;&quot;&gt;&lt;/p&gt;
&lt;p&gt;所以, 你以为多说的关闭意味着什么 ? &lt;/p&gt;
&lt;blockquote&gt;
&lt;p&gt;那时 cocos2d-x 还十分火爆,&lt;br&gt;那时我还在用 c++,&lt;br&gt;那年我才 21 岁.&lt;/p&gt;
&lt;/blockquote&gt;
&lt;hr&gt;
&lt;p&gt;好吧, 现在关闭装逼模式.&lt;/p&gt;
&lt;p&gt;虽然用了这么多面的评论, 但正如 @王子亭 博主在&lt;a href=&quot;https://jysperm.me/2016/05/remove-comments-and-wechat/&quot; target=&quot;_blank&quot; rel=&quot;external&quot;&gt;这篇&lt;/a&gt;文章中所言:&lt;/p&gt;
&lt;figure class=&quot;highlight plain&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;1&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;&amp;#20174;&amp;#21478;&amp;#19968;&amp;#20010;&amp;#35282;&amp;#24230;&amp;#26469;&amp;#30475;&amp;#65292;&amp;#25105;&amp;#20889;&amp;#20102;&amp;#36825;&amp;#20040;&amp;#22810;&amp;#24180;&amp;#21338;&amp;#23458;&amp;#65292;&amp;#25910;&amp;#21040;&amp;#30340;&amp;#22823;&amp;#37096;&amp;#20998;&amp;#35780;&amp;#35770;&amp;#37117;&amp;#21644;&amp;#25991;&amp;#31456;&amp;#20869;&amp;#23481;&amp;#26080;&amp;#20851; &amp;#8212;&amp;#8212; &amp;#20182;&amp;#20204;&amp;#22312;&amp;#25226;&amp;#25991;&amp;#31456;&amp;#30340;&amp;#35780;&amp;#35770;&amp;#24403;&amp;#20316;&amp;#30041;&amp;#35328;&amp;#26495;&amp;#26469;&amp;#20351;&amp;#29992;&amp;#65292;&amp;#21644;&amp;#25105;&amp;#25171;&amp;#20010;&amp;#25307;&amp;#21628;&amp;#25110;&amp;#32773;&amp;#35810;&amp;#38382;&amp;#19968;&amp;#19979;&amp;#36817;&amp;#20917;&amp;#12290;&amp;#24403;&amp;#28982;&amp;#25105;&amp;#20063;&amp;#26366;&amp;#25910;&amp;#21040;&amp;#26497;&amp;#23569;&amp;#37096;&amp;#20998;&amp;#19968;&amp;#20123;&amp;#35748;&amp;#30495;&amp;#25776;&amp;#20889;&amp;#30340;&amp;#35780;&amp;#35770;&amp;#65292;&amp;#25105;&amp;#20063;&amp;#24076;&amp;#26395;&amp;#32487;&amp;#32493;&amp;#32473;&amp;#36825;&amp;#20123;&amp;#20154;&amp;#30041;&amp;#20986;&amp;#19968;&amp;#20123;&amp;#31354;&amp;#38388;&amp;#65306;&amp;#25105;&amp;#20250;&amp;#20197;&amp;#37038;&amp;#20214;&amp;#30340;&amp;#24418;&amp;#24335;&amp;#25509;&amp;#21463;&amp;#25991;&amp;#31456;&amp;#35780;&amp;#35770;&amp;#65292;&amp;#25105;&amp;#20250;&amp;#25361;&amp;#36873;&amp;#20854;&amp;#20013;&amp;#23545;&amp;#35835;&amp;#32773;&amp;#26377;&amp;#20215;&amp;#20540;&amp;#30340;&amp;#37096;&amp;#20998;&amp;#23637;&amp;#31034;&amp;#22312;&amp;#25991;&amp;#31456;&amp;#30340;&amp;#26411;&amp;#23614;&amp;#12290;&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;
&lt;p&gt;子亭同学说的特别好, 刚好借着多说关闭的机会, 我移除了博客中的评论系统, 只保留了 &lt;code&gt;关于&lt;/code&gt; 这个灌水界面的评论, 还设立了一个小门槛, 只有拥有 github 账号的朋友才能评论.&lt;/p&gt;
&lt;p&gt;以后便会省心不少吧.&lt;/p&gt;
</content>
    
    <summary type="html">
    
      &lt;p&gt;大约是在前几天刷微博的时候看到有人说多说要关站了, 赶紧去备份评论 balabala … , 难以置信, 赶紧去我的邮箱找了下, 果然找到了这封邮件:&lt;/p&gt;
&lt;p&gt;&lt;img src=&quot;https://ww3.sinaimg.cn/large/006tNbRwly1fdyu
    
    </summary>
    
    
      <category term="blog" scheme="http://blog.justbilt.com/tags/blog/"/>
    
      <category term="comment" scheme="http://blog.justbilt.com/tags/comment/"/>
    
      <category term="duoshuo" scheme="http://blog.justbilt.com/tags/duoshuo/"/>
    
  </entry>
  
  <entry>
    <title>最近搞 iOS 版遇到的一些问题和技巧 (四)</title>
    <link href="http://blog.justbilt.com/2017/03/12/ios-dev-tips-4/"/>
    <id>http://blog.justbilt.com/2017/03/12/ios-dev-tips-4/</id>
    <published>2017-03-12T02:25:47.000Z</published>
    <updated>2017-03-12T04:19:41.000Z</updated>
    
    <content type="html">&lt;p&gt;这是这半年搞 iOS 时遇到的一些问题, 写下来, 希望会帮到大家. 因为时间精力有限, 有些问题, 并没有解决方案, 只是饶了过去.&lt;/p&gt;
&lt;h2 id=&quot;u4E00-_iOS__u6C99_u76D2_u6D4B_u8BD5__u65E0_u6CD5_u8FDE_u63A5_u5230APPSTORE&quot;&gt;&lt;a href=&quot;#u4E00-_iOS__u6C99_u76D2_u6D4B_u8BD5__u65E0_u6CD5_u8FDE_u63A5_u5230APPSTORE&quot; class=&quot;headerlink&quot; title=&quot;一. iOS 沙盒测试 无法连接到APPSTORE&quot;&gt;&lt;/a&gt;一. iOS 沙盒测试 无法连接到APPSTORE&lt;/h2&gt;&lt;p&gt;确定是测试机, 沙盒账号登录的也没有问题, 就是无法充值.&lt;/p&gt;
&lt;h3 id=&quot;u89E3_u51B3_u65B9_u6848&quot;&gt;&lt;a href=&quot;#u89E3_u51B3_u65B9_u6848&quot; class=&quot;headerlink&quot; title=&quot;解决方案&quot;&gt;&lt;/a&gt;解决方案&lt;/h3&gt;&lt;p&gt;换了一个测试机就好了&lt;/p&gt;
&lt;h2 id=&quot;u4E8C-_xcodebuilder_-exportArchive_dev__u5931_u8D25&quot;&gt;&lt;a href=&quot;#u4E8C-_xcodebuilder_-exportArchive_dev__u5931_u8D25&quot; class=&quot;headerlink&quot; title=&quot;二. xcodebuilder -exportArchive dev 失败&quot;&gt;&lt;/a&gt;二. xcodebuilder -exportArchive dev 失败&lt;/h2&gt;&lt;p&gt;这个问题发生在我们的 iOS 打包脚本中, 会报错:&lt;/p&gt;
&lt;blockquote&gt;
&lt;p&gt;IDEDistribution: Step failed: &lt;idedistributionthinningstep: 0x7fa72bbd50e0=&quot;&quot;&gt;: Error Domain=IDEDistributionErrorDomain Code=14 “No applicable devices found.”&lt;/idedistributionthinningstep:&gt;&lt;/p&gt;
&lt;/blockquote&gt;
&lt;h3 id=&quot;u89E3_u51B3_u65B9_u6848-1&quot;&gt;&lt;a href=&quot;#u89E3_u51B3_u65B9_u6848-1&quot; class=&quot;headerlink&quot; title=&quot;解决方案&quot;&gt;&lt;/a&gt;解决方案&lt;/h3&gt;&lt;p&gt;一开始我使用了老的 ipa 导出方案 &lt;code&gt;xcrun -sdk iphoneos PackageApplication&lt;/code&gt; , 这样虽然可以导出了, 但是经常无法安装到测试机, 还得用 XCode 打开归档文件手动导出 dev 版本. 就这样凑活了一段时间后, 我终于下定决心解决这个问题了. 原来每次 &lt;code&gt;exportArchive&lt;/code&gt; 会有有一个日志文件, 查看 /var/folders/…/IDEDistribution.standard.log 得知是我的 ruby 环境有问题:&lt;/p&gt;
&lt;figure class=&quot;highlight md&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;1&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;2&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;3&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;4&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;5&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;[NOTE]&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;You may have encountered a bug in the Ruby interpreter or extension libraries.&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;Bug reports are welcome.&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;Don&#39;t forget to include the above Crash Report log file.&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;For details: http://www.ruby-lang.org/bugreport.html&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;
&lt;p&gt;在 StackOverflow 上找到了&lt;a href=&quot;http://stackoverflow.com/questions/39634404/xcodebuild-exportarchive-no-applicable-devices-found/42027456#42027456&quot; target=&quot;_blank&quot; rel=&quot;external&quot;&gt;这个解决方案&lt;/a&gt;, 使用 &lt;code&gt;xcbuild-safe.sh&lt;/code&gt; 替换 &lt;code&gt;xcodebuilder&lt;/code&gt; 就好了&lt;/p&gt;
&lt;h2 id=&quot;u4E09-_You_must_supply_a_CFBundleIdentifier_for_this_request&quot;&gt;&lt;a href=&quot;#u4E09-_You_must_supply_a_CFBundleIdentifier_for_this_request&quot; class=&quot;headerlink&quot; title=&quot;三. You must supply a CFBundleIdentifier for this request&quot;&gt;&lt;/a&gt;三. You must supply a CFBundleIdentifier for this request&lt;/h2&gt;&lt;p&gt;上传 dis 包时遇到这个错误:&lt;/p&gt;
&lt;p&gt;&lt;img src=&quot;https://ww3.sinaimg.cn/large/006tNbRwly1fdjuz90b3cj30w40g2aar.jpg&quot; alt=&quot;&quot;&gt;&lt;/p&gt;
&lt;h3 id=&quot;u89E3_u51B3_u65B9_u6848-2&quot;&gt;&lt;a href=&quot;#u89E3_u51B3_u65B9_u6848-2&quot; class=&quot;headerlink&quot; title=&quot;解决方案&quot;&gt;&lt;/a&gt;解决方案&lt;/h3&gt;&lt;p&gt;在&lt;a href=&quot;http://www.jianshu.com/p/2d229dfb34a6&quot; target=&quot;_blank&quot; rel=&quot;external&quot;&gt;这篇文章&lt;/a&gt;中找到了解决方案:&lt;/p&gt;
&lt;blockquote&gt;
&lt;p&gt;infor.plist表中Bundle OS Type code 栏为空或者非APPL&lt;br&gt;具体设置路径为，项目的TARGETS &amp;gt;&amp;gt; infor &amp;gt;&amp;gt; Custom iOS Target Properties &amp;gt;&amp;gt; Bundle OS Type code，检查是否为空或者其他。将该选项设置为 APPL。自此，重新上传成功。&lt;/p&gt;
&lt;/blockquote&gt;
&lt;p&gt;虽然解决了, 但是比较奇怪的是, 我好多项目没有设置也可以上传成功.&lt;/p&gt;
&lt;h2 id=&quot;u56DB-__u8FDE_u63A5_VPN__u540E_u6709_u7684_http__u8BF7_u6C42_u4F1A_u5931_u8D25&quot;&gt;&lt;a href=&quot;#u56DB-__u8FDE_u63A5_VPN__u540E_u6709_u7684_http__u8BF7_u6C42_u4F1A_u5931_u8D25&quot; class=&quot;headerlink&quot; title=&quot;四. 连接 VPN 后有的 http 请求会失败&quot;&gt;&lt;/a&gt;四. 连接 VPN 后有的 http 请求会失败&lt;/h2&gt;&lt;p&gt;这个很诡异呀, 不连接 VPN 没有任何问题.&lt;/p&gt;
&lt;h3 id=&quot;u89E3_u51B3_u65B9_u6848-3&quot;&gt;&lt;a href=&quot;#u89E3_u51B3_u65B9_u6848-3&quot; class=&quot;headerlink&quot; title=&quot;解决方案&quot;&gt;&lt;/a&gt;解决方案&lt;/h3&gt;&lt;p&gt;我在 Exception Domain 添加对应域名之后就可以访问了. 猜测是不是果爹对大陆 ip 放宽了要求 ? 哈哈哈&lt;/p&gt;
&lt;h2 id=&quot;u4E94-_This_action_could_not_be_completed-Try_again-_28-22421_29&quot;&gt;&lt;a href=&quot;#u4E94-_This_action_could_not_be_completed-Try_again-_28-22421_29&quot; class=&quot;headerlink&quot; title=&quot;五. This action could not be completed.Try again.(-22421)&quot;&gt;&lt;/a&gt;五. This action could not be completed.Try again.(-22421)&lt;/h2&gt;&lt;p&gt;还是上传 dis 包到 iTunes 后台的时候, 会遇到这个错误:&lt;/p&gt;
&lt;p&gt;&lt;img src=&quot;https://ww2.sinaimg.cn/large/006tNbRwly1fdjv6l9qzij30dh038wep.jpg&quot; alt=&quot;&quot;&gt;&lt;/p&gt;
&lt;h3 id=&quot;u89E3_u51B3_u65B9_u6848-4&quot;&gt;&lt;a href=&quot;#u89E3_u51B3_u65B9_u6848-4&quot; class=&quot;headerlink&quot; title=&quot;解决方案&quot;&gt;&lt;/a&gt;解决方案&lt;/h3&gt;&lt;p&gt;在&lt;a href=&quot;http://www.jianshu.com/p/a9f818ac1066&quot; target=&quot;_blank&quot; rel=&quot;external&quot;&gt;这篇文章&lt;/a&gt;中找到了解决方案:&lt;/p&gt;
&lt;blockquote&gt;
&lt;p&gt;暂时请使用 -Application Loader上传app程序&lt;/p&gt;
&lt;/blockquote&gt;
&lt;h2 id=&quot;u516D-_iOS__u6C99_u76D2_u6D4B_u8BD5_u5145_u503C_u4E00_u6B21_u6210_u529F_2C__u4E00_u6B21_u5931_u8D25&quot;&gt;&lt;a href=&quot;#u516D-_iOS__u6C99_u76D2_u6D4B_u8BD5_u5145_u503C_u4E00_u6B21_u6210_u529F_2C__u4E00_u6B21_u5931_u8D25&quot; class=&quot;headerlink&quot; title=&quot;六. iOS 沙盒测试充值一次成功, 一次失败&quot;&gt;&lt;/a&gt;六. iOS 沙盒测试充值一次成功, 一次失败&lt;/h2&gt;&lt;p&gt;在沙盒测试充值时, 这次失败了, 下次就会成功, 主要发生在小面额的充值项上.&lt;/p&gt;
&lt;h3 id=&quot;u89E3_u51B3_u65B9_u6848-5&quot;&gt;&lt;a href=&quot;#u89E3_u51B3_u65B9_u6848-5&quot; class=&quot;headerlink&quot; title=&quot;解决方案&quot;&gt;&lt;/a&gt;解决方案&lt;/h3&gt;&lt;p&gt;&lt;img src=&quot;https://ww2.sinaimg.cn/large/006tNbRwly1fdjvcfmifbj31as0foq6c.jpg&quot; alt=&quot;&quot;&gt;&lt;/p&gt;
&lt;p&gt;苹果商店抽风, 没啥解决方案.&lt;/p&gt;
&lt;h2 id=&quot;u516D-__u82F9_u679C_u63D0_u4EA4_u5BA1_u6838_uFF0C_u56E0_u4E3A_u5E94_u7528_u540D_u79F0_u4E0D_u5408_u6CD5_u88AB_u62D2_uFF0C_u6539_u5B8C_u63D0_u4EA4_u8FD8_u662F_u88AB_u62D2&quot;&gt;&lt;a href=&quot;#u516D-__u82F9_u679C_u63D0_u4EA4_u5BA1_u6838_uFF0C_u56E0_u4E3A_u5E94_u7528_u540D_u79F0_u4E0D_u5408_u6CD5_u88AB_u62D2_uFF0C_u6539_u5B8C_u63D0_u4EA4_u8FD8_u662F_u88AB_u62D2&quot; class=&quot;headerlink&quot; title=&quot;六. 苹果提交审核，因为应用名称不合法被拒，改完提交还是被拒&quot;&gt;&lt;/a&gt;六. 苹果提交审核，因为应用名称不合法被拒，改完提交还是被拒&lt;/h2&gt;&lt;p&gt;这个是苹果的回复:&lt;/p&gt;
&lt;blockquote&gt;
&lt;p&gt;We still find that your app name to be displayed on the App Store includes descriptors, which are not appropriate for use in an app name.&lt;br&gt;Specifically, the following words in your app names are considered descriptors&lt;/p&gt;
&lt;/blockquote&gt;
&lt;h3 id=&quot;u89E3_u51B3_u65B9_u6848-6&quot;&gt;&lt;a href=&quot;#u89E3_u51B3_u65B9_u6848-6&quot; class=&quot;headerlink&quot; title=&quot;解决方案&quot;&gt;&lt;/a&gt;解决方案&lt;/h3&gt;&lt;p&gt;可以查看是否在iTunes connect 后台添加了多个语言，而只修改了一种语言。&lt;/p&gt;
&lt;h2 id=&quot;u4E03-_XCode__u5B89_u88C5_u5E94_u7528_u51FA_u9519&quot;&gt;&lt;a href=&quot;#u4E03-_XCode__u5B89_u88C5_u5E94_u7528_u51FA_u9519&quot; class=&quot;headerlink&quot; title=&quot;七. XCode 安装应用出错&quot;&gt;&lt;/a&gt;七. XCode 安装应用出错&lt;/h2&gt;&lt;p&gt;这个是错误内容:&lt;/p&gt;
&lt;blockquote&gt;
&lt;p&gt;This application’s application-identifier entitlement does not match that of the installed application. These values must match for an upgrade to be allowed.&lt;/p&gt;
&lt;/blockquote&gt;
&lt;h3 id=&quot;u89E3_u51B3_u65B9_u6848-7&quot;&gt;&lt;a href=&quot;#u89E3_u51B3_u65B9_u6848-7&quot; class=&quot;headerlink&quot; title=&quot;解决方案&quot;&gt;&lt;/a&gt;解决方案&lt;/h3&gt;&lt;p&gt;删除手机上已经安装的应用就好了&lt;/p&gt;
</content>
    
    <summary type="html">
    
      万一遇上了呢?
    
    </summary>
    
    
      <category term="iOS" scheme="http://blog.justbilt.com/tags/iOS/"/>
    
      <category term="iOS-Dev-Tips" scheme="http://blog.justbilt.com/tags/iOS-Dev-Tips/"/>
    
  </entry>
  
  <entry>
    <title>Quick-Cocos2d-x 中的面向对象</title>
    <link href="http://blog.justbilt.com/2017/03/04/quick-x-oop/"/>
    <id>http://blog.justbilt.com/2017/03/04/quick-x-oop/</id>
    <published>2017-03-04T02:04:44.000Z</published>
    <updated>2017-03-12T02:22:53.000Z</updated>
    
    <content type="html">&lt;p&gt;虽说现在一直提倡组合优于继承, 但是我们这帮深受 c++ 毒害的大好青年还是对继承有着深深的感情. Lua 这门语言本身并没有提供面向对象的机制, 不过我们可以很容易的通过 Lua 的 metatable 来实现一套面向对象的机制.&lt;/p&gt;
&lt;h1 id=&quot;u4E00-__u5B9E_u73B0_u673A_u5236&quot;&gt;&lt;a href=&quot;#u4E00-__u5B9E_u73B0_u673A_u5236&quot; class=&quot;headerlink&quot; title=&quot;一. 实现机制&quot;&gt;&lt;/a&gt;一. 实现机制&lt;/h1&gt;&lt;p&gt;实现的原理很简单, 如果一个 Lua 的 table1 通过 &lt;code&gt;setmetatable&lt;/code&gt; 函数设置了元表之后, 如果试图访问一个不存在的 &lt;code&gt;属性&lt;/code&gt;, 就会触发这个 metatable 的 &lt;code&gt;__index&lt;/code&gt; 元方法, 这个 __index 可以是另一个 table2 , 这样它就回去这个 table2 中去找那个属性了, 如果 table2 中还没有的话, 就会触发 table2 的元方法, 就这样一层一层的往上找. 我们可以用一个十分简单的栗子来测试下这个功能:&lt;/p&gt;
&lt;figure class=&quot;highlight lua&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;1&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;2&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;3&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;4&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;5&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;6&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;7&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;8&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;keyword&quot;&gt;local&lt;/span&gt; a = &amp;#123;aa = &lt;span class=&quot;number&quot;&gt;1&lt;/span&gt;&amp;#125;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;keyword&quot;&gt;local&lt;/span&gt; b = &amp;#123;bb = &lt;span class=&quot;number&quot;&gt;2&lt;/span&gt;&amp;#125;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;keyword&quot;&gt;local&lt;/span&gt; c = &amp;#123;cc = &lt;span class=&quot;number&quot;&gt;3&lt;/span&gt;&amp;#125;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;built_in&quot;&gt;setmetatable&lt;/span&gt;(b, &amp;#123;__index = a&amp;#125;)&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;built_in&quot;&gt;setmetatable&lt;/span&gt;(c, &amp;#123;__index = b&amp;#125;)&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;built_in&quot;&gt;print&lt;/span&gt;(&lt;span class=&quot;string&quot;&gt;&quot;aa:&quot;&lt;/span&gt;, c.aa, &lt;span class=&quot;string&quot;&gt;&quot;bb:&quot;&lt;/span&gt;, c.bb, &lt;span class=&quot;string&quot;&gt;&quot;cc&quot;&lt;/span&gt;, c.cc) &lt;span class=&quot;comment&quot;&gt;-- output: aa:  1   bb: 2   cc  3&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;
&lt;p&gt;如上, 只是加了两个 &lt;code&gt;setmetatable&lt;/code&gt;, c 便可以访问到 a 和 b 的属性, 是不是很神奇.&lt;/p&gt;
&lt;h1 id=&quot;u4E8C-_Quick-x__u4E2D_u7684_u5B9E_u73B0&quot;&gt;&lt;a href=&quot;#u4E8C-_Quick-x__u4E2D_u7684_u5B9E_u73B0&quot; class=&quot;headerlink&quot; title=&quot;二. Quick-x 中的实现&quot;&gt;&lt;/a&gt;二. Quick-x 中的实现&lt;/h1&gt;&lt;p&gt;Quick-x 作为一个 framework 自然也实现了一套这样的机制, 因为函数实现比较长, 所以我就不粘贴代码了, 大家可以&lt;a href=&quot;https://github.com/chukong/quick-cocos2d-x/blob/master/framework/functions.lua#L281-L339&quot; target=&quot;_blank&quot; rel=&quot;external&quot;&gt;跳转这里查看&lt;/a&gt;. 纵观这段代码, 可以以最外层的 &lt;code&gt;if-else&lt;/code&gt; 将这段逻辑分成两部分, 继承自 Cocos 的对象和继承自 Lua 的 Table, 为什么要这么分呢 ?&lt;/p&gt;
&lt;p&gt;因为 Cocos 的对象在 Lua 中的 type 是 &lt;code&gt;userdata&lt;/code&gt;, 是不能设置 metatable 的, 所以我们之前说的那套继承的方法就行不通了, Quick-x 在这里的选择是把所有的变量都复制一份, 做了一次一维的深拷贝. &lt;/p&gt;
&lt;p&gt;所以, 抛开继承的实现不同, 这两个分支的逻辑是一致的. 我们精简下, 可以分离出下面这段简短的代码:&lt;/p&gt;
&lt;figure class=&quot;highlight lua&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;1&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;2&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;3&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;4&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;5&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;6&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;7&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;8&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;9&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;10&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;11&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;12&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;13&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;14&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;function&quot;&gt;&lt;span class=&quot;keyword&quot;&gt;function&lt;/span&gt; &lt;span class=&quot;title&quot;&gt;class&lt;/span&gt;&lt;span class=&quot;params&quot;&gt;(_name, _super)&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    &lt;span class=&quot;keyword&quot;&gt;local&lt;/span&gt; cls = &amp;#123;__cname = _name, super = _super&amp;#125;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    &lt;span class=&quot;keyword&quot;&gt;if&lt;/span&gt; _super &lt;span class=&quot;keyword&quot;&gt;then&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;        &lt;span class=&quot;built_in&quot;&gt;setmetatable&lt;/span&gt;(cls, &amp;#123;__index = _super&amp;#125;)&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    &lt;span class=&quot;keyword&quot;&gt;else&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;        cls.ctor = &lt;span class=&quot;function&quot;&gt;&lt;span class=&quot;keyword&quot;&gt;function&lt;/span&gt;&lt;span class=&quot;params&quot;&gt;()&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;keyword&quot;&gt;end&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    &lt;span class=&quot;keyword&quot;&gt;end&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    &lt;span class=&quot;function&quot;&gt;&lt;span class=&quot;keyword&quot;&gt;function&lt;/span&gt; &lt;span class=&quot;title&quot;&gt;cls.new&lt;/span&gt;&lt;span class=&quot;params&quot;&gt;(...)&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;        &lt;span class=&quot;keyword&quot;&gt;local&lt;/span&gt; instance = &lt;span class=&quot;built_in&quot;&gt;setmetatable&lt;/span&gt;(&amp;#123;&amp;#125;, &amp;#123;__index = cls&amp;#125;)&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;        instance:ctor(...)&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;        &lt;span class=&quot;keyword&quot;&gt;return&lt;/span&gt; instance&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    &lt;span class=&quot;keyword&quot;&gt;end&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    &lt;span class=&quot;keyword&quot;&gt;return&lt;/span&gt; cls&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;keyword&quot;&gt;end&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;
&lt;p&gt;这短短十几行代码几乎已经包含了面向对象的所有特性, 有实例函数 &lt;code&gt;new&lt;/code&gt;, 有默认构造函数 &lt;code&gt;ctor&lt;/code&gt;, 可以访问父类 &lt;code&gt;super&lt;/code&gt;. &lt;/p&gt;
&lt;p&gt;大家可以看到这段代码有两次 &lt;code&gt;setmetatable&lt;/code&gt;, 第一次是在创建 cls 的时候, 是为了让 cls 能够访问到 super 中的属性; 第二次是在产生实例 &lt;code&gt;instance&lt;/code&gt; 的时候, 是为了让实例能够访问到 cls 中的属性. &lt;/p&gt;
&lt;h1 id=&quot;u4E09-__u8981_u6CE8_u610F_u7684_u5730_u65B9&quot;&gt;&lt;a href=&quot;#u4E09-__u8981_u6CE8_u610F_u7684_u5730_u65B9&quot; class=&quot;headerlink&quot; title=&quot;三. 要注意的地方&quot;&gt;&lt;/a&gt;三. 要注意的地方&lt;/h1&gt;&lt;p&gt;下面这段代码是一个典型的面向对象示例:&lt;/p&gt;
&lt;figure class=&quot;highlight lua&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;1&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;2&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;3&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;4&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;5&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;6&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;7&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;8&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;9&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;10&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;11&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;12&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;13&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;14&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;15&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;16&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;17&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;18&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;19&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;20&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;21&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;22&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;keyword&quot;&gt;local&lt;/span&gt; Animal = class(&lt;span class=&quot;string&quot;&gt;&quot;Animal&quot;&lt;/span&gt;)&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;function&quot;&gt;&lt;span class=&quot;keyword&quot;&gt;function&lt;/span&gt; &lt;span class=&quot;title&quot;&gt;Animal:ctor&lt;/span&gt;&lt;span class=&quot;params&quot;&gt;(_name)&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    self.name = _name&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;keyword&quot;&gt;end&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;function&quot;&gt;&lt;span class=&quot;keyword&quot;&gt;function&lt;/span&gt; &lt;span class=&quot;title&quot;&gt;Animal:say&lt;/span&gt;&lt;span class=&quot;params&quot;&gt;()&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    &lt;span class=&quot;built_in&quot;&gt;print&lt;/span&gt;(&lt;span class=&quot;string&quot;&gt;&quot;i couldn&#39;t say!&quot;&lt;/span&gt;)&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;keyword&quot;&gt;end&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;keyword&quot;&gt;local&lt;/span&gt; Dog = class(&lt;span class=&quot;string&quot;&gt;&quot;Dog&quot;&lt;/span&gt;, Animal)&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;function&quot;&gt;&lt;span class=&quot;keyword&quot;&gt;function&lt;/span&gt; &lt;span class=&quot;title&quot;&gt;Dog:ctor&lt;/span&gt;&lt;span class=&quot;params&quot;&gt;(_name, _age)&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    Dog.super.ctor(self, _name)&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    self.age = _age&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;keyword&quot;&gt;end&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;function&quot;&gt;&lt;span class=&quot;keyword&quot;&gt;function&lt;/span&gt; &lt;span class=&quot;title&quot;&gt;Dog:say&lt;/span&gt;&lt;span class=&quot;params&quot;&gt;()&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    &lt;span class=&quot;built_in&quot;&gt;print&lt;/span&gt;(&lt;span class=&quot;built_in&quot;&gt;string&lt;/span&gt;.format(&lt;span class=&quot;string&quot;&gt;&quot;I&#39;m a %s, my name is %s, i&#39;m %s years old.&quot;&lt;/span&gt;, self.__cname, self.name, self.age))&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;keyword&quot;&gt;end&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;Dog.new(&lt;span class=&quot;string&quot;&gt;&quot;Jack&quot;&lt;/span&gt;, &lt;span class=&quot;number&quot;&gt;5&lt;/span&gt;):say()&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;
&lt;p&gt;我们重点看下第 &lt;code&gt;14&lt;/code&gt; 行代码, 这行代码有些奇怪.&lt;/p&gt;
&lt;h2 id=&quot;1-__u4E3A_u4EC0_u4E48_u7528_u7C7B_u540D_u53BB_u8C03_u7528_super__3F&quot;&gt;&lt;a href=&quot;#1-__u4E3A_u4EC0_u4E48_u7528_u7C7B_u540D_u53BB_u8C03_u7528_super__3F&quot; class=&quot;headerlink&quot; title=&quot;1. 为什么用类名去调用 super ?&quot;&gt;&lt;/a&gt;1. 为什么用类名去调用 super ?&lt;/h2&gt;&lt;p&gt;当继承到第三层的时候 self.super 从 C 跳转到 B 时 self 还是 C 的实例, 这时 B 中 self.super 其实还 B, 就会造成 stack overflow.&lt;/p&gt;
&lt;h2 id=&quot;2-__u4E3A_u4EC0_u4E48_u662F_u7C7B_u540D_-_super__u800C_u4E0D_u662F__3A_super__3F&quot;&gt;&lt;a href=&quot;#2-__u4E3A_u4EC0_u4E48_u662F_u7C7B_u540D_-_super__u800C_u4E0D_u662F__3A_super__3F&quot; class=&quot;headerlink&quot; title=&quot;2. 为什么是类名 . super 而不是 : super ?&quot;&gt;&lt;/a&gt;2. 为什么是类名 &lt;code&gt;.&lt;/code&gt; super 而不是 &lt;code&gt;:&lt;/code&gt; super ?&lt;/h2&gt;&lt;p&gt;首先大家要明白 Lua 中 &lt;code&gt;.&lt;/code&gt; 和 &lt;code&gt;:&lt;/code&gt; 调用函数的区别是什么 ?&lt;/p&gt;
&lt;blockquote&gt;
&lt;p&gt;冒号调用是 Lua 提供的一个语法糖, 默认会将函数的调用者作为第一个参数传入.&lt;/p&gt;
&lt;/blockquote&gt;
&lt;p&gt;区别在于父类的函数收到的 self 是 &lt;code&gt;self&lt;/code&gt; (即 Dog 的实例) 还是 &lt;code&gt;Dog.super&lt;/code&gt; (即 Animal) , 很明显应该是后者.&lt;/p&gt;
&lt;h1 id=&quot;u56DB-__u6709_u4EC0_u4E48_u6539_u8FDB_u7684_u5730_u65B9&quot;&gt;&lt;a href=&quot;#u56DB-__u6709_u4EC0_u4E48_u6539_u8FDB_u7684_u5730_u65B9&quot; class=&quot;headerlink&quot; title=&quot;四. 有什么改进的地方&quot;&gt;&lt;/a&gt;四. 有什么改进的地方&lt;/h1&gt;&lt;p&gt;很早之前就拜读过&lt;a href=&quot;http://jennal.com/2014/10/18/cocos2dx-lua-oop/&quot; target=&quot;_blank&quot; rel=&quot;external&quot;&gt;这篇文章&lt;/a&gt;, 这篇文章中列举了一些作者的疑惑, 很有收获, 大家可以看一下. 文章中提出了两条:&lt;/p&gt;
&lt;blockquote&gt;
&lt;p&gt;问题1：从父类做深度拷贝&lt;br&gt;问题4：创建实例时的深度拷贝&lt;/p&gt;
&lt;/blockquote&gt;
&lt;p&gt;作者当时可能忽略了我们刚才做的解释: &lt;em&gt;无法向一个 userdata 设置 metatable&lt;/em&gt; , 那么我们这里是否真的需要一次深拷贝呢 ? 让我们先思考一个问题:&lt;/p&gt;
&lt;blockquote&gt;
&lt;p&gt;既然 Cocos 的对象是一个 &lt;code&gt;userdata&lt;/code&gt;, 那么我们为什么可以往这个 userdata 上添加新的 Lua 属性呢 ?&lt;/p&gt;
&lt;/blockquote&gt;
&lt;p&gt;Quick-x 为 C++ 导出 Lua 接口的工具是 tolua++ , 其中有两个接口叫: &lt;code&gt;tolua.setpeer&lt;/code&gt; 和 &lt;code&gt;tolua.gerpeer&lt;/code&gt; , 这个 peer 又是一个什么东西呢 ?&lt;/p&gt;
&lt;p&gt;&lt;img src=&quot;https://ww1.sinaimg.cn/large/006tNc79ly1fdbsvt09tnj313o08ewg5.jpg&quot; alt=&quot;&quot;&gt;&lt;/p&gt;
&lt;p&gt;这张图是六月大大在 Cocos 论坛中的回复, 我们可以理解为 &lt;code&gt;peer&lt;/code&gt; 是用来存储 C++ 对象在 Lua 中的扩展的, 他的本质是一个 table. 如果我们试图访问一个 userdata 类型的属性时, 如果这个 userdata 设置了 peer 表, 会优先从这个表中取值.&lt;/p&gt;
&lt;p&gt;既然这个 &lt;code&gt;peer&lt;/code&gt; 是一个 table, 那么是否可以为这个 table 设置元表, 这样在 peer 表中找不到就会触发 __index .&lt;/p&gt;
&lt;p&gt;我们对 class 的实现做出下面的修改:&lt;/p&gt;
&lt;p&gt;&lt;img src=&quot;https://ww3.sinaimg.cn/large/006tNbRwly1fdbtiv4cbaj30v009i3zv.jpg&quot; alt=&quot;&quot;&gt;&lt;/p&gt;
&lt;p&gt;用设置 peer 表的 metatable 来代替原来的深拷贝, 重新运行我们的项目, 完美. 让我们想想下这个实现带来的优势: &lt;strong&gt;更快, 更省内存&lt;/strong&gt;, 为此我做了一个小的性能测试:&lt;/p&gt;
&lt;figure class=&quot;highlight lua&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;1&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;2&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;3&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;4&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;5&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;6&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;7&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;8&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;9&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;10&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;11&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;12&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;13&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;14&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;15&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;16&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;17&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;keyword&quot;&gt;local&lt;/span&gt; A = class(&lt;span class=&quot;string&quot;&gt;&quot;A&quot;&lt;/span&gt;, &lt;span class=&quot;function&quot;&gt;&lt;span class=&quot;keyword&quot;&gt;function&lt;/span&gt;&lt;span class=&quot;params&quot;&gt;()&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    &lt;span class=&quot;keyword&quot;&gt;return&lt;/span&gt; cc.Node:create()&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;keyword&quot;&gt;end&lt;/span&gt;)&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;keyword&quot;&gt;for&lt;/span&gt; i = &lt;span class=&quot;number&quot;&gt;1&lt;/span&gt;, &lt;span class=&quot;number&quot;&gt;100&lt;/span&gt; &lt;span class=&quot;keyword&quot;&gt;do&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    A[&lt;span class=&quot;string&quot;&gt;&quot;a_index_&quot;&lt;/span&gt;..i] = i&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;keyword&quot;&gt;end&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;keyword&quot;&gt;local&lt;/span&gt; B = class(&lt;span class=&quot;string&quot;&gt;&quot;B&quot;&lt;/span&gt;, A)&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;keyword&quot;&gt;for&lt;/span&gt; i = &lt;span class=&quot;number&quot;&gt;1&lt;/span&gt;, &lt;span class=&quot;number&quot;&gt;100&lt;/span&gt; &lt;span class=&quot;keyword&quot;&gt;do&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    B[&lt;span class=&quot;string&quot;&gt;&quot;b_index_&quot;&lt;/span&gt;..i] = i&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;keyword&quot;&gt;end&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;keyword&quot;&gt;for&lt;/span&gt; i=&lt;span class=&quot;number&quot;&gt;1&lt;/span&gt;,&lt;span class=&quot;number&quot;&gt;10000&lt;/span&gt; &lt;span class=&quot;keyword&quot;&gt;do&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    B.new()&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;keyword&quot;&gt;end&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;
&lt;p&gt;我设计了 A,B 两个类, B 继承自 A, 每个各有 100 个成员变量, 最后创建 10000 个 B 的实例. 统计了下内存的占用情况和耗时. 结果如下:&lt;/p&gt;
&lt;figure class=&quot;highlight lua&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;1&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;2&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;3&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;4&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;5&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;6&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;7&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;深拷贝:&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;耗时: &lt;span class=&quot;number&quot;&gt;2.988687&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;内存: &lt;span class=&quot;number&quot;&gt;134.1&lt;/span&gt;M&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;built_in&quot;&gt;setmetatable&lt;/span&gt;:&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;耗时: &lt;span class=&quot;number&quot;&gt;0.107388&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;内存: &lt;span class=&quot;number&quot;&gt;38.9&lt;/span&gt;M&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;
&lt;p&gt;这个相差很多呀, 感觉自己马上就要走上人生巅峰了. 既然相差这么多, 而廖大貌似也早已发现了这个问题:&lt;/p&gt;
&lt;p&gt;&lt;img src=&quot;https://ww3.sinaimg.cn/large/006tNbRwly1fdbv2g5bfoj30m208mjs8.jpg&quot; alt=&quot;&quot;&gt;&lt;/p&gt;
&lt;p&gt;为什么直到 3.3 版本还没有改动呢 ? 莫非是我哪里计算错了, 抛开测试, 我在我们的一个线上项目中做了一个真是的测试, 结果令我大跌眼镜.&lt;/p&gt;
&lt;blockquote&gt;
&lt;p&gt;相差无几&lt;/p&gt;
&lt;/blockquote&gt;
&lt;p&gt;仔细想了下, 是否每一个对象都会有 100 个属性, 游戏内是否会同时存在 1w 个对象 ? 所以那份测试是没有意义的, 但是这个改动却是很有意义的.&lt;/p&gt;
&lt;p&gt;其实在发现 peer 表之前, 我还做过另一个尝试, 对于 userdata 类型的实例, 不返回这个实例, 而是返回一个 table, 有一个属性 &lt;code&gt;_cobj&lt;/code&gt; , 设置这个 table 的元表, 使得所有的属性都优先从 &lt;code&gt;_cobj&lt;/code&gt; 中取, 取不到再去 super 中取, 后来因为改动太大, 就放弃了, 不过在这个改动的过程中意外的发现 peer 表的存在.&lt;/p&gt;
&lt;p&gt;多折腾, 总会有所收获的.&lt;/p&gt;
</content>
    
    <summary type="html">
    
      没有对象? 自己 new 一个就好了嘛!
    
    </summary>
    
    
      <category term="Quick-Cocos2d-x" scheme="http://blog.justbilt.com/tags/Quick-Cocos2d-x/"/>
    
  </entry>
  
  <entry>
    <title>最近博客的一些变化</title>
    <link href="http://blog.justbilt.com/2017/02/24/some-change-for-blog/"/>
    <id>http://blog.justbilt.com/2017/02/24/some-change-for-blog/</id>
    <published>2017-02-23T16:39:14.000Z</published>
    <updated>2017-03-12T01:22:39.000Z</updated>
    
    <content type="html">&lt;p&gt;虽然最近博客的产量不高, 但是折腾的比较多. 而且每次折腾完都会有一些新的素材, 这样又可以对付一篇博客出来啦. 逃)&lt;/p&gt;
&lt;h1 id=&quot;u4E00-__u4E3B_u9898&quot;&gt;&lt;a href=&quot;#u4E00-__u4E3B_u9898&quot; class=&quot;headerlink&quot; title=&quot;一. 主题&quot;&gt;&lt;/a&gt;一. 主题&lt;/h1&gt;&lt;p&gt;我不是在换主题, 就是在换主题的路上. 以至于子龙山人经常会问我:”你又换博客啦?”, 并没有, 只是换了个主题而已.&lt;/p&gt;
&lt;p&gt;我换主题疯狂到什么程度呢? 几乎 &lt;a href=&quot;https://hexo.io/themes/&quot; target=&quot;_blank&quot; rel=&quot;external&quot;&gt;Hexo 主题页&lt;/a&gt;的我都尝试过, 很多不好看的简单尝试了下就放弃了, 好看的呢我又会改一改, 按照自己的喜好定制一些东西. 只可惜之前的主题都没有截图留念下, 否则还能拿出来装个逼.&lt;/p&gt;
&lt;p&gt;&lt;img src=&quot;/assets/themes-screenshot/01-raytaylorism.png&quot; alt=&quot;&quot;&gt;&lt;/p&gt;
&lt;p&gt;目前这个主题 &lt;code&gt;raytaylorism&lt;/code&gt; 简单修改了下 配色, 字体, 和一点样式, 感觉还不错, 应该可以挺一段时间.&lt;/p&gt;
&lt;h1 id=&quot;u4E8C-__u79FB_u52A8_u7AEF_u5199_u4F5C&quot;&gt;&lt;a href=&quot;#u4E8C-__u79FB_u52A8_u7AEF_u5199_u4F5C&quot; class=&quot;headerlink&quot; title=&quot;二. 移动端写作&quot;&gt;&lt;/a&gt;二. 移动端写作&lt;/h1&gt;&lt;p&gt;上篇文章我尝试了下在我的 Android 手机上书写, 用到了两个应用分别是 &lt;code&gt;Pocker Git&lt;/code&gt; 和 &lt;code&gt;JotterPad&lt;/code&gt; . 前者负责博客的 git 拉取和推送, 后者负责编辑, 两个应用都很给力, 配合的也很好, 虽然还有一些小瑕疵, 但着实已经是免费的解决方案中最佳之选了.&lt;/p&gt;
&lt;p&gt;&lt;img src=&quot;https://ww4.sinaimg.cn/large/006tNc79ly1fd0xcj3fmhj31kw0nyh5e.jpg&quot; alt=&quot;&quot;&gt;&lt;/p&gt;
&lt;h1 id=&quot;u4E09-__u8BBF_u95EE_u52A0_u901F&quot;&gt;&lt;a href=&quot;#u4E09-__u8BBF_u95EE_u52A0_u901F&quot; class=&quot;headerlink&quot; title=&quot;三. 访问加速&quot;&gt;&lt;/a&gt;三. 访问加速&lt;/h1&gt;&lt;p&gt;说的好像很高大上, 做起来特别简单. 之前博客是托管在 github 之上的, 但是由于一些众所周知的原因, 访问速度不是很理想, 甚至可能访问不了. 国内也有类似的免费托管方案 (coding), 但是外国友人若是想看俺写的文章咱办 ? 能不能国外网络走 github, 国内走 coding 呢?&lt;/p&gt;
&lt;p&gt;是可以的, 而且配置起来超级简单, 动动手指的功夫就解决了. 我基本上是照着&lt;a href=&quot;http://yumemor.com/2016/04/24/Github-Pages-%E6%9C%8D%E5%8A%A1%E5%A4%AA%E6%85%A2%EF%BC%9F%E6%9D%A5%E8%AF%95%E8%AF%95%E5%88%86%E6%B5%81%E5%90%A7/&quot; target=&quot;_blank&quot; rel=&quot;external&quot;&gt;这个教程&lt;/a&gt;搞的, 但是这个教程有些老, coding 他们改版的很快, 大家自己配合教程琢磨下就可以了.&lt;/p&gt;
&lt;p&gt;弄完之后, 访问博客速度&lt;strong&gt;嗷嗷的&lt;/strong&gt;, 感谢 coding 提供这么好的服务, 还是免费的, 良心企业.&lt;/p&gt;
&lt;h1 id=&quot;u56DB-__u56FE_u7247_u4E0A_u4F20&quot;&gt;&lt;a href=&quot;#u56DB-__u56FE_u7247_u4E0A_u4F20&quot; class=&quot;headerlink&quot; title=&quot;四. 图片上传&quot;&gt;&lt;/a&gt;四. 图片上传&lt;/h1&gt;&lt;p&gt;不知道大家之前博客配图是怎么搞的, 我之前是这么个流程:&lt;/p&gt;
&lt;blockquote&gt;
&lt;p&gt;准备图片 &amp;gt; 打开 chrome 微博图床插件 &amp;gt; 把图片拖拽上去 &amp;gt; 复制网址 &amp;gt; 返回编辑器粘贴网址&lt;/p&gt;
&lt;/blockquote&gt;
&lt;p&gt;过程还是略繁琐, 直到我发现了神器 &lt;code&gt;iPic&lt;/code&gt; , 复制图片后直接 &lt;code&gt;cmd + shift + u&lt;/code&gt; 等待上传完毕就可以获得网址了.&lt;/p&gt;
&lt;p&gt;&lt;img src=&quot;https://ww3.sinaimg.cn/large/006tNc79ly1fd0xv8mhqzj30c009u0tk.jpg&quot; alt=&quot;&quot;&gt;&lt;/p&gt;
&lt;p&gt;超级方便, 超级省心, 绝对是让生命更有意义的工具.&lt;/p&gt;
&lt;hr&gt;
&lt;p&gt;有了这么多牛逼的东西, 还有什么理由不好好写博客呢 ?&lt;/p&gt;
</content>
    
    <summary type="html">
    
      哎呀, 你咋又换主题了 !
    
    </summary>
    
    
      <category term="blog" scheme="http://blog.justbilt.com/tags/blog/"/>
    
  </entry>
  
  <entry>
    <title>充实而又愉快的 2016</title>
    <link href="http://blog.justbilt.com/2017/02/18/my-2016/"/>
    <id>http://blog.justbilt.com/2017/02/18/my-2016/</id>
    <published>2017-02-18T01:39:54.000Z</published>
    <updated>2017-03-12T02:22:53.000Z</updated>
    
    <content type="html">&lt;p&gt;以往的年结大家感兴趣的话可以看这里: &lt;a href=&quot;http://blog.justbilt.com/categories/%E5%B9%B4%E7%BB%93/&quot;&gt;我的年结&lt;/a&gt;, 这篇是第四篇了. 我大约是 2012 年正式开始写博客的, 时光荏苒, 已经过去5年了, 期间经历过一次大的迁移, 觉得最开始的博客太没有技术含量, 所以就都丢弃了. &lt;/p&gt;
&lt;p&gt;值得肯定的是, 这次的年结是写的最早的一次 ! (此处应有掌声👏) 拖延病患者的一小步, 社会的一大步 !&lt;/p&gt;
&lt;hr&gt;
&lt;h1 id=&quot;u4E00-__u5DE5_u4F5C&quot;&gt;&lt;a href=&quot;#u4E00-__u5DE5_u4F5C&quot; class=&quot;headerlink&quot; title=&quot;一. 工作&quot;&gt;&lt;/a&gt;一. 工作&lt;/h1&gt;&lt;h2 id=&quot;C__u516C_u53F8__282015-7__7E__u4ECA_29&quot;&gt;&lt;a href=&quot;#C__u516C_u53F8__282015-7__7E__u4ECA_29&quot; class=&quot;headerlink&quot; title=&quot;C 公司 (2015.7 ~ 今)&quot;&gt;&lt;/a&gt;C 公司 (2015.7 ~ 今)&lt;/h2&gt;&lt;p&gt;算下来, 我在 C 已经呆了一年半多的时间了, 如果要用一个字来形容我的感受, 那就是 &lt;code&gt;爽&lt;/code&gt; . 去年我对 C 的介绍并不多, 当时的体验并不久, 今年终于可以来说一说了, 仔细想来 C 这样的团队才是我心目中理想的团队:&lt;/p&gt;
&lt;blockquote&gt;
&lt;p&gt;不计考勤, 周末双休&lt;br&gt;有一顿免费晚饭, 两大包 3M 口罩, 三个空气净化器&lt;br&gt;技术驱动, 效率优先&lt;br&gt;老板很牛逼, 团队无弱者&lt;/p&gt;
&lt;/blockquote&gt;
&lt;p&gt;这里面最重要的是 &lt;em&gt;老板很牛逼, 团队无弱者&lt;/em&gt;, 在 C 你经常可以看到策划同学在改后端战斗逻辑, 测试同学在用按键精灵写自动测试脚本, UE 妹子听得懂程序逻辑还兼着客服+运营, UI 设计师和前端讨论这个界面拼的合理性. 两位老板 (@bin, @jinbo) 更是牛逼, 他们就是我心目中的两尊神, 我就不夸他们了, 免得被认为在吹牛逼.&lt;/p&gt;
&lt;p&gt;&lt;img src=&quot;https://ww4.sinaimg.cn/large/006tNc79ly1fcufng11glj30zk0qdact.jpg&quot; alt=&quot;年中去轰趴&quot;&gt;&lt;/p&gt;
&lt;p&gt;&lt;img src=&quot;https://ww3.sinaimg.cn/large/006tNc79ly1fcufg12hhjj30zk0qo0xq.jpg&quot; alt=&quot;年夜饭&quot;&gt;&lt;/p&gt;
&lt;p&gt;这一年间, 公司来了一些人, 也走了一些人, 对于有些人还是十分不舍的, 但是每个人都有自己的选择, 强扭的瓜不甜. &lt;/p&gt;
&lt;p&gt;公司年夜饭这一天, 我喝的酩酊大醉, 为现在的这些人, 也为离开那些人 !&lt;/p&gt;
&lt;h1 id=&quot;u4E8C-__u6280_u672F&quot;&gt;&lt;a href=&quot;#u4E8C-__u6280_u672F&quot; class=&quot;headerlink&quot; title=&quot;二. 技术&quot;&gt;&lt;/a&gt;二. 技术&lt;/h1&gt;&lt;p&gt;关于技术, 这一年没有往广度去发展了, 更多对之前技术的巩固和项目后期的一些理解. 这一年语言的技术栈主要还是 &lt;code&gt;lua + python + shell&lt;/code&gt;, lua 用来做项目, python 和 shell 用来写支持.&lt;/p&gt;
&lt;h2 id=&quot;Android_Studio&quot;&gt;&lt;a href=&quot;#Android_Studio&quot; class=&quot;headerlink&quot; title=&quot;Android Studio&quot;&gt;&lt;/a&gt;Android Studio&lt;/h2&gt;&lt;p&gt;2016 年最大收获之一就是它了, 接触它是一个很机缘巧合事情, 我们打算接入一个崩溃统计的 SDK , 但是这个 SDK 只支持 Android Studio (以后简称 AS) 接入, 我们会为了一个 sdk 改变整个 Android 项目的结构吗 ? 会 . 现在还依稀记得当时十分没底气的很 @bin 说: &lt;/p&gt;
&lt;blockquote&gt;
&lt;p&gt;“我们能不能换一个 Android 的 ide ?”&lt;/p&gt;
&lt;/blockquote&gt;
&lt;p&gt;当时 Android 端的项目还不是很复杂，在 bin 的支持下，很快便迁移到了 AS ，直到后面我们团队在一周之内接完 30+ 个渠道的 sdk ，才意识到了当初的选择是多么的明智.&lt;/p&gt;
&lt;p&gt;当然这一路并不是顺风顺水，也遇到了很多坑，幸好 Google 在大力推 as ，遇到的坑在 Stack Overflow 上也都有答案。&lt;/p&gt;
&lt;p&gt;感谢 Bugtags ，感谢 Android studio 。关于崩溃统计的问题，我有空会单独开一篇文章来写。&lt;/p&gt;
&lt;h2 id=&quot;u9879_u76EE&quot;&gt;&lt;a href=&quot;#u9879_u76EE&quot; class=&quot;headerlink&quot; title=&quot;项目&quot;&gt;&lt;/a&gt;项目&lt;/h2&gt;&lt;p&gt;就项目来说，也可谓是 “活久见”，我工作了这么多年，第一次走到项目的大后期。之前的项目多数倒在了上线前或上线后不久，没有想到上线后竟然也有这么多的问题。&lt;/p&gt;
&lt;p&gt;也遇到了几次重大的线上事故，可谓是心惊肉跳，我们都开玩笑说公司应该常备速效救心丸。&lt;/p&gt;
&lt;p&gt;优化包体积，优化内存，优化性能 这些之前纸上谈兵的方案也得到了新的诠释。&lt;/p&gt;
&lt;p&gt;而且随着项目的不断推进，之前好多技术方案都不能满足需求，比如热更新，打包，国际化与本地化等等。&lt;/p&gt;
&lt;h2 id=&quot;u56E2_u961F&quot;&gt;&lt;a href=&quot;#u56E2_u961F&quot; class=&quot;headerlink&quot; title=&quot;团队&quot;&gt;&lt;/a&gt;团队&lt;/h2&gt;&lt;p&gt;从 16 年初，我之前和另一人负责的哪个项目遇到挫折，因为收费太过后期，加上模型产品太过强盛，没有发行公司敢于正面怼，所以就搁置了。另一个同事离职，我加入到了公司的另一个项目组内，这是一个非常年轻且有激情的团队，但是大家经验略有不足，便由我这个“老人”来带领这个团队。&lt;/p&gt;
&lt;p&gt;工作了这么久，几乎是第一次正是的带领团队，心中难免戚戚焉。如何快速融入团队并获得大家的认可呢？和 @zengrong 大神的选择类似，&lt;/p&gt;
&lt;blockquote&gt;
&lt;p&gt;解决一个大家开发过程中的痛点&lt;/p&gt;
&lt;/blockquote&gt;
&lt;p&gt;在负责一个小模块的时候， 我发现项目中有很多相似的控件，每个都得单独做，逻辑冗余且散落的到处都是，为什么不实现一个通用的控件去做呢？细节不赘述，最终这个控件成功的替换了所有的老控件，带来了极大的效率提升。&lt;/p&gt;
&lt;h1 id=&quot;u4E09-__u751F_u6D3B&quot;&gt;&lt;a href=&quot;#u4E09-__u751F_u6D3B&quot; class=&quot;headerlink&quot; title=&quot;三. 生活&quot;&gt;&lt;/a&gt;三. 生活&lt;/h1&gt;&lt;h2 id=&quot;u65C5_u884C&quot;&gt;&lt;a href=&quot;#u65C5_u884C&quot; class=&quot;headerlink&quot; title=&quot;旅行&quot;&gt;&lt;/a&gt;旅行&lt;/h2&gt;&lt;p&gt;在 16 年春节前，我和媳妇开始我们的 上海-杭州-苏州 之旅，为期 2 周，这个也是我和冰子出去游玩时间最长的一次。&lt;/p&gt;
&lt;p&gt;&lt;img src=&quot;https://ww2.sinaimg.cn/large/006tNc79ly1fcuzylbg29j30qd0zkjt3.jpg&quot; alt=&quot;&quot;&gt;&lt;/p&gt;
&lt;p&gt;上海东方明珠外的玻璃栈道, 杭州的汽车真的是会主动让行人的, 苏州街边的点心真的很精致. 世界这么大, 出去走走真是好.&lt;/p&gt;
&lt;h2 id=&quot;u5B66_u8F66&quot;&gt;&lt;a href=&quot;#u5B66_u8F66&quot; class=&quot;headerlink&quot; title=&quot;学车&quot;&gt;&lt;/a&gt;学车&lt;/h2&gt;&lt;p&gt;很早之前就报名了，一直没有狠下心来去学，还一直拿工作忙没时间来搪塞冰子。&lt;/p&gt;
&lt;p&gt;直到冰子一气之下直接给我报了名，我才开始拿起手机背题，这里真的要感谢《驾考宝典》这个 APP ，它上面的易错题非常牛逼，考试的时候几乎都碰上了，就这样轻松通过科目一。&lt;/p&gt;
&lt;p&gt;&lt;img src=&quot;https://ww2.sinaimg.cn/large/006tNc79ly1fcuzlkei9nj30zk0qon0u.jpg&quot; alt=&quot;&quot;&gt;&lt;/p&gt;
&lt;p&gt;科目二的时候十分艰苦，我们报的周末上午班，每天5点就要起床，有一个多月的时间的周末早晨都是在班车上度过的。科目二考试的时候因为车型的原因差点没有过，好险！&lt;/p&gt;
&lt;p&gt;科目三很简单，过不过很多时候不是由自己决定的，只要科目二学的够扎实，下面就可以交给命运了，我很幸运，一次就过了。&lt;/p&gt;
&lt;p&gt;科目四同样很简单，满分难，通过却很容易。&lt;/p&gt;
&lt;p&gt;就这样，历时两个月，我成功拿到之前根本没有想到的驾照。而冰子，她还挂在科目二呢，哈哈哈，嘲笑她一把。&lt;/p&gt;
&lt;h2 id=&quot;u80CC_u5355_u8BCD&quot;&gt;&lt;a href=&quot;#u80CC_u5355_u8BCD&quot; class=&quot;headerlink&quot; title=&quot;背单词&quot;&gt;&lt;/a&gt;背单词&lt;/h2&gt;&lt;p&gt;我大概是在 16 年初突然决定背单词的，原因我已经记不清楚了。从此，早晨公交车上，公司厕所内，晚上等车时，你都会看到一个在背单词的身影。&lt;/p&gt;
&lt;p&gt;作为一个花了好多钱学英语报班都没有坚持下来的愿望，这次真的能够成功吗？&lt;/p&gt;
&lt;p&gt;&lt;img src=&quot;https://ww1.sinaimg.cn/large/006tNc79ly1fcuzpmd3y5j30k00zkgnl.jpg&quot; alt=&quot;&quot;&gt;&lt;/p&gt;
&lt;p&gt;这次能坚持，完全归功于《百词斩》，宏爷很早之前就给我安利过这款产品，当时功能还很简陋，没有坚持下来。&lt;/p&gt;
&lt;p&gt;背单词对我的帮助十分大，现在我已经可以很简单的浏览 Stack Overflow 了，能看懂每一个答案在说什么，甚至已经可以自己去回答帮助别人了。&lt;/p&gt;
&lt;h2 id=&quot;u751F_u65E5&quot;&gt;&lt;a href=&quot;#u751F_u65E5&quot; class=&quot;headerlink&quot; title=&quot;生日&quot;&gt;&lt;/a&gt;生日&lt;/h2&gt;&lt;p&gt;这一年最大惊喜就是冰子为我准备的生日派对, 我从小都没有这样过过生日. &lt;/p&gt;
&lt;p&gt;&lt;img src=&quot;https://ww2.sinaimg.cn/large/006tNc79ly1fcv02ph5dzj30zk0qowgn.jpg&quot; alt=&quot;&quot;&gt;&lt;/p&gt;
&lt;p&gt;虽然很朴素, 但可以看到用了很多心, 听说冰子吹气球吹的腮帮疼, 哈哈 , 好傻 ! 谢谢你, 老婆, 永远爱你 !&lt;/p&gt;
&lt;h1 id=&quot;u56DB-__u5241_u624B&quot;&gt;&lt;a href=&quot;#u56DB-__u5241_u624B&quot; class=&quot;headerlink&quot; title=&quot;四. 剁手&quot;&gt;&lt;/a&gt;四. 剁手&lt;/h1&gt;&lt;h2 id=&quot;u5C0F_u7C73_u5708_u94C1_u8033_u673A&quot;&gt;&lt;a href=&quot;#u5C0F_u7C73_u5708_u94C1_u8033_u673A&quot; class=&quot;headerlink&quot; title=&quot;小米圈铁耳机&quot;&gt;&lt;/a&gt;小米圈铁耳机&lt;/h2&gt;&lt;p&gt;&lt;img src=&quot;https://ww2.sinaimg.cn/large/006tNc79ly1fcuxwqotzcj30qd0zkq4e.jpg&quot; alt=&quot;&quot;&gt;&lt;/p&gt;
&lt;p&gt;上一个耳机 KOSS PORTAPRO 挂掉之后, 就不打算买头戴式的了, 麻烦不说还容易坏. 在微博上看到谁说这个耳机还不错, 便入手了. 总体来说, 算不上惊艳, 但还算好用, 毕竟 &lt;code&gt;99&lt;/code&gt; 的价位也不会对它有什么过分的要求.&lt;/p&gt;
&lt;h2 id=&quot;u5C0F_u7C73max&quot;&gt;&lt;a href=&quot;#u5C0F_u7C73max&quot; class=&quot;headerlink&quot; title=&quot;小米max&quot;&gt;&lt;/a&gt;小米max&lt;/h2&gt;&lt;p&gt;&lt;img src=&quot;https://ww4.sinaimg.cn/large/006tNc79ly1fcuzds4awbj30zk0qota8.jpg&quot; alt=&quot;&quot;&gt;&lt;/p&gt;
&lt;p&gt;买的时候想的很好, 大屏可以用来看书, 实际却很少看书. 总而言之, 质量没的说, 我对小米的手机就没有失望过, 但是大屏单手操作还是有所不便, 买的时候还是要慎重一些.&lt;/p&gt;
&lt;hr&gt;
&lt;p&gt;总而言之, 这是充实而又愉快的 2016 年, 工作和家庭都很顺心, 希望 17 年能继续保持下去. &lt;/p&gt;
</content>
    
    <summary type="html">
    
      又到了一年树新风(tree new bee)的时候啦
    
    </summary>
    
    
      <category term="年结" scheme="http://blog.justbilt.com/tags/%E5%B9%B4%E7%BB%93/"/>
    
  </entry>
  
  <entry>
    <title>quick-x 视频播放</title>
    <link href="http://blog.justbilt.com/2016/12/10/quickx-playvideo/"/>
    <id>http://blog.justbilt.com/2016/12/10/quickx-playvideo/</id>
    <published>2016-12-10T14:00:28.000Z</published>
    <updated>2017-03-12T02:22:53.000Z</updated>
    
    <content type="html">&lt;p&gt;今天我们来聊聊 QuickX 中播放视频的那些事. &lt;/p&gt;
&lt;p&gt;这篇文章来自于日常的笔记, 年代可能会有些久远, 加上当时最开始视频播放不是我来做的, 所以有些地方我的理解也不是很深刻. 若是有什么不对的地方, 还望大家不吝赐教.&lt;/p&gt;
&lt;h1 id=&quot;u4E00-__u57FA_u672C_u7528_u6CD5&quot;&gt;&lt;a href=&quot;#u4E00-__u57FA_u672C_u7528_u6CD5&quot; class=&quot;headerlink&quot; title=&quot;一. 基本用法&quot;&gt;&lt;/a&gt;一. 基本用法&lt;/h1&gt;&lt;p&gt;播放一段视频:&lt;/p&gt;
&lt;figure class=&quot;highlight lua&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;1&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;2&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;3&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;4&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;5&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;6&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;7&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;8&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;9&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;keyword&quot;&gt;local&lt;/span&gt; video = ccexp.VideoPlayer:create()&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;video:setPosition(cc.p(display.cx, display.cy))&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;video:setAnchorPoint(cc.p(&lt;span class=&quot;number&quot;&gt;0.5&lt;/span&gt;, &lt;span class=&quot;number&quot;&gt;0.5&lt;/span&gt;))&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;video:setContentSize(cc.size(display.width, display.height))&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;video:setFileName(&lt;span class=&quot;string&quot;&gt;&quot;res/start_video.mp4&quot;&lt;/span&gt;)&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;video:setKeepAspectRatioEnabled(&lt;span class=&quot;keyword&quot;&gt;true&lt;/span&gt;)&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;video:setFullScreenEnabled(&lt;span class=&quot;keyword&quot;&gt;true&lt;/span&gt;)&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;self:addChild(video)&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;
&lt;p&gt;监听视屏播放事件:&lt;/p&gt;
&lt;figure class=&quot;highlight lua&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;1&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;2&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;3&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;4&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;5&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;6&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;7&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;8&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;9&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;10&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;keyword&quot;&gt;local&lt;/span&gt; &lt;span class=&quot;function&quot;&gt;&lt;span class=&quot;keyword&quot;&gt;function&lt;/span&gt; &lt;span class=&quot;title&quot;&gt;onVideoEventCallback&lt;/span&gt;&lt;span class=&quot;params&quot;&gt;(sender, eventType)&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    &lt;span class=&quot;built_in&quot;&gt;print&lt;/span&gt;(&lt;span class=&quot;string&quot;&gt;&quot;onVideoEventCallback:&quot;&lt;/span&gt;, eventType)&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    &lt;span class=&quot;keyword&quot;&gt;if&lt;/span&gt; eventType == ccexp.VideoPlayerEvent.PLAYING &lt;span class=&quot;keyword&quot;&gt;then&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    &lt;span class=&quot;keyword&quot;&gt;elseif&lt;/span&gt; eventType == ccexp.VideoPlayerEvent.PAUSED &lt;span class=&quot;keyword&quot;&gt;then&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    &lt;span class=&quot;keyword&quot;&gt;elseif&lt;/span&gt; eventType == ccexp.VideoPlayerEvent.STOPPED &lt;span class=&quot;keyword&quot;&gt;then&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    &lt;span class=&quot;keyword&quot;&gt;elseif&lt;/span&gt; eventType == ccexp.VideoPlayerEvent.COMPLETED &lt;span class=&quot;keyword&quot;&gt;then&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    &lt;span class=&quot;keyword&quot;&gt;end&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;keyword&quot;&gt;end&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;video:addEventListener(onVideoEventCallback)&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;video:play()&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;
&lt;blockquote&gt;
&lt;p&gt;然而你做完这一切还是可能会播放不出来视频, 没有关系, 多播放几次就出来啦.&lt;/p&gt;
&lt;/blockquote&gt;
&lt;h1 id=&quot;u4E8C-__u9047_u5230_u7684_u95EE_u9898&quot;&gt;&lt;a href=&quot;#u4E8C-__u9047_u5230_u7684_u95EE_u9898&quot; class=&quot;headerlink&quot; title=&quot;二. 遇到的问题&quot;&gt;&lt;/a&gt;二. 遇到的问题&lt;/h1&gt;&lt;h2 id=&quot;u95EE_u9898_1_3A_iOS__u64AD_u653E_u89C6_u9891_u5B8C_u540E_u9ED1_u5C4F&quot;&gt;&lt;a href=&quot;#u95EE_u9898_1_3A_iOS__u64AD_u653E_u89C6_u9891_u5B8C_u540E_u9ED1_u5C4F&quot; class=&quot;headerlink&quot; title=&quot;问题 1: iOS 播放视频完后黑屏&quot;&gt;&lt;/a&gt;问题 1: iOS 播放视频完后黑屏&lt;/h2&gt;&lt;p&gt;cocos2dx 3.3 iOS端播放视频完后黑屏, 控制台中提示日志: OpenGL error 0x0506 in -[CCEAGLView swapBuffers] 324&lt;/p&gt;
&lt;p&gt;解决方案:&lt;/p&gt;
&lt;p&gt;&lt;a href=&quot;http://www.cnblogs.com/cc4coco/p/4188347.html&quot; target=&quot;_blank&quot; rel=&quot;external&quot;&gt;http://www.cnblogs.com/cc4coco/p/4188347.html&lt;/a&gt;&lt;/p&gt;
&lt;figure class=&quot;highlight objc&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;1&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;2&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;3&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;4&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;5&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;6&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;7&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;8&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;9&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;10&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;11&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;-(&lt;span class=&quot;keyword&quot;&gt;void&lt;/span&gt;) viewDidAppear:(&lt;span class=&quot;built_in&quot;&gt;BOOL&lt;/span&gt;)animated&amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    cocos2d::Director::getInstance()-&amp;gt;resume();&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    cocos2d::Director::getInstance()-&amp;gt;startAnimation();&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&amp;#125;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;- (&lt;span class=&quot;keyword&quot;&gt;void&lt;/span&gt;)viewWillDisappear:(&lt;span class=&quot;built_in&quot;&gt;BOOL&lt;/span&gt;)animated&amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    cocos2d::Director::getInstance()-&amp;gt;pause();&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    cocos2d::Director::getInstance()-&amp;gt;stopAnimation();&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&amp;#125;&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;
&lt;h2 id=&quot;u95EE_u9898_2_3A__u5728_iOS_9-2__u4EE5_u4E0A_u4F1A_u5D29_u6E83&quot;&gt;&lt;a href=&quot;#u95EE_u9898_2_3A__u5728_iOS_9-2__u4EE5_u4E0A_u4F1A_u5D29_u6E83&quot; class=&quot;headerlink&quot; title=&quot;问题 2: 在 iOS 9.2 以上会崩溃&quot;&gt;&lt;/a&gt;问题 2: 在 iOS 9.2 以上会崩溃&lt;/h2&gt;&lt;p&gt;解决方案:&lt;/p&gt;
&lt;p&gt;&lt;a href=&quot;https://github.com/cocos2d/cocos2d-x/issues/14855&quot; target=&quot;_blank&quot; rel=&quot;external&quot;&gt;https://github.com/cocos2d/cocos2d-x/issues/14855&lt;/a&gt;&lt;/p&gt;
&lt;p&gt;修改 VideoPlayer 类的析构函数, 将 &lt;code&gt;dealloc&lt;/code&gt; 改为 &lt;code&gt;release&lt;/code&gt;.&lt;/p&gt;
&lt;figure class=&quot;highlight java&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;1&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;2&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;3&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;4&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;5&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;6&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;7&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;8&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;VideoPlayer::~VideoPlayer()&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;     &lt;span class=&quot;keyword&quot;&gt;if&lt;/span&gt;(_videoView)&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;     &amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;-        [((UIVideoViewWrapperIos*)_videoView) dealloc];&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;+        [((UIVideoViewWrapperIos*)_videoView) release];&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;     &amp;#125;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&amp;#125;&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;
&lt;h2 id=&quot;u95EE_u9898_3_3A_iOS__u4E0A_u64AD_u653E_u89C6_u9891_u6709_u8FDB_u5EA6_u6761_2C__u53CC_u51FB_u53EF_u4EE5_u653E_u5927_u7F29_u5C0F_2C_Android__u70B9_u51FB_u53EF_u4EE5_u6682_u505C&quot;&gt;&lt;a href=&quot;#u95EE_u9898_3_3A_iOS__u4E0A_u64AD_u653E_u89C6_u9891_u6709_u8FDB_u5EA6_u6761_2C__u53CC_u51FB_u53EF_u4EE5_u653E_u5927_u7F29_u5C0F_2C_Android__u70B9_u51FB_u53EF_u4EE5_u6682_u505C&quot; class=&quot;headerlink&quot; title=&quot;问题 3: iOS 上播放视频有进度条, 双击可以放大缩小, Android 点击可以暂停&quot;&gt;&lt;/a&gt;问题 3: iOS 上播放视频有进度条, 双击可以放大缩小, Android 点击可以暂停&lt;/h2&gt;&lt;p&gt;解决方案:&lt;/p&gt;
&lt;p&gt;这个问题挺让人啼笑皆非的, 不知道当时设计这个类的人是如何考虑的, 至少也应该提供一个关闭的接口吧. 好, 让我们看下如何解决它.&lt;/p&gt;
&lt;p&gt;&lt;img src=&quot;http://ww3.sinaimg.cn/large/006y8lVajw1fam4s9vv7ij30dj0m9q3f.jpg&quot; alt=&quot;&quot;&gt;&lt;/p&gt;
&lt;h3 id=&quot;1-__u9690_u85CF_iOS__u64AD_u653E_u8FDB_u5EA6_u6761&quot;&gt;&lt;a href=&quot;#1-__u9690_u85CF_iOS__u64AD_u653E_u8FDB_u5EA6_u6761&quot; class=&quot;headerlink&quot; title=&quot;1. 隐藏 iOS 播放进度条&quot;&gt;&lt;/a&gt;1. 隐藏 iOS 播放进度条&lt;/h3&gt;&lt;p&gt;在 UIVideoPlayer-ios.mm 的 &lt;code&gt;-(void) setURL:(int)videoSource :(std::string &amp;amp;)videoUrl&lt;/code&gt; 函数中, 修改 &lt;code&gt;MPMovieControlStyleEmbedded&lt;/code&gt; 为 &lt;code&gt;MPMovieControlStyleNone&lt;/code&gt;:&lt;/p&gt;
&lt;figure class=&quot;highlight objc&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;1&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;2&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;-    &lt;span class=&quot;keyword&quot;&gt;self&lt;/span&gt;&lt;span class=&quot;variable&quot;&gt;.moviePlayer&lt;/span&gt;&lt;span class=&quot;variable&quot;&gt;.controlStyle&lt;/span&gt; = &lt;span class=&quot;built_in&quot;&gt;MPMovieControlStyleEmbedded&lt;/span&gt;;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;+    &lt;span class=&quot;keyword&quot;&gt;self&lt;/span&gt;&lt;span class=&quot;variable&quot;&gt;.moviePlayer&lt;/span&gt;&lt;span class=&quot;variable&quot;&gt;.controlStyle&lt;/span&gt; = &lt;span class=&quot;built_in&quot;&gt;MPMovieControlStyleNone&lt;/span&gt;;&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;
&lt;p&gt;进度条隐藏了, 但是视频播放时双击缩放的问题却无法解决.&lt;/p&gt;
&lt;h3 id=&quot;2-__u7981_u7528_Android__u70B9_u51FB_u6682_u505C&quot;&gt;&lt;a href=&quot;#2-__u7981_u7528_Android__u70B9_u51FB_u6682_u505C&quot; class=&quot;headerlink&quot; title=&quot;2. 禁用 Android 点击暂停&quot;&gt;&lt;/a&gt;2. 禁用 Android 点击暂停&lt;/h3&gt;&lt;p&gt;修改 &lt;code&gt;Cocos2dxWebView.java&lt;/code&gt; 中的 &lt;code&gt;onTouchEvent&lt;/code&gt; 函数&lt;/p&gt;
&lt;figure class=&quot;highlight java&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;1&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;2&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;3&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;4&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;5&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;6&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;7&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;8&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;9&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;10&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;11&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;12&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;13&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;    &lt;span class=&quot;annotation&quot;&gt;@Override&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    &lt;span class=&quot;function&quot;&gt;&lt;span class=&quot;keyword&quot;&gt;public&lt;/span&gt; &lt;span class=&quot;keyword&quot;&gt;boolean&lt;/span&gt; &lt;span class=&quot;title&quot;&gt;onTouchEvent&lt;/span&gt;&lt;span class=&quot;params&quot;&gt;(MotionEvent event)&lt;/span&gt; &lt;/span&gt;&amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;comment&quot;&gt;//        if((event.getAction() &amp;amp; MotionEvent.ACTION_MASK) == MotionEvent.ACTION_UP)&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;comment&quot;&gt;//        &amp;#123;&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;comment&quot;&gt;//            if (isPlaying()) &amp;#123;&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;comment&quot;&gt;//                pause();&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;comment&quot;&gt;//            &amp;#125; else if(mCurrentState == STATE_PAUSED)&amp;#123;&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;comment&quot;&gt;//                resume();&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;comment&quot;&gt;//            &amp;#125;&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;comment&quot;&gt;//        &amp;#125;&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;        &lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;        &lt;span class=&quot;keyword&quot;&gt;return&lt;/span&gt; &lt;span class=&quot;keyword&quot;&gt;true&lt;/span&gt;;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    &amp;#125;&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;
&lt;h2 id=&quot;u95EE_u9898_4_3A_vivo_u624B_u673A_u65E0_u6CD5_u64AD_u653E_u89C6_u9891_u7684bug&quot;&gt;&lt;a href=&quot;#u95EE_u9898_4_3A_vivo_u624B_u673A_u65E0_u6CD5_u64AD_u653E_u89C6_u9891_u7684bug&quot; class=&quot;headerlink&quot; title=&quot;问题 4: vivo手机无法播放视频的bug&quot;&gt;&lt;/a&gt;问题 4: vivo手机无法播放视频的bug&lt;/h2&gt;&lt;p&gt;解决方案:&lt;/p&gt;
&lt;p&gt;经过断点跟踪, 定位到了原因, 视频的尺寸获取的有问题, 我尝试修改了 &lt;code&gt;setVideoRect&lt;/code&gt; 函数中的两行代码:&lt;/p&gt;
&lt;figure class=&quot;highlight java&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;1&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;2&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;3&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;4&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;-        mViewWidth = maxWidth;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;-        mViewHeight = maxHeight;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;+        mViewWidth = &lt;span class=&quot;number&quot;&gt;1&lt;/span&gt;;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;+        mViewHeight = &lt;span class=&quot;number&quot;&gt;1&lt;/span&gt;;&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;
&lt;p&gt;很神奇的解决了这个问题.&lt;/p&gt;
&lt;h2 id=&quot;u95EE_u9898_5_3A__u591A_u6B21_u8C03_u7528_u53EF_u80FD_u4F1A_u906E_u6321_SDK__u7684_u5F39_u51FA_u754C_u9762&quot;&gt;&lt;a href=&quot;#u95EE_u9898_5_3A__u591A_u6B21_u8C03_u7528_u53EF_u80FD_u4F1A_u906E_u6321_SDK__u7684_u5F39_u51FA_u754C_u9762&quot; class=&quot;headerlink&quot; title=&quot;问题 5: 多次调用可能会遮挡 SDK 的弹出界面&quot;&gt;&lt;/a&gt;问题 5: 多次调用可能会遮挡 SDK 的弹出界面&lt;/h2&gt;&lt;p&gt;我们游戏中有一个重启的功能, 每次重启都会播放一个视频, 这样某些渠道的登录界面就看不到了, 另一个不播放视屏的项目就没有问题, 好像是每次播放都会提高游戏的层级.&lt;/p&gt;
&lt;p&gt;解决方案:&lt;/p&gt;
&lt;p&gt;遍历所有 window , 找到 SDK 的那个 window, 将它的 windowLevel 提高一级.&lt;/p&gt;
&lt;figure class=&quot;highlight objc&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;1&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;2&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;3&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;4&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;5&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;6&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;keyword&quot;&gt;for&lt;/span&gt;(&lt;span class=&quot;built_in&quot;&gt;UIWindow&lt;/span&gt; * w &lt;span class=&quot;keyword&quot;&gt;in&lt;/span&gt; [[&lt;span class=&quot;built_in&quot;&gt;UIApplication&lt;/span&gt; sharedApplication]windows])&amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    &lt;span class=&quot;keyword&quot;&gt;if&lt;/span&gt; ([w isKindOfClass:&lt;span class=&quot;built_in&quot;&gt;NSClassFromString&lt;/span&gt;(&lt;span class=&quot;string&quot;&gt;@&quot;XSDKOriginalWindow&quot;&lt;/span&gt;)]) &amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;        [w setWindowLevel:[[[&lt;span class=&quot;built_in&quot;&gt;UIApplication&lt;/span&gt; sharedApplication]keyWindow]windowLevel]+&lt;span class=&quot;number&quot;&gt;1&lt;/span&gt;];&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;        &lt;span class=&quot;keyword&quot;&gt;break&lt;/span&gt;;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    &amp;#125;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&amp;#125;&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;
&lt;h2 id=&quot;u95EE_u9898_6_3A__u8FD8_u6709_u4EC0_u4E48_u95EE_u9898_2C__u90FD_u8BF4_u4E86_u5427&quot;&gt;&lt;a href=&quot;#u95EE_u9898_6_3A__u8FD8_u6709_u4EC0_u4E48_u95EE_u9898_2C__u90FD_u8BF4_u4E86_u5427&quot; class=&quot;headerlink&quot; title=&quot;问题 6: 还有什么问题, 都说了吧&quot;&gt;&lt;/a&gt;问题 6: 还有什么问题, 都说了吧&lt;/h2&gt;&lt;p&gt;如果播放时候是黑屏，把游戏切到后台，再进入游戏就能从头播放！&lt;br&gt;如果播放时候正常，切到后台再切回来就变成黑屏&lt;/p&gt;
&lt;p&gt;&lt;a href=&quot;http://www.cocoachina.com/bbs/read.php?tid-306892.html&quot; target=&quot;_blank&quot; rel=&quot;external&quot;&gt;http://www.cocoachina.com/bbs/read.php?tid-306892.html&lt;/a&gt;&lt;/p&gt;
&lt;p&gt;Cocos2d-x V3.10版本中的videoplayer问题&lt;br&gt;&lt;a href=&quot;http://www.voidcn.com/blog/sh15285118586/article/p-5989468.html&quot; target=&quot;_blank&quot; rel=&quot;external&quot;&gt;http://www.voidcn.com/blog/sh15285118586/article/p-5989468.html&lt;/a&gt;&lt;/p&gt;
&lt;p&gt;关于cocos2dx 3.x VideoPlayer的问题&lt;br&gt;&lt;a href=&quot;http://blog.sina.com.cn/s/blog_93add5520102w6n9.html&quot; target=&quot;_blank&quot; rel=&quot;external&quot;&gt;http://blog.sina.com.cn/s/blog_93add5520102w6n9.html&lt;/a&gt;&lt;/p&gt;
&lt;p&gt;cocos2d-x视频控件VideoPlayer的用户操作栏进度条去除&lt;br&gt;&lt;a href=&quot;http://blog.csdn.net/pklll000pp44/article/details/51337577&quot; target=&quot;_blank&quot; rel=&quot;external&quot;&gt;http://blog.csdn.net/pklll000pp44/article/details/51337577&lt;/a&gt;&lt;/p&gt;
&lt;hr&gt;
&lt;p&gt;还真的是问题一大堆呢! 大家最好还是回去和策划大大商量下, 别播放视频了.&lt;/p&gt;
</content>
    
    <summary type="html">
    
      半成品, 别用!
    
    </summary>
    
    
      <category term="Quick-Cocos2d-x" scheme="http://blog.justbilt.com/tags/Quick-Cocos2d-x/"/>
    
      <category term="videoplayer" scheme="http://blog.justbilt.com/tags/videoplayer/"/>
    
  </entry>
  
  <entry>
    <title>一个命令行的 TexturePacker 拆解工具  (二)</title>
    <link href="http://blog.justbilt.com/2016/10/29/untp-2/"/>
    <id>http://blog.justbilt.com/2016/10/29/untp-2/</id>
    <published>2016-10-29T15:39:18.000Z</published>
    <updated>2017-03-12T01:22:39.000Z</updated>
    
    <content type="html">&lt;p&gt;距离第一版的 &lt;code&gt;untp&lt;/code&gt; 发布已经有一年半的时间了, 在这个项目上我收获了很多的第一次:&lt;/p&gt;
&lt;blockquote&gt;
&lt;p&gt;第一次有一个项目的 star 数超过 50&lt;br&gt;第一次往 pypi 上上传项目&lt;br&gt;第一次如此认真的维护一个项目&lt;br&gt;…&lt;/p&gt;
&lt;/blockquote&gt;
&lt;p&gt;这篇文章已经是关于 untp 的第三篇文章了, 所有的文章列表可以&lt;a href=&quot;/tags/untp&quot;&gt;查看这里&lt;/a&gt;. 下面我来讲讲 untp 最近的几次更新以及后续的一个维护计划.&lt;/p&gt;
&lt;h1 id=&quot;u4E00-__u66F4_u65B0&quot;&gt;&lt;a href=&quot;#u4E00-__u66F4_u65B0&quot; class=&quot;headerlink&quot; title=&quot;一. 更新&quot;&gt;&lt;/a&gt;一. 更新&lt;/h1&gt;&lt;h2 id=&quot;1-0-5&quot;&gt;&lt;a href=&quot;#1-0-5&quot; class=&quot;headerlink&quot; title=&quot;1.0.5&quot;&gt;&lt;/a&gt;1.0.5&lt;/h2&gt;&lt;ol&gt;
&lt;li&gt;拆解单个文件时支持 &lt;code&gt;-o&lt;/code&gt; 参数指定输出目录&lt;/li&gt;
&lt;li&gt;可以在 &lt;code&gt;python&lt;/code&gt; 中 &lt;code&gt;import&lt;/code&gt;&lt;/li&gt;
&lt;li&gt;支持 cocos2d/cocos2d-x v3 格式&lt;/li&gt;
&lt;/ol&gt;
&lt;h2 id=&quot;1-0-4&quot;&gt;&lt;a href=&quot;#1-0-4&quot; class=&quot;headerlink&quot; title=&quot;1.0.4&quot;&gt;&lt;/a&gt;1.0.4&lt;/h2&gt;&lt;ol&gt;
&lt;li&gt;使用 argparse 解析调用参数, 支持更多选项&lt;/li&gt;
&lt;li&gt;捕获图片打开异常, 程序更加健壮&lt;/li&gt;
&lt;li&gt;支持文件夹递归查找所有 plist 拆解&lt;/li&gt;
&lt;/ol&gt;
&lt;h2 id=&quot;1-0-3&quot;&gt;&lt;a href=&quot;#1-0-3&quot; class=&quot;headerlink&quot; title=&quot;1.0.3&quot;&gt;&lt;/a&gt;1.0.3&lt;/h2&gt;&lt;ol&gt;
&lt;li&gt;修复依赖 Pillow 模块版本大于 3.0 时图片输出错误&lt;/li&gt;
&lt;/ol&gt;
&lt;h2 id=&quot;1-0-2&quot;&gt;&lt;a href=&quot;#1-0-2&quot; class=&quot;headerlink&quot; title=&quot;1.0.2&quot;&gt;&lt;/a&gt;1.0.2&lt;/h2&gt;&lt;ol&gt;
&lt;li&gt;兼容 python3&lt;/li&gt;
&lt;li&gt;放弃之前的打包发布, 改为 pypi 发布&lt;/li&gt;
&lt;li&gt;修复一处路径错误&lt;/li&gt;
&lt;li&gt;根据 python code style 优化代码&lt;/li&gt;
&lt;li&gt;pvr,pvr.czz 格式支持 (需要安装 &lt;code&gt;TexturePacker&lt;/code&gt; 命令行工具)&lt;/li&gt;
&lt;/ol&gt;
&lt;h1 id=&quot;u4E8C-__u540E_u7EED_u8BA1_u5212&quot;&gt;&lt;a href=&quot;#u4E8C-__u540E_u7EED_u8BA1_u5212&quot; class=&quot;headerlink&quot; title=&quot;二. 后续计划&quot;&gt;&lt;/a&gt;二. 后续计划&lt;/h1&gt;&lt;p&gt;untp 这个项目最初来源于项目中的一个需求, 所以开始只是为了自用, 开源之后发现有能帮助一些人, 顺便实现一下他们的一些小需求, 自我更新动力并不是很足, 因此更新的频率不是很高.&lt;/p&gt;
&lt;p&gt;之前的发展策略我一直都是按着更便捷安装, 更方便使用方向上走的, 从一开始的 PyInstaller 打包到后面的上传到 pypi , 从开始只支持单一文件到支持目录, 都是按照这个思路搞的.至于后面如何发展我也没有很好的想法, 或许让它停留在这一版也很好. 今天看到张小龙的一篇内部分享, 一个好的工具就应该只是一个工具, 想到就用, 用完就走, 不要想着把用户黏住.&lt;/p&gt;
&lt;p&gt;所以, untp 就只是一个拆解大图的工具, 绝对不做其他的功能. 在这个原则的基础上, 有这么几个方向去搞:&lt;/p&gt;
&lt;ol&gt;
&lt;li&gt;GUI 界面的支持&lt;/li&gt;
&lt;li&gt;支持更多的格式&lt;/li&gt;
&lt;/ol&gt;
&lt;p&gt;我想使用这个工具的人可能不一定是程序员, 他们不一定懂 pip , 不一定会打开终端. 所以一个 GUI 的界面就很重要了. 第二个是可以让更多引擎的开发者来使用, 现在只支持 cocos 是有些狭隘了, 对自己也是一个很好地的锻炼.&lt;/p&gt;
&lt;p&gt;如果你还有更好的建议, 欢迎在评论里或者 &lt;a href=&quot;https://github.com/justbilt/untp/issues&quot; target=&quot;_blank&quot; rel=&quot;external&quot;&gt;issue&lt;/a&gt; 中提出.&lt;/p&gt;
&lt;h1 id=&quot;u4E09-__u4E2D_u6587_u4F7F_u7528_u8BF4_u660E_28_u6301_u7EED_u66F4_u65B0_29&quot;&gt;&lt;a href=&quot;#u4E09-__u4E2D_u6587_u4F7F_u7528_u8BF4_u660E_28_u6301_u7EED_u66F4_u65B0_29&quot; class=&quot;headerlink&quot; title=&quot;三. 中文使用说明(持续更新)&quot;&gt;&lt;/a&gt;三. 中文使用说明(持续更新)&lt;/h1&gt;&lt;h2 id=&quot;1-__u5B89_u88C5&quot;&gt;&lt;a href=&quot;#1-__u5B89_u88C5&quot; class=&quot;headerlink&quot; title=&quot;1. 安装&quot;&gt;&lt;/a&gt;1. 安装&lt;/h2&gt;&lt;p&gt;现在可以采用两种方式安装, 在终端中键入 &lt;code&gt;pip install untp&lt;/code&gt; 或者 clone 代码到本地, 在根目录 &lt;code&gt;python setup install&lt;/code&gt; .&lt;/p&gt;
&lt;h2 id=&quot;2-__u4F7F_u7528&quot;&gt;&lt;a href=&quot;#2-__u4F7F_u7528&quot; class=&quot;headerlink&quot; title=&quot;2. 使用&quot;&gt;&lt;/a&gt;2. 使用&lt;/h2&gt;&lt;p&gt;当我们在终端中键入 &lt;code&gt;untp -h&lt;/code&gt; 后, 会得到下面这段输出:&lt;/p&gt;
&lt;figure class=&quot;highlight plain&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;1&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;usage:&amp;#10;untp ../btn.plist&amp;#10;untp ../btn.plist -i ../btn.png&amp;#10;untp ../data&amp;#10;untp ../data -r&amp;#10;&amp;#10;positional arguments:&amp;#10;  path                  plist file name or directory&amp;#10;&amp;#10;optional arguments:&amp;#10;  -h, --help            show this help message and exit&amp;#10;&amp;#10;For file:&amp;#10;  -i image_file, --image_file image_file&amp;#10;                        specified image file for plist&amp;#10;  -o output, --output output&amp;#10;                        specified output directory&amp;#10;&amp;#10;For directory:&amp;#10;  -r, --recursive&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;
&lt;p&gt;对于单个 plist 文件, 可以 &lt;code&gt;untp xxx.plist&lt;/code&gt; 来拆解它, 会读取 plist 中配置的图片输出到同名的目录中, 可以使用 &lt;code&gt;-i&lt;/code&gt; 指定图片, &lt;code&gt;-o&lt;/code&gt; 指定输出目录.&lt;/p&gt;
&lt;p&gt;对于目录, 使用 &lt;code&gt;untp path&lt;/code&gt; path 是包含 &lt;code&gt;plist&lt;/code&gt; 文件的目录, 可以使用 &lt;code&gt;-r&lt;/code&gt; 参数指定遍历子目录.&lt;/p&gt;
&lt;p&gt;(以上)&lt;/p&gt;
</content>
    
    <summary type="html">
    
      中文使用说明
    
    </summary>
    
    
      <category term="Tool" scheme="http://blog.justbilt.com/tags/Tool/"/>
    
      <category term="untp" scheme="http://blog.justbilt.com/tags/untp/"/>
    
  </entry>
  
  <entry>
    <title>quick-x utf8 支持</title>
    <link href="http://blog.justbilt.com/2016/09/23/quickx-utf8-support/"/>
    <id>http://blog.justbilt.com/2016/09/23/quickx-utf8-support/</id>
    <published>2016-09-22T22:58:40.000Z</published>
    <updated>2017-03-12T02:22:53.000Z</updated>
    
    <content type="html">&lt;h1 id=&quot;u4E00-__u9700_u6C42&quot;&gt;&lt;a href=&quot;#u4E00-__u9700_u6C42&quot; class=&quot;headerlink&quot; title=&quot;一. 需求&quot;&gt;&lt;/a&gt;一. 需求&lt;/h1&gt;&lt;h2 id=&quot;1-__u8BA1_u7B97_u73A9_u5BB6_u540D_u5B57_u5B57_u7B26_u6570&quot;&gt;&lt;a href=&quot;#1-__u8BA1_u7B97_u73A9_u5BB6_u540D_u5B57_u5B57_u7B26_u6570&quot; class=&quot;headerlink&quot; title=&quot;1. 计算玩家名字字符数&quot;&gt;&lt;/a&gt;1. 计算玩家名字字符数&lt;/h2&gt;&lt;p&gt;对于这个需求一般情况下 &lt;code&gt;string.len&lt;/code&gt; 或 quick 自带的 &lt;code&gt;string.utf8len&lt;/code&gt; 就能满足, 但是如果需求是:&lt;/p&gt;
&lt;blockquote&gt;
&lt;p&gt;对于像 中文/日文/韩文 这样的方块字一个占 2 个长度, 其他字符占 1 个长度.&lt;/p&gt;
&lt;/blockquote&gt;
&lt;p&gt;该如何满足呢 ? &lt;/p&gt;
&lt;h2 id=&quot;2-__u5C4F_u853D_emoji__u8868_u60C5&quot;&gt;&lt;a href=&quot;#2-__u5C4F_u853D_emoji__u8868_u60C5&quot; class=&quot;headerlink&quot; title=&quot;2. 屏蔽 emoji 表情&quot;&gt;&lt;/a&gt;2. 屏蔽 emoji 表情&lt;/h2&gt;&lt;p&gt;我们游戏的聊天/起名都是不允许输入 emoji 表情的, 那么该如何判断玩家输入的文字中包含 emoji 表情呢 ? &lt;/p&gt;
&lt;p&gt;在我之前的文章(&lt;a href=&quot;/2016/05/01/quickx-editbox-util/#u4E8C-__u5C4F_u853D_Emoji__u8F93_u5165&quot;&gt;quick-x EditBox 几个小技巧&lt;/a&gt;)中有提到过这个需求, 当时分析了下有两个解决方案:&lt;/p&gt;
&lt;ol&gt;
&lt;li&gt;无法输入, 弹出键盘点击表情没有反应&lt;/li&gt;
&lt;li&gt;输入完成后, 游戏内点击提交时提示非法&lt;/li&gt;
&lt;/ol&gt;
&lt;p&gt;本来打算是使用&lt;strong&gt;方法2&lt;/strong&gt;的, 苦于无法在 lua 这边识别出 emoji , 所以只能曲线救国的使用的&lt;strong&gt;方法1&lt;/strong&gt;, 每个平台得单独实现不说, 还容易出 bug, 出了 bug 亦无法热更新修复.&lt;/p&gt;
&lt;p&gt;最近还真是遇到了 bug , 会导致在 ios 上无法使用&lt;strong&gt;九宫格&lt;/strong&gt;输入法.&lt;/p&gt;
&lt;hr&gt;
&lt;p&gt;以上两个问题, 如果支持 utf8 的话, 我们可以遍历整个字符串, 判断每个字符的 &lt;code&gt;codepoint&lt;/code&gt; 是否在某个码区中. 所以我们需要实现这么几个接口:&lt;/p&gt;
&lt;ol&gt;
&lt;li&gt;utf8 长度计算&lt;/li&gt;
&lt;li&gt;遍历 utf8&lt;/li&gt;
&lt;li&gt;utf8 char/byte 实现&lt;/li&gt;
&lt;/ol&gt;
&lt;h1 id=&quot;u4E8C-__u5B9E_u73B0&quot;&gt;&lt;a href=&quot;#u4E8C-__u5B9E_u73B0&quot; class=&quot;headerlink&quot; title=&quot;二. 实现&quot;&gt;&lt;/a&gt;二. 实现&lt;/h1&gt;&lt;h2 id=&quot;1-__u4F7F_u7528_clib__u5B9E_u73B0&quot;&gt;&lt;a href=&quot;#1-__u4F7F_u7528_clib__u5B9E_u73B0&quot; class=&quot;headerlink&quot; title=&quot;1. 使用 clib 实现&quot;&gt;&lt;/a&gt;1. 使用 clib 实现&lt;/h2&gt;&lt;p&gt;Google 搜索 &lt;code&gt;lua utf8&lt;/code&gt; 很快发现了 &lt;a href=&quot;/2016/05/01/quickx-editbox-util/#u4E8C-__u5C4F_u853D_Emoji__u8F93_u5165&quot;&gt;luautf8&lt;/a&gt; 这个项目, 100 多个 star , 对于一个 lua 项目, 已经算很多了. 实现也很简单, 就 &lt;code&gt;unidata.h&lt;/code&gt; 和 &lt;code&gt;lutf8lib.c&lt;/code&gt; 两个文件.&lt;/p&gt;
&lt;p&gt;下面我们在 quick 中集成这个项目, 我们在 &lt;code&gt;quick-cocos2d-x/external/lua&lt;/code&gt; 目录先新建一个 &lt;code&gt;utf8&lt;/code&gt; 目录, 将上面提到的那两个文件下载下来放进去, 修改 &lt;code&gt;lutf8lib.c:1303&lt;/code&gt; 行:&lt;/p&gt;
&lt;figure class=&quot;highlight c&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;1&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;2&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;3&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;comment&quot;&gt;//  lua_createtable(L, 0, sizeof(libs)/sizeof(libs[0]));&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;comment&quot;&gt;//  luaL_register(L, NULL, libs);&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;  luaL_openlib(L, &lt;span class=&quot;string&quot;&gt;&quot;utf8&quot;&lt;/span&gt;, libs, &lt;span class=&quot;number&quot;&gt;0&lt;/span&gt;);&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;
&lt;p&gt;为了在别的文件中能够访问到 &lt;code&gt;luaopen_utf8&lt;/code&gt; 函数, 我们还需要新建一个 &lt;code&gt;utf8lib.h&lt;/code&gt; 头文件:&lt;/p&gt;
&lt;figure class=&quot;highlight c&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;1&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;2&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;3&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;4&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;5&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;6&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;7&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;8&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;9&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;10&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;11&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;12&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;13&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;14&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;15&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;preprocessor&quot;&gt;#&lt;span class=&quot;keyword&quot;&gt;ifndef&lt;/span&gt; LUAUTF8_H&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;preprocessor&quot;&gt;#&lt;span class=&quot;keyword&quot;&gt;define&lt;/span&gt; LUAUTF8_H&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;preprocessor&quot;&gt;#&lt;span class=&quot;keyword&quot;&gt;include&lt;/span&gt; &lt;span class=&quot;string&quot;&gt;&quot;lua.h&quot;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;preprocessor&quot;&gt;#&lt;span class=&quot;keyword&quot;&gt;ifndef&lt;/span&gt; LUALIB_API&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;preprocessor&quot;&gt;#&lt;span class=&quot;keyword&quot;&gt;define&lt;/span&gt; LUALIB_API extern&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;preprocessor&quot;&gt;#&lt;span class=&quot;keyword&quot;&gt;endif&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;comment&quot;&gt;/*-------------------------------------------------------------------------*\&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;* Initializes the library.&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;\*-------------------------------------------------------------------------*/&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;function&quot;&gt;LUALIB_API &lt;span class=&quot;keyword&quot;&gt;int&lt;/span&gt; &lt;span class=&quot;title&quot;&gt;luaopen_utf8&lt;/span&gt;&lt;span class=&quot;params&quot;&gt;(lua_State *L)&lt;/span&gt;&lt;/span&gt;;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;preprocessor&quot;&gt;#&lt;span class=&quot;keyword&quot;&gt;endif&lt;/span&gt; &lt;span class=&quot;comment&quot;&gt;/* LUAUTF8_H */&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;
&lt;p&gt;下面我们就可以注册这个库了, 修改 &lt;code&gt;cocos/scripting/lua-bindings/manual/network/lua_extensions.c&lt;/code&gt; :&lt;/p&gt;
&lt;figure class=&quot;highlight c&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;1&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;2&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;3&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;4&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;5&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;6&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;preprocessor&quot;&gt;#&lt;span class=&quot;keyword&quot;&gt;include&lt;/span&gt; &lt;span class=&quot;string&quot;&gt;&quot;utf8/lutf8lib.h&quot;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;function&quot;&gt;&lt;span class=&quot;keyword&quot;&gt;void&lt;/span&gt; &lt;span class=&quot;title&quot;&gt;luaopen_lua_extensions&lt;/span&gt;&lt;span class=&quot;params&quot;&gt;(lua_State *L)&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;/span&gt;&amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    ...&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    luaopen_utf8(L);&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&amp;#125;&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;
&lt;p&gt;同时我们还需要修改编译脚本, 使得在不同平台上能够编译通过, Android 需要修改&lt;/p&gt;
&lt;p&gt; &lt;code&gt;cocos/scripting/lua-bindings/proj.android/Android.mk&lt;/code&gt; 文件:&lt;/p&gt;
&lt;figure class=&quot;highlight mk&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;1&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;2&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;3&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;constant&quot;&gt;LOCAL_SRC_FILES&lt;/span&gt; += ../manual/network/lua_cocos2dx_network_manual.cpp \&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;                   ../../../../external/lua/luasocket/usocket.c \&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;                   ../../../../external/lua/utf8/lutf8lib.c&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;
&lt;p&gt;在 &lt;code&gt;LOCAL_SRC_FILES&lt;/code&gt; 末尾加上 &lt;code&gt;lutf8lib.c&lt;/code&gt; .&lt;/p&gt;
&lt;p&gt;iOS/Mac 的话, 在 XCode 中将整个 &lt;code&gt;utf8&lt;/code&gt; 目录加入进来就可以呀, 如下图所示:&lt;/p&gt;
&lt;p&gt;&lt;img src=&quot;http://ww2.sinaimg.cn/large/7f870d23gw1f838r4uoz1j207e03u74f.jpg&quot; alt=&quot;&quot;&gt;&lt;/p&gt;
&lt;h2 id=&quot;2-__u7EAF_lua__u5B9E_u73B0&quot;&gt;&lt;a href=&quot;#2-__u7EAF_lua__u5B9E_u73B0&quot; class=&quot;headerlink&quot; title=&quot;2. 纯 lua 实现&quot;&gt;&lt;/a&gt;2. 纯 lua 实现&lt;/h2&gt;&lt;p&gt;如果一切按计划走的话, 是不会有这么一步的, 然而天意难测, 说好的冷更新变成了变成了热更新. 若是还想保留这个功能的话, 只能寻找纯 lua 的解决方案了. 虽然走了不少弯路, 浪费了大量的时间, 最终还是让我找到了: &lt;/p&gt;
&lt;p&gt;&lt;a href=&quot;https://github.com/Stepets/utf8.lua&quot; target=&quot;_blank&quot; rel=&quot;external&quot;&gt;https://github.com/Stepets/utf8.lua&lt;/a&gt;&lt;/p&gt;
&lt;p&gt;将项目中的 &lt;code&gt;utf8.lua&lt;/code&gt; 下载下来放到你工程中就可以啦, 就是这么简单.&lt;/p&gt;
&lt;h2 id=&quot;3-__u517C_u5BB9&quot;&gt;&lt;a href=&quot;#3-__u517C_u5BB9&quot; class=&quot;headerlink&quot; title=&quot;3. 兼容&quot;&gt;&lt;/a&gt;3. 兼容&lt;/h2&gt;&lt;p&gt;按说有了纯 lua 的实现后, 我们就可以放弃 c 代码的实现了, 但是想起做 python 的时候, 有好多库的实现为了提高效率, 都会有一份 c/c++ 的实现优先使用. 我们是不是也可以这样子搞, 优先使用 clib 的实现, 若是没有再考虑 lua 的实现 ? 首先, 我们要对比一下这两个库的效率对比.&lt;/p&gt;
&lt;p&gt;设计了一个简单的测试案例, 遍历一个 utf8 的字符串, 计算耗时, 得出了这样一份数据:&lt;/p&gt;
&lt;table&gt;
&lt;thead&gt;
&lt;tr&gt;
&lt;th&gt;字符数&lt;/th&gt;
&lt;th&gt;耗时clib&lt;/th&gt;
&lt;th&gt;耗时lua&lt;/th&gt;
&lt;th&gt;倍数&lt;/th&gt;
&lt;/tr&gt;
&lt;/thead&gt;
&lt;tbody&gt;
&lt;tr&gt;
&lt;td&gt;10&lt;/td&gt;
&lt;td&gt;2.0999999999938e-05&lt;/td&gt;
&lt;td&gt;6.8000000000068e-05&lt;/td&gt;
&lt;td&gt;3.2380952381081&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td&gt;138&lt;/td&gt;
&lt;td&gt;0.00018899999999999&lt;/td&gt;
&lt;td&gt;0.00095199999999995&lt;/td&gt;
&lt;td&gt;5.0370370370369&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td&gt;2919&lt;/td&gt;
&lt;td&gt;0.001868&lt;/td&gt;
&lt;td&gt;0.01553&lt;/td&gt;
&lt;td&gt;8.3137044967881&lt;/td&gt;
&lt;/tr&gt;
&lt;/tbody&gt;
&lt;/table&gt;
&lt;p&gt;可以看到至少也有 3 倍的速度提升, 而且随着字符数越来越多, 速度差距会更大. &lt;/p&gt;
&lt;p&gt;这个方案是可行的, 我们可用如下代码做兼容:&lt;/p&gt;
&lt;figure class=&quot;highlight lua&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;1&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;2&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;3&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;keyword&quot;&gt;if&lt;/span&gt; &lt;span class=&quot;built_in&quot;&gt;type&lt;/span&gt;(utf8) ~= &lt;span class=&quot;string&quot;&gt;&quot;table&quot;&lt;/span&gt; &lt;span class=&quot;keyword&quot;&gt;then&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    utf8 = &lt;span class=&quot;built_in&quot;&gt;require&lt;/span&gt;(&lt;span class=&quot;string&quot;&gt;&quot;your/path/of.utf8&quot;&lt;/span&gt;)&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;keyword&quot;&gt;end&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;
&lt;p&gt;但是两种实现遍历字符串的 api 略有不同, 需要包装兼容一下:&lt;/p&gt;
&lt;figure class=&quot;highlight lua&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;1&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;2&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;3&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;4&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;5&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;6&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;7&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;8&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;9&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;10&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;11&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;12&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;13&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;14&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;15&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;16&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;17&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;18&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;19&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;20&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;utf8.foreach = &lt;span class=&quot;function&quot;&gt;&lt;span class=&quot;keyword&quot;&gt;function&lt;/span&gt;&lt;span class=&quot;params&quot;&gt;(_str, _func)&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    &lt;span class=&quot;keyword&quot;&gt;local&lt;/span&gt; index = &lt;span class=&quot;number&quot;&gt;1&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    &lt;span class=&quot;keyword&quot;&gt;if&lt;/span&gt; utf8.&lt;span class=&quot;built_in&quot;&gt;next&lt;/span&gt; &lt;span class=&quot;keyword&quot;&gt;then&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;        &lt;span class=&quot;keyword&quot;&gt;for&lt;/span&gt; pos, code &lt;span class=&quot;keyword&quot;&gt;in&lt;/span&gt; utf8.&lt;span class=&quot;built_in&quot;&gt;next&lt;/span&gt;, _str &lt;span class=&quot;keyword&quot;&gt;do&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;            &lt;span class=&quot;keyword&quot;&gt;if&lt;/span&gt; _func(index, utf8.char(code), code, pos) &lt;span class=&quot;keyword&quot;&gt;then&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;                &lt;span class=&quot;keyword&quot;&gt;return&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;            &lt;span class=&quot;keyword&quot;&gt;end&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;            index = index + &lt;span class=&quot;number&quot;&gt;1&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;        &lt;span class=&quot;keyword&quot;&gt;end&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    &lt;span class=&quot;keyword&quot;&gt;elseif&lt;/span&gt; utf8.gensub &lt;span class=&quot;keyword&quot;&gt;then&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;        &lt;span class=&quot;keyword&quot;&gt;for&lt;/span&gt; char,pos &lt;span class=&quot;keyword&quot;&gt;in&lt;/span&gt; utf8.gensub(_str) &lt;span class=&quot;keyword&quot;&gt;do&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;            &lt;span class=&quot;keyword&quot;&gt;if&lt;/span&gt; _func(index, char, utf8.byte(char), pos) &lt;span class=&quot;keyword&quot;&gt;then&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;                &lt;span class=&quot;keyword&quot;&gt;return&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;            &lt;span class=&quot;keyword&quot;&gt;end&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;            index = index + &lt;span class=&quot;number&quot;&gt;1&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;        &lt;span class=&quot;keyword&quot;&gt;end&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    &lt;span class=&quot;keyword&quot;&gt;else&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;        &lt;span class=&quot;built_in&quot;&gt;assert&lt;/span&gt;(&lt;span class=&quot;keyword&quot;&gt;false&lt;/span&gt;, &lt;span class=&quot;string&quot;&gt;&quot;no utf8 supports!&quot;&lt;/span&gt;)&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    &lt;span class=&quot;keyword&quot;&gt;end&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;keyword&quot;&gt;end&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;
&lt;h1 id=&quot;u9644_u5F55_3A&quot;&gt;&lt;a href=&quot;#u9644_u5F55_3A&quot; class=&quot;headerlink&quot; title=&quot;附录:&quot;&gt;&lt;/a&gt;附录:&lt;/h1&gt;&lt;p&gt;附上我们判断玩家姓名和 emoji 的代码, 比较简单, 若有不对之处, 欢迎指正.&lt;/p&gt;
&lt;h2 id=&quot;u73A9_u5BB6_u59D3_u540D_u957F_u5EA6_u5224_u65AD&quot;&gt;&lt;a href=&quot;#u73A9_u5BB6_u59D3_u540D_u957F_u5EA6_u5224_u65AD&quot; class=&quot;headerlink&quot; title=&quot;玩家姓名长度判断&quot;&gt;&lt;/a&gt;玩家姓名长度判断&lt;/h2&gt;&lt;figure class=&quot;highlight lua&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;1&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;2&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;3&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;4&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;5&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;6&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;7&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;8&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;9&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;10&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;keyword&quot;&gt;local&lt;/span&gt; length = &lt;span class=&quot;number&quot;&gt;0&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;utf8.foreach(text, &lt;span class=&quot;function&quot;&gt;&lt;span class=&quot;keyword&quot;&gt;function&lt;/span&gt;&lt;span class=&quot;params&quot;&gt;(index, char, code, pos)&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    &lt;span class=&quot;comment&quot;&gt;-- 中日韩文字一个字符算两个长度&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    &lt;span class=&quot;keyword&quot;&gt;if&lt;/span&gt; code &amp;gt;= &lt;span class=&quot;number&quot;&gt;0x3040&lt;/span&gt; &lt;span class=&quot;keyword&quot;&gt;and&lt;/span&gt; code &amp;lt;= &lt;span class=&quot;number&quot;&gt;0x9fff&lt;/span&gt; &lt;span class=&quot;keyword&quot;&gt;then&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;        length = length + &lt;span class=&quot;number&quot;&gt;2&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    &lt;span class=&quot;keyword&quot;&gt;else&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;        length = length + &lt;span class=&quot;number&quot;&gt;1&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    &lt;span class=&quot;keyword&quot;&gt;end&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;keyword&quot;&gt;end&lt;/span&gt;)&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;
&lt;h2 id=&quot;emoji__u8868_u60C5_u5224_u65AD&quot;&gt;&lt;a href=&quot;#emoji__u8868_u60C5_u5224_u65AD&quot; class=&quot;headerlink&quot; title=&quot;emoji 表情判断&quot;&gt;&lt;/a&gt;emoji 表情判断&lt;/h2&gt;&lt;figure class=&quot;highlight lua&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;1&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;2&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;3&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;4&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;5&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;6&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;7&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;8&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;9&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;10&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;11&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;keyword&quot;&gt;local&lt;/span&gt; &lt;span class=&quot;function&quot;&gt;&lt;span class=&quot;keyword&quot;&gt;function&lt;/span&gt; &lt;span class=&quot;title&quot;&gt;checkContainsEomji&lt;/span&gt;&lt;span class=&quot;params&quot;&gt;(text)&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    &lt;span class=&quot;keyword&quot;&gt;local&lt;/span&gt; contain = &lt;span class=&quot;keyword&quot;&gt;false&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    utf8.foreach(text, &lt;span class=&quot;function&quot;&gt;&lt;span class=&quot;keyword&quot;&gt;function&lt;/span&gt;&lt;span class=&quot;params&quot;&gt;(index, char, code, pos)&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;        &lt;span class=&quot;comment&quot;&gt;-- [^\u0000-\u25ff\u27c0-\uD7FF\uE000-\uFFFF]&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;        &lt;span class=&quot;keyword&quot;&gt;if&lt;/span&gt; &lt;span class=&quot;keyword&quot;&gt;not&lt;/span&gt; ((code &amp;gt;= &lt;span class=&quot;number&quot;&gt;0x0000&lt;/span&gt; &lt;span class=&quot;keyword&quot;&gt;and&lt;/span&gt; code &amp;lt;= &lt;span class=&quot;number&quot;&gt;0x25ff&lt;/span&gt;) &lt;span class=&quot;keyword&quot;&gt;or&lt;/span&gt; (code &amp;gt;= &lt;span class=&quot;number&quot;&gt;0x27c0&lt;/span&gt; &lt;span class=&quot;keyword&quot;&gt;and&lt;/span&gt; code &amp;lt;= &lt;span class=&quot;number&quot;&gt;0xD7FF&lt;/span&gt;) &lt;span class=&quot;keyword&quot;&gt;or&lt;/span&gt; (code &amp;gt;= &lt;span class=&quot;number&quot;&gt;0xE000&lt;/span&gt; &lt;span class=&quot;keyword&quot;&gt;and&lt;/span&gt; code &amp;lt;= &lt;span class=&quot;number&quot;&gt;0xFFFF&lt;/span&gt;)) &lt;span class=&quot;keyword&quot;&gt;then&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;            contain = &lt;span class=&quot;keyword&quot;&gt;true&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;            &lt;span class=&quot;keyword&quot;&gt;return&lt;/span&gt; &lt;span class=&quot;keyword&quot;&gt;true&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;        &lt;span class=&quot;keyword&quot;&gt;end&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    &lt;span class=&quot;keyword&quot;&gt;end&lt;/span&gt;)&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    &lt;span class=&quot;keyword&quot;&gt;return&lt;/span&gt; contain&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;keyword&quot;&gt;end&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;
</content>
    
    <summary type="html">
    
      唉, 什么都得自己搞.
    
    </summary>
    
    
      <category term="Quick-Cocos2d-x" scheme="http://blog.justbilt.com/tags/Quick-Cocos2d-x/"/>
    
      <category term="utf8" scheme="http://blog.justbilt.com/tags/utf8/"/>
    
  </entry>
  
  <entry>
    <title>最近遇到的几个 quick-x 真机崩溃(二)</title>
    <link href="http://blog.justbilt.com/2016/09/10/quickx-crash-on-phone-2/"/>
    <id>http://blog.justbilt.com/2016/09/10/quickx-crash-on-phone-2/</id>
    <published>2016-09-10T15:28:45.000Z</published>
    <updated>2017-03-12T02:22:53.000Z</updated>
    
    <content type="html">&lt;p&gt;大概是 8 月中旬的时候, 我们项目发生了一个很严重的线上事故. 在版本更新之后, 部分 Android 玩家反馈点击按钮开始游戏或活动按钮会闪退.&lt;/p&gt;
&lt;p&gt;开始收到这个反馈时, 并没有太在意, 心想是不是机型适配有问题 ? 加上当时有别的工作在忙, 就没有去理会. 大概一个小时后, 玩家的邮件像雪花一样纷纷而至, 我才开始意识到, 更新出问题了.&lt;/p&gt;
&lt;p&gt;汇总了一下玩家的反馈:&lt;/p&gt;
&lt;ol&gt;
&lt;li&gt;新注册账号没有问题, 老账号会崩溃&lt;/li&gt;
&lt;li&gt;新服务器没有问题, 老服务器崩溃&lt;/li&gt;
&lt;li&gt;删除游戏重装后就没有问题了&lt;/li&gt;
&lt;/ol&gt;
&lt;p&gt;看着这些条件, 有经验的老司机可能已经看出倪端了, 但当时我并没有看出. 我们平时测试的时候, 多数都会新注册一个账号, 或者将原先的老包删除掉, 所以 Q&amp;amp;A 并没有测试出这个问题, 也没有办法复现这个我问题.&lt;/p&gt;
&lt;p&gt;我们游戏是集成了两个错误统计sdk的, 一个是 Bugtags, 一个是 umeng 错误收集, 但是这两个都是没有办法收集到 native 层面的 crash 的. &lt;/p&gt;
&lt;p&gt;&lt;img src=&quot;http://ww4.sinaimg.cn/large/7f870d23jw1f7xim4h1aaj21b50ej0ul.jpg&quot; alt=&quot;&quot;&gt;&lt;/p&gt;
&lt;p&gt;正当我一筹莫展的时候, 运营人员发来了 umeng 的这个错误列表, 我恍然大悟:&lt;/p&gt;
&lt;blockquote&gt;
&lt;p&gt;本地存档出问题了&lt;/p&gt;
&lt;/blockquote&gt;
&lt;p&gt;因为我们的玩家存档是以 &lt;code&gt;服务器id+玩家id&lt;/code&gt; 形式存入的, 所以上面列举的问题一下子就解释的通了.&lt;/p&gt;
&lt;h1 id=&quot;u4E00-__u7528_getStringForKey__u53BB_u83B7_u53D6_u4E00_u4E2A_bool__u578B_u7684_u5B58_u6863&quot;&gt;&lt;a href=&quot;#u4E00-__u7528_getStringForKey__u53BB_u83B7_u53D6_u4E00_u4E2A_bool__u578B_u7684_u5B58_u6863&quot; class=&quot;headerlink&quot; title=&quot;一. 用 getStringForKey 去获取一个 bool 型的存档&quot;&gt;&lt;/a&gt;一. 用 getStringForKey 去获取一个 bool 型的存档&lt;/h1&gt;&lt;p&gt;后台看到的错误日志是这个样子的:&lt;/p&gt;
&lt;blockquote&gt;
&lt;p&gt;java.lang.ClassCastException: java.lang.String cannot be cast to java.lang.Boolean&lt;/p&gt;
&lt;/blockquote&gt;
&lt;p&gt;&lt;img src=&quot;/face/yilianmengbi.jpg&quot; alt=&quot;&quot;&gt;&lt;/p&gt;
&lt;p&gt;这也可以? 这个错误闻所未闻, 只能说 Android 那边类型检测太严格了, 同时 cococ 读取存档时没有做异常处理.&lt;/p&gt;
&lt;p&gt;有了方向就好办了, 我搜索了代码中所有用到 &lt;code&gt;getStringForKey&lt;/code&gt; 的地方, 加上崩溃出现的时机, 很快定位了这个错误发生的原因.&lt;/p&gt;
&lt;p&gt;团队的中的一位成员, 这次更新时更换过存档的类型, 之前的某一个数据是以 &lt;code&gt;setBoolForKey/getBoolForKey&lt;/code&gt;, 现在更换成了 &lt;code&gt;setStringForKey/getStringForKey&lt;/code&gt;, 这个问题不能怪他, 若是我也会遇到这个问题.&lt;/p&gt;
&lt;p&gt;修改也很简单, 我换了一个新 key 去 存取/读取 这个存档.&lt;/p&gt;
&lt;h1 id=&quot;u4E8C-_setSpriteFrame_28_u201Ca-png_u201D_29__u4F20_u5165_u4E0D_u5B58_u5728_u7684_Sprite_Frmae_Name__u5C31_u4F1A_u5D29_u6E83&quot;&gt;&lt;a href=&quot;#u4E8C-_setSpriteFrame_28_u201Ca-png_u201D_29__u4F20_u5165_u4E0D_u5B58_u5728_u7684_Sprite_Frmae_Name__u5C31_u4F1A_u5D29_u6E83&quot; class=&quot;headerlink&quot; title=&quot;二. setSpriteFrame(“a.png”) 传入不存在的 Sprite Frmae Name 就会崩溃&quot;&gt;&lt;/a&gt;二. setSpriteFrame(“a.png”) 传入不存在的 Sprite Frmae Name 就会崩溃&lt;/h1&gt;&lt;p&gt;这个问题以前我没有遇到过, 我甚至都不知道 setSpriteFrame 可以传入 Sprite Frmae Name, 我每次都是 从 SpriteFrameCache 中获取一个 &lt;code&gt;SpriteFrame&lt;/code&gt; 对象传入的.&lt;/p&gt;
&lt;p&gt;导致这个问题发生原因是我们变化了图片打包策略, 之前用的是纹理图集, 现在改为碎片纹理了. 原理这些图片都在一个纹理图集上, 在游戏开始时已经 loading 过了, 所以不会有问题. 但是改为碎图就会找不到了.&lt;/p&gt;
&lt;figure class=&quot;highlight lua&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;1&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;2&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;3&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;4&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;5&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;6&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;7&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;8&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;9&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;10&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;11&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;12&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;13&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;14&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;15&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;16&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;function&quot;&gt;&lt;span class=&quot;keyword&quot;&gt;function&lt;/span&gt; &lt;span class=&quot;title&quot;&gt;newSpriteFrame&lt;/span&gt;&lt;span class=&quot;params&quot;&gt;(_name)&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    &lt;span class=&quot;built_in&quot;&gt;assert&lt;/span&gt;(_name &lt;span class=&quot;keyword&quot;&gt;and&lt;/span&gt; _name ~= &lt;span class=&quot;string&quot;&gt;&quot;&quot;&lt;/span&gt;)&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    &lt;span class=&quot;comment&quot;&gt;-- 尝试在大图中找&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    &lt;span class=&quot;keyword&quot;&gt;local&lt;/span&gt; frame = cc.SpriteFrameCache:getInstance():getSpriteFrame(_name)&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    &lt;span class=&quot;keyword&quot;&gt;if&lt;/span&gt; &lt;span class=&quot;keyword&quot;&gt;not&lt;/span&gt; frame &lt;span class=&quot;keyword&quot;&gt;then&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;        &lt;span class=&quot;keyword&quot;&gt;local&lt;/span&gt; texture = cc.Director:getInstance():getTextureCache():addImage(_name)&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;        &lt;span class=&quot;keyword&quot;&gt;if&lt;/span&gt; texture &lt;span class=&quot;keyword&quot;&gt;then&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;            frame = cc.SpriteFrame:createWithTexture(texture, cc.rect(&lt;span class=&quot;number&quot;&gt;0&lt;/span&gt;, &lt;span class=&quot;number&quot;&gt;0&lt;/span&gt;, texture:getContentSize().width, texture:getContentSize().height))&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;            cc.SpriteFrameCache:getInstance():addSpriteFrame(frame, _name)&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;        &lt;span class=&quot;keyword&quot;&gt;else&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;            &lt;span class=&quot;built_in&quot;&gt;print&lt;/span&gt;(&lt;span class=&quot;string&quot;&gt;&quot;[ERROR]no such file:&quot;&lt;/span&gt;, _name)&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;        &lt;span class=&quot;keyword&quot;&gt;end&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    &lt;span class=&quot;keyword&quot;&gt;end&lt;/span&gt; &lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    &lt;span class=&quot;keyword&quot;&gt;return&lt;/span&gt; frame&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;keyword&quot;&gt;end&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;
&lt;p&gt;我们封装了这个函数来兼容这个 &lt;code&gt;纹理图集/碎片纹理&lt;/code&gt;, 这样这个问题就解决了.&lt;/p&gt;
&lt;h1 id=&quot;u53CD_u601D&quot;&gt;&lt;a href=&quot;#u53CD_u601D&quot; class=&quot;headerlink&quot; title=&quot;反思&quot;&gt;&lt;/a&gt;反思&lt;/h1&gt;&lt;p&gt;每经历一次事故, 总要有所收获, 除了下次同样的问题不再发生, 流程上是否还有什么值得优化的地方 ?&lt;/p&gt;
&lt;h2 id=&quot;1-__u91CD_u89C6_u7EBF_u4E0A_u9519_u8BEF&quot;&gt;&lt;a href=&quot;#1-__u91CD_u89C6_u7EBF_u4E0A_u9519_u8BEF&quot; class=&quot;headerlink&quot; title=&quot;1. 重视线上错误&quot;&gt;&lt;/a&gt;1. 重视线上错误&lt;/h2&gt;&lt;p&gt;由于我一开对这个错误的轻视, 导致问题没有在第一时间控制住, 损失的不只是收入, 更是玩家对我们信心, 如果一个游戏经常出事故, 你还会去玩吗?&lt;/p&gt;
&lt;p&gt;错误率对我们而言只是一个数字, 是一个概率, 但是具体到某一个发生故障的玩家, 对他而言就是 100% , 就是焦急, 愤怒.&lt;/p&gt;
&lt;h2 id=&quot;2-__u771F_u5B9E_u7684_u7EBF_u4E0A_u73AF_u5883_u6D4B_u8BD5&quot;&gt;&lt;a href=&quot;#2-__u771F_u5B9E_u7684_u7EBF_u4E0A_u73AF_u5883_u6D4B_u8BD5&quot; class=&quot;headerlink&quot; title=&quot;2. 真实的线上环境测试&quot;&gt;&lt;/a&gt;2. 真实的线上环境测试&lt;/h2&gt;&lt;p&gt;这个问题发生, 有很大一部分原因是我们的测试没有在一个真实的环境中去测试, 应该保证一个手机只安装线上包, 模拟真实玩家, 每天去玩一段时间.&lt;/p&gt;
&lt;h2 id=&quot;3-__u9519_u8BEF_u6536_u96C6_u7CFB_u7EDF_u7684_u9009_u62E9&quot;&gt;&lt;a href=&quot;#3-__u9519_u8BEF_u6536_u96C6_u7CFB_u7EDF_u7684_u9009_u62E9&quot; class=&quot;headerlink&quot; title=&quot;3. 错误收集系统的选择&quot;&gt;&lt;/a&gt;3. 错误收集系统的选择&lt;/h2&gt;&lt;p&gt;我们采用的 bugtags 不具有完全完整的错误收集能力, 对错误的检索也很弱, 甚至不如免费 bugly . 为此我要付一定责任, 当初选择的时候, 没有完整的调研对比过, 只是看到这个还不错就选择了.&lt;/p&gt;
&lt;p&gt;做出判断前一定要慎重思考.&lt;/p&gt;
</content>
    
    <summary type="html">
    
      卧槽, 又崩溃了!
    
    </summary>
    
    
      <category term="Quick-Cocos2d-x" scheme="http://blog.justbilt.com/tags/Quick-Cocos2d-x/"/>
    
      <category term="crash" scheme="http://blog.justbilt.com/tags/crash/"/>
    
  </entry>
  
  <entry>
    <title>最近搞 iOS 版遇到的一些问题和技巧 (三)</title>
    <link href="http://blog.justbilt.com/2016/09/05/ios-dev-tips-3/"/>
    <id>http://blog.justbilt.com/2016/09/05/ios-dev-tips-3/</id>
    <published>2016-09-05T15:50:12.000Z</published>
    <updated>2017-03-12T04:19:57.000Z</updated>
    
    <content type="html">&lt;h1 id=&quot;u4E00-_iOS__u5185_u8D2D_u8FD4_u56DE_u5546_u54C1_u65E0_u6548_invalid_product&quot;&gt;&lt;a href=&quot;#u4E00-_iOS__u5185_u8D2D_u8FD4_u56DE_u5546_u54C1_u65E0_u6548_invalid_product&quot; class=&quot;headerlink&quot; title=&quot;一. iOS 内购返回商品无效 invalid product&quot;&gt;&lt;/a&gt;一. iOS 内购返回商品无效 invalid product&lt;/h1&gt;&lt;p&gt;我使用 quick-x 内置的 store 类请求商品信息时, 收到这样的错误:&lt;/p&gt;
&lt;blockquote&gt;
&lt;p&gt;nvalidProductIdentifiers [CCStore_obj]&lt;br&gt;[CCStore_obj] productsRequestDidReceiveResponse() invalid pid: com.xxx.xxx&lt;/p&gt;
&lt;/blockquote&gt;
&lt;p&gt;首先, &lt;strong&gt;检查你请求的商品 id 在 iTunes 后台是否创建&lt;/strong&gt;, 是否拼写错误. 如果没有问题, 那么就不太好办了, 会有很多原因导致这个问题.&lt;/p&gt;
&lt;p&gt;ZZB_Amoy 博客的&lt;a href=&quot;http://blog.sina.com.cn/s/blog_a6a46b330101dgju.html&quot; target=&quot;_blank&quot; rel=&quot;external&quot;&gt;这篇文章&lt;/a&gt;总结了下可能的原因, 如下:&lt;/p&gt;
&lt;blockquote&gt;
&lt;ul&gt;
&lt;li&gt;创建的App ID是否启用了IAP功能。&lt;/li&gt;
&lt;li&gt;商品信息是否配置到iTurn Connect，并到达“Ready to Submit”状态。&lt;/li&gt;
&lt;li&gt;在iTurn Connect中创建Test User，并收取邮件激活。之后登录到测试用手机的设置页面中（Store选项）。&lt;/li&gt;
&lt;li&gt;App的Bundle Id是否和后台配置的App Id一致。&lt;/li&gt;
&lt;li&gt;是否创建相应的provisioning profile，并用此签名App。&lt;/li&gt;
&lt;li&gt;iTurn Connect后台配置完商品信息后，是否等待若干小时生效。&lt;/li&gt;
&lt;li&gt;SKProductsRequest请求的商品Id必须和iTurn Connect中配置的一致。（如：com.test.product.xxx）&lt;/li&gt;
&lt;li&gt;iTunes Connect中配置的银行信息是否正确。&lt;/li&gt;
&lt;li&gt;是否先删除旧App，再重新编译生成新的。&lt;/li&gt;
&lt;li&gt;请不要使用越狱手机测试。&lt;/li&gt;
&lt;/ul&gt;
&lt;/blockquote&gt;
&lt;p&gt;下面说说我两次遇到这个问题的解决方案:&lt;/p&gt;
&lt;ol&gt;
&lt;li&gt;如果游戏发布区域中没有手机中 App Store 当前区的话, 需要先登陆下对应区域创建的测试账号, 将商店切换到对应区域.&lt;/li&gt;
&lt;li&gt;完善苹果开发者账号所能完善的信息, 如付款信息呀什么的, 然后莫名其妙就解决了.&lt;/li&gt;
&lt;li&gt;商品 id 大小写错误, 在 chrome 搜索时是忽略大小的.&lt;/li&gt;
&lt;/ol&gt;
&lt;blockquote&gt;
&lt;p&gt;注：在测试阶段，可以不用上传APP软件包，但必须创建测试用Apple Id，并在手机设置中（store选项）登录。&lt;/p&gt;
&lt;/blockquote&gt;
&lt;h1 id=&quot;u4E8C-_iOS__u8FD0_u884C_u5D29_u6E83_unrecognized_selector_sent_to_instance&quot;&gt;&lt;a href=&quot;#u4E8C-_iOS__u8FD0_u884C_u5D29_u6E83_unrecognized_selector_sent_to_instance&quot; class=&quot;headerlink&quot; title=&quot;二. iOS 运行崩溃 unrecognized selector sent to instance&quot;&gt;&lt;/a&gt;二. iOS 运行崩溃 unrecognized selector sent to instance&lt;/h1&gt;&lt;p&gt;运行游戏过程中收到如下错误:&lt;/p&gt;
&lt;blockquote&gt;
&lt;p&gt;[1515:710439] -[AppController window]: unrecognized selector sent to instance 0x2c85c00&lt;br&gt;libc++abi.dylib: terminate_handler unexpectedly threw an exception&lt;/p&gt;
&lt;/blockquote&gt;
&lt;p&gt;这个在接入某一个平台 sdk 时遇到的问题, 于是便问了下他们的技术, 很快解决了问题. &lt;/p&gt;
&lt;h4 id=&quot;1-__u4FEE_u6539_AppController-h__u4E2D_window__u53D8_u91CF_u7684_u58F0_u660E_u5F62_u5F0F&quot;&gt;&lt;a href=&quot;#1-__u4FEE_u6539_AppController-h__u4E2D_window__u53D8_u91CF_u7684_u58F0_u660E_u5F62_u5F0F&quot; class=&quot;headerlink&quot; title=&quot;1. 修改 AppController.h 中 window 变量的声明形式&quot;&gt;&lt;/a&gt;1. 修改 AppController.h 中 window 变量的声明形式&lt;/h4&gt;&lt;p&gt;&lt;img src=&quot;http://ww2.sinaimg.cn/large/7f870d23gw1f7j62j0mfuj20dw02n3yy.jpg&quot; alt=&quot;&quot;&gt;&lt;/p&gt;
&lt;h4 id=&quot;2-__u4FEE_u6539_AppController-mm&quot;&gt;&lt;a href=&quot;#2-__u4FEE_u6539_AppController-mm&quot; class=&quot;headerlink&quot; title=&quot;2. 修改 AppController.mm&quot;&gt;&lt;/a&gt;2. 修改 AppController.mm&lt;/h4&gt;&lt;p&gt;&lt;img src=&quot;http://ww2.sinaimg.cn/large/7f870d23gw1f7j665yyacj207901zq32.jpg&quot; alt=&quot;&quot;&gt;&lt;/p&gt;
&lt;p&gt;虽然问题解决了, 但是我并不明白各种缘由. Google 了下, 大概明白了, 原来如此. 从错误中我们可以看到这句 &lt;code&gt;[AppController window]&lt;/code&gt; , 从语法来看, 这是要调用 AppController 的 window 函数, 但是在我们之前的写法中没有实现这个函数, 便出错了. 而使用 &lt;code&gt;@property&lt;/code&gt; 这个东西, 会自动帮你实现一个 &lt;code&gt;window/setWindow&lt;/code&gt; 函数, 这样就不会找不到这个函数了.&lt;/p&gt;
&lt;h1 id=&quot;u4E09-__u6E38_u620F_u5728_u4F4E_u4E8E_ios9__u7684_u7CFB_u7EDF_u542F_u52A8_u5D29_u6E83&quot;&gt;&lt;a href=&quot;#u4E09-__u6E38_u620F_u5728_u4F4E_u4E8E_ios9__u7684_u7CFB_u7EDF_u542F_u52A8_u5D29_u6E83&quot; class=&quot;headerlink&quot; title=&quot;三. 游戏在低于 ios9 的系统启动崩溃&quot;&gt;&lt;/a&gt;三. 游戏在低于 ios9 的系统启动崩溃&lt;/h1&gt;&lt;p&gt;这个也是在接入第三方 sdk 时遇到的问题, 游戏一启动就会崩溃, 收到错误如下:&lt;/p&gt;
&lt;blockquote&gt;
&lt;p&gt;dyld: Symbol not found: _OBJC&lt;em&gt;CLASS&lt;/em&gt;$_SFSafariViewController&lt;br&gt;  Referenced from: /var/mobile/Applications/CF4146B4-3F79-4644-86CA-F19E52E64BAA/superarmoreddivision.app/superarmoreddivision&lt;br&gt;  Expected in: /System/Library/Frameworks/SafariServices.framework/SafariServices&lt;br&gt; in /var/mobile/Applications/CF4146B4-3F79-4644-86CA-F19E52E64BAA/superarmoreddivision.app/superarmoreddivision&lt;/p&gt;
&lt;/blockquote&gt;
&lt;p&gt;Google 了一下, 没有任何人遇到过这样的问题, 这就十分棘手了, 完全不知从何入手. 经过一番探索, 找到了几个有用的线索:&lt;/p&gt;
&lt;ol&gt;
&lt;li&gt;SFSafariViewController 这个类是 ios 9 才引入的, 这和我们已知的信息相符.&lt;/li&gt;
&lt;li&gt;所幸的是我们的游戏有多个 Scheme , 每个 Scheme 接入不同的 sdk . 其他的 Scheme 的都可以正常运行.&lt;/li&gt;
&lt;/ol&gt;
&lt;p&gt;这就可以肯定是某个 sdk 中使用了 &lt;code&gt;SFSafariViewController&lt;/code&gt; 这个类, 但是还是没有办法定位是那个 sdk . 我不知道是否有一个命令查找符号引用, 因此只能采用最笨的排除法了, 我将引入的 sdk 依次删除, 看是否能够运行.&lt;/p&gt;
&lt;p&gt;最终定位到了某个广告统计 sdk , 在询问其 ios 技术人员后得到了解决方案. 原来他们 sdk 需要&lt;strong&gt;以 &lt;code&gt;optional&lt;/code&gt; 的形式引入 &lt;code&gt;SafariServices.framework&lt;/code&gt;&lt;/strong&gt;.&lt;/p&gt;
&lt;p&gt;&lt;img src=&quot;http://ww1.sinaimg.cn/large/7f870d23gw1f7kanujs5rj20ol018jrf.jpg&quot; alt=&quot;&quot;&gt;&lt;/p&gt;
&lt;p&gt;都怪我没有仔细阅读文档, 白白耽误了一段时间, 下次一定要注意!&lt;/p&gt;
&lt;h1 id=&quot;u56DB-_Facebook__u767B_u5F55_u5D29_u6E83&quot;&gt;&lt;a href=&quot;#u56DB-_Facebook__u767B_u5F55_u5D29_u6E83&quot; class=&quot;headerlink&quot; title=&quot;四. Facebook 登录崩溃&quot;&gt;&lt;/a&gt;四. Facebook 登录崩溃&lt;/h1&gt;&lt;p&gt;集成 Facebook sdk 时, 调用登录接口游戏就会崩溃, 这个问题 Google 一下就能解决, 解决方案也很简单, 在 Info.plist 中加入下面几行代码即可:&lt;/p&gt;
&lt;figure class=&quot;highlight xml&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;1&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;2&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;3&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;4&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;5&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;6&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;7&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;tag&quot;&gt;&amp;lt;&lt;span class=&quot;title&quot;&gt;key&lt;/span&gt;&amp;gt;&lt;/span&gt;LSApplicationQueriesSchemes&lt;span class=&quot;tag&quot;&gt;&amp;lt;/&lt;span class=&quot;title&quot;&gt;key&lt;/span&gt;&amp;gt;&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;tag&quot;&gt;&amp;lt;&lt;span class=&quot;title&quot;&gt;array&lt;/span&gt;&amp;gt;&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;        &lt;span class=&quot;tag&quot;&gt;&amp;lt;&lt;span class=&quot;title&quot;&gt;string&lt;/span&gt;&amp;gt;&lt;/span&gt;fbapi&lt;span class=&quot;tag&quot;&gt;&amp;lt;/&lt;span class=&quot;title&quot;&gt;string&lt;/span&gt;&amp;gt;&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;        &lt;span class=&quot;tag&quot;&gt;&amp;lt;&lt;span class=&quot;title&quot;&gt;string&lt;/span&gt;&amp;gt;&lt;/span&gt;fb-messenger-api&lt;span class=&quot;tag&quot;&gt;&amp;lt;/&lt;span class=&quot;title&quot;&gt;string&lt;/span&gt;&amp;gt;&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;        &lt;span class=&quot;tag&quot;&gt;&amp;lt;&lt;span class=&quot;title&quot;&gt;string&lt;/span&gt;&amp;gt;&lt;/span&gt;fbauth2&lt;span class=&quot;tag&quot;&gt;&amp;lt;/&lt;span class=&quot;title&quot;&gt;string&lt;/span&gt;&amp;gt;&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;        &lt;span class=&quot;tag&quot;&gt;&amp;lt;&lt;span class=&quot;title&quot;&gt;string&lt;/span&gt;&amp;gt;&lt;/span&gt;fbshareextension&lt;span class=&quot;tag&quot;&gt;&amp;lt;/&lt;span class=&quot;title&quot;&gt;string&lt;/span&gt;&amp;gt;&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;tag&quot;&gt;&amp;lt;/&lt;span class=&quot;title&quot;&gt;array&lt;/span&gt;&amp;gt;&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;
&lt;p&gt;Stackoverflow 上的答案可以&lt;a href=&quot;http://stackoverflow.com/a/33489214&quot; target=&quot;_blank&quot; rel=&quot;external&quot;&gt;移步这里&lt;/a&gt;, Facebook 官网上也&lt;a href=&quot;https://developers.facebook.com/docs/ios/ios9&quot; target=&quot;_blank&quot; rel=&quot;external&quot;&gt;给了解答&lt;/a&gt;.&lt;/p&gt;
&lt;h1 id=&quot;u4E94-_ios9__u72B6_u6001_u680F_u65E0_u6CD5_u9690_u85CF&quot;&gt;&lt;a href=&quot;#u4E94-_ios9__u72B6_u6001_u680F_u65E0_u6CD5_u9690_u85CF&quot; class=&quot;headerlink&quot; title=&quot;五. ios9 状态栏无法隐藏&quot;&gt;&lt;/a&gt;五. ios9 状态栏无法隐藏&lt;/h1&gt;&lt;p&gt;隐藏状态栏在 ios9 上换了一种方式, 还是需要在 Info.plist 中进行配置:&lt;/p&gt;
&lt;figure class=&quot;highlight xml&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;1&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;2&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;3&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;4&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;tag&quot;&gt;&amp;lt;&lt;span class=&quot;title&quot;&gt;key&lt;/span&gt;&amp;gt;&lt;/span&gt;UIStatusBarHidden&lt;span class=&quot;tag&quot;&gt;&amp;lt;/&lt;span class=&quot;title&quot;&gt;key&lt;/span&gt;&amp;gt;&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;tag&quot;&gt;&amp;lt;&lt;span class=&quot;title&quot;&gt;true&lt;/span&gt;/&amp;gt;&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;tag&quot;&gt;&amp;lt;&lt;span class=&quot;title&quot;&gt;key&lt;/span&gt;&amp;gt;&lt;/span&gt;UIViewControllerBasedStatusBarAppearance&lt;span class=&quot;tag&quot;&gt;&amp;lt;/&lt;span class=&quot;title&quot;&gt;key&lt;/span&gt;&amp;gt;&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;tag&quot;&gt;&amp;lt;&lt;span class=&quot;title&quot;&gt;false&lt;/span&gt;/&amp;gt;&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;
&lt;p&gt;Stackoverflow 上的答案可以&lt;a href=&quot;http://stackoverflow.com/a/32965748&quot; target=&quot;_blank&quot; rel=&quot;external&quot;&gt;移步这里&lt;/a&gt;.&lt;/p&gt;
&lt;h1 id=&quot;u516D-_showAlert__u8BE1_u5F02_u5D29_u6E83&quot;&gt;&lt;a href=&quot;#u516D-_showAlert__u8BE1_u5F02_u5D29_u6E83&quot; class=&quot;headerlink&quot; title=&quot;六. showAlert 诡异崩溃&quot;&gt;&lt;/a&gt;六. showAlert 诡异崩溃&lt;/h1&gt;&lt;p&gt;游戏内的一些弹框为了保证在游戏的最上层显示, 偷懒使用了 quick-x 提供的 &lt;code&gt;device.showAlert&lt;/code&gt; 接口. showAlert 内部使用 &lt;code&gt;UIAlertView&lt;/code&gt; 实现, 运行一直良好, 有一天突然就不行了, 一调用就崩溃. &lt;/p&gt;
&lt;p&gt;各种办法都试过了, 网上都说是线程安全问题, 我试了一下各种处理都不行, 打断点跟踪到最底层也无济于事. 几近绝望之时, @bin 的一句话提醒了我:&lt;/p&gt;
&lt;blockquote&gt;
&lt;p&gt;会不是屏幕方向的问题 ? &lt;/p&gt;
&lt;/blockquote&gt;
&lt;p&gt;最终一番尝试, 删除了 &lt;code&gt;RootViewController.mm&lt;/code&gt; 中几个屏幕方向相关的函数:&lt;/p&gt;
&lt;figure class=&quot;highlight objc&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;1&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;2&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;3&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;4&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;5&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;6&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;7&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;8&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;9&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;10&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;11&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;12&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;13&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;14&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;15&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;16&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;17&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;18&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;19&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;20&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;21&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;22&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;23&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;24&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;25&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;26&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;27&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;28&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;29&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;30&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;31&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;*/&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;comment&quot;&gt;// Override to allow orientations other than the default portrait orientation.&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;comment&quot;&gt;// This method is deprecated on ios6&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;- (&lt;span class=&quot;built_in&quot;&gt;BOOL&lt;/span&gt;)shouldAutorotateToInterfaceOrientation:(&lt;span class=&quot;built_in&quot;&gt;UIInterfaceOrientation&lt;/span&gt;)interfaceOrientation &amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    &lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    &lt;span class=&quot;keyword&quot;&gt;if&lt;/span&gt; (ConfigParser::getInstance()-&amp;gt;isLanscape()) &amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;        &lt;span class=&quot;keyword&quot;&gt;return&lt;/span&gt; &lt;span class=&quot;built_in&quot;&gt;UIInterfaceOrientationIsLandscape&lt;/span&gt;( interfaceOrientation );&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    &amp;#125;&lt;span class=&quot;keyword&quot;&gt;else&lt;/span&gt;&amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;        &lt;span class=&quot;keyword&quot;&gt;return&lt;/span&gt; &lt;span class=&quot;built_in&quot;&gt;UIInterfaceOrientationIsPortrait&lt;/span&gt;( interfaceOrientation );&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    &amp;#125;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    &lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&amp;#125;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;comment&quot;&gt;// For ios6, use supportedInterfaceOrientations &amp;amp; shouldAutorotate instead&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;- (&lt;span class=&quot;built_in&quot;&gt;NSUInteger&lt;/span&gt;) supportedInterfaceOrientations&amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;preprocessor&quot;&gt;#ifdef __IPHONE_6_0&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    &lt;span class=&quot;keyword&quot;&gt;if&lt;/span&gt; (ConfigParser::getInstance()-&amp;gt;isLanscape()) &amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;        &lt;span class=&quot;keyword&quot;&gt;return&lt;/span&gt; &lt;span class=&quot;built_in&quot;&gt;UIInterfaceOrientationMaskLandscape&lt;/span&gt;;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    &amp;#125;&lt;span class=&quot;keyword&quot;&gt;else&lt;/span&gt;&amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;        &lt;span class=&quot;keyword&quot;&gt;return&lt;/span&gt; &lt;span class=&quot;built_in&quot;&gt;UIInterfaceOrientationMaskPortraitUpsideDown&lt;/span&gt;;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    &amp;#125;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;preprocessor&quot;&gt;#endif&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&amp;#125;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;- (&lt;span class=&quot;built_in&quot;&gt;BOOL&lt;/span&gt;) shouldAutorotate &amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    &lt;span class=&quot;keyword&quot;&gt;if&lt;/span&gt; (ConfigParser::getInstance()-&amp;gt;isLanscape()) &amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;        &lt;span class=&quot;keyword&quot;&gt;return&lt;/span&gt; &lt;span class=&quot;literal&quot;&gt;YES&lt;/span&gt;;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    &amp;#125;&lt;span class=&quot;keyword&quot;&gt;else&lt;/span&gt;&amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;        &lt;span class=&quot;keyword&quot;&gt;return&lt;/span&gt; &lt;span class=&quot;literal&quot;&gt;NO&lt;/span&gt;;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    &amp;#125;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&amp;#125;&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;
&lt;p&gt;这个 bug 出现之诡异, 解决方案之诡异, 在我遇到的 bug 中也算是很少见了.&lt;/p&gt;
</content>
    
    <summary type="html">
    
      万一遇上了呢?
    
    </summary>
    
    
      <category term="iOS" scheme="http://blog.justbilt.com/tags/iOS/"/>
    
      <category term="iOS-Dev-Tips" scheme="http://blog.justbilt.com/tags/iOS-Dev-Tips/"/>
    
  </entry>
  
  <entry>
    <title>更简洁的 lua 逻辑代码</title>
    <link href="http://blog.justbilt.com/2016/06/26/terse-lua-code/"/>
    <id>http://blog.justbilt.com/2016/06/26/terse-lua-code/</id>
    <published>2016-06-26T06:28:11.000Z</published>
    <updated>2017-03-12T01:22:38.000Z</updated>
    
    <content type="html">&lt;p&gt;爱因斯坦的质能方程 &lt;code&gt;E=MC^2&lt;/code&gt;, 用在编程界同样适用 &lt;code&gt;Error = More Code ^ 2&lt;/code&gt;. 代码越多, 出错的可能性就更大, 这个结论很正确呀. 那么我们如何使用更少的代码实现同样的需求呢 ?&lt;/p&gt;
&lt;p&gt;一. 普通技&lt;/p&gt;
&lt;h2 id=&quot;1-_bool__u503C_u4E0E_if__u8BED_u53E5_u7684_u62E9_u51B3&quot;&gt;&lt;a href=&quot;#1-_bool__u503C_u4E0E_if__u8BED_u53E5_u7684_u62E9_u51B3&quot; class=&quot;headerlink&quot; title=&quot;1. bool 值与 if 语句的择决&quot;&gt;&lt;/a&gt;1. bool 值与 if 语句的择决&lt;/h2&gt;&lt;p&gt;让我们来看一段代码:&lt;/p&gt;
&lt;figure class=&quot;highlight lua&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;1&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;2&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;3&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;4&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;5&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;6&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;keyword&quot;&gt;local&lt;/span&gt; monthly_is_taken = app.player:getAttribute(&lt;span class=&quot;string&quot;&gt;&quot;monthly_is_taken&quot;&lt;/span&gt;)&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;keyword&quot;&gt;if&lt;/span&gt; monthly_is_taken == &lt;span class=&quot;keyword&quot;&gt;true&lt;/span&gt; &lt;span class=&quot;keyword&quot;&gt;then&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    self._monthly_take:setButtonEnabled(&lt;span class=&quot;keyword&quot;&gt;false&lt;/span&gt;)&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;keyword&quot;&gt;else&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    self._monthly_take:setButtonEnabled(&lt;span class=&quot;keyword&quot;&gt;true&lt;/span&gt;)&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;keyword&quot;&gt;end&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;
&lt;p&gt;显然这个 if 语句是没有必要的, 我们可以直接使用 bool 进行函数参数传递:&lt;/p&gt;
&lt;figure class=&quot;highlight lua&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;1&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;2&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;keyword&quot;&gt;local&lt;/span&gt; monthly_is_taken = app.player:getAttribute(&lt;span class=&quot;string&quot;&gt;&quot;monthly_is_taken&quot;&lt;/span&gt;)&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;self._monthly_take:setButtonEnabled(monthly_is_taken)&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;
&lt;p&gt;我们可以看到减少了 %60 的代码, 逻辑反而变得更清晰了.&lt;/p&gt;
&lt;h2 id=&quot;2-__u51CF_u5C11_u975E_u5FC5_u987B_u7684_u4E2D_u95F4_u53D8_u91CF&quot;&gt;&lt;a href=&quot;#2-__u51CF_u5C11_u975E_u5FC5_u987B_u7684_u4E2D_u95F4_u53D8_u91CF&quot; class=&quot;headerlink&quot; title=&quot;2. 减少非必须的中间变量&quot;&gt;&lt;/a&gt;2. 减少非必须的中间变量&lt;/h2&gt;&lt;p&gt;我们都明白了中间变量的意义, 主要是为提高代码的可读性. 但是有时候中间变量的太多, 在增加码量的同时, 也会打断我们的我们的思路.&lt;/p&gt;
&lt;p&gt;比如我们要算一个等差数列的和, 我们都知道使用公式 &lt;code&gt;(首项+末项)*项数/2&lt;/code&gt;, 我们看一下这个实现:&lt;/p&gt;
&lt;figure class=&quot;highlight lua&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;1&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;2&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;3&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;4&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;5&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;keyword&quot;&gt;local&lt;/span&gt; array = &amp;#123;&lt;span class=&quot;number&quot;&gt;1&lt;/span&gt;,&lt;span class=&quot;number&quot;&gt;3&lt;/span&gt;,&lt;span class=&quot;number&quot;&gt;5&lt;/span&gt;,&lt;span class=&quot;number&quot;&gt;7&lt;/span&gt;,&lt;span class=&quot;number&quot;&gt;9&lt;/span&gt;&amp;#125;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;keyword&quot;&gt;local&lt;/span&gt; array_len = #array&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;keyword&quot;&gt;local&lt;/span&gt; first_element = array[&lt;span class=&quot;number&quot;&gt;1&lt;/span&gt;]&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;keyword&quot;&gt;local&lt;/span&gt; last_element = array[array_len]&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;keyword&quot;&gt;local&lt;/span&gt; sum = (first_element+last_element)*array_len/&lt;span class=&quot;number&quot;&gt;2&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;
&lt;p&gt;就不如下面这个实现:&lt;/p&gt;
&lt;figure class=&quot;highlight lua&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;1&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;2&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;keyword&quot;&gt;local&lt;/span&gt; array = &amp;#123;&lt;span class=&quot;number&quot;&gt;1&lt;/span&gt;,&lt;span class=&quot;number&quot;&gt;3&lt;/span&gt;,&lt;span class=&quot;number&quot;&gt;5&lt;/span&gt;,&lt;span class=&quot;number&quot;&gt;7&lt;/span&gt;,&lt;span class=&quot;number&quot;&gt;9&lt;/span&gt;&amp;#125;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;keyword&quot;&gt;local&lt;/span&gt; sum = (array[&lt;span class=&quot;number&quot;&gt;1&lt;/span&gt;]+array[#array])*#array/&lt;span class=&quot;number&quot;&gt;2&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;
&lt;p&gt;这样的话, 我们上一个示例的代码可以进一步精简:&lt;/p&gt;
&lt;figure class=&quot;highlight lua&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;1&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;self._monthly_take:setButtonEnabled(app.player:getAttribute(&lt;span class=&quot;string&quot;&gt;&quot;monthly_is_taken&quot;&lt;/span&gt;))&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;
&lt;h2 id=&quot;3-__u4F7F_u7528_elseif__u4F18_u5316_if__u8BED_u53E5&quot;&gt;&lt;a href=&quot;#3-__u4F7F_u7528_elseif__u4F18_u5316_if__u8BED_u53E5&quot; class=&quot;headerlink&quot; title=&quot;3. 使用 elseif 优化 if 语句&quot;&gt;&lt;/a&gt;3. 使用 elseif 优化 if 语句&lt;/h2&gt;&lt;p&gt;如果是逻辑相悖的判断条件, 我们可以使用 elseif 语句连接, 而不用多个 if 语句. &lt;/p&gt;
&lt;figure class=&quot;highlight lua&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;1&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;2&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;3&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;4&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;5&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;6&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;7&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;8&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;9&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;10&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;11&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;keyword&quot;&gt;if&lt;/span&gt; self.item_id == &lt;span class=&quot;string&quot;&gt;&quot;43&quot;&lt;/span&gt; &lt;span class=&quot;keyword&quot;&gt;then&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    &lt;span class=&quot;comment&quot;&gt;-- do some thing&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;keyword&quot;&gt;end&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;keyword&quot;&gt;if&lt;/span&gt; self.item_id == &lt;span class=&quot;string&quot;&gt;&quot;69&quot;&lt;/span&gt; &lt;span class=&quot;keyword&quot;&gt;then&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    &lt;span class=&quot;comment&quot;&gt;-- do some thing&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;keyword&quot;&gt;end&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;keyword&quot;&gt;if&lt;/span&gt; self.item_id == &lt;span class=&quot;string&quot;&gt;&quot;75&quot;&lt;/span&gt; &lt;span class=&quot;keyword&quot;&gt;then&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    &lt;span class=&quot;comment&quot;&gt;-- do some thing&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;keyword&quot;&gt;end&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;
&lt;p&gt;我们可以修改为:&lt;/p&gt;
&lt;figure class=&quot;highlight lua&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;1&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;2&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;3&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;4&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;5&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;6&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;7&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;keyword&quot;&gt;if&lt;/span&gt; self.item_id == &lt;span class=&quot;string&quot;&gt;&quot;43&quot;&lt;/span&gt; &lt;span class=&quot;keyword&quot;&gt;then&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    &lt;span class=&quot;comment&quot;&gt;-- do some thing&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;keyword&quot;&gt;elseif&lt;/span&gt; self.item_id == &lt;span class=&quot;string&quot;&gt;&quot;69&quot;&lt;/span&gt; &lt;span class=&quot;keyword&quot;&gt;then&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    &lt;span class=&quot;comment&quot;&gt;-- do some thing&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;keyword&quot;&gt;elseif&lt;/span&gt; self.item_id == &lt;span class=&quot;string&quot;&gt;&quot;75&quot;&lt;/span&gt; &lt;span class=&quot;keyword&quot;&gt;then&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    &lt;span class=&quot;comment&quot;&gt;-- do some thing&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;keyword&quot;&gt;end&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;
&lt;p&gt;这样修改后, 对逻辑的执行时间也优化哟, 因为一但有一个 if 语句命中, 后面的 elseif 都不会再去判断了.&lt;/p&gt;
&lt;h2 id=&quot;4-__u4F7F_u7528_config__u4F18_u5316_if-elseif__u8BED_u53E5&quot;&gt;&lt;a href=&quot;#4-__u4F7F_u7528_config__u4F18_u5316_if-elseif__u8BED_u53E5&quot; class=&quot;headerlink&quot; title=&quot;4. 使用 config 优化 if-elseif 语句&quot;&gt;&lt;/a&gt;4. 使用 config 优化 if-elseif 语句&lt;/h2&gt;&lt;p&gt;如果一个逻辑中有大量的 if-elseif 语句, 我么就可以使用 config 的形式替换掉它, 使得逻辑更加简洁.&lt;/p&gt;
&lt;p&gt;让我们看一个示例:&lt;/p&gt;
&lt;figure class=&quot;highlight lua&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;1&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;2&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;3&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;4&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;5&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;6&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;7&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;8&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;9&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;10&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;11&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;12&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;13&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;14&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;keyword&quot;&gt;if&lt;/span&gt; _data.&lt;span class=&quot;built_in&quot;&gt;type&lt;/span&gt; == GameEnum.MailType.MAIL_TYPE_SYSTEM &lt;span class=&quot;keyword&quot;&gt;then&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    self._title:setString(_data.content.content.subtype)&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    self._name:setString(TextEnum.CNReset.SYSTEM)&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    self.title = TextEnum.CNReset.SYSTEM_INFORMATION&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;keyword&quot;&gt;elseif&lt;/span&gt; _data.&lt;span class=&quot;built_in&quot;&gt;type&lt;/span&gt; == GameEnum.MailType.MAIL_TYPE_ALLIANCE_KICK &lt;span class=&quot;keyword&quot;&gt;then&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    self._title:setString(TextEnum.CNReset.KICK)&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    self._name:setString(TextEnum.CNReset.SYSTEM)&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    self.title = TextEnum.CNReset.KICK&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;keyword&quot;&gt;elseif&lt;/span&gt; _data.&lt;span class=&quot;built_in&quot;&gt;type&lt;/span&gt; == GameEnum.MailType.MAIL_TYPE_ALLIANCE_JOIN &lt;span class=&quot;keyword&quot;&gt;then&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    self._title:setString(TextEnum.CNReset.JOIN_IN)&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    self._name:setString(TextEnum.CNReset.SYSTEM)&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    self.title = TextEnum.CNReset.JOIN_IN&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;keyword&quot;&gt;elseif&lt;/span&gt; _data.&lt;span class=&quot;built_in&quot;&gt;type&lt;/span&gt; == GameEnum.MailType.MAIL_TYPE_ALLIANCE_REJECT &lt;span class=&quot;keyword&quot;&gt;then&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    ...&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;
&lt;p&gt;这是一段关于邮件标题的逻辑, 这里只节选出了 1/4 的代码, 真的是又臭又长. 我们可以这样子去优化它:&lt;/p&gt;
&lt;figure class=&quot;highlight lua&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;1&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;2&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;3&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;4&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;5&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;6&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;7&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;8&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;9&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;10&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;11&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;12&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;13&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;keyword&quot;&gt;local&lt;/span&gt; CONFIG = &amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    [GameEnum.MailType.MAIL_TYPE_SYSTEM] = &amp;#123;title = XXX, name = XXX&amp;#125;,&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    [GameEnum.MailType.MAIL_TYPE_ALLIANCE_KICK] = &amp;#123;title = XXX, name = XXX&amp;#125;,&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    [GameEnum.MailType.MAIL_TYPE_ALLIANCE_JOIN] = &amp;#123;title = XXX, name = XXX&amp;#125;,&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    [GameEnum.MailType.MAIL_TYPE_ALLIANCE_REJECT] = &amp;#123;title = XXX, name = XXX&amp;#125;,&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    ...&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&amp;#125;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;keyword&quot;&gt;local&lt;/span&gt; config = CONFIG[_data.&lt;span class=&quot;built_in&quot;&gt;type&lt;/span&gt;]&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;keyword&quot;&gt;if&lt;/span&gt; config &lt;span class=&quot;keyword&quot;&gt;then&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    self._title:setString(config.title)&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    self._name:setString(config.name)&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;keyword&quot;&gt;end&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;
&lt;p&gt;因为只是代码节选, 所以上面修改是一段伪代码, 但是看起来超级清爽的有木有! 对于一开始无法确定的数据如何配置呢? 我们可以配置一个 &lt;code&gt;function&lt;/code&gt;, 用的时候取出来调用就可以啦.&lt;/p&gt;
&lt;h1 id=&quot;u4E8C-__u9ED1_u79D1_u6280&quot;&gt;&lt;a href=&quot;#u4E8C-__u9ED1_u79D1_u6280&quot; class=&quot;headerlink&quot; title=&quot;二. 黑科技&quot;&gt;&lt;/a&gt;二. 黑科技&lt;/h1&gt;&lt;h2 id=&quot;1-__u6570_u636E_u9ED8_u8BA4_u503C_u7684_u8BBE_u5B9A&quot;&gt;&lt;a href=&quot;#1-__u6570_u636E_u9ED8_u8BA4_u503C_u7684_u8BBE_u5B9A&quot; class=&quot;headerlink&quot; title=&quot;1. 数据默认值的设定&quot;&gt;&lt;/a&gt;1. 数据默认值的设定&lt;/h2&gt;&lt;p&gt;当我们拿到一段数据后, 总是要先预处理数据, 后面才是使用数据. 预处理阶段很重要的一步就是某些数据的默认值.&lt;/p&gt;
&lt;figure class=&quot;highlight lua&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;1&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;2&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;3&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;4&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;5&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;6&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;7&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;8&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;9&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;10&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;11&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;12&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;function&quot;&gt;&lt;span class=&quot;keyword&quot;&gt;function&lt;/span&gt; &lt;span class=&quot;title&quot;&gt;sum3&lt;/span&gt;&lt;span class=&quot;params&quot;&gt;(_num1, _num2, _num3)&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    &lt;span class=&quot;keyword&quot;&gt;if&lt;/span&gt; &lt;span class=&quot;keyword&quot;&gt;not&lt;/span&gt; _num1 &lt;span class=&quot;keyword&quot;&gt;then&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;        _num1 = &lt;span class=&quot;number&quot;&gt;0&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    &lt;span class=&quot;keyword&quot;&gt;end&lt;/span&gt; &lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    &lt;span class=&quot;keyword&quot;&gt;if&lt;/span&gt; &lt;span class=&quot;keyword&quot;&gt;not&lt;/span&gt; _num2 &lt;span class=&quot;keyword&quot;&gt;then&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;        _num2 = &lt;span class=&quot;number&quot;&gt;0&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    &lt;span class=&quot;keyword&quot;&gt;end&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    &lt;span class=&quot;keyword&quot;&gt;if&lt;/span&gt; &lt;span class=&quot;keyword&quot;&gt;not&lt;/span&gt; _num3 &lt;span class=&quot;keyword&quot;&gt;then&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;        _num3 = &lt;span class=&quot;number&quot;&gt;0&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    &lt;span class=&quot;keyword&quot;&gt;end&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    &lt;span class=&quot;keyword&quot;&gt;return&lt;/span&gt; _num1 +　_num2 + _num3&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;keyword&quot;&gt;end&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;
&lt;p&gt;很繁琐是不是, 这时候我们可以使用 and 和 or 来优化默认值的设置:&lt;/p&gt;
&lt;figure class=&quot;highlight lua&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;1&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;2&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;3&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;4&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;5&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;6&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;function&quot;&gt;&lt;span class=&quot;keyword&quot;&gt;function&lt;/span&gt; &lt;span class=&quot;title&quot;&gt;sum3&lt;/span&gt;&lt;span class=&quot;params&quot;&gt;(_num1, _num2, _num3)&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    _num1 = _num1 &lt;span class=&quot;keyword&quot;&gt;or&lt;/span&gt; &lt;span class=&quot;number&quot;&gt;0&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    _num2 = _num2 &lt;span class=&quot;keyword&quot;&gt;or&lt;/span&gt; &lt;span class=&quot;number&quot;&gt;0&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    _num3 = _num3 &lt;span class=&quot;keyword&quot;&gt;or&lt;/span&gt; &lt;span class=&quot;number&quot;&gt;0&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    &lt;span class=&quot;keyword&quot;&gt;return&lt;/span&gt; _num1 +　_num2 + _num3&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;keyword&quot;&gt;end&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;
&lt;p&gt;当 &lt;code&gt;or&lt;/code&gt; 的前面部分是 &lt;code&gt;nil&lt;/code&gt; 或者 &lt;code&gt;false&lt;/code&gt; 的情况下, 返回这个表达式的值后面部分. 下面我列举一下常用类型的默认值用法:&lt;/p&gt;
&lt;figure class=&quot;highlight lua&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;1&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;2&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;3&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;4&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;5&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;6&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;7&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;8&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;9&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;10&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;comment&quot;&gt;-- number&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;a = a &lt;span class=&quot;keyword&quot;&gt;or&lt;/span&gt; &lt;span class=&quot;number&quot;&gt;0&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;comment&quot;&gt;-- string&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;a = a &lt;span class=&quot;keyword&quot;&gt;or&lt;/span&gt; &lt;span class=&quot;string&quot;&gt;&quot;&quot;&lt;/span&gt; &lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;comment&quot;&gt;-- function&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;a = a &lt;span class=&quot;keyword&quot;&gt;or&lt;/span&gt; &lt;span class=&quot;function&quot;&gt;&lt;span class=&quot;keyword&quot;&gt;function&lt;/span&gt;&lt;span class=&quot;params&quot;&gt;()&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;keyword&quot;&gt;end&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;comment&quot;&gt;-- table&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;a = a &lt;span class=&quot;keyword&quot;&gt;or&lt;/span&gt; &amp;#123;&amp;#125;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;comment&quot;&gt;-- boolean&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;a = a == &lt;span class=&quot;keyword&quot;&gt;nil&lt;/span&gt; &lt;span class=&quot;keyword&quot;&gt;and&lt;/span&gt; &lt;span class=&quot;keyword&quot;&gt;true&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;
&lt;p&gt;这里值得一提的是 &lt;code&gt;boolean&lt;/code&gt; 类型, 如果希望默认值是 false 话, 就不需要默认值, 因为 nil 和 false 对于判断来说以意义一致. 而如果希望默认值是 true 的话, 并不是 &lt;code&gt;a = a or true&lt;/code&gt;, 而是 &lt;code&gt;a == nil and true&lt;/code&gt;, 大家可以细想一下其中的含义.&lt;/p&gt;
&lt;h2 id=&quot;2-_table__u4E2D_u5143_u7D20_u7684_u521D_u59CB_u5316&quot;&gt;&lt;a href=&quot;#2-_table__u4E2D_u5143_u7D20_u7684_u521D_u59CB_u5316&quot; class=&quot;headerlink&quot; title=&quot;2. table 中元素的初始化&quot;&gt;&lt;/a&gt;2. table 中元素的初始化&lt;/h2&gt;&lt;p&gt;比如我们要统计一个列表中, 每个元素出现的次数:&lt;/p&gt;
&lt;figure class=&quot;highlight lua&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;1&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;2&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;3&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;4&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;5&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;6&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;7&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;8&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;keyword&quot;&gt;local&lt;/span&gt; list = &amp;#123;&lt;span class=&quot;number&quot;&gt;1&lt;/span&gt;,&lt;span class=&quot;number&quot;&gt;2&lt;/span&gt;,&lt;span class=&quot;number&quot;&gt;2&lt;/span&gt;,&lt;span class=&quot;number&quot;&gt;3&lt;/span&gt;,&lt;span class=&quot;number&quot;&gt;1&lt;/span&gt;,&lt;span class=&quot;number&quot;&gt;3&lt;/span&gt;&amp;#125;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;keyword&quot;&gt;local&lt;/span&gt; counter = &amp;#123;&amp;#125;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;keyword&quot;&gt;for&lt;/span&gt; i,v &lt;span class=&quot;keyword&quot;&gt;in&lt;/span&gt; &lt;span class=&quot;built_in&quot;&gt;ipairs&lt;/span&gt;(list) &lt;span class=&quot;keyword&quot;&gt;do&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    &lt;span class=&quot;keyword&quot;&gt;if&lt;/span&gt; &lt;span class=&quot;keyword&quot;&gt;not&lt;/span&gt; counter[v] &lt;span class=&quot;keyword&quot;&gt;then&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;        counter[v] = &lt;span class=&quot;number&quot;&gt;0&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    &lt;span class=&quot;keyword&quot;&gt;end&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    counter[v] = counter[v] + &lt;span class=&quot;number&quot;&gt;1&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;keyword&quot;&gt;end&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;
&lt;p&gt;因为 &lt;code&gt;counter&lt;/code&gt; 不可能提前初始化好, 所以总是要判断存不存在这个元素, 我们也可以利用上面提到的技巧做这个事情:&lt;/p&gt;
&lt;figure class=&quot;highlight lua&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;1&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;2&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;3&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;4&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;5&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;keyword&quot;&gt;local&lt;/span&gt; list = &amp;#123;&lt;span class=&quot;number&quot;&gt;1&lt;/span&gt;,&lt;span class=&quot;number&quot;&gt;2&lt;/span&gt;,&lt;span class=&quot;number&quot;&gt;2&lt;/span&gt;,&lt;span class=&quot;number&quot;&gt;3&lt;/span&gt;,&lt;span class=&quot;number&quot;&gt;1&lt;/span&gt;,&lt;span class=&quot;number&quot;&gt;3&lt;/span&gt;&amp;#125;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;keyword&quot;&gt;local&lt;/span&gt; counter = &amp;#123;&amp;#125;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;keyword&quot;&gt;for&lt;/span&gt; i,v &lt;span class=&quot;keyword&quot;&gt;in&lt;/span&gt; &lt;span class=&quot;built_in&quot;&gt;ipairs&lt;/span&gt;(list) &lt;span class=&quot;keyword&quot;&gt;do&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    counter[v] = (counter[v] &lt;span class=&quot;keyword&quot;&gt;or&lt;/span&gt; &lt;span class=&quot;number&quot;&gt;0&lt;/span&gt;) + &lt;span class=&quot;number&quot;&gt;1&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;keyword&quot;&gt;end&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;
&lt;p&gt;是不是变得很简洁 ?&lt;/p&gt;
</content>
    
    <summary type="html">
    
      奇技淫巧耳!
    
    </summary>
    
    
      <category term="Lua" scheme="http://blog.justbilt.com/tags/Lua/"/>
    
      <category term="游戏心得" scheme="http://blog.justbilt.com/tags/%E6%B8%B8%E6%88%8F%E5%BF%83%E5%BE%97/"/>
    
  </entry>
  
  <entry>
    <title>最近搞 iOS 版遇到的一些问题和技巧 (二)</title>
    <link href="http://blog.justbilt.com/2016/06/26/ios-dev-tips-2/"/>
    <id>http://blog.justbilt.com/2016/06/26/ios-dev-tips-2/</id>
    <published>2016-06-26T03:38:44.000Z</published>
    <updated>2017-03-12T04:19:57.000Z</updated>
    
    <content type="html">&lt;h2 id=&quot;u4E00-_XCode_3A_Could_not_find_Developer_Disk_Image&quot;&gt;&lt;a href=&quot;#u4E00-_XCode_3A_Could_not_find_Developer_Disk_Image&quot; class=&quot;headerlink&quot; title=&quot;一. XCode: Could not find Developer Disk Image&quot;&gt;&lt;/a&gt;一. XCode: Could not find Developer Disk Image&lt;/h2&gt;&lt;p&gt;&lt;img src=&quot;http://static.zybuluo.com/justbilt/84lvyg8n11lmtefi02pirqup/101138-1ab6ab96d37904bd.jpeg&quot; alt=&quot;101138-1ab6ab96d37904bd.jpeg-4.5kB&quot;&gt;&lt;br&gt;&lt;strong&gt;解决方案:&lt;/strong&gt;&lt;br&gt;&lt;a href=&quot;http://www.jianshu.com/p/3930df903a44&quot; target=&quot;_blank&quot; rel=&quot;external&quot;&gt;http://www.jianshu.com/p/3930df903a44&lt;/a&gt;&lt;br&gt;这个问题可能是因为你 XCode 没有下载对应 iOS 的 SDK 导致, 一般情况需要同步更新 XCode.&lt;/p&gt;
&lt;h2 id=&quot;u4E8C-_XCode_3A__u65E0_u6CD5_u5BFC_u51FA_Archive__u7684_u9879_u76EE&quot;&gt;&lt;a href=&quot;#u4E8C-_XCode_3A__u65E0_u6CD5_u5BFC_u51FA_Archive__u7684_u9879_u76EE&quot; class=&quot;headerlink&quot; title=&quot;二. XCode: 无法导出 Archive 的项目&quot;&gt;&lt;/a&gt;二. XCode: 无法导出 Archive 的项目&lt;/h2&gt;&lt;p&gt;这个问题有可能是你项目 Team 选择的是一个没有开发者资格的账号导致的, 虽然可以正常开发, 真机调试, 但是是不能发布的, 所以也无法 Export .&lt;br&gt;&lt;strong&gt;解决方案:&lt;/strong&gt;&lt;/p&gt;
&lt;ol&gt;
&lt;li&gt;更换一个有开发者资格的账号重新 Archive 导出, 但是 Bundle ID 就得换一个了.&lt;/li&gt;
&lt;li&gt;通过命令行工具导出.&lt;br&gt;在 Organizer 中找到你想导出的 Archive, 右键选择在文件夹中显示, 复制路径, 打开终端:&lt;figure class=&quot;highlight plain&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;1&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;xcodebuild -exportArchive -exportFormat ipa -archivePath your-archive-file-name.xcarchive -exportPath ~/Desktop/test.ipa&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;
&lt;/li&gt;
&lt;/ol&gt;
&lt;h2 id=&quot;u4E09-_XCode_3A_App_Installation_failed&quot;&gt;&lt;a href=&quot;#u4E09-_XCode_3A_App_Installation_failed&quot; class=&quot;headerlink&quot; title=&quot;三. XCode: App Installation failed&quot;&gt;&lt;/a&gt;三. XCode: App Installation failed&lt;/h2&gt;&lt;p&gt;&lt;img src=&quot;http://static.zybuluo.com/justbilt/kl9sahl74sqfnxgjem57f390/Unknown.png&quot; alt=&quot;Unknown.png-45.1kB&quot;&gt;&lt;br&gt;很可能是之前手机已经装过一个同 Bundle ID 的应用, 但是现在换了签名.&lt;br&gt;&lt;strong&gt;解决方案:&lt;/strong&gt;&lt;br&gt;删掉手机已经安装的那个应用就可以啦.&lt;/p&gt;
&lt;h2 id=&quot;u56DB-_XCode_3A_Failed_to_code_sign__u201Cxxxx_u201D&quot;&gt;&lt;a href=&quot;#u56DB-_XCode_3A_Failed_to_code_sign__u201Cxxxx_u201D&quot; class=&quot;headerlink&quot; title=&quot;四. XCode: Failed to code sign “xxxx”&quot;&gt;&lt;/a&gt;四. XCode: Failed to code sign “xxxx”&lt;/h2&gt;&lt;p&gt;&lt;img src=&quot;http://static.zybuluo.com/justbilt/eb80q3re93fflmiuhygk4f1m/QQ20160626-0.png&quot; alt=&quot;QQ20160626-0.png-437.7kB&quot;&gt;&lt;br&gt;签名失败了, 这种情况一般发生在使用别人给的证书打包时. 这时候我们项目 &lt;code&gt;Build Setting &amp;gt; Code Signing Identity&lt;/code&gt; 就不能选择 &lt;code&gt;iOS Developer&lt;/code&gt;, 而是要选择导入的签名文件.&lt;/p&gt;
&lt;h2 id=&quot;u4E94-__u5185_u8D2D_3A__u65E0_u6CD5_u8FDE_u63A5_u5230_iTunes_Store&quot;&gt;&lt;a href=&quot;#u4E94-__u5185_u8D2D_3A__u65E0_u6CD5_u8FDE_u63A5_u5230_iTunes_Store&quot; class=&quot;headerlink&quot; title=&quot;五. 内购: 无法连接到 iTunes Store&quot;&gt;&lt;/a&gt;五. 内购: 无法连接到 iTunes Store&lt;/h2&gt;&lt;p&gt;如果没有发布应用的话, 需要用沙盒测试账号来测试. 我们需要先在 &lt;code&gt;设置&amp;gt;iTunes Store 和 App Store&lt;/code&gt;中 &lt;strong&gt;注销账号&lt;/strong&gt;, 然后打开游戏, 开始购买, 这时候输入你的测试账号. 成功后如果有跳转 App Store 的话或者绑定付款方式的话, 不同理会, 再返回应用购买就可以了.&lt;/p&gt;
&lt;h2 id=&quot;u516D-__u5D29_u6E83_3A_showAlert__u5D29_u6E83&quot;&gt;&lt;a href=&quot;#u516D-__u5D29_u6E83_3A_showAlert__u5D29_u6E83&quot; class=&quot;headerlink&quot; title=&quot;六. 崩溃: showAlert 崩溃&quot;&gt;&lt;/a&gt;六. 崩溃: showAlert 崩溃&lt;/h2&gt;&lt;p&gt;某一次突然, 一旦调用 quick-x 提供的 &lt;code&gt;device.showAlert&lt;/code&gt; 就会崩溃, 断点调试无果, 崩溃时提示的内容也不尽相同.&lt;br&gt;&lt;strong&gt;解决方案:&lt;/strong&gt;&lt;br&gt;删除 &lt;code&gt;RootViewController.mm&lt;/code&gt; 中所有和屏幕方向代码, 就解决啦.&lt;/p&gt;
&lt;figure class=&quot;highlight objc&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;1&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;2&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;3&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;4&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;- (&lt;span class=&quot;built_in&quot;&gt;BOOL&lt;/span&gt;)shouldAutorotateToInterfaceOrientation:(&lt;span class=&quot;built_in&quot;&gt;UIInterfaceOrientation&lt;/span&gt;)interfaceOrientation&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;- (&lt;span class=&quot;built_in&quot;&gt;NSUInteger&lt;/span&gt;) supportedInterfaceOrientations&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;- (&lt;span class=&quot;built_in&quot;&gt;BOOL&lt;/span&gt;) shouldAutorotate&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;- (&lt;span class=&quot;keyword&quot;&gt;void&lt;/span&gt;)didRotateFromInterfaceOrientation:(&lt;span class=&quot;built_in&quot;&gt;UIInterfaceOrientation&lt;/span&gt;)fromInterfaceOrientation&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;
&lt;h2 id=&quot;u4E03-__u5D29_u6E83_3A_iOS_9-2+__u64AD_u653E_u89C6_u9891_u5D29_u6E83&quot;&gt;&lt;a href=&quot;#u4E03-__u5D29_u6E83_3A_iOS_9-2+__u64AD_u653E_u89C6_u9891_u5D29_u6E83&quot; class=&quot;headerlink&quot; title=&quot;七. 崩溃: iOS 9.2+ 播放视频崩溃&quot;&gt;&lt;/a&gt;七. 崩溃: iOS 9.2+ 播放视频崩溃&lt;/h2&gt;&lt;p&gt;感谢 @子龙山人 大神提供的解决方案, &lt;a href=&quot;https://github.com/cocos2d/cocos2d-x/issues/14855&quot; target=&quot;_blank&quot; rel=&quot;external&quot;&gt;点击这里查看&lt;/a&gt;.&lt;/p&gt;
&lt;p&gt;将 &lt;code&gt;UIVideoPlayer-ios.mm&lt;/code&gt; 文件 &lt;code&gt;~VideoPlayer()&lt;/code&gt; 函数中的 &lt;code&gt;dealloc&lt;/code&gt; 修改为 &lt;code&gt;release&lt;/code&gt; 即可.&lt;/p&gt;
&lt;figure class=&quot;highlight objc&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;1&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;2&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;-        [((&lt;span class=&quot;built_in&quot;&gt;UIVideoViewWrapperIos&lt;/span&gt;*)_videoView) dealloc];&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;+        [((&lt;span class=&quot;built_in&quot;&gt;UIVideoViewWrapperIos&lt;/span&gt;*)_videoView) release];&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;
</content>
    
    <summary type="html">
    
      万一遇上了呢?
    
    </summary>
    
    
      <category term="iOS" scheme="http://blog.justbilt.com/tags/iOS/"/>
    
      <category term="iOS-Dev-Tips" scheme="http://blog.justbilt.com/tags/iOS-Dev-Tips/"/>
    
  </entry>
  
  <entry>
    <title>quick-x 适配 IPV6</title>
    <link href="http://blog.justbilt.com/2016/06/19/quickx-ipv6/"/>
    <id>http://blog.justbilt.com/2016/06/19/quickx-ipv6/</id>
    <published>2016-06-19T07:39:44.000Z</published>
    <updated>2017-03-12T02:22:53.000Z</updated>
    
    <content type="html">&lt;h1 id=&quot;u4E00-_IPV6__u662F_u5565__3F&quot;&gt;&lt;a href=&quot;#u4E00-_IPV6__u662F_u5565__3F&quot; class=&quot;headerlink&quot; title=&quot;一. IPV6 是啥 ?&quot;&gt;&lt;/a&gt;一. IPV6 是啥 ?&lt;/h1&gt;&lt;p&gt;这两天一个运营的同事跑过来问我:&lt;/p&gt;
&lt;blockquote&gt;
&lt;p&gt;他: 咱们的游戏适配那啥 VIP6 了么?&lt;br&gt;我: ….&lt;/p&gt;
&lt;/blockquote&gt;
&lt;p&gt;苹果商店在儿童节之后就不允许未适配 IPV6 的应用上架了, IPV6 是啥 ? 需要做些什么呢 ? 看完这两篇文章就明白了:&lt;/p&gt;
&lt;p&gt;&lt;a href=&quot;http://www.jianshu.com/p/a6bab07c4062&quot; target=&quot;_blank&quot; rel=&quot;external&quot;&gt;iOS应用支持IPV6，就那点事儿&lt;/a&gt;&lt;br&gt;&lt;a href=&quot;http://www.jianshu.com/p/69ed4489762c&quot; target=&quot;_blank&quot; rel=&quot;external&quot;&gt;针对苹果最新审核要求为应用兼容IPv6&lt;/a&gt;&lt;/p&gt;
&lt;p&gt;虽然这两篇文章是针对应用的, 但是从中我们也能了解大概的做法:&lt;/p&gt;
&lt;ol&gt;
&lt;li&gt;不建议使用底层的网络API&lt;/li&gt;
&lt;li&gt;不要用IP地址&lt;/li&gt;
&lt;/ol&gt;
&lt;h1 id=&quot;u4E8C-_COCOS2D-X__u9002_u914D_IPV6&quot;&gt;&lt;a href=&quot;#u4E8C-_COCOS2D-X__u9002_u914D_IPV6&quot; class=&quot;headerlink&quot; title=&quot;二. COCOS2D-X 适配 IPV6&quot;&gt;&lt;/a&gt;二. COCOS2D-X 适配 IPV6&lt;/h1&gt;&lt;p&gt;cocos 依赖的三方库涉及到 IPV6 问题的库为 &lt;code&gt;curl&lt;/code&gt;, &lt;code&gt;websocket&lt;/code&gt;, cocos 自己提供的模块需要适配的有: &lt;/p&gt;
&lt;ol&gt;
&lt;li&gt;HttpClient&lt;/li&gt;
&lt;li&gt;AssetsManagerEx&lt;/li&gt;
&lt;li&gt;SocketIO&lt;/li&gt;
&lt;li&gt;WebSocket&lt;/li&gt;
&lt;li&gt;Console&lt;/li&gt;
&lt;li&gt;ScriptingCore&lt;/li&gt;
&lt;/ol&gt;
&lt;p&gt;cocos 官方也第一时间适配了 IPV6, 具体内容可以看这篇文章:&lt;a href=&quot;https://mp.weixin.qq.com/s?__biz=MjM5ODAxNTM2NA==&amp;amp;mid=2659642350&amp;amp;idx=1&amp;amp;sn=a7db1bb86e965f8408c1687f73b23c7e&amp;amp;scene=1&amp;amp;srcid=0619ztJlty4HuLRBOll0Yr6V&amp;amp;key=18e81ac7415f67c4acff47973e6979565cda32dd8f6c87dca6f733d6e6b4118817536543eb3844b8c890968fdbb06eed&amp;amp;ascene=0&amp;amp;uin=Mjk2MDM0NjgyMA%3D%3D&amp;amp;devicetype=iMac+MacBookAir6%2C2+OSX+OSX+10.10.5+build(14F1021)&amp;amp;version=11020201&amp;amp;pass_ticket=WECSEWT6jaVZNRKNNwilauFgBa%2FhDiF9DioAiHKmly2CArsnkf%2FQbQJchxVf%2F7bk&quot; target=&quot;_blank&quot; rel=&quot;external&quot;&gt;儿童节后苹果爸爸只爱IPv6 Cocos2d-x第一时间支持&lt;/a&gt;, 里面描述的很简单:&lt;/p&gt;
&lt;blockquote&gt;
&lt;p&gt;如果你需要支持纯IPv6网络，只需要更新CURL和libwebsocket网络。&lt;/p&gt;
&lt;/blockquote&gt;
&lt;p&gt;让我们尝试一下.&lt;/p&gt;
&lt;h2 id=&quot;1-__u4E0B_u8F7D_cocos2d-x-3rd-party-libs-bin&quot;&gt;&lt;a href=&quot;#1-__u4E0B_u8F7D_cocos2d-x-3rd-party-libs-bin&quot; class=&quot;headerlink&quot; title=&quot;1. 下载 cocos2d-x-3rd-party-libs-bin&quot;&gt;&lt;/a&gt;1. 下载 cocos2d-x-3rd-party-libs-bin&lt;/h2&gt;&lt;p&gt;这一步看似很简单, 实则不然. 你不会想到从 github 上下载一个 100 多 MB 的文件是多麽困难, 为此我花费了近 2个小时的时间.&lt;/p&gt;
&lt;p&gt;我下载的是 99 版的, 解压代用.&lt;/p&gt;
&lt;h2 id=&quot;2-__u66F4_u65B0_curl&quot;&gt;&lt;a href=&quot;#2-__u66F4_u65B0_curl&quot; class=&quot;headerlink&quot; title=&quot;2. 更新 curl&quot;&gt;&lt;/a&gt;2. 更新 curl&lt;/h2&gt;&lt;p&gt;拷贝解压出来的文件夹中的 &lt;code&gt;curl&lt;/code&gt; 目录到 &lt;code&gt;quick-cocos2d-x/external&lt;/code&gt;, 替换原来的 &lt;code&gt;curl&lt;/code&gt; 目录.&lt;/p&gt;
&lt;p&gt;打开 xcode, 编译, 发现有 100 多个错误:&lt;/p&gt;
&lt;p&gt;&lt;img src=&quot;http://static.zybuluo.com/justbilt/6b752pk1bzragqhjgbl2llky/image_1alkfke1vag91ccc1p15179c1jtcm.png&quot; alt=&quot;image_1alkfke1vag91ccc1p15179c1jtcm.png-113.9kB&quot;&gt;&lt;/p&gt;
&lt;figure class=&quot;highlight plain&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;1&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;Undefined symbols for architecture i386:&amp;#10;  &amp;#34;_ASN1_INTEGER_get&amp;#34;, referenced from:&amp;#10;      _ossl_connect_common in libcocos2d iOS.a(libcurl_la-openssl.o)&amp;#10;  &amp;#34;_ASN1_STRING_data&amp;#34;, referenced from:&amp;#10;      _ossl_connect_common in libcocos2d iOS.a(libcurl_la-openssl.o)&amp;#10;  &amp;#34;_ASN1_STRING_length&amp;#34;, referenced from:&amp;#10;      _ossl_connect_common in libcocos2d iOS.a(libcurl_la-openssl.o)&amp;#10;    ...&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;
&lt;p&gt;不要惊慌, 这是因为新版本 curl 多了一些静态库, 我们需要引入它们, 在 XCode 项目输找到 &lt;code&gt;cocos2d_lib &amp;gt; external &amp;gt; curl &amp;gt; ios&lt;/code&gt; 目录上右键, 选择 &lt;code&gt;Add Files to &amp;#39;cocos2d_lib.xcodeproj&amp;#39;&lt;/code&gt;:&lt;/p&gt;
&lt;p&gt;&lt;img src=&quot;http://static.zybuluo.com/justbilt/1c0jehn0zxvrj7u3pf2cugam/image_1alkfv73t446cr3sc41r6r1hqj13.png&quot; alt=&quot;image_1alkfv73t446cr3sc41r6r1hqj13.png-238.8kB&quot;&gt;&lt;/p&gt;
&lt;p&gt;选中 &lt;code&gt;libcrypto.a&lt;/code&gt; 和 &lt;code&gt;libssl.a&lt;/code&gt;, targets 选择 &lt;code&gt;libcocos2d iOS&lt;/code&gt;, 确定, 重新编译, 搞定.&lt;/p&gt;
&lt;h2 id=&quot;3-__u66F4_u65B0_websocket&quot;&gt;&lt;a href=&quot;#3-__u66F4_u65B0_websocket&quot; class=&quot;headerlink&quot; title=&quot;3. 更新 websocket&quot;&gt;&lt;/a&gt;3. 更新 websocket&lt;/h2&gt;&lt;blockquote&gt;
&lt;p&gt;注: 我们项目并没有用到 websocket , 所以这里只是搞到编译通过, 运行时有木有问题就不到知道了!&lt;/p&gt;
&lt;/blockquote&gt;
&lt;p&gt;和 curl 类似, 拷贝 cocos2d-x-3rd-party-libs 中的 &lt;code&gt;websockets&lt;/code&gt; 目录到 &lt;code&gt;quick-cocos2d-x/external&lt;/code&gt;, 替换原来的 &lt;code&gt;websockets&lt;/code&gt; 目录.&lt;/p&gt;
&lt;p&gt;因为最新版的 websockets api 变化挺大, 所以我们需要使用 cocos &lt;a href=&quot;https://github.com/cocos2d/cocos2d-x/tree/v3/cocos/network&quot; target=&quot;_blank&quot; rel=&quot;external&quot;&gt;最新的&lt;/a&gt; WebSocket.h 和 WebSocket.cpp 替换 quick-cocos2d-x/cocos/network 中的 &lt;code&gt;WebSocket&lt;/code&gt; .&lt;/p&gt;
&lt;p&gt;编译, 会有一处错误发生在 &lt;code&gt;WebSocket::WebSocket()&lt;/code&gt; 中, 因为 quick 中并没有 &lt;code&gt;Director::EVENT_RESET&lt;/code&gt; 消息, 我们注释掉这段代码即可.&lt;/p&gt;
&lt;figure class=&quot;highlight cpp&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;1&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;2&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;3&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;4&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;5&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;6&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;7&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;8&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;9&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;10&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;11&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;12&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;13&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;14&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;15&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;16&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;17&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;&amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    &lt;span class=&quot;comment&quot;&gt;// reserve data buffer to avoid allocate memory frequently&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    _receivedData.reserve(WS_RESERVE_RECEIVE_BUFFER_SIZE);&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    &lt;span class=&quot;keyword&quot;&gt;if&lt;/span&gt; (__websocketInstances == &lt;span class=&quot;literal&quot;&gt;nullptr&lt;/span&gt;)&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    &amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;        __websocketInstances = &lt;span class=&quot;keyword&quot;&gt;new&lt;/span&gt; (&lt;span class=&quot;built_in&quot;&gt;std&lt;/span&gt;::nothrow) &lt;span class=&quot;built_in&quot;&gt;std&lt;/span&gt;::&lt;span class=&quot;built_in&quot;&gt;vector&lt;/span&gt;&amp;lt;WebSocket*&amp;gt;();&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    &amp;#125;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    __websocketInstances-&amp;gt;push_back(&lt;span class=&quot;keyword&quot;&gt;this&lt;/span&gt;);&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    &lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;comment&quot;&gt;//    std::shared_ptr&amp;lt;std::atomic&amp;lt;bool&amp;gt;&amp;gt; isDestroyed = _isDestroyed;&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;comment&quot;&gt;//    _resetDirectorListener = Director::getInstance()-&amp;gt;getEventDispatcher()-&amp;gt;addCustomEventListener(Director::EVENT_RESET, [this, isDestroyed](EventCustom*)&amp;#123;&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;comment&quot;&gt;//        if (*isDestroyed)&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;comment&quot;&gt;//            return;&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;comment&quot;&gt;//        close();&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;comment&quot;&gt;//    &amp;#125;);&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&amp;#125;&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;
&lt;h1 id=&quot;u4E09-_QUICK-COCOS2D-X__u9002_u914D_IPV6&quot;&gt;&lt;a href=&quot;#u4E09-_QUICK-COCOS2D-X__u9002_u914D_IPV6&quot; class=&quot;headerlink&quot; title=&quot;三. QUICK-COCOS2D-X 适配 IPV6&quot;&gt;&lt;/a&gt;三. QUICK-COCOS2D-X 适配 IPV6&lt;/h1&gt;&lt;h2 id=&quot;1-__u5982_u4F55_u9002_u914D&quot;&gt;&lt;a href=&quot;#1-__u5982_u4F55_u9002_u914D&quot; class=&quot;headerlink&quot; title=&quot;1. 如何适配&quot;&gt;&lt;/a&gt;1. 如何适配&lt;/h2&gt;&lt;p&gt;quick-x 中主要是 luasocket 的适配, 适配的方法就是选择性的调用 &lt;code&gt;socket.tcp6()&lt;/code&gt; 和 &lt;code&gt;socket.tcp()&lt;/code&gt;, udp 也是如此.&lt;/p&gt;
&lt;p&gt;quick-x 中调创建 socket 是在 &lt;code&gt;SocketTCP:connect&lt;/code&gt; 函数中, 并没有预留 ipv6 参数, 我们需要添加一下:&lt;/p&gt;
&lt;figure class=&quot;highlight lua&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;1&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;2&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;3&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;4&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;5&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;6&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;7&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;8&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;9&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;10&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;11&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;12&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;13&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;14&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;function&quot;&gt;&lt;span class=&quot;keyword&quot;&gt;function&lt;/span&gt; &lt;span class=&quot;title&quot;&gt;SocketTCP:connect&lt;/span&gt;&lt;span class=&quot;params&quot;&gt;(__host, __port, __retryConnectWhenFailure, __ipv6)&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    &lt;span class=&quot;keyword&quot;&gt;if&lt;/span&gt; __host &lt;span class=&quot;keyword&quot;&gt;then&lt;/span&gt; self.host = __host &lt;span class=&quot;keyword&quot;&gt;end&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    &lt;span class=&quot;keyword&quot;&gt;if&lt;/span&gt; __port &lt;span class=&quot;keyword&quot;&gt;then&lt;/span&gt; self.port = __port &lt;span class=&quot;keyword&quot;&gt;end&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    &lt;span class=&quot;keyword&quot;&gt;if&lt;/span&gt; __retryConnectWhenFailure ~= &lt;span class=&quot;keyword&quot;&gt;nil&lt;/span&gt; &lt;span class=&quot;keyword&quot;&gt;then&lt;/span&gt; self.isRetryConnect = __retryConnectWhenFailure &lt;span class=&quot;keyword&quot;&gt;end&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    &lt;span class=&quot;built_in&quot;&gt;assert&lt;/span&gt;(self.host &lt;span class=&quot;keyword&quot;&gt;or&lt;/span&gt; self.port, &lt;span class=&quot;string&quot;&gt;&quot;Host and port are necessary!&quot;&lt;/span&gt;)&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    &lt;span class=&quot;comment&quot;&gt;--printInfo(&quot;%s.connect(%s, %d)&quot;, self.name, self.host, self.port)&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    &lt;span class=&quot;keyword&quot;&gt;if&lt;/span&gt; __ipv6 &lt;span class=&quot;keyword&quot;&gt;then&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;        self.tcp = socket.tcp6()&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    &lt;span class=&quot;keyword&quot;&gt;else&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;        self.tcp = socket.tcp()&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    &lt;span class=&quot;keyword&quot;&gt;end&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    &lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    self.tcp:settimeout(&lt;span class=&quot;number&quot;&gt;0&lt;/span&gt;)&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    ...&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;
&lt;p&gt;然后, 如果要连接 ipv6 的服务器的话, &lt;code&gt;__ipv6&lt;/code&gt; 值传 &lt;code&gt;true&lt;/code&gt; 即可.&lt;/p&gt;
&lt;h2 id=&quot;2-__u5982_u4F55_u5224_u65AD_u4E00_u4E2A_u670D_u52A1_u5668_u662F_ipv6__u8FD8_u662F_ipv4&quot;&gt;&lt;a href=&quot;#2-__u5982_u4F55_u5224_u65AD_u4E00_u4E2A_u670D_u52A1_u5668_u662F_ipv6__u8FD8_u662F_ipv4&quot; class=&quot;headerlink&quot; title=&quot;2. 如何判断一个服务器是 ipv6 还是 ipv4&quot;&gt;&lt;/a&gt;2. 如何判断一个服务器是 ipv6 还是 ipv4&lt;/h2&gt;&lt;p&gt;lua 中 socket 的 dns 模块提供了一个函数 &lt;code&gt;getaddrinfo&lt;/code&gt;, 可以返回一个服务器的 dns 解析结果数组, 其中一个很重要的字段就是 &lt;code&gt;family&lt;/code&gt;, 有 &lt;code&gt;inet&lt;/code&gt; 和 &lt;code&gt;inet6&lt;/code&gt; 两个值可选.&lt;/p&gt;
&lt;p&gt;大家可以运行 &lt;code&gt;dump(socket.dns.getaddrinfo(&amp;quot;ipv6-test.com&amp;quot;))&lt;/code&gt; 看下结果:&lt;/p&gt;
&lt;figure class=&quot;highlight lua&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;1&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;2&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;3&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;4&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;5&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;6&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;7&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;8&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;9&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;10&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;- &lt;span class=&quot;string&quot;&gt;&quot;&amp;lt;var&amp;gt;&quot;&lt;/span&gt; = &amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;-     &lt;span class=&quot;number&quot;&gt;1&lt;/span&gt; = &amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;-         &lt;span class=&quot;string&quot;&gt;&quot;addr&quot;&lt;/span&gt;   = &lt;span class=&quot;string&quot;&gt;&quot;5.135.165.173&quot;&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;-         &lt;span class=&quot;string&quot;&gt;&quot;family&quot;&lt;/span&gt; = &lt;span class=&quot;string&quot;&gt;&quot;inet&quot;&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;-     &amp;#125;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;-     &lt;span class=&quot;number&quot;&gt;2&lt;/span&gt; = &amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;-         &lt;span class=&quot;string&quot;&gt;&quot;addr&quot;&lt;/span&gt;   = &lt;span class=&quot;string&quot;&gt;&quot;2001:41d0:8:e8ad::1&quot;&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;-         &lt;span class=&quot;string&quot;&gt;&quot;family&quot;&lt;/span&gt; = &lt;span class=&quot;string&quot;&gt;&quot;inet6&quot;&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;-     &amp;#125;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;- &amp;#125;&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;
&lt;p&gt;我们遍历一下这个结果, 如果其中有 &lt;code&gt;&amp;quot;family&amp;quot; = &amp;quot;inet6&amp;quot;&lt;/code&gt; 的解析, 就可以使用 ipv6 进行连接了, 代码实现如下:&lt;/p&gt;
&lt;figure class=&quot;highlight lua&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;1&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;2&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;3&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;4&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;5&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;6&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;7&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;8&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;9&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;10&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;11&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;12&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;13&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;keyword&quot;&gt;local&lt;/span&gt; &lt;span class=&quot;function&quot;&gt;&lt;span class=&quot;keyword&quot;&gt;function&lt;/span&gt; &lt;span class=&quot;title&quot;&gt;isSupportIpv6&lt;/span&gt;&lt;span class=&quot;params&quot;&gt;(_domain)&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    &lt;span class=&quot;keyword&quot;&gt;local&lt;/span&gt; result = socket.dns.getaddrinfo(_domain)&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    &lt;span class=&quot;keyword&quot;&gt;local&lt;/span&gt; ipv6 = &lt;span class=&quot;keyword&quot;&gt;false&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    &lt;span class=&quot;keyword&quot;&gt;if&lt;/span&gt; result &lt;span class=&quot;keyword&quot;&gt;then&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;        &lt;span class=&quot;keyword&quot;&gt;for&lt;/span&gt; k,v &lt;span class=&quot;keyword&quot;&gt;in&lt;/span&gt; &lt;span class=&quot;built_in&quot;&gt;pairs&lt;/span&gt;(result) &lt;span class=&quot;keyword&quot;&gt;do&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;            &lt;span class=&quot;keyword&quot;&gt;if&lt;/span&gt; v.family == &lt;span class=&quot;string&quot;&gt;&quot;inet6&quot;&lt;/span&gt; &lt;span class=&quot;keyword&quot;&gt;then&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;                ipv6 = &lt;span class=&quot;keyword&quot;&gt;true&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;                &lt;span class=&quot;keyword&quot;&gt;break&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;            &lt;span class=&quot;keyword&quot;&gt;end&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;        &lt;span class=&quot;keyword&quot;&gt;end&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    &lt;span class=&quot;keyword&quot;&gt;end&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    &lt;span class=&quot;keyword&quot;&gt;return&lt;/span&gt; ipv6&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;keyword&quot;&gt;end&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;
&lt;p&gt;我们将这个函数的结果作为 &lt;code&gt;SocketTCP:connect&lt;/code&gt; 的最后一个参数传入即可.&lt;/p&gt;
&lt;h1 id=&quot;u56DB-__u8FD8_u6709_u4EC0_u4E48_u8981_u6CE8_u610F_u7684&quot;&gt;&lt;a href=&quot;#u56DB-__u8FD8_u6709_u4EC0_u4E48_u8981_u6CE8_u610F_u7684&quot; class=&quot;headerlink&quot; title=&quot;四. 还有什么要注意的&quot;&gt;&lt;/a&gt;四. 还有什么要注意的&lt;/h1&gt;&lt;h2 id=&quot;1-__u4E00_u5B9A_u8981_u4F7F_u7528_u4F7F_u7528_u57DF_u540D&quot;&gt;&lt;a href=&quot;#1-__u4E00_u5B9A_u8981_u4F7F_u7528_u4F7F_u7528_u57DF_u540D&quot; class=&quot;headerlink&quot; title=&quot;1. 一定要使用使用域名&quot;&gt;&lt;/a&gt;1. 一定要使用使用域名&lt;/h2&gt;&lt;p&gt;向苹果提审的服务器一定要使用域名, 所有的地方都是如此, 包括 http 请求, 热更新返回的 &lt;code&gt;version.md&lt;/code&gt; 地址.&lt;/p&gt;
&lt;h2 id=&quot;2-__u505A_u597D_u517C_u5BB9_u6027_u6D4B_u8BD5&quot;&gt;&lt;a href=&quot;#2-__u505A_u597D_u517C_u5BB9_u6027_u6D4B_u8BD5&quot; class=&quot;headerlink&quot; title=&quot;2. 做好兼容性测试&quot;&gt;&lt;/a&gt;2. 做好兼容性测试&lt;/h2&gt;&lt;p&gt;测试 IPV6 ONLY 的时候使用最新的 iOS 9.3 做测试, 苹果他们审核的时候也是只审核最新的系统是否正常. &lt;/p&gt;
&lt;p&gt;但是我们实现的时候要兼容的不同的系统, 网络环境(&lt;code&gt;IPV6 兼容&lt;/code&gt; 和 &lt;code&gt;IPV6 ONLY&lt;/code&gt;), 因为用户的网络可能是各种各样样, 这些组合都要测试到.&lt;/p&gt;
</content>
    
    <summary type="html">
    
      你们的游戏适配那啥 VIP6 了么?
    
    </summary>
    
    
      <category term="Quick-Cocos2d-x" scheme="http://blog.justbilt.com/tags/Quick-Cocos2d-x/"/>
    
      <category term="iOS" scheme="http://blog.justbilt.com/tags/iOS/"/>
    
  </entry>
  
  <entry>
    <title>quick-x 使用静态库加速 iOS 打包</title>
    <link href="http://blog.justbilt.com/2016/05/29/quickx-ios-static-lib/"/>
    <id>http://blog.justbilt.com/2016/05/29/quickx-ios-static-lib/</id>
    <published>2016-05-29T13:20:58.000Z</published>
    <updated>2017-03-12T02:22:53.000Z</updated>
    
    <content type="html">&lt;p&gt;quick-x 项目的 iOS 工程使用 &lt;code&gt;Tgarget Dependencise&lt;/code&gt; 依赖 &lt;code&gt;cocos2d_lib&lt;/code&gt; 和 &lt;code&gt;cocos_lua_bindings&lt;/code&gt; 工程.&lt;/p&gt;
&lt;p&gt;&lt;img src=&quot;http://static.zybuluo.com/justbilt/i0vtatej9k1wx2d9ck8fmqhy/QQ20160529-0.png&quot; alt=&quot;QQ20160529-0.png-27kB&quot;&gt;&lt;/p&gt;
&lt;p&gt;这样子在 iOS Archive 时会重新编译这两个项目, 十分痛苦, 尤其是一次出七八个渠道的包, 好几个小时就耗在里面了.&lt;/p&gt;
&lt;p&gt;为什么不用静态库, 编译出 .a , 使用时直接链接就可以了嘛.&lt;/p&gt;
&lt;h1 id=&quot;u4E00-__u7F16_u8BD1_u9759_u6001_u5E93&quot;&gt;&lt;a href=&quot;#u4E00-__u7F16_u8BD1_u9759_u6001_u5E93&quot; class=&quot;headerlink&quot; title=&quot;一. 编译静态库&quot;&gt;&lt;/a&gt;一. 编译静态库&lt;/h1&gt;&lt;p&gt;找了一下, 原来早已经有小伙伴想到了这点, 这篇文章 &lt;a href=&quot;http://www.nicnocquee.com/2016/01/20/build-cocos2d-x-fat-static-library.html&quot; target=&quot;_blank&quot; rel=&quot;external&quot;&gt;Build cocos2d-x fat static library&lt;/a&gt; 就特别棒. 从中我们可以发现一个特别有用的脚本 &lt;a href=&quot;https://gist.github.com/nicnocquee/9dc4c4a128d7c0bafe23#file-buildstaticlib-sh&quot; target=&quot;_blank&quot; rel=&quot;external&quot;&gt;buildstaticlib.sh&lt;/a&gt;, 可以直接使用 xcode 工程编译出静态库.&lt;/p&gt;
&lt;p&gt;不过这个脚本只能编译出 &lt;code&gt;Release&lt;/code&gt; 版, 我修改下可以传入 &lt;code&gt;configuration&lt;/code&gt;, 这样我们可以分别编译出 Debug 和 Release 版的静态库啦, 我修改后的&lt;a href=&quot;https://gist.github.com/justbilt/903ef34b568527d57c9bd9bf4069ed72&quot; target=&quot;_blank&quot; rel=&quot;external&quot;&gt;文件在这里&lt;/a&gt;.&lt;/p&gt;
&lt;p&gt;因为我们要编译出多个静态库, 所有又写了另一个脚本 &lt;code&gt;build.sh&lt;/code&gt; 调用 &lt;code&gt;buildstaticlib.sh&lt;/code&gt; , 内容如下:&lt;/p&gt;
&lt;figure class=&quot;highlight sh&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;1&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;2&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;3&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;4&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;5&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;6&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;7&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;./buildstaticlib.sh &lt;span class=&quot;variable&quot;&gt;$QUICK_V3_ROOT&lt;/span&gt;/cocos/scripting/lua-bindings/proj.ios_mac/cocos2d_lua_bindings.xcodeproj &lt;span class=&quot;string&quot;&gt;&quot;libluacocos2d iOS&quot;&lt;/span&gt; &lt;span class=&quot;string&quot;&gt;&quot;Release&quot;&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;./buildstaticlib.sh &lt;span class=&quot;variable&quot;&gt;$QUICK_V3_ROOT&lt;/span&gt;/build/cocos2d_libs.xcodeproj &lt;span class=&quot;string&quot;&gt;&quot;libcocos2d iOS&quot;&lt;/span&gt; &lt;span class=&quot;string&quot;&gt;&quot;Release&quot;&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;./buildstaticlib.sh &lt;span class=&quot;variable&quot;&gt;$QUICK_V3_ROOT&lt;/span&gt;/cocos/scripting/lua-bindings/proj.ios_mac/cocos2d_lua_bindings.xcodeproj &lt;span class=&quot;string&quot;&gt;&quot;libluacocos2d iOS&quot;&lt;/span&gt; &lt;span class=&quot;string&quot;&gt;&quot;Debug&quot;&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;./buildstaticlib.sh &lt;span class=&quot;variable&quot;&gt;$QUICK_V3_ROOT&lt;/span&gt;/build/cocos2d_libs.xcodeproj &lt;span class=&quot;string&quot;&gt;&quot;libcocos2d iOS&quot;&lt;/span&gt; &lt;span class=&quot;string&quot;&gt;&quot;Debug&quot;&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;
&lt;p&gt;运行成功后会在当前目录生成 4 个 .a 文件, 下一步中将会用到.&lt;br&gt;&lt;figure class=&quot;highlight sh&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;1&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;2&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;3&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;4&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;5&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;6&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;7&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;.&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;├── build.sh&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;├── buildstaticlib.sh&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;├── libcocos2d\ iOS-debug.a&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;├── libcocos2d\ iOS.a&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;├── libluacocos2d\ iOS-debug.a&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;└── libluacocos2d\ iOS.a&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;&lt;/p&gt;
&lt;h1 id=&quot;u4E8C-__u4F7F_u7528_u9759_u6001_u5E93&quot;&gt;&lt;a href=&quot;#u4E8C-__u4F7F_u7528_u9759_u6001_u5E93&quot; class=&quot;headerlink&quot; title=&quot;二. 使用静态库&quot;&gt;&lt;/a&gt;二. 使用静态库&lt;/h1&gt;&lt;p&gt;使用 XCode 打开 &lt;code&gt;proj.ios_mac&lt;/code&gt; 目录下的 &lt;code&gt;xxx.xcodeproj&lt;/code&gt; 工程.&lt;/p&gt;
&lt;h2 id=&quot;1-__u79FB_u9664_Tgarget_Dependencise&quot;&gt;&lt;a href=&quot;#1-__u79FB_u9664_Tgarget_Dependencise&quot; class=&quot;headerlink&quot; title=&quot;1. 移除 Tgarget Dependencise&quot;&gt;&lt;/a&gt;1. 移除 Tgarget Dependencise&lt;/h2&gt;&lt;p&gt;首先移除对 &lt;code&gt;cocos2d_lib&lt;/code&gt; 和 &lt;code&gt;cocos_lua_bindings&lt;/code&gt; 工程的依赖, 右键点击 &lt;code&gt;Delete&lt;/code&gt; 然后选择 &lt;code&gt;Remove reference&lt;/code&gt; 就可以.&lt;/p&gt;
&lt;p&gt;&lt;img src=&quot;http://static.zybuluo.com/justbilt/3d9eiua1tind8aycakjwymgl/QQ20160529-1.png&quot; alt=&quot;QQ20160529-1.png-49.2kB&quot;&gt;&lt;/p&gt;
&lt;h2 id=&quot;2-__u6DFB_u52A0_Other_Linker_Flags&quot;&gt;&lt;a href=&quot;#2-__u6DFB_u52A0_Other_Linker_Flags&quot; class=&quot;headerlink&quot; title=&quot;2. 添加 Other Linker Flags&quot;&gt;&lt;/a&gt;2. 添加 Other Linker Flags&lt;/h2&gt;&lt;p&gt;我们静态库的依赖是在这里添加的, 在 Debug 和 Release 选项中分别加入对应的静态库.&lt;br&gt;&lt;img src=&quot;http://static.zybuluo.com/justbilt/5g1o6ozh1j4dlybcjftfybnr/QQ20160529-3.png&quot; alt=&quot;QQ20160529-3.png-117.8kB&quot;&gt;&lt;/p&gt;
&lt;p&gt;这样就完成啦, 尝试一下 Archive 的速度吧 !&lt;/p&gt;
&lt;h1 id=&quot;u4E09-__u5176_u4ED6&quot;&gt;&lt;a href=&quot;#u4E09-__u5176_u4ED6&quot; class=&quot;headerlink&quot; title=&quot;三. 其他&quot;&gt;&lt;/a&gt;三. 其他&lt;/h1&gt;&lt;h2 id=&quot;1-__u8C03_u8BD5_u73AF_u5883_u4E0E_u751F_u4EA7_u73AF_u5883&quot;&gt;&lt;a href=&quot;#1-__u8C03_u8BD5_u73AF_u5883_u4E0E_u751F_u4EA7_u73AF_u5883&quot; class=&quot;headerlink&quot; title=&quot;1. 调试环境与生产环境&quot;&gt;&lt;/a&gt;1. 调试环境与生产环境&lt;/h2&gt;&lt;p&gt;我们改成静态库后, 调试 cocos 引擎的代码会多有不便, 而且一旦修改了 cocos 的代码, 就得重新生成静态库, 对于开发阶段太不友好了.&lt;/p&gt;
&lt;p&gt;我们的解决方案, 就是再建立一个 debug 工程, 这个工程依旧使用依赖项目的方式编译 cocos , 调试流程和以前一致. 上线打包时则使用我们的静态库版本, 多渠道也做在这个工程中, 享受静态库带来的编译加速.&lt;/p&gt;
&lt;p&gt;最终我们的目录结构是这个样子的:&lt;/p&gt;
&lt;figure class=&quot;highlight sh&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;1&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;2&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;3&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;4&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;5&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;6&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;7&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;8&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;9&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;10&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;11&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;12&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;.&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;├── runtime-src&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;│   ├── Classes&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;│   ├── proj.android&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;│   ├── proj.android_no_anysdk&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;│   ├── proj.android_studio&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;│   ├── proj.ios_mac&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;│   ├── proj.win32&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;│   └── proj.wp8-xaml&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;└── runtime-src-debug&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    ├── Classes&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    └── proj.ios_mac&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;
&lt;h2 id=&quot;2-__u751F_u4EA7_u73AF_u5883_u5DE5_u7A0B_u7626_u8EAB&quot;&gt;&lt;a href=&quot;#2-__u751F_u4EA7_u73AF_u5883_u5DE5_u7A0B_u7626_u8EAB&quot; class=&quot;headerlink&quot; title=&quot;2. 生产环境工程瘦身&quot;&gt;&lt;/a&gt;2. 生产环境工程瘦身&lt;/h2&gt;&lt;p&gt;这一步可有可无, 我的代码洁癖又犯了, 所以顺手改了一下. &lt;/p&gt;
&lt;p&gt;这时的生产环境除静态库外的内容和调试环境几乎一致, 然而有一些东西是我们用不到的:&lt;/p&gt;
&lt;ol&gt;
&lt;li&gt;mac 平台对应的内容&lt;/li&gt;
&lt;li&gt;Classes/runtime 下的内容&lt;/li&gt;
&lt;/ol&gt;
&lt;p&gt;删除这些时改动了 AppDelegate 中的东西, 这也上一步为什么从 &lt;code&gt;runtimes-src&lt;/code&gt; 目录复制了一份.&lt;/p&gt;
&lt;h2 id=&quot;3-__u8FDB_u4E00_u6B65_u52A0_u901F_u7F16_u8BD1&quot;&gt;&lt;a href=&quot;#3-__u8FDB_u4E00_u6B65_u52A0_u901F_u7F16_u8BD1&quot; class=&quot;headerlink&quot; title=&quot;3. 进一步加速编译&quot;&gt;&lt;/a&gt;3. 进一步加速编译&lt;/h2&gt;&lt;p&gt;这一步我们目前还没有做, 只是一个想法.&lt;/p&gt;
&lt;p&gt;修改完使用静态库后, 编译速度得到了很大的提升, 但还没有达到极致, 因为 quick 特有的 c++ 文件还是以文件形式存在于工程中的. 所有 Archive 的时候还是有一百多个源文件需要编译.&lt;/p&gt;
&lt;p&gt;如果我们能进一步拆分, 新建一个 lib 工程, 将 quick 的源文件添加和依赖项目添加进去, 我们的游戏只依赖这样的一个静态库, 是否可以达到一个极致的编译速度 ?&lt;/p&gt;
&lt;h2 id=&quot;4-__u9759_u6001_u5E93_u6587_u4EF6_u7684_u7248_u672C_u7BA1_u7406&quot;&gt;&lt;a href=&quot;#4-__u9759_u6001_u5E93_u6587_u4EF6_u7684_u7248_u672C_u7BA1_u7406&quot; class=&quot;headerlink&quot; title=&quot;4. 静态库文件的版本管理&quot;&gt;&lt;/a&gt;4. 静态库文件的版本管理&lt;/h2&gt;&lt;p&gt;在编译出 debug 版的静态库之前, 我还有想法将这几个静态库压缩上传到 git 上, 编译出 debug 版之后, 我就一个想法, ignore them !&lt;/p&gt;
&lt;p&gt;所以我最终的策略 将这几个 .a 在 git 上忽略掉, 同时在那个目录保留了一个编译脚本, 谁要用到 iOS 项目的时候, 发现没有 .a , 自己运行脚本编译一份就可以啦 !&lt;/p&gt;
&lt;h2 id=&quot;5-__u7F16_u8BD1_u811A_u672C_u4F18_u5316__3F&quot;&gt;&lt;a href=&quot;#5-__u7F16_u8BD1_u811A_u672C_u4F18_u5316__3F&quot; class=&quot;headerlink&quot; title=&quot;5. 编译脚本优化 ?&quot;&gt;&lt;/a&gt;5. 编译脚本优化 ?&lt;/h2&gt;&lt;p&gt;现在那个编译脚本会编译出一个 &lt;code&gt;fat&lt;/code&gt;(armv7 armv7s arm64 i386 x86_64) 版的静态库, 内部实现其实是编译了好多次, 导致现在编译时间非常长.&lt;/p&gt;
&lt;p&gt;思考:&lt;/p&gt;
&lt;ol&gt;
&lt;li&gt;是否有必要编出 &lt;code&gt;i386 x86_64&lt;/code&gt; 版本 ?&lt;/li&gt;
&lt;li&gt;看到虾神的一篇文章貌似说可以以 armv7+arm64, i386+x86_64 组合两次打出所有版本.&lt;/li&gt;
&lt;/ol&gt;
&lt;h2 id=&quot;6-__u6700_u7EC8_Archive__u51FA_u7684_u5305_u4F1A_u6BD4_u4F7F_u7528_u6E90_u6587_u4EF6_u5927__3F&quot;&gt;&lt;a href=&quot;#6-__u6700_u7EC8_Archive__u51FA_u7684_u5305_u4F1A_u6BD4_u4F7F_u7528_u6E90_u6587_u4EF6_u5927__3F&quot; class=&quot;headerlink&quot; title=&quot;6. 最终 Archive 出的包会比使用源文件大 ?&quot;&gt;&lt;/a&gt;6. 最终 Archive 出的包会比使用源文件大 ?&lt;/h2&gt;&lt;p&gt;看到网上有过这个说法, 我没有在修改前后分别 Archive 对比包体, 不太严谨. &lt;/p&gt;
&lt;p&gt;但和我之前某一次的包相比, 只大了几百KB, 还不太确定是不是与使用静态库有关系, 大家在修改时可以注意对比一下.&lt;/p&gt;
</content>
    
    <summary type="html">
    
      亲爱的, 打完这个包就回家
    
    </summary>
    
    
      <category term="Quick-Cocos2d-x" scheme="http://blog.justbilt.com/tags/Quick-Cocos2d-x/"/>
    
      <category term="iOS" scheme="http://blog.justbilt.com/tags/iOS/"/>
    
  </entry>
  
  <entry>
    <title>cocos2d-x 优化游戏资源体积</title>
    <link href="http://blog.justbilt.com/2016/05/08/compress-res/"/>
    <id>http://blog.justbilt.com/2016/05/08/compress-res/</id>
    <published>2016-05-08T11:57:07.000Z</published>
    <updated>2017-03-12T01:22:38.000Z</updated>
    
    <content type="html">&lt;h1 id=&quot;u4E00-__u5220_u9664_u65E0_u7528_u8D44_u6E90&quot;&gt;&lt;a href=&quot;#u4E00-__u5220_u9664_u65E0_u7528_u8D44_u6E90&quot; class=&quot;headerlink&quot; title=&quot;一. 删除无用资源&quot;&gt;&lt;/a&gt;一. 删除无用资源&lt;/h1&gt;&lt;p&gt;在我们版本迭代的过程中, 总有一些图片被废弃掉, 如果当时忘记删除的话, 久而久之也就忘记了. 如果在上线前不做一次整理的话, 它们就会残存在你的资源中, 浪费包的体积.&lt;/p&gt;
&lt;p&gt;为避免这种情况, 我们可以做的是:&lt;/p&gt;
&lt;h2 id=&quot;1-__u5E9F_u5F03_u7684_u56FE_u7247_u4E00_u5B9A_u8981_u53CA_u65F6_u5220_u9664&quot;&gt;&lt;a href=&quot;#1-__u5E9F_u5F03_u7684_u56FE_u7247_u4E00_u5B9A_u8981_u53CA_u65F6_u5220_u9664&quot; class=&quot;headerlink&quot; title=&quot;1. 废弃的图片一定要及时删除&quot;&gt;&lt;/a&gt;1. 废弃的图片一定要及时删除&lt;/h2&gt;&lt;h2 id=&quot;2-__u7F16_u5199_u5E9F_u5F03_u8D44_u6E90_u67E5_u627E_u5DE5_u5177&quot;&gt;&lt;a href=&quot;#2-__u7F16_u5199_u5E9F_u5F03_u8D44_u6E90_u67E5_u627E_u5DE5_u5177&quot; class=&quot;headerlink&quot; title=&quot;2. 编写废弃资源查找工具&quot;&gt;&lt;/a&gt;2. 编写废弃资源查找工具&lt;/h2&gt;&lt;p&gt;可以用到的系统命令是 &lt;code&gt;ack&lt;/code&gt;, 我们可以通过 &lt;code&gt;brew install ack&lt;/code&gt; 安装, 使用的效果:&lt;/p&gt;
&lt;p&gt;&lt;img src=&quot;http://ww2.sinaimg.cn/large/7f870d23gw1f3upxy29uej20iy083gna.jpg&quot; alt=&quot;&quot;&gt;&lt;/p&gt;
&lt;p&gt;关于 ack 的更多用法请&lt;a href=&quot;http://beyondgrep.com/documentation/&quot; target=&quot;_blank&quot; rel=&quot;external&quot;&gt;移步这里&lt;/a&gt;.&lt;/p&gt;
&lt;h1 id=&quot;u4E8C-__u4F7F_u7528_u66FF_u4EE3_u5BF9_u8C61&quot;&gt;&lt;a href=&quot;#u4E8C-__u4F7F_u7528_u66FF_u4EE3_u5BF9_u8C61&quot; class=&quot;headerlink&quot; title=&quot;二. 使用替代对象&quot;&gt;&lt;/a&gt;二. 使用替代对象&lt;/h1&gt;&lt;h2 id=&quot;1-__u4F7F_u75289_u56FE&quot;&gt;&lt;a href=&quot;#1-__u4F7F_u75289_u56FE&quot; class=&quot;headerlink&quot; title=&quot;1. 使用9图&quot;&gt;&lt;/a&gt;1. 使用9图&lt;/h2&gt;&lt;p&gt;大家都知道图片在拉伸的过程中会失真, 那么如何避免这个情况呢? 使用9图. &lt;/p&gt;
&lt;p&gt;&lt;img src=&quot;http://ww2.sinaimg.cn/large/7f870d23gw1f3uqafyaevj206t04mjrj.jpg&quot; alt=&quot;&quot;&gt;&lt;/p&gt;
&lt;p&gt;注: 配图来自&lt;a href=&quot;http://mux.baidu.com/?p=1506&quot; target=&quot;_blank&quot; rel=&quot;external&quot;&gt;http://mux.baidu.com/?p=1506&lt;/a&gt;&lt;/p&gt;
&lt;p&gt;这样我们就可以将一张很大的图缩小到很小, 然后使用9图拉伸, 起到节省资源的目的. 9图在 cocos 中的对象是 &lt;code&gt;Scale9Sprite&lt;/code&gt;, 具体用法可以参考&lt;a href=&quot;http://shahdza.blog.51cto.com/2410787/1543284&quot; target=&quot;_blank&quot; rel=&quot;external&quot;&gt;这篇文章&lt;/a&gt;.&lt;/p&gt;
&lt;h2 id=&quot;2-__u901A_u8FC7_u4FEE_u6539_u8272_u8C03_u5B9E_u73B0_u8D44_u6E90_u590D_u7528&quot;&gt;&lt;a href=&quot;#2-__u901A_u8FC7_u4FEE_u6539_u8272_u8C03_u5B9E_u73B0_u8D44_u6E90_u590D_u7528&quot; class=&quot;headerlink&quot; title=&quot;2. 通过修改色调实现资源复用&quot;&gt;&lt;/a&gt;2. 通过修改色调实现资源复用&lt;/h2&gt;&lt;p&gt;知乎上有一篇问题讲的就是这个:&lt;br&gt;&lt;a href=&quot;https://www.zhihu.com/question/31133351&quot; target=&quot;_blank&quot; rel=&quot;external&quot;&gt;拳皇中的人物变色是如何实现的？&lt;/a&gt;&lt;br&gt;&lt;a href=&quot;http://daily.zhihu.com/story/4797855&quot; target=&quot;_blank&quot; rel=&quot;external&quot;&gt;知乎日报上的这篇&lt;/a&gt;&lt;/p&gt;
&lt;p&gt;&lt;img src=&quot;http://ww4.sinaimg.cn/large/7f870d23gw1f3uqjn3tz0j20ig08at9r.jpg&quot; alt=&quot;&quot;&gt;&lt;/p&gt;
&lt;p&gt;cocos2d-x 版由 &lt;a href=&quot;https://fusijie.github.io/2015/05/27/sprite-with-hue/&quot; target=&quot;_blank&quot; rel=&quot;external&quot;&gt;@偶尔e网事&lt;/a&gt; 大神实现, 对应的对象是 &lt;code&gt;SpriteWithHue&lt;/code&gt;, 目前已经默认集成到了 cocos2d-x 中.&lt;/p&gt;
&lt;p&gt;这样我们就可以将原来只是色调差异的图片用程序来实现啦~&lt;/p&gt;
&lt;h2 id=&quot;3-__u4F7F_u7528_u5E73_u94FA&quot;&gt;&lt;a href=&quot;#3-__u4F7F_u7528_u5E73_u94FA&quot; class=&quot;headerlink&quot; title=&quot;3. 使用平铺&quot;&gt;&lt;/a&gt;3. 使用平铺&lt;/h2&gt;&lt;p&gt;&lt;img src=&quot;http://ww4.sinaimg.cn/large/7f870d23gw1f3ur1pd7j5j20m8069tbd.jpg&quot; alt=&quot;&quot;&gt;&lt;/p&gt;
&lt;p&gt;注: 配图来自&lt;a href=&quot;http://bullteacher.com/7-textures.html&quot; target=&quot;_blank&quot; rel=&quot;external&quot;&gt;http://bullteacher.com/7-textures.html&lt;/a&gt;&lt;/p&gt;
&lt;p&gt;游戏中的有些图片完全可以通过平铺实现, 这样的话我们就可以让美术只出一个平铺单元的图片,在程序中去实现平铺.&lt;/p&gt;
&lt;p&gt;首先, 平铺的这个功能是 opengl 层面就支持的, 详情大家可以&lt;a href=&quot;http://bullteacher.com/7-textures.html&quot; target=&quot;_blank&quot; rel=&quot;external&quot;&gt;移步这里&lt;/a&gt;, cocos2d-x 中实现平铺很简单:&lt;/p&gt;
&lt;figure class=&quot;highlight lua&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;1&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;2&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;3&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;4&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;5&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;6&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;comment&quot;&gt;-- 首先, 使用平铺单元图片创建一个精灵&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;keyword&quot;&gt;local&lt;/span&gt; sprite = cc.Sprite:create(&lt;span class=&quot;string&quot;&gt;&quot;your_repeat_image.png&quot;&lt;/span&gt;)&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;comment&quot;&gt;-- 然后, 设置纹理参数&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;sprite:getTexture():setTexParameters(gl.LINEAR, gl.LINEAR, gl.REPEAT, gl.REPEAT)&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;comment&quot;&gt;-- 最后, 将这个精灵的纹理矩形设置为我们想要的大小&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;sprite:setTextureRect(cc.rect(&lt;span class=&quot;number&quot;&gt;0&lt;/span&gt;,&lt;span class=&quot;number&quot;&gt;0&lt;/span&gt;,&lt;span class=&quot;number&quot;&gt;1024&lt;/span&gt;,&lt;span class=&quot;number&quot;&gt;1024&lt;/span&gt;))&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;
&lt;blockquote&gt;
&lt;p&gt;注意:　平铺单元图片的尺寸只能是2的幂&lt;/p&gt;
&lt;/blockquote&gt;
&lt;h1 id=&quot;u4E09-__u538B_u7F29&quot;&gt;&lt;a href=&quot;#u4E09-__u538B_u7F29&quot; class=&quot;headerlink&quot; title=&quot;三. 压缩&quot;&gt;&lt;/a&gt;三. 压缩&lt;/h1&gt;&lt;h2 id=&quot;1-__u65E0_u635F_u538B_u7F29&quot;&gt;&lt;a href=&quot;#1-__u65E0_u635F_u538B_u7F29&quot; class=&quot;headerlink&quot; title=&quot;1. 无损压缩&quot;&gt;&lt;/a&gt;1. 无损压缩&lt;/h2&gt;&lt;p&gt;无损压缩还是十分值得推荐的, 它的原理知乎上&lt;a href=&quot;https://www.zhihu.com/question/23752454&quot; target=&quot;_blank&quot; rel=&quot;external&quot;&gt;这个答案&lt;/a&gt;讲的很清晰, 我节选其中的关键文字:&lt;/p&gt;
&lt;blockquote&gt;
&lt;p&gt;1.核心原理很简单，通俗的解释一下，就是由于PNG格式的灵活性，他可以有很多种方式表示同一张图片，不同方式有时就会导致文件大小不一样…&lt;br&gt;2.还有一点是PNG采用的是deflate算法，也非常的灵活，他的压缩率和encoder的实现有关，不同的encoder使用的时间，压缩出来的大小都不一样…&lt;br&gt;3.当然除了上面这两点是真正的无损压缩以外，还有减小PNG文件大小的方式就是去除一些对图片本身没有任何影响的metadata…&lt;/p&gt;
&lt;/blockquote&gt;
&lt;p&gt;所以无损压缩纯粹是单方面的受益, &lt;strong&gt;是一定要做的&lt;/strong&gt;.&lt;/p&gt;
&lt;p&gt;我们无损压缩主要用到的工具: &lt;a href=&quot;https://imageoptim.com/mac&quot; target=&quot;_blank&quot; rel=&quot;external&quot;&gt;ImageOptim&lt;/a&gt;&lt;/p&gt;
&lt;h2 id=&quot;2-__u6709_u635F_u538B_u7F29&quot;&gt;&lt;a href=&quot;#2-__u6709_u635F_u538B_u7F29&quot; class=&quot;headerlink&quot; title=&quot;2. 有损压缩&quot;&gt;&lt;/a&gt;2. 有损压缩&lt;/h2&gt;&lt;p&gt;&lt;img src=&quot;http://ww1.sinaimg.cn/large/7f870d23gw1f3uvav83k9j20g707fabp.jpg&quot; alt=&quot;&quot;&gt;&lt;/p&gt;
&lt;p&gt;有损压缩会损失一部分的图片质量, 但带来的受益还是十分可观的. 这是一个抉择的过程, 以最小的代价获取最大的受益, 甚至不能批量处理, 可能需要一张一张的人肉对比压缩.&lt;/p&gt;
&lt;p&gt;我们有损压缩主要用到的工具: &lt;a href=&quot;http://ppduck.com/&quot; target=&quot;_blank&quot; rel=&quot;external&quot;&gt;PP鸭&lt;/a&gt;&lt;/p&gt;
&lt;h1 id=&quot;u56DB-__u9009_u62E9_u6B63_u786E_u7684_u56FE_u7247_u683C_u5F0F&quot;&gt;&lt;a href=&quot;#u56DB-__u9009_u62E9_u6B63_u786E_u7684_u56FE_u7247_u683C_u5F0F&quot; class=&quot;headerlink&quot; title=&quot;四. 选择正确的图片格式&quot;&gt;&lt;/a&gt;四. 选择正确的图片格式&lt;/h1&gt;&lt;h2 id=&quot;1-__u5C06_u65E0_alpha__u901A_u9053_u7684_png__u56FE_u7247_u5B58_u50A8_u4E3A_jpg&quot;&gt;&lt;a href=&quot;#1-__u5C06_u65E0_alpha__u901A_u9053_u7684_png__u56FE_u7247_u5B58_u50A8_u4E3A_jpg&quot; class=&quot;headerlink&quot; title=&quot;1. 将无 alpha 通道的 png 图片存储为 jpg&quot;&gt;&lt;/a&gt;1. 将无 alpha 通道的 png 图片存储为 jpg&lt;/h2&gt;&lt;h2 id=&quot;2-__u9009_u7528_u538B_u7F29_u7387_u66F4_u9AD8_u7684_u56FE_u7247_u683C_u5F0F&quot;&gt;&lt;a href=&quot;#2-__u9009_u7528_u538B_u7F29_u7387_u66F4_u9AD8_u7684_u56FE_u7247_u683C_u5F0F&quot; class=&quot;headerlink&quot; title=&quot;2. 选用压缩率更高的图片格式&quot;&gt;&lt;/a&gt;2. 选用压缩率更高的图片格式&lt;/h2&gt;&lt;h1 id=&quot;u4E94-__u5176_u4ED6&quot;&gt;&lt;a href=&quot;#u4E94-__u5176_u4ED6&quot; class=&quot;headerlink&quot; title=&quot;五. 其他&quot;&gt;&lt;/a&gt;五. 其他&lt;/h1&gt;&lt;h2 id=&quot;1-__u5706_u5F62_u56FE_u7247_u53EA_u4F7F_u7528_1/4&quot;&gt;&lt;a href=&quot;#1-__u5706_u5F62_u56FE_u7247_u53EA_u4F7F_u7528_1/4&quot; class=&quot;headerlink&quot; title=&quot;1. 圆形图片只使用 1/4&quot;&gt;&lt;/a&gt;1. 圆形图片只使用 1/4&lt;/h2&gt;&lt;p&gt;然后在程序中翻转3次,得到其他角度的图片. 一般会用在图片尺寸特别大的场景. &lt;/p&gt;
&lt;p&gt;&lt;img src=&quot;http://ww4.sinaimg.cn/large/7f870d23gw1f3uvnfb31aj20hd09v74p.jpg&quot; alt=&quot;&quot;&gt;&lt;/p&gt;
&lt;p&gt;如上图, 我们游戏中一个全屏幕的雷达就是通过这个方案减少图片体积的.&lt;/p&gt;
&lt;h2 id=&quot;2-__u7F29_u5C0F_u56FE_u7247&quot;&gt;&lt;a href=&quot;#2-__u7F29_u5C0F_u56FE_u7247&quot; class=&quot;headerlink&quot; title=&quot;2. 缩小图片&quot;&gt;&lt;/a&gt;2. 缩小图片&lt;/h2&gt;&lt;p&gt;将展示精度不强的图片(比如: 游戏背景上的小装饰, 爆炸的序列帧)缩小, 在程序中放大. &lt;/p&gt;
&lt;h2 id=&quot;3-__u7279_u6B8A_u65B9_u6848_u5206_u79BBpng_u7684_u900F_u660E_u901A_u9053&quot;&gt;&lt;a href=&quot;#3-__u7279_u6B8A_u65B9_u6848_u5206_u79BBpng_u7684_u900F_u660E_u901A_u9053&quot; class=&quot;headerlink&quot; title=&quot;3. 特殊方案分离png的透明通道&quot;&gt;&lt;/a&gt;3. 特殊方案分离png的透明通道&lt;/h2&gt;&lt;p&gt;&lt;a href=&quot;http://www.cocoachina.com/bbs/read.php?tid-201144.html&quot; target=&quot;_blank&quot; rel=&quot;external&quot;&gt;用jpg和黑白色png作为遮罩实现透明&lt;/a&gt;&lt;br&gt;&lt;a href=&quot;http://blog.csdn.net/dawn_moon/article/details/8631783&quot; target=&quot;_blank&quot; rel=&quot;external&quot;&gt;用shader使图片背景透明&lt;/a&gt;&lt;br&gt;&lt;a href=&quot;http://www.cnblogs.com/elang/p/4104452.html&quot; target=&quot;_blank&quot; rel=&quot;external&quot;&gt;cocos2dx中使用JPG图和只带Alpha的PNG图合成渲染&lt;/a&gt;&lt;/p&gt;
&lt;p&gt;我们之前曾经采取过其中的一个方案, 将一张 png 图片拆分为 jpg+alpha.png 的形式, 整体的包体小了近 25% , 不过也带来的其他的一些副作用.&lt;/p&gt;
&lt;p&gt;建议大家使用这类黑科技前一定要做好调研和测试用例, 评估一下实际的收益.&lt;/p&gt;
</content>
    
    <summary type="html">
    
      优化资源体积是一个旷日持久的战役, 那我们从哪里入手呢? 
    
    </summary>
    
    
      <category term="优化" scheme="http://blog.justbilt.com/tags/%E4%BC%98%E5%8C%96/"/>
    
      <category term="游戏心得" scheme="http://blog.justbilt.com/tags/%E6%B8%B8%E6%88%8F%E5%BF%83%E5%BE%97/"/>
    
  </entry>
  
  <entry>
    <title>quick-x EditBox 几个小技巧</title>
    <link href="http://blog.justbilt.com/2016/05/01/quickx-editbox-util/"/>
    <id>http://blog.justbilt.com/2016/05/01/quickx-editbox-util/</id>
    <published>2016-05-01T00:56:03.000Z</published>
    <updated>2017-03-12T02:22:53.000Z</updated>
    
    <content type="html">&lt;p&gt;我们项目中的输入框使用的都是 EditBox , 但是 EditBox 还存在一些问题, 这里给大家分享一下我们的解决方案.&lt;/p&gt;
&lt;h1 id=&quot;u4E00-__u5B57_u4F53_u8FC7_u5927&quot;&gt;&lt;a href=&quot;#u4E00-__u5B57_u4F53_u8FC7_u5927&quot; class=&quot;headerlink&quot; title=&quot;一. 字体过大&quot;&gt;&lt;/a&gt;一. 字体过大&lt;/h1&gt;&lt;p&gt;用过 EditBox 的同学都知道这样一个情况, EditBox 在创建时是无法传入字体大小的, 字体大小默认和 EditBox 的 size 一致. 如果要修改字体大小的话, 就必须有程序的参与, 十分讨厌.&lt;/p&gt;
&lt;p&gt;而我们聪明的设计师 @大勇同学 则想到了一个非常棒的办法, 使用一张透明的9图来创建 EditBox, 后面再放置一个真实效果的 Scale9Sprite , 这样就可以实现字体比边框小很多的输入框了.&lt;/p&gt;
&lt;h1 id=&quot;u4E8C-__u591A_u884C_u8F93_u5165&quot;&gt;&lt;a href=&quot;#u4E8C-__u591A_u884C_u8F93_u5165&quot; class=&quot;headerlink&quot; title=&quot;二. 多行输入&quot;&gt;&lt;/a&gt;二. 多行输入&lt;/h1&gt;&lt;p&gt;多行输入是一个很有必要的事情, 我们在写邮件, 军团公告等界面都有类似的需求, 然而 EditBox 并不能很好的支持多行输入, 不同平台间也存在差异, 一直很头疼这件事情. &lt;/p&gt;
&lt;p&gt;然而团队中另外一位成员 @小齐同学 却用另一种十分脑洞的方案解决了这个问题, 着实让人佩服. 他的思路是这样子的:&lt;/p&gt;
&lt;blockquote&gt;
&lt;p&gt;创建一个和需求大小一致的 EditBox, 同时创建一个 LalbelTTF , 将 dimensions 属性设置为需求大小. 处理 EditBox 使之看不见, 但又能正常输入, 同时监听输入文字变化事件, 在事件中修改 LalbelTTF 的文字.&lt;/p&gt;
&lt;/blockquote&gt;
&lt;p&gt;核心就是让 EditBox 承担只文字输入的功能, 而让另外一个 LalbelTTF 来承担文字显示的功能. 实现的代码如下:&lt;/p&gt;
&lt;figure class=&quot;highlight lua&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;1&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;2&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;3&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;4&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;5&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;6&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;7&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;8&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;9&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;10&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;11&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;12&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;13&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;14&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;15&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;16&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;17&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;18&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;19&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;20&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;21&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;22&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;23&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;24&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;25&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;26&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;function&quot;&gt;&lt;span class=&quot;keyword&quot;&gt;function&lt;/span&gt; &lt;span class=&quot;title&quot;&gt;EditBoxUtil.multiline&lt;/span&gt;&lt;span class=&quot;params&quot;&gt;(_editbox, _label, _params)&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    _params = _params &lt;span class=&quot;keyword&quot;&gt;or&lt;/span&gt; &amp;#123;&amp;#125;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    &lt;span class=&quot;comment&quot;&gt;-- 本来这个应该只是Android上的设置, 但是为了避免平台的差异性, 因此统一处理&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    _editbox:setCascadeOpacityEnabled(&lt;span class=&quot;keyword&quot;&gt;true&lt;/span&gt;)&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    _editbox:setOpacity(&lt;span class=&quot;number&quot;&gt;0&lt;/span&gt;)&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    &lt;span class=&quot;keyword&quot;&gt;if&lt;/span&gt; device.platform == &lt;span class=&quot;string&quot;&gt;&quot;android&quot;&lt;/span&gt; &lt;span class=&quot;keyword&quot;&gt;then&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;        &lt;span class=&quot;comment&quot;&gt;-- 避免文字过大导致Android系统崩溃&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;        _editbox:setFont(&lt;span class=&quot;string&quot;&gt;&quot;Helvetica&quot;&lt;/span&gt;,&lt;span class=&quot;number&quot;&gt;2&lt;/span&gt;)&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    &lt;span class=&quot;keyword&quot;&gt;elseif&lt;/span&gt; device.platform == &lt;span class=&quot;string&quot;&gt;&quot;ios&quot;&lt;/span&gt; &lt;span class=&quot;keyword&quot;&gt;or&lt;/span&gt; device.platform == &lt;span class=&quot;string&quot;&gt;&quot;mac&quot;&lt;/span&gt; &lt;span class=&quot;keyword&quot;&gt;then&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;        _editbox:setFont(&lt;span class=&quot;string&quot;&gt;&quot;Helvetica&quot;&lt;/span&gt;,&lt;span class=&quot;number&quot;&gt;0&lt;/span&gt;)&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    &lt;span class=&quot;keyword&quot;&gt;end&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    _editbox:registerScriptEditBoxHandler(&lt;span class=&quot;function&quot;&gt;&lt;span class=&quot;keyword&quot;&gt;function&lt;/span&gt;&lt;span class=&quot;params&quot;&gt;(event)&lt;/span&gt;&lt;/span&gt;  &lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;        &lt;span class=&quot;keyword&quot;&gt;if&lt;/span&gt; event == &lt;span class=&quot;string&quot;&gt;&quot;began&quot;&lt;/span&gt; &lt;span class=&quot;keyword&quot;&gt;then&lt;/span&gt;  &lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;            _editbox:setText(_label:getString())&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;        &lt;span class=&quot;keyword&quot;&gt;elseif&lt;/span&gt; event == &lt;span class=&quot;string&quot;&gt;&quot;changed&quot;&lt;/span&gt; &lt;span class=&quot;keyword&quot;&gt;then&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;            _label:setString(_editbox:getText())&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;        &lt;span class=&quot;keyword&quot;&gt;elseif&lt;/span&gt; event == &lt;span class=&quot;string&quot;&gt;&quot;return&quot;&lt;/span&gt; &lt;span class=&quot;keyword&quot;&gt;then&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;            _label:setString(_editbox:getText())&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;        &lt;span class=&quot;keyword&quot;&gt;end&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;        &lt;span class=&quot;keyword&quot;&gt;if&lt;/span&gt; _params.listener &lt;span class=&quot;keyword&quot;&gt;then&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;            _params.listener(event, _editbox)&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;        &lt;span class=&quot;keyword&quot;&gt;end&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    &lt;span class=&quot;keyword&quot;&gt;end&lt;/span&gt;)&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;keyword&quot;&gt;end&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;
&lt;p&gt;这段代码和简单, 但背后所遇到的坑却不少, 且听我来道一道:&lt;/p&gt;
&lt;h2 id=&quot;1-__u4E3A_u4EC0_u4E48_u8981_u8C03_u7528_setFont&quot;&gt;&lt;a href=&quot;#1-__u4E3A_u4EC0_u4E48_u8981_u8C03_u7528_setFont&quot; class=&quot;headerlink&quot; title=&quot;1. 为什么要调用 setFont&quot;&gt;&lt;/a&gt;1. 为什么要调用 setFont&lt;/h2&gt;&lt;p&gt;如果只是想设置字体大小, EditBox 明明有提供 &lt;code&gt;setFontSize&lt;/code&gt; 接口, 为什么要调用 &lt;code&gt;setFont&lt;/code&gt; ? 请看 setFontSize 实现:&lt;/p&gt;
&lt;figure class=&quot;highlight cpp&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;1&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;2&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;3&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;4&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;5&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;6&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;7&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;8&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;keyword&quot;&gt;void&lt;/span&gt; EditBox::setFontSize(&lt;span class=&quot;keyword&quot;&gt;int&lt;/span&gt; fontSize)&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    _fontSize = fontSize;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    &lt;span class=&quot;keyword&quot;&gt;if&lt;/span&gt; (_editBoxImpl != &lt;span class=&quot;literal&quot;&gt;nullptr&lt;/span&gt; &amp;amp;&amp;amp; _fontName.length() &amp;gt; &lt;span class=&quot;number&quot;&gt;0&lt;/span&gt;)&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    &amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;        _editBoxImpl-&amp;gt;setFont(_fontName.c_str(), _fontSize);&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    &amp;#125;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&amp;#125;&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;
&lt;p&gt;可以看到 setFontSize 在没有设置字体名称 &lt;code&gt;_fontName&lt;/code&gt; 时是没有作用的.&lt;/p&gt;
&lt;h2 id=&quot;2-__u4E3A_u4EC0_u4E48_u8981_u5206_u5E73_u53F0_u6765_u5B9E_u73B0&quot;&gt;&lt;a href=&quot;#2-__u4E3A_u4EC0_u4E48_u8981_u5206_u5E73_u53F0_u6765_u5B9E_u73B0&quot; class=&quot;headerlink&quot; title=&quot;2. 为什么要分平台来实现&quot;&gt;&lt;/a&gt;2. 为什么要分平台来实现&lt;/h2&gt;&lt;p&gt;在接入 android 前,我们是没有分平台实现的, 只是 &lt;code&gt;setFont(&amp;quot;Helvetica&amp;quot;,0)&lt;/code&gt; , 在 iOS 上没有任何问题, 但是在 Android 上会 catch 到 &lt;code&gt;divide by zero&lt;/code&gt; 崩溃, 估计是某一个地方用 fontsize 做被除数了吧 , 于是 Android 上改为设置透明度.&lt;/p&gt;
&lt;h2 id=&quot;3-_Android__u8F93_u5165_u8FC7_u591A_u6587_u5B57_u540E_u4F1A_u5D29_u6E83_28OOM_29&quot;&gt;&lt;a href=&quot;#3-_Android__u8F93_u5165_u8FC7_u591A_u6587_u5B57_u540E_u4F1A_u5D29_u6E83_28OOM_29&quot; class=&quot;headerlink&quot; title=&quot;3. Android 输入过多文字后会崩溃(OOM)&quot;&gt;&lt;/a&gt;3. Android 输入过多文字后会崩溃(OOM)&lt;/h2&gt;&lt;p&gt;崩溃在 &lt;code&gt;Cocos2dxBitmap.java&lt;/code&gt; 的 &lt;code&gt;getPixels&lt;/code&gt; 函数中:&lt;br&gt;&lt;figure class=&quot;highlight java&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;1&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;2&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;3&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;4&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;5&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;6&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;7&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;8&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;9&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;10&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;11&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;keyword&quot;&gt;private&lt;/span&gt; &lt;span class=&quot;keyword&quot;&gt;static&lt;/span&gt; &lt;span class=&quot;keyword&quot;&gt;byte&lt;/span&gt;[] getPixels(&lt;span class=&quot;keyword&quot;&gt;final&lt;/span&gt; Bitmap bitmap) &amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    &lt;span class=&quot;keyword&quot;&gt;if&lt;/span&gt; (bitmap != &lt;span class=&quot;keyword&quot;&gt;null&lt;/span&gt;) &amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;        &lt;span class=&quot;keyword&quot;&gt;final&lt;/span&gt; &lt;span class=&quot;keyword&quot;&gt;byte&lt;/span&gt;[] pixels = &lt;span class=&quot;keyword&quot;&gt;new&lt;/span&gt; &lt;span class=&quot;keyword&quot;&gt;byte&lt;/span&gt;[bitmap.getWidth() * bitmap.getHeight() * &lt;span class=&quot;number&quot;&gt;4&lt;/span&gt;];&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;        &lt;span class=&quot;keyword&quot;&gt;final&lt;/span&gt; ByteBuffer buf = ByteBuffer.wrap(pixels);&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;        buf.order(ByteOrder.nativeOrder());&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;        bitmap.copyPixelsToBuffer(buf);&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;        &lt;span class=&quot;keyword&quot;&gt;return&lt;/span&gt; pixels;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    &amp;#125;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    &lt;span class=&quot;keyword&quot;&gt;return&lt;/span&gt; &lt;span class=&quot;keyword&quot;&gt;null&lt;/span&gt;;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&amp;#125;&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;&lt;/p&gt;
&lt;p&gt;在 &lt;code&gt;new byte&lt;/code&gt; 这里触发了报错的原因是 &lt;code&gt;Out Of Memory&lt;/code&gt; 异常 ! 调试发现 &lt;code&gt;bitmap&lt;/code&gt; 的宽高惊人的达到了 &lt;code&gt;12000x600&lt;/code&gt; ! &lt;/p&gt;
&lt;p&gt;经过 @bin 的提醒, 发现这里可能是因为 EditBox 字体过大的原因, 因为 EditBox 会默认设置字体字体大小和 Scale9Sprite 的 PreferredSize 一直, 就可能设置字体大小为 100+ , 文字一多尺寸当然就上去了! 所以便有了这么一行:&lt;/p&gt;
&lt;figure class=&quot;highlight lua&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;1&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;2&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;3&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;keyword&quot;&gt;if&lt;/span&gt; device.platform == &lt;span class=&quot;string&quot;&gt;&quot;android&quot;&lt;/span&gt; &lt;span class=&quot;keyword&quot;&gt;then&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    &lt;span class=&quot;comment&quot;&gt;-- 避免文字过大导致Android系统崩溃&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    _editbox:setFont(&lt;span class=&quot;string&quot;&gt;&quot;Helvetica&quot;&lt;/span&gt;,&lt;span class=&quot;number&quot;&gt;2&lt;/span&gt;)&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;
&lt;h1 id=&quot;u4E8C-__u5C4F_u853D_Emoji__u8F93_u5165&quot;&gt;&lt;a href=&quot;#u4E8C-__u5C4F_u853D_Emoji__u8F93_u5165&quot; class=&quot;headerlink&quot; title=&quot;二. 屏蔽 Emoji 输入&quot;&gt;&lt;/a&gt;二. 屏蔽 Emoji 输入&lt;/h1&gt;&lt;p&gt;按照要求游戏中玩家可以输入文字的地方都是不能够输入 Emoji 表情的, 原因有两点:&lt;/p&gt;
&lt;ol&gt;
&lt;li&gt;不同系统间表现存在差异&lt;/li&gt;
&lt;li&gt;EditBox Android 版输入确认后会变乱码&lt;/li&gt;
&lt;li&gt;后台搜索玩家时不太方便&lt;/li&gt;
&lt;/ol&gt;
&lt;p&gt;因此, 我们需要屏蔽 Emoji 表情的输入, 我们有两种做法:&lt;/p&gt;
&lt;ol&gt;
&lt;li&gt;无法输入, 弹出键盘点击表情没有反应&lt;/li&gt;
&lt;li&gt;输入完成后, 游戏内点击提交时提示非法&lt;/li&gt;
&lt;/ol&gt;
&lt;p&gt;我们采用的是第二种方案, 这个无法通过纯 lua 代码实现, 需要分平台去做.&lt;/p&gt;
&lt;h2 id=&quot;1-_iOS&quot;&gt;&lt;a href=&quot;#1-_iOS&quot; class=&quot;headerlink&quot; title=&quot;1. iOS&quot;&gt;&lt;/a&gt;1. iOS&lt;/h2&gt;&lt;p&gt;修改 &lt;code&gt;UIEditBoxImpl-ios.mm&lt;/code&gt; 文件的 &lt;code&gt;shouldChangeCharactersInRange&lt;/code&gt; 函数:&lt;/p&gt;
&lt;figure class=&quot;highlight objc&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;1&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;2&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;3&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;4&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;5&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;6&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;7&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;8&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;9&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;10&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;11&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;12&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;13&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;14&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;15&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;16&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;17&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;18&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;19&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;20&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;21&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;22&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;23&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;24&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;25&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;26&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;27&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;28&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;29&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;30&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;31&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;32&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;33&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;34&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;35&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;36&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;37&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;38&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;39&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;40&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;41&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;42&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;43&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;- (&lt;span class=&quot;built_in&quot;&gt;BOOL&lt;/span&gt;)textField:(&lt;span class=&quot;built_in&quot;&gt;UITextField&lt;/span&gt; *) textField shouldChangeCharactersInRange:(&lt;span class=&quot;built_in&quot;&gt;NSRange&lt;/span&gt;)range replacementString:(&lt;span class=&quot;built_in&quot;&gt;NSString&lt;/span&gt; *)string&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    __block &lt;span class=&quot;built_in&quot;&gt;BOOL&lt;/span&gt; returnValue = &lt;span class=&quot;literal&quot;&gt;NO&lt;/span&gt;;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    [string enumerateSubstringsInRange:&lt;span class=&quot;built_in&quot;&gt;NSMakeRange&lt;/span&gt;(&lt;span class=&quot;number&quot;&gt;0&lt;/span&gt;, [string length]) options:&lt;span class=&quot;built_in&quot;&gt;NSStringEnumerationByComposedCharacterSequences&lt;/span&gt; usingBlock:&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;     ^(&lt;span class=&quot;built_in&quot;&gt;NSString&lt;/span&gt; *substring, &lt;span class=&quot;built_in&quot;&gt;NSRange&lt;/span&gt; substringRange, &lt;span class=&quot;built_in&quot;&gt;NSRange&lt;/span&gt; enclosingRange, &lt;span class=&quot;built_in&quot;&gt;BOOL&lt;/span&gt; *stop) &amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;         &lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;         &lt;span class=&quot;keyword&quot;&gt;if&lt;/span&gt; ([substring rangeOfCharacterFromSet: [&lt;span class=&quot;built_in&quot;&gt;NSCharacterSet&lt;/span&gt; characterSetWithRange:&lt;span class=&quot;built_in&quot;&gt;NSMakeRange&lt;/span&gt;(&lt;span class=&quot;number&quot;&gt;0xFE00&lt;/span&gt;, &lt;span class=&quot;number&quot;&gt;16&lt;/span&gt;)]]&lt;span class=&quot;variable&quot;&gt;.location&lt;/span&gt; != &lt;span class=&quot;built_in&quot;&gt;NSNotFound&lt;/span&gt;) &amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;             returnValue = &lt;span class=&quot;literal&quot;&gt;YES&lt;/span&gt;;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;         &amp;#125;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;         &lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;         &lt;span class=&quot;keyword&quot;&gt;const&lt;/span&gt; &lt;span class=&quot;keyword&quot;&gt;unichar&lt;/span&gt; high = [substring characterAtIndex: &lt;span class=&quot;number&quot;&gt;0&lt;/span&gt;];&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;         &lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;         &lt;span class=&quot;comment&quot;&gt;// Surrogate pair (U+1D000-1F9FF)&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;         &lt;span class=&quot;keyword&quot;&gt;if&lt;/span&gt; (&lt;span class=&quot;number&quot;&gt;0xD800&lt;/span&gt; &amp;lt;= high &amp;amp;&amp;amp; high &amp;lt;= &lt;span class=&quot;number&quot;&gt;0xDBFF&lt;/span&gt;) &amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;             &lt;span class=&quot;keyword&quot;&gt;const&lt;/span&gt; &lt;span class=&quot;keyword&quot;&gt;unichar&lt;/span&gt; low = [substring characterAtIndex: &lt;span class=&quot;number&quot;&gt;1&lt;/span&gt;];&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;             &lt;span class=&quot;keyword&quot;&gt;const&lt;/span&gt; &lt;span class=&quot;keyword&quot;&gt;int&lt;/span&gt; codepoint = ((high - &lt;span class=&quot;number&quot;&gt;0xD800&lt;/span&gt;) * &lt;span class=&quot;number&quot;&gt;0x400&lt;/span&gt;) + (low - &lt;span class=&quot;number&quot;&gt;0xDC00&lt;/span&gt;) + &lt;span class=&quot;number&quot;&gt;0x10000&lt;/span&gt;;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;             &lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;             returnValue = (&lt;span class=&quot;number&quot;&gt;0x1D000&lt;/span&gt; &amp;lt;= codepoint &amp;amp;&amp;amp; codepoint &amp;lt;= &lt;span class=&quot;number&quot;&gt;0x1F9FF&lt;/span&gt;);&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;             &lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;             &lt;span class=&quot;comment&quot;&gt;// Not surrogate pair (U+2100-27BF)&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;         &amp;#125; &lt;span class=&quot;keyword&quot;&gt;else&lt;/span&gt; &amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;             returnValue = (&lt;span class=&quot;number&quot;&gt;0x2100&lt;/span&gt; &amp;lt;= high &amp;amp;&amp;amp; high &amp;lt;= &lt;span class=&quot;number&quot;&gt;0x27BF&lt;/span&gt;);&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;         &amp;#125;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;     &amp;#125;];&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    &lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    &lt;span class=&quot;keyword&quot;&gt;if&lt;/span&gt; (returnValue) &amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;        &lt;span class=&quot;keyword&quot;&gt;return&lt;/span&gt; &lt;span class=&quot;literal&quot;&gt;NO&lt;/span&gt;;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    &amp;#125;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    &lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    &lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    &lt;span class=&quot;keyword&quot;&gt;if&lt;/span&gt; (getEditBoxImplIOS()-&amp;gt;getMaxLength() &amp;lt; &lt;span class=&quot;number&quot;&gt;0&lt;/span&gt;)&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    &amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;        &lt;span class=&quot;keyword&quot;&gt;return&lt;/span&gt; &lt;span class=&quot;literal&quot;&gt;YES&lt;/span&gt;;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    &amp;#125;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    &lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    &lt;span class=&quot;built_in&quot;&gt;NSUInteger&lt;/span&gt; oldLength = [textField&lt;span class=&quot;variable&quot;&gt;.text&lt;/span&gt; length];&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    &lt;span class=&quot;built_in&quot;&gt;NSUInteger&lt;/span&gt; replacementLength = [string length];&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    &lt;span class=&quot;built_in&quot;&gt;NSUInteger&lt;/span&gt; rangeLength = range&lt;span class=&quot;variable&quot;&gt;.length&lt;/span&gt;;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    &lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    &lt;span class=&quot;built_in&quot;&gt;NSUInteger&lt;/span&gt; newLength = oldLength - rangeLength + replacementLength;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    &lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    &lt;span class=&quot;keyword&quot;&gt;return&lt;/span&gt; newLength &amp;lt;= getEditBoxImplIOS()-&amp;gt;getMaxLength();&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&amp;#125;&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;
&lt;p&gt;这段代码是我从 &lt;a href=&quot;https://github.com/woxtu/NSString-RemoveEmoji&quot; target=&quot;_blank&quot; rel=&quot;external&quot;&gt;https://github.com/woxtu/NSString-RemoveEmoji&lt;/a&gt; 中提取出来的.&lt;/p&gt;
&lt;h2 id=&quot;2-_Android&quot;&gt;&lt;a href=&quot;#2-_Android&quot; class=&quot;headerlink&quot; title=&quot;2. Android&quot;&gt;&lt;/a&gt;2. Android&lt;/h2&gt;&lt;p&gt;Android 上的实现也很简单, 主要是需要创建一个新的 &lt;code&gt;InputFilter&lt;/code&gt; 用来过滤 Emoji 表情. 需要修改 &lt;code&gt;Cocos2dxEditBoxDialog.java&lt;/code&gt; 文件成员变量添加:&lt;/p&gt;
&lt;figure class=&quot;highlight java&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;1&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;2&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;3&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;4&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;5&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;6&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;7&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;8&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;9&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;10&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;11&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;12&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;13&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;keyword&quot;&gt;public&lt;/span&gt; &lt;span class=&quot;keyword&quot;&gt;static&lt;/span&gt; InputFilter EMOJI_FILTER = &lt;span class=&quot;keyword&quot;&gt;new&lt;/span&gt; InputFilter() &amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    &lt;span class=&quot;annotation&quot;&gt;@Override&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    &lt;span class=&quot;function&quot;&gt;&lt;span class=&quot;keyword&quot;&gt;public&lt;/span&gt; CharSequence &lt;span class=&quot;title&quot;&gt;filter&lt;/span&gt;&lt;span class=&quot;params&quot;&gt;(CharSequence source, &lt;span class=&quot;keyword&quot;&gt;int&lt;/span&gt; start, &lt;span class=&quot;keyword&quot;&gt;int&lt;/span&gt; end, Spanned dest, &lt;span class=&quot;keyword&quot;&gt;int&lt;/span&gt; dstart, &lt;span class=&quot;keyword&quot;&gt;int&lt;/span&gt; dend)&lt;/span&gt; &lt;/span&gt;&amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;        &lt;span class=&quot;keyword&quot;&gt;for&lt;/span&gt; (&lt;span class=&quot;keyword&quot;&gt;int&lt;/span&gt; index = start; index &amp;lt; end; index++) &amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;            &lt;span class=&quot;keyword&quot;&gt;int&lt;/span&gt; type = Character.getType(source.charAt(index));&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;            &lt;span class=&quot;keyword&quot;&gt;if&lt;/span&gt; (type == Character.SURROGATE || type == Character.OTHER_SYMBOL || type == Character.PRIVATE_USE) &amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;                &lt;span class=&quot;keyword&quot;&gt;return&lt;/span&gt; &lt;span class=&quot;string&quot;&gt;&quot;&quot;&lt;/span&gt;;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;            &amp;#125;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;        &amp;#125;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;        &lt;span class=&quot;keyword&quot;&gt;return&lt;/span&gt; &lt;span class=&quot;keyword&quot;&gt;null&lt;/span&gt;;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    &amp;#125;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&amp;#125;;&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;
&lt;p&gt;修改 &lt;code&gt;onCreate&lt;/code&gt; 函数 &lt;code&gt;setFilters&lt;/code&gt; 处逻辑:&lt;/p&gt;
&lt;figure class=&quot;highlight java&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;1&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;2&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;3&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;4&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;5&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;keyword&quot;&gt;if&lt;/span&gt; (&lt;span class=&quot;keyword&quot;&gt;this&lt;/span&gt;.mMaxLength &amp;gt; &lt;span class=&quot;number&quot;&gt;0&lt;/span&gt;) &amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    &lt;span class=&quot;keyword&quot;&gt;this&lt;/span&gt;.mInputEditText.setFilters(&lt;span class=&quot;keyword&quot;&gt;new&lt;/span&gt; InputFilter[] &amp;#123; &lt;span class=&quot;keyword&quot;&gt;new&lt;/span&gt; InputFilter.LengthFilter(&lt;span class=&quot;keyword&quot;&gt;this&lt;/span&gt;.mMaxLength), EMOJI_FILTER &amp;#125;);&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&amp;#125;&lt;span class=&quot;keyword&quot;&gt;else&lt;/span&gt;&amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    &lt;span class=&quot;keyword&quot;&gt;this&lt;/span&gt;.mInputEditText.setFilters(&lt;span class=&quot;keyword&quot;&gt;new&lt;/span&gt; InputFilter[] &amp;#123; EMOJI_FILTER &amp;#125;);&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&amp;#125;&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;
&lt;hr&gt;
&lt;p&gt;关于 Emoji 的相关修改都已经推送到了 github 上, &lt;a href=&quot;https://github.com/mafiagame/quick-cocos2d-x/commit/8a7c27aedb919e0ae5d178d688b704e620c2c1bb&quot; target=&quot;_blank&quot; rel=&quot;external&quot;&gt;点击这里&lt;/a&gt;查看.&lt;/p&gt;
</content>
    
    <summary type="html">
    
      为了应付 PM, EditBox 你需要知道的几个小技巧
    
    </summary>
    
    
      <category term="EditBox" scheme="http://blog.justbilt.com/tags/EditBox/"/>
    
      <category term="Quick-Cocos2d-x" scheme="http://blog.justbilt.com/tags/Quick-Cocos2d-x/"/>
    
  </entry>
  
  <entry>
    <title>最近遇到的几个 quick-x  真机崩溃</title>
    <link href="http://blog.justbilt.com/2016/04/10/quickx-crash-on-phone/"/>
    <id>http://blog.justbilt.com/2016/04/10/quickx-crash-on-phone/</id>
    <published>2016-04-10T12:14:18.000Z</published>
    <updated>2017-03-12T02:22:53.000Z</updated>
    
    <content type="html">&lt;p&gt;最近这段时间遇到了两次比较严重的真机崩溃问题, 都是之前所没有遇到过的, 特此记录一下, 希望能帮助到遇到类似问题的朋友.&lt;/p&gt;
&lt;p&gt;之所以强调真机, 是因为这些问题在 player 上或者 debug 版无法出现, 只有真正运行在手机上才可能遇到, 因为最后我们 Archive 出来的包都是 release 版的.&lt;/p&gt;
&lt;h1 id=&quot;1-_removeFromParent&quot;&gt;&lt;a href=&quot;#1-_removeFromParent&quot; class=&quot;headerlink&quot; title=&quot;1. removeFromParent&quot;&gt;&lt;/a&gt;1. removeFromParent&lt;/h1&gt;&lt;p&gt;removeFromParent() 多次会导致崩溃并闪退, 很难以想象是吧, 在我的记忆中应该只是抛出一个 lua 错误. 事实上, debug 版确实如此, 让我们看一段测试代码:&lt;/p&gt;
&lt;figure class=&quot;highlight lua&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;1&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;2&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;self._btnLogin:removeFromParent()&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;self._btnLogin:removeFromParent()&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;
&lt;p&gt;player 上会收到如下的 lua 错误提示:&lt;/p&gt;
&lt;figure class=&quot;highlight lua&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;1&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;LUA ERROR: [&lt;span class=&quot;built_in&quot;&gt;string&lt;/span&gt; &lt;span class=&quot;string&quot;&gt;&quot;xxx.lua&quot;&lt;/span&gt;]:&lt;span class=&quot;number&quot;&gt;349&lt;/span&gt;: invalid &lt;span class=&quot;string&quot;&gt;&#39;cobj&#39;&lt;/span&gt; &lt;span class=&quot;keyword&quot;&gt;in&lt;/span&gt; &lt;span class=&quot;function&quot;&gt;&lt;span class=&quot;keyword&quot;&gt;function&lt;/span&gt; &#39;&lt;span class=&quot;title&quot;&gt;lua_cocos2dx_Node_removeFromParentAndCleanup&lt;/span&gt;&#39;&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;
&lt;p&gt;让我们看下抛出这个错误的地方 &lt;code&gt;lua_cocos2dx_Node_removeFromParentAndCleanup&lt;/code&gt; :&lt;/p&gt;
&lt;figure class=&quot;highlight c++&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;1&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;2&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;3&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;4&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;5&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;6&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;7&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;preprocessor&quot;&gt;#&lt;span class=&quot;keyword&quot;&gt;if&lt;/span&gt; COCOS2D_DEBUG &amp;gt;= &lt;span class=&quot;number&quot;&gt;1&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    &lt;span class=&quot;keyword&quot;&gt;if&lt;/span&gt; (!cobj)&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    &amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;        tolua_error(tolua_S,&lt;span class=&quot;string&quot;&gt;&quot;invalid &#39;cobj&#39; in function &#39;lua_cocos2dx_Node_removeFromParentAndCleanup&#39;&quot;&lt;/span&gt;, &lt;span class=&quot;literal&quot;&gt;nullptr&lt;/span&gt;);&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;        &lt;span class=&quot;keyword&quot;&gt;return&lt;/span&gt; &lt;span class=&quot;number&quot;&gt;0&lt;/span&gt;;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    &amp;#125;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;preprocessor&quot;&gt;#&lt;span class=&quot;keyword&quot;&gt;endif&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;
&lt;p&gt;第一次调用完 removeFromParent(), &lt;code&gt;_btnLogin&lt;/code&gt; 的 c++ 对象就已经被释放了, 再次调用 &lt;code&gt;cobj&lt;/code&gt; 就是 &lt;code&gt;NULL&lt;/code&gt; 了, 所以就会进入到这个判断中, 从而抛出错误.&lt;/p&gt;
&lt;p&gt;但是这段代码却是运行在 COCOS2D_DEBUG 宏中的, 就意味着这段代码在 release 版是不生效的, 所以就会接着往下执行, 从而导致崩溃.&lt;/p&gt;
&lt;p&gt;虽然我们不太可能直接会用一个对象调用 removeFromParent 多次, 但是包含 removeFromParent 的函数被调用多次却是很有可能的, 所以我们一定要养成一个好的习惯, 在 &lt;code&gt;removeFromParent&lt;/code&gt; 之前要做判空检测, 之后要立刻置空:&lt;/p&gt;
&lt;figure class=&quot;highlight lua&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;1&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;2&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;3&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;4&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;keyword&quot;&gt;if&lt;/span&gt; xxx &lt;span class=&quot;keyword&quot;&gt;then&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    xxx:removeFromParent()&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    xxx = &lt;span class=&quot;keyword&quot;&gt;nil&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;keyword&quot;&gt;end&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;
&lt;h1 id=&quot;2-_Signal_13_was_raised-_SIGPIPE&quot;&gt;&lt;a href=&quot;#2-_Signal_13_was_raised-_SIGPIPE&quot; class=&quot;headerlink&quot; title=&quot;2. Signal 13 was raised. SIGPIPE&quot;&gt;&lt;/a&gt;2. Signal 13 was raised. SIGPIPE&lt;/h1&gt;&lt;p&gt;当游戏在 iOS 上不切换到后台直接锁屏一段时间, 网络资源就会被系统回收掉, 这时候解锁屏幕, 游戏并不知道 tcp 连接已经断开, 发送消息就会触发这个崩溃.&lt;/p&gt;
&lt;p&gt;表现出来的效果是手机解锁不了, 得等好久才可以.&lt;/p&gt;
&lt;p&gt;关于具体技术解释, 大家可以看这篇文章, &lt;a href=&quot;http://blog.csdn.net/jia12216/article/details/50844013&quot; target=&quot;_blank&quot; rel=&quot;external&quot;&gt;Signal 13 was raised（SIGPIPE管道破裂）&lt;/a&gt;, 我这里重点讲解决方案.&lt;/p&gt;
&lt;p&gt;网上说有两种解决方案(&lt;a href=&quot;http://www.jianshu.com/p/1957d2b18d2c&quot; target=&quot;_blank&quot; rel=&quot;external&quot;&gt;如何在 iOS 上避免 SIGPIPE 信号导致的 crash&lt;/a&gt;):&lt;/p&gt;
&lt;h2 id=&quot;1-__u5728_u5168_u5C40_u8303_u56F4_u5185_u5FFD_u7565_u8FD9_u4E2A_u4FE1_u53F7&quot;&gt;&lt;a href=&quot;#1-__u5728_u5168_u5C40_u8303_u56F4_u5185_u5FFD_u7565_u8FD9_u4E2A_u4FE1_u53F7&quot; class=&quot;headerlink&quot; title=&quot;1. 在全局范围内忽略这个信号&quot;&gt;&lt;/a&gt;1. 在全局范围内忽略这个信号&lt;/h2&gt;&lt;figure class=&quot;highlight c++&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;1&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;signal(SIGPIPE, SIG_IGN);&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;
&lt;h2 id=&quot;2-__u5728_u4E00_u5F00_u59CB_u7684_u65F6_u5019_u8BBE_u7F6E_socket__u4E0D_u8981_u53D1_u9001_SIGPIPE__u4FE1_u53F7&quot;&gt;&lt;a href=&quot;#2-__u5728_u4E00_u5F00_u59CB_u7684_u65F6_u5019_u8BBE_u7F6E_socket__u4E0D_u8981_u53D1_u9001_SIGPIPE__u4FE1_u53F7&quot; class=&quot;headerlink&quot; title=&quot;2. 在一开始的时候设置 socket 不要发送 SIGPIPE 信号&quot;&gt;&lt;/a&gt;2. 在一开始的时候设置 socket 不要发送 SIGPIPE 信号&lt;/h2&gt;&lt;figure class=&quot;highlight c++&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;1&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;2&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;keyword&quot;&gt;int&lt;/span&gt; value = &lt;span class=&quot;number&quot;&gt;1&lt;/span&gt;;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;setsockopt(sock, SOL_SOCKET, SO_NOSIGPIPE, &amp;amp;value, &lt;span class=&quot;keyword&quot;&gt;sizeof&lt;/span&gt;(value));&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;
&lt;p&gt;就 1 来说, cocos 早已设置了忽略, 在 &lt;code&gt;socket_open&lt;/code&gt; 函数中, 并且这的执行到了. 我在 &lt;code&gt;tcp.c&lt;/code&gt; 中的 &lt;code&gt;tcp_create&lt;/code&gt; 中加入 2 方案, 确实解决了这个问题. 但是 &lt;code&gt;SO_NOSIGPIPE&lt;/code&gt; 并不是跨平台的, 我偷懒直接用宏判断了下:&lt;/p&gt;
&lt;figure class=&quot;highlight c++&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;1&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;2&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;3&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;4&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;5&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;6&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;7&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;8&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;9&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;10&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;11&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;12&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;13&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;function&quot;&gt;&lt;span class=&quot;keyword&quot;&gt;static&lt;/span&gt; &lt;span class=&quot;keyword&quot;&gt;int&lt;/span&gt; &lt;span class=&quot;title&quot;&gt;tcp_create&lt;/span&gt;&lt;span class=&quot;params&quot;&gt;(lua_State *L, &lt;span class=&quot;keyword&quot;&gt;int&lt;/span&gt; family)&lt;/span&gt; &lt;/span&gt;&amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    t_socket sock;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    &lt;span class=&quot;keyword&quot;&gt;const&lt;/span&gt; &lt;span class=&quot;keyword&quot;&gt;char&lt;/span&gt; *err = inet_trycreate(&amp;amp;sock, family, SOCK_STREAM);&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    &lt;span class=&quot;comment&quot;&gt;/* try to allocate a system socket */&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    &lt;span class=&quot;keyword&quot;&gt;if&lt;/span&gt; (!err) &amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;        ...&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;        &lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;preprocessor&quot;&gt;#&lt;span class=&quot;keyword&quot;&gt;ifdef&lt;/span&gt; CC_TARGET_OS_IPHONE&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;        &lt;span class=&quot;keyword&quot;&gt;int&lt;/span&gt; val = &lt;span class=&quot;number&quot;&gt;1&lt;/span&gt;;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;        setsockopt(sock, SOL_SOCKET, SO_NOSIGPIPE, (&lt;span class=&quot;keyword&quot;&gt;void&lt;/span&gt; *)&amp;amp;val, &lt;span class=&quot;keyword&quot;&gt;sizeof&lt;/span&gt;(&lt;span class=&quot;keyword&quot;&gt;int&lt;/span&gt;));&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;preprocessor&quot;&gt;#&lt;span class=&quot;keyword&quot;&gt;endif&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;        ...&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&amp;#125;&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;
</content>
    
    <summary type="html">
    
      卧槽, 又崩溃了!
    
    </summary>
    
    
      <category term="Quick-Cocos2d-x" scheme="http://blog.justbilt.com/tags/Quick-Cocos2d-x/"/>
    
      <category term="crash" scheme="http://blog.justbilt.com/tags/crash/"/>
    
  </entry>
  
  <entry>
    <title>最近搞 iOS 版遇到的一些问题和技巧</title>
    <link href="http://blog.justbilt.com/2016/04/04/ios-dev-tips/"/>
    <id>http://blog.justbilt.com/2016/04/04/ios-dev-tips/</id>
    <published>2016-04-04T01:13:34.000Z</published>
    <updated>2017-03-12T04:19:57.000Z</updated>
    
    <content type="html">&lt;h1 id=&quot;u4E00-__u7F16_u8BD1_u8FD0_u884C&quot;&gt;&lt;a href=&quot;#u4E00-__u7F16_u8BD1_u8FD0_u884C&quot; class=&quot;headerlink&quot; title=&quot;一. 编译运行&quot;&gt;&lt;/a&gt;一. 编译运行&lt;/h1&gt;&lt;h2 id=&quot;1-__u8FD0_u884C_u65F6_u63D0_u793A_identity__u65E0_u6548&quot;&gt;&lt;a href=&quot;#1-__u8FD0_u884C_u65F6_u63D0_u793A_identity__u65E0_u6548&quot; class=&quot;headerlink&quot; title=&quot;1. 运行时提示 identity 无效&quot;&gt;&lt;/a&gt;1. 运行时提示 identity 无效&lt;/h2&gt;&lt;p&gt;&lt;img src=&quot;http://ww2.sinaimg.cn/large/7f870d23gw1f2ker4f0hhj20nc08eabu.jpg&quot; alt=&quot;&quot;&gt;&lt;/p&gt;
&lt;blockquote&gt;
&lt;p&gt;The identity used to sign the executable is no longer valid.&lt;br&gt;Please verify that your device’s clock is properly set, and that your signing certificate is not expired. (0xE8008018).&lt;/p&gt;
&lt;/blockquote&gt;
&lt;p&gt;解决方案:&lt;/p&gt;
&lt;ol&gt;
&lt;li&gt;打开 Preferences &amp;gt; Accounts&lt;/li&gt;
&lt;li&gt;选中项目对应的 Apple ID &amp;gt; 点击右下角 &lt;code&gt;View Details...&lt;/code&gt;&lt;/li&gt;
&lt;li&gt;点击弹出框左下角的 &lt;code&gt;Download All&lt;/code&gt; &amp;gt; 等待完成后点击 &lt;code&gt;Done&lt;/code&gt; 关闭&lt;/li&gt;
&lt;li&gt;再次运行项目, 等待弹出框, 点击 &lt;code&gt;reset&lt;/code&gt;.&lt;/li&gt;
&lt;/ol&gt;
&lt;p&gt;&lt;img src=&quot;http://ww1.sinaimg.cn/large/7f870d23gw1f2khakkr86j20ja0a0go3.jpg&quot; alt=&quot;&quot;&gt;&lt;/p&gt;
&lt;h2 id=&quot;2-_iPhone5__u4E0A_u83B7_u5F97_u7684_u8BBE_u5907_u5C3A_u5BF8_u4E3A_960x640&quot;&gt;&lt;a href=&quot;#2-_iPhone5__u4E0A_u83B7_u5F97_u7684_u8BBE_u5907_u5C3A_u5BF8_u4E3A_960x640&quot; class=&quot;headerlink&quot; title=&quot;2. iPhone5 上获得的设备尺寸为 960x640&quot;&gt;&lt;/a&gt;2. iPhone5 上获得的设备尺寸为 960x640&lt;/h2&gt;&lt;p&gt;表现出来是竖屏游戏上线有黑边, 跟踪发现获得的设备尺寸为 960x640, 而非 1136x640.&lt;/p&gt;
&lt;p&gt;解决方案:&lt;/p&gt;
&lt;p&gt;添加一张尺寸为 &lt;code&gt;1136x640&lt;/code&gt; 名为 &lt;code&gt;Default-568h@2x.png&lt;/code&gt; 的启动图即可.&lt;/p&gt;
&lt;p&gt;参考资料:&lt;br&gt;&lt;a href=&quot;http://discuss.cocos2d-x.org/t/getframesize-get-wrong-screen-size/7657&quot; target=&quot;_blank&quot; rel=&quot;external&quot;&gt;http://discuss.cocos2d-x.org/t/getframesize-get-wrong-screen-size/7657&lt;/a&gt;&lt;/p&gt;
&lt;h2 id=&quot;3-_XCode_issue__u9875_u9762_u53EA_u663E_u793A_u9519_u8BEF_2C__u4E0D_u663E_u793A_u8B66_u544A&quot;&gt;&lt;a href=&quot;#3-_XCode_issue__u9875_u9762_u53EA_u663E_u793A_u9519_u8BEF_2C__u4E0D_u663E_u793A_u8B66_u544A&quot; class=&quot;headerlink&quot; title=&quot;3. XCode issue 页面只显示错误, 不显示警告&quot;&gt;&lt;/a&gt;3. XCode issue 页面只显示错误, 不显示警告&lt;/h2&gt;&lt;p&gt;cocos2d-x 在 XCode 中编译 warning 太多, 出错后 error 会被淹没在一大堆的警告中, 得拖动半天才能找得到.&lt;/p&gt;
&lt;p&gt;解决方案:&lt;/p&gt;
&lt;p&gt;&lt;img src=&quot;http://ww2.sinaimg.cn/large/7f870d23gw1f2kib70c4qj207500mt8h.jpg&quot; alt=&quot;&quot;&gt;&lt;/p&gt;
&lt;p&gt;在页面最下方有一个感叹号型按钮, 点击选中即可.&lt;/p&gt;
&lt;h1 id=&quot;u4E8C-__u4E0A_u4F20_u5E94_u7528&quot;&gt;&lt;a href=&quot;#u4E8C-__u4E0A_u4F20_u5E94_u7528&quot; class=&quot;headerlink&quot; title=&quot;二. 上传应用&quot;&gt;&lt;/a&gt;二. 上传应用&lt;/h1&gt;&lt;h2 id=&quot;1-__u591A_u4EFB_u52A1_u652F_u6301&quot;&gt;&lt;a href=&quot;#1-__u591A_u4EFB_u52A1_u652F_u6301&quot; class=&quot;headerlink&quot; title=&quot;1. 多任务支持&quot;&gt;&lt;/a&gt;1. 多任务支持&lt;/h2&gt;&lt;blockquote&gt;
&lt;p&gt;XCode 7 error: “A launch storyboard or xib must be provided unless the app requires full screen”&lt;/p&gt;
&lt;/blockquote&gt;
&lt;p&gt;解决方案:&lt;/p&gt;
&lt;p&gt;我们勾上全屏即可:&lt;br&gt;&lt;img src=&quot;http://ww1.sinaimg.cn/large/7f870d23gw1f2khkqmob7j20b809it9f.jpg&quot; alt=&quot;&quot;&gt;&lt;/p&gt;
&lt;hr&gt;
&lt;p&gt;目前就这些, 后面会持续更新 !&lt;/p&gt;
</content>
    
    <summary type="html">
    
      万一遇上了呢?
    
    </summary>
    
    
      <category term="iOS" scheme="http://blog.justbilt.com/tags/iOS/"/>
    
      <category term="iOS-Dev-Tips" scheme="http://blog.justbilt.com/tags/iOS-Dev-Tips/"/>
    
  </entry>
  
  <entry>
    <title>记一次 quick-x 内存泄露排查</title>
    <link href="http://blog.justbilt.com/2016/03/19/quickx-memery-leak/"/>
    <id>http://blog.justbilt.com/2016/03/19/quickx-memery-leak/</id>
    <published>2016-03-19T09:48:38.000Z</published>
    <updated>2017-03-12T02:22:53.000Z</updated>
    
    <content type="html">&lt;p&gt;这周 @bin 告诉我项目有比较严重的内存泄露, 任意一个界面不停的打开关闭, 内存占用会一直往上涨, 直到被系统 kill 掉.&lt;/p&gt;
&lt;h1 id=&quot;u4E00-__u786E_u5B9A_u95EE_u9898&quot;&gt;&lt;a href=&quot;#u4E00-__u786E_u5B9A_u95EE_u9898&quot; class=&quot;headerlink&quot; title=&quot;一. 确定问题&quot;&gt;&lt;/a&gt;一. 确定问题&lt;/h1&gt;&lt;p&gt;收到问题后, 我简单写了一段测试代码, 加载/移除界面 100 次, 对比内存变化:&lt;/p&gt;
&lt;figure class=&quot;highlight lua&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;1&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;2&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;3&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;4&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;5&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;6&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;7&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;8&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;9&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;10&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;11&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;12&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;13&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;14&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;keyword&quot;&gt;local&lt;/span&gt; index = &lt;span class=&quot;number&quot;&gt;0&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;keyword&quot;&gt;local&lt;/span&gt; handler = &lt;span class=&quot;keyword&quot;&gt;nil&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;handler = scheduler.scheduleGlobal(&lt;span class=&quot;function&quot;&gt;&lt;span class=&quot;keyword&quot;&gt;function&lt;/span&gt;&lt;span class=&quot;params&quot;&gt;( ... )&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    &lt;span class=&quot;comment&quot;&gt;-- 加载界面&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    app.sceneManager:pushLayer(&lt;span class=&quot;built_in&quot;&gt;require&lt;/span&gt;(&lt;span class=&quot;string&quot;&gt;&#39;app.scenes.PageShop&#39;&lt;/span&gt;).new())&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    self:performWithDelay(&lt;span class=&quot;function&quot;&gt;&lt;span class=&quot;keyword&quot;&gt;function&lt;/span&gt;&lt;span class=&quot;params&quot;&gt;( ... )&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;        &lt;span class=&quot;comment&quot;&gt;-- 移除界面&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;        app.sceneManager:popLayer()&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;        index = index + &lt;span class=&quot;number&quot;&gt;1&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;        &lt;span class=&quot;keyword&quot;&gt;if&lt;/span&gt; index &amp;gt;= &lt;span class=&quot;number&quot;&gt;100&lt;/span&gt; &lt;span class=&quot;keyword&quot;&gt;then&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;            scheduler.unscheduleGlobal(handler)&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;        &lt;span class=&quot;keyword&quot;&gt;end&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    &lt;span class=&quot;keyword&quot;&gt;end&lt;/span&gt;, &lt;span class=&quot;number&quot;&gt;0.5&lt;/span&gt;)&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;keyword&quot;&gt;end&lt;/span&gt;, &lt;span class=&quot;number&quot;&gt;0.5&lt;/span&gt;)&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;
&lt;p&gt;为了方便, 我没有进行真机测试, 而是使用 xcode 启动 player 来进行测试, 在 Xcode 的 &lt;code&gt;Debug Navigator/Memory Report&lt;/code&gt; 窗口查看结果.&lt;/p&gt;
&lt;p&gt;&lt;img src=&quot;http://ww3.sinaimg.cn/large/7f870d23gw1f23kr8dricj20rh0fstab.jpg&quot; alt=&quot;&quot;&gt;&lt;/p&gt;
&lt;p&gt;在测试前的平稳内存为 194M , 测试后惊人的达到了 258M, 十分严重的内存泄露了!&lt;/p&gt;
&lt;h1 id=&quot;u4E8C-__u521D_u6B65_u89E3_u51B3_u95EE_u9898&quot;&gt;&lt;a href=&quot;#u4E8C-__u521D_u6B65_u89E3_u51B3_u95EE_u9898&quot; class=&quot;headerlink&quot; title=&quot;二. 初步解决问题&quot;&gt;&lt;/a&gt;二. 初步解决问题&lt;/h1&gt;&lt;p&gt;由于项目是纯 lua 的, 所以不太可能是数据和逻辑的问题, 那么很有可能是视图(cocos2d-x 对象)存在内存泄露. 而每一个界面都存在问题, 那么很可能是某个通用组件存在问题.&lt;/p&gt;
&lt;p&gt;经过一番努力, 最终成功找到了内存持续增加的原因, 一共两处:&lt;/p&gt;
&lt;h2 id=&quot;1-_lua__u5783_u573E_u6CA1_u6709_u53CA_u65F6_u56DE_u6536&quot;&gt;&lt;a href=&quot;#1-_lua__u5783_u573E_u6CA1_u6709_u53CA_u65F6_u56DE_u6536&quot; class=&quot;headerlink&quot; title=&quot;1. lua 垃圾没有及时回收&quot;&gt;&lt;/a&gt;1. lua 垃圾没有及时回收&lt;/h2&gt;&lt;p&gt;lua 的垃圾是会自动回收的, 但我们有时候可能需要手动回收下, 比如切换场景时, 关闭界面时, 主动回收的代码很简单:&lt;/p&gt;
&lt;figure class=&quot;highlight plain&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;1&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;collectgarbage(&amp;#34;collect&amp;#34;)&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;
&lt;p&gt;我将这段代码加到了统一关闭界面的地方.&lt;/p&gt;
&lt;p&gt;更多关于 lua 垃圾回收的具体问题大家可以参考这个两篇文章:&lt;/p&gt;
&lt;p&gt;&lt;a href=&quot;http://luatut.com/collectgarbage.html&quot; target=&quot;_blank&quot; rel=&quot;external&quot;&gt;http://luatut.com/collectgarbage.html&lt;/a&gt;&lt;br&gt;&lt;a href=&quot;http://www.codingnow.com/2000/download/lua_manual.html&quot; target=&quot;_blank&quot; rel=&quot;external&quot;&gt;http://www.codingnow.com/2000/download/lua_manual.html&lt;/a&gt;&lt;/p&gt;
&lt;h2 id=&quot;2-__u7CBE_u7075_u53D8_u7070_u548C_u9AD8_u4EAE_u7684_shader__u521B_u5EFA_u540E_u4E00_u76F4_u6CA1_u6709_u91CA_u653E&quot;&gt;&lt;a href=&quot;#2-__u7CBE_u7075_u53D8_u7070_u548C_u9AD8_u4EAE_u7684_shader__u521B_u5EFA_u540E_u4E00_u76F4_u6CA1_u6709_u91CA_u653E&quot; class=&quot;headerlink&quot; title=&quot;2. 精灵变灰和高亮的 shader 创建后一直没有释放&quot;&gt;&lt;/a&gt;2. 精灵变灰和高亮的 shader 创建后一直没有释放&lt;/h2&gt;&lt;figure class=&quot;highlight lua&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;1&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;2&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;3&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;4&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;5&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;6&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;7&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;8&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;9&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;10&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;11&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;12&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;function&quot;&gt;&lt;span class=&quot;keyword&quot;&gt;function&lt;/span&gt; &lt;span class=&quot;title&quot;&gt;GameUtils.SetSpriteGrey&lt;/span&gt;&lt;span class=&quot;params&quot;&gt;(sprite,is_grey)&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    &lt;span class=&quot;keyword&quot;&gt;if&lt;/span&gt; sprite &lt;span class=&quot;keyword&quot;&gt;and&lt;/span&gt; sprite.setGLProgramState &lt;span class=&quot;keyword&quot;&gt;then&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;        &lt;span class=&quot;keyword&quot;&gt;if&lt;/span&gt; is_grey &lt;span class=&quot;keyword&quot;&gt;then&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;            &lt;span class=&quot;keyword&quot;&gt;local&lt;/span&gt; pProgram = cc.GLProgram:createWithByteArrays(ShaderData.vertDefaultSourceGrey, ShaderData.pszFragSourceGrey)&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;            ...&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;            sprite:setGLProgram(pProgram) &lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;        &lt;span class=&quot;keyword&quot;&gt;else&lt;/span&gt; &lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;            &lt;span class=&quot;keyword&quot;&gt;local&lt;/span&gt; pProgram = cc.GLProgramState:getOrCreateWithGLProgram(cc.GLProgramCache:getInstance():getGLProgram(&lt;span class=&quot;string&quot;&gt;&quot;ShaderPositionTextureColor_noMVP&quot;&lt;/span&gt;))&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;            sprite:setGLProgramState(pProgram)&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;        &lt;span class=&quot;keyword&quot;&gt;end&lt;/span&gt; &lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    &lt;span class=&quot;keyword&quot;&gt;end&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;keyword&quot;&gt;end&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;
&lt;p&gt;这段代码看起来没有任何问题, 我能想到只是没有用 &lt;code&gt;GLProgramCache&lt;/code&gt; 缓存起来, 造成每次都会创建的效率问题, 应该不会导致泄露吗 ? 精灵被释放时难道不会自动释放所引用的 GLProgram 吗?&lt;/p&gt;
&lt;p&gt;因为当时项目比较紧急, 我将这段代码使用 &lt;code&gt;GLProgramCache&lt;/code&gt; 的形式修改了一下, 惊奇的发现内存泄露问题竟然解决了. 修改后的代码如下:&lt;/p&gt;
&lt;figure class=&quot;highlight lua&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;1&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;2&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;3&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;4&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;5&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;6&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;7&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;8&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;9&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;10&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;11&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;12&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;13&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;14&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;15&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;16&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;17&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;18&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;19&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;function&quot;&gt;&lt;span class=&quot;keyword&quot;&gt;function&lt;/span&gt; &lt;span class=&quot;title&quot;&gt;GameUtils.SetSpriteGrey&lt;/span&gt;&lt;span class=&quot;params&quot;&gt;(sprite,is_grey)&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    &lt;span class=&quot;keyword&quot;&gt;if&lt;/span&gt; sprite &lt;span class=&quot;keyword&quot;&gt;and&lt;/span&gt; sprite.setGLProgramState &lt;span class=&quot;keyword&quot;&gt;then&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;        &lt;span class=&quot;keyword&quot;&gt;if&lt;/span&gt; is_grey &lt;span class=&quot;keyword&quot;&gt;then&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;            &lt;span class=&quot;keyword&quot;&gt;local&lt;/span&gt; pProgram = cc.GLProgramCache:getInstance():getGLProgram(&lt;span class=&quot;string&quot;&gt;&quot;ShaderPositionTextureColor_Gray&quot;&lt;/span&gt;)&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;            &lt;span class=&quot;keyword&quot;&gt;if&lt;/span&gt; &lt;span class=&quot;keyword&quot;&gt;not&lt;/span&gt; pProgram &lt;span class=&quot;keyword&quot;&gt;then&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;                pProgram = cc.GLProgram:createWithByteArrays(ShaderData.vertDefaultSourceGrey, ShaderData.pszFragSourceGrey)&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;                pProgram:bindAttribLocation(cc.ATTRIBUTE_NAME_POSITION, cc.VERTEX_ATTRIB_POSITION)&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;                pProgram:bindAttribLocation(cc.ATTRIBUTE_NAME_COLOR, cc.VERTEX_ATTRIB_COLOR)&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;                pProgram:bindAttribLocation(cc.ATTRIBUTE_NAME_TEX_COORD, cc.VERTEX_ATTRIB_FLAG_TEX_COORDS)&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;                pProgram:link()&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;                pProgram:updateUniforms()&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;                cc.GLProgramCache:getInstance():addGLProgram(pProgram, &lt;span class=&quot;string&quot;&gt;&quot;ShaderPositionTextureColor_Gray&quot;&lt;/span&gt;)&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;            &lt;span class=&quot;keyword&quot;&gt;end&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;            sprite:setGLProgram(pProgram) &lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;        &lt;span class=&quot;keyword&quot;&gt;else&lt;/span&gt; &lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;            sprite:setGLProgram(cc.GLProgramCache:getInstance():getGLProgram(&lt;span class=&quot;string&quot;&gt;&quot;ShaderPositionTextureColor_noMVP&quot;&lt;/span&gt;))&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;        &lt;span class=&quot;keyword&quot;&gt;end&lt;/span&gt; &lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    &lt;span class=&quot;keyword&quot;&gt;end&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;keyword&quot;&gt;end&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;
&lt;h1 id=&quot;u4E09-__u9690_u85CF_u5728_u80CC_u540E_u7684_u79D8_u5BC6&quot;&gt;&lt;a href=&quot;#u4E09-__u9690_u85CF_u5728_u80CC_u540E_u7684_u79D8_u5BC6&quot; class=&quot;headerlink&quot; title=&quot;三. 隐藏在背后的秘密&quot;&gt;&lt;/a&gt;三. 隐藏在背后的秘密&lt;/h1&gt;&lt;p&gt;问题解决了, 那么是不是可以结束了呢 ? 并不能, 晚上回到家我就一直在思考这个问题, 倒是是什么原因导致了 GLProgram 内存没有释放, 而使用 GLProgramCache 就没有问题.&lt;/p&gt;
&lt;p&gt;莫不是 cocos2d-x 的 bug ? cocos 对象是基于引用计数去自动释放内存的. 我排查了几处可疑的地方:&lt;/p&gt;
&lt;ol&gt;
&lt;li&gt;GLProgram::createWithByteArrays 调用了 autorelease&lt;/li&gt;
&lt;li&gt;Node::setGLProgram 调用了 retain&lt;/li&gt;
&lt;li&gt;Node::~Node 调用了 release&lt;/li&gt;
&lt;/ol&gt;
&lt;p&gt;貌似都没有问题. 那么我可以跟踪下引用计数的变化, 看看是哪一步出现的问题! 经过一番调试,最终定位到了问题, 大家请看:&lt;/p&gt;
&lt;p&gt;&lt;img src=&quot;http://ww1.sinaimg.cn/large/7f870d23gw1f2anef57p3j20u60370ts.jpg&quot; alt=&quot;&quot;&gt;&lt;/p&gt;
&lt;p&gt;1.&lt;code&gt;Node::setGLProgram&lt;/code&gt; 进入到 &lt;code&gt;GLProgramState::getOrCreateWithGLProgram&lt;/code&gt;, 这一步没有什么问题.&lt;/p&gt;
&lt;p&gt;&lt;img src=&quot;http://ww4.sinaimg.cn/large/7f870d23gw1f2aneul8cej20u7021jrx.jpg&quot; alt=&quot;&quot;&gt;&lt;/p&gt;
&lt;p&gt;2.这里有一个新的缓存 &lt;code&gt;GLProgramStateCache&lt;/code&gt; , 进入它到 &lt;code&gt;getGLProgramState&lt;/code&gt; 函数.&lt;/p&gt;
&lt;p&gt;&lt;img src=&quot;http://ww3.sinaimg.cn/large/7f870d23gw1f2anf4bv4tj20u906l402.jpg&quot; alt=&quot;&quot;&gt;&lt;/p&gt;
&lt;p&gt;3.这一步是 GLProgramStateCache 的核心代码了, 判断有无在缓存中, 没有则 insert 到末尾. 这里的 &lt;code&gt;_glProgramStates&lt;/code&gt; 是一个 &lt;code&gt;Map&lt;/code&gt; , 而这个 map 竟然是以传递进来的 &lt;code&gt;glprogram&lt;/code&gt; 做&lt;br&gt; key , 而我们每次传递进来的 glprogram 都是新创建的, 所以在我们这个使用情况下缓存根本是无效的.&lt;/p&gt;
&lt;p&gt;&lt;img src=&quot;http://ww1.sinaimg.cn/large/7f870d23gw1f2anfex5v1j20tx03zjs1.jpg&quot; alt=&quot;&quot;&gt;&lt;/p&gt;
&lt;p&gt;4.让我看一下, &lt;code&gt;GLProgramState&lt;/code&gt; 的 &lt;code&gt;init&lt;/code&gt; 函数, 这下找到 retain 地方了. &lt;/p&gt;
&lt;p&gt;这样的话, 就讲得通了, GLProgram 会在 GLProgramState 析构的时候 release 掉. 而 GLProgramState 只会在 GLProgramStateCache:removeAllGLProgramState 释放掉. 而 removeAllGLProgramState 只有在手动或者游戏退出的时候才会调用.&lt;/p&gt;
&lt;p&gt;OK, 这下定位到了问题, 虽然我们使用有些问题, 但 GLProgramStateCache 设计确实有不合理的地方, 大家记得正确用法就好了, 就是 shader 一定要使用 GLProgramCache !&lt;/p&gt;
&lt;hr&gt;
&lt;p&gt;后记&lt;/p&gt;
&lt;p&gt;通过这次解决问题, 我有一个特别大的收获. 就是做优化工作时一定不能去猜, 要有数据和逻辑的支持.&lt;/p&gt;
</content>
    
    <summary type="html">
    
      谁动了我的内存 ? 
    
    </summary>
    
    
      <category term="MemoryLeak" scheme="http://blog.justbilt.com/tags/MemoryLeak/"/>
    
      <category term="Quick-Cocos2d-x" scheme="http://blog.justbilt.com/tags/Quick-Cocos2d-x/"/>
    
  </entry>
  
  <entry>
    <title>在 quick-x 中使用 TableView</title>
    <link href="http://blog.justbilt.com/2016/03/13/quickx-tableview/"/>
    <id>http://blog.justbilt.com/2016/03/13/quickx-tableview/</id>
    <published>2016-03-13T00:02:53.000Z</published>
    <updated>2017-03-12T02:22:53.000Z</updated>
    
    <content type="html">&lt;p&gt;上篇文章说到使用 TableView 可以大幅提升界面的创建速度, 这篇文章我们来看看如何在 quick 中使用它.&lt;/p&gt;
&lt;h1 id=&quot;u4E00-__u57FA_u672C_u7528_u6CD5&quot;&gt;&lt;a href=&quot;#u4E00-__u57FA_u672C_u7528_u6CD5&quot; class=&quot;headerlink&quot; title=&quot;一. 基本用法&quot;&gt;&lt;/a&gt;一. 基本用法&lt;/h1&gt;&lt;h2 id=&quot;1-__u521B_u5EFA_u5BF9_u8C61&quot;&gt;&lt;a href=&quot;#1-__u521B_u5EFA_u5BF9_u8C61&quot; class=&quot;headerlink&quot; title=&quot;1. 创建对象&quot;&gt;&lt;/a&gt;1. 创建对象&lt;/h2&gt;&lt;p&gt;首先, 创建一个 TableView 对象:&lt;/p&gt;
&lt;figure class=&quot;highlight lua&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;1&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;keyword&quot;&gt;local&lt;/span&gt; view = cc.TableView:create(cc.size(&lt;span class=&quot;number&quot;&gt;480&lt;/span&gt;,&lt;span class=&quot;number&quot;&gt;320&lt;/span&gt;))&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;
&lt;p&gt;传入的那个 size 是 viewsize, 即可视区域的尺寸, 后期也可以通过 &lt;code&gt;setViewSize&lt;/code&gt; 来调节.&lt;/p&gt;
&lt;h2 id=&quot;2-__u8BBE_u7F6E_u586B_u5145_u987A_u5E8F&quot;&gt;&lt;a href=&quot;#2-__u8BBE_u7F6E_u586B_u5145_u987A_u5E8F&quot; class=&quot;headerlink&quot; title=&quot;2. 设置填充顺序&quot;&gt;&lt;/a&gt;2. 设置填充顺序&lt;/h2&gt;&lt;p&gt;下面设置填充顺序, 默认是从下往上填充, 我们习惯了使用从上往下填充, 所以需要修改下:&lt;br&gt;&lt;figure class=&quot;highlight lua&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;1&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;view:setVerticalFillOrder(cc.TABLEVIEW_FILL_TOPDOWN)&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;&lt;/p&gt;
&lt;p&gt;其可选值如下:&lt;br&gt;&lt;figure class=&quot;highlight lua&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;1&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;2&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;cc.TABLEVIEW_FILL_TOPDOWN = &lt;span class=&quot;number&quot;&gt;0&lt;/span&gt;  &lt;span class=&quot;comment&quot;&gt;-- 从上自下&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;cc.TABLEVIEW_FILL_BOTTOMUP = &lt;span class=&quot;number&quot;&gt;1&lt;/span&gt; &lt;span class=&quot;comment&quot;&gt;-- 从下自上&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;&lt;/p&gt;
&lt;p&gt;这个值最终会影响所有 cell 的顺序, 具体些是第 0 个元素在最上面还是在最下面.&lt;/p&gt;
&lt;h2 id=&quot;3-__u6CE8_u518C_u4E8B_u4EF6_u76D1_u542C&quot;&gt;&lt;a href=&quot;#3-__u6CE8_u518C_u4E8B_u4EF6_u76D1_u542C&quot; class=&quot;headerlink&quot; title=&quot;3. 注册事件监听&quot;&gt;&lt;/a&gt;3. 注册事件监听&lt;/h2&gt;&lt;p&gt;TableView 提供了好多事件, 具体作用如下:&lt;/p&gt;
&lt;figure class=&quot;highlight lua&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;1&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;2&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;3&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;4&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;5&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;6&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;7&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;8&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;9&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;cc.SCROLLVIEW_SCRIPT_SCROLL = &lt;span class=&quot;number&quot;&gt;0&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;cc.SCROLLVIEW_SCRIPT_ZOOM   = &lt;span class=&quot;number&quot;&gt;1&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;cc.TABLECELL_TOUCHED        = &lt;span class=&quot;number&quot;&gt;2&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;cc.TABLECELL_HIGH_LIGHT     = &lt;span class=&quot;number&quot;&gt;3&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;cc.TABLECELL_UNHIGH_LIGHT   = &lt;span class=&quot;number&quot;&gt;4&lt;/span&gt; &lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;cc.TABLECELL_WILL_RECYCLE   = &lt;span class=&quot;number&quot;&gt;5&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;cc.TABLECELL_SIZE_FOR_INDEX = &lt;span class=&quot;number&quot;&gt;6&lt;/span&gt; &lt;span class=&quot;comment&quot;&gt;-- 获取节点尺寸的回调&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;cc.TABLECELL_SIZE_AT_INDEX  = &lt;span class=&quot;number&quot;&gt;7&lt;/span&gt; &lt;span class=&quot;comment&quot;&gt;-- 获取对应位置节点的回调&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;cc.NUMBER_OF_CELLS_IN_TABLEVIEW = &lt;span class=&quot;number&quot;&gt;8&lt;/span&gt; &lt;span class=&quot;comment&quot;&gt;-- 获取节点数量的回调&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;
&lt;p&gt;但其实真正有意义的就三个, 6,7,8. 其他的&lt;strong&gt;根本不会回调&lt;/strong&gt;, 注册了也没有什么用. 注册监听使用 &lt;code&gt;registerScriptHandler&lt;/code&gt; 函数.&lt;/p&gt;
&lt;h3 id=&quot;1_29-__u6CE8_u518C_u8282_u70B9_u6570_u91CF_u56DE_u8C03&quot;&gt;&lt;a href=&quot;#1_29-__u6CE8_u518C_u8282_u70B9_u6570_u91CF_u56DE_u8C03&quot; class=&quot;headerlink&quot; title=&quot;1). 注册节点数量回调&quot;&gt;&lt;/a&gt;1). 注册节点数量回调&lt;/h3&gt;&lt;figure class=&quot;highlight lua&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;1&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;2&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;3&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;view:registerScriptHandler(&lt;span class=&quot;function&quot;&gt;&lt;span class=&quot;keyword&quot;&gt;function&lt;/span&gt;&lt;span class=&quot;params&quot;&gt;()&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    &lt;span class=&quot;keyword&quot;&gt;return&lt;/span&gt; &lt;span class=&quot;number&quot;&gt;10&lt;/span&gt; &lt;span class=&quot;comment&quot;&gt;-- 假如有10个节点&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;keyword&quot;&gt;end&lt;/span&gt;, cc.NUMBER_OF_CELLS_IN_TABLEVIEW)&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;
&lt;p&gt;返回节点数量.&lt;/p&gt;
&lt;h3 id=&quot;2_29-__u6CE8_u518C_u83B7_u53D6_u8282_u70B9_u5C3A_u5BF8_u7684_u56DE_u8C03&quot;&gt;&lt;a href=&quot;#2_29-__u6CE8_u518C_u83B7_u53D6_u8282_u70B9_u5C3A_u5BF8_u7684_u56DE_u8C03&quot; class=&quot;headerlink&quot; title=&quot;2). 注册获取节点尺寸的回调&quot;&gt;&lt;/a&gt;2). 注册获取节点尺寸的回调&lt;/h3&gt;&lt;p&gt;若是每个节点一致, 则可以返回一个固定尺寸; 若不一致, 可以根据 idx 去取出对应节点的尺寸.&lt;/p&gt;
&lt;figure class=&quot;highlight lua&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;1&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;2&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;3&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;4&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;5&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;6&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;7&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;8&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;9&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;10&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;view:registerScriptHandler(&lt;span class=&quot;function&quot;&gt;&lt;span class=&quot;keyword&quot;&gt;function&lt;/span&gt;&lt;span class=&quot;params&quot;&gt;(table, idx)&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    &lt;span class=&quot;comment&quot;&gt;-- 默认尺寸&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    &lt;span class=&quot;keyword&quot;&gt;local&lt;/span&gt; size = self.defaultSize&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    &lt;span class=&quot;keyword&quot;&gt;local&lt;/span&gt; cell = view:cellAtIndex(idx)&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    &lt;span class=&quot;keyword&quot;&gt;if&lt;/span&gt; cell &lt;span class=&quot;keyword&quot;&gt;then&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;        &lt;span class=&quot;comment&quot;&gt;-- cell.view 属性是在线面创建 cell 时赋值的.&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;        size = cell.view:getBoundingBox()&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    &lt;span class=&quot;keyword&quot;&gt;end&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    &lt;span class=&quot;keyword&quot;&gt;return&lt;/span&gt; size.height, size.width&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;keyword&quot;&gt;end&lt;/span&gt;, cc.TABLECELL_SIZE_FOR_INDEX)&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;
&lt;p&gt;注意, 这里如果是纵向滚动的话,返回顺序是高,宽; 横向滚动的话则返回宽,高. &lt;/p&gt;
&lt;h3 id=&quot;3_29-__u83B7_u53D6_u5BF9_u5E94_u4F4D_u7F6E_u8282_u70B9_u7684_u56DE_u8C03&quot;&gt;&lt;a href=&quot;#3_29-__u83B7_u53D6_u5BF9_u5E94_u4F4D_u7F6E_u8282_u70B9_u7684_u56DE_u8C03&quot; class=&quot;headerlink&quot; title=&quot;3). 获取对应位置节点的回调&quot;&gt;&lt;/a&gt;3). 获取对应位置节点的回调&lt;/h3&gt;&lt;p&gt;这个回调的名称和上面那个很像, 有时候会分不清楚.&lt;/p&gt;
&lt;figure class=&quot;highlight lua&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;1&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;2&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;3&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;4&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;5&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;6&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;7&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;8&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;9&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;10&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;11&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;12&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;13&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;view:registerScriptHandler(&lt;span class=&quot;function&quot;&gt;&lt;span class=&quot;keyword&quot;&gt;function&lt;/span&gt;&lt;span class=&quot;params&quot;&gt;(table, idx)&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    &lt;span class=&quot;keyword&quot;&gt;local&lt;/span&gt; cell = &lt;span class=&quot;built_in&quot;&gt;table&lt;/span&gt;:dequeueCell()&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    &lt;span class=&quot;keyword&quot;&gt;if&lt;/span&gt; &lt;span class=&quot;keyword&quot;&gt;nil&lt;/span&gt; == cell &lt;span class=&quot;keyword&quot;&gt;then&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;        cell = cc.TableViewCell:new()&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;        cell.view = self.class.new()&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;            :pos(self.class.designSize.width/&lt;span class=&quot;number&quot;&gt;2&lt;/span&gt;, self.class.designSize.height/&lt;span class=&quot;number&quot;&gt;2&lt;/span&gt;)&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;            :addTo(cell)&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    &lt;span class=&quot;keyword&quot;&gt;end&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    &lt;span class=&quot;comment&quot;&gt;-- 如果需要刷新的话, 可能需要自己去处理, 如不需要, 就可以不用下面的这个调用&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    cell.view:refresh()&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    &lt;span class=&quot;keyword&quot;&gt;return&lt;/span&gt; cell&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;keyword&quot;&gt;end&lt;/span&gt;, cc.TABLECELL_SIZE_AT_INDEX)&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;
&lt;h2 id=&quot;3-__u83B7_u53D6/_u65B0_u589E/_u4FEE_u6539/_u5220_u9664_u8282_u70B9&quot;&gt;&lt;a href=&quot;#3-__u83B7_u53D6/_u65B0_u589E/_u4FEE_u6539/_u5220_u9664_u8282_u70B9&quot; class=&quot;headerlink&quot; title=&quot;3. 获取/新增/修改/删除节点&quot;&gt;&lt;/a&gt;3. 获取/新增/修改/删除节点&lt;/h2&gt;&lt;p&gt;这些操作分别对应 &lt;code&gt;cellAtIndex&lt;/code&gt;/&lt;code&gt;updateCellAtIndex&lt;/code&gt;/&lt;code&gt;insertCellAtIndex&lt;/code&gt;/&lt;code&gt;removeCellAtIndex&lt;/code&gt; . 这些接口很好理解, 但就多数情况而言, 他们可能需要和 &lt;code&gt;reloadData&lt;/code&gt; 配合使用. &lt;/p&gt;
&lt;p&gt;好了, 以上就是基本用法了. 在使用时还有一些需要注意的细节:&lt;/p&gt;
&lt;ol&gt;
&lt;li&gt;不能使用 setNodeEventEnable, 因为和 Node 的 registerScriptHandler 有冲突.&lt;/li&gt;
&lt;li&gt;id 从 0 开始, 而大家在 lua 这边准备的数据多是以 1 开始, 这样可能需要 +1 和 -1, 需要细心一些.&lt;/li&gt;
&lt;/ol&gt;
&lt;hr&gt;
&lt;h1 id=&quot;u4E8C-__u4E00_u4E9B_u5F02_u5E38_u7684_u89E3_u51B3_u65B9_u6848&quot;&gt;&lt;a href=&quot;#u4E8C-__u4E00_u4E9B_u5F02_u5E38_u7684_u89E3_u51B3_u65B9_u6848&quot; class=&quot;headerlink&quot; title=&quot;二. 一些异常的解决方案&quot;&gt;&lt;/a&gt;二. 一些异常的解决方案&lt;/h1&gt;&lt;h2 id=&quot;1-_lua__u51FA_u9519_u5BFC_u81F4_player__u5D29_u6E83&quot;&gt;&lt;a href=&quot;#1-_lua__u51FA_u9519_u5BFC_u81F4_player__u5D29_u6E83&quot; class=&quot;headerlink&quot; title=&quot;1. lua 出错导致 player 崩溃&quot;&gt;&lt;/a&gt;1. lua 出错导致 player 崩溃&lt;/h2&gt;&lt;p&gt;TableView 回调 &lt;code&gt;tableCellAtIndex&lt;/code&gt; 在lua这边的实现一旦出错, 就会在 c++ 那边收到一个 NULL 的 cell, 因为没有判空, 下面对 cell 的操作就会导致 Plaer 崩溃. 对应修改如下:&lt;/p&gt;
&lt;figure class=&quot;highlight c++&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;1&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;2&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;3&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;4&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;5&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;6&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;7&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;8&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;     cell = _dataSource-&amp;gt;tableCellAtIndex(&lt;span class=&quot;keyword&quot;&gt;this&lt;/span&gt;, idx);&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;-    &lt;span class=&quot;keyword&quot;&gt;this&lt;/span&gt;-&amp;gt;_setIndexForCell(idx, cell);&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;-    &lt;span class=&quot;keyword&quot;&gt;this&lt;/span&gt;-&amp;gt;_addCellIfNecessary(cell);&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;+    &lt;span class=&quot;keyword&quot;&gt;if&lt;/span&gt;(cell)&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;+    &amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;+        &lt;span class=&quot;keyword&quot;&gt;this&lt;/span&gt;-&amp;gt;_setIndexForCell(idx, cell);&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;+        &lt;span class=&quot;keyword&quot;&gt;this&lt;/span&gt;-&amp;gt;_addCellIfNecessary(cell);&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;+    &amp;#125;&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;
&lt;p&gt;这时候, 不会崩溃了, 但是也看不到 lua 那边出的什么错误, 经过一番追踪, 定位到了 &lt;code&gt;LuaStack::executeFunction&lt;/code&gt; 函数:&lt;/p&gt;
&lt;figure class=&quot;highlight c++&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;1&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;2&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;3&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;4&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;5&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;6&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;7&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;8&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;9&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;10&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;11&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;12&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;13&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;14&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;        &lt;span class=&quot;keyword&quot;&gt;if&lt;/span&gt; (error)&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;        &amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;            &lt;span class=&quot;keyword&quot;&gt;if&lt;/span&gt; (traceCallback == &lt;span class=&quot;number&quot;&gt;0&lt;/span&gt;)&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;            &amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;                CCLOG(&lt;span class=&quot;string&quot;&gt;&quot;[LUA ERROR] %s&quot;&lt;/span&gt;, lua_tostring(_state, - &lt;span class=&quot;number&quot;&gt;1&lt;/span&gt;));        &lt;span class=&quot;comment&quot;&gt;/* L: ... error */&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;                lua_pop(_state, &lt;span class=&quot;number&quot;&gt;1&lt;/span&gt;);                                        &lt;span class=&quot;comment&quot;&gt;// remove error message from stack&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;            &amp;#125;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;            &lt;span class=&quot;keyword&quot;&gt;else&lt;/span&gt;                                                           &lt;span class=&quot;comment&quot;&gt;/* L: ... G error */&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;            &amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;+               CCLOG(&lt;span class=&quot;string&quot;&gt;&quot;[LUA ERROR] %s&quot;&lt;/span&gt;, lua_tostring(_state, - &lt;span class=&quot;number&quot;&gt;2&lt;/span&gt;));        &lt;span class=&quot;comment&quot;&gt;/* L: ... error */&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;                lua_pop(_state, &lt;span class=&quot;number&quot;&gt;2&lt;/span&gt;);                                        &lt;span class=&quot;comment&quot;&gt;// remove __G__TRACKBACK__ and error message from stack&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;            &amp;#125;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;            &lt;span class=&quot;keyword&quot;&gt;return&lt;/span&gt; &lt;span class=&quot;number&quot;&gt;0&lt;/span&gt;;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;        &amp;#125;&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;
&lt;p&gt;虽然出错了, 但是 &lt;code&gt;traceCallback&lt;/code&gt; 的值并不等于 0, 所以没有进入输出错误的逻辑, 具体用意并不明白. 我的添加了带 &lt;code&gt;+&lt;/code&gt; 号的哪一行, 输出了下就可以看到 lua 的错误了.&lt;/p&gt;
&lt;h2 id=&quot;2-__u6EDA_u52A8_u540E_u5BFC_u81F4_u8282_u70B9_u4E0A_u6309_u94AE_u89E6_u6478_u5931_u6548&quot;&gt;&lt;a href=&quot;#2-__u6EDA_u52A8_u540E_u5BFC_u81F4_u8282_u70B9_u4E0A_u6309_u94AE_u89E6_u6478_u5931_u6548&quot; class=&quot;headerlink&quot; title=&quot;2. 滚动后导致节点上按钮触摸失效&quot;&gt;&lt;/a&gt;2. 滚动后导致节点上按钮触摸失效&lt;/h2&gt;&lt;p&gt;大家使用时可能会遇到这样的问题, 节点上有一个利用 quick 触摸机制实现的按钮, 在 TableView 滚动后触摸事件都会失效, 按钮无法被点击.&lt;/p&gt;
&lt;p&gt;这个实际上是 quick 触摸机制的一个bug, 复现是很容易的. 大家创建一个按钮并调用 &lt;code&gt;retain&lt;/code&gt;, 然后将这个按钮添加到父节点上, 在某个时候将按钮从父节点上移除 (&lt;code&gt;removeFromParent&lt;/code&gt;) 并再次添加(&lt;code&gt;addChild&lt;/code&gt;)上到父节点. 这时候按钮还在, 但是触摸事件已经没有了.&lt;/p&gt;
&lt;p&gt;究其原因是我们一般会在对象的 &lt;code&gt;ctor&lt;/code&gt; 函数中 &lt;code&gt;setTouchEnable&lt;/code&gt;, 然后 quick 在收到 &lt;code&gt;cleanup&lt;/code&gt; 事件后移除了对象触摸事件, 具体逻辑大家可以看 &lt;code&gt;Node:EventDispatcher&lt;/code&gt; 函数. 而一个节点从父节点上移除时恰好会发送 cleanup 事件.&lt;/p&gt;
&lt;p&gt;对应到 TableView 中来, TableViewCell 为了做到复用在 &lt;code&gt;dequeueCell&lt;/code&gt; 时会调用 &lt;code&gt;retain&lt;/code&gt; 函数, 并且在移出屏幕时会被从 Container 上移除掉的. 这样 TableViewCell 的所有子节点都会收到对应的 cleanup 事件.&lt;/p&gt;
&lt;p&gt;这个问题的解决方案恰好是我之前写的一篇文章, &lt;a href=&quot;/2015/05/17/onDestroy&quot;&gt;为 quick-cocos2d-x 添加析构事件&lt;/a&gt;, 在这篇文章中, 已经修改为收到 destroy 事件后才去移除节点的触摸事件, 非常完美的解决了这个问题.&lt;/p&gt;
&lt;blockquote&gt;
&lt;p&gt;Update: 2016-04-24&lt;/p&gt;
&lt;/blockquote&gt;
&lt;h2 id=&quot;3-__u906E_u6321_u4E0A_u5C42_u6309_u94AE_u89E6_u6478_u4E8B_u4EF6&quot;&gt;&lt;a href=&quot;#3-__u906E_u6321_u4E0A_u5C42_u6309_u94AE_u89E6_u6478_u4E8B_u4EF6&quot; class=&quot;headerlink&quot; title=&quot;3. 遮挡上层按钮触摸事件&quot;&gt;&lt;/a&gt;3. 遮挡上层按钮触摸事件&lt;/h2&gt;&lt;p&gt;经过这几天的使用, 我发现了一个十分严重的问题. 如下图所示, TableView 中的某个按钮拖出 ViewRect 范围后会不可见, 但如果其位置恰好在 TableView 外的另一个按钮范围内, 就会优先收到点击事件. 这就会引发十分奇怪的现象, TableView 外的按钮看得见点不着, TableView 内的按钮看不见却可以响应到, 十分影响体验.&lt;/p&gt;
&lt;p&gt;&lt;img src=&quot;http://ww4.sinaimg.cn/large/7f870d23gw1f381i7v2adj206c045glr.jpg&quot; alt=&quot;&quot;&gt;&lt;/p&gt;
&lt;p&gt;因为有着以往 cocos 2.x 的悲惨经历, 我非常武断的认为这肯定是 TableView 的 bug, 开始着手阅读 TableView 的代码实现, 却一直未果. 然而团队中另外一位成员 @小齐同学 的意外发现, 让这个问题的谜底在无意中就被揭开了.&lt;/p&gt;
&lt;p&gt;我们在项目中大量使用了 quick-x 提供的一个控件 &lt;code&gt;UIScrollView&lt;/code&gt;, 它是一个用 &lt;code&gt;ClippingRegionNode&lt;/code&gt; 纯 lua 实现的 &lt;code&gt;CCScrollView&lt;/code&gt;, 一直以来工作的十分良好. 但是在某一天 测试中, @齐少 意外的发现, 某个界面的 UIScrollView 出现了和 TableView 一模一样的问题, 导致上层按钮无法点击. 经过排查, 发现是因为 UIScrollView 的创建顺序被延后的原因, 如果一个按钮先于 UIScrollView 添加到父节点, 就会被 UIScrollView 中的按钮所屏蔽, 后添加则不会.&lt;/p&gt;
&lt;p&gt;当 @齐少 告诉我这个结论后, 我立刻意识到, TableView 遇到的问题肯定也是这个原因, 查看代码后果然如此, TableView 是最后被创建的. 解决方案也十分简单, 将 TableView 外部按钮放到 TableView 之后去创建就可以啦.&lt;/p&gt;
&lt;hr&gt;
&lt;p&gt;恩, 以上就是我在使用 TableView 时遇到的所有问题了, 虽然解决了这些问题, 但是在使用上还是十分的繁琐. 若是在一两个界面上使用可能还可以接受, 但若是想大规模推广就很有些困难了, 代码会变得十分冗长.&lt;/p&gt;
&lt;p&gt;在此基础上, 我们又对 TableView 进行了一次封装, 数据驱动, 使用时不用过分关注界面的逻辑, 中心更多的落在了数据的组织上, 真正的做到了 “开箱即用” , 等我们内部进行推广并稳定后可以再和大家分享下心得.&lt;/p&gt;
</content>
    
    <summary type="html">
    
      如何使用 TableView 这个效率提升利器? 
    
    </summary>
    
    
      <category term="Quick-Cocos2d-x" scheme="http://blog.justbilt.com/tags/Quick-Cocos2d-x/"/>
    
      <category term="TableView" scheme="http://blog.justbilt.com/tags/TableView/"/>
    
  </entry>
  
</feed>
