title: 游戏性能优化 - 界面篇
date: 2016-02-26 23:46:48
tags: 性能优化
---

最近几天都在做性能优化方面的事情, 关于优化, 之前的经验也都是泛泛而谈, 知道有几条路线可以走, 但一直没有去实践过. 所以刚开始搞的时候, 也是两眼一抹黑, 走了不少弯路, 最后也是受益匪浅, 这里记录一下我们的思路, 也是为下次优化提供一个可行的方案.


# 界面卡顿

在测试的时候, 界面卡顿十分严重, 主要分为三个方面, 分别是 **打开界面卡顿**, **操作界面卡顿**, **关闭界面卡顿** . 不开玩笑, 确实如此 ! 

## 打开界面

打开界面卡顿的主要原因是在界面 **初始化时做了太多的事情**, 比如: 一个界面有多个标签页, 为了不在点击切换标签时卡顿, 打开界面时初始化了所有的标签页. 这个其实没有必要, 不这样做的话可以将加载时间分摊到每次点击标签的时候, 再优化下标签页的初始化速度, 切换标签时就完全感觉不到卡顿的.

还有就是我们界面大量用到了 ScrollView , 如果子节点数量很多的话, 就会奇卡无比, 因为会在初始化时创建所有的子节点! 对于这个我们做了两点优化:

### 1. 优化子节点 node 数量
我们一个子节点可能有多个互斥的状态, 美术拼界面时会把所有的状态都拼在界面里, 程序再根据具体状态 setVisible , 这样就非常的浪费. 为此我们实现了在 ccb 中标记节点状态的功能, 所有不属于基本 ui 状态的节点树都不会被创建, 用到时候手动 init , 这个实现对性能的提升非常显著.

### 2. 针对性选择使用 TableView

我一般情况下不建议使用 TableView, 因为它的创建方式十分复杂, 使用起来也诸多不便, 更重要的是会破坏串行的ui创建逻辑. 但不得不承认, 某些情况下它对性能的提升非常有帮助, 尤其是在子节点的数量达到 30 个以上的时候, 简直是质的飞跃.

但是基于 TableView 十分难用, 加上 lua 这边逻辑出错后并不会抛出, debug 十分痛苦, 我们在原有自动布局的基础上又实现了一个快速布局 `FastLayout`, 它一开始只会创建屏幕范围内的子节点, 因此创建速度十分快. 但当子节点出屏幕时并不释放, 而是缓存住, 这样一旦拖动过再回来的话就会十分流畅. 目前的实现并不完美, 只能适用于数据不会发生变化的界面, 比如排行榜, 争取这周末修改下达到可用的状态.

### 3. 顶点数量巨多的界面加 loading 动画

这个 loading 不同于切换场景的 loading, 可以做的非常轻, 非常简单,用来避免同时渲染两个界面导致帧率剧降的情况. 可以一个门, 门关上时, 前一个界面就不渲染了, 这时在门的后面加载显示新的界面, 隐藏(自动剔除)旧的界面, 门打开, 这时只有新的界面会被渲染出来了.

可能同时渲染两个界面感觉不到这么明显的变化, 但是我们的前一个界面是大基地, 有将近 4000 个顶点, 150 多渲染批次, 这样就会十分明显了.

## 操作界面

经过分析, 卡顿的原因是每当有数据变化时就刷新整个界面, 这样完全就是一个偷懒的做法, 应当是哪里有数据变化就刷新哪里. 高端机可能觉察不到, 一到 Android 渣机就卡的跟够似得, 完全没法玩.

这里得出的经验就是, 平时测试的时候一定要使用渣机.

## 关闭界面

关闭界面时代码没有太大的问题, 发生卡顿原因是我们的关闭界面有一个动画, 整个层淡出并向下移动. 这样就会在动画的过程中露出下面的基地界面, 导致定点数剧增, 帧率骤降, 表现出来的现象就是 "三帧-咔咔咔".

解决方案也很简单, 去掉这个动画就可以了.


---

# 渲染批次和顶点数量

正如刚才提到的, 我们的一个 主基地+UI 的渲染批次就到了 250, 顶点数量更是惊人的到了 4000+ , 因此在低端机上, 无理论做什么都卡卡的.

| 节点类型 | 顶点数量 | 渲染批次 | 批量渲染 |
| --------   | -----:  | :----:  | :----: |
| cc.Node | 0 | 0 |
| cc.Layer | 0 | 0 |
| cc.LayerColor | 4 | 1 | × |
| cc.Sprite | 6 | 1 | √ |
| cc.Scale9Sprite | 6 | 1 | √ |
| cc.TTFLabel | 6 | 1 | × |
| cc.BMFontLabel | 6*n | 1 | × |
| cc.ParticleSystemQuad | 6*n | 1 | √ |

## 顶点数量

经过大致的测试, 我们发现导致顶点数据飙升的原因竟是 `Scale9Sprite`, 

