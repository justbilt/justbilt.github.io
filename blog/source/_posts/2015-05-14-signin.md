title: "signin"
date: 2015-05-14 16:04:39
tags:
---


之前的逻辑:

```
function ActivityData.calcSigninData(_data)
	local last = TimeUtil.getData(_data.signin.lastSigninTime)
	local first = TimeUtil.getData(_data.signin.firstLoginTime)
	local cur = TimeUtil.getData(TimeUtil.getCurrentTime())
	log.dump(last)
	log.dump(first)
	-- 签到天数
	_data.signin.signinTimes = cur.yday - first.yday + 1
	if cur.hour < 5 then
		_data.signin.signinTimes = _data.signin.signinTimes - 1
	end


	-- 能否签到
	_data.signin.couldSignin = false
	
	if cur.yday - last.yday > 1 then
		_data.signin.couldSignin = true
		return
	end

	if cur.yday - last.yday == 1 then
		if cur.hour > 5 or last.hour < 5 then
			_data.signin.couldSignin = true
		end
		return
	end

	if cur.yday - last.yday == 0 then
		if last.hour < 5 and cur.hour > 5 then
			_data.signin.couldSignin = true
		end
		return
	end
	assert(false)
end
```

修改后的逻辑
```
function TimeUtil.getRefreshDay(_time64)
    local data = TimeUtil.getData(_time64)
    local day = data.yday
    if data.hour < 5 then
        day = day - 1
    end
    return day
end

function ActivityData.calcSigninData(_data)
	-- 计算刷新日
	local last  = TimeUtil.getRefreshDay(_data.signin.lastSigninTime)
	local first = TimeUtil.getRefreshDay(_data.signin.firstLoginTime)
	local cur   = TimeUtil.getRefreshDay(TimeUtil.getCurrentTime())

	-- 签到天数
	_data.signin.signinTimes = cur - first
	-- 能否签到
	_data.signin.couldSignin = cur ~= last

	assert(cur>=last)
end
```