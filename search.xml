<?xml version="1.0" encoding="utf-8"?>
<search>
  
  
    
    <entry>
      <title><![CDATA[多说, 再见 !]]></title>
      <url>http://blog.justbilt.com/2017/03/25/bye-duoshuo-bye-comment/</url>
      <content type="html"><![CDATA[<p>大约是在前几天刷微博的时候看到有人说多说要关站了, 赶紧去备份评论 balabala … , 难以置信, 赶紧去我的邮箱找了下, 果然找到了这封邮件:</p>
<p><img src="https://ww3.sinaimg.cn/large/006tNbRwly1fdyu57rth7j30pi08bab4.jpg" alt=""></p>
<p>震惊 !!! 依然难以置信 !!!</p>
<p>我急忙把这个消息转发到了公司的微信群里, 却很快就被其他消息淹没, 没有激起一点浪花.</p>
<p><img src="https://ww2.sinaimg.cn/large/006tNbRwly1fdyuh2osr9j30bu0j2gmh.jpg" alt=""></p>
<p>他们可能也很奇怪, 多说是什么鬼, 关闭了和我有什么关系 ? 嗯哪, 毕竟写博和读博都只是小众的需求.</p>
<p>将时间拨回 2013 年, 那时我刚把博客从 WordPress 切换到 hexo, 那时 hexo 的默认评论还是 disqus 呢, 由于众所周知的原因, 速度非常慢. 经过一番查找, 选择了多说, 速度快, 还支持国内的各种社交账号登录, 免费, 很良心.</p>
<p><img src="https://ww4.sinaimg.cn/large/006tNbRwly1fdyujgpr90j30um0kk0wp.jpg" alt=""></p>
<p>我在新博客写的第一篇文章是 <a href="/2013/11/03/elbow/">&lt;&lt;弯管(拐角)对方向的改变&gt;&gt;</a> ,时间 <code>2013/11/03</code>, 收到的第一条评论是:</p>
<p><img src="https://ww4.sinaimg.cn/large/006tNbRwly1fdyuxow26aj30nf022weq.jpg" alt=""></p>
<p>是 firedragonpzy 兄发来的[给力], 这么多年过去了, 不知他现在做什么?　</p>
<p>最后一篇有多说评论的文章是 <a href="/2017/02/24/some-change-for-blog/">&lt;&lt;最近博客的一些变化&gt;&gt;</a>, 时间 <code>2017/02/24</code>, 是回复山人的吐槽:</p>
<p><img src="https://ww4.sinaimg.cn/large/006tNbRwly1fdyv73hz7fj30ng040aai.jpg" alt=""></p>
<p>所以, 你以为多说的关闭意味着什么 ? </p>
<blockquote>
<p>那时 cocos2d-x 还十分火爆,<br>那时我还在用 c++,<br>那年我才 21 岁.</p>
</blockquote>
]]></content>
    </entry>
    
    <entry>
      <title><![CDATA[最近搞 iOS 版遇到的一些问题和技巧 (四)]]></title>
      <url>http://blog.justbilt.com/2017/03/12/ios-dev-tips-4/</url>
      <content type="html"><![CDATA[<p>这是这半年搞 iOS 时遇到的一些问题, 写下来, 希望会帮到大家. 因为时间精力有限, 有些问题, 并没有解决方案, 只是饶了过去.</p>
<h2 id="u4E00-_iOS__u6C99_u76D2_u6D4B_u8BD5__u65E0_u6CD5_u8FDE_u63A5_u5230APPSTORE"><a href="#u4E00-_iOS__u6C99_u76D2_u6D4B_u8BD5__u65E0_u6CD5_u8FDE_u63A5_u5230APPSTORE" class="headerlink" title="一. iOS 沙盒测试 无法连接到APPSTORE"></a>一. iOS 沙盒测试 无法连接到APPSTORE</h2><p>确定是测试机, 沙盒账号登录的也没有问题, 就是无法充值.</p>
<h3 id="u89E3_u51B3_u65B9_u6848"><a href="#u89E3_u51B3_u65B9_u6848" class="headerlink" title="解决方案"></a>解决方案</h3><p>换了一个测试机就好了</p>
<h2 id="u4E8C-_xcodebuilder_-exportArchive_dev__u5931_u8D25"><a href="#u4E8C-_xcodebuilder_-exportArchive_dev__u5931_u8D25" class="headerlink" title="二. xcodebuilder -exportArchive dev 失败"></a>二. xcodebuilder -exportArchive dev 失败</h2><p>这个问题发生在我们的 iOS 打包脚本中, 会报错:</p>
<blockquote>
<p>IDEDistribution: Step failed: <idedistributionthinningstep: 0x7fa72bbd50e0="">: Error Domain=IDEDistributionErrorDomain Code=14 “No applicable devices found.”</idedistributionthinningstep:></p>
</blockquote>
<h3 id="u89E3_u51B3_u65B9_u6848-1"><a href="#u89E3_u51B3_u65B9_u6848-1" class="headerlink" title="解决方案"></a>解决方案</h3><p>一开始我使用了老的 ipa 导出方案 <code>xcrun -sdk iphoneos PackageApplication</code> , 这样虽然可以导出了, 但是经常无法安装到测试机, 还得用 XCode 打开归档文件手动导出 dev 版本. 就这样凑活了一段时间后, 我终于下定决心解决这个问题了. 原来每次 <code>exportArchive</code> 会有有一个日志文件, 查看 /var/folders/…/IDEDistribution.standard.log 得知是我的 ruby 环境有问题:</p>
<figure class="highlight md"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">[NOTE]</span><br><span class="line">You may have encountered a bug in the Ruby interpreter or extension libraries.</span><br><span class="line">Bug reports are welcome.</span><br><span class="line">Don't forget to include the above Crash Report log file.</span><br><span class="line">For details: http://www.ruby-lang.org/bugreport.html</span><br></pre></td></tr></table></figure>
<p>在 StackOverflow 上找到了<a href="http://stackoverflow.com/questions/39634404/xcodebuild-exportarchive-no-applicable-devices-found/42027456#42027456" target="_blank" rel="external">这个解决方案</a>, 使用 <code>xcbuild-safe.sh</code> 替换 <code>xcodebuilder</code> 就好了</p>
<h2 id="u4E09-_You_must_supply_a_CFBundleIdentifier_for_this_request"><a href="#u4E09-_You_must_supply_a_CFBundleIdentifier_for_this_request" class="headerlink" title="三. You must supply a CFBundleIdentifier for this request"></a>三. You must supply a CFBundleIdentifier for this request</h2><p>上传 dis 包时遇到这个错误:</p>
<p><img src="https://ww3.sinaimg.cn/large/006tNbRwly1fdjuz90b3cj30w40g2aar.jpg" alt=""></p>
<h3 id="u89E3_u51B3_u65B9_u6848-2"><a href="#u89E3_u51B3_u65B9_u6848-2" class="headerlink" title="解决方案"></a>解决方案</h3><p>在<a href="http://www.jianshu.com/p/2d229dfb34a6" target="_blank" rel="external">这篇文章</a>中找到了解决方案:</p>
<blockquote>
<p>infor.plist表中Bundle OS Type code 栏为空或者非APPL<br>具体设置路径为，项目的TARGETS &gt;&gt; infor &gt;&gt; Custom iOS Target Properties &gt;&gt; Bundle OS Type code，检查是否为空或者其他。将该选项设置为 APPL。自此，重新上传成功。</p>
</blockquote>
<p>虽然解决了, 但是比较奇怪的是, 我好多项目没有设置也可以上传成功.</p>
<h2 id="u56DB-__u8FDE_u63A5_VPN__u540E_u6709_u7684_http__u8BF7_u6C42_u4F1A_u5931_u8D25"><a href="#u56DB-__u8FDE_u63A5_VPN__u540E_u6709_u7684_http__u8BF7_u6C42_u4F1A_u5931_u8D25" class="headerlink" title="四. 连接 VPN 后有的 http 请求会失败"></a>四. 连接 VPN 后有的 http 请求会失败</h2><p>这个很诡异呀, 不连接 VPN 没有任何问题.</p>
<h3 id="u89E3_u51B3_u65B9_u6848-3"><a href="#u89E3_u51B3_u65B9_u6848-3" class="headerlink" title="解决方案"></a>解决方案</h3><p>我在 Exception Domain 添加对应域名之后就可以访问了. 猜测是不是果爹对大陆 ip 放宽了要求 ? 哈哈哈</p>
<h2 id="u4E94-_This_action_could_not_be_completed-Try_again-_28-22421_29"><a href="#u4E94-_This_action_could_not_be_completed-Try_again-_28-22421_29" class="headerlink" title="五. This action could not be completed.Try again.(-22421)"></a>五. This action could not be completed.Try again.(-22421)</h2><p>还是上传 dis 包到 iTunes 后台的时候, 会遇到这个错误:</p>
<p><img src="https://ww2.sinaimg.cn/large/006tNbRwly1fdjv6l9qzij30dh038wep.jpg" alt=""></p>
<h3 id="u89E3_u51B3_u65B9_u6848-4"><a href="#u89E3_u51B3_u65B9_u6848-4" class="headerlink" title="解决方案"></a>解决方案</h3><p>在<a href="http://www.jianshu.com/p/a9f818ac1066" target="_blank" rel="external">这篇文章</a>中找到了解决方案:</p>
<blockquote>
<p>暂时请使用 -Application Loader上传app程序</p>
</blockquote>
<h2 id="u516D-_iOS__u6C99_u76D2_u6D4B_u8BD5_u5145_u503C_u4E00_u6B21_u6210_u529F_2C__u4E00_u6B21_u5931_u8D25"><a href="#u516D-_iOS__u6C99_u76D2_u6D4B_u8BD5_u5145_u503C_u4E00_u6B21_u6210_u529F_2C__u4E00_u6B21_u5931_u8D25" class="headerlink" title="六. iOS 沙盒测试充值一次成功, 一次失败"></a>六. iOS 沙盒测试充值一次成功, 一次失败</h2><p>在沙盒测试充值时, 这次失败了, 下次就会成功, 主要发生在小面额的充值项上.</p>
<h3 id="u89E3_u51B3_u65B9_u6848-5"><a href="#u89E3_u51B3_u65B9_u6848-5" class="headerlink" title="解决方案"></a>解决方案</h3><p><img src="https://ww2.sinaimg.cn/large/006tNbRwly1fdjvcfmifbj31as0foq6c.jpg" alt=""></p>
<p>苹果商店抽风, 没啥解决方案.</p>
<h2 id="u516D-__u82F9_u679C_u63D0_u4EA4_u5BA1_u6838_uFF0C_u56E0_u4E3A_u5E94_u7528_u540D_u79F0_u4E0D_u5408_u6CD5_u88AB_u62D2_uFF0C_u6539_u5B8C_u63D0_u4EA4_u8FD8_u662F_u88AB_u62D2"><a href="#u516D-__u82F9_u679C_u63D0_u4EA4_u5BA1_u6838_uFF0C_u56E0_u4E3A_u5E94_u7528_u540D_u79F0_u4E0D_u5408_u6CD5_u88AB_u62D2_uFF0C_u6539_u5B8C_u63D0_u4EA4_u8FD8_u662F_u88AB_u62D2" class="headerlink" title="六. 苹果提交审核，因为应用名称不合法被拒，改完提交还是被拒"></a>六. 苹果提交审核，因为应用名称不合法被拒，改完提交还是被拒</h2><p>这个是苹果的回复:</p>
<blockquote>
<p>We still find that your app name to be displayed on the App Store includes descriptors, which are not appropriate for use in an app name.<br>Specifically, the following words in your app names are considered descriptors</p>
</blockquote>
<h3 id="u89E3_u51B3_u65B9_u6848-6"><a href="#u89E3_u51B3_u65B9_u6848-6" class="headerlink" title="解决方案"></a>解决方案</h3><p>可以查看是否在iTunes connect 后台添加了多个语言，而只修改了一种语言。</p>
<h2 id="u4E03-_XCode__u5B89_u88C5_u5E94_u7528_u51FA_u9519"><a href="#u4E03-_XCode__u5B89_u88C5_u5E94_u7528_u51FA_u9519" class="headerlink" title="七. XCode 安装应用出错"></a>七. XCode 安装应用出错</h2><p>这个是错误内容:</p>
<blockquote>
<p>This application’s application-identifier entitlement does not match that of the installed application. These values must match for an upgrade to be allowed.</p>
</blockquote>
<h3 id="u89E3_u51B3_u65B9_u6848-7"><a href="#u89E3_u51B3_u65B9_u6848-7" class="headerlink" title="解决方案"></a>解决方案</h3><p>删除手机上已经安装的应用就好了</p>
]]></content>
    </entry>
    
    <entry>
      <title><![CDATA[Quick-Cocos2d-x 中的面向对象]]></title>
      <url>http://blog.justbilt.com/2017/03/04/quick-x-oop/</url>
      <content type="html"><![CDATA[<p>虽说现在一直提倡组合优于继承, 但是我们这帮深受 c++ 毒害的大好青年还是对继承有着深深的感情. Lua 这门语言本身并没有提供面向对象的机制, 不过我们可以很容易的通过 Lua 的 metatable 来实现一套面向对象的机制.</p>
<h1 id="u4E00-__u5B9E_u73B0_u673A_u5236"><a href="#u4E00-__u5B9E_u73B0_u673A_u5236" class="headerlink" title="一. 实现机制"></a>一. 实现机制</h1><p>实现的原理很简单, 如果一个 Lua 的 table1 通过 <code>setmetatable</code> 函数设置了元表之后, 如果试图访问一个不存在的 <code>属性</code>, 就会触发这个 metatable 的 <code>__index</code> 元方法, 这个 __index 可以是另一个 table2 , 这样它就回去这个 table2 中去找那个属性了, 如果 table2 中还没有的话, 就会触发 table2 的元方法, 就这样一层一层的往上找. 我们可以用一个十分简单的栗子来测试下这个功能:</p>
<figure class="highlight lua"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">local</span> a = &#123;aa = <span class="number">1</span>&#125;</span><br><span class="line"><span class="keyword">local</span> b = &#123;bb = <span class="number">2</span>&#125;</span><br><span class="line"><span class="keyword">local</span> c = &#123;cc = <span class="number">3</span>&#125;</span><br><span class="line"></span><br><span class="line"><span class="built_in">setmetatable</span>(b, &#123;__index = a&#125;)</span><br><span class="line"><span class="built_in">setmetatable</span>(c, &#123;__index = b&#125;)</span><br><span class="line"></span><br><span class="line"><span class="built_in">print</span>(<span class="string">"aa:"</span>, c.aa, <span class="string">"bb:"</span>, c.bb, <span class="string">"cc"</span>, c.cc) <span class="comment">-- output: aa:  1   bb: 2   cc  3</span></span><br></pre></td></tr></table></figure>
<p>如上, 只是加了两个 <code>setmetatable</code>, c 便可以访问到 a 和 b 的属性, 是不是很神奇.</p>
<h1 id="u4E8C-_Quick-x__u4E2D_u7684_u5B9E_u73B0"><a href="#u4E8C-_Quick-x__u4E2D_u7684_u5B9E_u73B0" class="headerlink" title="二. Quick-x 中的实现"></a>二. Quick-x 中的实现</h1><p>Quick-x 作为一个 framework 自然也实现了一套这样的机制, 因为函数实现比较长, 所以我就不粘贴代码了, 大家可以<a href="https://github.com/chukong/quick-cocos2d-x/blob/master/framework/functions.lua#L281-L339" target="_blank" rel="external">跳转这里查看</a>. 纵观这段代码, 可以以最外层的 <code>if-else</code> 将这段逻辑分成两部分, 继承自 Cocos 的对象和继承自 Lua 的 Table, 为什么要这么分呢 ?</p>
<p>因为 Cocos 的对象在 Lua 中的 type 是 <code>userdata</code>, 是不能设置 metatable 的, 所以我们之前说的那套继承的方法就行不通了, Quick-x 在这里的选择是把所有的变量都复制一份, 做了一次一维的深拷贝. </p>
<p>所以, 抛开继承的实现不同, 这两个分支的逻辑是一致的. 我们精简下, 可以分离出下面这段简短的代码:</p>
<figure class="highlight lua"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">class</span><span class="params">(_name, _super)</span></span></span><br><span class="line">    <span class="keyword">local</span> cls = &#123;__cname = _name, super = _super&#125;</span><br><span class="line">    <span class="keyword">if</span> _super <span class="keyword">then</span></span><br><span class="line">        <span class="built_in">setmetatable</span>(cls, &#123;__index = _super&#125;)</span><br><span class="line">    <span class="keyword">else</span></span><br><span class="line">        cls.ctor = <span class="function"><span class="keyword">function</span><span class="params">()</span></span><span class="keyword">end</span></span><br><span class="line">    <span class="keyword">end</span></span><br><span class="line">    <span class="function"><span class="keyword">function</span> <span class="title">cls.new</span><span class="params">(...)</span></span></span><br><span class="line">        <span class="keyword">local</span> instance = <span class="built_in">setmetatable</span>(&#123;&#125;, &#123;__index = cls&#125;)</span><br><span class="line">        instance:ctor(...)</span><br><span class="line">        <span class="keyword">return</span> instance</span><br><span class="line">    <span class="keyword">end</span></span><br><span class="line">    <span class="keyword">return</span> cls</span><br><span class="line"><span class="keyword">end</span></span><br></pre></td></tr></table></figure>
<p>这短短十几行代码几乎已经包含了面向对象的所有特性, 有实例函数 <code>new</code>, 有默认构造函数 <code>ctor</code>, 可以访问父类 <code>super</code>. </p>
<p>大家可以看到这段代码有两次 <code>setmetatable</code>, 第一次是在创建 cls 的时候, 是为了让 cls 能够访问到 super 中的属性; 第二次是在产生实例 <code>instance</code> 的时候, 是为了让实例能够访问到 cls 中的属性. </p>
<h1 id="u4E09-__u8981_u6CE8_u610F_u7684_u5730_u65B9"><a href="#u4E09-__u8981_u6CE8_u610F_u7684_u5730_u65B9" class="headerlink" title="三. 要注意的地方"></a>三. 要注意的地方</h1><p>下面这段代码是一个典型的面向对象示例:</p>
<figure class="highlight lua"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">local</span> Animal = class(<span class="string">"Animal"</span>)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">Animal:ctor</span><span class="params">(_name)</span></span></span><br><span class="line">    self.name = _name</span><br><span class="line"><span class="keyword">end</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">Animal:say</span><span class="params">()</span></span></span><br><span class="line">    <span class="built_in">print</span>(<span class="string">"i couldn't say!"</span>)</span><br><span class="line"><span class="keyword">end</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">local</span> Dog = class(<span class="string">"Dog"</span>, Animal)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">Dog:ctor</span><span class="params">(_name, _age)</span></span></span><br><span class="line">    Dog.super.ctor(self, _name)</span><br><span class="line">    self.age = _age</span><br><span class="line"><span class="keyword">end</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">Dog:say</span><span class="params">()</span></span></span><br><span class="line">    <span class="built_in">print</span>(<span class="built_in">string</span>.format(<span class="string">"I'm a %s, my name is %s, i'm %s years old."</span>, self.__cname, self.name, self.age))</span><br><span class="line"><span class="keyword">end</span></span><br><span class="line"></span><br><span class="line">Dog.new(<span class="string">"Jack"</span>, <span class="number">5</span>):say()</span><br></pre></td></tr></table></figure>
<p>我们重点看下第 <code>14</code> 行代码, 这行代码有些奇怪.</p>
<h2 id="1-__u4E3A_u4EC0_u4E48_u7528_u7C7B_u540D_u53BB_u8C03_u7528_super__3F"><a href="#1-__u4E3A_u4EC0_u4E48_u7528_u7C7B_u540D_u53BB_u8C03_u7528_super__3F" class="headerlink" title="1. 为什么用类名去调用 super ?"></a>1. 为什么用类名去调用 super ?</h2><p>当继承到第三层的时候 self.super 从 C 跳转到 B 时 self 还是 C 的实例, 这时 B 中 self.super 其实还 B, 就会造成 stack overflow.</p>
<h2 id="2-__u4E3A_u4EC0_u4E48_u662F_u7C7B_u540D_-_super__u800C_u4E0D_u662F__3A_super__3F"><a href="#2-__u4E3A_u4EC0_u4E48_u662F_u7C7B_u540D_-_super__u800C_u4E0D_u662F__3A_super__3F" class="headerlink" title="2. 为什么是类名 . super 而不是 : super ?"></a>2. 为什么是类名 <code>.</code> super 而不是 <code>:</code> super ?</h2><p>首先大家要明白 Lua 中 <code>.</code> 和 <code>:</code> 调用函数的区别是什么 ?</p>
<blockquote>
<p>冒号调用是 Lua 提供的一个语法糖, 默认会将函数的调用者作为第一个参数传入.</p>
</blockquote>
<p>区别在于父类的函数收到的 self 是 <code>self</code> (即 Dog 的实例) 还是 <code>Dog.super</code> (即 Animal) , 很明显应该是后者.</p>
<h1 id="u56DB-__u6709_u4EC0_u4E48_u6539_u8FDB_u7684_u5730_u65B9"><a href="#u56DB-__u6709_u4EC0_u4E48_u6539_u8FDB_u7684_u5730_u65B9" class="headerlink" title="四. 有什么改进的地方"></a>四. 有什么改进的地方</h1><p>很早之前就拜读过<a href="http://jennal.com/2014/10/18/cocos2dx-lua-oop/" target="_blank" rel="external">这篇文章</a>, 这篇文章中列举了一些作者的疑惑, 很有收获, 大家可以看一下. 文章中提出了两条:</p>
<blockquote>
<p>问题1：从父类做深度拷贝<br>问题4：创建实例时的深度拷贝</p>
</blockquote>
<p>作者当时可能忽略了我们刚才做的解释: <em>无法向一个 userdata 设置 metatable</em> , 那么我们这里是否真的需要一次深拷贝呢 ? 让我们先思考一个问题:</p>
<blockquote>
<p>既然 Cocos 的对象是一个 <code>userdata</code>, 那么我们为什么可以往这个 userdata 上添加新的 Lua 属性呢 ?</p>
</blockquote>
<p>Quick-x 为 C++ 导出 Lua 接口的工具是 tolua++ , 其中有两个接口叫: <code>tolua.setpeer</code> 和 <code>tolua.gerpeer</code> , 这个 peer 又是一个什么东西呢 ?</p>
<p><img src="https://ww1.sinaimg.cn/large/006tNc79ly1fdbsvt09tnj313o08ewg5.jpg" alt=""></p>
<p>这张图是六月大大在 Cocos 论坛中的回复, 我们可以理解为 <code>peer</code> 是用来存储 C++ 对象在 Lua 中的扩展的, 他的本质是一个 table. 如果我们试图访问一个 userdata 类型的属性时, 如果这个 userdata 设置了 peer 表, 会优先从这个表中取值.</p>
<p>既然这个 <code>peer</code> 是一个 table, 那么是否可以为这个 table 设置元表, 这样在 peer 表中找不到就会触发 __index .</p>
<p>我们对 class 的实现做出下面的修改:</p>
<p><img src="https://ww3.sinaimg.cn/large/006tNbRwly1fdbtiv4cbaj30v009i3zv.jpg" alt=""></p>
<p>用设置 peer 表的 metatable 来代替原来的深拷贝, 重新运行我们的项目, 完美. 让我们想想下这个实现带来的优势: <strong>更快, 更省内存</strong>, 为此我做了一个小的性能测试:</p>
<figure class="highlight lua"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">local</span> A = class(<span class="string">"A"</span>, <span class="function"><span class="keyword">function</span><span class="params">()</span></span></span><br><span class="line">    <span class="keyword">return</span> cc.Node:create()</span><br><span class="line"><span class="keyword">end</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> i = <span class="number">1</span>, <span class="number">100</span> <span class="keyword">do</span></span><br><span class="line">    A[<span class="string">"a_index_"</span>..i] = i</span><br><span class="line"><span class="keyword">end</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">local</span> B = class(<span class="string">"B"</span>, A)</span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> i = <span class="number">1</span>, <span class="number">100</span> <span class="keyword">do</span></span><br><span class="line">    B[<span class="string">"b_index_"</span>..i] = i</span><br><span class="line"><span class="keyword">end</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> i=<span class="number">1</span>,<span class="number">10000</span> <span class="keyword">do</span></span><br><span class="line">    B.new()</span><br><span class="line"><span class="keyword">end</span></span><br></pre></td></tr></table></figure>
<p>我设计了 A,B 两个类, B 继承自 A, 每个各有 100 个成员变量, 最后创建 10000 个 B 的实例. 统计了下内存的占用情况和耗时. 结果如下:</p>
<figure class="highlight lua"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">深拷贝:</span><br><span class="line">耗时: <span class="number">2.988687</span></span><br><span class="line">内存: <span class="number">134.1</span>M</span><br><span class="line"></span><br><span class="line"><span class="built_in">setmetatable</span>:</span><br><span class="line">耗时: <span class="number">0.107388</span></span><br><span class="line">内存: <span class="number">38.9</span>M</span><br></pre></td></tr></table></figure>
<p>这个相差很多呀, 感觉自己马上就要走上人生巅峰了. 既然相差这么多, 而廖大貌似也早已发现了这个问题:</p>
<p><img src="https://ww3.sinaimg.cn/large/006tNbRwly1fdbv2g5bfoj30m208mjs8.jpg" alt=""></p>
<p>为什么直到 3.3 版本还没有改动呢 ? 莫非是我哪里计算错了, 抛开测试, 我在我们的一个线上项目中做了一个真是的测试, 结果令我大跌眼镜.</p>
<blockquote>
<p>相差无几</p>
</blockquote>
<p>仔细想了下, 是否每一个对象都会有 100 个属性, 游戏内是否会同时存在 1w 个对象 ? 所以那份测试是没有意义的, 但是这个改动却是很有意义的.</p>
<p>其实在发现 peer 表之前, 我还做过另一个尝试, 对于 userdata 类型的实例, 不返回这个实例, 而是返回一个 table, 有一个属性 <code>_cobj</code> , 设置这个 table 的元表, 使得所有的属性都优先从 <code>_cobj</code> 中取, 取不到再去 super 中取, 后来因为改动太大, 就放弃了, 不过在这个改动的过程中意外的发现 peer 表的存在.</p>
<p>多折腾, 总会有所收获的.</p>
]]></content>
    </entry>
    
    <entry>
      <title><![CDATA[最近博客的一些变化]]></title>
      <url>http://blog.justbilt.com/2017/02/24/some-change-for-blog/</url>
      <content type="html"><![CDATA[<p>虽然最近博客的产量不高, 但是折腾的比较多. 而且每次折腾完都会有一些新的素材, 这样又可以对付一篇博客出来啦. 逃)</p>
<h1 id="u4E00-__u4E3B_u9898"><a href="#u4E00-__u4E3B_u9898" class="headerlink" title="一. 主题"></a>一. 主题</h1><p>我不是在换主题, 就是在换主题的路上. 以至于子龙山人经常会问我:”你又换博客啦?”, 并没有, 只是换了个主题而已.</p>
<p>我换主题疯狂到什么程度呢? 几乎 <a href="https://hexo.io/themes/" target="_blank" rel="external">Hexo 主题页</a>的我都尝试过, 很多不好看的简单尝试了下就放弃了, 好看的呢我又会改一改, 按照自己的喜好定制一些东西. 只可惜之前的主题都没有截图留念下, 否则还能拿出来装个逼.</p>
<p><img src="/assets/themes-screenshot/01-raytaylorism.png" alt=""></p>
<p>目前这个主题 <code>raytaylorism</code> 简单修改了下 配色, 字体, 和一点样式, 感觉还不错, 应该可以挺一段时间.</p>
<h1 id="u4E8C-__u79FB_u52A8_u7AEF_u5199_u4F5C"><a href="#u4E8C-__u79FB_u52A8_u7AEF_u5199_u4F5C" class="headerlink" title="二. 移动端写作"></a>二. 移动端写作</h1><p>上篇文章我尝试了下在我的 Android 手机上书写, 用到了两个应用分别是 <code>Pocker Git</code> 和 <code>JotterPad</code> . 前者负责博客的 git 拉取和推送, 后者负责编辑, 两个应用都很给力, 配合的也很好, 虽然还有一些小瑕疵, 但着实已经是免费的解决方案中最佳之选了.</p>
<p><img src="https://ww4.sinaimg.cn/large/006tNc79ly1fd0xcj3fmhj31kw0nyh5e.jpg" alt=""></p>
<h1 id="u4E09-__u8BBF_u95EE_u52A0_u901F"><a href="#u4E09-__u8BBF_u95EE_u52A0_u901F" class="headerlink" title="三. 访问加速"></a>三. 访问加速</h1><p>说的好像很高大上, 做起来特别简单. 之前博客是托管在 github 之上的, 但是由于一些众所周知的原因, 访问速度不是很理想, 甚至可能访问不了. 国内也有类似的免费托管方案 (coding), 但是外国友人若是想看俺写的文章咱办 ? 能不能国外网络走 github, 国内走 coding 呢?</p>
<p>是可以的, 而且配置起来超级简单, 动动手指的功夫就解决了. 我基本上是照着<a href="http://yumemor.com/2016/04/24/Github-Pages-%E6%9C%8D%E5%8A%A1%E5%A4%AA%E6%85%A2%EF%BC%9F%E6%9D%A5%E8%AF%95%E8%AF%95%E5%88%86%E6%B5%81%E5%90%A7/" target="_blank" rel="external">这个教程</a>搞的, 但是这个教程有些老, coding 他们改版的很快, 大家自己配合教程琢磨下就可以了.</p>
<p>弄完之后, 访问博客速度<strong>嗷嗷的</strong>, 感谢 coding 提供这么好的服务, 还是免费的, 良心企业.</p>
<h1 id="u56DB-__u56FE_u7247_u4E0A_u4F20"><a href="#u56DB-__u56FE_u7247_u4E0A_u4F20" class="headerlink" title="四. 图片上传"></a>四. 图片上传</h1><p>不知道大家之前博客配图是怎么搞的, 我之前是这么个流程:</p>
<blockquote>
<p>准备图片 &gt; 打开 chrome 微博图床插件 &gt; 把图片拖拽上去 &gt; 复制网址 &gt; 返回编辑器粘贴网址</p>
</blockquote>
<p>过程还是略繁琐, 直到我发现了神器 <code>iPic</code> , 复制图片后直接 <code>cmd + shift + u</code> 等待上传完毕就可以获得网址了.</p>
<p><img src="https://ww3.sinaimg.cn/large/006tNc79ly1fd0xv8mhqzj30c009u0tk.jpg" alt=""></p>
<p>超级方便, 超级省心, 绝对是让生命更有意义的工具.</p>
<hr>
<p>有了这么多牛逼的东西, 还有什么理由不好好写博客呢 ?</p>
]]></content>
    </entry>
    
    <entry>
      <title><![CDATA[充实而又愉快的 2016]]></title>
      <url>http://blog.justbilt.com/2017/02/18/my-2016/</url>
      <content type="html"><![CDATA[<p>以往的年结大家感兴趣的话可以看这里: <a href="http://blog.justbilt.com/categories/%E5%B9%B4%E7%BB%93/">我的年结</a>, 这篇是第四篇了. 我大约是 2012 年正式开始写博客的, 时光荏苒, 已经过去5年了, 期间经历过一次大的迁移, 觉得最开始的博客太没有技术含量, 所以就都丢弃了. </p>
<p>值得肯定的是, 这次的年结是写的最早的一次 ! (此处应有掌声👏) 拖延病患者的一小步, 社会的一大步 !</p>
<hr>
<h1 id="u4E00-__u5DE5_u4F5C"><a href="#u4E00-__u5DE5_u4F5C" class="headerlink" title="一. 工作"></a>一. 工作</h1><h2 id="C__u516C_u53F8__282015-7__7E__u4ECA_29"><a href="#C__u516C_u53F8__282015-7__7E__u4ECA_29" class="headerlink" title="C 公司 (2015.7 ~ 今)"></a>C 公司 (2015.7 ~ 今)</h2><p>算下来, 我在 C 已经呆了一年半多的时间了, 如果要用一个字来形容我的感受, 那就是 <code>爽</code> . 去年我对 C 的介绍并不多, 当时的体验并不久, 今年终于可以来说一说了, 仔细想来 C 这样的团队才是我心目中理想的团队:</p>
<blockquote>
<p>不计考勤, 周末双休<br>有一顿免费晚饭, 两大包 3M 口罩, 三个空气净化器<br>技术驱动, 效率优先<br>老板很牛逼, 团队无弱者</p>
</blockquote>
<p>这里面最重要的是 <em>老板很牛逼, 团队无弱者</em>, 在 C 你经常可以看到策划同学在改后端战斗逻辑, 测试同学在用按键精灵写自动测试脚本, UE 妹子听得懂程序逻辑还兼着客服+运营, UI 设计师和前端讨论这个界面拼的合理性. 两位老板 (@bin, @jinbo) 更是牛逼, 他们就是我心目中的两尊神, 我就不夸他们了, 免得被认为在吹牛逼.</p>
<p><img src="https://ww4.sinaimg.cn/large/006tNc79ly1fcufng11glj30zk0qdact.jpg" alt="年中去轰趴"></p>
<p><img src="https://ww3.sinaimg.cn/large/006tNc79ly1fcufg12hhjj30zk0qo0xq.jpg" alt="年夜饭"></p>
<p>这一年间, 公司来了一些人, 也走了一些人, 对于有些人还是十分不舍的, 但是每个人都有自己的选择, 强扭的瓜不甜. </p>
<p>公司年夜饭这一天, 我喝的酩酊大醉, 为现在的这些人, 也为离开那些人 !</p>
<h1 id="u4E8C-__u6280_u672F"><a href="#u4E8C-__u6280_u672F" class="headerlink" title="二. 技术"></a>二. 技术</h1><p>关于技术, 这一年没有往广度去发展了, 更多对之前技术的巩固和项目后期的一些理解. 这一年语言的技术栈主要还是 <code>lua + python + shell</code>, lua 用来做项目, python 和 shell 用来写支持.</p>
<h2 id="Android_Studio"><a href="#Android_Studio" class="headerlink" title="Android Studio"></a>Android Studio</h2><p>2016 年最大收获之一就是它了, 接触它是一个很机缘巧合事情, 我们打算接入一个崩溃统计的 SDK , 但是这个 SDK 只支持 Android Studio (以后简称 AS) 接入, 我们会为了一个 sdk 改变整个 Android 项目的结构吗 ? 会 . 现在还依稀记得当时十分没底气的很 @bin 说: </p>
<blockquote>
<p>“我们能不能换一个 Android 的 ide ?”</p>
</blockquote>
<p>当时 Android 端的项目还不是很复杂，在 bin 的支持下，很快便迁移到了 AS ，直到后面我们团队在一周之内接完 30+ 个渠道的 sdk ，才意识到了当初的选择是多么的明智.</p>
<p>当然这一路并不是顺风顺水，也遇到了很多坑，幸好 Google 在大力推 as ，遇到的坑在 Stack Overflow 上也都有答案。</p>
<p>感谢 Bugtags ，感谢 Android studio 。关于崩溃统计的问题，我有空会单独开一篇文章来写。</p>
<h2 id="u9879_u76EE"><a href="#u9879_u76EE" class="headerlink" title="项目"></a>项目</h2><p>就项目来说，也可谓是 “活久见”，我工作了这么多年，第一次走到项目的大后期。之前的项目多数倒在了上线前或上线后不久，没有想到上线后竟然也有这么多的问题。</p>
<p>也遇到了几次重大的线上事故，可谓是心惊肉跳，我们都开玩笑说公司应该常备速效救心丸。</p>
<p>优化包体积，优化内存，优化性能 这些之前纸上谈兵的方案也得到了新的诠释。</p>
<p>而且随着项目的不断推进，之前好多技术方案都不能满足需求，比如热更新，打包，国际化与本地化等等。</p>
<h2 id="u56E2_u961F"><a href="#u56E2_u961F" class="headerlink" title="团队"></a>团队</h2><p>从 16 年初，我之前和另一人负责的哪个项目遇到挫折，因为收费太过后期，加上模型产品太过强盛，没有发行公司敢于正面怼，所以就搁置了。另一个同事离职，我加入到了公司的另一个项目组内，这是一个非常年轻且有激情的团队，但是大家经验略有不足，便由我这个“老人”来带领这个团队。</p>
<p>工作了这么久，几乎是第一次正是的带领团队，心中难免戚戚焉。如何快速融入团队并获得大家的认可呢？和 @zengrong 大神的选择类似，</p>
<blockquote>
<p>解决一个大家开发过程中的痛点</p>
</blockquote>
<p>在负责一个小模块的时候， 我发现项目中有很多相似的控件，每个都得单独做，逻辑冗余且散落的到处都是，为什么不实现一个通用的控件去做呢？细节不赘述，最终这个控件成功的替换了所有的老控件，带来了极大的效率提升。</p>
<h1 id="u4E09-__u751F_u6D3B"><a href="#u4E09-__u751F_u6D3B" class="headerlink" title="三. 生活"></a>三. 生活</h1><h2 id="u65C5_u884C"><a href="#u65C5_u884C" class="headerlink" title="旅行"></a>旅行</h2><p>在 16 年春节前，我和媳妇开始我们的 上海-杭州-苏州 之旅，为期 2 周，这个也是我和冰子出去游玩时间最长的一次。</p>
<p><img src="https://ww2.sinaimg.cn/large/006tNc79ly1fcuzylbg29j30qd0zkjt3.jpg" alt=""></p>
<p>上海东方明珠外的玻璃栈道, 杭州的汽车真的是会主动让行人的, 苏州街边的点心真的很精致. 世界这么大, 出去走走真是好.</p>
<h2 id="u5B66_u8F66"><a href="#u5B66_u8F66" class="headerlink" title="学车"></a>学车</h2><p>很早之前就报名了，一直没有狠下心来去学，还一直拿工作忙没时间来搪塞冰子。</p>
<p>直到冰子一气之下直接给我报了名，我才开始拿起手机背题，这里真的要感谢《驾考宝典》这个 APP ，它上面的易错题非常牛逼，考试的时候几乎都碰上了，就这样轻松通过科目一。</p>
<p><img src="https://ww2.sinaimg.cn/large/006tNc79ly1fcuzlkei9nj30zk0qon0u.jpg" alt=""></p>
<p>科目二的时候十分艰苦，我们报的周末上午班，每天5点就要起床，有一个多月的时间的周末早晨都是在班车上度过的。科目二考试的时候因为车型的原因差点没有过，好险！</p>
<p>科目三很简单，过不过很多时候不是由自己决定的，只要科目二学的够扎实，下面就可以交给命运了，我很幸运，一次就过了。</p>
<p>科目四同样很简单，满分难，通过却很容易。</p>
<p>就这样，历时两个月，我成功拿到之前根本没有想到的驾照。而冰子，她还挂在科目二呢，哈哈哈，嘲笑她一把。</p>
<h2 id="u80CC_u5355_u8BCD"><a href="#u80CC_u5355_u8BCD" class="headerlink" title="背单词"></a>背单词</h2><p>我大概是在 16 年初突然决定背单词的，原因我已经记不清楚了。从此，早晨公交车上，公司厕所内，晚上等车时，你都会看到一个在背单词的身影。</p>
<p>作为一个花了好多钱学英语报班都没有坚持下来的愿望，这次真的能够成功吗？</p>
<p><img src="https://ww1.sinaimg.cn/large/006tNc79ly1fcuzpmd3y5j30k00zkgnl.jpg" alt=""></p>
<p>这次能坚持，完全归功于《百词斩》，宏爷很早之前就给我安利过这款产品，当时功能还很简陋，没有坚持下来。</p>
<p>背单词对我的帮助十分大，现在我已经可以很简单的浏览 Stack Overflow 了，能看懂每一个答案在说什么，甚至已经可以自己去回答帮助别人了。</p>
<h2 id="u751F_u65E5"><a href="#u751F_u65E5" class="headerlink" title="生日"></a>生日</h2><p>这一年最大惊喜就是冰子为我准备的生日派对, 我从小都没有这样过过生日. </p>
<p><img src="https://ww2.sinaimg.cn/large/006tNc79ly1fcv02ph5dzj30zk0qowgn.jpg" alt=""></p>
<p>虽然很朴素, 但可以看到用了很多心, 听说冰子吹气球吹的腮帮疼, 哈哈 , 好傻 ! 谢谢你, 老婆, 永远爱你 !</p>
<h1 id="u56DB-__u5241_u624B"><a href="#u56DB-__u5241_u624B" class="headerlink" title="四. 剁手"></a>四. 剁手</h1><h2 id="u5C0F_u7C73_u5708_u94C1_u8033_u673A"><a href="#u5C0F_u7C73_u5708_u94C1_u8033_u673A" class="headerlink" title="小米圈铁耳机"></a>小米圈铁耳机</h2><p><img src="https://ww2.sinaimg.cn/large/006tNc79ly1fcuxwqotzcj30qd0zkq4e.jpg" alt=""></p>
<p>上一个耳机 KOSS PORTAPRO 挂掉之后, 就不打算买头戴式的了, 麻烦不说还容易坏. 在微博上看到谁说这个耳机还不错, 便入手了. 总体来说, 算不上惊艳, 但还算好用, 毕竟 <code>99</code> 的价位也不会对它有什么过分的要求.</p>
<h2 id="u5C0F_u7C73max"><a href="#u5C0F_u7C73max" class="headerlink" title="小米max"></a>小米max</h2><p><img src="https://ww4.sinaimg.cn/large/006tNc79ly1fcuzds4awbj30zk0qota8.jpg" alt=""></p>
<p>买的时候想的很好, 大屏可以用来看书, 实际却很少看书. 总而言之, 质量没的说, 我对小米的手机就没有失望过, 但是大屏单手操作还是有所不便, 买的时候还是要慎重一些.</p>
<hr>
<p>总而言之, 这是充实而又愉快的 2016 年, 工作和家庭都很顺心, 希望 17 年能继续保持下去. </p>
]]></content>
    </entry>
    
    <entry>
      <title><![CDATA[quick-x 视频播放]]></title>
      <url>http://blog.justbilt.com/2016/12/10/quickx-playvideo/</url>
      <content type="html"><![CDATA[<p>今天我们来聊聊 QuickX 中播放视频的那些事. </p>
<p>这篇文章来自于日常的笔记, 年代可能会有些久远, 加上当时最开始视频播放不是我来做的, 所以有些地方我的理解也不是很深刻. 若是有什么不对的地方, 还望大家不吝赐教.</p>
<h1 id="u4E00-__u57FA_u672C_u7528_u6CD5"><a href="#u4E00-__u57FA_u672C_u7528_u6CD5" class="headerlink" title="一. 基本用法"></a>一. 基本用法</h1><p>播放一段视频:</p>
<figure class="highlight lua"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">local</span> video = ccexp.VideoPlayer:create()</span><br><span class="line">video:setPosition(cc.p(display.cx, display.cy))</span><br><span class="line">video:setAnchorPoint(cc.p(<span class="number">0.5</span>, <span class="number">0.5</span>))</span><br><span class="line">video:setContentSize(cc.size(display.width, display.height))</span><br><span class="line">video:setFileName(<span class="string">"res/start_video.mp4"</span>)</span><br><span class="line">video:setKeepAspectRatioEnabled(<span class="keyword">true</span>)</span><br><span class="line">video:setFullScreenEnabled(<span class="keyword">true</span>)</span><br><span class="line"></span><br><span class="line">self:addChild(video)</span><br></pre></td></tr></table></figure>
<p>监听视屏播放事件:</p>
<figure class="highlight lua"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">local</span> <span class="function"><span class="keyword">function</span> <span class="title">onVideoEventCallback</span><span class="params">(sender, eventType)</span></span></span><br><span class="line">    <span class="built_in">print</span>(<span class="string">"onVideoEventCallback:"</span>, eventType)</span><br><span class="line">    <span class="keyword">if</span> eventType == ccexp.VideoPlayerEvent.PLAYING <span class="keyword">then</span></span><br><span class="line">    <span class="keyword">elseif</span> eventType == ccexp.VideoPlayerEvent.PAUSED <span class="keyword">then</span></span><br><span class="line">    <span class="keyword">elseif</span> eventType == ccexp.VideoPlayerEvent.STOPPED <span class="keyword">then</span></span><br><span class="line">    <span class="keyword">elseif</span> eventType == ccexp.VideoPlayerEvent.COMPLETED <span class="keyword">then</span></span><br><span class="line">    <span class="keyword">end</span></span><br><span class="line"><span class="keyword">end</span></span><br><span class="line">video:addEventListener(onVideoEventCallback)</span><br><span class="line">video:play()</span><br></pre></td></tr></table></figure>
<blockquote>
<p>然而你做完这一切还是可能会播放不出来视频, 没有关系, 多播放几次就出来啦.</p>
</blockquote>
<h1 id="u4E8C-__u9047_u5230_u7684_u95EE_u9898"><a href="#u4E8C-__u9047_u5230_u7684_u95EE_u9898" class="headerlink" title="二. 遇到的问题"></a>二. 遇到的问题</h1><h2 id="u95EE_u9898_1_3A_iOS__u64AD_u653E_u89C6_u9891_u5B8C_u540E_u9ED1_u5C4F"><a href="#u95EE_u9898_1_3A_iOS__u64AD_u653E_u89C6_u9891_u5B8C_u540E_u9ED1_u5C4F" class="headerlink" title="问题 1: iOS 播放视频完后黑屏"></a>问题 1: iOS 播放视频完后黑屏</h2><p>cocos2dx 3.3 iOS端播放视频完后黑屏, 控制台中提示日志: OpenGL error 0x0506 in -[CCEAGLView swapBuffers] 324</p>
<p>解决方案:</p>
<p><a href="http://www.cnblogs.com/cc4coco/p/4188347.html" target="_blank" rel="external">http://www.cnblogs.com/cc4coco/p/4188347.html</a></p>
<figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">-(<span class="keyword">void</span>) viewDidAppear:(<span class="built_in">BOOL</span>)animated&#123;</span><br><span class="line"></span><br><span class="line">    cocos2d::Director::getInstance()-&gt;resume();</span><br><span class="line">    cocos2d::Director::getInstance()-&gt;startAnimation();</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">- (<span class="keyword">void</span>)viewWillDisappear:(<span class="built_in">BOOL</span>)animated&#123;</span><br><span class="line"></span><br><span class="line">    cocos2d::Director::getInstance()-&gt;pause();</span><br><span class="line">    cocos2d::Director::getInstance()-&gt;stopAnimation();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="u95EE_u9898_2_3A__u5728_iOS_9-2__u4EE5_u4E0A_u4F1A_u5D29_u6E83"><a href="#u95EE_u9898_2_3A__u5728_iOS_9-2__u4EE5_u4E0A_u4F1A_u5D29_u6E83" class="headerlink" title="问题 2: 在 iOS 9.2 以上会崩溃"></a>问题 2: 在 iOS 9.2 以上会崩溃</h2><p>解决方案:</p>
<p><a href="https://github.com/cocos2d/cocos2d-x/issues/14855" target="_blank" rel="external">https://github.com/cocos2d/cocos2d-x/issues/14855</a></p>
<p>修改 VideoPlayer 类的析构函数, 将 <code>dealloc</code> 改为 <code>release</code>.</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">VideoPlayer::~VideoPlayer()</span><br><span class="line">&#123;</span><br><span class="line">     <span class="keyword">if</span>(_videoView)</span><br><span class="line">     &#123;</span><br><span class="line">-        [((UIVideoViewWrapperIos*)_videoView) dealloc];</span><br><span class="line">+        [((UIVideoViewWrapperIos*)_videoView) release];</span><br><span class="line">     &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="u95EE_u9898_3_3A_iOS__u4E0A_u64AD_u653E_u89C6_u9891_u6709_u8FDB_u5EA6_u6761_2C__u53CC_u51FB_u53EF_u4EE5_u653E_u5927_u7F29_u5C0F_2C_Android__u70B9_u51FB_u53EF_u4EE5_u6682_u505C"><a href="#u95EE_u9898_3_3A_iOS__u4E0A_u64AD_u653E_u89C6_u9891_u6709_u8FDB_u5EA6_u6761_2C__u53CC_u51FB_u53EF_u4EE5_u653E_u5927_u7F29_u5C0F_2C_Android__u70B9_u51FB_u53EF_u4EE5_u6682_u505C" class="headerlink" title="问题 3: iOS 上播放视频有进度条, 双击可以放大缩小, Android 点击可以暂停"></a>问题 3: iOS 上播放视频有进度条, 双击可以放大缩小, Android 点击可以暂停</h2><p>解决方案:</p>
<p>这个问题挺让人啼笑皆非的, 不知道当时设计这个类的人是如何考虑的, 至少也应该提供一个关闭的接口吧. 好, 让我们看下如何解决它.</p>
<p><img src="http://ww3.sinaimg.cn/large/006y8lVajw1fam4s9vv7ij30dj0m9q3f.jpg" alt=""></p>
<h3 id="1-__u9690_u85CF_iOS__u64AD_u653E_u8FDB_u5EA6_u6761"><a href="#1-__u9690_u85CF_iOS__u64AD_u653E_u8FDB_u5EA6_u6761" class="headerlink" title="1. 隐藏 iOS 播放进度条"></a>1. 隐藏 iOS 播放进度条</h3><p>在 UIVideoPlayer-ios.mm 的 <code>-(void) setURL:(int)videoSource :(std::string &amp;)videoUrl</code> 函数中, 修改 <code>MPMovieControlStyleEmbedded</code> 为 <code>MPMovieControlStyleNone</code>:</p>
<figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">-    <span class="keyword">self</span><span class="variable">.moviePlayer</span><span class="variable">.controlStyle</span> = <span class="built_in">MPMovieControlStyleEmbedded</span>;</span><br><span class="line">+    <span class="keyword">self</span><span class="variable">.moviePlayer</span><span class="variable">.controlStyle</span> = <span class="built_in">MPMovieControlStyleNone</span>;</span><br></pre></td></tr></table></figure>
<p>进度条隐藏了, 但是视频播放时双击缩放的问题却无法解决.</p>
<h3 id="2-__u7981_u7528_Android__u70B9_u51FB_u6682_u505C"><a href="#2-__u7981_u7528_Android__u70B9_u51FB_u6682_u505C" class="headerlink" title="2. 禁用 Android 点击暂停"></a>2. 禁用 Android 点击暂停</h3><p>修改 <code>Cocos2dxWebView.java</code> 中的 <code>onTouchEvent</code> 函数</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">    <span class="annotation">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">onTouchEvent</span><span class="params">(MotionEvent event)</span> </span>&#123;</span><br><span class="line"><span class="comment">//        if((event.getAction() &amp; MotionEvent.ACTION_MASK) == MotionEvent.ACTION_UP)</span></span><br><span class="line"><span class="comment">//        &#123;</span></span><br><span class="line"><span class="comment">//            if (isPlaying()) &#123;</span></span><br><span class="line"><span class="comment">//                pause();</span></span><br><span class="line"><span class="comment">//            &#125; else if(mCurrentState == STATE_PAUSED)&#123;</span></span><br><span class="line"><span class="comment">//                resume();</span></span><br><span class="line"><span class="comment">//            &#125;</span></span><br><span class="line"><span class="comment">//        &#125;</span></span><br><span class="line">        </span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>
<h2 id="u95EE_u9898_4_3A_vivo_u624B_u673A_u65E0_u6CD5_u64AD_u653E_u89C6_u9891_u7684bug"><a href="#u95EE_u9898_4_3A_vivo_u624B_u673A_u65E0_u6CD5_u64AD_u653E_u89C6_u9891_u7684bug" class="headerlink" title="问题 4: vivo手机无法播放视频的bug"></a>问题 4: vivo手机无法播放视频的bug</h2><p>解决方案:</p>
<p>经过断点跟踪, 定位到了原因, 视频的尺寸获取的有问题, 我尝试修改了 <code>setVideoRect</code> 函数中的两行代码:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">-        mViewWidth = maxWidth;</span><br><span class="line">-        mViewHeight = maxHeight;</span><br><span class="line">+        mViewWidth = <span class="number">1</span>;</span><br><span class="line">+        mViewHeight = <span class="number">1</span>;</span><br></pre></td></tr></table></figure>
<p>很神奇的解决了这个问题.</p>
<h2 id="u95EE_u9898_5_3A__u591A_u6B21_u8C03_u7528_u53EF_u80FD_u4F1A_u906E_u6321_SDK__u7684_u5F39_u51FA_u754C_u9762"><a href="#u95EE_u9898_5_3A__u591A_u6B21_u8C03_u7528_u53EF_u80FD_u4F1A_u906E_u6321_SDK__u7684_u5F39_u51FA_u754C_u9762" class="headerlink" title="问题 5: 多次调用可能会遮挡 SDK 的弹出界面"></a>问题 5: 多次调用可能会遮挡 SDK 的弹出界面</h2><p>我们游戏中有一个重启的功能, 每次重启都会播放一个视频, 这样某些渠道的登录界面就看不到了, 另一个不播放视屏的项目就没有问题, 好像是每次播放都会提高游戏的层级.</p>
<p>解决方案:</p>
<p>遍历所有 window , 找到 SDK 的那个 window, 将它的 windowLevel 提高一级.</p>
<figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">for</span>(<span class="built_in">UIWindow</span> * w <span class="keyword">in</span> [[<span class="built_in">UIApplication</span> sharedApplication]windows])&#123;</span><br><span class="line">    <span class="keyword">if</span> ([w isKindOfClass:<span class="built_in">NSClassFromString</span>(<span class="string">@"XSDKOriginalWindow"</span>)]) &#123;</span><br><span class="line">        [w setWindowLevel:[[[<span class="built_in">UIApplication</span> sharedApplication]keyWindow]windowLevel]+<span class="number">1</span>];</span><br><span class="line">        <span class="keyword">break</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="u95EE_u9898_6_3A__u8FD8_u6709_u4EC0_u4E48_u95EE_u9898_2C__u90FD_u8BF4_u4E86_u5427"><a href="#u95EE_u9898_6_3A__u8FD8_u6709_u4EC0_u4E48_u95EE_u9898_2C__u90FD_u8BF4_u4E86_u5427" class="headerlink" title="问题 6: 还有什么问题, 都说了吧"></a>问题 6: 还有什么问题, 都说了吧</h2><p>如果播放时候是黑屏，把游戏切到后台，再进入游戏就能从头播放！<br>如果播放时候正常，切到后台再切回来就变成黑屏</p>
<p><a href="http://www.cocoachina.com/bbs/read.php?tid-306892.html" target="_blank" rel="external">http://www.cocoachina.com/bbs/read.php?tid-306892.html</a></p>
<p>Cocos2d-x V3.10版本中的videoplayer问题<br><a href="http://www.voidcn.com/blog/sh15285118586/article/p-5989468.html" target="_blank" rel="external">http://www.voidcn.com/blog/sh15285118586/article/p-5989468.html</a></p>
<p>关于cocos2dx 3.x VideoPlayer的问题<br><a href="http://blog.sina.com.cn/s/blog_93add5520102w6n9.html" target="_blank" rel="external">http://blog.sina.com.cn/s/blog_93add5520102w6n9.html</a></p>
<p>cocos2d-x视频控件VideoPlayer的用户操作栏进度条去除<br><a href="http://blog.csdn.net/pklll000pp44/article/details/51337577" target="_blank" rel="external">http://blog.csdn.net/pklll000pp44/article/details/51337577</a></p>
<hr>
<p>还真的是问题一大堆呢! 大家最好还是回去和策划大大商量下, 别播放视频了.</p>
]]></content>
    </entry>
    
    <entry>
      <title><![CDATA[一个命令行的 TexturePacker 拆解工具  (二)]]></title>
      <url>http://blog.justbilt.com/2016/10/29/untp-2/</url>
      <content type="html"><![CDATA[<p>距离第一版的 <code>untp</code> 发布已经有一年半的时间了, 在这个项目上我收获了很多的第一次:</p>
<blockquote>
<p>第一次有一个项目的 star 数超过 50<br>第一次往 pypi 上上传项目<br>第一次如此认真的维护一个项目<br>…</p>
</blockquote>
<p>这篇文章已经是关于 untp 的第三篇文章了, 所有的文章列表可以<a href="/tags/untp">查看这里</a>. 下面我来讲讲 untp 最近的几次更新以及后续的一个维护计划.</p>
<h1 id="u4E00-__u66F4_u65B0"><a href="#u4E00-__u66F4_u65B0" class="headerlink" title="一. 更新"></a>一. 更新</h1><h2 id="1-0-5"><a href="#1-0-5" class="headerlink" title="1.0.5"></a>1.0.5</h2><ol>
<li>拆解单个文件时支持 <code>-o</code> 参数指定输出目录</li>
<li>可以在 <code>python</code> 中 <code>import</code></li>
<li>支持 cocos2d/cocos2d-x v3 格式</li>
</ol>
<h2 id="1-0-4"><a href="#1-0-4" class="headerlink" title="1.0.4"></a>1.0.4</h2><ol>
<li>使用 argparse 解析调用参数, 支持更多选项</li>
<li>捕获图片打开异常, 程序更加健壮</li>
<li>支持文件夹递归查找所有 plist 拆解</li>
</ol>
<h2 id="1-0-3"><a href="#1-0-3" class="headerlink" title="1.0.3"></a>1.0.3</h2><ol>
<li>修复依赖 Pillow 模块版本大于 3.0 时图片输出错误</li>
</ol>
<h2 id="1-0-2"><a href="#1-0-2" class="headerlink" title="1.0.2"></a>1.0.2</h2><ol>
<li>兼容 python3</li>
<li>放弃之前的打包发布, 改为 pypi 发布</li>
<li>修复一处路径错误</li>
<li>根据 python code style 优化代码</li>
<li>pvr,pvr.czz 格式支持 (需要安装 <code>TexturePacker</code> 命令行工具)</li>
</ol>
<h1 id="u4E8C-__u540E_u7EED_u8BA1_u5212"><a href="#u4E8C-__u540E_u7EED_u8BA1_u5212" class="headerlink" title="二. 后续计划"></a>二. 后续计划</h1><p>untp 这个项目最初来源于项目中的一个需求, 所以开始只是为了自用, 开源之后发现有能帮助一些人, 顺便实现一下他们的一些小需求, 自我更新动力并不是很足, 因此更新的频率不是很高.</p>
<p>之前的发展策略我一直都是按着更便捷安装, 更方便使用方向上走的, 从一开始的 PyInstaller 打包到后面的上传到 pypi , 从开始只支持单一文件到支持目录, 都是按照这个思路搞的.至于后面如何发展我也没有很好的想法, 或许让它停留在这一版也很好. 今天看到张小龙的一篇内部分享, 一个好的工具就应该只是一个工具, 想到就用, 用完就走, 不要想着把用户黏住.</p>
<p>所以, untp 就只是一个拆解大图的工具, 绝对不做其他的功能. 在这个原则的基础上, 有这么几个方向去搞:</p>
<ol>
<li>GUI 界面的支持</li>
<li>支持更多的格式</li>
</ol>
<p>我想使用这个工具的人可能不一定是程序员, 他们不一定懂 pip , 不一定会打开终端. 所以一个 GUI 的界面就很重要了. 第二个是可以让更多引擎的开发者来使用, 现在只支持 cocos 是有些狭隘了, 对自己也是一个很好地的锻炼.</p>
<p>如果你还有更好的建议, 欢迎在评论里或者 <a href="https://github.com/justbilt/untp/issues" target="_blank" rel="external">issue</a> 中提出.</p>
<h1 id="u4E09-__u4E2D_u6587_u4F7F_u7528_u8BF4_u660E_28_u6301_u7EED_u66F4_u65B0_29"><a href="#u4E09-__u4E2D_u6587_u4F7F_u7528_u8BF4_u660E_28_u6301_u7EED_u66F4_u65B0_29" class="headerlink" title="三. 中文使用说明(持续更新)"></a>三. 中文使用说明(持续更新)</h1><h2 id="1-__u5B89_u88C5"><a href="#1-__u5B89_u88C5" class="headerlink" title="1. 安装"></a>1. 安装</h2><p>现在可以采用两种方式安装, 在终端中键入 <code>pip install untp</code> 或者 clone 代码到本地, 在根目录 <code>python setup install</code> .</p>
<h2 id="2-__u4F7F_u7528"><a href="#2-__u4F7F_u7528" class="headerlink" title="2. 使用"></a>2. 使用</h2><p>当我们在终端中键入 <code>untp -h</code> 后, 会得到下面这段输出:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">usage:&#10;untp ../btn.plist&#10;untp ../btn.plist -i ../btn.png&#10;untp ../data&#10;untp ../data -r&#10;&#10;positional arguments:&#10;  path                  plist file name or directory&#10;&#10;optional arguments:&#10;  -h, --help            show this help message and exit&#10;&#10;For file:&#10;  -i image_file, --image_file image_file&#10;                        specified image file for plist&#10;  -o output, --output output&#10;                        specified output directory&#10;&#10;For directory:&#10;  -r, --recursive</span><br></pre></td></tr></table></figure>
<p>对于单个 plist 文件, 可以 <code>untp xxx.plist</code> 来拆解它, 会读取 plist 中配置的图片输出到同名的目录中, 可以使用 <code>-i</code> 指定图片, <code>-o</code> 指定输出目录.</p>
<p>对于目录, 使用 <code>untp path</code> path 是包含 <code>plist</code> 文件的目录, 可以使用 <code>-r</code> 参数指定遍历子目录.</p>
<p>(以上)</p>
]]></content>
    </entry>
    
    <entry>
      <title><![CDATA[quick-x utf8 支持]]></title>
      <url>http://blog.justbilt.com/2016/09/23/quickx-utf8-support/</url>
      <content type="html"><![CDATA[<h1 id="u4E00-__u9700_u6C42"><a href="#u4E00-__u9700_u6C42" class="headerlink" title="一. 需求"></a>一. 需求</h1><h2 id="1-__u8BA1_u7B97_u73A9_u5BB6_u540D_u5B57_u5B57_u7B26_u6570"><a href="#1-__u8BA1_u7B97_u73A9_u5BB6_u540D_u5B57_u5B57_u7B26_u6570" class="headerlink" title="1. 计算玩家名字字符数"></a>1. 计算玩家名字字符数</h2><p>对于这个需求一般情况下 <code>string.len</code> 或 quick 自带的 <code>string.utf8len</code> 就能满足, 但是如果需求是:</p>
<blockquote>
<p>对于像 中文/日文/韩文 这样的方块字一个占 2 个长度, 其他字符占 1 个长度.</p>
</blockquote>
<p>该如何满足呢 ? </p>
<h2 id="2-__u5C4F_u853D_emoji__u8868_u60C5"><a href="#2-__u5C4F_u853D_emoji__u8868_u60C5" class="headerlink" title="2. 屏蔽 emoji 表情"></a>2. 屏蔽 emoji 表情</h2><p>我们游戏的聊天/起名都是不允许输入 emoji 表情的, 那么该如何判断玩家输入的文字中包含 emoji 表情呢 ? </p>
<p>在我之前的文章(<a href="/2016/05/01/quickx-editbox-util/#u4E8C-__u5C4F_u853D_Emoji__u8F93_u5165">quick-x EditBox 几个小技巧</a>)中有提到过这个需求, 当时分析了下有两个解决方案:</p>
<ol>
<li>无法输入, 弹出键盘点击表情没有反应</li>
<li>输入完成后, 游戏内点击提交时提示非法</li>
</ol>
<p>本来打算是使用<strong>方法2</strong>的, 苦于无法在 lua 这边识别出 emoji , 所以只能曲线救国的使用的<strong>方法1</strong>, 每个平台得单独实现不说, 还容易出 bug, 出了 bug 亦无法热更新修复.</p>
<p>最近还真是遇到了 bug , 会导致在 ios 上无法使用<strong>九宫格</strong>输入法.</p>
<hr>
<p>以上两个问题, 如果支持 utf8 的话, 我们可以遍历整个字符串, 判断每个字符的 <code>codepoint</code> 是否在某个码区中. 所以我们需要实现这么几个接口:</p>
<ol>
<li>utf8 长度计算</li>
<li>遍历 utf8</li>
<li>utf8 char/byte 实现</li>
</ol>
<h1 id="u4E8C-__u5B9E_u73B0"><a href="#u4E8C-__u5B9E_u73B0" class="headerlink" title="二. 实现"></a>二. 实现</h1><h2 id="1-__u4F7F_u7528_clib__u5B9E_u73B0"><a href="#1-__u4F7F_u7528_clib__u5B9E_u73B0" class="headerlink" title="1. 使用 clib 实现"></a>1. 使用 clib 实现</h2><p>Google 搜索 <code>lua utf8</code> 很快发现了 <a href="/2016/05/01/quickx-editbox-util/#u4E8C-__u5C4F_u853D_Emoji__u8F93_u5165">luautf8</a> 这个项目, 100 多个 star , 对于一个 lua 项目, 已经算很多了. 实现也很简单, 就 <code>unidata.h</code> 和 <code>lutf8lib.c</code> 两个文件.</p>
<p>下面我们在 quick 中集成这个项目, 我们在 <code>quick-cocos2d-x/external/lua</code> 目录先新建一个 <code>utf8</code> 目录, 将上面提到的那两个文件下载下来放进去, 修改 <code>lutf8lib.c:1303</code> 行:</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//  lua_createtable(L, 0, sizeof(libs)/sizeof(libs[0]));</span></span><br><span class="line"><span class="comment">//  luaL_register(L, NULL, libs);</span></span><br><span class="line">  luaL_openlib(L, <span class="string">"utf8"</span>, libs, <span class="number">0</span>);</span><br></pre></td></tr></table></figure>
<p>为了在别的文件中能够访问到 <code>luaopen_utf8</code> 函数, 我们还需要新建一个 <code>utf8lib.h</code> 头文件:</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="preprocessor">#<span class="keyword">ifndef</span> LUAUTF8_H</span></span><br><span class="line"><span class="preprocessor">#<span class="keyword">define</span> LUAUTF8_H</span></span><br><span class="line"></span><br><span class="line"><span class="preprocessor">#<span class="keyword">include</span> <span class="string">"lua.h"</span></span></span><br><span class="line"></span><br><span class="line"><span class="preprocessor">#<span class="keyword">ifndef</span> LUALIB_API</span></span><br><span class="line"><span class="preprocessor">#<span class="keyword">define</span> LUALIB_API extern</span></span><br><span class="line"><span class="preprocessor">#<span class="keyword">endif</span></span></span><br><span class="line"></span><br><span class="line"><span class="comment">/*-------------------------------------------------------------------------*\</span><br><span class="line">* Initializes the library.</span><br><span class="line">\*-------------------------------------------------------------------------*/</span></span><br><span class="line"><span class="function">LUALIB_API <span class="keyword">int</span> <span class="title">luaopen_utf8</span><span class="params">(lua_State *L)</span></span>;</span><br><span class="line"></span><br><span class="line"><span class="preprocessor">#<span class="keyword">endif</span> <span class="comment">/* LUAUTF8_H */</span></span></span><br></pre></td></tr></table></figure>
<p>下面我们就可以注册这个库了, 修改 <code>cocos/scripting/lua-bindings/manual/network/lua_extensions.c</code> :</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="preprocessor">#<span class="keyword">include</span> <span class="string">"utf8/lutf8lib.h"</span></span></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">luaopen_lua_extensions</span><span class="params">(lua_State *L)</span></span><br><span class="line"></span>&#123;</span><br><span class="line">    ...</span><br><span class="line">    luaopen_utf8(L);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>同时我们还需要修改编译脚本, 使得在不同平台上能够编译通过, Android 需要修改</p>
<p> <code>cocos/scripting/lua-bindings/proj.android/Android.mk</code> 文件:</p>
<figure class="highlight mk"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="constant">LOCAL_SRC_FILES</span> += ../manual/network/lua_cocos2dx_network_manual.cpp \</span><br><span class="line">                   ../../../../external/lua/luasocket/usocket.c \</span><br><span class="line">                   ../../../../external/lua/utf8/lutf8lib.c</span><br></pre></td></tr></table></figure>
<p>在 <code>LOCAL_SRC_FILES</code> 末尾加上 <code>lutf8lib.c</code> .</p>
<p>iOS/Mac 的话, 在 XCode 中将整个 <code>utf8</code> 目录加入进来就可以呀, 如下图所示:</p>
<p><img src="http://ww2.sinaimg.cn/large/7f870d23gw1f838r4uoz1j207e03u74f.jpg" alt=""></p>
<h2 id="2-__u7EAF_lua__u5B9E_u73B0"><a href="#2-__u7EAF_lua__u5B9E_u73B0" class="headerlink" title="2. 纯 lua 实现"></a>2. 纯 lua 实现</h2><p>如果一切按计划走的话, 是不会有这么一步的, 然而天意难测, 说好的冷更新变成了变成了热更新. 若是还想保留这个功能的话, 只能寻找纯 lua 的解决方案了. 虽然走了不少弯路, 浪费了大量的时间, 最终还是让我找到了: </p>
<p><a href="https://github.com/Stepets/utf8.lua" target="_blank" rel="external">https://github.com/Stepets/utf8.lua</a></p>
<p>将项目中的 <code>utf8.lua</code> 下载下来放到你工程中就可以啦, 就是这么简单.</p>
<h2 id="3-__u517C_u5BB9"><a href="#3-__u517C_u5BB9" class="headerlink" title="3. 兼容"></a>3. 兼容</h2><p>按说有了纯 lua 的实现后, 我们就可以放弃 c 代码的实现了, 但是想起做 python 的时候, 有好多库的实现为了提高效率, 都会有一份 c/c++ 的实现优先使用. 我们是不是也可以这样子搞, 优先使用 clib 的实现, 若是没有再考虑 lua 的实现 ? 首先, 我们要对比一下这两个库的效率对比.</p>
<p>设计了一个简单的测试案例, 遍历一个 utf8 的字符串, 计算耗时, 得出了这样一份数据:</p>
<table>
<thead>
<tr>
<th>字符数</th>
<th>耗时clib</th>
<th>耗时lua</th>
<th>倍数</th>
</tr>
</thead>
<tbody>
<tr>
<td>10</td>
<td>2.0999999999938e-05</td>
<td>6.8000000000068e-05</td>
<td>3.2380952381081</td>
</tr>
<tr>
<td>138</td>
<td>0.00018899999999999</td>
<td>0.00095199999999995</td>
<td>5.0370370370369</td>
</tr>
<tr>
<td>2919</td>
<td>0.001868</td>
<td>0.01553</td>
<td>8.3137044967881</td>
</tr>
</tbody>
</table>
<p>可以看到至少也有 3 倍的速度提升, 而且随着字符数越来越多, 速度差距会更大. </p>
<p>这个方案是可行的, 我们可用如下代码做兼容:</p>
<figure class="highlight lua"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> <span class="built_in">type</span>(utf8) ~= <span class="string">"table"</span> <span class="keyword">then</span></span><br><span class="line">    utf8 = <span class="built_in">require</span>(<span class="string">"your/path/of.utf8"</span>)</span><br><span class="line"><span class="keyword">end</span></span><br></pre></td></tr></table></figure>
<p>但是两种实现遍历字符串的 api 略有不同, 需要包装兼容一下:</p>
<figure class="highlight lua"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">utf8.foreach = <span class="function"><span class="keyword">function</span><span class="params">(_str, _func)</span></span></span><br><span class="line">    <span class="keyword">local</span> index = <span class="number">1</span></span><br><span class="line">    <span class="keyword">if</span> utf8.<span class="built_in">next</span> <span class="keyword">then</span></span><br><span class="line">        <span class="keyword">for</span> pos, code <span class="keyword">in</span> utf8.<span class="built_in">next</span>, _str <span class="keyword">do</span></span><br><span class="line">            <span class="keyword">if</span> _func(index, utf8.char(code), code, pos) <span class="keyword">then</span></span><br><span class="line">                <span class="keyword">return</span></span><br><span class="line">            <span class="keyword">end</span></span><br><span class="line">            index = index + <span class="number">1</span></span><br><span class="line">        <span class="keyword">end</span></span><br><span class="line">    <span class="keyword">elseif</span> utf8.gensub <span class="keyword">then</span></span><br><span class="line">        <span class="keyword">for</span> char,pos <span class="keyword">in</span> utf8.gensub(_str) <span class="keyword">do</span></span><br><span class="line">            <span class="keyword">if</span> _func(index, char, utf8.byte(char), pos) <span class="keyword">then</span></span><br><span class="line">                <span class="keyword">return</span></span><br><span class="line">            <span class="keyword">end</span></span><br><span class="line">            index = index + <span class="number">1</span></span><br><span class="line">        <span class="keyword">end</span></span><br><span class="line">    <span class="keyword">else</span></span><br><span class="line">        <span class="built_in">assert</span>(<span class="keyword">false</span>, <span class="string">"no utf8 supports!"</span>)</span><br><span class="line">    <span class="keyword">end</span></span><br><span class="line"><span class="keyword">end</span></span><br></pre></td></tr></table></figure>
<h1 id="u9644_u5F55_3A"><a href="#u9644_u5F55_3A" class="headerlink" title="附录:"></a>附录:</h1><p>附上我们判断玩家姓名和 emoji 的代码, 比较简单, 若有不对之处, 欢迎指正.</p>
<h2 id="u73A9_u5BB6_u59D3_u540D_u957F_u5EA6_u5224_u65AD"><a href="#u73A9_u5BB6_u59D3_u540D_u957F_u5EA6_u5224_u65AD" class="headerlink" title="玩家姓名长度判断"></a>玩家姓名长度判断</h2><figure class="highlight lua"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">local</span> length = <span class="number">0</span></span><br><span class="line"></span><br><span class="line">utf8.foreach(text, <span class="function"><span class="keyword">function</span><span class="params">(index, char, code, pos)</span></span></span><br><span class="line">    <span class="comment">-- 中日韩文字一个字符算两个长度</span></span><br><span class="line">    <span class="keyword">if</span> code &gt;= <span class="number">0x3040</span> <span class="keyword">and</span> code &lt;= <span class="number">0x9fff</span> <span class="keyword">then</span></span><br><span class="line">        length = length + <span class="number">2</span></span><br><span class="line">    <span class="keyword">else</span></span><br><span class="line">        length = length + <span class="number">1</span></span><br><span class="line">    <span class="keyword">end</span></span><br><span class="line"><span class="keyword">end</span>)</span><br></pre></td></tr></table></figure>
<h2 id="emoji__u8868_u60C5_u5224_u65AD"><a href="#emoji__u8868_u60C5_u5224_u65AD" class="headerlink" title="emoji 表情判断"></a>emoji 表情判断</h2><figure class="highlight lua"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">local</span> <span class="function"><span class="keyword">function</span> <span class="title">checkContainsEomji</span><span class="params">(text)</span></span></span><br><span class="line">    <span class="keyword">local</span> contain = <span class="keyword">false</span></span><br><span class="line">    utf8.foreach(text, <span class="function"><span class="keyword">function</span><span class="params">(index, char, code, pos)</span></span></span><br><span class="line">        <span class="comment">-- [^\u0000-\u25ff\u27c0-\uD7FF\uE000-\uFFFF]</span></span><br><span class="line">        <span class="keyword">if</span> <span class="keyword">not</span> ((code &gt;= <span class="number">0x0000</span> <span class="keyword">and</span> code &lt;= <span class="number">0x25ff</span>) <span class="keyword">or</span> (code &gt;= <span class="number">0x27c0</span> <span class="keyword">and</span> code &lt;= <span class="number">0xD7FF</span>) <span class="keyword">or</span> (code &gt;= <span class="number">0xE000</span> <span class="keyword">and</span> code &lt;= <span class="number">0xFFFF</span>)) <span class="keyword">then</span></span><br><span class="line">            contain = <span class="keyword">true</span></span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">true</span></span><br><span class="line">        <span class="keyword">end</span></span><br><span class="line">    <span class="keyword">end</span>)</span><br><span class="line">    <span class="keyword">return</span> contain</span><br><span class="line"><span class="keyword">end</span></span><br></pre></td></tr></table></figure>
]]></content>
    </entry>
    
    <entry>
      <title><![CDATA[最近遇到的几个 quick-x 真机崩溃(二)]]></title>
      <url>http://blog.justbilt.com/2016/09/10/quickx-crash-on-phone-2/</url>
      <content type="html"><![CDATA[<p>大概是 8 月中旬的时候, 我们项目发生了一个很严重的线上事故. 在版本更新之后, 部分 Android 玩家反馈点击按钮开始游戏或活动按钮会闪退.</p>
<p>开始收到这个反馈时, 并没有太在意, 心想是不是机型适配有问题 ? 加上当时有别的工作在忙, 就没有去理会. 大概一个小时后, 玩家的邮件像雪花一样纷纷而至, 我才开始意识到, 更新出问题了.</p>
<p>汇总了一下玩家的反馈:</p>
<ol>
<li>新注册账号没有问题, 老账号会崩溃</li>
<li>新服务器没有问题, 老服务器崩溃</li>
<li>删除游戏重装后就没有问题了</li>
</ol>
<p>看着这些条件, 有经验的老司机可能已经看出倪端了, 但当时我并没有看出. 我们平时测试的时候, 多数都会新注册一个账号, 或者将原先的老包删除掉, 所以 Q&amp;A 并没有测试出这个问题, 也没有办法复现这个我问题.</p>
<p>我们游戏是集成了两个错误统计sdk的, 一个是 Bugtags, 一个是 umeng 错误收集, 但是这两个都是没有办法收集到 native 层面的 crash 的. </p>
<p><img src="http://ww4.sinaimg.cn/large/7f870d23jw1f7xim4h1aaj21b50ej0ul.jpg" alt=""></p>
<p>正当我一筹莫展的时候, 运营人员发来了 umeng 的这个错误列表, 我恍然大悟:</p>
<blockquote>
<p>本地存档出问题了</p>
</blockquote>
<p>因为我们的玩家存档是以 <code>服务器id+玩家id</code> 形式存入的, 所以上面列举的问题一下子就解释的通了.</p>
<h1 id="u4E00-__u7528_getStringForKey__u53BB_u83B7_u53D6_u4E00_u4E2A_bool__u578B_u7684_u5B58_u6863"><a href="#u4E00-__u7528_getStringForKey__u53BB_u83B7_u53D6_u4E00_u4E2A_bool__u578B_u7684_u5B58_u6863" class="headerlink" title="一. 用 getStringForKey 去获取一个 bool 型的存档"></a>一. 用 getStringForKey 去获取一个 bool 型的存档</h1><p>后台看到的错误日志是这个样子的:</p>
<blockquote>
<p>java.lang.ClassCastException: java.lang.String cannot be cast to java.lang.Boolean</p>
</blockquote>
<p><img src="/face/yilianmengbi.jpg" alt=""></p>
<p>这也可以? 这个错误闻所未闻, 只能说 Android 那边类型检测太严格了, 同时 cococ 读取存档时没有做异常处理.</p>
<p>有了方向就好办了, 我搜索了代码中所有用到 <code>getStringForKey</code> 的地方, 加上崩溃出现的时机, 很快定位了这个错误发生的原因.</p>
<p>团队的中的一位成员, 这次更新时更换过存档的类型, 之前的某一个数据是以 <code>setBoolForKey/getBoolForKey</code>, 现在更换成了 <code>setStringForKey/getStringForKey</code>, 这个问题不能怪他, 若是我也会遇到这个问题.</p>
<p>修改也很简单, 我换了一个新 key 去 存取/读取 这个存档.</p>
<h1 id="u4E8C-_setSpriteFrame_28_u201Ca-png_u201D_29__u4F20_u5165_u4E0D_u5B58_u5728_u7684_Sprite_Frmae_Name__u5C31_u4F1A_u5D29_u6E83"><a href="#u4E8C-_setSpriteFrame_28_u201Ca-png_u201D_29__u4F20_u5165_u4E0D_u5B58_u5728_u7684_Sprite_Frmae_Name__u5C31_u4F1A_u5D29_u6E83" class="headerlink" title="二. setSpriteFrame(“a.png”) 传入不存在的 Sprite Frmae Name 就会崩溃"></a>二. setSpriteFrame(“a.png”) 传入不存在的 Sprite Frmae Name 就会崩溃</h1><p>这个问题以前我没有遇到过, 我甚至都不知道 setSpriteFrame 可以传入 Sprite Frmae Name, 我每次都是 从 SpriteFrameCache 中获取一个 <code>SpriteFrame</code> 对象传入的.</p>
<p>导致这个问题发生原因是我们变化了图片打包策略, 之前用的是纹理图集, 现在改为碎片纹理了. 原理这些图片都在一个纹理图集上, 在游戏开始时已经 loading 过了, 所以不会有问题. 但是改为碎图就会找不到了.</p>
<figure class="highlight lua"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">newSpriteFrame</span><span class="params">(_name)</span></span></span><br><span class="line">    <span class="built_in">assert</span>(_name <span class="keyword">and</span> _name ~= <span class="string">""</span>)</span><br><span class="line">    <span class="comment">-- 尝试在大图中找</span></span><br><span class="line">    <span class="keyword">local</span> frame = cc.SpriteFrameCache:getInstance():getSpriteFrame(_name)</span><br><span class="line">    <span class="keyword">if</span> <span class="keyword">not</span> frame <span class="keyword">then</span></span><br><span class="line">        <span class="keyword">local</span> texture = cc.Director:getInstance():getTextureCache():addImage(_name)</span><br><span class="line">        <span class="keyword">if</span> texture <span class="keyword">then</span></span><br><span class="line">            frame = cc.SpriteFrame:createWithTexture(texture, cc.rect(<span class="number">0</span>, <span class="number">0</span>, texture:getContentSize().width, texture:getContentSize().height))</span><br><span class="line">            cc.SpriteFrameCache:getInstance():addSpriteFrame(frame, _name)</span><br><span class="line">        <span class="keyword">else</span></span><br><span class="line">            <span class="built_in">print</span>(<span class="string">"[ERROR]no such file:"</span>, _name)</span><br><span class="line">        <span class="keyword">end</span></span><br><span class="line">    <span class="keyword">end</span> </span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> frame</span><br><span class="line"><span class="keyword">end</span></span><br></pre></td></tr></table></figure>
<p>我们封装了这个函数来兼容这个 <code>纹理图集/碎片纹理</code>, 这样这个问题就解决了.</p>
<h1 id="u53CD_u601D"><a href="#u53CD_u601D" class="headerlink" title="反思"></a>反思</h1><p>每经历一次事故, 总要有所收获, 除了下次同样的问题不再发生, 流程上是否还有什么值得优化的地方 ?</p>
<h2 id="1-__u91CD_u89C6_u7EBF_u4E0A_u9519_u8BEF"><a href="#1-__u91CD_u89C6_u7EBF_u4E0A_u9519_u8BEF" class="headerlink" title="1. 重视线上错误"></a>1. 重视线上错误</h2><p>由于我一开对这个错误的轻视, 导致问题没有在第一时间控制住, 损失的不只是收入, 更是玩家对我们信心, 如果一个游戏经常出事故, 你还会去玩吗?</p>
<p>错误率对我们而言只是一个数字, 是一个概率, 但是具体到某一个发生故障的玩家, 对他而言就是 100% , 就是焦急, 愤怒.</p>
<h2 id="2-__u771F_u5B9E_u7684_u7EBF_u4E0A_u73AF_u5883_u6D4B_u8BD5"><a href="#2-__u771F_u5B9E_u7684_u7EBF_u4E0A_u73AF_u5883_u6D4B_u8BD5" class="headerlink" title="2. 真实的线上环境测试"></a>2. 真实的线上环境测试</h2><p>这个问题发生, 有很大一部分原因是我们的测试没有在一个真实的环境中去测试, 应该保证一个手机只安装线上包, 模拟真实玩家, 每天去玩一段时间.</p>
<h2 id="3-__u9519_u8BEF_u6536_u96C6_u7CFB_u7EDF_u7684_u9009_u62E9"><a href="#3-__u9519_u8BEF_u6536_u96C6_u7CFB_u7EDF_u7684_u9009_u62E9" class="headerlink" title="3. 错误收集系统的选择"></a>3. 错误收集系统的选择</h2><p>我们采用的 bugtags 不具有完全完整的错误收集能力, 对错误的检索也很弱, 甚至不如免费 bugly . 为此我要付一定责任, 当初选择的时候, 没有完整的调研对比过, 只是看到这个还不错就选择了.</p>
<p>做出判断前一定要慎重思考.</p>
]]></content>
    </entry>
    
    <entry>
      <title><![CDATA[最近搞 iOS 版遇到的一些问题和技巧 (三)]]></title>
      <url>http://blog.justbilt.com/2016/09/05/ios-dev-tips-3/</url>
      <content type="html"><![CDATA[<h1 id="u4E00-_iOS__u5185_u8D2D_u8FD4_u56DE_u5546_u54C1_u65E0_u6548_invalid_product"><a href="#u4E00-_iOS__u5185_u8D2D_u8FD4_u56DE_u5546_u54C1_u65E0_u6548_invalid_product" class="headerlink" title="一. iOS 内购返回商品无效 invalid product"></a>一. iOS 内购返回商品无效 invalid product</h1><p>我使用 quick-x 内置的 store 类请求商品信息时, 收到这样的错误:</p>
<blockquote>
<p>nvalidProductIdentifiers [CCStore_obj]<br>[CCStore_obj] productsRequestDidReceiveResponse() invalid pid: com.xxx.xxx</p>
</blockquote>
<p>首先, <strong>检查你请求的商品 id 在 iTunes 后台是否创建</strong>, 是否拼写错误. 如果没有问题, 那么就不太好办了, 会有很多原因导致这个问题.</p>
<p>ZZB_Amoy 博客的<a href="http://blog.sina.com.cn/s/blog_a6a46b330101dgju.html" target="_blank" rel="external">这篇文章</a>总结了下可能的原因, 如下:</p>
<blockquote>
<ul>
<li>创建的App ID是否启用了IAP功能。</li>
<li>商品信息是否配置到iTurn Connect，并到达“Ready to Submit”状态。</li>
<li>在iTurn Connect中创建Test User，并收取邮件激活。之后登录到测试用手机的设置页面中（Store选项）。</li>
<li>App的Bundle Id是否和后台配置的App Id一致。</li>
<li>是否创建相应的provisioning profile，并用此签名App。</li>
<li>iTurn Connect后台配置完商品信息后，是否等待若干小时生效。</li>
<li>SKProductsRequest请求的商品Id必须和iTurn Connect中配置的一致。（如：com.test.product.xxx）</li>
<li>iTunes Connect中配置的银行信息是否正确。</li>
<li>是否先删除旧App，再重新编译生成新的。</li>
<li>请不要使用越狱手机测试。</li>
</ul>
</blockquote>
<p>下面说说我两次遇到这个问题的解决方案:</p>
<ol>
<li>如果游戏发布区域中没有手机中 App Store 当前区的话, 需要先登陆下对应区域创建的测试账号, 将商店切换到对应区域.</li>
<li>完善苹果开发者账号所能完善的信息, 如付款信息呀什么的, 然后莫名其妙就解决了.</li>
<li>商品 id 大小写错误, 在 chrome 搜索时是忽略大小的.</li>
</ol>
<blockquote>
<p>注：在测试阶段，可以不用上传APP软件包，但必须创建测试用Apple Id，并在手机设置中（store选项）登录。</p>
</blockquote>
<h1 id="u4E8C-_iOS__u8FD0_u884C_u5D29_u6E83_unrecognized_selector_sent_to_instance"><a href="#u4E8C-_iOS__u8FD0_u884C_u5D29_u6E83_unrecognized_selector_sent_to_instance" class="headerlink" title="二. iOS 运行崩溃 unrecognized selector sent to instance"></a>二. iOS 运行崩溃 unrecognized selector sent to instance</h1><p>运行游戏过程中收到如下错误:</p>
<blockquote>
<p>[1515:710439] -[AppController window]: unrecognized selector sent to instance 0x2c85c00<br>libc++abi.dylib: terminate_handler unexpectedly threw an exception</p>
</blockquote>
<p>这个在接入某一个平台 sdk 时遇到的问题, 于是便问了下他们的技术, 很快解决了问题. </p>
<h4 id="1-__u4FEE_u6539_AppController-h__u4E2D_window__u53D8_u91CF_u7684_u58F0_u660E_u5F62_u5F0F"><a href="#1-__u4FEE_u6539_AppController-h__u4E2D_window__u53D8_u91CF_u7684_u58F0_u660E_u5F62_u5F0F" class="headerlink" title="1. 修改 AppController.h 中 window 变量的声明形式"></a>1. 修改 AppController.h 中 window 变量的声明形式</h4><p><img src="http://ww2.sinaimg.cn/large/7f870d23gw1f7j62j0mfuj20dw02n3yy.jpg" alt=""></p>
<h4 id="2-__u4FEE_u6539_AppController-mm"><a href="#2-__u4FEE_u6539_AppController-mm" class="headerlink" title="2. 修改 AppController.mm"></a>2. 修改 AppController.mm</h4><p><img src="http://ww2.sinaimg.cn/large/7f870d23gw1f7j665yyacj207901zq32.jpg" alt=""></p>
<p>虽然问题解决了, 但是我并不明白各种缘由. Google 了下, 大概明白了, 原来如此. 从错误中我们可以看到这句 <code>[AppController window]</code> , 从语法来看, 这是要调用 AppController 的 window 函数, 但是在我们之前的写法中没有实现这个函数, 便出错了. 而使用 <code>@property</code> 这个东西, 会自动帮你实现一个 <code>window/setWindow</code> 函数, 这样就不会找不到这个函数了.</p>
<h1 id="u4E09-__u6E38_u620F_u5728_u4F4E_u4E8E_ios9__u7684_u7CFB_u7EDF_u542F_u52A8_u5D29_u6E83"><a href="#u4E09-__u6E38_u620F_u5728_u4F4E_u4E8E_ios9__u7684_u7CFB_u7EDF_u542F_u52A8_u5D29_u6E83" class="headerlink" title="三. 游戏在低于 ios9 的系统启动崩溃"></a>三. 游戏在低于 ios9 的系统启动崩溃</h1><p>这个也是在接入第三方 sdk 时遇到的问题, 游戏一启动就会崩溃, 收到错误如下:</p>
<blockquote>
<p>dyld: Symbol not found: _OBJC<em>CLASS</em>$_SFSafariViewController<br>  Referenced from: /var/mobile/Applications/CF4146B4-3F79-4644-86CA-F19E52E64BAA/superarmoreddivision.app/superarmoreddivision<br>  Expected in: /System/Library/Frameworks/SafariServices.framework/SafariServices<br> in /var/mobile/Applications/CF4146B4-3F79-4644-86CA-F19E52E64BAA/superarmoreddivision.app/superarmoreddivision</p>
</blockquote>
<p>Google 了一下, 没有任何人遇到过这样的问题, 这就十分棘手了, 完全不知从何入手. 经过一番探索, 找到了几个有用的线索:</p>
<ol>
<li>SFSafariViewController 这个类是 ios 9 才引入的, 这和我们已知的信息相符.</li>
<li>所幸的是我们的游戏有多个 Scheme , 每个 Scheme 接入不同的 sdk . 其他的 Scheme 的都可以正常运行.</li>
</ol>
<p>这就可以肯定是某个 sdk 中使用了 <code>SFSafariViewController</code> 这个类, 但是还是没有办法定位是那个 sdk . 我不知道是否有一个命令查找符号引用, 因此只能采用最笨的排除法了, 我将引入的 sdk 依次删除, 看是否能够运行.</p>
<p>最终定位到了某个广告统计 sdk , 在询问其 ios 技术人员后得到了解决方案. 原来他们 sdk 需要<strong>以 <code>optional</code> 的形式引入 <code>SafariServices.framework</code></strong>.</p>
<p><img src="http://ww1.sinaimg.cn/large/7f870d23gw1f7kanujs5rj20ol018jrf.jpg" alt=""></p>
<p>都怪我没有仔细阅读文档, 白白耽误了一段时间, 下次一定要注意!</p>
<h1 id="u56DB-_Facebook__u767B_u5F55_u5D29_u6E83"><a href="#u56DB-_Facebook__u767B_u5F55_u5D29_u6E83" class="headerlink" title="四. Facebook 登录崩溃"></a>四. Facebook 登录崩溃</h1><p>集成 Facebook sdk 时, 调用登录接口游戏就会崩溃, 这个问题 Google 一下就能解决, 解决方案也很简单, 在 Info.plist 中加入下面几行代码即可:</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="title">key</span>&gt;</span>LSApplicationQueriesSchemes<span class="tag">&lt;/<span class="title">key</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="title">array</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="title">string</span>&gt;</span>fbapi<span class="tag">&lt;/<span class="title">string</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="title">string</span>&gt;</span>fb-messenger-api<span class="tag">&lt;/<span class="title">string</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="title">string</span>&gt;</span>fbauth2<span class="tag">&lt;/<span class="title">string</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="title">string</span>&gt;</span>fbshareextension<span class="tag">&lt;/<span class="title">string</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="title">array</span>&gt;</span></span><br></pre></td></tr></table></figure>
<p>Stackoverflow 上的答案可以<a href="http://stackoverflow.com/a/33489214" target="_blank" rel="external">移步这里</a>, Facebook 官网上也<a href="https://developers.facebook.com/docs/ios/ios9" target="_blank" rel="external">给了解答</a>.</p>
<h1 id="u4E94-_ios9__u72B6_u6001_u680F_u65E0_u6CD5_u9690_u85CF"><a href="#u4E94-_ios9__u72B6_u6001_u680F_u65E0_u6CD5_u9690_u85CF" class="headerlink" title="五. ios9 状态栏无法隐藏"></a>五. ios9 状态栏无法隐藏</h1><p>隐藏状态栏在 ios9 上换了一种方式, 还是需要在 Info.plist 中进行配置:</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="title">key</span>&gt;</span>UIStatusBarHidden<span class="tag">&lt;/<span class="title">key</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="title">true</span>/&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="title">key</span>&gt;</span>UIViewControllerBasedStatusBarAppearance<span class="tag">&lt;/<span class="title">key</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="title">false</span>/&gt;</span></span><br></pre></td></tr></table></figure>
<p>Stackoverflow 上的答案可以<a href="http://stackoverflow.com/a/32965748" target="_blank" rel="external">移步这里</a>.</p>
<h1 id="u516D-_showAlert__u8BE1_u5F02_u5D29_u6E83"><a href="#u516D-_showAlert__u8BE1_u5F02_u5D29_u6E83" class="headerlink" title="六. showAlert 诡异崩溃"></a>六. showAlert 诡异崩溃</h1><p>游戏内的一些弹框为了保证在游戏的最上层显示, 偷懒使用了 quick-x 提供的 <code>device.showAlert</code> 接口. showAlert 内部使用 <code>UIAlertView</code> 实现, 运行一直良好, 有一天突然就不行了, 一调用就崩溃. </p>
<p>各种办法都试过了, 网上都说是线程安全问题, 我试了一下各种处理都不行, 打断点跟踪到最底层也无济于事. 几近绝望之时, @bin 的一句话提醒了我:</p>
<blockquote>
<p>会不是屏幕方向的问题 ? </p>
</blockquote>
<p>最终一番尝试, 删除了 <code>RootViewController.mm</code> 中几个屏幕方向相关的函数:</p>
<figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line">*/</span><br><span class="line"><span class="comment">// Override to allow orientations other than the default portrait orientation.</span></span><br><span class="line"><span class="comment">// This method is deprecated on ios6</span></span><br><span class="line">- (<span class="built_in">BOOL</span>)shouldAutorotateToInterfaceOrientation:(<span class="built_in">UIInterfaceOrientation</span>)interfaceOrientation &#123;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">if</span> (ConfigParser::getInstance()-&gt;isLanscape()) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="built_in">UIInterfaceOrientationIsLandscape</span>( interfaceOrientation );</span><br><span class="line">    &#125;<span class="keyword">else</span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="built_in">UIInterfaceOrientationIsPortrait</span>( interfaceOrientation );</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// For ios6, use supportedInterfaceOrientations &amp; shouldAutorotate instead</span></span><br><span class="line">- (<span class="built_in">NSUInteger</span>) supportedInterfaceOrientations&#123;</span><br><span class="line"><span class="preprocessor">#ifdef __IPHONE_6_0</span></span><br><span class="line">    <span class="keyword">if</span> (ConfigParser::getInstance()-&gt;isLanscape()) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="built_in">UIInterfaceOrientationMaskLandscape</span>;</span><br><span class="line">    &#125;<span class="keyword">else</span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="built_in">UIInterfaceOrientationMaskPortraitUpsideDown</span>;</span><br><span class="line">    &#125;</span><br><span class="line"><span class="preprocessor">#endif</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">- (<span class="built_in">BOOL</span>) shouldAutorotate &#123;</span><br><span class="line">    <span class="keyword">if</span> (ConfigParser::getInstance()-&gt;isLanscape()) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">YES</span>;</span><br><span class="line">    &#125;<span class="keyword">else</span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">NO</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>这个 bug 出现之诡异, 解决方案之诡异, 在我遇到的 bug 中也算是很少见了.</p>
]]></content>
    </entry>
    
    <entry>
      <title><![CDATA[更简洁的 lua 逻辑代码]]></title>
      <url>http://blog.justbilt.com/2016/06/26/terse-lua-code/</url>
      <content type="html"><![CDATA[<p>爱因斯坦的质能方程 <code>E=MC^2</code>, 用在编程界同样适用 <code>Error = More Code ^ 2</code>. 代码越多, 出错的可能性就更大, 这个结论很正确呀. 那么我们如何使用更少的代码实现同样的需求呢 ?</p>
<p>一. 普通技</p>
<h2 id="1-_bool__u503C_u4E0E_if__u8BED_u53E5_u7684_u62E9_u51B3"><a href="#1-_bool__u503C_u4E0E_if__u8BED_u53E5_u7684_u62E9_u51B3" class="headerlink" title="1. bool 值与 if 语句的择决"></a>1. bool 值与 if 语句的择决</h2><p>让我们来看一段代码:</p>
<figure class="highlight lua"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">local</span> monthly_is_taken = app.player:getAttribute(<span class="string">"monthly_is_taken"</span>)</span><br><span class="line"><span class="keyword">if</span> monthly_is_taken == <span class="keyword">true</span> <span class="keyword">then</span></span><br><span class="line">    self._monthly_take:setButtonEnabled(<span class="keyword">false</span>)</span><br><span class="line"><span class="keyword">else</span></span><br><span class="line">    self._monthly_take:setButtonEnabled(<span class="keyword">true</span>)</span><br><span class="line"><span class="keyword">end</span></span><br></pre></td></tr></table></figure>
<p>显然这个 if 语句是没有必要的, 我们可以直接使用 bool 进行函数参数传递:</p>
<figure class="highlight lua"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">local</span> monthly_is_taken = app.player:getAttribute(<span class="string">"monthly_is_taken"</span>)</span><br><span class="line">self._monthly_take:setButtonEnabled(monthly_is_taken)</span><br></pre></td></tr></table></figure>
<p>我们可以看到减少了 %60 的代码, 逻辑反而变得更清晰了.</p>
<h2 id="2-__u51CF_u5C11_u975E_u5FC5_u987B_u7684_u4E2D_u95F4_u53D8_u91CF"><a href="#2-__u51CF_u5C11_u975E_u5FC5_u987B_u7684_u4E2D_u95F4_u53D8_u91CF" class="headerlink" title="2. 减少非必须的中间变量"></a>2. 减少非必须的中间变量</h2><p>我们都明白了中间变量的意义, 主要是为提高代码的可读性. 但是有时候中间变量的太多, 在增加码量的同时, 也会打断我们的我们的思路.</p>
<p>比如我们要算一个等差数列的和, 我们都知道使用公式 <code>(首项+末项)*项数/2</code>, 我们看一下这个实现:</p>
<figure class="highlight lua"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">local</span> array = &#123;<span class="number">1</span>,<span class="number">3</span>,<span class="number">5</span>,<span class="number">7</span>,<span class="number">9</span>&#125;</span><br><span class="line"><span class="keyword">local</span> array_len = #array</span><br><span class="line"><span class="keyword">local</span> first_element = array[<span class="number">1</span>]</span><br><span class="line"><span class="keyword">local</span> last_element = array[array_len]</span><br><span class="line"><span class="keyword">local</span> sum = (first_element+last_element)*array_len/<span class="number">2</span></span><br></pre></td></tr></table></figure>
<p>就不如下面这个实现:</p>
<figure class="highlight lua"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">local</span> array = &#123;<span class="number">1</span>,<span class="number">3</span>,<span class="number">5</span>,<span class="number">7</span>,<span class="number">9</span>&#125;</span><br><span class="line"><span class="keyword">local</span> sum = (array[<span class="number">1</span>]+array[#array])*#array/<span class="number">2</span></span><br></pre></td></tr></table></figure>
<p>这样的话, 我们上一个示例的代码可以进一步精简:</p>
<figure class="highlight lua"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">self._monthly_take:setButtonEnabled(app.player:getAttribute(<span class="string">"monthly_is_taken"</span>))</span><br></pre></td></tr></table></figure>
<h2 id="3-__u4F7F_u7528_elseif__u4F18_u5316_if__u8BED_u53E5"><a href="#3-__u4F7F_u7528_elseif__u4F18_u5316_if__u8BED_u53E5" class="headerlink" title="3. 使用 elseif 优化 if 语句"></a>3. 使用 elseif 优化 if 语句</h2><p>如果是逻辑相悖的判断条件, 我们可以使用 elseif 语句连接, 而不用多个 if 语句. </p>
<figure class="highlight lua"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> self.item_id == <span class="string">"43"</span> <span class="keyword">then</span></span><br><span class="line">    <span class="comment">-- do some thing</span></span><br><span class="line"><span class="keyword">end</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> self.item_id == <span class="string">"69"</span> <span class="keyword">then</span></span><br><span class="line">    <span class="comment">-- do some thing</span></span><br><span class="line"><span class="keyword">end</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> self.item_id == <span class="string">"75"</span> <span class="keyword">then</span></span><br><span class="line">    <span class="comment">-- do some thing</span></span><br><span class="line"><span class="keyword">end</span></span><br></pre></td></tr></table></figure>
<p>我们可以修改为:</p>
<figure class="highlight lua"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> self.item_id == <span class="string">"43"</span> <span class="keyword">then</span></span><br><span class="line">    <span class="comment">-- do some thing</span></span><br><span class="line"><span class="keyword">elseif</span> self.item_id == <span class="string">"69"</span> <span class="keyword">then</span></span><br><span class="line">    <span class="comment">-- do some thing</span></span><br><span class="line"><span class="keyword">elseif</span> self.item_id == <span class="string">"75"</span> <span class="keyword">then</span></span><br><span class="line">    <span class="comment">-- do some thing</span></span><br><span class="line"><span class="keyword">end</span></span><br></pre></td></tr></table></figure>
<p>这样修改后, 对逻辑的执行时间也优化哟, 因为一但有一个 if 语句命中, 后面的 elseif 都不会再去判断了.</p>
<h2 id="4-__u4F7F_u7528_config__u4F18_u5316_if-elseif__u8BED_u53E5"><a href="#4-__u4F7F_u7528_config__u4F18_u5316_if-elseif__u8BED_u53E5" class="headerlink" title="4. 使用 config 优化 if-elseif 语句"></a>4. 使用 config 优化 if-elseif 语句</h2><p>如果一个逻辑中有大量的 if-elseif 语句, 我么就可以使用 config 的形式替换掉它, 使得逻辑更加简洁.</p>
<p>让我们看一个示例:</p>
<figure class="highlight lua"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> _data.<span class="built_in">type</span> == GameEnum.MailType.MAIL_TYPE_SYSTEM <span class="keyword">then</span></span><br><span class="line">    self._title:setString(_data.content.content.subtype)</span><br><span class="line">    self._name:setString(TextEnum.CNReset.SYSTEM)</span><br><span class="line">    self.title = TextEnum.CNReset.SYSTEM_INFORMATION</span><br><span class="line"><span class="keyword">elseif</span> _data.<span class="built_in">type</span> == GameEnum.MailType.MAIL_TYPE_ALLIANCE_KICK <span class="keyword">then</span></span><br><span class="line">    self._title:setString(TextEnum.CNReset.KICK)</span><br><span class="line">    self._name:setString(TextEnum.CNReset.SYSTEM)</span><br><span class="line">    self.title = TextEnum.CNReset.KICK</span><br><span class="line"><span class="keyword">elseif</span> _data.<span class="built_in">type</span> == GameEnum.MailType.MAIL_TYPE_ALLIANCE_JOIN <span class="keyword">then</span></span><br><span class="line">    self._title:setString(TextEnum.CNReset.JOIN_IN)</span><br><span class="line">    self._name:setString(TextEnum.CNReset.SYSTEM)</span><br><span class="line">    self.title = TextEnum.CNReset.JOIN_IN</span><br><span class="line"><span class="keyword">elseif</span> _data.<span class="built_in">type</span> == GameEnum.MailType.MAIL_TYPE_ALLIANCE_REJECT <span class="keyword">then</span></span><br><span class="line">    ...</span><br></pre></td></tr></table></figure>
<p>这是一段关于邮件标题的逻辑, 这里只节选出了 1/4 的代码, 真的是又臭又长. 我们可以这样子去优化它:</p>
<figure class="highlight lua"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">local</span> CONFIG = &#123;</span><br><span class="line">    [GameEnum.MailType.MAIL_TYPE_SYSTEM] = &#123;title = XXX, name = XXX&#125;,</span><br><span class="line">    [GameEnum.MailType.MAIL_TYPE_ALLIANCE_KICK] = &#123;title = XXX, name = XXX&#125;,</span><br><span class="line">    [GameEnum.MailType.MAIL_TYPE_ALLIANCE_JOIN] = &#123;title = XXX, name = XXX&#125;,</span><br><span class="line">    [GameEnum.MailType.MAIL_TYPE_ALLIANCE_REJECT] = &#123;title = XXX, name = XXX&#125;,</span><br><span class="line">    ...</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">local</span> config = CONFIG[_data.<span class="built_in">type</span>]</span><br><span class="line"><span class="keyword">if</span> config <span class="keyword">then</span></span><br><span class="line">    self._title:setString(config.title)</span><br><span class="line">    self._name:setString(config.name)</span><br><span class="line"><span class="keyword">end</span></span><br></pre></td></tr></table></figure>
<p>因为只是代码节选, 所以上面修改是一段伪代码, 但是看起来超级清爽的有木有! 对于一开始无法确定的数据如何配置呢? 我们可以配置一个 <code>function</code>, 用的时候取出来调用就可以啦.</p>
<h1 id="u4E8C-__u9ED1_u79D1_u6280"><a href="#u4E8C-__u9ED1_u79D1_u6280" class="headerlink" title="二. 黑科技"></a>二. 黑科技</h1><h2 id="1-__u6570_u636E_u9ED8_u8BA4_u503C_u7684_u8BBE_u5B9A"><a href="#1-__u6570_u636E_u9ED8_u8BA4_u503C_u7684_u8BBE_u5B9A" class="headerlink" title="1. 数据默认值的设定"></a>1. 数据默认值的设定</h2><p>当我们拿到一段数据后, 总是要先预处理数据, 后面才是使用数据. 预处理阶段很重要的一步就是某些数据的默认值.</p>
<figure class="highlight lua"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">sum3</span><span class="params">(_num1, _num2, _num3)</span></span></span><br><span class="line">    <span class="keyword">if</span> <span class="keyword">not</span> _num1 <span class="keyword">then</span></span><br><span class="line">        _num1 = <span class="number">0</span></span><br><span class="line">    <span class="keyword">end</span> </span><br><span class="line">    <span class="keyword">if</span> <span class="keyword">not</span> _num2 <span class="keyword">then</span></span><br><span class="line">        _num2 = <span class="number">0</span></span><br><span class="line">    <span class="keyword">end</span></span><br><span class="line">    <span class="keyword">if</span> <span class="keyword">not</span> _num3 <span class="keyword">then</span></span><br><span class="line">        _num3 = <span class="number">0</span></span><br><span class="line">    <span class="keyword">end</span></span><br><span class="line">    <span class="keyword">return</span> _num1 +　_num2 + _num3</span><br><span class="line"><span class="keyword">end</span></span><br></pre></td></tr></table></figure>
<p>很繁琐是不是, 这时候我们可以使用 and 和 or 来优化默认值的设置:</p>
<figure class="highlight lua"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">sum3</span><span class="params">(_num1, _num2, _num3)</span></span></span><br><span class="line">    _num1 = _num1 <span class="keyword">or</span> <span class="number">0</span></span><br><span class="line">    _num2 = _num2 <span class="keyword">or</span> <span class="number">0</span></span><br><span class="line">    _num3 = _num3 <span class="keyword">or</span> <span class="number">0</span></span><br><span class="line">    <span class="keyword">return</span> _num1 +　_num2 + _num3</span><br><span class="line"><span class="keyword">end</span></span><br></pre></td></tr></table></figure>
<p>当 <code>or</code> 的前面部分是 <code>nil</code> 或者 <code>false</code> 的情况下, 返回这个表达式的值后面部分. 下面我列举一下常用类型的默认值用法:</p>
<figure class="highlight lua"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">-- number</span></span><br><span class="line">a = a <span class="keyword">or</span> <span class="number">0</span></span><br><span class="line"><span class="comment">-- string</span></span><br><span class="line">a = a <span class="keyword">or</span> <span class="string">""</span> </span><br><span class="line"><span class="comment">-- function</span></span><br><span class="line">a = a <span class="keyword">or</span> <span class="function"><span class="keyword">function</span><span class="params">()</span></span><span class="keyword">end</span></span><br><span class="line"><span class="comment">-- table</span></span><br><span class="line">a = a <span class="keyword">or</span> &#123;&#125;</span><br><span class="line"><span class="comment">-- boolean</span></span><br><span class="line">a = a == <span class="keyword">nil</span> <span class="keyword">and</span> <span class="keyword">true</span></span><br></pre></td></tr></table></figure>
<p>这里值得一提的是 <code>boolean</code> 类型, 如果希望默认值是 false 话, 就不需要默认值, 因为 nil 和 false 对于判断来说以意义一致. 而如果希望默认值是 true 的话, 并不是 <code>a = a or true</code>, 而是 <code>a == nil and true</code>, 大家可以细想一下其中的含义.</p>
<h2 id="2-_table__u4E2D_u5143_u7D20_u7684_u521D_u59CB_u5316"><a href="#2-_table__u4E2D_u5143_u7D20_u7684_u521D_u59CB_u5316" class="headerlink" title="2. table 中元素的初始化"></a>2. table 中元素的初始化</h2><p>比如我们要统计一个列表中, 每个元素出现的次数:</p>
<figure class="highlight lua"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">local</span> list = &#123;<span class="number">1</span>,<span class="number">2</span>,<span class="number">2</span>,<span class="number">3</span>,<span class="number">1</span>,<span class="number">3</span>&#125;</span><br><span class="line"><span class="keyword">local</span> counter = &#123;&#125;</span><br><span class="line"><span class="keyword">for</span> i,v <span class="keyword">in</span> <span class="built_in">ipairs</span>(list) <span class="keyword">do</span></span><br><span class="line">    <span class="keyword">if</span> <span class="keyword">not</span> counter[v] <span class="keyword">then</span></span><br><span class="line">        counter[v] = <span class="number">0</span></span><br><span class="line">    <span class="keyword">end</span></span><br><span class="line">    counter[v] = counter[v] + <span class="number">1</span></span><br><span class="line"><span class="keyword">end</span></span><br></pre></td></tr></table></figure>
<p>因为 <code>counter</code> 不可能提前初始化好, 所以总是要判断存不存在这个元素, 我们也可以利用上面提到的技巧做这个事情:</p>
<figure class="highlight lua"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">local</span> list = &#123;<span class="number">1</span>,<span class="number">2</span>,<span class="number">2</span>,<span class="number">3</span>,<span class="number">1</span>,<span class="number">3</span>&#125;</span><br><span class="line"><span class="keyword">local</span> counter = &#123;&#125;</span><br><span class="line"><span class="keyword">for</span> i,v <span class="keyword">in</span> <span class="built_in">ipairs</span>(list) <span class="keyword">do</span></span><br><span class="line">    counter[v] = (counter[v] <span class="keyword">or</span> <span class="number">0</span>) + <span class="number">1</span></span><br><span class="line"><span class="keyword">end</span></span><br></pre></td></tr></table></figure>
<p>是不是变得很简洁 ?</p>
]]></content>
    </entry>
    
    <entry>
      <title><![CDATA[最近搞 iOS 版遇到的一些问题和技巧 (二)]]></title>
      <url>http://blog.justbilt.com/2016/06/26/ios-dev-tips-2/</url>
      <content type="html"><![CDATA[<h2 id="u4E00-_XCode_3A_Could_not_find_Developer_Disk_Image"><a href="#u4E00-_XCode_3A_Could_not_find_Developer_Disk_Image" class="headerlink" title="一. XCode: Could not find Developer Disk Image"></a>一. XCode: Could not find Developer Disk Image</h2><p><img src="http://static.zybuluo.com/justbilt/84lvyg8n11lmtefi02pirqup/101138-1ab6ab96d37904bd.jpeg" alt="101138-1ab6ab96d37904bd.jpeg-4.5kB"><br><strong>解决方案:</strong><br><a href="http://www.jianshu.com/p/3930df903a44" target="_blank" rel="external">http://www.jianshu.com/p/3930df903a44</a><br>这个问题可能是因为你 XCode 没有下载对应 iOS 的 SDK 导致, 一般情况需要同步更新 XCode.</p>
<h2 id="u4E8C-_XCode_3A__u65E0_u6CD5_u5BFC_u51FA_Archive__u7684_u9879_u76EE"><a href="#u4E8C-_XCode_3A__u65E0_u6CD5_u5BFC_u51FA_Archive__u7684_u9879_u76EE" class="headerlink" title="二. XCode: 无法导出 Archive 的项目"></a>二. XCode: 无法导出 Archive 的项目</h2><p>这个问题有可能是你项目 Team 选择的是一个没有开发者资格的账号导致的, 虽然可以正常开发, 真机调试, 但是是不能发布的, 所以也无法 Export .<br><strong>解决方案:</strong></p>
<ol>
<li>更换一个有开发者资格的账号重新 Archive 导出, 但是 Bundle ID 就得换一个了.</li>
<li>通过命令行工具导出.<br>在 Organizer 中找到你想导出的 Archive, 右键选择在文件夹中显示, 复制路径, 打开终端:<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">xcodebuild -exportArchive -exportFormat ipa -archivePath your-archive-file-name.xcarchive -exportPath ~/Desktop/test.ipa</span><br></pre></td></tr></table></figure>
</li>
</ol>
<h2 id="u4E09-_XCode_3A_App_Installation_failed"><a href="#u4E09-_XCode_3A_App_Installation_failed" class="headerlink" title="三. XCode: App Installation failed"></a>三. XCode: App Installation failed</h2><p><img src="http://static.zybuluo.com/justbilt/kl9sahl74sqfnxgjem57f390/Unknown.png" alt="Unknown.png-45.1kB"><br>很可能是之前手机已经装过一个同 Bundle ID 的应用, 但是现在换了签名.<br><strong>解决方案:</strong><br>删掉手机已经安装的那个应用就可以啦.</p>
<h2 id="u56DB-_XCode_3A_Failed_to_code_sign__u201Cxxxx_u201D"><a href="#u56DB-_XCode_3A_Failed_to_code_sign__u201Cxxxx_u201D" class="headerlink" title="四. XCode: Failed to code sign “xxxx”"></a>四. XCode: Failed to code sign “xxxx”</h2><p><img src="http://static.zybuluo.com/justbilt/eb80q3re93fflmiuhygk4f1m/QQ20160626-0.png" alt="QQ20160626-0.png-437.7kB"><br>签名失败了, 这种情况一般发生在使用别人给的证书打包时. 这时候我们项目 <code>Build Setting &gt; Code Signing Identity</code> 就不能选择 <code>iOS Developer</code>, 而是要选择导入的签名文件.</p>
<h2 id="u4E94-__u5185_u8D2D_3A__u65E0_u6CD5_u8FDE_u63A5_u5230_iTunes_Store"><a href="#u4E94-__u5185_u8D2D_3A__u65E0_u6CD5_u8FDE_u63A5_u5230_iTunes_Store" class="headerlink" title="五. 内购: 无法连接到 iTunes Store"></a>五. 内购: 无法连接到 iTunes Store</h2><p>如果没有发布应用的话, 需要用沙盒测试账号来测试. 我们需要先在 <code>设置&gt;iTunes Store 和 App Store</code>中 <strong>注销账号</strong>, 然后打开游戏, 开始购买, 这时候输入你的测试账号. 成功后如果有跳转 App Store 的话或者绑定付款方式的话, 不同理会, 再返回应用购买就可以了.</p>
<h2 id="u516D-__u5D29_u6E83_3A_showAlert__u5D29_u6E83"><a href="#u516D-__u5D29_u6E83_3A_showAlert__u5D29_u6E83" class="headerlink" title="六. 崩溃: showAlert 崩溃"></a>六. 崩溃: showAlert 崩溃</h2><p>某一次突然, 一旦调用 quick-x 提供的 <code>device.showAlert</code> 就会崩溃, 断点调试无果, 崩溃时提示的内容也不尽相同.<br><strong>解决方案:</strong><br>删除 <code>RootViewController.mm</code> 中所有和屏幕方向代码, 就解决啦.</p>
<figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">- (<span class="built_in">BOOL</span>)shouldAutorotateToInterfaceOrientation:(<span class="built_in">UIInterfaceOrientation</span>)interfaceOrientation</span><br><span class="line">- (<span class="built_in">NSUInteger</span>) supportedInterfaceOrientations</span><br><span class="line">- (<span class="built_in">BOOL</span>) shouldAutorotate</span><br><span class="line">- (<span class="keyword">void</span>)didRotateFromInterfaceOrientation:(<span class="built_in">UIInterfaceOrientation</span>)fromInterfaceOrientation</span><br></pre></td></tr></table></figure>
<h2 id="u4E03-__u5D29_u6E83_3A_iOS_9-2+__u64AD_u653E_u89C6_u9891_u5D29_u6E83"><a href="#u4E03-__u5D29_u6E83_3A_iOS_9-2+__u64AD_u653E_u89C6_u9891_u5D29_u6E83" class="headerlink" title="七. 崩溃: iOS 9.2+ 播放视频崩溃"></a>七. 崩溃: iOS 9.2+ 播放视频崩溃</h2><p>感谢 @子龙山人 大神提供的解决方案, <a href="https://github.com/cocos2d/cocos2d-x/issues/14855" target="_blank" rel="external">点击这里查看</a>.</p>
<p>将 <code>UIVideoPlayer-ios.mm</code> 文件 <code>~VideoPlayer()</code> 函数中的 <code>dealloc</code> 修改为 <code>release</code> 即可.</p>
<figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">-        [((<span class="built_in">UIVideoViewWrapperIos</span>*)_videoView) dealloc];</span><br><span class="line">+        [((<span class="built_in">UIVideoViewWrapperIos</span>*)_videoView) release];</span><br></pre></td></tr></table></figure>
]]></content>
    </entry>
    
    <entry>
      <title><![CDATA[quick-x 适配 IPV6]]></title>
      <url>http://blog.justbilt.com/2016/06/19/quickx-ipv6/</url>
      <content type="html"><![CDATA[<h1 id="u4E00-_IPV6__u662F_u5565__3F"><a href="#u4E00-_IPV6__u662F_u5565__3F" class="headerlink" title="一. IPV6 是啥 ?"></a>一. IPV6 是啥 ?</h1><p>这两天一个运营的同事跑过来问我:</p>
<blockquote>
<p>他: 咱们的游戏适配那啥 VIP6 了么?<br>我: ….</p>
</blockquote>
<p>苹果商店在儿童节之后就不允许未适配 IPV6 的应用上架了, IPV6 是啥 ? 需要做些什么呢 ? 看完这两篇文章就明白了:</p>
<p><a href="http://www.jianshu.com/p/a6bab07c4062" target="_blank" rel="external">iOS应用支持IPV6，就那点事儿</a><br><a href="http://www.jianshu.com/p/69ed4489762c" target="_blank" rel="external">针对苹果最新审核要求为应用兼容IPv6</a></p>
<p>虽然这两篇文章是针对应用的, 但是从中我们也能了解大概的做法:</p>
<ol>
<li>不建议使用底层的网络API</li>
<li>不要用IP地址</li>
</ol>
<h1 id="u4E8C-_COCOS2D-X__u9002_u914D_IPV6"><a href="#u4E8C-_COCOS2D-X__u9002_u914D_IPV6" class="headerlink" title="二. COCOS2D-X 适配 IPV6"></a>二. COCOS2D-X 适配 IPV6</h1><p>cocos 依赖的三方库涉及到 IPV6 问题的库为 <code>curl</code>, <code>websocket</code>, cocos 自己提供的模块需要适配的有: </p>
<ol>
<li>HttpClient</li>
<li>AssetsManagerEx</li>
<li>SocketIO</li>
<li>WebSocket</li>
<li>Console</li>
<li>ScriptingCore</li>
</ol>
<p>cocos 官方也第一时间适配了 IPV6, 具体内容可以看这篇文章:<a href="https://mp.weixin.qq.com/s?__biz=MjM5ODAxNTM2NA==&amp;mid=2659642350&amp;idx=1&amp;sn=a7db1bb86e965f8408c1687f73b23c7e&amp;scene=1&amp;srcid=0619ztJlty4HuLRBOll0Yr6V&amp;key=18e81ac7415f67c4acff47973e6979565cda32dd8f6c87dca6f733d6e6b4118817536543eb3844b8c890968fdbb06eed&amp;ascene=0&amp;uin=Mjk2MDM0NjgyMA%3D%3D&amp;devicetype=iMac+MacBookAir6%2C2+OSX+OSX+10.10.5+build(14F1021)&amp;version=11020201&amp;pass_ticket=WECSEWT6jaVZNRKNNwilauFgBa%2FhDiF9DioAiHKmly2CArsnkf%2FQbQJchxVf%2F7bk" target="_blank" rel="external">儿童节后苹果爸爸只爱IPv6 Cocos2d-x第一时间支持</a>, 里面描述的很简单:</p>
<blockquote>
<p>如果你需要支持纯IPv6网络，只需要更新CURL和libwebsocket网络。</p>
</blockquote>
<p>让我们尝试一下.</p>
<h2 id="1-__u4E0B_u8F7D_cocos2d-x-3rd-party-libs-bin"><a href="#1-__u4E0B_u8F7D_cocos2d-x-3rd-party-libs-bin" class="headerlink" title="1. 下载 cocos2d-x-3rd-party-libs-bin"></a>1. 下载 cocos2d-x-3rd-party-libs-bin</h2><p>这一步看似很简单, 实则不然. 你不会想到从 github 上下载一个 100 多 MB 的文件是多麽困难, 为此我花费了近 2个小时的时间.</p>
<p>我下载的是 99 版的, 解压代用.</p>
<h2 id="2-__u66F4_u65B0_curl"><a href="#2-__u66F4_u65B0_curl" class="headerlink" title="2. 更新 curl"></a>2. 更新 curl</h2><p>拷贝解压出来的文件夹中的 <code>curl</code> 目录到 <code>quick-cocos2d-x/external</code>, 替换原来的 <code>curl</code> 目录.</p>
<p>打开 xcode, 编译, 发现有 100 多个错误:</p>
<p><img src="http://static.zybuluo.com/justbilt/6b752pk1bzragqhjgbl2llky/image_1alkfke1vag91ccc1p15179c1jtcm.png" alt="image_1alkfke1vag91ccc1p15179c1jtcm.png-113.9kB"></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Undefined symbols for architecture i386:&#10;  &#34;_ASN1_INTEGER_get&#34;, referenced from:&#10;      _ossl_connect_common in libcocos2d iOS.a(libcurl_la-openssl.o)&#10;  &#34;_ASN1_STRING_data&#34;, referenced from:&#10;      _ossl_connect_common in libcocos2d iOS.a(libcurl_la-openssl.o)&#10;  &#34;_ASN1_STRING_length&#34;, referenced from:&#10;      _ossl_connect_common in libcocos2d iOS.a(libcurl_la-openssl.o)&#10;    ...</span><br></pre></td></tr></table></figure>
<p>不要惊慌, 这是因为新版本 curl 多了一些静态库, 我们需要引入它们, 在 XCode 项目输找到 <code>cocos2d_lib &gt; external &gt; curl &gt; ios</code> 目录上右键, 选择 <code>Add Files to &#39;cocos2d_lib.xcodeproj&#39;</code>:</p>
<p><img src="http://static.zybuluo.com/justbilt/1c0jehn0zxvrj7u3pf2cugam/image_1alkfv73t446cr3sc41r6r1hqj13.png" alt="image_1alkfv73t446cr3sc41r6r1hqj13.png-238.8kB"></p>
<p>选中 <code>libcrypto.a</code> 和 <code>libssl.a</code>, targets 选择 <code>libcocos2d iOS</code>, 确定, 重新编译, 搞定.</p>
<h2 id="3-__u66F4_u65B0_websocket"><a href="#3-__u66F4_u65B0_websocket" class="headerlink" title="3. 更新 websocket"></a>3. 更新 websocket</h2><blockquote>
<p>注: 我们项目并没有用到 websocket , 所以这里只是搞到编译通过, 运行时有木有问题就不到知道了!</p>
</blockquote>
<p>和 curl 类似, 拷贝 cocos2d-x-3rd-party-libs 中的 <code>websockets</code> 目录到 <code>quick-cocos2d-x/external</code>, 替换原来的 <code>websockets</code> 目录.</p>
<p>因为最新版的 websockets api 变化挺大, 所以我们需要使用 cocos <a href="https://github.com/cocos2d/cocos2d-x/tree/v3/cocos/network" target="_blank" rel="external">最新的</a> WebSocket.h 和 WebSocket.cpp 替换 quick-cocos2d-x/cocos/network 中的 <code>WebSocket</code> .</p>
<p>编译, 会有一处错误发生在 <code>WebSocket::WebSocket()</code> 中, 因为 quick 中并没有 <code>Director::EVENT_RESET</code> 消息, 我们注释掉这段代码即可.</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">    <span class="comment">// reserve data buffer to avoid allocate memory frequently</span></span><br><span class="line">    _receivedData.reserve(WS_RESERVE_RECEIVE_BUFFER_SIZE);</span><br><span class="line">    <span class="keyword">if</span> (__websocketInstances == <span class="literal">nullptr</span>)</span><br><span class="line">    &#123;</span><br><span class="line">        __websocketInstances = <span class="keyword">new</span> (<span class="built_in">std</span>::nothrow) <span class="built_in">std</span>::<span class="built_in">vector</span>&lt;WebSocket*&gt;();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    __websocketInstances-&gt;push_back(<span class="keyword">this</span>);</span><br><span class="line">    </span><br><span class="line"><span class="comment">//    std::shared_ptr&lt;std::atomic&lt;bool&gt;&gt; isDestroyed = _isDestroyed;</span></span><br><span class="line"><span class="comment">//    _resetDirectorListener = Director::getInstance()-&gt;getEventDispatcher()-&gt;addCustomEventListener(Director::EVENT_RESET, [this, isDestroyed](EventCustom*)&#123;</span></span><br><span class="line"><span class="comment">//        if (*isDestroyed)</span></span><br><span class="line"><span class="comment">//            return;</span></span><br><span class="line"><span class="comment">//        close();</span></span><br><span class="line"><span class="comment">//    &#125;);</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h1 id="u4E09-_QUICK-COCOS2D-X__u9002_u914D_IPV6"><a href="#u4E09-_QUICK-COCOS2D-X__u9002_u914D_IPV6" class="headerlink" title="三. QUICK-COCOS2D-X 适配 IPV6"></a>三. QUICK-COCOS2D-X 适配 IPV6</h1><h2 id="1-__u5982_u4F55_u9002_u914D"><a href="#1-__u5982_u4F55_u9002_u914D" class="headerlink" title="1. 如何适配"></a>1. 如何适配</h2><p>quick-x 中主要是 luasocket 的适配, 适配的方法就是选择性的调用 <code>socket.tcp6()</code> 和 <code>socket.tcp()</code>, udp 也是如此.</p>
<p>quick-x 中调创建 socket 是在 <code>SocketTCP:connect</code> 函数中, 并没有预留 ipv6 参数, 我们需要添加一下:</p>
<figure class="highlight lua"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">SocketTCP:connect</span><span class="params">(__host, __port, __retryConnectWhenFailure, __ipv6)</span></span></span><br><span class="line">    <span class="keyword">if</span> __host <span class="keyword">then</span> self.host = __host <span class="keyword">end</span></span><br><span class="line">    <span class="keyword">if</span> __port <span class="keyword">then</span> self.port = __port <span class="keyword">end</span></span><br><span class="line">    <span class="keyword">if</span> __retryConnectWhenFailure ~= <span class="keyword">nil</span> <span class="keyword">then</span> self.isRetryConnect = __retryConnectWhenFailure <span class="keyword">end</span></span><br><span class="line">    <span class="built_in">assert</span>(self.host <span class="keyword">or</span> self.port, <span class="string">"Host and port are necessary!"</span>)</span><br><span class="line">    <span class="comment">--printInfo("%s.connect(%s, %d)", self.name, self.host, self.port)</span></span><br><span class="line">    <span class="keyword">if</span> __ipv6 <span class="keyword">then</span></span><br><span class="line">        self.tcp = socket.tcp6()</span><br><span class="line">    <span class="keyword">else</span></span><br><span class="line">        self.tcp = socket.tcp()</span><br><span class="line">    <span class="keyword">end</span></span><br><span class="line">    </span><br><span class="line">    self.tcp:settimeout(<span class="number">0</span>)</span><br><span class="line">    ...</span><br></pre></td></tr></table></figure>
<p>然后, 如果要连接 ipv6 的服务器的话, <code>__ipv6</code> 值传 <code>true</code> 即可.</p>
<h2 id="2-__u5982_u4F55_u5224_u65AD_u4E00_u4E2A_u670D_u52A1_u5668_u662F_ipv6__u8FD8_u662F_ipv4"><a href="#2-__u5982_u4F55_u5224_u65AD_u4E00_u4E2A_u670D_u52A1_u5668_u662F_ipv6__u8FD8_u662F_ipv4" class="headerlink" title="2. 如何判断一个服务器是 ipv6 还是 ipv4"></a>2. 如何判断一个服务器是 ipv6 还是 ipv4</h2><p>lua 中 socket 的 dns 模块提供了一个函数 <code>getaddrinfo</code>, 可以返回一个服务器的 dns 解析结果数组, 其中一个很重要的字段就是 <code>family</code>, 有 <code>inet</code> 和 <code>inet6</code> 两个值可选.</p>
<p>大家可以运行 <code>dump(socket.dns.getaddrinfo(&quot;ipv6-test.com&quot;))</code> 看下结果:</p>
<figure class="highlight lua"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">- <span class="string">"&lt;var&gt;"</span> = &#123;</span><br><span class="line">-     <span class="number">1</span> = &#123;</span><br><span class="line">-         <span class="string">"addr"</span>   = <span class="string">"5.135.165.173"</span></span><br><span class="line">-         <span class="string">"family"</span> = <span class="string">"inet"</span></span><br><span class="line">-     &#125;</span><br><span class="line">-     <span class="number">2</span> = &#123;</span><br><span class="line">-         <span class="string">"addr"</span>   = <span class="string">"2001:41d0:8:e8ad::1"</span></span><br><span class="line">-         <span class="string">"family"</span> = <span class="string">"inet6"</span></span><br><span class="line">-     &#125;</span><br><span class="line">- &#125;</span><br></pre></td></tr></table></figure>
<p>我们遍历一下这个结果, 如果其中有 <code>&quot;family&quot; = &quot;inet6&quot;</code> 的解析, 就可以使用 ipv6 进行连接了, 代码实现如下:</p>
<figure class="highlight lua"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">local</span> <span class="function"><span class="keyword">function</span> <span class="title">isSupportIpv6</span><span class="params">(_domain)</span></span></span><br><span class="line">    <span class="keyword">local</span> result = socket.dns.getaddrinfo(_domain)</span><br><span class="line">    <span class="keyword">local</span> ipv6 = <span class="keyword">false</span></span><br><span class="line">    <span class="keyword">if</span> result <span class="keyword">then</span></span><br><span class="line">        <span class="keyword">for</span> k,v <span class="keyword">in</span> <span class="built_in">pairs</span>(result) <span class="keyword">do</span></span><br><span class="line">            <span class="keyword">if</span> v.family == <span class="string">"inet6"</span> <span class="keyword">then</span></span><br><span class="line">                ipv6 = <span class="keyword">true</span></span><br><span class="line">                <span class="keyword">break</span></span><br><span class="line">            <span class="keyword">end</span></span><br><span class="line">        <span class="keyword">end</span></span><br><span class="line">    <span class="keyword">end</span></span><br><span class="line">    <span class="keyword">return</span> ipv6</span><br><span class="line"><span class="keyword">end</span></span><br></pre></td></tr></table></figure>
<p>我们将这个函数的结果作为 <code>SocketTCP:connect</code> 的最后一个参数传入即可.</p>
<h1 id="u56DB-__u8FD8_u6709_u4EC0_u4E48_u8981_u6CE8_u610F_u7684"><a href="#u56DB-__u8FD8_u6709_u4EC0_u4E48_u8981_u6CE8_u610F_u7684" class="headerlink" title="四. 还有什么要注意的"></a>四. 还有什么要注意的</h1><h2 id="1-__u4E00_u5B9A_u8981_u4F7F_u7528_u4F7F_u7528_u57DF_u540D"><a href="#1-__u4E00_u5B9A_u8981_u4F7F_u7528_u4F7F_u7528_u57DF_u540D" class="headerlink" title="1. 一定要使用使用域名"></a>1. 一定要使用使用域名</h2><p>向苹果提审的服务器一定要使用域名, 所有的地方都是如此, 包括 http 请求, 热更新返回的 <code>version.md</code> 地址.</p>
<h2 id="2-__u505A_u597D_u517C_u5BB9_u6027_u6D4B_u8BD5"><a href="#2-__u505A_u597D_u517C_u5BB9_u6027_u6D4B_u8BD5" class="headerlink" title="2. 做好兼容性测试"></a>2. 做好兼容性测试</h2><p>测试 IPV6 ONLY 的时候使用最新的 iOS 9.3 做测试, 苹果他们审核的时候也是只审核最新的系统是否正常. </p>
<p>但是我们实现的时候要兼容的不同的系统, 网络环境(<code>IPV6 兼容</code> 和 <code>IPV6 ONLY</code>), 因为用户的网络可能是各种各样样, 这些组合都要测试到.</p>
]]></content>
    </entry>
    
    <entry>
      <title><![CDATA[quick-x 使用静态库加速 iOS 打包]]></title>
      <url>http://blog.justbilt.com/2016/05/29/quickx-ios-static-lib/</url>
      <content type="html"><![CDATA[<p>quick-x 项目的 iOS 工程使用 <code>Tgarget Dependencise</code> 依赖 <code>cocos2d_lib</code> 和 <code>cocos_lua_bindings</code> 工程.</p>
<p><img src="http://static.zybuluo.com/justbilt/i0vtatej9k1wx2d9ck8fmqhy/QQ20160529-0.png" alt="QQ20160529-0.png-27kB"></p>
<p>这样子在 iOS Archive 时会重新编译这两个项目, 十分痛苦, 尤其是一次出七八个渠道的包, 好几个小时就耗在里面了.</p>
<p>为什么不用静态库, 编译出 .a , 使用时直接链接就可以了嘛.</p>
<h1 id="u4E00-__u7F16_u8BD1_u9759_u6001_u5E93"><a href="#u4E00-__u7F16_u8BD1_u9759_u6001_u5E93" class="headerlink" title="一. 编译静态库"></a>一. 编译静态库</h1><p>找了一下, 原来早已经有小伙伴想到了这点, 这篇文章 <a href="http://www.nicnocquee.com/2016/01/20/build-cocos2d-x-fat-static-library.html" target="_blank" rel="external">Build cocos2d-x fat static library</a> 就特别棒. 从中我们可以发现一个特别有用的脚本 <a href="https://gist.github.com/nicnocquee/9dc4c4a128d7c0bafe23#file-buildstaticlib-sh" target="_blank" rel="external">buildstaticlib.sh</a>, 可以直接使用 xcode 工程编译出静态库.</p>
<p>不过这个脚本只能编译出 <code>Release</code> 版, 我修改下可以传入 <code>configuration</code>, 这样我们可以分别编译出 Debug 和 Release 版的静态库啦, 我修改后的<a href="https://gist.github.com/justbilt/903ef34b568527d57c9bd9bf4069ed72" target="_blank" rel="external">文件在这里</a>.</p>
<p>因为我们要编译出多个静态库, 所有又写了另一个脚本 <code>build.sh</code> 调用 <code>buildstaticlib.sh</code> , 内容如下:</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">./buildstaticlib.sh <span class="variable">$QUICK_V3_ROOT</span>/cocos/scripting/lua-bindings/proj.ios_mac/cocos2d_lua_bindings.xcodeproj <span class="string">"libluacocos2d iOS"</span> <span class="string">"Release"</span></span><br><span class="line"></span><br><span class="line">./buildstaticlib.sh <span class="variable">$QUICK_V3_ROOT</span>/build/cocos2d_libs.xcodeproj <span class="string">"libcocos2d iOS"</span> <span class="string">"Release"</span></span><br><span class="line"></span><br><span class="line">./buildstaticlib.sh <span class="variable">$QUICK_V3_ROOT</span>/cocos/scripting/lua-bindings/proj.ios_mac/cocos2d_lua_bindings.xcodeproj <span class="string">"libluacocos2d iOS"</span> <span class="string">"Debug"</span></span><br><span class="line"></span><br><span class="line">./buildstaticlib.sh <span class="variable">$QUICK_V3_ROOT</span>/build/cocos2d_libs.xcodeproj <span class="string">"libcocos2d iOS"</span> <span class="string">"Debug"</span></span><br></pre></td></tr></table></figure>
<p>运行成功后会在当前目录生成 4 个 .a 文件, 下一步中将会用到.<br><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">.</span><br><span class="line">├── build.sh</span><br><span class="line">├── buildstaticlib.sh</span><br><span class="line">├── libcocos2d\ iOS-debug.a</span><br><span class="line">├── libcocos2d\ iOS.a</span><br><span class="line">├── libluacocos2d\ iOS-debug.a</span><br><span class="line">└── libluacocos2d\ iOS.a</span><br></pre></td></tr></table></figure></p>
<h1 id="u4E8C-__u4F7F_u7528_u9759_u6001_u5E93"><a href="#u4E8C-__u4F7F_u7528_u9759_u6001_u5E93" class="headerlink" title="二. 使用静态库"></a>二. 使用静态库</h1><p>使用 XCode 打开 <code>proj.ios_mac</code> 目录下的 <code>xxx.xcodeproj</code> 工程.</p>
<h2 id="1-__u79FB_u9664_Tgarget_Dependencise"><a href="#1-__u79FB_u9664_Tgarget_Dependencise" class="headerlink" title="1. 移除 Tgarget Dependencise"></a>1. 移除 Tgarget Dependencise</h2><p>首先移除对 <code>cocos2d_lib</code> 和 <code>cocos_lua_bindings</code> 工程的依赖, 右键点击 <code>Delete</code> 然后选择 <code>Remove reference</code> 就可以.</p>
<p><img src="http://static.zybuluo.com/justbilt/3d9eiua1tind8aycakjwymgl/QQ20160529-1.png" alt="QQ20160529-1.png-49.2kB"></p>
<h2 id="2-__u6DFB_u52A0_Other_Linker_Flags"><a href="#2-__u6DFB_u52A0_Other_Linker_Flags" class="headerlink" title="2. 添加 Other Linker Flags"></a>2. 添加 Other Linker Flags</h2><p>我们静态库的依赖是在这里添加的, 在 Debug 和 Release 选项中分别加入对应的静态库.<br><img src="http://static.zybuluo.com/justbilt/5g1o6ozh1j4dlybcjftfybnr/QQ20160529-3.png" alt="QQ20160529-3.png-117.8kB"></p>
<p>这样就完成啦, 尝试一下 Archive 的速度吧 !</p>
<h1 id="u4E09-__u5176_u4ED6"><a href="#u4E09-__u5176_u4ED6" class="headerlink" title="三. 其他"></a>三. 其他</h1><h2 id="1-__u8C03_u8BD5_u73AF_u5883_u4E0E_u751F_u4EA7_u73AF_u5883"><a href="#1-__u8C03_u8BD5_u73AF_u5883_u4E0E_u751F_u4EA7_u73AF_u5883" class="headerlink" title="1. 调试环境与生产环境"></a>1. 调试环境与生产环境</h2><p>我们改成静态库后, 调试 cocos 引擎的代码会多有不便, 而且一旦修改了 cocos 的代码, 就得重新生成静态库, 对于开发阶段太不友好了.</p>
<p>我们的解决方案, 就是再建立一个 debug 工程, 这个工程依旧使用依赖项目的方式编译 cocos , 调试流程和以前一致. 上线打包时则使用我们的静态库版本, 多渠道也做在这个工程中, 享受静态库带来的编译加速.</p>
<p>最终我们的目录结构是这个样子的:</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">.</span><br><span class="line">├── runtime-src</span><br><span class="line">│   ├── Classes</span><br><span class="line">│   ├── proj.android</span><br><span class="line">│   ├── proj.android_no_anysdk</span><br><span class="line">│   ├── proj.android_studio</span><br><span class="line">│   ├── proj.ios_mac</span><br><span class="line">│   ├── proj.win32</span><br><span class="line">│   └── proj.wp8-xaml</span><br><span class="line">└── runtime-src-debug</span><br><span class="line">    ├── Classes</span><br><span class="line">    └── proj.ios_mac</span><br></pre></td></tr></table></figure>
<h2 id="2-__u751F_u4EA7_u73AF_u5883_u5DE5_u7A0B_u7626_u8EAB"><a href="#2-__u751F_u4EA7_u73AF_u5883_u5DE5_u7A0B_u7626_u8EAB" class="headerlink" title="2. 生产环境工程瘦身"></a>2. 生产环境工程瘦身</h2><p>这一步可有可无, 我的代码洁癖又犯了, 所以顺手改了一下. </p>
<p>这时的生产环境除静态库外的内容和调试环境几乎一致, 然而有一些东西是我们用不到的:</p>
<ol>
<li>mac 平台对应的内容</li>
<li>Classes/runtime 下的内容</li>
</ol>
<p>删除这些时改动了 AppDelegate 中的东西, 这也上一步为什么从 <code>runtimes-src</code> 目录复制了一份.</p>
<h2 id="3-__u8FDB_u4E00_u6B65_u52A0_u901F_u7F16_u8BD1"><a href="#3-__u8FDB_u4E00_u6B65_u52A0_u901F_u7F16_u8BD1" class="headerlink" title="3. 进一步加速编译"></a>3. 进一步加速编译</h2><p>这一步我们目前还没有做, 只是一个想法.</p>
<p>修改完使用静态库后, 编译速度得到了很大的提升, 但还没有达到极致, 因为 quick 特有的 c++ 文件还是以文件形式存在于工程中的. 所有 Archive 的时候还是有一百多个源文件需要编译.</p>
<p>如果我们能进一步拆分, 新建一个 lib 工程, 将 quick 的源文件添加和依赖项目添加进去, 我们的游戏只依赖这样的一个静态库, 是否可以达到一个极致的编译速度 ?</p>
<h2 id="4-__u9759_u6001_u5E93_u6587_u4EF6_u7684_u7248_u672C_u7BA1_u7406"><a href="#4-__u9759_u6001_u5E93_u6587_u4EF6_u7684_u7248_u672C_u7BA1_u7406" class="headerlink" title="4. 静态库文件的版本管理"></a>4. 静态库文件的版本管理</h2><p>在编译出 debug 版的静态库之前, 我还有想法将这几个静态库压缩上传到 git 上, 编译出 debug 版之后, 我就一个想法, ignore them !</p>
<p>所以我最终的策略 将这几个 .a 在 git 上忽略掉, 同时在那个目录保留了一个编译脚本, 谁要用到 iOS 项目的时候, 发现没有 .a , 自己运行脚本编译一份就可以啦 !</p>
<h2 id="5-__u7F16_u8BD1_u811A_u672C_u4F18_u5316__3F"><a href="#5-__u7F16_u8BD1_u811A_u672C_u4F18_u5316__3F" class="headerlink" title="5. 编译脚本优化 ?"></a>5. 编译脚本优化 ?</h2><p>现在那个编译脚本会编译出一个 <code>fat</code>(armv7 armv7s arm64 i386 x86_64) 版的静态库, 内部实现其实是编译了好多次, 导致现在编译时间非常长.</p>
<p>思考:</p>
<ol>
<li>是否有必要编出 <code>i386 x86_64</code> 版本 ?</li>
<li>看到虾神的一篇文章貌似说可以以 armv7+arm64, i386+x86_64 组合两次打出所有版本.</li>
</ol>
<h2 id="6-__u6700_u7EC8_Archive__u51FA_u7684_u5305_u4F1A_u6BD4_u4F7F_u7528_u6E90_u6587_u4EF6_u5927__3F"><a href="#6-__u6700_u7EC8_Archive__u51FA_u7684_u5305_u4F1A_u6BD4_u4F7F_u7528_u6E90_u6587_u4EF6_u5927__3F" class="headerlink" title="6. 最终 Archive 出的包会比使用源文件大 ?"></a>6. 最终 Archive 出的包会比使用源文件大 ?</h2><p>看到网上有过这个说法, 我没有在修改前后分别 Archive 对比包体, 不太严谨. </p>
<p>但和我之前某一次的包相比, 只大了几百KB, 还不太确定是不是与使用静态库有关系, 大家在修改时可以注意对比一下.</p>
]]></content>
    </entry>
    
    <entry>
      <title><![CDATA[cocos2d-x 优化游戏资源体积]]></title>
      <url>http://blog.justbilt.com/2016/05/08/compress-res/</url>
      <content type="html"><![CDATA[<h1 id="u4E00-__u5220_u9664_u65E0_u7528_u8D44_u6E90"><a href="#u4E00-__u5220_u9664_u65E0_u7528_u8D44_u6E90" class="headerlink" title="一. 删除无用资源"></a>一. 删除无用资源</h1><p>在我们版本迭代的过程中, 总有一些图片被废弃掉, 如果当时忘记删除的话, 久而久之也就忘记了. 如果在上线前不做一次整理的话, 它们就会残存在你的资源中, 浪费包的体积.</p>
<p>为避免这种情况, 我们可以做的是:</p>
<h2 id="1-__u5E9F_u5F03_u7684_u56FE_u7247_u4E00_u5B9A_u8981_u53CA_u65F6_u5220_u9664"><a href="#1-__u5E9F_u5F03_u7684_u56FE_u7247_u4E00_u5B9A_u8981_u53CA_u65F6_u5220_u9664" class="headerlink" title="1. 废弃的图片一定要及时删除"></a>1. 废弃的图片一定要及时删除</h2><h2 id="2-__u7F16_u5199_u5E9F_u5F03_u8D44_u6E90_u67E5_u627E_u5DE5_u5177"><a href="#2-__u7F16_u5199_u5E9F_u5F03_u8D44_u6E90_u67E5_u627E_u5DE5_u5177" class="headerlink" title="2. 编写废弃资源查找工具"></a>2. 编写废弃资源查找工具</h2><p>可以用到的系统命令是 <code>ack</code>, 我们可以通过 <code>brew install ack</code> 安装, 使用的效果:</p>
<p><img src="http://ww2.sinaimg.cn/large/7f870d23gw1f3upxy29uej20iy083gna.jpg" alt=""></p>
<p>关于 ack 的更多用法请<a href="http://beyondgrep.com/documentation/" target="_blank" rel="external">移步这里</a>.</p>
<h1 id="u4E8C-__u4F7F_u7528_u66FF_u4EE3_u5BF9_u8C61"><a href="#u4E8C-__u4F7F_u7528_u66FF_u4EE3_u5BF9_u8C61" class="headerlink" title="二. 使用替代对象"></a>二. 使用替代对象</h1><h2 id="1-__u4F7F_u75289_u56FE"><a href="#1-__u4F7F_u75289_u56FE" class="headerlink" title="1. 使用9图"></a>1. 使用9图</h2><p>大家都知道图片在拉伸的过程中会失真, 那么如何避免这个情况呢? 使用9图. </p>
<p><img src="http://ww2.sinaimg.cn/large/7f870d23gw1f3uqafyaevj206t04mjrj.jpg" alt=""></p>
<p>注: 配图来自<a href="http://mux.baidu.com/?p=1506" target="_blank" rel="external">http://mux.baidu.com/?p=1506</a></p>
<p>这样我们就可以将一张很大的图缩小到很小, 然后使用9图拉伸, 起到节省资源的目的. 9图在 cocos 中的对象是 <code>Scale9Sprite</code>, 具体用法可以参考<a href="http://shahdza.blog.51cto.com/2410787/1543284" target="_blank" rel="external">这篇文章</a>.</p>
<h2 id="2-__u901A_u8FC7_u4FEE_u6539_u8272_u8C03_u5B9E_u73B0_u8D44_u6E90_u590D_u7528"><a href="#2-__u901A_u8FC7_u4FEE_u6539_u8272_u8C03_u5B9E_u73B0_u8D44_u6E90_u590D_u7528" class="headerlink" title="2. 通过修改色调实现资源复用"></a>2. 通过修改色调实现资源复用</h2><p>知乎上有一篇问题讲的就是这个:<br><a href="https://www.zhihu.com/question/31133351" target="_blank" rel="external">拳皇中的人物变色是如何实现的？</a><br><a href="http://daily.zhihu.com/story/4797855" target="_blank" rel="external">知乎日报上的这篇</a></p>
<p><img src="http://ww4.sinaimg.cn/large/7f870d23gw1f3uqjn3tz0j20ig08at9r.jpg" alt=""></p>
<p>cocos2d-x 版由 <a href="https://fusijie.github.io/2015/05/27/sprite-with-hue/" target="_blank" rel="external">@偶尔e网事</a> 大神实现, 对应的对象是 <code>SpriteWithHue</code>, 目前已经默认集成到了 cocos2d-x 中.</p>
<p>这样我们就可以将原来只是色调差异的图片用程序来实现啦~</p>
<h2 id="3-__u4F7F_u7528_u5E73_u94FA"><a href="#3-__u4F7F_u7528_u5E73_u94FA" class="headerlink" title="3. 使用平铺"></a>3. 使用平铺</h2><p><img src="http://ww4.sinaimg.cn/large/7f870d23gw1f3ur1pd7j5j20m8069tbd.jpg" alt=""></p>
<p>注: 配图来自<a href="http://bullteacher.com/7-textures.html" target="_blank" rel="external">http://bullteacher.com/7-textures.html</a></p>
<p>游戏中的有些图片完全可以通过平铺实现, 这样的话我们就可以让美术只出一个平铺单元的图片,在程序中去实现平铺.</p>
<p>首先, 平铺的这个功能是 opengl 层面就支持的, 详情大家可以<a href="http://bullteacher.com/7-textures.html" target="_blank" rel="external">移步这里</a>, cocos2d-x 中实现平铺很简单:</p>
<figure class="highlight lua"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">-- 首先, 使用平铺单元图片创建一个精灵</span></span><br><span class="line"><span class="keyword">local</span> sprite = cc.Sprite:create(<span class="string">"your_repeat_image.png"</span>)</span><br><span class="line"><span class="comment">-- 然后, 设置纹理参数</span></span><br><span class="line">sprite:getTexture():setTexParameters(gl.LINEAR, gl.LINEAR, gl.REPEAT, gl.REPEAT)</span><br><span class="line"><span class="comment">-- 最后, 将这个精灵的纹理矩形设置为我们想要的大小</span></span><br><span class="line">sprite:setTextureRect(cc.rect(<span class="number">0</span>,<span class="number">0</span>,<span class="number">1024</span>,<span class="number">1024</span>))</span><br></pre></td></tr></table></figure>
<blockquote>
<p>注意:　平铺单元图片的尺寸只能是2的幂</p>
</blockquote>
<h1 id="u4E09-__u538B_u7F29"><a href="#u4E09-__u538B_u7F29" class="headerlink" title="三. 压缩"></a>三. 压缩</h1><h2 id="1-__u65E0_u635F_u538B_u7F29"><a href="#1-__u65E0_u635F_u538B_u7F29" class="headerlink" title="1. 无损压缩"></a>1. 无损压缩</h2><p>无损压缩还是十分值得推荐的, 它的原理知乎上<a href="https://www.zhihu.com/question/23752454" target="_blank" rel="external">这个答案</a>讲的很清晰, 我节选其中的关键文字:</p>
<blockquote>
<p>1.核心原理很简单，通俗的解释一下，就是由于PNG格式的灵活性，他可以有很多种方式表示同一张图片，不同方式有时就会导致文件大小不一样…<br>2.还有一点是PNG采用的是deflate算法，也非常的灵活，他的压缩率和encoder的实现有关，不同的encoder使用的时间，压缩出来的大小都不一样…<br>3.当然除了上面这两点是真正的无损压缩以外，还有减小PNG文件大小的方式就是去除一些对图片本身没有任何影响的metadata…</p>
</blockquote>
<p>所以无损压缩纯粹是单方面的受益, <strong>是一定要做的</strong>.</p>
<p>我们无损压缩主要用到的工具: <a href="https://imageoptim.com/mac" target="_blank" rel="external">ImageOptim</a></p>
<h2 id="2-__u6709_u635F_u538B_u7F29"><a href="#2-__u6709_u635F_u538B_u7F29" class="headerlink" title="2. 有损压缩"></a>2. 有损压缩</h2><p><img src="http://ww1.sinaimg.cn/large/7f870d23gw1f3uvav83k9j20g707fabp.jpg" alt=""></p>
<p>有损压缩会损失一部分的图片质量, 但带来的受益还是十分可观的. 这是一个抉择的过程, 以最小的代价获取最大的受益, 甚至不能批量处理, 可能需要一张一张的人肉对比压缩.</p>
<p>我们有损压缩主要用到的工具: <a href="http://ppduck.com/" target="_blank" rel="external">PP鸭</a></p>
<h1 id="u56DB-__u9009_u62E9_u6B63_u786E_u7684_u56FE_u7247_u683C_u5F0F"><a href="#u56DB-__u9009_u62E9_u6B63_u786E_u7684_u56FE_u7247_u683C_u5F0F" class="headerlink" title="四. 选择正确的图片格式"></a>四. 选择正确的图片格式</h1><h2 id="1-__u5C06_u65E0_alpha__u901A_u9053_u7684_png__u56FE_u7247_u5B58_u50A8_u4E3A_jpg"><a href="#1-__u5C06_u65E0_alpha__u901A_u9053_u7684_png__u56FE_u7247_u5B58_u50A8_u4E3A_jpg" class="headerlink" title="1. 将无 alpha 通道的 png 图片存储为 jpg"></a>1. 将无 alpha 通道的 png 图片存储为 jpg</h2><h2 id="2-__u9009_u7528_u538B_u7F29_u7387_u66F4_u9AD8_u7684_u56FE_u7247_u683C_u5F0F"><a href="#2-__u9009_u7528_u538B_u7F29_u7387_u66F4_u9AD8_u7684_u56FE_u7247_u683C_u5F0F" class="headerlink" title="2. 选用压缩率更高的图片格式"></a>2. 选用压缩率更高的图片格式</h2><h1 id="u4E94-__u5176_u4ED6"><a href="#u4E94-__u5176_u4ED6" class="headerlink" title="五. 其他"></a>五. 其他</h1><h2 id="1-__u5706_u5F62_u56FE_u7247_u53EA_u4F7F_u7528_1/4"><a href="#1-__u5706_u5F62_u56FE_u7247_u53EA_u4F7F_u7528_1/4" class="headerlink" title="1. 圆形图片只使用 1/4"></a>1. 圆形图片只使用 1/4</h2><p>然后在程序中翻转3次,得到其他角度的图片. 一般会用在图片尺寸特别大的场景. </p>
<p><img src="http://ww4.sinaimg.cn/large/7f870d23gw1f3uvnfb31aj20hd09v74p.jpg" alt=""></p>
<p>如上图, 我们游戏中一个全屏幕的雷达就是通过这个方案减少图片体积的.</p>
<h2 id="2-__u7F29_u5C0F_u56FE_u7247"><a href="#2-__u7F29_u5C0F_u56FE_u7247" class="headerlink" title="2. 缩小图片"></a>2. 缩小图片</h2><p>将展示精度不强的图片(比如: 游戏背景上的小装饰, 爆炸的序列帧)缩小, 在程序中放大. </p>
<h2 id="3-__u7279_u6B8A_u65B9_u6848_u5206_u79BBpng_u7684_u900F_u660E_u901A_u9053"><a href="#3-__u7279_u6B8A_u65B9_u6848_u5206_u79BBpng_u7684_u900F_u660E_u901A_u9053" class="headerlink" title="3. 特殊方案分离png的透明通道"></a>3. 特殊方案分离png的透明通道</h2><p><a href="http://www.cocoachina.com/bbs/read.php?tid-201144.html" target="_blank" rel="external">用jpg和黑白色png作为遮罩实现透明</a><br><a href="http://blog.csdn.net/dawn_moon/article/details/8631783" target="_blank" rel="external">用shader使图片背景透明</a><br><a href="http://www.cnblogs.com/elang/p/4104452.html" target="_blank" rel="external">cocos2dx中使用JPG图和只带Alpha的PNG图合成渲染</a></p>
<p>我们之前曾经采取过其中的一个方案, 将一张 png 图片拆分为 jpg+alpha.png 的形式, 整体的包体小了近 25% , 不过也带来的其他的一些副作用.</p>
<p>建议大家使用这类黑科技前一定要做好调研和测试用例, 评估一下实际的收益.</p>
]]></content>
    </entry>
    
    <entry>
      <title><![CDATA[quick-x EditBox 几个小技巧]]></title>
      <url>http://blog.justbilt.com/2016/05/01/quickx-editbox-util/</url>
      <content type="html"><![CDATA[<p>我们项目中的输入框使用的都是 EditBox , 但是 EditBox 还存在一些问题, 这里给大家分享一下我们的解决方案.</p>
<h1 id="u4E00-__u5B57_u4F53_u8FC7_u5927"><a href="#u4E00-__u5B57_u4F53_u8FC7_u5927" class="headerlink" title="一. 字体过大"></a>一. 字体过大</h1><p>用过 EditBox 的同学都知道这样一个情况, EditBox 在创建时是无法传入字体大小的, 字体大小默认和 EditBox 的 size 一致. 如果要修改字体大小的话, 就必须有程序的参与, 十分讨厌.</p>
<p>而我们聪明的设计师 @大勇同学 则想到了一个非常棒的办法, 使用一张透明的9图来创建 EditBox, 后面再放置一个真实效果的 Scale9Sprite , 这样就可以实现字体比边框小很多的输入框了.</p>
<h1 id="u4E8C-__u591A_u884C_u8F93_u5165"><a href="#u4E8C-__u591A_u884C_u8F93_u5165" class="headerlink" title="二. 多行输入"></a>二. 多行输入</h1><p>多行输入是一个很有必要的事情, 我们在写邮件, 军团公告等界面都有类似的需求, 然而 EditBox 并不能很好的支持多行输入, 不同平台间也存在差异, 一直很头疼这件事情. </p>
<p>然而团队中另外一位成员 @小齐同学 却用另一种十分脑洞的方案解决了这个问题, 着实让人佩服. 他的思路是这样子的:</p>
<blockquote>
<p>创建一个和需求大小一致的 EditBox, 同时创建一个 LalbelTTF , 将 dimensions 属性设置为需求大小. 处理 EditBox 使之看不见, 但又能正常输入, 同时监听输入文字变化事件, 在事件中修改 LalbelTTF 的文字.</p>
</blockquote>
<p>核心就是让 EditBox 承担只文字输入的功能, 而让另外一个 LalbelTTF 来承担文字显示的功能. 实现的代码如下:</p>
<figure class="highlight lua"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">EditBoxUtil.multiline</span><span class="params">(_editbox, _label, _params)</span></span></span><br><span class="line">    _params = _params <span class="keyword">or</span> &#123;&#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">-- 本来这个应该只是Android上的设置, 但是为了避免平台的差异性, 因此统一处理</span></span><br><span class="line">    _editbox:setCascadeOpacityEnabled(<span class="keyword">true</span>)</span><br><span class="line">    _editbox:setOpacity(<span class="number">0</span>)</span><br><span class="line">    <span class="keyword">if</span> device.platform == <span class="string">"android"</span> <span class="keyword">then</span></span><br><span class="line">        <span class="comment">-- 避免文字过大导致Android系统崩溃</span></span><br><span class="line">        _editbox:setFont(<span class="string">"Helvetica"</span>,<span class="number">2</span>)</span><br><span class="line">    <span class="keyword">elseif</span> device.platform == <span class="string">"ios"</span> <span class="keyword">or</span> device.platform == <span class="string">"mac"</span> <span class="keyword">then</span></span><br><span class="line">        _editbox:setFont(<span class="string">"Helvetica"</span>,<span class="number">0</span>)</span><br><span class="line">    <span class="keyword">end</span></span><br><span class="line"></span><br><span class="line">    _editbox:registerScriptEditBoxHandler(<span class="function"><span class="keyword">function</span><span class="params">(event)</span></span>  </span><br><span class="line">        <span class="keyword">if</span> event == <span class="string">"began"</span> <span class="keyword">then</span>  </span><br><span class="line">            _editbox:setText(_label:getString())</span><br><span class="line">        <span class="keyword">elseif</span> event == <span class="string">"changed"</span> <span class="keyword">then</span></span><br><span class="line">            _label:setString(_editbox:getText())</span><br><span class="line">        <span class="keyword">elseif</span> event == <span class="string">"return"</span> <span class="keyword">then</span></span><br><span class="line">            _label:setString(_editbox:getText())</span><br><span class="line">        <span class="keyword">end</span></span><br><span class="line">        <span class="keyword">if</span> _params.listener <span class="keyword">then</span></span><br><span class="line">            _params.listener(event, _editbox)</span><br><span class="line">        <span class="keyword">end</span></span><br><span class="line">    <span class="keyword">end</span>)</span><br><span class="line"><span class="keyword">end</span></span><br></pre></td></tr></table></figure>
<p>这段代码和简单, 但背后所遇到的坑却不少, 且听我来道一道:</p>
<h2 id="1-__u4E3A_u4EC0_u4E48_u8981_u8C03_u7528_setFont"><a href="#1-__u4E3A_u4EC0_u4E48_u8981_u8C03_u7528_setFont" class="headerlink" title="1. 为什么要调用 setFont"></a>1. 为什么要调用 setFont</h2><p>如果只是想设置字体大小, EditBox 明明有提供 <code>setFontSize</code> 接口, 为什么要调用 <code>setFont</code> ? 请看 setFontSize 实现:</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">void</span> EditBox::setFontSize(<span class="keyword">int</span> fontSize)</span><br><span class="line">&#123;</span><br><span class="line">    _fontSize = fontSize;</span><br><span class="line">    <span class="keyword">if</span> (_editBoxImpl != <span class="literal">nullptr</span> &amp;&amp; _fontName.length() &gt; <span class="number">0</span>)</span><br><span class="line">    &#123;</span><br><span class="line">        _editBoxImpl-&gt;setFont(_fontName.c_str(), _fontSize);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>可以看到 setFontSize 在没有设置字体名称 <code>_fontName</code> 时是没有作用的.</p>
<h2 id="2-__u4E3A_u4EC0_u4E48_u8981_u5206_u5E73_u53F0_u6765_u5B9E_u73B0"><a href="#2-__u4E3A_u4EC0_u4E48_u8981_u5206_u5E73_u53F0_u6765_u5B9E_u73B0" class="headerlink" title="2. 为什么要分平台来实现"></a>2. 为什么要分平台来实现</h2><p>在接入 android 前,我们是没有分平台实现的, 只是 <code>setFont(&quot;Helvetica&quot;,0)</code> , 在 iOS 上没有任何问题, 但是在 Android 上会 catch 到 <code>divide by zero</code> 崩溃, 估计是某一个地方用 fontsize 做被除数了吧 , 于是 Android 上改为设置透明度.</p>
<h2 id="3-_Android__u8F93_u5165_u8FC7_u591A_u6587_u5B57_u540E_u4F1A_u5D29_u6E83_28OOM_29"><a href="#3-_Android__u8F93_u5165_u8FC7_u591A_u6587_u5B57_u540E_u4F1A_u5D29_u6E83_28OOM_29" class="headerlink" title="3. Android 输入过多文字后会崩溃(OOM)"></a>3. Android 输入过多文字后会崩溃(OOM)</h2><p>崩溃在 <code>Cocos2dxBitmap.java</code> 的 <code>getPixels</code> 函数中:<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">byte</span>[] getPixels(<span class="keyword">final</span> Bitmap bitmap) &#123;</span><br><span class="line">    <span class="keyword">if</span> (bitmap != <span class="keyword">null</span>) &#123;</span><br><span class="line">        <span class="keyword">final</span> <span class="keyword">byte</span>[] pixels = <span class="keyword">new</span> <span class="keyword">byte</span>[bitmap.getWidth() * bitmap.getHeight() * <span class="number">4</span>];</span><br><span class="line">        <span class="keyword">final</span> ByteBuffer buf = ByteBuffer.wrap(pixels);</span><br><span class="line">        buf.order(ByteOrder.nativeOrder());</span><br><span class="line">        bitmap.copyPixelsToBuffer(buf);</span><br><span class="line">        <span class="keyword">return</span> pixels;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>在 <code>new byte</code> 这里触发了报错的原因是 <code>Out Of Memory</code> 异常 ! 调试发现 <code>bitmap</code> 的宽高惊人的达到了 <code>12000x600</code> ! </p>
<p>经过 @bin 的提醒, 发现这里可能是因为 EditBox 字体过大的原因, 因为 EditBox 会默认设置字体字体大小和 Scale9Sprite 的 PreferredSize 一直, 就可能设置字体大小为 100+ , 文字一多尺寸当然就上去了! 所以便有了这么一行:</p>
<figure class="highlight lua"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> device.platform == <span class="string">"android"</span> <span class="keyword">then</span></span><br><span class="line">    <span class="comment">-- 避免文字过大导致Android系统崩溃</span></span><br><span class="line">    _editbox:setFont(<span class="string">"Helvetica"</span>,<span class="number">2</span>)</span><br></pre></td></tr></table></figure>
<h1 id="u4E8C-__u5C4F_u853D_Emoji__u8F93_u5165"><a href="#u4E8C-__u5C4F_u853D_Emoji__u8F93_u5165" class="headerlink" title="二. 屏蔽 Emoji 输入"></a>二. 屏蔽 Emoji 输入</h1><p>按照要求游戏中玩家可以输入文字的地方都是不能够输入 Emoji 表情的, 原因有两点:</p>
<ol>
<li>不同系统间表现存在差异</li>
<li>EditBox Android 版输入确认后会变乱码</li>
<li>后台搜索玩家时不太方便</li>
</ol>
<p>因此, 我们需要屏蔽 Emoji 表情的输入, 我们有两种做法:</p>
<ol>
<li>无法输入, 弹出键盘点击表情没有反应</li>
<li>输入完成后, 游戏内点击提交时提示非法</li>
</ol>
<p>我们采用的是第二种方案, 这个无法通过纯 lua 代码实现, 需要分平台去做.</p>
<h2 id="1-_iOS"><a href="#1-_iOS" class="headerlink" title="1. iOS"></a>1. iOS</h2><p>修改 <code>UIEditBoxImpl-ios.mm</code> 文件的 <code>shouldChangeCharactersInRange</code> 函数:</p>
<figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br></pre></td><td class="code"><pre><span class="line">- (<span class="built_in">BOOL</span>)textField:(<span class="built_in">UITextField</span> *) textField shouldChangeCharactersInRange:(<span class="built_in">NSRange</span>)range replacementString:(<span class="built_in">NSString</span> *)string</span><br><span class="line">&#123;</span><br><span class="line">    __block <span class="built_in">BOOL</span> returnValue = <span class="literal">NO</span>;</span><br><span class="line">    [string enumerateSubstringsInRange:<span class="built_in">NSMakeRange</span>(<span class="number">0</span>, [string length]) options:<span class="built_in">NSStringEnumerationByComposedCharacterSequences</span> usingBlock:</span><br><span class="line">     ^(<span class="built_in">NSString</span> *substring, <span class="built_in">NSRange</span> substringRange, <span class="built_in">NSRange</span> enclosingRange, <span class="built_in">BOOL</span> *stop) &#123;</span><br><span class="line">         </span><br><span class="line">         <span class="keyword">if</span> ([substring rangeOfCharacterFromSet: [<span class="built_in">NSCharacterSet</span> characterSetWithRange:<span class="built_in">NSMakeRange</span>(<span class="number">0xFE00</span>, <span class="number">16</span>)]]<span class="variable">.location</span> != <span class="built_in">NSNotFound</span>) &#123;</span><br><span class="line">             returnValue = <span class="literal">YES</span>;</span><br><span class="line">         &#125;</span><br><span class="line">         </span><br><span class="line">         <span class="keyword">const</span> <span class="keyword">unichar</span> high = [substring characterAtIndex: <span class="number">0</span>];</span><br><span class="line">         </span><br><span class="line">         <span class="comment">// Surrogate pair (U+1D000-1F9FF)</span></span><br><span class="line">         <span class="keyword">if</span> (<span class="number">0xD800</span> &lt;= high &amp;&amp; high &lt;= <span class="number">0xDBFF</span>) &#123;</span><br><span class="line">             <span class="keyword">const</span> <span class="keyword">unichar</span> low = [substring characterAtIndex: <span class="number">1</span>];</span><br><span class="line">             <span class="keyword">const</span> <span class="keyword">int</span> codepoint = ((high - <span class="number">0xD800</span>) * <span class="number">0x400</span>) + (low - <span class="number">0xDC00</span>) + <span class="number">0x10000</span>;</span><br><span class="line">             </span><br><span class="line">             returnValue = (<span class="number">0x1D000</span> &lt;= codepoint &amp;&amp; codepoint &lt;= <span class="number">0x1F9FF</span>);</span><br><span class="line">             </span><br><span class="line">             <span class="comment">// Not surrogate pair (U+2100-27BF)</span></span><br><span class="line">         &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">             returnValue = (<span class="number">0x2100</span> &lt;= high &amp;&amp; high &lt;= <span class="number">0x27BF</span>);</span><br><span class="line">         &#125;</span><br><span class="line">     &#125;];</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">if</span> (returnValue) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">NO</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    </span><br><span class="line">    <span class="keyword">if</span> (getEditBoxImplIOS()-&gt;getMaxLength() &lt; <span class="number">0</span>)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">YES</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="built_in">NSUInteger</span> oldLength = [textField<span class="variable">.text</span> length];</span><br><span class="line">    <span class="built_in">NSUInteger</span> replacementLength = [string length];</span><br><span class="line">    <span class="built_in">NSUInteger</span> rangeLength = range<span class="variable">.length</span>;</span><br><span class="line">    </span><br><span class="line">    <span class="built_in">NSUInteger</span> newLength = oldLength - rangeLength + replacementLength;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">return</span> newLength &lt;= getEditBoxImplIOS()-&gt;getMaxLength();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>这段代码是我从 <a href="https://github.com/woxtu/NSString-RemoveEmoji" target="_blank" rel="external">https://github.com/woxtu/NSString-RemoveEmoji</a> 中提取出来的.</p>
<h2 id="2-_Android"><a href="#2-_Android" class="headerlink" title="2. Android"></a>2. Android</h2><p>Android 上的实现也很简单, 主要是需要创建一个新的 <code>InputFilter</code> 用来过滤 Emoji 表情. 需要修改 <code>Cocos2dxEditBoxDialog.java</code> 文件成员变量添加:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> InputFilter EMOJI_FILTER = <span class="keyword">new</span> InputFilter() &#123;</span><br><span class="line"></span><br><span class="line">    <span class="annotation">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> CharSequence <span class="title">filter</span><span class="params">(CharSequence source, <span class="keyword">int</span> start, <span class="keyword">int</span> end, Spanned dest, <span class="keyword">int</span> dstart, <span class="keyword">int</span> dend)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> index = start; index &lt; end; index++) &#123;</span><br><span class="line">            <span class="keyword">int</span> type = Character.getType(source.charAt(index));</span><br><span class="line">            <span class="keyword">if</span> (type == Character.SURROGATE || type == Character.OTHER_SYMBOL || type == Character.PRIVATE_USE) &#123;</span><br><span class="line">                <span class="keyword">return</span> <span class="string">""</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>
<p>修改 <code>onCreate</code> 函数 <code>setFilters</code> 处逻辑:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> (<span class="keyword">this</span>.mMaxLength &gt; <span class="number">0</span>) &#123;</span><br><span class="line">    <span class="keyword">this</span>.mInputEditText.setFilters(<span class="keyword">new</span> InputFilter[] &#123; <span class="keyword">new</span> InputFilter.LengthFilter(<span class="keyword">this</span>.mMaxLength), EMOJI_FILTER &#125;);</span><br><span class="line">&#125;<span class="keyword">else</span>&#123;</span><br><span class="line">    <span class="keyword">this</span>.mInputEditText.setFilters(<span class="keyword">new</span> InputFilter[] &#123; EMOJI_FILTER &#125;);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<hr>
<p>关于 Emoji 的相关修改都已经推送到了 github 上, <a href="https://github.com/mafiagame/quick-cocos2d-x/commit/8a7c27aedb919e0ae5d178d688b704e620c2c1bb" target="_blank" rel="external">点击这里</a>查看.</p>
]]></content>
    </entry>
    
    <entry>
      <title><![CDATA[最近遇到的几个 quick-x  真机崩溃]]></title>
      <url>http://blog.justbilt.com/2016/04/10/quickx-crash-on-phone/</url>
      <content type="html"><![CDATA[<p>最近这段时间遇到了两次比较严重的真机崩溃问题, 都是之前所没有遇到过的, 特此记录一下, 希望能帮助到遇到类似问题的朋友.</p>
<p>之所以强调真机, 是因为这些问题在 player 上或者 debug 版无法出现, 只有真正运行在手机上才可能遇到, 因为最后我们 Archive 出来的包都是 release 版的.</p>
<h1 id="1-_removeFromParent"><a href="#1-_removeFromParent" class="headerlink" title="1. removeFromParent"></a>1. removeFromParent</h1><p>removeFromParent() 多次会导致崩溃并闪退, 很难以想象是吧, 在我的记忆中应该只是抛出一个 lua 错误. 事实上, debug 版确实如此, 让我们看一段测试代码:</p>
<figure class="highlight lua"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">self._btnLogin:removeFromParent()</span><br><span class="line">self._btnLogin:removeFromParent()</span><br></pre></td></tr></table></figure>
<p>player 上会收到如下的 lua 错误提示:</p>
<figure class="highlight lua"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">LUA ERROR: [<span class="built_in">string</span> <span class="string">"xxx.lua"</span>]:<span class="number">349</span>: invalid <span class="string">'cobj'</span> <span class="keyword">in</span> <span class="function"><span class="keyword">function</span> '<span class="title">lua_cocos2dx_Node_removeFromParentAndCleanup</span>'</span></span><br></pre></td></tr></table></figure>
<p>让我们看下抛出这个错误的地方 <code>lua_cocos2dx_Node_removeFromParentAndCleanup</code> :</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="preprocessor">#<span class="keyword">if</span> COCOS2D_DEBUG &gt;= <span class="number">1</span></span></span><br><span class="line">    <span class="keyword">if</span> (!cobj)</span><br><span class="line">    &#123;</span><br><span class="line">        tolua_error(tolua_S,<span class="string">"invalid 'cobj' in function 'lua_cocos2dx_Node_removeFromParentAndCleanup'"</span>, <span class="literal">nullptr</span>);</span><br><span class="line">        <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">    &#125;</span><br><span class="line"><span class="preprocessor">#<span class="keyword">endif</span></span></span><br></pre></td></tr></table></figure>
<p>第一次调用完 removeFromParent(), <code>_btnLogin</code> 的 c++ 对象就已经被释放了, 再次调用 <code>cobj</code> 就是 <code>NULL</code> 了, 所以就会进入到这个判断中, 从而抛出错误.</p>
<p>但是这段代码却是运行在 COCOS2D_DEBUG 宏中的, 就意味着这段代码在 release 版是不生效的, 所以就会接着往下执行, 从而导致崩溃.</p>
<p>虽然我们不太可能直接会用一个对象调用 removeFromParent 多次, 但是包含 removeFromParent 的函数被调用多次却是很有可能的, 所以我们一定要养成一个好的习惯, 在 <code>removeFromParent</code> 之前要做判空检测, 之后要立刻置空:</p>
<figure class="highlight lua"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> xxx <span class="keyword">then</span></span><br><span class="line">    xxx:removeFromParent()</span><br><span class="line">    xxx = <span class="keyword">nil</span></span><br><span class="line"><span class="keyword">end</span></span><br></pre></td></tr></table></figure>
<h1 id="2-_Signal_13_was_raised-_SIGPIPE"><a href="#2-_Signal_13_was_raised-_SIGPIPE" class="headerlink" title="2. Signal 13 was raised. SIGPIPE"></a>2. Signal 13 was raised. SIGPIPE</h1><p>当游戏在 iOS 上不切换到后台直接锁屏一段时间, 网络资源就会被系统回收掉, 这时候解锁屏幕, 游戏并不知道 tcp 连接已经断开, 发送消息就会触发这个崩溃.</p>
<p>表现出来的效果是手机解锁不了, 得等好久才可以.</p>
<p>关于具体技术解释, 大家可以看这篇文章, <a href="http://blog.csdn.net/jia12216/article/details/50844013" target="_blank" rel="external">Signal 13 was raised（SIGPIPE管道破裂）</a>, 我这里重点讲解决方案.</p>
<p>网上说有两种解决方案(<a href="http://www.jianshu.com/p/1957d2b18d2c" target="_blank" rel="external">如何在 iOS 上避免 SIGPIPE 信号导致的 crash</a>):</p>
<h2 id="1-__u5728_u5168_u5C40_u8303_u56F4_u5185_u5FFD_u7565_u8FD9_u4E2A_u4FE1_u53F7"><a href="#1-__u5728_u5168_u5C40_u8303_u56F4_u5185_u5FFD_u7565_u8FD9_u4E2A_u4FE1_u53F7" class="headerlink" title="1. 在全局范围内忽略这个信号"></a>1. 在全局范围内忽略这个信号</h2><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">signal(SIGPIPE, SIG_IGN);</span><br></pre></td></tr></table></figure>
<h2 id="2-__u5728_u4E00_u5F00_u59CB_u7684_u65F6_u5019_u8BBE_u7F6E_socket__u4E0D_u8981_u53D1_u9001_SIGPIPE__u4FE1_u53F7"><a href="#2-__u5728_u4E00_u5F00_u59CB_u7684_u65F6_u5019_u8BBE_u7F6E_socket__u4E0D_u8981_u53D1_u9001_SIGPIPE__u4FE1_u53F7" class="headerlink" title="2. 在一开始的时候设置 socket 不要发送 SIGPIPE 信号"></a>2. 在一开始的时候设置 socket 不要发送 SIGPIPE 信号</h2><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">int</span> value = <span class="number">1</span>;</span><br><span class="line">setsockopt(sock, SOL_SOCKET, SO_NOSIGPIPE, &amp;value, <span class="keyword">sizeof</span>(value));</span><br></pre></td></tr></table></figure>
<p>就 1 来说, cocos 早已设置了忽略, 在 <code>socket_open</code> 函数中, 并且这的执行到了. 我在 <code>tcp.c</code> 中的 <code>tcp_create</code> 中加入 2 方案, 确实解决了这个问题. 但是 <code>SO_NOSIGPIPE</code> 并不是跨平台的, 我偷懒直接用宏判断了下:</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">int</span> <span class="title">tcp_create</span><span class="params">(lua_State *L, <span class="keyword">int</span> family)</span> </span>&#123;</span><br><span class="line">    t_socket sock;</span><br><span class="line">    <span class="keyword">const</span> <span class="keyword">char</span> *err = inet_trycreate(&amp;sock, family, SOCK_STREAM);</span><br><span class="line">    <span class="comment">/* try to allocate a system socket */</span></span><br><span class="line">    <span class="keyword">if</span> (!err) &#123;</span><br><span class="line">        ...</span><br><span class="line">        </span><br><span class="line"><span class="preprocessor">#<span class="keyword">ifdef</span> CC_TARGET_OS_IPHONE</span></span><br><span class="line">        <span class="keyword">int</span> val = <span class="number">1</span>;</span><br><span class="line">        setsockopt(sock, SOL_SOCKET, SO_NOSIGPIPE, (<span class="keyword">void</span> *)&amp;val, <span class="keyword">sizeof</span>(<span class="keyword">int</span>));</span><br><span class="line"><span class="preprocessor">#<span class="keyword">endif</span></span></span><br><span class="line">        ...</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
]]></content>
    </entry>
    
    <entry>
      <title><![CDATA[最近搞 iOS 版遇到的一些问题和技巧]]></title>
      <url>http://blog.justbilt.com/2016/04/04/ios-dev-tips/</url>
      <content type="html"><![CDATA[<h1 id="u4E00-__u7F16_u8BD1_u8FD0_u884C"><a href="#u4E00-__u7F16_u8BD1_u8FD0_u884C" class="headerlink" title="一. 编译运行"></a>一. 编译运行</h1><h2 id="1-__u8FD0_u884C_u65F6_u63D0_u793A_identity__u65E0_u6548"><a href="#1-__u8FD0_u884C_u65F6_u63D0_u793A_identity__u65E0_u6548" class="headerlink" title="1. 运行时提示 identity 无效"></a>1. 运行时提示 identity 无效</h2><p><img src="http://ww2.sinaimg.cn/large/7f870d23gw1f2ker4f0hhj20nc08eabu.jpg" alt=""></p>
<blockquote>
<p>The identity used to sign the executable is no longer valid.<br>Please verify that your device’s clock is properly set, and that your signing certificate is not expired. (0xE8008018).</p>
</blockquote>
<p>解决方案:</p>
<ol>
<li>打开 Preferences &gt; Accounts</li>
<li>选中项目对应的 Apple ID &gt; 点击右下角 <code>View Details...</code></li>
<li>点击弹出框左下角的 <code>Download All</code> &gt; 等待完成后点击 <code>Done</code> 关闭</li>
<li>再次运行项目, 等待弹出框, 点击 <code>reset</code>.</li>
</ol>
<p><img src="http://ww1.sinaimg.cn/large/7f870d23gw1f2khakkr86j20ja0a0go3.jpg" alt=""></p>
<h2 id="2-_iPhone5__u4E0A_u83B7_u5F97_u7684_u8BBE_u5907_u5C3A_u5BF8_u4E3A_960x640"><a href="#2-_iPhone5__u4E0A_u83B7_u5F97_u7684_u8BBE_u5907_u5C3A_u5BF8_u4E3A_960x640" class="headerlink" title="2. iPhone5 上获得的设备尺寸为 960x640"></a>2. iPhone5 上获得的设备尺寸为 960x640</h2><p>表现出来是竖屏游戏上线有黑边, 跟踪发现获得的设备尺寸为 960x640, 而非 1136x640.</p>
<p>解决方案:</p>
<p>添加一张尺寸为 <code>1136x640</code> 名为 <code>Default-568h@2x.png</code> 的启动图即可.</p>
<p>参考资料:<br><a href="http://discuss.cocos2d-x.org/t/getframesize-get-wrong-screen-size/7657" target="_blank" rel="external">http://discuss.cocos2d-x.org/t/getframesize-get-wrong-screen-size/7657</a></p>
<h2 id="3-_XCode_issue__u9875_u9762_u53EA_u663E_u793A_u9519_u8BEF_2C__u4E0D_u663E_u793A_u8B66_u544A"><a href="#3-_XCode_issue__u9875_u9762_u53EA_u663E_u793A_u9519_u8BEF_2C__u4E0D_u663E_u793A_u8B66_u544A" class="headerlink" title="3. XCode issue 页面只显示错误, 不显示警告"></a>3. XCode issue 页面只显示错误, 不显示警告</h2><p>cocos2d-x 在 XCode 中编译 warning 太多, 出错后 error 会被淹没在一大堆的警告中, 得拖动半天才能找得到.</p>
<p>解决方案:</p>
<p><img src="http://ww2.sinaimg.cn/large/7f870d23gw1f2kib70c4qj207500mt8h.jpg" alt=""></p>
<p>在页面最下方有一个感叹号型按钮, 点击选中即可.</p>
<h1 id="u4E8C-__u4E0A_u4F20_u5E94_u7528"><a href="#u4E8C-__u4E0A_u4F20_u5E94_u7528" class="headerlink" title="二. 上传应用"></a>二. 上传应用</h1><h2 id="1-__u591A_u4EFB_u52A1_u652F_u6301"><a href="#1-__u591A_u4EFB_u52A1_u652F_u6301" class="headerlink" title="1. 多任务支持"></a>1. 多任务支持</h2><blockquote>
<p>XCode 7 error: “A launch storyboard or xib must be provided unless the app requires full screen”</p>
</blockquote>
<p>解决方案:</p>
<p>我们勾上全屏即可:<br><img src="http://ww1.sinaimg.cn/large/7f870d23gw1f2khkqmob7j20b809it9f.jpg" alt=""></p>
<hr>
<p>目前就这些, 后面会持续更新 !</p>
]]></content>
    </entry>
    
    <entry>
      <title><![CDATA[记一次 quick-x 内存泄露排查]]></title>
      <url>http://blog.justbilt.com/2016/03/19/quickx-memery-leak/</url>
      <content type="html"><![CDATA[<p>这周 @bin 告诉我项目有比较严重的内存泄露, 任意一个界面不停的打开关闭, 内存占用会一直往上涨, 直到被系统 kill 掉.</p>
<h1 id="u4E00-__u786E_u5B9A_u95EE_u9898"><a href="#u4E00-__u786E_u5B9A_u95EE_u9898" class="headerlink" title="一. 确定问题"></a>一. 确定问题</h1><p>收到问题后, 我简单写了一段测试代码, 加载/移除界面 100 次, 对比内存变化:</p>
<figure class="highlight lua"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">local</span> index = <span class="number">0</span></span><br><span class="line"><span class="keyword">local</span> handler = <span class="keyword">nil</span></span><br><span class="line">handler = scheduler.scheduleGlobal(<span class="function"><span class="keyword">function</span><span class="params">( ... )</span></span></span><br><span class="line">    <span class="comment">-- 加载界面</span></span><br><span class="line">    app.sceneManager:pushLayer(<span class="built_in">require</span>(<span class="string">'app.scenes.PageShop'</span>).new())</span><br><span class="line">    self:performWithDelay(<span class="function"><span class="keyword">function</span><span class="params">( ... )</span></span></span><br><span class="line">        <span class="comment">-- 移除界面</span></span><br><span class="line">        app.sceneManager:popLayer()</span><br><span class="line">        index = index + <span class="number">1</span></span><br><span class="line">        <span class="keyword">if</span> index &gt;= <span class="number">100</span> <span class="keyword">then</span></span><br><span class="line">            scheduler.unscheduleGlobal(handler)</span><br><span class="line">        <span class="keyword">end</span></span><br><span class="line">    <span class="keyword">end</span>, <span class="number">0.5</span>)</span><br><span class="line"><span class="keyword">end</span>, <span class="number">0.5</span>)</span><br></pre></td></tr></table></figure>
<p>为了方便, 我没有进行真机测试, 而是使用 xcode 启动 player 来进行测试, 在 Xcode 的 <code>Debug Navigator/Memory Report</code> 窗口查看结果.</p>
<p><img src="http://ww3.sinaimg.cn/large/7f870d23gw1f23kr8dricj20rh0fstab.jpg" alt=""></p>
<p>在测试前的平稳内存为 194M , 测试后惊人的达到了 258M, 十分严重的内存泄露了!</p>
<h1 id="u4E8C-__u521D_u6B65_u89E3_u51B3_u95EE_u9898"><a href="#u4E8C-__u521D_u6B65_u89E3_u51B3_u95EE_u9898" class="headerlink" title="二. 初步解决问题"></a>二. 初步解决问题</h1><p>由于项目是纯 lua 的, 所以不太可能是数据和逻辑的问题, 那么很有可能是视图(cocos2d-x 对象)存在内存泄露. 而每一个界面都存在问题, 那么很可能是某个通用组件存在问题.</p>
<p>经过一番努力, 最终成功找到了内存持续增加的原因, 一共两处:</p>
<h2 id="1-_lua__u5783_u573E_u6CA1_u6709_u53CA_u65F6_u56DE_u6536"><a href="#1-_lua__u5783_u573E_u6CA1_u6709_u53CA_u65F6_u56DE_u6536" class="headerlink" title="1. lua 垃圾没有及时回收"></a>1. lua 垃圾没有及时回收</h2><p>lua 的垃圾是会自动回收的, 但我们有时候可能需要手动回收下, 比如切换场景时, 关闭界面时, 主动回收的代码很简单:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">collectgarbage(&#34;collect&#34;)</span><br></pre></td></tr></table></figure>
<p>我将这段代码加到了统一关闭界面的地方.</p>
<p>更多关于 lua 垃圾回收的具体问题大家可以参考这个两篇文章:</p>
<p><a href="http://luatut.com/collectgarbage.html" target="_blank" rel="external">http://luatut.com/collectgarbage.html</a><br><a href="http://www.codingnow.com/2000/download/lua_manual.html" target="_blank" rel="external">http://www.codingnow.com/2000/download/lua_manual.html</a></p>
<h2 id="2-__u7CBE_u7075_u53D8_u7070_u548C_u9AD8_u4EAE_u7684_shader__u521B_u5EFA_u540E_u4E00_u76F4_u6CA1_u6709_u91CA_u653E"><a href="#2-__u7CBE_u7075_u53D8_u7070_u548C_u9AD8_u4EAE_u7684_shader__u521B_u5EFA_u540E_u4E00_u76F4_u6CA1_u6709_u91CA_u653E" class="headerlink" title="2. 精灵变灰和高亮的 shader 创建后一直没有释放"></a>2. 精灵变灰和高亮的 shader 创建后一直没有释放</h2><figure class="highlight lua"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">GameUtils.SetSpriteGrey</span><span class="params">(sprite,is_grey)</span></span></span><br><span class="line">    <span class="keyword">if</span> sprite <span class="keyword">and</span> sprite.setGLProgramState <span class="keyword">then</span></span><br><span class="line">        <span class="keyword">if</span> is_grey <span class="keyword">then</span></span><br><span class="line">            <span class="keyword">local</span> pProgram = cc.GLProgram:createWithByteArrays(ShaderData.vertDefaultSourceGrey, ShaderData.pszFragSourceGrey)</span><br><span class="line">            ...</span><br><span class="line">            sprite:setGLProgram(pProgram) </span><br><span class="line">        <span class="keyword">else</span> </span><br><span class="line">            <span class="keyword">local</span> pProgram = cc.GLProgramState:getOrCreateWithGLProgram(cc.GLProgramCache:getInstance():getGLProgram(<span class="string">"ShaderPositionTextureColor_noMVP"</span>))</span><br><span class="line">            sprite:setGLProgramState(pProgram)</span><br><span class="line">        <span class="keyword">end</span> </span><br><span class="line">    <span class="keyword">end</span></span><br><span class="line"><span class="keyword">end</span></span><br></pre></td></tr></table></figure>
<p>这段代码看起来没有任何问题, 我能想到只是没有用 <code>GLProgramCache</code> 缓存起来, 造成每次都会创建的效率问题, 应该不会导致泄露吗 ? 精灵被释放时难道不会自动释放所引用的 GLProgram 吗?</p>
<p>因为当时项目比较紧急, 我将这段代码使用 <code>GLProgramCache</code> 的形式修改了一下, 惊奇的发现内存泄露问题竟然解决了. 修改后的代码如下:</p>
<figure class="highlight lua"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">GameUtils.SetSpriteGrey</span><span class="params">(sprite,is_grey)</span></span></span><br><span class="line">    <span class="keyword">if</span> sprite <span class="keyword">and</span> sprite.setGLProgramState <span class="keyword">then</span></span><br><span class="line">        <span class="keyword">if</span> is_grey <span class="keyword">then</span></span><br><span class="line">            <span class="keyword">local</span> pProgram = cc.GLProgramCache:getInstance():getGLProgram(<span class="string">"ShaderPositionTextureColor_Gray"</span>)</span><br><span class="line">            <span class="keyword">if</span> <span class="keyword">not</span> pProgram <span class="keyword">then</span></span><br><span class="line">                pProgram = cc.GLProgram:createWithByteArrays(ShaderData.vertDefaultSourceGrey, ShaderData.pszFragSourceGrey)</span><br><span class="line">                pProgram:bindAttribLocation(cc.ATTRIBUTE_NAME_POSITION, cc.VERTEX_ATTRIB_POSITION)</span><br><span class="line">                pProgram:bindAttribLocation(cc.ATTRIBUTE_NAME_COLOR, cc.VERTEX_ATTRIB_COLOR)</span><br><span class="line">                pProgram:bindAttribLocation(cc.ATTRIBUTE_NAME_TEX_COORD, cc.VERTEX_ATTRIB_FLAG_TEX_COORDS)</span><br><span class="line">                pProgram:link()</span><br><span class="line">                pProgram:updateUniforms()</span><br><span class="line">                cc.GLProgramCache:getInstance():addGLProgram(pProgram, <span class="string">"ShaderPositionTextureColor_Gray"</span>)</span><br><span class="line">            <span class="keyword">end</span></span><br><span class="line">            sprite:setGLProgram(pProgram) </span><br><span class="line">        <span class="keyword">else</span> </span><br><span class="line">            sprite:setGLProgram(cc.GLProgramCache:getInstance():getGLProgram(<span class="string">"ShaderPositionTextureColor_noMVP"</span>))</span><br><span class="line">        <span class="keyword">end</span> </span><br><span class="line">    <span class="keyword">end</span></span><br><span class="line"><span class="keyword">end</span></span><br></pre></td></tr></table></figure>
<h1 id="u4E09-__u9690_u85CF_u5728_u80CC_u540E_u7684_u79D8_u5BC6"><a href="#u4E09-__u9690_u85CF_u5728_u80CC_u540E_u7684_u79D8_u5BC6" class="headerlink" title="三. 隐藏在背后的秘密"></a>三. 隐藏在背后的秘密</h1><p>问题解决了, 那么是不是可以结束了呢 ? 并不能, 晚上回到家我就一直在思考这个问题, 倒是是什么原因导致了 GLProgram 内存没有释放, 而使用 GLProgramCache 就没有问题.</p>
<p>莫不是 cocos2d-x 的 bug ? cocos 对象是基于引用计数去自动释放内存的. 我排查了几处可疑的地方:</p>
<ol>
<li>GLProgram::createWithByteArrays 调用了 autorelease</li>
<li>Node::setGLProgram 调用了 retain</li>
<li>Node::~Node 调用了 release</li>
</ol>
<p>貌似都没有问题. 那么我可以跟踪下引用计数的变化, 看看是哪一步出现的问题! 经过一番调试,最终定位到了问题, 大家请看:</p>
<p><img src="http://ww1.sinaimg.cn/large/7f870d23gw1f2anef57p3j20u60370ts.jpg" alt=""></p>
<p>1.<code>Node::setGLProgram</code> 进入到 <code>GLProgramState::getOrCreateWithGLProgram</code>, 这一步没有什么问题.</p>
<p><img src="http://ww4.sinaimg.cn/large/7f870d23gw1f2aneul8cej20u7021jrx.jpg" alt=""></p>
<p>2.这里有一个新的缓存 <code>GLProgramStateCache</code> , 进入它到 <code>getGLProgramState</code> 函数.</p>
<p><img src="http://ww3.sinaimg.cn/large/7f870d23gw1f2anf4bv4tj20u906l402.jpg" alt=""></p>
<p>3.这一步是 GLProgramStateCache 的核心代码了, 判断有无在缓存中, 没有则 insert 到末尾. 这里的 <code>_glProgramStates</code> 是一个 <code>Map</code> , 而这个 map 竟然是以传递进来的 <code>glprogram</code> 做<br> key , 而我们每次传递进来的 glprogram 都是新创建的, 所以在我们这个使用情况下缓存根本是无效的.</p>
<p><img src="http://ww1.sinaimg.cn/large/7f870d23gw1f2anfex5v1j20tx03zjs1.jpg" alt=""></p>
<p>4.让我看一下, <code>GLProgramState</code> 的 <code>init</code> 函数, 这下找到 retain 地方了. </p>
<p>这样的话, 就讲得通了, GLProgram 会在 GLProgramState 析构的时候 release 掉. 而 GLProgramState 只会在 GLProgramStateCache:removeAllGLProgramState 释放掉. 而 removeAllGLProgramState 只有在手动或者游戏退出的时候才会调用.</p>
<p>OK, 这下定位到了问题, 虽然我们使用有些问题, 但 GLProgramStateCache 设计确实有不合理的地方, 大家记得正确用法就好了, 就是 shader 一定要使用 GLProgramCache !</p>
<hr>
<p>后记</p>
<p>通过这次解决问题, 我有一个特别大的收获. 就是做优化工作时一定不能去猜, 要有数据和逻辑的支持.</p>
]]></content>
    </entry>
    
    <entry>
      <title><![CDATA[在 quick-x 中使用 TableView]]></title>
      <url>http://blog.justbilt.com/2016/03/13/quickx-tableview/</url>
      <content type="html"><![CDATA[<p>上篇文章说到使用 TableView 可以大幅提升界面的创建速度, 这篇文章我们来看看如何在 quick 中使用它.</p>
<h1 id="u4E00-__u57FA_u672C_u7528_u6CD5"><a href="#u4E00-__u57FA_u672C_u7528_u6CD5" class="headerlink" title="一. 基本用法"></a>一. 基本用法</h1><h2 id="1-__u521B_u5EFA_u5BF9_u8C61"><a href="#1-__u521B_u5EFA_u5BF9_u8C61" class="headerlink" title="1. 创建对象"></a>1. 创建对象</h2><p>首先, 创建一个 TableView 对象:</p>
<figure class="highlight lua"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">local</span> view = cc.TableView:create(cc.size(<span class="number">480</span>,<span class="number">320</span>))</span><br></pre></td></tr></table></figure>
<p>传入的那个 size 是 viewsize, 即可视区域的尺寸, 后期也可以通过 <code>setViewSize</code> 来调节.</p>
<h2 id="2-__u8BBE_u7F6E_u586B_u5145_u987A_u5E8F"><a href="#2-__u8BBE_u7F6E_u586B_u5145_u987A_u5E8F" class="headerlink" title="2. 设置填充顺序"></a>2. 设置填充顺序</h2><p>下面设置填充顺序, 默认是从下往上填充, 我们习惯了使用从上往下填充, 所以需要修改下:<br><figure class="highlight lua"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">view:setVerticalFillOrder(cc.TABLEVIEW_FILL_TOPDOWN)</span><br></pre></td></tr></table></figure></p>
<p>其可选值如下:<br><figure class="highlight lua"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">cc.TABLEVIEW_FILL_TOPDOWN = <span class="number">0</span>  <span class="comment">-- 从上自下</span></span><br><span class="line">cc.TABLEVIEW_FILL_BOTTOMUP = <span class="number">1</span> <span class="comment">-- 从下自上</span></span><br></pre></td></tr></table></figure></p>
<p>这个值最终会影响所有 cell 的顺序, 具体些是第 0 个元素在最上面还是在最下面.</p>
<h2 id="3-__u6CE8_u518C_u4E8B_u4EF6_u76D1_u542C"><a href="#3-__u6CE8_u518C_u4E8B_u4EF6_u76D1_u542C" class="headerlink" title="3. 注册事件监听"></a>3. 注册事件监听</h2><p>TableView 提供了好多事件, 具体作用如下:</p>
<figure class="highlight lua"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">cc.SCROLLVIEW_SCRIPT_SCROLL = <span class="number">0</span></span><br><span class="line">cc.SCROLLVIEW_SCRIPT_ZOOM   = <span class="number">1</span></span><br><span class="line">cc.TABLECELL_TOUCHED        = <span class="number">2</span></span><br><span class="line">cc.TABLECELL_HIGH_LIGHT     = <span class="number">3</span></span><br><span class="line">cc.TABLECELL_UNHIGH_LIGHT   = <span class="number">4</span> </span><br><span class="line">cc.TABLECELL_WILL_RECYCLE   = <span class="number">5</span></span><br><span class="line">cc.TABLECELL_SIZE_FOR_INDEX = <span class="number">6</span> <span class="comment">-- 获取节点尺寸的回调</span></span><br><span class="line">cc.TABLECELL_SIZE_AT_INDEX  = <span class="number">7</span> <span class="comment">-- 获取对应位置节点的回调</span></span><br><span class="line">cc.NUMBER_OF_CELLS_IN_TABLEVIEW = <span class="number">8</span> <span class="comment">-- 获取节点数量的回调</span></span><br></pre></td></tr></table></figure>
<p>但其实真正有意义的就三个, 6,7,8. 其他的<strong>根本不会回调</strong>, 注册了也没有什么用. 注册监听使用 <code>registerScriptHandler</code> 函数.</p>
<h3 id="1_29-__u6CE8_u518C_u8282_u70B9_u6570_u91CF_u56DE_u8C03"><a href="#1_29-__u6CE8_u518C_u8282_u70B9_u6570_u91CF_u56DE_u8C03" class="headerlink" title="1). 注册节点数量回调"></a>1). 注册节点数量回调</h3><figure class="highlight lua"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">view:registerScriptHandler(<span class="function"><span class="keyword">function</span><span class="params">()</span></span></span><br><span class="line">    <span class="keyword">return</span> <span class="number">10</span> <span class="comment">-- 假如有10个节点</span></span><br><span class="line"><span class="keyword">end</span>, cc.NUMBER_OF_CELLS_IN_TABLEVIEW)</span><br></pre></td></tr></table></figure>
<p>返回节点数量.</p>
<h3 id="2_29-__u6CE8_u518C_u83B7_u53D6_u8282_u70B9_u5C3A_u5BF8_u7684_u56DE_u8C03"><a href="#2_29-__u6CE8_u518C_u83B7_u53D6_u8282_u70B9_u5C3A_u5BF8_u7684_u56DE_u8C03" class="headerlink" title="2). 注册获取节点尺寸的回调"></a>2). 注册获取节点尺寸的回调</h3><p>若是每个节点一致, 则可以返回一个固定尺寸; 若不一致, 可以根据 idx 去取出对应节点的尺寸.</p>
<figure class="highlight lua"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">view:registerScriptHandler(<span class="function"><span class="keyword">function</span><span class="params">(table, idx)</span></span></span><br><span class="line">    <span class="comment">-- 默认尺寸</span></span><br><span class="line">    <span class="keyword">local</span> size = self.defaultSize</span><br><span class="line">    <span class="keyword">local</span> cell = view:cellAtIndex(idx)</span><br><span class="line">    <span class="keyword">if</span> cell <span class="keyword">then</span></span><br><span class="line">        <span class="comment">-- cell.view 属性是在线面创建 cell 时赋值的.</span></span><br><span class="line">        size = cell.view:getBoundingBox()</span><br><span class="line">    <span class="keyword">end</span></span><br><span class="line">    <span class="keyword">return</span> size.height, size.width</span><br><span class="line"><span class="keyword">end</span>, cc.TABLECELL_SIZE_FOR_INDEX)</span><br></pre></td></tr></table></figure>
<p>注意, 这里如果是纵向滚动的话,返回顺序是高,宽; 横向滚动的话则返回宽,高. </p>
<h3 id="3_29-__u83B7_u53D6_u5BF9_u5E94_u4F4D_u7F6E_u8282_u70B9_u7684_u56DE_u8C03"><a href="#3_29-__u83B7_u53D6_u5BF9_u5E94_u4F4D_u7F6E_u8282_u70B9_u7684_u56DE_u8C03" class="headerlink" title="3). 获取对应位置节点的回调"></a>3). 获取对应位置节点的回调</h3><p>这个回调的名称和上面那个很像, 有时候会分不清楚.</p>
<figure class="highlight lua"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">view:registerScriptHandler(<span class="function"><span class="keyword">function</span><span class="params">(table, idx)</span></span></span><br><span class="line">    <span class="keyword">local</span> cell = <span class="built_in">table</span>:dequeueCell()</span><br><span class="line">    <span class="keyword">if</span> <span class="keyword">nil</span> == cell <span class="keyword">then</span></span><br><span class="line">        cell = cc.TableViewCell:new()</span><br><span class="line">        cell.view = self.class.new()</span><br><span class="line">            :pos(self.class.designSize.width/<span class="number">2</span>, self.class.designSize.height/<span class="number">2</span>)</span><br><span class="line">            :addTo(cell)</span><br><span class="line">    <span class="keyword">end</span></span><br><span class="line">    <span class="comment">-- 如果需要刷新的话, 可能需要自己去处理, 如不需要, 就可以不用下面的这个调用</span></span><br><span class="line">    cell.view:refresh()</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> cell</span><br><span class="line"><span class="keyword">end</span>, cc.TABLECELL_SIZE_AT_INDEX)</span><br></pre></td></tr></table></figure>
<h2 id="3-__u83B7_u53D6/_u65B0_u589E/_u4FEE_u6539/_u5220_u9664_u8282_u70B9"><a href="#3-__u83B7_u53D6/_u65B0_u589E/_u4FEE_u6539/_u5220_u9664_u8282_u70B9" class="headerlink" title="3. 获取/新增/修改/删除节点"></a>3. 获取/新增/修改/删除节点</h2><p>这些操作分别对应 <code>cellAtIndex</code>/<code>updateCellAtIndex</code>/<code>insertCellAtIndex</code>/<code>removeCellAtIndex</code> . 这些接口很好理解, 但就多数情况而言, 他们可能需要和 <code>reloadData</code> 配合使用. </p>
<p>好了, 以上就是基本用法了. 在使用时还有一些需要注意的细节:</p>
<ol>
<li>不能使用 setNodeEventEnable, 因为和 Node 的 registerScriptHandler 有冲突.</li>
<li>id 从 0 开始, 而大家在 lua 这边准备的数据多是以 1 开始, 这样可能需要 +1 和 -1, 需要细心一些.</li>
</ol>
<hr>
<h1 id="u4E8C-__u4E00_u4E9B_u5F02_u5E38_u7684_u89E3_u51B3_u65B9_u6848"><a href="#u4E8C-__u4E00_u4E9B_u5F02_u5E38_u7684_u89E3_u51B3_u65B9_u6848" class="headerlink" title="二. 一些异常的解决方案"></a>二. 一些异常的解决方案</h1><h2 id="1-_lua__u51FA_u9519_u5BFC_u81F4_player__u5D29_u6E83"><a href="#1-_lua__u51FA_u9519_u5BFC_u81F4_player__u5D29_u6E83" class="headerlink" title="1. lua 出错导致 player 崩溃"></a>1. lua 出错导致 player 崩溃</h2><p>TableView 回调 <code>tableCellAtIndex</code> 在lua这边的实现一旦出错, 就会在 c++ 那边收到一个 NULL 的 cell, 因为没有判空, 下面对 cell 的操作就会导致 Plaer 崩溃. 对应修改如下:</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">     cell = _dataSource-&gt;tableCellAtIndex(<span class="keyword">this</span>, idx);</span><br><span class="line">-    <span class="keyword">this</span>-&gt;_setIndexForCell(idx, cell);</span><br><span class="line">-    <span class="keyword">this</span>-&gt;_addCellIfNecessary(cell);</span><br><span class="line">+    <span class="keyword">if</span>(cell)</span><br><span class="line">+    &#123;</span><br><span class="line">+        <span class="keyword">this</span>-&gt;_setIndexForCell(idx, cell);</span><br><span class="line">+        <span class="keyword">this</span>-&gt;_addCellIfNecessary(cell);</span><br><span class="line">+    &#125;</span><br></pre></td></tr></table></figure>
<p>这时候, 不会崩溃了, 但是也看不到 lua 那边出的什么错误, 经过一番追踪, 定位到了 <code>LuaStack::executeFunction</code> 函数:</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">        <span class="keyword">if</span> (error)</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">if</span> (traceCallback == <span class="number">0</span>)</span><br><span class="line">            &#123;</span><br><span class="line">                CCLOG(<span class="string">"[LUA ERROR] %s"</span>, lua_tostring(_state, - <span class="number">1</span>));        <span class="comment">/* L: ... error */</span></span><br><span class="line">                lua_pop(_state, <span class="number">1</span>);                                        <span class="comment">// remove error message from stack</span></span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">else</span>                                                           <span class="comment">/* L: ... G error */</span></span><br><span class="line">            &#123;</span><br><span class="line">+               CCLOG(<span class="string">"[LUA ERROR] %s"</span>, lua_tostring(_state, - <span class="number">2</span>));        <span class="comment">/* L: ... error */</span></span><br><span class="line">                lua_pop(_state, <span class="number">2</span>);                                        <span class="comment">// remove __G__TRACKBACK__ and error message from stack</span></span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">        &#125;</span><br></pre></td></tr></table></figure>
<p>虽然出错了, 但是 <code>traceCallback</code> 的值并不等于 0, 所以没有进入输出错误的逻辑, 具体用意并不明白. 我的添加了带 <code>+</code> 号的哪一行, 输出了下就可以看到 lua 的错误了.</p>
<h2 id="2-__u6EDA_u52A8_u540E_u5BFC_u81F4_u8282_u70B9_u4E0A_u6309_u94AE_u89E6_u6478_u5931_u6548"><a href="#2-__u6EDA_u52A8_u540E_u5BFC_u81F4_u8282_u70B9_u4E0A_u6309_u94AE_u89E6_u6478_u5931_u6548" class="headerlink" title="2. 滚动后导致节点上按钮触摸失效"></a>2. 滚动后导致节点上按钮触摸失效</h2><p>大家使用时可能会遇到这样的问题, 节点上有一个利用 quick 触摸机制实现的按钮, 在 TableView 滚动后触摸事件都会失效, 按钮无法被点击.</p>
<p>这个实际上是 quick 触摸机制的一个bug, 复现是很容易的. 大家创建一个按钮并调用 <code>retain</code>, 然后将这个按钮添加到父节点上, 在某个时候将按钮从父节点上移除 (<code>removeFromParent</code>) 并再次添加(<code>addChild</code>)上到父节点. 这时候按钮还在, 但是触摸事件已经没有了.</p>
<p>究其原因是我们一般会在对象的 <code>ctor</code> 函数中 <code>setTouchEnable</code>, 然后 quick 在收到 <code>cleanup</code> 事件后移除了对象触摸事件, 具体逻辑大家可以看 <code>Node:EventDispatcher</code> 函数. 而一个节点从父节点上移除时恰好会发送 cleanup 事件.</p>
<p>对应到 TableView 中来, TableViewCell 为了做到复用在 <code>dequeueCell</code> 时会调用 <code>retain</code> 函数, 并且在移出屏幕时会被从 Container 上移除掉的. 这样 TableViewCell 的所有子节点都会收到对应的 cleanup 事件.</p>
<p>这个问题的解决方案恰好是我之前写的一篇文章, <a href="/2015/05/17/onDestroy">为 quick-cocos2d-x 添加析构事件</a>, 在这篇文章中, 已经修改为收到 destroy 事件后才去移除节点的触摸事件, 非常完美的解决了这个问题.</p>
<blockquote>
<p>Update: 2016-04-24</p>
</blockquote>
<h2 id="3-__u906E_u6321_u4E0A_u5C42_u6309_u94AE_u89E6_u6478_u4E8B_u4EF6"><a href="#3-__u906E_u6321_u4E0A_u5C42_u6309_u94AE_u89E6_u6478_u4E8B_u4EF6" class="headerlink" title="3. 遮挡上层按钮触摸事件"></a>3. 遮挡上层按钮触摸事件</h2><p>经过这几天的使用, 我发现了一个十分严重的问题. 如下图所示, TableView 中的某个按钮拖出 ViewRect 范围后会不可见, 但如果其位置恰好在 TableView 外的另一个按钮范围内, 就会优先收到点击事件. 这就会引发十分奇怪的现象, TableView 外的按钮看得见点不着, TableView 内的按钮看不见却可以响应到, 十分影响体验.</p>
<p><img src="http://ww4.sinaimg.cn/large/7f870d23gw1f381i7v2adj206c045glr.jpg" alt=""></p>
<p>因为有着以往 cocos 2.x 的悲惨经历, 我非常武断的认为这肯定是 TableView 的 bug, 开始着手阅读 TableView 的代码实现, 却一直未果. 然而团队中另外一位成员 @小齐同学 的意外发现, 让这个问题的谜底在无意中就被揭开了.</p>
<p>我们在项目中大量使用了 quick-x 提供的一个控件 <code>UIScrollView</code>, 它是一个用 <code>ClippingRegionNode</code> 纯 lua 实现的 <code>CCScrollView</code>, 一直以来工作的十分良好. 但是在某一天 测试中, @齐少 意外的发现, 某个界面的 UIScrollView 出现了和 TableView 一模一样的问题, 导致上层按钮无法点击. 经过排查, 发现是因为 UIScrollView 的创建顺序被延后的原因, 如果一个按钮先于 UIScrollView 添加到父节点, 就会被 UIScrollView 中的按钮所屏蔽, 后添加则不会.</p>
<p>当 @齐少 告诉我这个结论后, 我立刻意识到, TableView 遇到的问题肯定也是这个原因, 查看代码后果然如此, TableView 是最后被创建的. 解决方案也十分简单, 将 TableView 外部按钮放到 TableView 之后去创建就可以啦.</p>
<hr>
<p>恩, 以上就是我在使用 TableView 时遇到的所有问题了, 虽然解决了这些问题, 但是在使用上还是十分的繁琐. 若是在一两个界面上使用可能还可以接受, 但若是想大规模推广就很有些困难了, 代码会变得十分冗长.</p>
<p>在此基础上, 我们又对 TableView 进行了一次封装, 数据驱动, 使用时不用过分关注界面的逻辑, 中心更多的落在了数据的组织上, 真正的做到了 “开箱即用” , 等我们内部进行推广并稳定后可以再和大家分享下心得.</p>
]]></content>
    </entry>
    
    <entry>
      <title><![CDATA[游戏性能优化 - 界面篇]]></title>
      <url>http://blog.justbilt.com/2016/03/06/game-optimize/</url>
      <content type="html"><![CDATA[<p>最近几天都在做性能优化方面的事情, 关于优化, 之前的经验也都是泛泛而谈, 知道有几条路线可以走, 但一直没有去实践过. 所以刚开始搞的时候, 也是两眼一抹黑, 走了不少弯路, 最后也是受益匪浅, 这里记录一下我们的思路, 也是为下次优化提供一个可行的方案.</p>
<p>在测试的时候, 不少界面界面卡顿十分严重, 主要分为三个方面, 分别是 <strong>打开界面卡顿</strong>, <strong>操作界面卡顿</strong>, <strong>关闭界面卡顿</strong> . 不开玩笑, 确实如此 ! </p>
<p>经过分析, 这些界面多有许多共同的特征:</p>
<ol>
<li>界面包含多个页签</li>
<li>界面含有 ScrollView</li>
</ol>
<p>在看具体业务逻辑的时候, 发现了很多的问题. 下面就和大家细说一下优化方案.</p>
<h1 id="u6253_u5F00_u754C_u9762"><a href="#u6253_u5F00_u754C_u9762" class="headerlink" title="打开界面"></a>打开界面</h1><p>总结一下, 打开界面卡顿的主要原因是:</p>
<blockquote>
<p>界面创建时做了太多的事情.</p>
</blockquote>
<p>对于多页签界面, 为了不在点击切换标签时有卡顿的感觉, 打开界面时创建了所有标签页的内容. 如下图:</p>
<p><img src="http://static.zybuluo.com/justbilt/4ngqmwbvcjwltqrq94ra65o4/QQ20160219-0@2x.png" alt=""></p>
<p>这个其实没有必要, 不这样做的话可以将加载时间分摊到每次点击标签的时候, 再优化下每个标签页的创建速度, 切换标签时就几乎感觉不到卡顿的. 然后我们缓存注这些界面, 下次切换就会更流畅了.</p>
<p>对于 ScrollView , 如果子节点数量很多的话, 就会奇卡无比, 因为会在初始化时创建所有的子节点! 对于这个我们做了两点优化:</p>
<h2 id="1-__u4F18_u5316_u5B50_u8282_u70B9_node__u6570_u91CF"><a href="#1-__u4F18_u5316_u5B50_u8282_u70B9_node__u6570_u91CF" class="headerlink" title="1. 优化子节点 node 数量"></a>1. 优化子节点 node 数量</h2><p>我们一个子节点可能有多个互斥的状态, 美术拼界面时会把所有的状态都拼在界面里, 程序再根据具体状态 setVisible , 这样就非常的浪费. 为此我们实现了在 ccb 中标记节点状态的功能, 所有不属于基本 ui 状态的节点树都不会被创建, 用到时候手动 init , 这个实现对性能的提升非常显著.</p>
<h2 id="2-__u9488_u5BF9_u6027_u9009_u62E9_u4F7F_u7528_TableView"><a href="#2-__u9488_u5BF9_u6027_u9009_u62E9_u4F7F_u7528_TableView" class="headerlink" title="2. 针对性选择使用 TableView"></a>2. 针对性选择使用 TableView</h2><p>我一般情况下不建议使用 TableView, 因为它的创建方式十分复杂, 使用起来也诸多不便, 更重要的是会破坏串行的ui创建逻辑. 但不得不承认, 某些情况下它对性能的提升非常有帮助, 尤其是在子节点的数量达到 20 个以上的时候, 简直是质的飞跃.</p>
<p>但是基于 TableView 十分难用, 加上 lua 这边逻辑出错后并不会抛出, debug 十分痛苦. 为此我们修改了一些 TableView 的源码, 同时在 lua 这边有封装了一层, 做到了数据和界面的分离.</p>
<p>当然 quick-3.3 的 TableView 坑不止这些, 感觉不做些修改基本没法使用. 具体细节, 我会在下一篇文章中和大家细说.</p>
<hr>
<p>对于其他情况, 若是界面需要加载的东西特别多, 点击后会有几近卡死的状态, 同时因为顶点数量居多, 若是同时渲染背景场景和该界面, 会进一步加剧卡顿效果. </p>
<blockquote>
<p>顶点数量巨多的界面加 loading 动画</p>
</blockquote>
<p>这个 loading 不同于切换场景的 loading, 可以做的非常轻, 非常简单, 用来避免同时渲染两个界面导致帧率剧降的情况. 可以是一个门, 门关上时, 前一个界面就不渲染了, 这时在门的后面加载显示新的界面, 隐藏(自动剔除)旧的界面, 门打开, 这时只有新的界面会被渲染出来了.</p>
<p>可能同时渲染两个界面感觉不到这么明显的变化, 但是我们的前一个界面是大基地, 有将近 4000 个顶点, 150 多渲染批次, 这样就会十分明显了.</p>
<h1 id="u64CD_u4F5C_u754C_u9762"><a href="#u64CD_u4F5C_u754C_u9762" class="headerlink" title="操作界面"></a>操作界面</h1><p>操作界面卡顿主要发生在含有 ScrollView 的界面, 我看了下逻辑, 在数据发生变化时, 会将 ScrollView 的所有节点都移除掉, 重新创建. 这样完全就是一个偷懒的做法, 应当是哪里有数据变化就刷新哪里, 那些数据删除了, 就删除掉对应的子节点, 那些数据是新增的, 就创建一些新的节点加入进去.</p>
<p>这个问题高端机可能觉察不到, 一到 Android 渣机就卡成狗, 完全没法玩. 这里得出的经验就是, 平时测试的时候一定要找一个渣机.</p>
<h1 id="u5173_u95ED_u754C_u9762"><a href="#u5173_u95ED_u754C_u9762" class="headerlink" title="关闭界面"></a>关闭界面</h1><p>关闭界面时的主要问题是动画不流畅, 代码并没有太大的问题. 我们的关闭界面有一个动画, 整个层淡出并向下移动. 这样就会在动画的过程中露出下面的基地界面, 导致同时渲染顶点数剧增, 帧率骤降, 表现出来的现象就是 “三帧-咔咔咔”.</p>
<p>解决方案也很简单, 去掉这个动画就, 改成直接移除. 如果大家观察一下其他游戏, 在关闭界面时也多是没有动画的.</p>
<hr>
<p>以上就是我们针对界面做的优化, 没有上代码, 多是理论思路和操作方法. 同时我针对内部小伙伴也写了一篇文章, 内容多是类似, 但是会有一些具体代码上讲解. 大家若是有兴趣的话, 也可以<a href="https://www.zybuluo.com/justbilt/note/289485" target="_blank" rel="external">点击这里</a>阅读, 若是有什么疑问及见解, 欢迎指出.</p>
]]></content>
    </entry>
    
    <entry>
      <title><![CDATA[将 untp 发布到 Pypi 上]]></title>
      <url>http://blog.justbilt.com/2016/02/29/publish-untp-to-pypi/</url>
      <content type="html"><![CDATA[<p>上一篇年结的时候有提到 <a href="https://github.com/justbilt/untp" target="_blank" rel="external">untp</a> 这个小工具, 它是我在 github 收获 star 数最多的一个项目. 这个项目本是无心之举, 既然受大家欢迎, 那么一定要好好维护下去 ! 对于它后续的发展, 我打算从两个方面入手:</p>
<ol>
<li>更便捷的安装</li>
<li>支持更多的格式</li>
</ol>
<p>之前唯一一次发布时用 PyInstaller 打包成可执行文件来发布的, 很方便, 出来的安装包也很小! 但是我时常会收到在 Mac 上崩溃的反馈:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">illegal instruction 4</span><br></pre></td></tr></table></figure>
<p>在这个错误上我花费了特别大的精力, 因为在推荐给朋友的时候吹得天花乱坠, 实际却完全运行不起来, 这也太不给我面子了吧.</p>
<p>Google 上对于这个问题也是众说纷纭, 没有一个能帮到我. 我尝试过各种解决方案, 升降级 PyInstaller, 用 Python3 重写, 用 PyQtDeploy 打包. 但却总是无功而返. PyQtDeploy 倒是可以解决问题, 但是打的包足足有 30~40MB , 想想还是算了吧.</p>
<p>最后我仔细想了想, 在 Mac 上完全没有必要打包成一个可执行文件呀, 系统自带 python 环境, 直接通过 pip 安装一下就可以了嘛 ~</p>
<p>关于如何制作,上传,发布自己的项目, 推荐大家阅读这篇文章 <a href="http://yejinxin.github.io/distribute-python-packages-to-pypi-server/" target="_blank" rel="external">发布python的包至pypi服务器</a> , 文章写的很好, 里面已经提到内容我在下面就不赘述了.</p>
<h1 id="1-__u5236_u4F5C_setup-py"><a href="#1-__u5236_u4F5C_setup-py" class="headerlink" title="1. 制作 setup.py"></a>1. 制作 setup.py</h1><p>我的 setup.py 文件如下:</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> setuptools <span class="keyword">import</span> setup, find_packages</span><br><span class="line"></span><br><span class="line">setup(</span><br><span class="line">    name = <span class="string">'untp'</span>,</span><br><span class="line">    version = <span class="string">'1.0.2'</span>,</span><br><span class="line">    keywords = (<span class="string">'untp'</span>, <span class="string">'texturepacker'</span>),</span><br><span class="line">    description = <span class="string">'A command line tool to split TexturePacker publish file.'</span>,</span><br><span class="line">    license = <span class="string">'MIT License'</span>,</span><br><span class="line">    install_requires = [</span><br><span class="line">        <span class="string">'Pillow'</span>,</span><br><span class="line">        <span class="string">'parse'</span></span><br><span class="line">    ],</span><br><span class="line">    url = <span class="string">'https://github.com/justbilt/untp'</span>,</span><br><span class="line">    author = <span class="string">'justbilt'</span>,</span><br><span class="line">    author_email = <span class="string">'wangbilt@gmail.com'</span>,</span><br><span class="line">    scripts=[<span class="string">'untp.py'</span>],</span><br><span class="line">    entry_points=&#123;</span><br><span class="line">        <span class="string">'console_scripts'</span>: [</span><br><span class="line">            <span class="string">'untp = untp:main'</span>,</span><br><span class="line">        ],</span><br><span class="line">    &#125;</span><br><span class="line">)</span><br></pre></td></tr></table></figure>
<h2 id="entry_points"><a href="#entry_points" class="headerlink" title="entry_points"></a>entry_points</h2><p>使用 entry_points 字段, 可以为项目添加可执行命令, 在我上面的配置中, 我就添加了 <code>untp</code> 这个名命令, 会执行 untp.py 的 main 函数.</p>
<p>关于 entry_points 的更多用法, 可以参考这篇文章 <a href="https://pythonhosted.org/setuptools/setuptools.html#automatic-script-creation" target="_blank" rel="external">Automatic Script Creation</a> .</p>
<h2 id="scripts"><a href="#scripts" class="headerlink" title="scripts"></a>scripts</h2><p>这里面值得一提的是 <code>scripts</code> 字段, 这个字段好多文章都没有提, 但是在我这里却引发了一个大问题. 我的目录结构如下:</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">untp</span><br><span class="line">├── README.md</span><br><span class="line">├── setup.py</span><br><span class="line">└── untp.py</span><br></pre></td></tr></table></figure>
<p>因为项目比较小, 我就直接将 untp.py 直接裸露在项目根目录, 开始没有添加 scripts 字段, 打包安装 <code>import</code> 都没有问题, 但是运行 <code>untp</code> 时却会报最经典的 <code>ImportError</code> 错误:</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">wanghaitaodeMacBook-Air:untp bilt$ untp</span><br><span class="line">Traceback (most recent call last):</span><br><span class="line">  File <span class="string">"/usr/local/bin/untp"</span>, line <span class="number">9</span>, <span class="keyword">in</span> &lt;module&gt;</span><br><span class="line">    load_entry_point(<span class="string">'untp==1.0.2'</span>, <span class="string">'console_scripts'</span>, <span class="string">'untp'</span>)()</span><br><span class="line">  ...</span><br><span class="line">  File <span class="string">"/usr/local/lib/python2.7/site-packages/pkg_resources/__init__.py"</span>, line <span class="number">2361</span>, <span class="keyword">in</span> resolve</span><br><span class="line">    module = __import__(self.module_name, fromlist=[<span class="string">'__name__'</span>], level=<span class="number">0</span>)</span><br><span class="line">ImportError: No module named untp</span><br></pre></td></tr></table></figure>
<p>然后我就要疯了, 这里什么个鬼情况 !!! 直到我看到了这个问答: <a href="http://stackoverflow.com/questions/19718813/module-not-found-during-load-entry-point-in-python" target="_blank" rel="external">module-not-found-during-load-entry-point-in-python</a> . 我才意识到, 原来我一直都没有安装对, 之所以能够 import 成功, 是因为我就在当前 (untp.py) 目录运行的 python 终端.</p>
<p>然后去啃官方文档, 经过一番尝试, 其他人使用的 <code>packages = find_packages()</code>, 在我这里并不好使, 只有手动指定 scripts 才可以 !</p>
<h1 id="2-__u6D4B_u8BD5"><a href="#2-__u6D4B_u8BD5" class="headerlink" title="2. 测试"></a>2. 测试</h1><p>我还是推荐大家先在 <code>testpypi.python.org</code> 上测试正确了再上传到正式的 <code>pypi.python.org</code>, 因为一但在正式服务器提交了, 就必须以版本号迭代的代价来更正上次提交. 而在测试服务器上发现问题的话, 登录删除一下有问题的版本就可以了!</p>
<p>testpypi 也是需要注册的, 和 pypi 的注册方法一致, 注册完别忘了去邮箱验证一下.</p>
<p>注意上传的时候不一定会成功, 说在 <code>.pypirc</code> 中找不到 testpypi 的配置, 解决方案可以看这里: <a href="https://wiki.python.org/moin/TestPyPI" target="_blank" rel="external">Test PyPI Server</a> .</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">python setup.py register -r https://testpypi.python.org/pypi</span><br><span class="line">python setup.py upload -r https://testpypi.python.org/pypi</span><br><span class="line">pip install -i https://testpypi.python.org/pypi &lt;package name&gt;</span><br></pre></td></tr></table></figure>
<p>然后使用上面几条命令进行测试注册,发布,安装.</p>
<h1 id="3-__u53D1_u5E03"><a href="#3-__u53D1_u5E03" class="headerlink" title="3. 发布"></a>3. 发布</h1><p>这边没有什么说的, 测试没有问题之后, 发布也不会出什么问题, 只是网址不一样而已. 写这篇文章的时候, 大家已经可以使用 <code>pip</code> 来安装最新版的 untp 了:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">pip install untp</span><br></pre></td></tr></table></figure>
<p>–EOF–</p>
]]></content>
    </entry>
    
    <entry>
      <title><![CDATA[手机游戏攻防(三) 网络游戏]]></title>
      <url>http://blog.justbilt.com/2016/02/14/phone-game-AND-OLgame/</url>
      <content type="html"><![CDATA[<p>这篇文章好早就写了, 一直放在草稿箱, 今天整理的时候发现了, 于是修改了一下就发布了出来 !</p>
<hr>
<p>前段时间我们的游戏公测了下, 在安全这方面遇到了不少问题, 和大家分享一下.</p>
<h2 id="1-__u9053_u5177_u8D1F_u6570_u5356_u51FA"><a href="#1-__u9053_u5177_u8D1F_u6570_u5356_u51FA" class="headerlink" title="1. 道具负数卖出"></a>1. 道具负数卖出</h2><p>卖出道具是多数游戏都有的一个功能, <strong>那么如果卖出一个负数量的道具呢?</strong> 卖出道具的逻辑可能是这样的:</p>
<figure class="highlight lua"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">sell</span><span class="params">(_id, _count)</span></span></span><br><span class="line">	item_data[_id].count = item_data[_id].count - _count</span><br><span class="line"><span class="keyword">end</span></span><br></pre></td></tr></table></figure>
<p>可以看到, 如果不做任何保护的话, 一旦 <code>_count</code> 是负数, 实际会变成<strong>加法</strong>. 我们遇到的第一个问题就是这个, 玩家通过八门神器或烧饼助手修改出售数量为负数, 这样就会变成增加道具. 一般情况下, 游戏后端会拦截住, 返回卖出失败的结果, 但是不巧, 他们也没有做类似的判断. </p>
<blockquote>
<p>解决方案:</p>
</blockquote>
<p>对于前端来说, 可以粗暴的断言一下, 因为正常肯定不会出现这个情况, 也可以温和的 Alert 一个提示. 如下:</p>
<figure class="highlight lua"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">sell</span><span class="params">(_id, _count)</span></span></span><br><span class="line">	<span class="keyword">if</span> _count &lt; <span class="number">1</span> <span class="keyword">then</span></span><br><span class="line">		Alert.new(<span class="string">"卖出道具数量不能小于1"</span>)</span><br><span class="line">		<span class="keyword">return</span></span><br><span class="line">	<span class="keyword">end</span></span><br><span class="line">	item_data[_id].count = item_data[_id].count - _count</span><br><span class="line"><span class="keyword">end</span></span><br></pre></td></tr></table></figure>
<p>但这种限制肯定是服务端做的, 毕竟客户端这里只是第一道防线, 中间还有太多的手脚可做 !</p>
<h2 id="2-__u6E38_u620F_u52A0_u901F"><a href="#2-__u6E38_u620F_u52A0_u901F" class="headerlink" title="2. 游戏加速"></a>2. 游戏加速</h2><p>烧饼助手有一个游戏加速的功能, 类似于变速齿轮. 可以将游戏加速到十倍甚至百倍的速度, 一般对于网游来说, 真实的时间是服务端来计算的, 客户端的计时只是一个表现. 但是由于我们的战斗模块基本上是离线的, 所以这里在加速的情况下出了问题.</p>
<p>我们战斗有一个特色就是主公技, 是一系列非常强大的技能. 因此在战斗中会严格控制释放次数, 通过<strong>消耗能量</strong>和<strong>冷却时间</strong>来实现. 正常情况下, 战斗中加速的话整个战斗的节奏就会加快, 因此不会有问题.</p>
<p>但是不知为何, 我们的人物动作加速到一定倍数后就会停止, 而主公技的能量回复和冷却速度却会无限增大, 因此表现出来的就是主公技可以<strong>无限释放</strong>, 玩家可以轻松挑战数倍强于自己的敌人!</p>
<p>发现这个问题后, 我和小伙伴们都惊呆了, 原来还可以这样搞!!! </p>
<blockquote>
<p>解决方案:</p>
</blockquote>
<p>现在我们的解决方案是将主公技的能量回复速度与人物动作联系起来, 这样不至于太变态. 同时加入了战斗的时间限制, 如果加速到10倍以上的, 时间很快会耗尽, 战斗失败! </p>
<p>但是我想到了一个更好的办法, 能从源头解决这个问题, 就是<strong>对比系统的时间流逝与游戏内的时间流逝速度</strong>. 一般, 变速齿轮只会改你当前游戏的时间, 没法改动系统的时间. 只要我么通过 native 的函数获取原生系统的时间, 一对比就可以发现有木有使用加速了.</p>
<p>但是目前还没有去实现这个想法, 有机会吧!</p>
<h2 id="2-_socket__u6293_u5305/_u53D1_u5305"><a href="#2-_socket__u6293_u5305/_u53D1_u5305" class="headerlink" title="2. socket 抓包/发包"></a>2. socket 抓包/发包</h2><p>当看到群里有玩家讨论抓包的时候, 我们都目瞪口呆, 这年头作弊都需要高科技了! 玩家通过截取客户端发送的数据包, 重复发送, 这样可以轻松避开客户端的各种限制, 从而达到作弊的目的.</p>
<blockquote>
<p>解决方案:</p>
</blockquote>
<p>最终的解决方案还是得靠服务端严谨的逻辑来避免, 各种检查参数, 检查返回值! 也可以通过设计来避免, 比如每次发送数据包都附加一个 id 属性, 这个 id 会以某种规则增长, 服务端哪里也有一个 id , 对比之后就可以判断是否玩家作弊了 !</p>
<hr>
<p>哈哈, 综上所述, 一个有经验的游戏服务端是多麽的重要.</p>
]]></content>
    </entry>
    
    <entry>
      <title><![CDATA[继续进步的 2015]]></title>
      <url>http://blog.justbilt.com/2016/02/11/my-2015/</url>
      <content type="html"><![CDATA[<p>之前的几次年结:</p>
<p><a href="/2014/05/01/my-2013">2013年结</a><br><a href="/2015/05/31/my-2014">2014年结</a></p>
<p>因为自己非常严重的拖延症, 之前几次年结都拖的好晚 (五月) 才写, 这次终于克服了一下, 下次一定争取元旦写, 毕竟每过一年, 都要有进步的嘛. 这次年结还是按照以往的惯例来写, 从工作, 技术, 生活这几个方面来切入来写.</p>
<h1 id="u5DE5_u4F5C"><a href="#u5DE5_u4F5C" class="headerlink" title="工作"></a>工作</h1><h2 id="D__u516C_u53F8__282014-7_-_2015-7_29"><a href="#D__u516C_u53F8__282014-7_-_2015-7_29" class="headerlink" title="D 公司 (2014.7 - 2015.7)"></a>D 公司 (2014.7 - 2015.7)</h2><p>这一年大半的时间都是在 D 公司度过的, 对于 D , 我的感情是很复杂的, 在 D 投入了我有史以来最大的精力, 完全可以说一腔热血都洒在上面了, 有差不多半年都是 9-11-6 的工作方式, 若说不是因为热爱这个工作, 又怎么会这样? 对于项目的最终失利, 我没有过多的话可说, 虽说这一切都在意料之中, 但为什么还是会感到失落.</p>
<p><img src="http://ww4.sinaimg.cn/large/7f870d23gw1f0wqhs5mhjj20vk0no0uk.jpg" alt=""></p>
<blockquote>
<p>图注: 晚上 10:30 , 打包前的测试</p>
</blockquote>
<p>先说说 D 好的一面, 与前端团队的相处是我感到最开心的一点, 好友宏爷<a href="http://weibo.com/u/1832998307" target="_blank" rel="external">@imbahom</a> , 主程也是曾经的老师 <a href="http://weibo.com/u/5264215627" target="_blank" rel="external">@桂老</a>, 以及新认识古灵精怪的妹子 @小蒋童鞋 . </p>
<p>宏爷是我多年好基友, 打得一手好dota. 同时技术能力毋庸置疑, 绝对是团队开荒的好手. 但是随着合作的深入, 我们在某些方面的分歧很大, 加上我代码洁癖的病越来越重, 因此也有过一些争吵. 哈哈, anyway, 这些小事情, 完全不影响我们之间的情谊 ! </p>
<p>小蒋童鞋是团队中的唯一妹子, 身为90后, 特别刻苦, 谦虚, 经常会冒出一些神语录, 哈哈哈, 大家都很喜欢她. 不过作为行业中的新人, 若是没有一个严厉的前辈带领, 野生蛮长之下, 容易走一些弯路. </p>
<p>桂老最然年长一些, 但是心态特别好, 与我三观很合, 对于技术的尊重和对烂代码要即时重构的观点真是太合我心意了. 同时在他无为而治的管理观念下, 我的好多建议都能得到他的积极响应, 因为之前都是单刀独斗, 这次团队配合让我感到十分舒心.</p>
<p>好的一方面, 公司成员多数都是行业中老兵, 经验丰富, 从他们身上可以学到好多东西. 另一方面, 公司虽小, 但是大家的鄙视链却很长, 后端看不起策划, 策划看不起美术, 同时策划之间又互相鄙视, 完全就不是一副齐心协力干事情的样子. </p>
<p>团队配合让人操碎了心, 却半路又开了一个项目, 招了一批成员, 又调走了几个, 对于这些, 只能呵呵又呵呵了! 同时公司对于时间节点毫无观念, 计划一拖再拖, 代码改了又改.</p>
<p>我想多数有一些规模的公司可能都是和 D 差不多的情况, 这样的公司我想在我激情退却之前是不想再加入了 !</p>
<h2 id="C__u516C_u53F8__282015-7__7E__29"><a href="#C__u516C_u53F8__282015-7__7E__29" class="headerlink" title="C 公司 (2015.7 ~ )"></a>C 公司 (2015.7 ~ )</h2><p>啊, 不是该 E 公司了么? 没错, 我又回到了 C 公司. 在 @Bin 和我接触的时候, 我是非常纠结的, 因为在我的观点中, 分手了还做朋友是不太可能的, 更别提复合了. 同时我的选择也很多, 留在 D, D 的老板承诺加薪分股; 很早认识的一个大哥推荐我去他们公司, 用我一直想用 Unity3D , 龙图投资, 技术老大也是一个非常 nice 的人; 或者离开北京, 去一个陌生的地方重新开始.</p>
<p>那么在一次次纠结之后, 我为什么选择了 C ? 是因为对陌生未来的恐惧 ? 是打心底认可 C ? 或者是被 bin 的诚意打动, 或者是离别时那一句随口的承诺. </p>
<blockquote>
<p>我暂时离开, 若有机会我还是会回来 !</p>
</blockquote>
<p>重新归来的 C, 浴火重生的 C,  我在 C 又将谱写出一段什么样的篇章, 我现在还无法细说, 只能说我在 C 非常快乐, 稳步进步的同时又接触到一些前所未有的东西.</p>
<h1 id="u6280_u672F"><a href="#u6280_u672F" class="headerlink" title="技术"></a>技术</h1><h2 id="1-_Sublime_Text"><a href="#1-_Sublime_Text" class="headerlink" title="1. Sublime Text"></a>1. Sublime Text</h2><p>最早接触 Sublime Text (ST), 也算是机缘巧合, 很早之前与 @Bin 聊天时无意间提及, 我便记在了心理. 下载下来时候更是惊为天人, 作为一个 IDE 狗, 从未想过编辑器竟可以如此轻便, 如此好用. 再次期间, 我尝试过 Vim, Emacs, Atom, 等多款编辑器, 但从未改变过对 ST 的喜爱.</p>
<p>后来, bin 竟转向 pycharm, 这个可恶的叛徒, 必须烧死!!! 逃 :)</p>
<p>但是这个时候, 我只是拿 ST 当做一款普通的编辑器使用, 写写 python 代码, 没有装任何插件. 接下来, 转到使用 quick-cocos2d-x 的时候, 因为 QuickXDev 的原因, 大家推荐的也是 ST 作为主力开发环境, 在这个时候, 才算是真正的使用 ST .</p>
<p>直到今年, 我的第一款 ST 插件 <a href="https://github.com/justbilt/sublime-falign" target="_blank" rel="external">FAlign</a> 发布, 我对 ST 的理解总算达到了全面的标准啦!</p>
<h2 id="2-_ccb2lua"><a href="#2-_ccb2lua" class="headerlink" title="2. ccb2lua"></a>2. ccb2lua</h2><p>这个恐怕是我今年最得意的作品了, 实现了将 CocosBuilder 的界面文件转化为 lua 代码的功能. 因为使用 jinja2 作为模板, 全部的映射逻辑都写在模板中, 所以它的灵活性及可扩展性都极高. 哈哈, 因为代码目前还无法开源, 所以我就不细说, 免得被认为吹牛逼 ~</p>
<h2 id="3-__u6B63_u5219"><a href="#3-__u6B63_u5219" class="headerlink" title="3. 正则"></a>3. 正则</h2><p>若说今年有什么特别值得一提, 那么就是终于降服了正则表达式这头猛兽了. 早在很多年就被一个好友安利过正则, <a href="http://deerchao.net/tutorials/regex/regex.htm" target="_blank" rel="external">正则表达式30分钟入门教程</a> 这篇教程也看了好几遍, 却一直没有入门. 直到我做一个小工具的时候, 才被迫又看了一遍, 写了几个表达式之后, 终于入了门. 进了这扇门之后, 才发现各种方便各种好, 从此一发不可收拾, 把之前好多写的非常蹩脚的地方都用正则重新实现了下. </p>
<p>果然, 只有在重压之下, 才能克服拖延症!!!</p>
<h2 id="4-_untp"><a href="#4-_untp" class="headerlink" title="4. untp"></a>4. untp</h2><p>对于这个小工具, 我也很满意 ! 当时真的有帮到我好多, 为此我还特意写了一篇文章, <a href="/2015/04/19/untp">一个命令行的 TexturePacker 拆解工具</a>, 这个小工具, 也成为了为 Github 上 star 数最多的一个项目, 忍不住小自豪一把.</p>
<h2 id="5-__u6253_u5B57"><a href="#5-__u6253_u5B57" class="headerlink" title="5. 打字"></a>5. 打字</h2><p>这也值得一提 ? 恐怕是的, 就打字方面, 我一直没有进行过系统的训练. 从最开始的 “一指禅” 到后来的两只手四五根指头打字, 错误率极高不说, 速度到一定程度之后也难以再提升. 但是这一切我一直不以为然, 认为编程最重要的是思想, 直到有一天, bin 在朋友圈发了这么一条:</p>
<p><img src="http://ww2.sinaimg.cn/large/7f870d23gw1f0vqg8j0zej20k005jjs1.jpg" alt=""></p>
<p>虽然不是在说我, 但我仍旧感到很羞愧. 人知耻而后勇, 同时又找到了一个神器 <a href="http://zhihu.com/question/27021761/answer/53323794" target="_blank" rel="external">TT</a> , 经过一番苦练, 我的WPM (每分钟敲下多少个单词) 终于达到了 30 , 这个速度相比之前已是天翻地覆的变化了, 今年我一定要继续苦练, 争取达到 50 !</p>
<h1 id="u751F_u6D3B"><a href="#u751F_u6D3B" class="headerlink" title="生活"></a>生活</h1><p>今年最重要的事情就是与相恋三年的女友步入了婚姻的殿堂, 媳妇想着多省些钱, 因此婚礼办的相对比较简单, 媳妇这么懂事, 我是很开心但也很羞愧. </p>
<p>婚后的生活与之前并没有太大的变化, 更多是体现在心灵的变化上, 媳妇脾气越来越好, 我也更加愿意让着她, 这种感觉真的好棒. 如果不出意外的话, 接下来还有好几年悠闲的时光, 趁着这个机会, 努力提升自己, 争取技术事业上有大的进步.</p>
<p>关于生活, 不想多说什么, 平平淡淡, 真真切切, 这样挺好 !</p>
]]></content>
    </entry>
    
    <entry>
      <title><![CDATA[quickx-3.3 热更新若干心得]]></title>
      <url>http://blog.justbilt.com/2016/01/01/quickx-hotupdate/</url>
      <content type="html"><![CDATA[<p>关于热更新, 虽然这已经是第三次实现了, 但每一次都会有新的收获, 都会比上次更加完善一下.</p>
<a id="more"></a>
<h1 id="u4E00-_App__u7248_u672C_u53F7_u7684_u83B7_u53D6"><a href="#u4E00-_App__u7248_u672C_u53F7_u7684_u83B7_u53D6" class="headerlink" title="一. App 版本号的获取"></a>一. App 版本号的获取</h1><p>对于我们的游戏来说,其实是有两个版本配置的,一个是 <code>versionName</code>, 一个是 <code>versionCode</code>. versionName 只是一个显示, 类似于 <code>1.2.3</code>, 而 versionCode, 它是一个纯数字的字符串 (e.g. 4083), 它可以简单的<strong>转化为 int 去对比版本大小</strong>. 那么如何去获取app对应的版本呢 ?</p>
<p>iOS:<br><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">std</span>::<span class="built_in">string</span> Device::getAppVersionCode()</span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">return</span> [[[NSBundle mainBundle] objectForInfoDictionaryKey:@<span class="string">"CFBundleVersion"</span>] cStringUsingEncoding:NSUTF8StringEncoding];</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>MacOS 上获取版本号的方式与 iOS 一致.</p>
<p>Android:<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> String <span class="title">getAppVersionCode</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    String versionCode = <span class="string">""</span>;</span><br><span class="line">    PackageInfo pInfo;</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        pInfo = sActivity.getPackageManager().getPackageInfo(sActivity.getPackageName(), <span class="number">0</span>);</span><br><span class="line">        versionCode = <span class="string">""</span>+pInfo.versionCode;</span><br><span class="line">    &#125; <span class="keyword">catch</span> (NameNotFoundException e) &#123;</span><br><span class="line">        <span class="comment">// TODO Auto-generated catch block</span></span><br><span class="line">        e.printStackTrace();</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> versionCode;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>为了调用这个方法, 我们还需要额外实现一个 jni 的调用.</p>
<h1 id="u4E8C-__u5982_u4F55_u4FEE_u6539_Mac__u4E0A_UserDefault__u8BB0_u5F55"><a href="#u4E8C-__u5982_u4F55_u4FEE_u6539_Mac__u4E0A_UserDefault__u8BB0_u5F55" class="headerlink" title="二. 如何修改 Mac 上 UserDefault 记录"></a>二. 如何修改 Mac 上 UserDefault 记录</h1><p>quickx-3.3 Mac 版不再像 2.x 时将 UserDefault 保存在项目的根目录, 而是使用 <code>NSUserDefaults</code> 将配置保存在了系统的配置目录:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">~/Library/Preferences/com.cocos.quick.apps.player.plist</span><br></pre></td></tr></table></figure>
<p>双击可以使用 XCode 打开, <strong>修改保存完毕后并不会立刻生效</strong>, 而是需要再额外运行一条命令:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">killall -SIGTERM cfprefsd</span><br></pre></td></tr></table></figure>
<h1 id="u4E09-__u5982_u4F55_u91CD_u542F_u6E38_u620F"><a href="#u4E09-__u5982_u4F55_u91CD_u542F_u6E38_u620F" class="headerlink" title="三. 如何重启游戏"></a>三. 如何重启游戏</h1><p>这个做法有好多, 纯App层面的, 纯Lua层面的, 我们使用了一个虽然很土但却很简单的做法. 因为热更新只会更新 lua 代码和资源, 因此可以通过重启 LuaEngine, 清空三大缓存来实现重启. 在 Lua 中发送重启消息, C++ 接收到消息后销毁并重新创建 LuaEngine. 关键代码如下:</p>
<p>Lua:</p>
<figure class="highlight lua"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">cc.Director:getInstance():getEventDispatcher():dispatchEvent(cc.EventCustom:new(<span class="string">"NEED_RESTART_APP"</span>))</span><br></pre></td></tr></table></figure>
<p>AppDelegate.cpp:</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 监听重启事件</span></span><br><span class="line"><span class="keyword">auto</span> callBack = [<span class="keyword">this</span>](EventCustom* event)</span><br><span class="line">&#123;</span><br><span class="line">    <span class="comment">//do restart LuaEngine</span></span><br><span class="line">&#125;;</span><br><span class="line">Director::getInstance()-&gt;getEventDispatcher()-&gt;addCustomEventListener(<span class="string">"NEED_RESTART_APP"</span>, callBack);</span><br></pre></td></tr></table></figure>
<h1 id="u56DB-__u4EE3_u7801_u66F4_u65B0_u7B56_u7565"><a href="#u56DB-__u4EE3_u7801_u66F4_u65B0_u7B56_u7565" class="headerlink" title="四. 代码更新策略"></a>四. 代码更新策略</h1><p>大体分为三类:</p>
<ol>
<li>全量更新</li>
<li>相对于上一个版本增量更新</li>
<li>相对于渠道版本增量更新</li>
</ol>
<p><strong>全量更新</strong>指每一个热更新包内都含有项目全部代码, 如果项目体量较小的话勉强可以接收这种方案, 如果项目略大一些, 更新包就会很大, 随便更改一行代码都会有 3,4M 的更新, 实乃下下之策.</p>
<p><strong>相对于上一个版本增量更新</strong>, 这样更新包就会小很多, 达到资源的最大利用, 缺点是如果版本相差较大就会需要下载多个更新包, 如果代码采用 zip 压缩的话, 需要将这些 zip (e.g. <code>1.1-1.2.zip</code>, <code>1.2-1.3.zip</code>)都加载进来.</p>
<p><strong>相对于渠道版本增量更新</strong>, 这一种折中的解决方案, 对比差异是永远是基于线上渠道版本, 这种做法的优点在于游戏只用额外挂载一个 <code>patch.zip</code>, 玩家也只用更新一次即可到最新版, 而代价只是会增加一些服务器更新包的存储开销.</p>
<p>很长一段时间内, 我们都很 low 的采用了第一种解决方案, 造成这种错误的原因在于我错误的估计了增量更新的难度, 进而放宽了自我要求, 觉得全量更新还OK balabala… 多亏了 @BinStartup 童鞋强烈地需求, 才迫使我们去考虑更优解决方案, 用我们内部的一个梗来夸赞一下 Bin 童鞋: ‘牛逼呀~’ . </p>
<h1 id="u4E94-__u66F4_u65B0_u5305_u7684_u5236_u4F5C"><a href="#u4E94-__u66F4_u65B0_u5305_u7684_u5236_u4F5C" class="headerlink" title="五. 更新包的制作"></a>五. 更新包的制作</h1><p>相比于代码层面的热更新支持, 自动化的制作热更新包才是更为重要的事情, 因为这个操作会持续的发生, 并且随着更新次数的增多复杂度会剧增.</p>
<p>从大的层面来看, 更新包的制作主要有这么几个问题:</p>
<h2 id="1-__u5982_u4F55_u6807_u8BB0_u5E76_u5BFC_u51FA_u7248_u672C_3F"><a href="#1-__u5982_u4F55_u6807_u8BB0_u5E76_u5BFC_u51FA_u7248_u672C_3F" class="headerlink" title="1. 如何标记并导出版本?"></a>1. 如何标记并导出版本?</h2><p>首先我们要考虑如何标记版本, 因为要做增量更新就必须得对比不同的版本, 实现的方法有好多, 你甚至可以每次都将项目拷贝一份, 用版本号来命名. 我们项目版本控制工具是 git , 因此可以使用 git tag 来标记版本号.</p>
<p>至于导出版本, 一开始并没有考虑到这个, 本来打算直接使用 <code>git diff</code>来进行版本对比, 不幸的是我们项目中有一堆的 <code>submodule</code>, git diff 并不能对比子模块的变化. 同理 <code>git archive</code> 也不可以, 最终我们使用了:</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">git checkout <span class="variable">$tag</span></span><br><span class="line">git submodule update --init --recursive</span><br></pre></td></tr></table></figure>
<p>这样当前项目的环境就到了 <code>$tag</code> 这次提交, 然后将 <code>src</code> 目录拷贝到一个临时目录, 再切换到下一个 tag . 多次之后, 就获取到了所有版本的脚本文件了.</p>
<h2 id="2-__u5982_u4F55_u5BF9_u6BD4_u751F_u6210_diff__u6587_u4EF6"><a href="#2-__u5982_u4F55_u5BF9_u6BD4_u751F_u6210_diff__u6587_u4EF6" class="headerlink" title="2. 如何对比生成 diff 文件"></a>2. 如何对比生成 diff 文件</h2><p>因为是拷贝到了临时的目录, 所以不能通过 <code>git diff</code> 来进行对比了. 简单搜索了下, 可选的是系统自带的 <code>diff</code> 命令, 不过它的结果不方便处理. 最终决定使用 python 的 <code>filecmp</code> 模块进行对比. </p>
<h2 id="3-__u5176_u4ED6_u540E_u7EED_u5904_u7406"><a href="#3-__u5176_u4ED6_u540E_u7EED_u5904_u7406" class="headerlink" title="3. 其他后续处理"></a>3. 其他后续处理</h2><p>diff 出来的脚本问题, 我们需要加密, 和加密 src 一样调用 <code>compile_scripts.sh</code> 即可.</p>
<p>因为热更新需要的是一个 zip 文件, 我们可能会用到 <code>zip</code> 命令, 需要注意的一点是不能简单的使用 <code>zip -r xxx.zip yyy</code>, 这样的话压缩包内会含有 <code>yyy</code> 目录. 正确的做法是:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">(cd yyy; zip -r ../xxx.zip *)</span><br></pre></td></tr></table></figure>
<hr>
<p>重启的那个方案还有一些隐患, 所以没有放出具体的代码, 等修复之后会补上.<br>暂时就这些, 后面想到啥了再加上来.</p>
]]></content>
    </entry>
    
    <entry>
      <title><![CDATA[使用 Pyqtdeploy 发布你的 Pyqt 程序]]></title>
      <url>http://blog.justbilt.com/2015/11/28/pyqtdeploy/</url>
      <content type="html"><![CDATA[<p>在不久前我的另一篇博文<a href="/2015/10/17/setup-pyqt5-on-mac">Pyqt5 MacOS 环境搭建</a>中介绍了如何在 Mac 上搭建 PyQt 的环境, 如果你恰巧看过那篇文章, 并且照做了, 那么非常不幸, 如果你打算使用 pyqtdeploy 发布的你的程序的话, 你可能得重新来一遍了!</p>
<a id="more"></a>
<p>我们需要准备几个几个东西:</p>
<ol>
<li>在<a href="https://www.python.org/downloads/source/" target="_blank" rel="external">这里</a>下载 python 3.x 的源码包.</li>
<li>在<a href="https://riverbankcomputing.com/software/sip/download" target="_blank" rel="external">这里</a>下载 sip 的源码包.</li>
<li>在<a href="http://sourceforge.net/projects/PyQt/files/PyQt5/" target="_blank" rel="external">这里</a>下载与你 qt 版本对应的 PyQt 的源码包.</li>
</ol>
<p>注: 不要下载 3.5 , 因为后面某一步骤时会出错. – 2015年11月29日</p>
<h1 id="u4E00-__u5B89_u88C5"><a href="#u4E00-__u5B89_u88C5" class="headerlink" title="一. 安装"></a>一. 安装</h1><h2 id="1-__u5B89_u88C5_python3__3A"><a href="#1-__u5B89_u88C5_python3__3A" class="headerlink" title="1. 安装 python3 :"></a>1. 安装 python3 :</h2><p>因为 pyqtdeploy 要求 PyQt5 和 Python v3.2 或更高的版本, 因此我们需要安装 python3, 这里要记下你的 python 主要版本号 (e.g. 3.4), 后面会用到.</p>
<p>解压下载好的 python3 源码, 开启终端 cd 进这个目录:<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">./configure</span><br></pre></td></tr></table></figure></p>
<p>等待结束后执行 <code>make</code>, 没有错误的话 <code>make install</code> .</p>
<p>##2. 安装 sip :</p>
<p>因为某些未知的原因, 我们需要先使用 brew 安装 sip:<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">brew install sip --with-python3</span><br></pre></td></tr></table></figure></p>
<p>然后解压下载好的源码包, 打开终端 cd 进解压好的目录:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">python3 configure.py --static --target-py-version=VERSION</span><br></pre></td></tr></table></figure>
<p>替换 VERSION 为你的 python3 版本号, <code>--static</code> 是将 sip 编译为静态库的, 我们使用 brew 安装的 sip 没有生成静态库, 因此我们需要手动安装.</p>
<p>等待成功后, 执行 <code>make &amp;&amp; make install</code>.</p>
<p>因为上一步会会覆盖 brew 安装的 sip 的执行文件, 所以我们需要重新 link 一下.</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">brew link --overwrite sip</span><br></pre></td></tr></table></figure>
<p>然后我们<code>brew info sip</code>, 可以找到类似的一个路径:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">/usr/local/Cellar/sip/4.16.9</span><br></pre></td></tr></table></figure>
<p>在这个路径下有一个 <code>include</code> 文件夹, 这个文件夹的路径就是就是我们下面安装 <code>PyQt</code> 所需的路径.</p>
<p>##3. 安装 PyQt</p>
<p>这一步需要知道 <code>qmake</code> 的路径, 因此我们需将它所在目录加入到环境变量中:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">export PATH=/path/of/your/Qt/clang_64/bin:$PATH</span><br></pre></td></tr></table></figure>
<p>最终我们会输入这样的一行指令:<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">python3 configure.py --sip-incdir=PATH --target-py-version=VERSION --static</span><br></pre></td></tr></table></figure></p>
<p>将上面的 <code>PATH</code> 修改为上面获取到的路径(e.g. <code>/usr/local/Cellar/sip/4.16.9/include</code>), 同时 <code>VERSION</code> 替换为你的 python 版本.</p>
<p>提示 <code>Do you accept the terms of the license?</code> 时输入 <code>yes</code>.</p>
<p>等待成功后,执行 <code>make</code>, 这一步需要编译好多东西, 可能会需要好久. 若是没有什么错误的话, 执行 <code>make install</code>.</p>
<p>##4. 安装 pyqtdeploy</p>
<p>安装好前面那些之后, 这一步变得十分简单:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">pip3 install pyqtdeploy</span><br></pre></td></tr></table></figure>
<p>到此为止, 我们 pyqtdeploy 的环境就搭建好了, 在任意目录输入 <code>pyqtdeploy</code>, 看到下面这个界面就算成功了:</p>
<p><img src="http://static.zybuluo.com/justbilt/0ud9c1sdxopu72gu02htefgb/%E5%B1%8F%E5%B9%95%E5%BF%AB%E7%85%A7%202015-12-05%20%E4%B8%8B%E5%8D%882.28.29.png" alt=""></p>
<h1 id="u4E8C-__u4F7F_u7528"><a href="#u4E8C-__u4F7F_u7528" class="headerlink" title="二. 使用"></a>二. 使用</h1><p>关于 pyqtdeploy 的使用还是建议大家看看<a href="http://PyQt.sourceforge.net/Docs/pyqtdeploy/" target="_blank" rel="external">官方文档</a>, 写的非常详细, 开始我寻求其他人写的教程, 但竟无一篇中文教程, 英文也寥寥无几, 最后还是回去啃文档. 下面介绍一下我的配置是什么, 至于期间踩坑无数, 自不足为外人道也.</p>
<p>首先我要创建一个 <code>pdy</code> 文件, pdy 是 pyqtdeploy 的工程配置文件. 需要注意的一点是, pdy 文件一定要保存在程序入口 py 文件的同级目录. 首先在你的项目源码目录中打开终端, 键入命令 <code>pyqtdeploy xxx.pdy</code>,(替换xxx为你想起的文件名) 然后就会弹出一个gui界面.</p>
<h2 id="1-_Application_Source_3A"><a href="#1-_Application_Source_3A" class="headerlink" title="1. Application Source:"></a>1. Application Source:</h2><p><img src="http://ww4.sinaimg.cn/large/7f870d23gw1ez5zupeyb3j20rw0hs42h.jpg" alt=""></p>
<p>Name: 填入你程序的名称<br>Main Script file: 程序的入口文件<br>Application Package Directory: 程序的其他 py 文件</p>
<h2 id="2-_qmake"><a href="#2-_qmake" class="headerlink" title="2. qmake"></a>2. qmake</h2><p>这一页没有什么特别的设置</p>
<h2 id="3-_PyQt_Modules"><a href="#3-_PyQt_Modules" class="headerlink" title="3. PyQt Modules"></a>3. PyQt Modules</h2><p>这一页中你的项目中使用了什么模块就勾选什么模块就可以了.</p>
<h2 id="4-_Standard_Library"><a href="#4-_Standard_Library" class="headerlink" title="4. Standard Library"></a>4. Standard Library</h2><p>默认设置</p>
<h2 id="5-_Other_Packages"><a href="#5-_Other_Packages" class="headerlink" title="5. Other Packages"></a>5. Other Packages</h2><p>默认设置</p>
<h2 id="6-_Other_Extension_Modules"><a href="#6-_Other_Extension_Modules" class="headerlink" title="6. Other Extension Modules"></a>6. Other Extension Modules</h2><p>默认设置</p>
<h2 id="7-_Locations"><a href="#7-_Locations" class="headerlink" title="7. Locations"></a>7. Locations</h2><p>这一页的设置是重中之重, 曾在这里浪费了很多的时间.</p>
<p><img src="http://ww4.sinaimg.cn/large/7f870d23gw1ez67jp69umj20rw0f7jut.jpg" alt=""></p>
<p><strong>Interpreter</strong>: python 可执行文件路径<br><strong>Source directory</strong>: 还记得我们之前下载的 python 源码, 解压到一个目录, 填写路径到这里就ok了 !<br><strong>Include directory</strong>: python 的头文件路径<br><strong>Python library</strong>: python 的静态库文件路径<br><strong>Standard python library</strong>: python 标准库文件路径<br><strong>Build directory</strong>: 构建用路径<br><strong>qmake</strong>: qmake 文件路径</p>
<h2 id="8-_Build"><a href="#8-_Build" class="headerlink" title="8. Build"></a>8. Build</h2><p><img src="http://ww4.sinaimg.cn/large/7f870d23gw1ez69ew90vbj20r40ef7b2.jpg" alt=""></p>
<p>这一页必要重要的是勾选 <code>Verbose output</code> , 这样子出错了能够比较准确的定位. 另外勾选 <code>Additional Build Steps</code>, 可以帮你编译运行.</p>
<h1 id="u4E09-_Q_26amp_3BA"><a href="#u4E09-_Q_26amp_3BA" class="headerlink" title="三. Q&amp;A"></a>三. Q&amp;A</h1><ol>
<li>ImportError: No module named xxx</li>
</ol>
<p>如果这个模块是你项目的一个本地依赖模块, 那么请检查你的 pdy 文件是否保存在代码入口文件的同一级目录.</p>
<ol>
<li>error: use of undeclared identifier ‘_Py_BEGIN_SUPPRESS_IPH’</li>
</ol>
<p>是否使用了 python3.5 , 我切换为 python3.4 就 ok 了!</p>
<hr>
<p>转眼间又过去了一个月多月, 每周一篇好不容易坚持了3周就这样断掉了. 主要原因是还是懒, 次要原因是公司项目即将上线, 所以工作比平时要紧张好多, 最近两周周六也开始加班了!  对目前这个项目还是比较看好的, 加油!</p>
<p>下次分享下我在最近这次热更新上的一些收获!</p>
]]></content>
    </entry>
    
    <entry>
      <title><![CDATA[FAlign 代码洁癖患者的福音]]></title>
      <url>http://blog.justbilt.com/2015/11/15/falign/</url>
      <content type="html"><![CDATA[<p>对于一个重度代码洁癖患者, 看到下面这样的代码, 心中难免奇痒难耐, 想要给它对齐了去!</p>
<a id="more"></a>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">local name = params.name or &#34;Arial&#34;&#10;local color = params.color or cc.c3b(255, 255, 255)&#10;local age = params.age or 0&#10;local font_size = params.font_size or 30</span><br></pre></td></tr></table></figure>
<p>sublime 的代码对齐插件有很多, 大家可以<a href="https://packagecontrol.io/search/align?sort=popularity" target="_blank" rel="external">看这里</a>, 我之前一直使用的是 <a href="https://packagecontrol.io/packages/VAlign" target="_blank" rel="external">VAlign</a>, 事实上它在多数的情况下还是很好使的. 但是它还是有这么几个问题:</p>
<ol>
<li>个别情况下代码对齐的不够理想.</li>
<li>不能多次对齐.</li>
<li>就算已经对齐, 也会使得文件变为 modified 状态.</li>
</ol>
<blockquote>
<p><strong>一种造轮子的冲动涌上心头.</strong></p>
</blockquote>
<p><img src="/img/22015-04-19-001.jpg" alt=""></p>
<h1 id="u5F00_u5E72"><a href="#u5F00_u5E72" class="headerlink" title="开干"></a>开干</h1><p>之前一直没有尝试过类似的事情, 一上来有些发蒙, 从哪里入手呢? 仔细分析了下需求, 将功能切分为小块.</p>
<h2 id="1-__u4E00_u884C_u4EE3_u7801_u7684_u7279_u5F81"><a href="#1-__u4E00_u884C_u4EE3_u7801_u7684_u7279_u5F81" class="headerlink" title="1. 一行代码的特征"></a>1. 一行代码的特征</h2><p>什么样的代码会需要对齐? <strong>多行相似的代码</strong>. 怎么判断相似? <strong>有共同的特征吗?</strong> 一行代码的特征有好多, 怎么确定那个是你想要的.</p>
<p>最终我选择了 <code>缩进层级</code> 作为第一个特征, 如果两个文字的缩进层级不一致的话, 它们就不会被对齐. 第二个特征我选择了 <code>关键字列表</code>, 我找出了所有关键字和它们在这一行中的位置.</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&#123; [1] = &#123;keyword : &#34;=&#34;, position: 10&#125;, [2] = &#123;keyword : &#34;,&#34;, position: 20&#125;, ...&#125;</span><br></pre></td></tr></table></figure>
<h2 id="2-__u627E_u5230_u76F8_u4F3C_u884C"><a href="#2-__u627E_u5230_u76F8_u4F3C_u884C" class="headerlink" title="2. 找到相似行"></a>2. 找到相似行</h2><p>我的做法和 Vlign 是一致的, for 循环分别加减一个游标, 代表着当前行, 获取这一行的特征数据, 如果缩进和关键字列表中的第一个元素一致的话, 则记录这一行, 否则跳出循环.</p>
<p>这样当 for 循环结束后, 我们就获得了一个多行数据的列表.</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&#123;&#10;    &#34;80&#34; : &#123; [1] = &#123;keyword : &#34;=&#34;, position: 10&#125;, [2] = &#123;keyword : &#34;,&#34;, position: 20&#125;, ...&#125;,&#10;    &#34;81&#34; : &#123; [1] = &#123;keyword : &#34;=&#34;, position: 15&#125;, [2] = &#123;keyword : &#34;,&#34;, position: 40&#125;, ...&#125;,&#10;    &#34;82&#34; : &#123; [1] = &#123;keyword : &#34;=&#34;, position: 20&#125;, [2] = &#123;keyword : &#34;,&#34;, position: 60&#125;, ...&#125;,&#10;    &#34;83&#34; : &#123; [1] = &#123;keyword : &#34;=&#34;, position: 25&#125;, [2] = &#123;keyword : &#34;,&#34;, position: 80&#125;, ...&#125;,&#10;&#125;</span><br></pre></td></tr></table></figure>
<h2 id="3-__u5220_u9664_u5DF2_u7ECF_u5BF9_u9F50_u7684keyword"><a href="#3-__u5220_u9664_u5DF2_u7ECF_u5BF9_u9F50_u7684keyword" class="headerlink" title="3. 删除已经对齐的keyword"></a>3. 删除已经对齐的keyword</h2><p>按照我的设想, 应该是每调用一次对齐函数, 就找到第一个没有对齐的关键字进行对齐, 这样当一组需要对齐的文字中有多个可以对齐的关键字的话, 就需要多次调用对齐函数. 那么问题就来了? 如何判断出当前相对齐的是哪一个关键字呢?</p>
<p>我是这样子做的, 前面不是找到了多行数据的列表嘛, 我们遍历一下这个列表, 如果这些行的关键字列表中的第一个元素的位置是一样的, 那么这个关键字就已经对齐了, 那么我便删除它.</p>
<p>这样多次后, 列表中的行的关键字列表的第一个元素就是我们需要对齐的那个元素啦.</p>
<p>但是这样之后, 之前的行数据就会有中断的情况, 所以我们需要再次整理这些数据.</p>
<h2 id="4-__u53BB_u9664_u5173_u952E_u5B57_u5468_u56F4_u7684_u7A7A_u767D"><a href="#4-__u53BB_u9664_u5173_u952E_u5B57_u5468_u56F4_u7684_u7A7A_u767D" class="headerlink" title="4. 去除关键字周围的空白"></a>4. 去除关键字周围的空白</h2><p>我举个栗子, 比如下面这两行代码:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">local a    = 1&#10;local bbbbbb        = 1</span><br></pre></td></tr></table></figure>
<p>我们以 <code>=</code> 为关键字对齐它, 如果不去除周围的空白的话, 对齐出来的将会是这个样子的:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">local a             = 1&#10;local bbbbbb        = 1</span><br></pre></td></tr></table></figure>
<p>这显然不是我们需要的, 我的实现是这个样子的, 还是 for 循环使用一个游标从关键字位置分别向前后遍历, 遇到第一个非空字符停止, 这样循环结束后便会获得一个区间. 然后我们在根据这个关键字左右是否需要空格构造一个新的关键字内容去替换掉那个区间的字符串.</p>
<h2 id="5-__u5BF9_u9F50_u884C"><a href="#5-__u5BF9_u9F50_u884C" class="headerlink" title="5. 对齐行"></a>5. 对齐行</h2><p>真正昨晚上上面的那些处理后, 对齐这些行的逻辑其实十分简单, 甚至都不超过10行代码. 主要就是遍历一遍, 找出某个关键字在所有行中的最大位置, 然后给每行关键字的前面或后面补足与最大值的差值的空格即可.</p>
<h1 id="FAlign"><a href="#FAlign" class="headerlink" title="FAlign"></a>FAlign</h1><p>FAlign 是 sublime 的一个代码对齐插件, 实现了一行代码多个关键字的对齐功能.</p>
<p><img src="http://ww4.sinaimg.cn/large/7f870d23gw1exv5kflm7ug20ov0213yx.gif" alt=""></p>
<p>代码开源在github: <a href="https://github.com/justbilt/sublime-falign" target="_blank" rel="external">https://github.com/justbilt/sublime-falign</a>, 大家可自行取阅.</p>
<h2 id="u5B89_u88C5"><a href="#u5B89_u88C5" class="headerlink" title="安装"></a>安装</h2><p>两个方法安装:</p>
<ol>
<li>如果安装了 Package Control 的话, 可以搜索 <code>FAlign</code> 安装</li>
<li>将源码 clone 到你 sublime 插件目录</li>
</ol>
<h2 id="u4F7F_u7528_u65B9_u6CD5"><a href="#u4F7F_u7528_u65B9_u6CD5" class="headerlink" title="使用方法"></a>使用方法</h2><p><code>⌘ + \</code> 对齐第一个关键字, 再次按下对齐第二个关键字, …</p>
<h2 id="u793A_u4F8B"><a href="#u793A_u4F8B" class="headerlink" title="示例"></a>示例</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Button = import(&#34;.utils.Button&#34;)&#10;AlertEx = import(&#34;.utils.AlertEx&#34;)&#10;Tips = import(&#34;.utils.Tips&#34;)&#10;Help = import(&#34;.utils.Help&#34;)</span><br></pre></td></tr></table></figure>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Button  = import(&#34;.utils.Button&#34;)&#10;AlertEx = import(&#34;.utils.AlertEx&#34;)&#10;Tips    = import(&#34;.utils.Tips&#34;)&#10;Help    = import(&#34;.utils.Help&#34;)</span><br></pre></td></tr></table></figure>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">dispatcher:addEventListener(&#34;mail_new&#34;, mail_new)&#10;dispatcher:addEventListener(&#34;mail_mark_read&#34;, mail_mark_read)&#10;dispatcher:addEventListener(&#34;mail_handle_invitation&#34;, mail_handle_invitation)&#10;dispatcher:addEventListener(&#34;mail_send&#34;, mail_send)</span><br></pre></td></tr></table></figure>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">dispatcher:addEventListener(&#34;mail_new&#34;,               mail_new)&#10;dispatcher:addEventListener(&#34;mail_mark_read&#34;,         mail_mark_read)&#10;dispatcher:addEventListener(&#34;mail_handle_invitation&#34;, mail_handle_invitation)&#10;dispatcher:addEventListener(&#34;mail_send&#34;,              mail_send)</span><br></pre></td></tr></table></figure>
]]></content>
    </entry>
    
    <entry>
      <title><![CDATA[MyGUI学习笔记(二) 在 MacOS 上运行MyGUI]]></title>
      <url>http://blog.justbilt.com/2015/10/31/mygui-2-run-on-osx/</url>
      <content type="html"><![CDATA[<p>不知大家是否还记得我的这篇文章 <a href="http://blog.justbilt.com/2015/05/29/mygui-1-run-on-windows">MyGUI学习笔记(一) 在Windows上运行MyGUI</a>, 这篇文章讲述了在 Windows 上编译运行 MyGUI 的过程. 文中提到了在 Mac 遇到了很多坑, 确实如此, 当时的 MyGUI 虽然号称 Cross Platform , 但是在 Mac 却有好多东西没有实现, 编译起来困难重重, 以至于我不得不切换到 Windows 系统上, 因此便有了那篇文章.</p>
<a id="more"></a>
<p>那么今天为什么又要写这个了呢? 因为这几个月内, MyGUI 团队针对 Mac 做了好多修改, 使得脱离 Ogre 之后 Demo 也能够跨平台运行了!</p>
<p>那么我们就来看一下如何在 Mac 上运行 MyGUI 吧!</p>
<h1 id="u96F6-__u51C6_u5907_u5DE5_u4F5C"><a href="#u96F6-__u51C6_u5907_u5DE5_u4F5C" class="headerlink" title="零. 准备工作"></a>零. 准备工作</h1><p>如同 Windows 一样, 我们需要做一些准备工作. 因为在这个阶段这些工作互不影响, 因此大家并行操作, 高效利用时间.</p>
<ol>
<li>从 github 上 clone 最新的 <a href="https://github.com/MyGUI/mygui" target="_blank" rel="external">MyGUI 源码</a>.</li>
<li>下载 <a href="https://cmake.org/download/" target="_blank" rel="external">CMake Mac 版</a>, 并安装.</li>
<li>使用 Homebrew 安装 <code>sdl2_image</code>.</li>
<li>下载已经编译好的 Mac 版 <a href="http://jaist.dl.sourceforge.net/project/ogre/ogre-dependencies-mac/1.8/OgreDependencies_OSX_20120525.zip" target="_blank" rel="external">Orge Dependencise</a>, 并解压到 mygui 的根目录.</li>
</ol>
<p>注: 这里我偷懒使用了已经编译好的依赖库, 毕竟那不是我们的主要目的. 当然你也可以自行编译, 源码位于<a href="https://bitbucket.org/cabalistic/ogredeps" target="_blank" rel="external">这里</a>. </p>
<h1 id="u4E00-__u751F_u6210_Xcode__u5DE5_u7A0B"><a href="#u4E00-__u751F_u6210_Xcode__u5DE5_u7A0B" class="headerlink" title="一. 生成 Xcode 工程"></a>一. 生成 Xcode 工程</h1><p>首先我们运行 CMake, 然后在 <code>Where is the source code:</code> 栏选择你的 clone 下来的 mygui 源码路径. 在 <code>Where to build the binaries:</code> 选择生成目录, 我是选择生成在 mygui 的 <code>bin</code> 路径下.</p>
<p><img src="http://static.zybuluo.com/justbilt/ultxdpj801k222om0tyr205m/QQ20151101-0.png" alt="QQ20151101-0.png-24.9kB"></p>
<p>然后点击 <code>Configure</code> 按钮, 如果弹出询问是否创建 <code>bin</code> 路径, 请同意. 在接下来的弹出界面的下拉列表中选择 <code>Xcode</code>, 点击确定.</p>
<p>等待片刻后, 会弹出一个错误提示:</p>
<blockquote>
<p>Error in configuration precess, project files may be invaild</p>
</blockquote>
<p>在日志窗口查看错误信息可以得知我们需要修下 <code>MYGUI_RENDERSYSTEM</code> 的值. 为方便查找, 我们可以将 CMake 界面的 <code>Grouped</code> 复选框选中, 这样所有的配置都会分组显示. </p>
<p>在中间红色区域的 <code>MYGUI</code> 分类下找到 <code>MYGUI_RENDERSYSTEM</code> 选项, 将其值修改为 <code>4</code>, 鼠标悬停可以查看数字做代表的意义.</p>
<p><img src="http://static.zybuluo.com/justbilt/xiit07e4x4z8khyymr3d0a8z/QQ20151101-1.png" alt="QQ20151101-1.png-61.6kB"></p>
<p>再次点击 <code>Configure</code> 按钮, 无任何错误提示即为成功. 接下来点击 <code>Generate</code> 生成 Xcode 工程.</p>
<h1 id="u4E8C-__u7F16_u8BD1_MyGUI"><a href="#u4E8C-__u7F16_u8BD1_MyGUI" class="headerlink" title="二. 编译 MyGUI"></a>二. 编译 MyGUI</h1><p>打开 <code>bin</code> 目录下的 <code>MYGUI.xcodeproj</code> 工程, 开始编译.  编译过程中会遇到如下编译错误:</p>
<blockquote>
<p>/Users/…/Data.cpp:136:11: No viable conversion from ‘std::__1::nullptr_t’ to ‘DataPtr’ (aka ‘shared_ptr<tools::data>‘)</tools::data></p>
</blockquote>
<p>对于这个错误说明呢大家可以<a href="https://github.com/MyGUI/mygui/pull/82" target="_blank" rel="external">看这里</a>, 我的解决方案是把出错地方的 <code>nullptr</code> 都改为 <code>NULL</code>, 一共需要修改十几处吧.</p>
<p><img src="http://static.zybuluo.com/justbilt/tfk0iznreipqw8m02ge20d3r/QQ20151101-2.png" alt="QQ20151101-2.png-82.3kB"></p>
<p>然后就编译成功了!</p>
<h1 id="u4E09-__u8FD0_u884C_MyGUI__u793A_u4F8B"><a href="#u4E09-__u8FD0_u884C_MyGUI__u793A_u4F8B" class="headerlink" title="三. 运行 MyGUI 示例"></a>三. 运行 MyGUI 示例</h1><p>当我们选中一个示例运行的时候, 会遇到这个崩溃错误:</p>
<blockquote>
<p>An exception has occured : MyGUI EXCEPTION : No root widget. [‘ColourPanel.layout]<br> in MyGUI at /Users/bilt/Documents/mygui/Common/BaseLayout/BaseLayout.h (line 126)libc++abi.dylib: terminating with uncaught exception of type MyGUI::Exception: MyGUI EXCEPTION : No root widget. [‘ColourPanel.layout]<br> in MyGUI at /Users/bilt/Documents/mygui/Common/BaseLayout/BaseLayout.h (line 126)</p>
</blockquote>
<p>经过追踪, 是没有找到 <code>resources.xml</code> 没有找见的原因, 它位于 <code>path/of/mygui/bin/bin</code>目录, 而默认应用的工作目录不是这里, 因此我们需要设置下工作目录.</p>
<p>选中 Scheme 列表末尾的 <code>Edit Scheme</code> (或者按下<code>cmd+shift+,</code>), 然后再 <code>Options</code> 标签下将 <code>Working Directory</code> 选择为你的生成 <code>bin</code> 目录.</p>
<p><img src="http://static.zybuluo.com/justbilt/6smjifuob0cc0g24yis212t1/QQ20151101-5.png" alt="QQ20151101-5.png-97.1kB"></p>
<p>再次运行就可以啦!</p>
<p>上一张截图纪念一下:</p>
<p><img src="http://static.zybuluo.com/justbilt/qeeokj32fvk2qgkufmwk0ki9/QQ20151101-3.png" alt="QQ20151101-3.png-371.3kB"></p>
<hr>
<p>MyGUI 从07年发展到现在已有8年的历史了, 仍然有这么多人在开发使用, 真的让人敬佩不已. 同时 MyGUI 的代码简洁, 优美, 十分适合学习研究, 下面我将从浅入深的和大家分享我的学习经验!</p>
]]></content>
    </entry>
    
    <entry>
      <title><![CDATA[Pyqt5 MacOS 环境搭建]]></title>
      <url>http://blog.justbilt.com/2015/10/17/setup-pyqt5-on-mac/</url>
      <content type="html"><![CDATA[<p>尝试过用各种 python 的 gui 库来写一些小工具, TkInter, wxPython, Pyfltk , PyQt等, 最终发现还是只有 <code>wxPython</code> 和 <code>PyQt</code> 能相对靠谱一些, 控件全, 文档丰富, 使用的人多. 因为曾经使用搞过 qt , 所以最终选择了 PyQt, 这次我们来说一下如何在 Mac 上安装.</p>
<a id="more"></a>
<h1 id="1-__u5B89_u88C5_qt"><a href="#1-__u5B89_u88C5_qt" class="headerlink" title="1. 安装 qt"></a>1. 安装 qt</h1><p>PyQt 其实就是 qt 的 python 绑定, 所以我们首先需要安装 qt, 版本可以自行选择, <a href="http://www.qt.io/download-open-source/#section-2" target="_blank" rel="external">最新版</a> 的下载地址, <a href="http://download.qt.io/archive/qt/" target="_blank" rel="external">历史版本</a>的地址. 如果追求最新版的话, 最好是去 PyQt 的<a href="http://sourceforge.net/projects/PyQt/files/PyQt5/" target="_blank" rel="external">下载网站</a>看那一下最新版是什么, 因为 PyQt 的更新速度会落后于 qt.</p>
<p><img src="http://static.zybuluo.com/justbilt/krc3gqufsqx99msip1jw9fqy/%E5%B1%8F%E5%B9%95%E5%BF%AB%E7%85%A7%202015-09-12%20%E4%B8%8A%E5%8D%887.37.42.png" alt="屏幕快照 2015-09-12 上午7.37.42.png-117.1kB"></p>
<p>当看到这个界面时, qt 就安装成功了.</p>
<h1 id="2-__u5B89_u88C5_sip"><a href="#2-__u5B89_u88C5_sip" class="headerlink" title="2. 安装 sip"></a>2. 安装 sip</h1><p>sip 是一个 python 调用 c 的工具, 官方网址在<a href="http://PyQt.sourceforge.net/Docs/sip4/installation.html" target="_blank" rel="external">这里</a>, 我们可以按照官网上的指南去安装, 也可以选择另一种更简单的方式:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">brew install sip</span><br></pre></td></tr></table></figure>
<h1 id="3-__u5B89_u88C5_PyQt"><a href="#3-__u5B89_u88C5_PyQt" class="headerlink" title="3. 安装 PyQt"></a>3. 安装 PyQt</h1><hr>
<p>我们首先去<a href="http://sourceforge.net/projects/PyQt/files/PyQt5/" target="_blank" rel="external">这里</a>下载适合自己版本, 解压, 并在终端 cd 进这个目录. 执行:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">python configure.py</span><br></pre></td></tr></table></figure>
<p>如果出现 <code>Error: Use the --qmake argument to explicitly specify a working Qt qmake.</code> 错误, 则是因为我们没有将 <code>qmake</code> 加入到环境变量中. 那么 qmake 在哪里呢? 根绝安装路径和版本,差不多是在这样的一个路径中:</p>
<p><img src="http://static.zybuluo.com/justbilt/6tbyfo13vr6hf4cuztepeja9/%E5%B1%8F%E5%B9%95%E5%BF%AB%E7%85%A7%202015-09-13%20%E4%B8%8B%E5%8D%884.41.29.png" alt="屏幕快照 2015-09-13 下午4.41.29.png-75.1kB"></p>
<p>知道了路径, 我们可以似乎可以通过 <code>--qmake</code> 参数指定 qmake 目录 ,但其实我们可以把它临时的加入到环境变量中, 在终端中键入:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">export PATH=/path/your/qt/version/clang_64/bin:$PATH</span><br></pre></td></tr></table></figure>
<p>再次执行<code>python configure.py</code>, 一切顺林的话会遇到一个选择 license 的提示, 我们输入 <code>yes</code> 即可.</p>
<p>等待 <code>configure</code> 完成, 我们执行:<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">make</span><br></pre></td></tr></table></figure></p>
<p>这次可能并没有那么顺利, 我遇到这样的错误:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">In file included from ../qpy/QtCore/qpycore_api.h:30:&#10;../qpy/QtCore/qpycore_public_api.h:26:10: fatal error: &#39;sip.h&#39; file not found&#10;#include &#60;sip.h&#62;&#10;         ^&#10;1 error generated.&#10;make[1]: *** [qpycore_post_init.o] Error 1&#10;make: *** [sub-QtCore-make_first-ordered] Error 2</span><br></pre></td></tr></table></figure>
<p>这时候我们需要传入 sip 的 include 路径, 如果是通过 brew 安装的(如果不是, 请看文章末尾的Q&amp;A), 可以通过 <code>brew info sip</code>获得:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ brew info sip&#10;sip: stable 4.16.9 (bottled), HEAD&#10;Tool to create Python bindings for C and C++ libraries&#10;http://www.riverbankcomputing.co.uk/software/sip&#10;/usr/local/Cellar/sip/4.16.9 (10 files, 908K) *</span><br></pre></td></tr></table></figure>
<p>然后重新执行 </p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">python configure.py --sip-incdir=/path/of/your/sip/4.16.9/include</span><br></pre></td></tr></table></figure>
<p>等待成功后, 我们可以执行:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">make &#38;&#38; make install</span><br></pre></td></tr></table></figure>
<p>到此为止, 我们安装就完成了. 下面让我们用 <a href="http://zetcode.com/gui/pyqt5/" target="_blank" rel="external">zetcode</a> 上的例题测试一下:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">#!/usr/bin/python3&#10;# -*- coding: utf-8 -*-&#10;&#10;&#34;&#34;&#34;&#10;ZetCode PyQt5 tutorial &#10;&#10;In this example, we create a simple&#10;window in PyQt5.&#10;&#10;author: Jan Bodnar&#10;website: zetcode.com &#10;last edited: January 2015&#10;&#34;&#34;&#34;&#10;&#10;import sys&#10;from PyQt5.QtWidgets import QApplication, QWidget&#10;&#10;&#10;if __name__ == &#39;__main__&#39;:&#10;    &#10;    app = QApplication(sys.argv)&#10;&#10;    w = QWidget()&#10;    w.resize(250, 150)&#10;    w.move(300, 300)&#10;    w.setWindowTitle(&#39;Simple&#39;)&#10;    w.show()&#10;    &#10;    sys.exit(app.exec_())</span><br></pre></td></tr></table></figure>
<p>把上面那段代码保存在一个python文件中, 然后执行:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">python test.py</span><br></pre></td></tr></table></figure>
<p>如果出现下面这个界面, 就说明你成功了!</p>
<p><img src="http://static.zybuluo.com/justbilt/qg63w41bobru04w0oki6iu8g/%E5%B1%8F%E5%B9%95%E5%BF%AB%E7%85%A7%202015-09-14%20%E4%B8%8A%E5%8D%888.02.58.png" alt="屏幕快照 2015-09-14 上午8.02.58.png-20kB"></p>
<hr>
<p>如果你没有通过 brew 安装 sip , 你可能遇到的问题:</p>
<h2 id="1-__u5B89_u88C5_PyQt__2C__u6267_u884C_python_configure-py__u65F6_u627E_u4E0D_u5230_sip"><a href="#1-__u5B89_u88C5_PyQt__2C__u6267_u884C_python_configure-py__u65F6_u627E_u4E0D_u5230_sip" class="headerlink" title="1. 安装 PyQt , 执行 python configure.py 时找不到 sip"></a>1. 安装 PyQt , 执行 <code>python configure.py</code> 时找不到 sip</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sh: sip: command not found&#10;Error: &#39;sip -V&#39; did not generate any output.</span><br></pre></td></tr></table></figure>
<h2 id="u89E3_u51B3_u65B9_u6848_3A"><a href="#u89E3_u51B3_u65B9_u6848_3A" class="headerlink" title="解决方案:"></a>解决方案:</h2><p>知道你安装 sip <code>make install</code> 时的一些信息, 比如:<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ make install&#10;cp -f sip /usr/local/Cellar/python/2.7.10_2/Frameworks/Python.framework/Versions/2.7/bin/sip</span><br></pre></td></tr></table></figure></p>
<p>然后在终端中执行:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">export PATH=/path/of/your/python/2.7.10_2/Frameworks/Python.framework/Versions/2.7/bin/:$PATH</span><br></pre></td></tr></table></figure>
<h2 id="2-_fatal_error_3A__u2018sip-h_u2019_file_not_found"><a href="#2-_fatal_error_3A__u2018sip-h_u2019_file_not_found" class="headerlink" title="2. fatal error: ‘sip.h’ file not found"></a>2. fatal error: ‘sip.h’ file not found</h2><p>错误:<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">In file included from qpycore_post_init.cpp:25:&#10;In file included from ../qpy/QtCore/qpycore_api.h:30:&#10;../qpy/QtCore/qpycore_public_api.h:26:10: fatal error: &#39;sip.h&#39; file not found&#10;#include &#60;sip.h&#62;&#10;         ^&#10;1 error generated.&#10;make[1]: *** [qpycore_post_init.o] Error 1&#10;make: *** [sub-QtCore-make_first-ordered] Error 2</span><br></pre></td></tr></table></figure></p>
<p><a href="http://python.6.x6.nabble.com/PyQt-5-1-1-Compilation-Error-td5037071.html" target="_blank" rel="external">解决方案</a>:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">python configure.py --sip-incdir=/path/of/your/Downloads/sip-4.16.9/siplib</span><br></pre></td></tr></table></figure>
<hr>
<p>Update 2015年11月25日:</p>
<h2 id="u5982_u4F55_u4E3A_python3__u5B89_u88C5_pyqt5"><a href="#u5982_u4F55_u4E3A_python3__u5B89_u88C5_pyqt5" class="headerlink" title="如何为 python3 安装 pyqt5"></a>如何为 python3 安装 pyqt5</h2><h3 id="1-__u5B89_u88C5_sip__u65F6_u9644_u52A0_u989D_u5916_u53C2_u6570_-with-python3"><a href="#1-__u5B89_u88C5_sip__u65F6_u9644_u52A0_u989D_u5916_u53C2_u6570_-with-python3" class="headerlink" title="1. 安装 sip 时附加额外参数 --with-python3"></a>1. 安装 sip 时附加额外参数 <code>--with-python3</code></h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">brew install sip --with-python3</span><br></pre></td></tr></table></figure>
<h3 id="2-__u5B89_u88C5_PyQt__u65F6_u9644_u52A0_u989D_u5916_u53C2_u6570_-target-py-version_3DVERSION__28e-g-_3-4_29"><a href="#2-__u5B89_u88C5_PyQt__u65F6_u9644_u52A0_u989D_u5916_u53C2_u6570_-target-py-version_3DVERSION__28e-g-_3-4_29" class="headerlink" title="2. 安装 PyQt 时附加额外参数 --target-py-version=VERSION (e.g. 3.4)"></a>2. 安装 PyQt 时附加额外参数 <code>--target-py-version=VERSION</code> (e.g. 3.4)</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">python3 configure.py --sip-incdir=/path/of/your/sip/include --target-py-version=VERSION</span><br></pre></td></tr></table></figure>
]]></content>
    </entry>
    
    <entry>
      <title><![CDATA[ldoc 入门指南]]></title>
      <url>http://blog.justbilt.com/2015/08/23/ldoc/</url>
      <content type="html"><![CDATA[<p>最近因为服务端的一些变故, 需要一份客户端与服务器交互的 api 文档. 首先肯定是要排除掉手写的, api 文档这货肯定是要自动生成啦, 要不以后维护起来得死人的.</p>
<a id="more"></a>
<p>项目前端是使用 quick-cocos2d-x 来开发的, 开发语言是 lua, 找了一下 lua 的文档生成工具, 貌似只有 LuaDoc 和 LDoc 可以选. LuaDoc 已经好几年没有人维护了, 加上 LDoc 可以兼容 LuaDoc 的文档, 所以就定了 LDoc.</p>
<h1 id="u4E00-__u5B89_u88C5"><a href="#u4E00-__u5B89_u88C5" class="headerlink" title="一. 安装"></a>一. 安装</h1><p>因为 LDoc 依赖与 penlight 和 lfs , 所以使用 luarocks 来安装是最简单的, 不然自己还得处理依赖. 因此我们需要先安装 luarocks.</p>
<h2 id="1-__u5B89_u88C5luarocks"><a href="#1-__u5B89_u88C5luarocks" class="headerlink" title="1. 安装luarocks"></a>1. 安装luarocks</h2><p>如果已经安装过了的话,可以跳过这一步.</p>
<h3 id="1-1__u901A_u8FC7_homebrew__u5B89_u88C5"><a href="#1-1__u901A_u8FC7_homebrew__u5B89_u88C5" class="headerlink" title="1.1 通过 homebrew 安装"></a>1.1 通过 homebrew 安装</h3><p>通过 homwbrew 安装是最简单的,  只需要 <code>brew update</code> 和 <code>brew install luarocks</code> 两步就可以啦! 不过 brew update 等待的时间可能会比较久, 耐心不够的话可以尝试从源码安装.</p>
<h3 id="1-2__u901A_u8FC7_u6E90_u7801_u5B89_u88C5"><a href="#1-2__u901A_u8FC7_u6E90_u7801_u5B89_u88C5" class="headerlink" title="1.2 通过源码安装"></a>1.2 通过源码安装</h3><p>1). 从<a href="https://github.com/keplerproject/luarocks/wiki/Release-history" target="_blank" rel="external">这里</a>下载最新版的 luarocks 源文件, 解压.</p>
<p>2). 打开终端, cd 到刚才解压的目录.</p>
<p>3). 键入 <code>./configure</code></p>
<p>这一步的话比较诡异, 我在公司装的时候各种问题, 在家里装就没有问题. 比如出现了这个:</p>
<blockquote>
<p>Looking for Lua…<br>lua not found in $PATH.<br>You may want to use the flags –with-lua, –with-lua-bin and/or –lua-suffix. See –help.<br>configure failed.</p>
</blockquote>
<p>这是没有找到lua的原因, 确保你安装了lua, 可以通过<code>which lua</code>来找到lua的安装路径. 然后用<code>--with-lua-bin</code> 参数传给<code>configure</code>, 如:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">./configure --with-lua-bin=/usr/local</span><br></pre></td></tr></table></figure>
<blockquote>
<p>Could not find a downloader helper program. Tried: curl wget fetch.<br>Make sure one of them is installed and available in your PATH.<br>configure failed.</p>
</blockquote>
<p>其实我也不知道为什么会抽这个风, <code>curl</code> 和 <code>wget</code> 我都有安装的, 用 <code>--with-downloader</code> 指定一下就ok了, 如:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">./configure --with-lua=/usr/local --with-downloader=wget</span><br></pre></td></tr></table></figure>
<blockquote>
<p>Could not find a MD5 checksum calculator. Tried: md5sum openssl md5.<br>Make sure one of them is installed and available in your PATH.<br>configure failed.</p>
</blockquote>
<p>额, 还是指定一下 <code>--with-md5-checker</code> 吧!</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">./configure --with-lua=/usr/local --with-downloader=wget --with-md5-checker=md5</span><br></pre></td></tr></table></figure>
<p>4). 键入 <code>make build</code></p>
<p>5). 键入 <code>make install</code></p>
<p>如果一切正常的话, 那么就安装成功了. 可以通过键入 <code>luarocks</code> 来检测.</p>
<h2 id="2-__u5B89_u88C5_LDoc"><a href="#2-__u5B89_u88C5_LDoc" class="headerlink" title="2. 安装 LDoc"></a>2. 安装 LDoc</h2><p>安装好 luarocks 之后, 安装 LDoc 是非常简单的, 只需要:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">luarocks install ldoc</span><br></pre></td></tr></table></figure>
<p>就可以了, luarocks 会自动帮你安装依赖项. 安装好之后在终端键入 <code>ldoc -h</code>, 如果出现下面这个, 则代表安装成功!</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ldoc, a documentation generator for Lua, vs 1.4.3&#10;...</span><br></pre></td></tr></table></figure>
<h1 id="u4E8C-__u6982_u89C8"><a href="#u4E8C-__u6982_u89C8" class="headerlink" title="二. 概览"></a>二. 概览</h1><p>让我们先通过一个简单的测试来了解下 ldoc , 先创建一个目录, 在目录下创建一个 <code>test.lua</code> 文件, 将下面的内容复制到里面:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">--- a test module&#10;-- @module test&#10;&#10;local test = &#123;&#125;&#10;&#10;--- this is a function&#10;-- @string param1 this is param1&#10;-- @int param2 this is param2&#10;-- @return a string value&#10;function test.my_module_function_1(param1, param2)&#10;&#9;return param1 .. param2&#10;end&#10;&#10;return test</span><br></pre></td></tr></table></figure>
<p>然后在这个目录下打开终端, 键入 <code>ldoc test.lua</code>, 一切正常的话, 会在当前目录下生成一个名为 doc 文件夹, 打开 <code>doc/index.html</code> 文件, 会看到下面这样的东西.</p>
<p><img src="/img/2015-08-23-1.jpg" alt=""></p>
<p>虽然很丑陋, 但也还不错, 该有的都有. 我们仔细看一下这个测试, 总体由 test 模块 和 my_module_function_1 函数 2部分组成. 它们都是以 <code>---</code> 开始的, 这是 ldoc 的一个规则, 只有以 <code>---</code> 开始的注释才会被 ldoc 解析, 这样就可以排除掉普通的注释信息. <code>@module</code> 是一个特殊的标签, 后面跟着模块的名字, 但其实这个标签是可选的, 没有的话默认会以文件名来定义模块名.</p>
<p>类似的标签还有很多, 我们在下面会一一说明.</p>
<h1 id="u4E09-__u8BE6_u89E3"><a href="#u4E09-__u8BE6_u89E3" class="headerlink" title="三. 详解"></a>三. 详解</h1><h2 id="1-__u6807_u7B7E"><a href="#1-__u6807_u7B7E" class="headerlink" title="1. 标签"></a>1. 标签</h2><ul>
<li><strong>@module</strong> 模块, 一般一个文件就是一个模块.</li>
<li><strong>@classmod</strong> 和 @module 类似, 但是用来描述 class, 用这个标签后, 生成的文档中 Module 文字会变成 Class.</li>
<li><strong>@submodule</strong> 如果一个模块的内容被分到了好几个文件中, 那么就可以再其他文件中用 submodule 来定义, 后面跟上master module的名字.</li>
<li><strong>@script</strong> 和 @module 类似, 生成的文档中 Module 文字会变成 Script.</li>
</ul>
<blockquote>
<p>以上几个标签都是<code>project-level</code>, 意味着每个文件中只能包含它们其中的一个, 否则生成时就会提示 <code>Module already declared!</code> 错误.</p>
</blockquote>
<ul>
<li><p><strong>@author</strong> (multiple), @copyright, @license, @release 这几个啥意思就不必说了吧, 值得一提的是它们必须放在<code>project-level</code>,如 @module 标签下.</p>
</li>
<li><p><strong>@function</strong>, @lfunction. 用来描述函数. @function 一般情况下不用加, 只需要给函数加上<code>---</code>注释就可以. @lfunction 用来表示一个局部函数, 但是ldoc默认是不会导出局部变量和函数的.</p>
</li>
<li><strong>@param</strong> @int, @string, @bool, @func, @tab, @thread 用来描述函数参数, 后面几个指定了参数类型.</li>
<li><strong>@return</strong> 函数的返回值, 函数的返回值可能有多种, 因此 @return 在一个函数中也是可以多次使用的</li>
<li><strong>@raise</strong> 这个函数可能抛出的错误</li>
<li><strong>@local</strong> 最大的作用是使得一个函数不被导出, 除非使用了(unless –all)</li>
<li><strong>@see</strong> 引用文档的其他内容, 同一模块的话直接 <code>@see xxx</code>, 不同模块的话需要加上模块名 <code>@see xxmodule.xxfunc</code></li>
<li><strong>@usage</strong> 给出函数的用例, 可以分多行来写</li>
<li><strong>@fixme</strong>, @todo 和 @warning , 意思大家应该都懂. 但是必须在函数体内部并且以 <code>---</code> 开头才能生效.</li>
</ul>
<blockquote>
<p>以上几个标签都是描述function的一些行为的</p>
</blockquote>
<ul>
<li><strong>@table</strong> 描述一个table, 也可以不加, 只需要给table加上<code>---</code>注释就可以.</li>
<li><p><strong>@field</strong> 用来描述table中的一个字段</p>
</li>
<li><p><strong>@section</strong> 用来把一个模块分隔成好几块</p>
</li>
<li><strong>@type</strong> 和 @class 的作用差不多, 但不能与 @class 同时存在. 一个文件中可以有多处 @type , 会和 @section 似得吧文件分隔成好多份.</li>
<li><strong>@within</strong> 用来形容函数和table, 指定它们属于哪个section, 可以指定不存在的一个section, 会自动创建一个</li>
</ul>
<p>哈哈, 以上就是所有的标签啦, 虽然比较多, 但是有很多都不怎么常用, 所以还是很好理解的.</p>
<h2 id="2-__u5BF9_u4E8E_u51FD_u6570_u7684_u4E00_u4E9B_u9AD8_u7EA7_u7528_u6CD5"><a href="#2-__u5BF9_u4E8E_u51FD_u6570_u7684_u4E00_u4E9B_u9AD8_u7EA7_u7528_u6CD5" class="headerlink" title="2. 对于函数的一些高级用法"></a>2. 对于函数的一些高级用法</h2><h3 id="2-1__u663E_u793A_u53C2_u6570_u7684_u7C7B_u578B"><a href="#2-1__u663E_u793A_u53C2_u6570_u7684_u7C7B_u578B" class="headerlink" title="2.1 显示参数的类型"></a>2.1 显示参数的类型</h3><p>这个前面有提过, @param 是不指明具体类型的, 若想指明的话可以用 @int, @string, @bool, @func, @tab, @thread 几个标签来.</p>
<h3 id="2-2__u53EF_u9009_u53C2_u6570_u4E0E_u9ED8_u8BA4_u503C"><a href="#2-2__u53EF_u9009_u53C2_u6570_u4E0E_u9ED8_u8BA4_u503C" class="headerlink" title="2.2 可选参数与默认值"></a>2.2 可选参数与默认值</h3><p>可选参数的标记是自参数标签后紧跟 <code>[opt]</code> 来标识, 默认值则是 <code>[opt=xx]</code>. 让我们看一个官方的示例:</p>
<figure class="highlight lua"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">--- a function with typed args.</span></span><br><span class="line"><span class="comment">-- @string name person's name</span></span><br><span class="line"><span class="comment">-- @int age</span></span><br><span class="line"><span class="comment">-- @string[opt='gregorian'] calender optional calendar</span></span><br><span class="line"><span class="comment">-- @int[opt=0] offset optional offset</span></span><br><span class="line"><span class="comment">-- @treturn string</span></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">one</span> <span class="params">(name,age,...)</span></span></span><br><span class="line"><span class="keyword">end</span></span><br><span class="line"><span class="comment">----&gt; displayed as: one (name, age [, calender='gregorian' [, offset=0]])</span></span><br></pre></td></tr></table></figure>
<h3 id="2-3__u591A_u79CD_u8FD4_u56DE_u503C"><a href="#2-3__u591A_u79CD_u8FD4_u56DE_u503C" class="headerlink" title="2.3 多种返回值"></a>2.3 多种返回值</h3><p>一个函数不同的情况可能返回不同的值, 意义也都不一样, 那么怎么来表示呢? 答案是在 @return 后紧跟 <code>[x]</code> (x可以是1,2,3,…) 来标识. 生成出来的文档是用 <code>Or</code> 来列出这些不同的返回值的.</p>
<h2 id="3-_config-ld__u7684_u5B57_u6BB5_u8BF4_u660E"><a href="#3-_config-ld__u7684_u5B57_u6BB5_u8BF4_u660E" class="headerlink" title="3. config.ld 的字段说明"></a>3. config.ld 的字段说明</h2><p>ldoc 运行时有一堆参数可以传递, 在终端中去做比较麻烦, 修改也不太方便. 因此我们可以创建一个 <code>config.ld</code> 配置文件来做这个事情, <code>ldoc .</code> 表示在当前目前下查找 config.ld 文件, <code>ldoc -c path/to/myconfig.ld &lt;file&gt;</code> 读取特殊的目录的配置文件. 其实 <code>config.ld</code> 就是一个lua文件, 填写时需要遵循lua语法.</p>
<p>config.ld 文件中有一大坨的条目可以选择, 我们来看一下他们都是什么意思吧.</p>
<ul>
<li><strong>file</strong> 可以是一个文件名或者目录名, 如: <code>file = &#39;test.lua&#39;</code>. file 也可以是一个table, 这时里面可以填写文件数组或目录数组, 同时也可以包含另一个特殊的数组 <code>exclude</code>, 表明要排除的文件或目录</li>
<li><strong>project</strong> 项目的名称, 会出现在文档的左上角. 默认为 <code>ldoc</code></li>
<li><strong>title</strong> 页面的名称, 默认为 <code>Reference</code></li>
<li><strong>all</strong> 导出 <code>local</code> 的 function</li>
<li><strong>output</strong> 导出 html 的名字, 默认是 <code>index</code></li>
<li><strong>dir</strong> 导出目录的名字, 默认是 <code>doc</code></li>
<li><strong>colon</strong> 使用冒号风格代替 @ 风格的 tag</li>
<li><strong>boilerplate</strong> 忽略所有源文件中的首个注释(块), 比如: license 注释.</li>
<li><strong>ext</strong> 输出文件的后缀(默认为 <code>html</code>)</li>
<li><strong>one</strong> 文档使用单列的布局</li>
<li><strong>style, template</strong> 指定模板和样式的目录. 在 config.ld 中它也可以为 <code>true</code> , 表示使用和配置文件同一目录的模板.</li>
<li><strong>merge</strong> 允许文档从不同的文件合并同名的 module , 而不是产生多个module.</li>
</ul>
<p>其它可选的参数还有很多, 但是都不常用. 大家可以<a href="http://stevedonovan.github.io/ldoc/manual/doc.md.html#Fields_allowed_in__config_ld_" target="_blank" rel="external">点击这里</a>跳转到官方文档继续查看.</p>
<hr>
<p>这篇文章到这里就差不多, ldoc 网上的中文资料不是很多, 加上我使用时遇到了一些问题, 因此我写下这篇文章, 主要是帮大家对 ldoc 形成一个大体的印象, 具体细节或者高级功能可能还是得去看官方的文档.</p>
<p>当然有什么问题也欢迎大家评论指出, 多多交流!</p>
<h2 id="u9644_u5F55_3A"><a href="#u9644_u5F55_3A" class="headerlink" title="附录:"></a>附录:</h2><p>官方文档: <a href="http://stevedonovan.github.io/ldoc/" target="_blank" rel="external">这里</a><br>github地址: <a href="https://github.com/stevedonovan/LDoc" target="_blank" rel="external">这里</a></p>
]]></content>
    </entry>
    
    <entry>
      <title><![CDATA[更新 spine 的 cocos2d-x runtimes]]></title>
      <url>http://blog.justbilt.com/2015/08/16/upgrad-spine-runtime/</url>
      <content type="html"><![CDATA[<p>又是2个多月没有更新博客了, 真是不应该, 惭愧啊！其实手上已经攒了一些素材了, 只是一直没有一个很强的动力去写出来, 今天总算是有一些想法了, 先用一篇没有什么养分的文章来 “探探路”,  唤醒下自己写作的欲望吧！</p>
<a id="more"></a>
<h1 id="1-_why__3F"><a href="#1-_why__3F" class="headerlink" title="1. why ?"></a>1. why ?</h1><p>最近的项目中用到 spine, 但是美术在spine中做的效果却与程序中得效果有些出入。比如在spine中设置翻转, 在程序中却是没有的。看了下导出的json文件, 里面是有 <code>flipX</code> 字段的, 于是猜想是没有解析的原因.</p>
<p>在spine的解析代码中搜索了一下, 果然是没有找到解析<code>flip</code>字段的代码的, 看来是需要更新下解析的代码了! spine 的解析库是放在 github 上的, 地址在这里 <a href="https://github.com/EsotericSoftware/spine-runtimes" target="_blank" rel="external">https://github.com/EsotericSoftware/spine-runtimes</a>.</p>
<h1 id="2-_How__3F"><a href="#2-_How__3F" class="headerlink" title="2. How ?"></a>2. How ?</h1><ol>
<li>首先我们 clone <code>spine-runtimes</code> 到本地的一个目录.</li>
<li>复制 <code>spine-runtimes/spine-c/include/spine/</code> 目录下所有文件到 <code>cocos2d-x/cocos/editor-support/spine/</code></li>
<li>复制 <code>spine-runtimes/spine-c/src/spine/</code> 目录下所有文件到 <code>cocos2d-x/cocos/editor-support/spine/</code></li>
<li>复制 <code>spine-runtimes/spine-cocos2dx/3/src/spine/</code> 目录下所有文件到 <code>cocos2d-x/cocos/editor-support/spine/</code></li>
<li>编译, 运行, 然后就没有然后了!</li>
</ol>
<hr>
<p>好吧, 这个升级远我想象的简单好多, 没有编译错误, 没有运行崩溃, 还真是令人有些不习惯, 只能说 spine 他们还是蛮认真的!</p>
]]></content>
    </entry>
    
    <entry>
      <title><![CDATA[cocos2d-x AssetsManager 问题汇总]]></title>
      <url>http://blog.justbilt.com/2015/06/06/cocos-assetsmanager/</url>
      <content type="html"><![CDATA[<p>大家做热更新的时候都会用到 AssetsManager , 我们使用的 2.2.6 版本还存在一些问题, 在这里记录一下, 希望大家能够避开这些!</p>
<a id="more"></a>
<h1 id="1-__u201Ccan_not_open_destination_file_xxx_u201D"><a href="#1-__u201Ccan_not_open_destination_file_xxx_u201D" class="headerlink" title="1. “can not open destination file xxx”"></a>1. “can not open destination file xxx”</h1><p>AssetsManager 在解压时有一定概率会出现这个错误, 让我们先定位错误发生点:</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">FILE *out = fopen(fullPath.c_str(), <span class="string">"wb"</span>);</span><br><span class="line"><span class="keyword">if</span> (! out)</span><br><span class="line">&#123;</span><br><span class="line">    CCLOG(<span class="string">"can not open destination file %s"</span>, fullPath.c_str());</span><br><span class="line">    unzCloseCurrentFile(zipfile);</span><br><span class="line">    unzClose(zipfile);</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>嗯, 其实就是打开一个文件去写的时候发生了错误, 这个 <code>fullPath</code> 就是解压的目标路径, 但是这个目标路径的文件夹是有可能不存在的, 比如 <code>download/res/ui/test.png</code>, 如果 <code>`download/res/ui</code> 目录不存在, 就会解压失败.</p>
<p>这个问题也有别人遇到了, 还有具体的原因分析, 大家可以看这里: <a href="http://bbs.firedragonpzy.com.cn/forum.php?mod=viewthread&amp;tid=119" target="_blank" rel="external">AssetsManager在下载某些特定内容的zip文件后解压缩会失败</a>.</p>
<p>解决方案也比较简单, 已经在 3.x 有实现了, 就是在解压文件前, <strong>遍历创建下每个层级的目录</strong> 就可以了, 代码如下:</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//There are not directory entry in some case.</span></span><br><span class="line"><span class="comment">//So we need to test whether the file directory exists when uncompressing file entry</span></span><br><span class="line"><span class="comment">//, if does not exist then create directory</span></span><br><span class="line"><span class="function"><span class="keyword">const</span> <span class="built_in">string</span> <span class="title">fileNameStr</span><span class="params">(fileName)</span></span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">size_t</span> startIndex=<span class="number">0</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">size_t</span> index=fileNameStr.find(<span class="string">"/"</span>,startIndex);</span><br><span class="line"></span><br><span class="line"><span class="keyword">while</span>(index != <span class="built_in">std</span>::<span class="built_in">string</span>::npos)</span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">const</span> <span class="built_in">string</span> dir=_storagePath+fileNameStr.substr(<span class="number">0</span>,index);</span><br><span class="line">    FILE *out = fopen(dir.c_str(), <span class="string">"r"</span>);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span>(!out)&#123;</span><br><span class="line">        <span class="keyword">if</span> (!createDirectory(dir.c_str()))&#123;</span><br><span class="line">            CCLOG(<span class="string">"can not create directory %s"</span>, dir.c_str());</span><br><span class="line">            unzClose(zipfile);</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">else</span>&#123;</span><br><span class="line">            CCLOG(<span class="string">"create directory %s"</span>,dir.c_str());</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">else</span>&#123;</span><br><span class="line">        fclose(out);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    startIndex=index+<span class="number">1</span>;</span><br><span class="line">    index=fileNameStr.find(<span class="string">"/"</span>,startIndex);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h1 id="2-__u4E0B_u8F7D_u8FDB_u5EA6_u95EE_u9898"><a href="#2-__u4E0B_u8F7D_u8FDB_u5EA6_u95EE_u9898" class="headerlink" title="2. 下载进度问题"></a>2. 下载进度问题</h1><p>AssetsManager 的下载进度会在控制台上打印出来, 但是这个进度却与我们注册监听的进度不太一致, 经常都下载完成了, 进度却只走了 10% 左右, 而解压确实是没有占用进度的, 令人十分困惑.</p>
<p>经过仔细阅读源码和分析, 发现了问题所在, AssetsManager 实际上是多线程的, 使用消息队列在线程间通信. 下载线程有消息了, 会压入队列中, 主线程注册了update, 不断的从队列中拿取消息, 处理, 删除. 这套设定其实还是蛮不错的, 但是却<strong>没有考虑到主线程的处理能力不足</strong>的情况. 下面是下载进度的逻辑:</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">assetsManagerProgressFunc</span><span class="params">(<span class="keyword">void</span> *ptr, <span class="keyword">double</span> totalToDownload, <span class="keyword">double</span> nowDownloaded, <span class="keyword">double</span> totalToUpLoad, <span class="keyword">double</span> nowUpLoaded)</span></span><br><span class="line"></span>&#123;</span><br><span class="line">    AssetsManager* manager = (AssetsManager*)ptr;</span><br><span class="line">    AssetsManager::Message *msg = <span class="keyword">new</span> AssetsManager::Message();</span><br><span class="line">    msg-&gt;what = ASSETSMANAGER_MESSAGE_PROGRESS;</span><br><span class="line">    </span><br><span class="line">    ProgressMessage *progressData = <span class="keyword">new</span> ProgressMessage();</span><br><span class="line">    progressData-&gt;percent = (<span class="keyword">int</span>)(nowDownloaded/totalToDownload*<span class="number">100</span>);</span><br><span class="line">    progressData-&gt;manager = manager;</span><br><span class="line">    msg-&gt;obj = progressData;</span><br><span class="line">    </span><br><span class="line">    manager-&gt;_schedule-&gt;sendMessage(msg);</span><br><span class="line">    </span><br><span class="line">    CCLOG(<span class="string">"downloading... %d%%"</span>, (<span class="keyword">int</span>)(nowDownloaded/totalToDownload*<span class="number">100</span>));</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>举个例子, 下载线程每秒压入5个消息, 但是主线程的update回调是1秒一次, 得等5s才能处理完成. 这样就会导致下载早已完成, 但主线程却还有一大坨的消息没有处理完成, 仍旧在不紧不慢的处理着. 解决问题的方法也比较简单, 可以从两个角度入手, 提升主线程的处理能力和减少下载线程的消息制造. 由于主线程已经是注册的帧事件 update 了, 没有提升的空间, 所以只能从第二个角度入手了.</p>
<p>分析了下需求, 对于下载进度的索取, 其实没有必要过于精确, 精确到1%就可以了. 这样的话一共只会产生100个事件, 大大减少了事件的数量. 这个问题, 3.x 也做了处理, 和我的想法一致. 摘录实现如下:</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">assetsManagerProgressFunc</span><span class="params">(<span class="keyword">void</span> *ptr, <span class="keyword">double</span> totalToDownload, <span class="keyword">double</span> nowDownloaded, <span class="keyword">double</span> totalToUpLoad, <span class="keyword">double</span> nowUpLoaded)</span></span><br><span class="line"></span>&#123;</span><br><span class="line">    <span class="keyword">static</span> <span class="keyword">int</span> percent = <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">int</span> tmp = (<span class="keyword">int</span>)(nowDownloaded / totalToDownload * <span class="number">100</span>);</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">if</span> (percent != tmp)</span><br><span class="line">    &#123;</span><br><span class="line">        percent = tmp;</span><br><span class="line">        Director::getInstance()-&gt;getScheduler()-&gt;performFunctionInCocosThread([=]&#123;</span><br><span class="line">            <span class="keyword">auto</span> manager = <span class="keyword">static_cast</span>&lt;AssetsManager*&gt;(ptr);</span><br><span class="line">            <span class="keyword">if</span> (manager-&gt;_delegate)</span><br><span class="line">                manager-&gt;_delegate-&gt;onProgress(percent);</span><br><span class="line">        &#125;);</span><br><span class="line">        </span><br><span class="line">        CCLOG(<span class="string">"downloading... %d%%"</span>, percent);</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>在查看源码的时候, 也发现了一些非常有意思的事情. AssetsManager 有做一个这样的设定, 下载全部完成后, 会将 <code>downloaded-version-code</code> 字段写入到 <code>UserDefault</code> 中, 解压完成后删除这个字段, 为什么呢? </p>
<p>为了应对解压过程中出现了一些意外, 比如关闭了游戏进程, 这样重启游戏的时候就不用再下载更新包了. 这本是一个不错的设定, 但是它使用了事件队列来做这个事情, 上面说过, 下载完成后, 其实积压了一大坨的事件, 所以这个事件根本不会立刻被执行到. 但是解压的操作却不会受次影响, 会立刻执行到. 这会导致什么问题呢? <strong>导致先删除<code>downloaded-version-code</code>字段, 后设置, 与预期的执行顺序完全想反</strong>. 虽然最后可能不会影响到什么, 但是却是一段非常危险的代码.</p>
<hr>
<h2 id="Update_3A_2015_u5E7406_u670825_u65E5"><a href="#Update_3A_2015_u5E7406_u670825_u65E5" class="headerlink" title="Update: 2015年06月25日"></a>Update: 2015年06月25日</h2><p>还是接着上面的那个问题, AssetsManager 将 <code>downloaded-version-code</code> 记录到了 <code>UserDefault</code> 中, 但是只有<strong>解压成功</strong>了才会删除, 那么解压失败了呢? 解压失败失败的原因有好多, 如果是下载的更新包有问题的话, 重启后仍然不会重新下载, 直接开始解压, 就会陷入到一个循环中, 一直出错. 解决的办法是什么呢? </p>
<blockquote>
<p>舍弃掉这个优化.</p>
</blockquote>
<p>将 AssetsManager 中的这几行注释掉, 就不会记录 <code>downloaded-version-code</code>, 出错后重启就会重新下载:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">CCUserDefault::sharedUserDefault()-&#62;setStringForKey(KEY_OF_DOWNLOADED_VERSION,&#10;                                                    ((AssetsManager*)msg-&#62;obj)-&#62;_version.c_str());&#10;CCUserDefault::sharedUserDefault()-&#62;flush();</span><br></pre></td></tr></table></figure>
<p>我们的游戏就遇到了这样的情况, 玩家热更解压失败后就一直处于解压失败的状态, 只能删除游戏重新安装了!</p>
<p>哈哈,正如你所想的,3.x 也做了这样的处理:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">if (! uncompress())&#10;&#123;&#10;    Director::getInstance()-&#62;getScheduler()-&#62;performFunctionInCocosThread([&#38;, this]&#123;&#10;        UserDefault::getInstance()-&#62;setStringForKey(this-&#62;keyOfDownloadedVersion().c_str(),&#34;&#34;);&#10;        UserDefault::getInstance()-&#62;flush();&#10;        if (this-&#62;_delegate)&#10;            this-&#62;_delegate-&#62;onError(ErrorCode::UNCOMPRESS);&#10;    &#125;);&#10;    break;&#10;&#125;</span><br></pre></td></tr></table></figure>
<p>解压失败后就直接清除了 <code>downloaded-version-code</code> 的记录.</p>
<hr>
<p>从上述可以看到, 这些问题都已在 3.x 中解决, 所以能升级引擎的还是赶紧升级. 同时也会明白cocos的坑还是蛮多的, 大家一定要做好测试呀!</p>
<p>–EOF–</p>
]]></content>
    </entry>
    
    <entry>
      <title><![CDATA[从 C++ 到 lua 的2014]]></title>
      <url>http://blog.justbilt.com/2015/05/31/my-2014/</url>
      <content type="html"><![CDATA[<p>2014的年结又晚了好多, 若是用一句话去总结这一年的变化的话, 那就是:</p>
<blockquote>
<p>从 C++ 到 lua</p>
</blockquote>
<p>大约是元旦的时候, 到了公司 C , 放弃了使用2年多的c++, 搞起了lua, 学习了 quick-cocos2d-x. 这一年工作,生活发生了好多变化, 自己的心态也变化了好多.</p>
<a id="more"></a>
<h1 id="u5DE5_u4F5C"><a href="#u5DE5_u4F5C" class="headerlink" title="工作"></a>工作</h1><h6 id="u5165_u804C_C"><a href="#u5165_u804C_C" class="headerlink" title="入职 C"></a>入职 C</h6><p>入职 C 似乎是早已注定的事情, 与 C 的老大<a href="http://weibo.com/yanbin001" target="_blank" rel="external">@Bin</a>在微博上相识已久, 一直未曾谋面, 后来公司缺人, 便推荐了好友<a href="http://weibo.com/imbahom" target="_blank" rel="external">@imbahom</a>过去, 后来听说我打算从 B 离职之后, 便多次邀请我过去共谋大业. 与其说是公司, C 其实更算是一个创业团队, 十来个人, 一套商住两用房, 扁平化管理. 其实 C 还是一个蛮有逼格的公司啦, 技术人员都配有 MBA或 MBP, 现磨咖啡机, Airport, 还有堆叠在一起的登山露营设备, 似乎都预示这是一个不一样的团队, 不像 B 一样是一个血汗工厂.</p>
<p>然而 C 所做的事情说起来可能有些low, 山寨与换皮. 我表示理解, 这是一个笑贫不笑娼的时代, 活下来可能才是最重要的事情. 公司除了一个主要的策略类游戏外, 还同时开着四五个山寨换皮游戏, 我过去也是负责一款, 同时顺带学习 lua 和 quick. 刚开始学习的时候总是十分痛苦的, 加上当时quick的文档不够健全, 好多东西只能自己摸索. 这个时候Bin给了我好多帮助, 他的思维跳跃极大, 总是能够想到一些奇怪的解决方案, 让人脑洞大开, 也使得苦闷的debug变得愉悦起来, 从他身上学到了好多.</p>
<p>小团队的好处有很多, 每天中午吃饭就是其一, 大家刚好能坐满一个桌, 每人点一个菜, 吃的不亦乐乎, 饭桌也是大家吐槽和释放压力的一个好地方! 然而快乐的日子总是短暂的, 主营的项目似乎不怎么赚钱, 换皮项目也都收不回成本, 公司的氛围变得十分的微妙! Bin经常将自己锁在会议室抽烟, 思考公司的未来, 与合伙人似乎也有些不合, 项目一个个的砍掉, 同事一个个的离职. 我也变得不安起来, 会不会next就是我? 要不要早谋出路? 好友 @imbahom 忍受不了, 先我一步离开公司, 这对我也是一个打击.</p>
<p>终于, 我于14年7月底从 C 离职, 在这里我感受到了小团队的灵活,高效,也明白的小团对的不稳定性, 一个项目的失败可能就会导致大家散伙.</p>
<h6 id="u5165_u804C_D"><a href="#u5165_u804C_D" class="headerlink" title="入职 D"></a>入职 D</h6><p>在之前的一位老师的带领下, 我和好友@imbahom加入了 D, 与 C 相比, D 的规模能略大一些, 更加正规一些, 至少是个公司了! 我们到来是为了接手一个半成品的项目, 之前的客户端团队集体离职, 但项目又急着上线, 便想找一个现成团队, 快速接手项目! 经过评估, 我们决定重写整个项目, 这也为后来无休止的加班埋下了伏笔. </p>
<p>其实 D 更像是一个传统的公司, 虽然好多规矩,流程上更正规一些, 但却失去了小团队的高效,灵活. 而且公司在一些硬件设备上比较抠, 着实让人有些想不明白, 好多几百大洋就能大幅提升工作效率的东西不愿意去做.</p>
<p>不过在这个项目中学到了好多东西, 对于lua的理解, 对于cs结构的理解, 对于quick的理解都增加了好多, 对于我的成长帮助特别大!</p>
<p>D 的老板也算是一个比较nice的人, 虽然有时候比较爱吹牛, 但是为人比较仗义, 人脉也广, 如果能有一个靠谱的研发团队的话, 一定能做成事的!</p>
<hr>
<p>好吧, 工作的事情就讲到这里, 后来也发生了好多事情, 但这都是15年的了, 等明年年结的时候再说吧, 这次一定会 on time!</p>
<h1 id="u6280_u672F/_u5B66_u4E60"><a href="#u6280_u672F/_u5B66_u4E60" class="headerlink" title="技术/学习"></a>技术/学习</h1><p>这一年技术的成长并不是很大, 更多的在理解/理念/效率上的变化了! </p>
<ol>
<li>学习了新的语言 lua, 非常简洁高效的一门语言, 读了云风的<a href="http://www.codingnow.com/temp/readinglua.pdf" target="_blank" rel="external">Lua 源码欣赏</a>, 了解到了很多语言底层的东西, 有机会一定要阅读下 lua 的源码.</li>
<li>学习了<a href="https://github.com/chukong/quick-cocos2d-x" target="_blank" rel="external">quick-cocos2d-x</a>, 一个非常棒的 cocos2d-x lua 框架, 集成了一堆有用的 feature, 确实能如宣传所言, 大幅提升开发效率. 只是后来被 cocos2d-x 团队收购后, 发展变得缓慢起来了, 方向我也搞不清楚是什么了, 感觉廖大应该解释一下.</li>
<li>终于参与了期待已久网络游戏的制作, 与单机相比, 更大的区别在于异步, 单机想要获取什么数据直接配置里读取, 而网游则需要去请求, 也不会立刻返回. 但是对于客户端数据的安全性要求就没有单机大了, 因为数据都是以服务端为准的.</li>
<li>终于在 MacOS 下开发了, 相比 Windows, Mac 在核心开发之外需要操心的东西真的很少, 统一的快捷键, brew , 不需要担心流氓软件等, 绝对大幅提升开发效率.</li>
<li>用一周业余时间开发了一款自己挺喜欢的小游戏<a href="http://www.wandoujia.com/apps/com.justbilt.colorclean" target="_blank" rel="external">开心消方块</a>, 在各大 android 渠道都上了, 虽然下载量不咋地, 但是自己还是蛮开心的, 同时对于各大渠道的流程也都搞清楚了.</li>
<li>订阅全面转向了<a href="http://www.inoreader.com/" target="_blank" rel="external">inoreader</a>, 学习的重心都放到了这里, 获益匪浅!</li>
<li>编辑器使用了<a href="http://www.sublimetext.com/" target="_blank" rel="external">Sublime Text</a>, 又是一个提示开发效率的利器!</li>
<li>购买了<a href="https://getqujing.com" target="_blank" rel="external">曲径</a>的冬月服务, ¥130.00 元/季, 一顿吃饭的钱, 用在这个上边, 绝对是最值的了!</li>
</ol>
<h1 id="u73A9_u5177"><a href="#u73A9_u5177" class="headerlink" title="玩具"></a>玩具</h1><blockquote>
<p>人体工学鼠标</p>
</blockquote>
<p><img src="/img/QQ20150602-3.jpg" alt=""></p>
<p>号称可以预防鼠标手, 键位比较奇怪, 10分钟可以上手, 感觉还不错, 不过半年不到滚轮已经不太好使了!</p>
<blockquote>
<p>小米手环</p>
</blockquote>
<p><img src="/img/QQ20150602-4.jpg" alt=""></p>
<p>戴着还算可以, 至少不丑, 60天超长待机巨爽!</p>
<blockquote>
<p>显示器支架</p>
</blockquote>
<p><img src="/img/QQ20150602-5.jpg" alt=""></p>
<p>还算有用, 不过安装调节都不是很方便, 不建议购买这款!</p>
<h1 id="u751F_u6D3B"><a href="#u751F_u6D3B" class="headerlink" title="生活"></a>生活</h1><p>14 年我觉得过得还是蛮快乐的一年, 4月份的时候搬到了离父母很近的地方, 有一段时间父母每天都做好饭我们回去吃, 中午还能带一顿, 感觉很棒! 虽然嘴上不说, 但是离父母近了, 心里确实能够踏实好多, 还组织过一次家庭奥森野营活动, 大家在一起特别开心, 工作这几年一直很少陪父母出去玩!</p>
<p>对于女友, 还是有一些亏欠的, 因为加班, 能陪她的时间变的很少, 她因此也有一些抱怨, 不过更多是对我身体上的担心. 虽然她的脾气比较大, 但是为人十分稳重谨慎, 心地善良, 这也是我特别喜欢她的一点.</p>
<p>这一年出去玩过三次, 京郊龙庆峡, 大同, 天津, 其实我比较宅的人, 不太愿意出去玩, 不过世界那么大, 走走也是对的.</p>
<hr>
<p>2014 年整体也还算是比较平静吧, 自己也在稳定中成长, 加油, 希望 2015 年能有更多的东西可以写.</p>
<p>–EOF–</p>
]]></content>
    </entry>
    
    <entry>
      <title><![CDATA[MyGUI学习笔记(一) 在Windows上运行MyGUI]]></title>
      <url>http://blog.justbilt.com/2015/05/29/mygui-1-run-on-windows/</url>
      <content type="html"><![CDATA[<p>最近突然对 MyGUI 燃起了一些兴趣, 打算学习一番. 第一步肯定是跑起来 Demo 吧, 我主力系统是 MacOS , 首先肯定是考虑在 Mac 上搞起. 虽然 MyGUI 号称是 Corss Platform 的, 然而脱离了 Ogre 之后的 MyGUI 就只能跑在 windows 上了. 额, 在 Mac 上的趟坑之旅我们暂且不提, 让我们来曲线救国吧 – 在Windows上运行MyGUI.</p>
<a id="more"></a>
<hr>
<h1 id="u96F6-__u51C6_u5907_u5DE5_u4F5C"><a href="#u96F6-__u51C6_u5907_u5DE5_u4F5C" class="headerlink" title="零. 准备工作"></a>零. 准备工作</h1><p>在正式开搞前, 我们需要准备几样东西, 这几样东西可能在墙外, 大家自备梯子.</p>
<ol>
<li>从 MyGUI 的 <a href="https://github.com/MyGUI/mygui/releases" target="_blank" rel="external">github</a> 上下载最新代码, 解压到一个目录备用.</li>
<li>从 CMake 的官网下载 <a href="http://www.cmake.org/" target="_blank" rel="external">CMake</a> 的最新安装包, 安装之.</li>
<li>从 bitbucket 上下载 <a href="https://bitbucket.org/cabalistic/ogredeps" target="_blank" rel="external">ogredeps</a>.</li>
</ol>
<h1 id="u4E00-__u7F16_u8BD1_ogredeps"><a href="#u4E00-__u7F16_u8BD1_ogredeps" class="headerlink" title="一. 编译 ogredeps"></a>一. 编译 ogredeps</h1><p>因为 MyGUI 一开始就是为 Ogre 设计的, 所以会用到 Ogre 的一些依赖库, 我们这一步就需要编译这些依赖库.</p>
<h2 id="1-__u8FD0_u884CCMake"><a href="#1-__u8FD0_u884CCMake" class="headerlink" title="1. 运行CMake"></a>1. 运行CMake</h2><p>在上方输入框中选择 ogredeps 的源码路径, 下面选择 build 路径. 如下图:</p>
<p><img src="/img/QQ20150530-1.jpg" alt=""></p>
<p>build 路径可以随意设置, 一般会选择和source目录一致.</p>
<h2 id="2-__u751F_u6210_IDE__u5DE5_u7A0B"><a href="#2-__u751F_u6210_IDE__u5DE5_u7A0B" class="headerlink" title="2. 生成 IDE 工程"></a>2. 生成 IDE 工程</h2><p>点击<code>Configure</code>按钮, 在弹出的框中选择自己的 VS 版本, 然后点击<code>finish</code>按钮.</p>
<p><img src="/img/QQ20150530-2.jpg" alt=""></p>
<p>这一步一般不会出什么问题, 成功后会刷新出一坨红色的东西, 不要担心, 那不是错误. 点击<code>Generate</code>按钮, 生成VS的工程文件.</p>
<h2 id="3-__u7F16_u8BD1_u5E76_u62F7_u8D1D_u751F_u6210_u6587_u4EF6"><a href="#3-__u7F16_u8BD1_u5E76_u62F7_u8D1D_u751F_u6210_u6587_u4EF6" class="headerlink" title="3. 编译并拷贝生成文件"></a>3. 编译并拷贝生成文件</h2><p>去 ogredeps 的根目录, 运行生成的<code>OGREDEPS.sln</code>文件打开VS, 在<code>Solution Explorer</code>窗口中找到<code>INSTALL</code>工程,右键<code>Build</code>:</p>
<p><img src="/img/QQ20150530-3.jpg" alt=""></p>
<p>等待编译成功后, 去 ogredeps 根目录下找到刚生成的 <code>ogredeps</code> 文件夹, 里面包含有头文件和库文件, 把它拷贝到 MyGUI 的根目录下, 并重命名为 <code>Dependencies</code>.</p>
<p>好了, 这一步就算完成了.</p>
<h1 id="u4E8C-__u7F16_u8BD1_MyGUI"><a href="#u4E8C-__u7F16_u8BD1_MyGUI" class="headerlink" title="二. 编译 MyGUI"></a>二. 编译 MyGUI</h1><h2 id="1-__u751F_u6210_VS__u5DE5_u7A0B"><a href="#1-__u751F_u6210_VS__u5DE5_u7A0B" class="headerlink" title="1. 生成 VS 工程"></a>1. 生成 VS 工程</h2><p>第一步还是运行 CMake, 不过这次要先<code>Delete Cach</code> 下, 可以在<code>File</code>菜单下找到它:</p>
<p><img src="/img/QQ20150530-4.jpg" alt=""></p>
<p>然后选择 source 路径 和 build 路径, 完成之后, 点击<code>Configure</code>按钮, 在弹出的框中选择自己的 VS 版本, 然后点击<code>finish</code>按钮.</p>
<p>一番等待之后, 弹出了错误提示! 这次是确实有错误了:</p>
<p><img src="/img/QQ20150530-5.jpg" alt=""></p>
<p>从红框部分,可以看到错误细节:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">+ ogre: Support for the Ogre render system &#60;&#62;</span><br></pre></td></tr></table></figure>
<p>MyGUI 的设计理念确实是按照 Cross Platform 设计来搞的, 所以他的 render system 是有多套实现的, 默认是用 Ogre 的渲染. 往上看一下就能找到解决方案:</p>
<blockquote>
<p>– Also check that you buildind with RenderSystem that you need or set<br>  another with -DMYGUI_RENDERSYSTEM=<1 2="" 3="" or="" for="" direct3d_9="" ogre="" opengl=""></1></p>
</blockquote>
<p>好的, 那我们找到 <code>MYGUI_RENDERSYSTEM</code> 这个宏, 给他改成 <code>3 &lt;OpenGL&gt;</code> 就可以了! 在 CMake 界面的一坨红色的东东中找到 <code>MYGUI_RENDERSYSTEM</code>, 如下图:</p>
<p><img src="/img/QQ20150530-6.jpg" alt=""></p>
<p>鼠标悬停的话会有详细介绍.</p>
<p>再次点击<code>Configure</code>按钮, 这次就不会有错误了! 完成后点击<code>Generate</code>按钮, 生成VS的工程文件.</p>
<h2 id="2-__u7F16_u8BD1_MyGUI"><a href="#2-__u7F16_u8BD1_MyGUI" class="headerlink" title="2. 编译 MyGUI"></a>2. 编译 MyGUI</h2><p>在 MyGUI 的根目录下找到 <code>MYGUI.sln</code> ,运行它! 还是在<code>Solution Explorer</code>窗口中找到<code>INSTALL</code>工程,右键<code>Build</code>. 这次编译会略微久一些, 不过正常情况下是不会有意外滴!</p>
<p><img src="/img/QQ20150530-7.jpg" alt=""></p>
<p>编译完成后, 会在 <code>bin/debug</code> 目录下看到所有的 Demo 的运行文件, 可以挨个运行看一下都是什么.</p>
<h2 id="3-__u8C03_u8BD5_u9879_u76EE"><a href="#3-__u8C03_u8BD5_u9879_u76EE" class="headerlink" title="3. 调试项目"></a>3. 调试项目</h2><p>如果我们想调试某个 Demo, 需要在这个Demo的工程文件上右键设为启动项<code>Set as StartUp Project</code>, 然后 <code>F5</code> 启动调试, 不过在运行时会因为找不到资源崩溃掉. 估计原因是工作目录不正确的, 我们需要修改下, 项目右键<code>Properties</code>:</p>
<p><img src="/img/QQ20150530-8.jpg" alt=""></p>
<p>将<code>$(ProjectDir)</code>改为<code>$(OutDir)</code>, 确定, 再次启动调试, 成功!</p>
<hr>
<p>至此为止, windows 上的运行调试已无问题, 可以开始学习了!</p>
<p>–EOF–</p>
]]></content>
    </entry>
    
    <entry>
      <title><![CDATA[为 quick-cocos2d-x 添加析构事件]]></title>
      <url>http://blog.justbilt.com/2015/05/17/onDestroy/</url>
      <content type="html"><![CDATA[<h1 id="u4E00-__u4E3A_u4EC0_u4E48_u4F1A_u9700_u8981_u6790_u6784_u4E8B_u4EF6__3F"><a href="#u4E00-__u4E3A_u4EC0_u4E48_u4F1A_u9700_u8981_u6790_u6784_u4E8B_u4EF6__3F" class="headerlink" title="一. 为什么会需要析构事件 ?"></a>一. 为什么会需要析构事件 ?</h1><p>quick 的 class 实现提供了类似c++构造函数的<code>ctor</code> , <strong>却没有提供类似 c++ 的析构函数</strong>. 我们确实需要这样的一个回调,去写一些retain对象的release调用, 移除监听的事件等. 那么该怎么做呢?</p>
<a id="more"></a>
<h2 id="1-_onEnter__u4E0E_onExit"><a href="#1-_onEnter__u4E0E_onExit" class="headerlink" title="1. onEnter 与 onExit"></a>1. onEnter 与 onExit</h2><p>onEnter 与 onExit 确实是一个蛮不错的选择, 总是成对出现. 但是, 确实存在这样的问题:</p>
<blockquote>
<p>问题1: 可能会被调用多次</p>
</blockquote>
<p>确实如此, 当你以 pushScene 的形式加入一个新的场景, 原先场景的所有节点都会被调用 onExit, popScene 时又会调用 onEnter ; 或者我们想暂停一个 Node, 可以通过手动调用 onExit 来实现, 恢复时调用 onEnter, 等等. 这样子在 onExit 中写一写释放的代码似乎又不太合适.</p>
<blockquote>
<p>问题2: 只有加入到渲染树的节点才会被调用 onEnter/onExit</p>
</blockquote>
<p>存在这样的需求, 我们 new 一个 Node 对象, 但是却不急于将他 addChild 到另一个节点上, 而是先retain下, 这样的话就不会调用的onEnter/onExit. 或者我们有一个局部的 Node 对象, 不添加到节点树, 这样下一个回收周期会被回收掉, 但是整个过程却不会调用的onEnter/onExit.</p>
<h2 id="2-_ctor__u4E0E_onCleanup"><a href="#2-_ctor__u4E0E_onCleanup" class="headerlink" title="2. ctor 与 onCleanup"></a>2. ctor 与 onCleanup</h2><p>当我看到 onCleanup 整个名字, 我一度为我找到了最终的解决方案. 事实上, <strong>它在多数情况下确实是能够正常工作的</strong>, 它会在 node 被 remove 时调用. 说到这里你可能会敏锐发现它会遇到与 onExit 相同的问题2, 也确实如此. <strong>只有加入到渲染树的节点才会被调用 onCleanup</strong>.</p>
<p>但是如果你没有上述的要求的话, ctor 与 onCleanup 配合使用还是很不错的. 需要注意的一点是, 调用 <code>removeFromParentAndCleanup(bool cleanup)</code> 时如果 cleanup 不传入 true 的话是不会触发 onCleanup 事件的.</p>
<hr>
<p>综上所述, 现在并没有一个完美的方案, 只能自己搞一个.</p>
<p><img src="/img/22015-04-19-001.jpg" alt=""></p>
<h1 id="u4E8C-__u5B9E_u73B0"><a href="#u4E8C-__u5B9E_u73B0" class="headerlink" title="二. 实现"></a>二. 实现</h1><p>要实现一个析构消息, 其实特别简单, 只用在 Node 的析构函数中分发一个消息就可以了. 这里我用 <code>quick-3.5</code> 实现一下.</p>
<h2 id="1-__u6DFB_u52A0_kNodeOnDestroy__u4E8B_u4EF6_u5E76_u5206_u6CD5"><a href="#1-__u6DFB_u52A0_kNodeOnDestroy__u4E8B_u4EF6_u5E76_u5206_u6CD5" class="headerlink" title="1. 添加 kNodeOnDestroy 事件并分法"></a>1. 添加 kNodeOnDestroy 事件并分法</h2><p>打开 CCNode.h , 找到 <code>kNodeOnCleanup</code> 枚举, 并在下方添加 <code>kNodeOnDestroy</code> :</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">enum</span> &#123;</span><br><span class="line">    kNodeOnEnter,</span><br><span class="line">    kNodeOnExit,</span><br><span class="line">    kNodeOnEnterTransitionDidFinish,</span><br><span class="line">    kNodeOnExitTransitionDidStart,</span><br><span class="line">    kNodeOnCleanup,</span><br><span class="line">    kNodeOnDestroy</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>
<p>打开 CCNode.cpp, 找到<code>Node::~Node()</code>函数, 在函数开始处添加:<br><figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">#if CC_ENABLE_SCRIPT_BINDING</span><br><span class="line">    if ( _scriptType != kScriptTypeNone)</span><br><span class="line">    &#123;</span><br><span class="line">        int action = kNodeOnDestroy;</span><br><span class="line">        BasicScriptData data(this,(void*)&amp;action);</span><br><span class="line">        ScriptEvent scriptEvent(kNodeEvent,(void*)&amp;data);</span><br><span class="line">        ScriptEngineManager::getInstance()-&gt;getScriptEngine()-&gt;sendEvent(&amp;scriptEvent);</span><br><span class="line">    &#125;</span><br><span class="line">#endif // #if CC_ENABLE_SCRIPT_BINDING</span><br></pre></td></tr></table></figure></p>
<p>打开 <code>CCLuaEngine.cpp</code>, 修改 <code>handleNodeEvent</code> 函数, 添加:<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">case kNodeOnDestroy:&#10;    _stack-&#62;pushString(&#34;destroy&#34;);&#10;    break;</span><br></pre></td></tr></table></figure></p>
<p>编译 player, c++ 这边的修改就结束了.</p>
<h2 id="2-_Lua__u6DFB_u52A0_u4E8B_u4EF6_u5904_u7406"><a href="#2-_Lua__u6DFB_u52A0_u4E8B_u4EF6_u5904_u7406" class="headerlink" title="2. Lua 添加事件处理"></a>2. Lua 添加事件处理</h2><p>打开 NodeEx.lua , 在<code>onCleanup</code>函数下方添加:<br><figure class="highlight lua"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">Node:onDestroy</span><span class="params">()</span></span></span><br><span class="line"><span class="keyword">end</span></span><br></pre></td></tr></table></figure></p>
<p>修改<code>setNodeEventEnabled</code>函数, 添加调用:<br><figure class="highlight lua"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">...</span><br><span class="line"><span class="keyword">elseif</span> name == <span class="string">"cleanup"</span> <span class="keyword">then</span></span><br><span class="line">    self:onCleanup()</span><br><span class="line"><span class="keyword">elseif</span> name == <span class="string">"destroy"</span> <span class="keyword">then</span></span><br><span class="line">    self:onDestroy()</span><br><span class="line"><span class="keyword">end</span></span><br><span class="line">...</span><br></pre></td></tr></table></figure></p>
<hr>
<p>下来我们要修改一下lua这边移除事件监听的条件, 之前是收到<code>cleanup</code>消息, 现在应当改为<code>destroy</code>消息.</p>
<p>还是 NodeEx.lua , 找到<code>EventDispatcher</code>函数, 修改判断条件如下:<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">if idx==c.NODE_EVENT then&#10;    event = &#123; name=data &#125;&#10;    if data==&#34;destroy&#34; then&#10;        flagNodeCleanup = true&#10;    end</span><br></pre></td></tr></table></figure></p>
<h2 id="3-__u6D4B_u8BD5"><a href="#3-__u6D4B_u8BD5" class="headerlink" title="3. 测试"></a>3. 测试</h2><blockquote>
<p>1.我们新建一个scene, 然后添加如下代码:</p>
</blockquote>
<figure class="highlight lua"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">local</span> nodeEventTest = class(<span class="string">"nodeEventTest"</span>,<span class="function"><span class="keyword">function</span><span class="params">()</span></span></span><br><span class="line">    <span class="keyword">return</span> display.newScene(<span class="string">"nodeEventTest"</span>)</span><br><span class="line"><span class="keyword">end</span>)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">nodeEventTest:ctor</span><span class="params">()</span></span></span><br><span class="line">    cc.FileUtils:getInstance():addSearchPath(<span class="string">"src/"</span>)</span><br><span class="line"></span><br><span class="line">    self:setNodeEventEnabled(<span class="keyword">true</span>)</span><br><span class="line"><span class="keyword">end</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">nodeEventTest:onDestroy</span><span class="params">()</span></span></span><br><span class="line">    <span class="built_in">print</span>(<span class="string">"--nodeEventTest:onDestroy"</span>)</span><br><span class="line"><span class="keyword">end</span></span><br></pre></td></tr></table></figure>
<p>启动这个scene后,然后再进入另一个scene后,会在控制台观察到输出.</p>
<blockquote>
<p>2.我们在一个Layer中添加下面这几行代码:</p>
</blockquote>
<figure class="highlight lua"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">local</span> node = display.newNode()</span><br><span class="line">node:setNodeEventEnabled(<span class="keyword">true</span>, <span class="function"><span class="keyword">function</span><span class="params">(event)</span></span></span><br><span class="line">    <span class="built_in">print</span>(<span class="string">"node:"</span>,event.name)</span><br><span class="line"><span class="keyword">end</span>)</span><br></pre></td></tr></table></figure>
<p>可以在控制台观察到:<br><figure class="highlight lua"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">[LUA-<span class="built_in">print</span>] node: destroy</span><br></pre></td></tr></table></figure></p>
<p>因此我们的做法是成功的, 一个临时cocos对象也可以收到<code>onDestroy</code>事件.</p>
<p>–EOF–</p>
]]></content>
    </entry>
    
    <entry>
      <title><![CDATA[入手 iMac Retina 5K]]></title>
      <url>http://blog.justbilt.com/2015/05/08/buy-imac-with-retina/</url>
      <content type="html"><![CDATA[<h2 id="u5F15_u5B50"><a href="#u5F15_u5B50" class="headerlink" title="引子"></a>引子</h2><p>就买电脑这事来说，还是挺曲折的。大约是12年从朋友那入手了他淘汰的10年13寸Air，当时那叫一个开心啊，卧槽，苹果笔记本就是尼玛好看，恨不得睡觉都抱着。然后每天回家就抱着Air写代码，现在想起来还能够感受到当时的那种喜悦之情。</p>
<a id="more"></a>
<p>就这样一直用着，突然有一天就发现电脑带不动了，当时十分low逼的装了的windows，一开机就起飞，电池也用的巨快。后来发现切到 Mac OS 下会好很多，于是卸了windows，开始搞 Mac。就这样又过了一段时间，Mac 升级了几次系统后，发现又有些扛不住了，而且因为分辨率不高，好多软件用着很难受，慢慢的就不爱用了。</p>
<p>再后来换了工作，新公司配了台新版的Air，而且非常 Nice 的可以带回家里用，相比之下就彻底放弃了原来的Air。大约过了半年吧，离开了这家公司（<em>这个我过几天2014的年结的文章里会细说，原谅我的拖延症</em>），不舍归不舍，电脑自然是要归还的。不过因为写代码用起了 Sublime ，相对 Xcode 和 VS 来说，要轻量好多，所以又启用了尘封已久的Air，用着倒也相安无事。</p>
<hr>
<p>然后重点就来了，为啥又想买电脑了呢？因为QT，因为 Qt Creater 的界面太大了，编一个 960x640 的 ui 都放不全，需要滚来滚去的，太痛苦了。额，我是想过外接显示器的，不过每次选好放到购物车点下单的时候就开始犹豫了，漏光怎么办？尺寸不够怎么办？有色差怎么办？。。。。然后就没有然后了！</p>
<p>就这样一直拖到了15年的5月份，有一天晚上，就蒙生了买一个 iMac 的冲动，我的想法比较简单，买一个之后主机，显示器，鼠标，键盘都有了，嘿嘿（<em>多实在的一个人呐</em>）。第二天我起了一大早（6点），就在苹果官网买了，用的招行信用卡，分期可以免利息，不过得从招行的官网(<a href="http://mall.cmbchina.com/" target="_blank" rel="external">这里</a>)进去。这一次非常利索，拖延君完全没有反应过来就已经剁手啦~ 哈哈哈。</p>
<p>不过还是要特别感谢老婆大人的大力支持，若不是如此，恐怕也不会如此顺利 ~ 说出来不怕大家见笑啦，哈哈。</p>
<h2 id="u5F00_u7BB1"><a href="#u5F00_u7BB1" class="headerlink" title="开箱"></a>开箱</h2><p>下完单后就各种刷快递了，从上海发的货，第二天晚上就到了。这里必须赞一下顺丰的服务，因为是限时送达，快递小哥特意打了几个电话确认时间，提前30分钟就到楼下等我了（因为我还在公司改bug，苦逼），见到我后主动要求帮我搬上6楼，非常给力的有木有~</p>
<hr>
<p><img src="/img/IMG_20150508_215741_HDR.jpg" alt=""></p>
<p>↑↑↑ 呐，就是这个啦，不过还真是蛮大的哎~</p>
<p><img src="/img/IMG_20150507_202522_HDR.jpg" alt=""></p>
<p>↑↑↑ 拆掉外包装的样子。</p>
<p><img src="/img/IMG_20150507_202912_HDR.jpg" alt=""></p>
<p>↑↑↑ 开箱ing，内部防震泡沫贴合的非常完美，下方的连个泡沫需要左右抽出。</p>
<p><img src="/img/IMG_20150507_203403.jpg" alt=""></p>
<p>↑↑↑ 放到电脑桌上，屏幕上的保护套没有摘，图片加了特效，还不错吧！</p>
<p><img src="/img/IMG_20150507_203849.jpg" alt=""></p>
<p>↑↑↑ 屏幕上还有一层贴膜</p>
<p><img src="/img/IMG_20150507_204253_HDR.jpg" alt=""></p>
<p>↑↑↑ 背部接口特写，从左至右依次是：<code>耳机口</code>，<code>SD卡</code>,<code>USB3</code>x4,<code>雷电口</code>x2,<code>网线口</code>.</p>
<p><img src="/img/IMG_20150507_204450_HDR.jpg" alt=""></p>
<p>↑↑↑ 键鼠特写，苹果的键盘我特别喜欢，终于拥有了，开心~</p>
<p><img src="/img/IMG_20150507_233159_HDR.jpg" alt=""></p>
<p>↑↑↑ 最后来一张和 Air 的合照，对比十分强烈！</p>
<h2 id="u540E_u8BB0"><a href="#u540E_u8BB0" class="headerlink" title="后记"></a>后记</h2><p>经过断断续续一天的使用，总体感觉还是十分给力的，大屏看着就是爽。因为是混合硬盘，虽然没有纯 SSD 快，但是直观上已经感觉不出什么差异了。打开 Sublime 后，就会有想写些什么的冲动，希望自己不是3分钟热情吧，不要最初忘记目的是什么。</p>
<p>–EOF–</p>
]]></content>
    </entry>
    
    <entry>
      <title><![CDATA[一个命令行的 TexturePacker 拆解工具 (一)]]></title>
      <url>http://blog.justbilt.com/2015/04/19/untp/</url>
      <content type="html"><![CDATA[<h2 id="u4E00-__u8D77_u6E90"><a href="#u4E00-__u8D77_u6E90" class="headerlink" title="一. 起源"></a>一. 起源</h2><p>为什么想着做这样的一个工具呢? </p>
<p>事情是这样的, 在游戏后期的优化过程中, 发现特效在资源的总量中占比很大, 所以打算压缩下特效的尺寸. 我们特效是由策划用 TexturePacker 打成 <code>plist + png</code>的形式, 因为项目经手了好多人, 所以好多特效的源文件<strong>都已丢失</strong>. 因此想到做一个这样的脚本来实现这个功能.</p>
<a id="more"></a>
<p>首先想到的是 <a href="http://weibo.com/p/1005051307211523" target="_blank" rel="external">@偶尔e网事</a> 同学的<a href="http://blog.csdn.net/jackystudio/article/details/12867863" target="_blank" rel="external">Anti_TexturePacker</a>, 非常好用, 我经常推荐给有需要的朋友. 不过目前只能运行在 Windows 上, 而且不支持命令行, 我们的特效有好几百个, 一个一个来的话会死人的哦~</p>
<p>下来找到的是这个, <a href="https://github.com/onepill/texture_unpacker_scirpt" target="_blank" rel="external">texture_unpacker_scirpt</a>, 一看还不错, 简单测试了下集成到了开发环境中, 不过后来发现部分 <code>trim+rotate</code> 过的 frame 解析是不正确的.</p>
<blockquote>
<p><strong>一种造轮子的冲动涌上心头.</strong></p>
</blockquote>
<p><img src="/img/22015-04-19-001.jpg" alt=""></p>
<h2 id="u4E8C-__u5206_u6790"><a href="#u4E8C-__u5206_u6790" class="headerlink" title="二. 分析"></a>二. 分析</h2><p>试着分析下这个项目, 主要分为这几点:</p>
<h3 id="1-plist__u6587_u4EF6_u7684_u89E3_u6790_u548C_u5206_u6790"><a href="#1-plist__u6587_u4EF6_u7684_u89E3_u6790_u548C_u5206_u6790" class="headerlink" title="1.plist 文件的解析和分析."></a>1.plist 文件的解析和分析.</h3><p>plist 文件其实就是 xml 文件, 可以用 <code>xml.etree.ElementTree</code> 来解析, 恰好之前做过一个 <code>ccb2lua</code> 的项目, 搞起来也是轻车熟路. </p>
<p>plsit 中关键的一个结构是:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&#60;key&#62;oooo_001.png&#60;/key&#62;&#10;&#60;dict&#62;&#10;    &#60;key&#62;frame&#60;/key&#62;&#10;    &#60;string&#62;&#123;&#123;978,582&#125;,&#123;38,40&#125;&#125;&#60;/string&#62;&#10;    &#60;key&#62;offset&#60;/key&#62;&#10;    &#60;string&#62;&#123;15,42&#125;&#60;/string&#62;&#10;    &#60;key&#62;rotated&#60;/key&#62;&#10;    &#60;true/&#62;&#10;    &#60;key&#62;sourceColorRect&#60;/key&#62;&#10;    &#60;string&#62;&#123;&#123;76,18&#125;,&#123;38,40&#125;&#125;&#60;/string&#62;&#10;    &#60;key&#62;sourceSize&#60;/key&#62;&#10;    &#60;string&#62;&#123;160,160&#125;&#60;/string&#62;&#10;&#60;/dict&#62;</span><br></pre></td></tr></table></figure>
<table>
<thead>
<tr>
<th>字段</th>
<th style="text-align:center">含义</th>
</tr>
</thead>
<tbody>
<tr>
<td>frame</td>
<td style="text-align:center">在大图上的坐标和尺寸信息</td>
</tr>
<tr>
<td>offset</td>
<td style="text-align:center">trim 过的图片和原图之间的偏移</td>
</tr>
<tr>
<td>rotated</td>
<td style="text-align:center">是否进行了旋转</td>
</tr>
<tr>
<td>sourceColorRect</td>
<td style="text-align:center">原始图上的坐标和尺寸信息</td>
</tr>
<tr>
<td>sourceSize</td>
<td style="text-align:center">原始图片尺寸</td>
</tr>
</tbody>
</table>
<p>我做了一张图来解释这些参数:</p>
<p><img src="http://i.stack.imgur.com/4JxYT.png" alt=""></p>
<p>这里要注意:</p>
<ol>
<li>一张图片是否旋转, 都会保存相同的<code>frame.w</code>,<code>frame.h</code> 这点比较坑.</li>
<li>如果没有裁剪, <code>sourceColorRect</code>的<code>x</code>,<code>y</code>就是<code>0</code>, <code>w,h</code> 和 <code>sourceSize</code> 一致.</li>
</ol>
<h3 id="2-__u56FE_u50CF_u7684_u5207_u53D6_u548C_u4FDD_u5B58"><a href="#2-__u56FE_u50CF_u7684_u5207_u53D6_u548C_u4FDD_u5B58" class="headerlink" title="2. 图像的切取和保存."></a>2. 图像的切取和保存.</h3><p>图像 python 的还是选用了 PIL 来搞, 用到的接口也不多:</p>
<blockquote>
<p><strong>Image.open(file) ⇒ image</strong></p>
</blockquote>
<p>打开图像</p>
<blockquote>
<p><strong>Image.new(mode, size) ⇒ image</strong></p>
</blockquote>
<p>创建一张图像</p>
<blockquote>
<p><strong>im.crop(box) ⇒ image</strong></p>
</blockquote>
<p>截图图像一个区域</p>
<blockquote>
<p><strong>im.paste(image, box)</strong></p>
</blockquote>
<p>将一张图像粘贴到一个区域</p>
<h1 id="u4E09-__u5B9E_u73B0"><a href="#u4E09-__u5B9E_u73B0" class="headerlink" title="三. 实现"></a>三. 实现</h1><p>这里我大概讲一下实现, 具体大家可以去看源码.</p>
<h3 id="1-plist__u8BFB_u53D6"><a href="#1-plist__u8BFB_u53D6" class="headerlink" title="1.plist 读取"></a>1.plist 读取</h3><p>cocos2d-x 的这个 plist 的格式是比较奇怪的 xml, 每一个 key 的 value 都是在下一行:</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="title">key</span>&gt;</span>format<span class="tag">&lt;/<span class="title">key</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="title">integer</span>&gt;</span>2<span class="tag">&lt;/<span class="title">integer</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="title">key</span>&gt;</span>realTextureFileName<span class="tag">&lt;/<span class="title">key</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="title">string</span>&gt;</span>oooo.png<span class="tag">&lt;/<span class="title">string</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="title">key</span>&gt;</span>size<span class="tag">&lt;/<span class="title">key</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="title">string</span>&gt;</span>&#123;1024,1024&#125;<span class="tag">&lt;/<span class="title">string</span>&gt;</span></span><br></pre></td></tr></table></figure>
<p>所以比较方便的实现是一次获取两行, 如下:</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">data = &#123;&#125;</span><br><span class="line">iterator = iter(_element)</span><br><span class="line"><span class="keyword">while</span> <span class="keyword">True</span>:</span><br><span class="line">    <span class="keyword">try</span>:</span><br><span class="line">        key = iterator.next()</span><br><span class="line">        value = iterator.next()</span><br><span class="line">        data[key.text] = parseElement(value.tag, value)</span><br><span class="line">    <span class="keyword">except</span> StopIteration:</span><br><span class="line">        <span class="keyword">break</span></span><br></pre></td></tr></table></figure>
<h3 id="2-_u56FE_u7247_u7684_trim+rotate"><a href="#2-_u56FE_u7247_u7684_trim+rotate" class="headerlink" title="2.图片的 trim+rotate"></a>2.图片的 trim+rotate</h3><p>这个着实令人蛋疼, 因为旋转之后, <code>frame</code> 标签记录的宽高值并没有改变, 所以还得自己去判断下有没有旋转. <code>trim+rotate</code> 之后更是令人发指, 因为这样 <code>sourceColorRect</code> 的宽高,xy偏移都会互换. 这里若是思路不清晰, 极有可能被绕晕.</p>
<p>因为开始参考了<a href="https://github.com/onepill/texture_unpacker_scirpt" target="_blank" rel="external">texture_unpacker_scirpt</a>的实现, 所以思路一直按照它的路线走, 代码中多次判断了是否旋转. 后来发现代码过于晦涩, 于是完全抛弃了它的实现. </p>
<p>最终核心代码如下:</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">src_image = Image.open(_imagefile)</span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> (name,config) <span class="keyword">in</span> data[<span class="string">"frames"</span>].items():</span><br><span class="line">    <span class="comment"># parse config</span></span><br><span class="line">    frame           = parse.parse(<span class="string">"&#123;&#123;&#123;&#123;&#123;x:d&#125;,&#123;y:d&#125;&#125;&#125;,&#123;&#123;&#123;w:d&#125;,&#123;h:d&#125;&#125;&#125;&#125;&#125;"</span>,config[<span class="string">"frame"</span>])</span><br><span class="line">    sourceColorRect = parse.parse(<span class="string">"&#123;&#123;&#123;&#123;&#123;x:d&#125;,&#123;y:d&#125;&#125;&#125;,&#123;&#123;&#123;w:d&#125;,&#123;h:d&#125;&#125;&#125;&#125;&#125;"</span>,config[<span class="string">"sourceColorRect"</span>])</span><br><span class="line">    sourceSize      = parse.parse(<span class="string">"&#123;&#123;&#123;w:d&#125;,&#123;h:d&#125;&#125;"</span>,config[<span class="string">"sourceSize"</span>])</span><br><span class="line">    rotated         = config[<span class="string">"rotated"</span>]</span><br><span class="line"></span><br><span class="line">    <span class="comment"># create temp image</span></span><br><span class="line">    src_rect = (frame[<span class="string">"x"</span>],frame[<span class="string">"y"</span>],frame[<span class="string">"x"</span>]+(frame[<span class="string">"h"</span>] <span class="keyword">if</span> rotated <span class="keyword">else</span> frame[<span class="string">"w"</span>]),frame[<span class="string">"y"</span>]+(frame[<span class="string">"w"</span>] <span class="keyword">if</span> rotated <span class="keyword">else</span> frame[<span class="string">"h"</span>]))</span><br><span class="line">    temp_image = src_image.crop(src_rect)</span><br><span class="line">    <span class="keyword">if</span> rotated:</span><br><span class="line">        temp_image = temp_image.rotate(<span class="number">90</span>)</span><br><span class="line"></span><br><span class="line">    <span class="comment"># create dst image</span></span><br><span class="line">    dst_image = Image.new(<span class="string">'RGBA'</span>, (sourceSize[<span class="string">"w"</span>], sourceSize[<span class="string">"h"</span>]), (<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>))</span><br><span class="line">    dst_image.paste(temp_image, (sourceColorRect[<span class="string">"x"</span>],sourceColorRect[<span class="string">"y"</span>]), mask=<span class="number">0</span>)</span><br><span class="line">    dst_image.save(outpath + <span class="string">"/"</span> + name)</span><br></pre></td></tr></table></figure>
<p>可以看到只有两处判断了旋转. 大家点这里可以看下<a href="https://github.com/onepill/texture_unpacker_scirpt/blob/master/unpacker.py#L26-64" target="_blank" rel="external">texture_unpacker_scirpt的实现</a>, 就会发现它的逻辑确实略显晦涩.</p>
<h1 id="u56DB-_u7528_u6CD5"><a href="#u56DB-_u7528_u6CD5" class="headerlink" title="四.用法"></a>四.用法</h1><p>用法已经更新, 大家到<a href="/2016/10/29/untp-2/">这里查看</a>.</p>
<h1 id="u4E94-_u540E_u8BB0"><a href="#u4E94-_u540E_u8BB0" class="headerlink" title="五.后记"></a>五.后记</h1><p>项目现已开源至github, 地址<a href="https://github.com/justbilt/untp" target="_blank" rel="external">https://github.com/justbilt/untp</a>, <del>并提供了 windows 和 mac 的可执行文件, 位于 <a href="https://github.com/justbilt/untp/releases" target="_blank" rel="external">Release Page</a></del>, 有问题欢迎评论或 issue 告知!</p>
<p>(–EOF–)</p>
]]></content>
    </entry>
    
    <entry>
      <title><![CDATA[手机游戏攻防(二) 守护变量法]]></title>
      <url>http://blog.justbilt.com/2015/04/05/phone-game-AND-watchdog/</url>
      <content type="html"><![CDATA[<h2 id="u4E00-_u601D_u8DEF"><a href="#u4E00-_u601D_u8DEF" class="headerlink" title="一.思路"></a>一.思路</h2><p>我在13年8月的时候写过一篇游戏防八门神器修改的文章(<a href="/2015/04/04/phone-game-AND-encrypt-var/">见这里</a>), 当时介绍了一个守护策略就是<code>变量加密法</code>, 今天我们来介绍下另一种思路: <code>守护变量法</code>.</p>
<a id="more"></a>
<p>这个最开始想法来自于我之前看到的一篇文章<a href="http://club.tgfcer.com/thread-6817371-1-1.html" target="_blank" rel="external">&lt;&lt;从外行的视角尝试讲解为什么这回丰田栽了&gt;&gt;</a>中的一小节: </p>
<blockquote>
<p>对关键变量缺乏保护。<br>嵌入式系统，或者任何系统，都会在一定条件下发生硬件或者软件错误。客观上这是无法避免的。而且汽车作为一个时常在震动、发热、位移的系统，它的内部环境不能说不恶劣，发生硬件错误的可能性甚至更高。什么样的硬件错误呢？别忘了变量都是0和1的组合，这些0和1由存储器上的高低电平代表。由于某些不可抗原因，一个电平从高变成低，或者反过来，那么这个变量就被更改了。这被称为“位反转（Bit Flip）”。为了对抗这样的事情发生，需要对变量进行保护。保护的方法一般是镜像法。简单来说就是在两个不同的地方写入同一个变量，读取的时候两边都读，比较是不是一致。如果不一致，那么可以得知这个变量已经不可靠，需要进行容错处理。</p>
</blockquote>
<p>这篇文章非常有意思, 大家不妨仔细阅读一下! 当时我看完文章后是非常震惊的, 作为一个游戏程序员, 我们出错后可能只会导致公司的一些收入损失. 但是对于开发汽车系统的程序员, 他们出错的后果可能就是一条条人命了! 这使得我之后写代码时更加谨慎, 觉得可能出错的地方都会加以处理.</p>
<p>言归正传, <strong>守护变量法的核心思想是为每一个变量都建立一个守护变量, 通过守护变量去验证原始变量的合法性</strong>, 思路与原文一致, 但实现略有不同, 就是守护变量与原始变量<strong>不是单纯的镜像,而是进行加密处理</strong>! 原因很简单, 单纯镜像会使得守护变量也被修改掉, 失去守护的能力!</p>
<p>那么问题就来了? 同样需要加密, <code>守护变量法</code>较<code>变量加密法</code>又有什么优势呢? 两点:</p>
<ol>
<li>可以监测到用户修改的行为</li>
<li>可以对数据进行还原</li>
</ol>
<p><strong>可以监测到玩家修改数据的行为</strong>使得我们掌握了主动权, 接下来是杀是留全在我们掌控之中. <strong>可以对数据进行还原</strong>又能保证进行温和的惩罚后游戏仍能正常的进行!</p>
<h2 id="u4E8C-_u5B9E_u73B0"><a href="#u4E8C-_u5B9E_u73B0" class="headerlink" title="二.实现"></a>二.实现</h2><p>这里我用 quick-cocos2d-x 简单实现下:</p>
<p>1). <code>CryptoNumber.lua</code>:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">local CryptoNumber = class(&#34;CryptoNumber&#34;)&#10;&#10;function CryptoNumber:ctor(_value)&#10;&#9;self:setValue(_value)&#10;end&#10;&#10;function CryptoNumber:decode()&#10;&#9;return tonumber(crypto.decodeBase64(self.protect_data))&#10;end&#10;&#10;function CryptoNumber:encode(_value)&#10;&#9;return crypto.encodeBase64(_value)&#10;end&#10;&#10;function CryptoNumber:setValue(_value)&#10;&#9; self.data = _value&#10;&#9; self.protect_data = self:encode(_value)&#10;end&#10;&#10;function CryptoNumber:getValue()&#10;&#9;if not self:check() then&#10;&#9;&#9;print(&#34;error!&#34;) --&#36825;&#37324;&#20570;&#20462;&#25913;&#21518;&#30340;&#22788;&#29702;!&#10;&#9;&#9;self:setValue(self:decode())&#10;&#9;end&#10;&#9;return self.data&#10;end&#10;&#10;function CryptoNumber:check()&#10;&#9;return self.data == self:decode()&#10;end&#10;&#10;return CryptoNumber</span><br></pre></td></tr></table></figure>
<p>2). <code>MyApp.lua</code></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">local n = require(&#34;utils.CryptoNumber&#34;).new(5)&#10;print(&#34;getValue:&#34;,n:getValue())&#10;n.data = 10 -- &#36825;&#37324;&#29992;&#30452;&#25509;&#36171;&#20540;&#27169;&#25311;&#25968;&#25454;&#20462;&#25913;&#10;print(&#34;getValue:&#34;,n:getValue())</span><br></pre></td></tr></table></figure>
<p>3). console</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">[LUA-print] getValue:&#9;5&#10;[LUA-print] error!&#10;[LUA-print] getValue:&#9;5  //&#21487;&#20197;&#30475;&#21040;&#25968;&#20540;&#34987;&#36824;&#21407;&#22238;&#21435;&#20102;</span><br></pre></td></tr></table></figure>
<p>演示代码, 没有考虑太多. 对于 lua 来说有更简单的做法, 比如使用<code>metamethod</code>.</p>
<h2 id="u4E09-_u540E_u8BB0"><a href="#u4E09-_u540E_u8BB0" class="headerlink" title="三.后记"></a>三.后记</h2><p>其实我是建议对修改数据的玩家进行温和处理的, 比如监测到玩家修改数据后, 弹出提示告诉玩家解锁成就, 比如<em>游戏大师</em>. 或者走煽情路线, 告诉玩家我们开发游戏的不易, 各种苦逼各种惨. 也可以做成一个彩蛋, 弹出开发者信息. 甚至可以给玩家一些小奖励. 核心就是: <strong>玩家不是我们的敌人, 让玩家感受到我们的诚意</strong>. </p>
]]></content>
    </entry>
    
    <entry>
      <title><![CDATA[手机游戏攻防(一) 变量加密法]]></title>
      <url>http://blog.justbilt.com/2015/04/04/phone-game-AND-encrypt-var/</url>
      <content type="html"><![CDATA[<p>这篇文章的前提是单机游戏,网络游戏有自己的加密方法,与单机游戏不尽相同!</p>
<p>游戏辛辛苦苦的做完了,但是使用八门神器可以轻松的修改你的重要数据(金币,道具数量),哈哈哈,那么恭喜您,您挣不到一分钱!说的有点危言耸听了,毕竟知道八门神器这个工具的不是非常多,而且使用条件比较苛刻,但是我们不能掉以轻心,他完全可以修改完成了,将存档放在网上,这样我们就十分被动了!</p>
<a id="more"></a>
<h3 id="u4E00-_u4EC0_u4E48_u662F_u516B_u95E8_u795E_u5668"><a href="#u4E00-_u4EC0_u4E48_u662F_u516B_u95E8_u795E_u5668" class="headerlink" title="一.什么是八门神器"></a>一.什么是八门神器</h3><p>不明白八门神器为何物的请自行Google!这里我引用百度百科(点击这里:<a href="http://baike.baidu.com/view/3258873.htm" target="_blank" rel="external">http://baike.baidu.com/view/3258873.htm</a>)中的一段话:</p>
<blockquote>
<p>八门神器是安卓、iOS、塞班平台上通用的游戏修改工具，可以修改内存中的数值和参数，达到修改游戏HP、MP、金钱、等级等的作用。八门神器类似于PC平台的金山游侠等游戏修改器，是手机游戏中的金手指。但八门神器在安卓平台下需要Root权限才能正常工作，在iOS平台下需要iPhone越狱才能正常工作，并且支持中、英双语言，并且自带帮助说明。</p>
</blockquote>
<p>建议大家还是亲自去使用下这个工具,效果请看下图:</p>
<p><img src="/img/31036b15a219185ac6a0c54157ebf36937540518.jpg" alt=""></p>
<h3 id="u4E8C-_u539F_u7406"><a href="#u4E8C-_u539F_u7406" class="headerlink" title="二.原理"></a>二.原理</h3><p>知己知彼百战百胜,我们要先了解八门神器的原理:</p>
<blockquote>
<p>在游戏运行时，内存和处理器都会对于游戏进行非常复杂的数据交换和变更，这是因为游戏有很多的数据，例如金钱、HP值、等级、攻击力、防御力等数据，而这些数据，就在内存和处理器的各个地址当中，玩家只需要在八门神器中搜索相关的数据值，八门神器就会将搜索出记录此数据的各个地址显示，玩家进行多次的数据变更后再次搜索，到最后就会确定此地址到底是哪一个，然后将此地址的数值进行修改，回到游戏中，相关的数据也会变化!<br>总结下,就是八门神器会搜索出对应数值的内存地址,然后改变内存地址对应的值!</p>
</blockquote>
<h3 id="u4E09-_u5E94_u5BF9_u65B9_u6848"><a href="#u4E09-_u5E94_u5BF9_u65B9_u6848" class="headerlink" title="三.应对方案"></a>三.应对方案</h3><p>这样我们貌似可以从两个方面去入手解决这个问题:</p>
<ol>
<li>让它搜不着!</li>
<li>让它改变不了!</li>
</ol>
<p>我们今天先来看看第一种方法. 用过这个工具的人都明白,一般情况下,一次搜索就能准确定位内存地址的情况非常少见(除非这个数字非常大,非常奇葩),都是先搜索,获得大量(几十万)的数据,然后回到游戏中,改变这个值,再回到八门神器,会自动筛选出之前搜索到的结果有哪些改变了…直到只剩下几个结果,这个时候我们挨个去改变值会变得十分的Easy!</p>
<p><strong>1.改变内存地址</strong></p>
<p>想想这个过程,好像只有第一次搜索是全局搜索,后面的每次搜索都是在之前搜索的结果上进行筛选!这样如果我们游戏中每次改变这个变量的时都去改变这个变量的内存地址,这样它就搜索不到了!代码如下:<br><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">class</span> DynamicInt</span><br><span class="line">&#123;</span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line">	DynamicInt()&#123;m_pValue=<span class="literal">NULL</span>;&#125;</span><br><span class="line"></span><br><span class="line">	~DynamicInt()</span><br><span class="line">	&#123;</span><br><span class="line">		<span class="keyword">if</span> (m_pValue)</span><br><span class="line">		&#123;</span><br><span class="line">			<span class="keyword">delete</span> m_pValue;</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="function"><span class="keyword">int</span> <span class="title">getValue</span><span class="params">()</span></span>&#123;<span class="keyword">return</span> *m_pValue;&#125;</span><br><span class="line"></span><br><span class="line">	<span class="function"><span class="keyword">void</span> <span class="title">setValue</span><span class="params">(<span class="keyword">int</span> nValue)</span></span><br><span class="line">	</span>&#123;</span><br><span class="line">		<span class="keyword">if</span> (m_pValue)</span><br><span class="line">		&#123;</span><br><span class="line">			<span class="keyword">delete</span> m_pValue;</span><br><span class="line">		&#125;</span><br><span class="line">		m_pValue=<span class="keyword">new</span> <span class="keyword">int</span>();</span><br><span class="line">		*m_pValue=nValue;</span><br><span class="line">	&#125;</span><br><span class="line"><span class="keyword">private</span>:</span><br><span class="line">	<span class="keyword">int</span> * m_pValue;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure></p>
<p> 经过尝试,这个方法并不管用,还能被破解,不知我的做法错误呢还是八门神器的原理不是这样!请懂行人指出!</p>
<blockquote>
<p>注: 经过分析, 可能是因为你 delete 后立刻 new 会获取到同一块内存地址的原因~ 这样的话, 我们也好说, 我们先换下顺序可能就可以了, 不过我没有进行过测试!</p>
</blockquote>
<p><strong>2.加密数据</strong></p>
<p>换个思路,我们为何不在数据上做手脚,对数据进行加密(如:表面上显示的是50,内部存的却是50^0xff),这样他搜索表面上的数字当然搜索不到!代码如下:<br><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><span class="line"><span class="preprocessor">#<span class="keyword">ifndef</span> _H_DYNAMICVALUE_H_</span></span><br><span class="line"><span class="preprocessor">#<span class="keyword">define</span> _H_DYNAMICVALUE_H_</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">template</span>&lt;<span class="keyword">class</span> T&gt;</span><br><span class="line"><span class="keyword">class</span> CEncryptValue</span><br><span class="line">&#123;</span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line">	CEncryptValue()</span><br><span class="line">		: m_Value(<span class="number">0</span>)</span><br><span class="line">	&#123;</span><br><span class="line">	&#125;</span><br><span class="line">	~CEncryptValue()</span><br><span class="line">	&#123;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="function">T <span class="title">getValue</span><span class="params">()</span></span><br><span class="line">	</span>&#123;</span><br><span class="line">		<span class="keyword">return</span> m_Value ^ m_EncryptKey;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="function"><span class="keyword">void</span> <span class="title">setValue</span><span class="params">(T value)</span></span><br><span class="line">	</span>&#123;</span><br><span class="line">		m_Value = value;</span><br><span class="line">		m_EncryptKey = rand();</span><br><span class="line">		m_Value ^= m_EncryptKey;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="function"><span class="keyword">void</span> <span class="title">offset</span><span class="params">(T value)</span></span><br><span class="line">	</span>&#123;</span><br><span class="line">		setValue(getValue() + value);</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line">	T m_Value;</span><br><span class="line">	<span class="keyword">int</span> m_EncryptKey;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="keyword">typedef</span> CEncryptValue&lt;<span class="keyword">int</span>&gt; CDynamicValueInt;</span><br><span class="line"><span class="keyword">typedef</span> CEncryptValue&lt;<span class="keyword">float</span>&gt; CDynamicValueFloat;</span><br><span class="line"><span class="keyword">typedef</span> CEncryptValue&lt;<span class="keyword">bool</span>&gt; CDynamicValueBool;</span><br><span class="line"></span><br><span class="line"><span class="preprocessor">#<span class="keyword">endif</span></span></span><br></pre></td></tr></table></figure></p>
<p>使用时:</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">CDynamicValueInt m_DynamicMoney;</span><br><span class="line"></span><br><span class="line"><span class="comment">//设置金钱数</span></span><br><span class="line">m_DynamicMoney.setValue(<span class="number">1000</span>);</span><br><span class="line"></span><br><span class="line"><span class="comment">//得到金钱</span></span><br><span class="line">m_DynamicMoney.getValue()</span><br><span class="line"></span><br><span class="line"><span class="comment">//改变金钱</span></span><br><span class="line">m_DynamicMoney.offset(-<span class="number">100</span>);</span><br></pre></td></tr></table></figure>
<p>这个方法经过测试,十分管用!也是我目前采取的方案!大家可以直接拿来使用!</p>
<p>写在后面的话:</p>
<p>有些人可能会骂八门神器的作者无耻之类,我非常不认同,大家都是靠手艺吃饭的,么有什么无耻不无耻的,如果你的游戏被破解了,只能说明你比较傻!还有对使用八门神器破解游戏的玩家表示同情,因为你一旦破解了,整个游戏就没有意义了!</p>
]]></content>
    </entry>
    
    <entry>
      <title><![CDATA[QuickxDev插件(二) debug.log文件的处理]]></title>
      <url>http://blog.justbilt.com/2015/03/16/quickxdev-2/</url>
      <content type="html"><![CDATA[<p>上篇文章中我们说过要对debug.log文件做一些特殊处理, 这里我们来看看具体的实现.</p>
<a id="more"></a>
<h1 id="u4E00-__u5BF9_debug-log__u6587_u4EF6_u8FDB_u884C_u914D_u8272"><a href="#u4E00-__u5BF9_debug-log__u6587_u4EF6_u8FDB_u884C_u914D_u8272" class="headerlink" title="一. 对 debug.log 文件进行配色"></a>一. 对 debug.log 文件进行配色</h1><p>debug.log文件默认是没有配色的, 灰不拉几不好看. 实现这个其实非常简单, 每一个打开的文件都是一个<code>sublime.View</code>, <code>sublime.View</code>中有现成的函数<code>set_syntax_file</code>来设置文件句法规则, 让我们来看下定义:</p>
<blockquote>
<p>set_syntax_file(syntax_file)<br>Changes the syntax used by the view. syntax_file should be a name along the lines of Packages/Python/Python.tmLanguage. To retrieve the current syntax, use view.settings().get(‘syntax’).</p>
</blockquote>
<p>这个函数其实对应的是 Sublime 菜单栏中的这个:</p>
<p><img src="/img/QQ20150316-2.jpg" alt=""></p>
<p>大家可以多试几次, 挑一个好看点的, 我选中的是 <code>Java</code> 的语法(路径为:<code>Packages/Java/Java.tmLanguage</code>).</p>
<p>下面我们要监听文件 debug.log 的打开, 监听事件需要继承<code>sublime_plugin.EventListener</code>, QuickxDev 已经有了 <code>QuickxListener</code>, 查询 api 可以得知可以监听 <code>on_load</code> 事件来实现.</p>
<blockquote>
<p>on_load(view)<br>Called when the file is finished loading.</p>
</blockquote>
<p>实现的代码也非常的简单:</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">QuickxListener</span><span class="params">(sublime_plugin.EventListener)</span>:</span></span><br><span class="line">	...</span><br><span class="line">	<span class="function"><span class="keyword">def</span> <span class="title">on_load</span><span class="params">(self, view)</span>:</span></span><br><span class="line">		print(view.file_name())</span><br><span class="line">		<span class="keyword">if</span> view.file_name().find(<span class="string">"debug.log"</span>) != -<span class="number">1</span>:</span><br><span class="line">			view.set_syntax_file(<span class="string">"Packages/Java/Java.tmLanguage"</span>)</span><br></pre></td></tr></table></figure>
<p>让我们来张对比图:</p>
<p><img src="/img/QQ20150316-3.jpg" alt=""></p>
<h1 id="u4E8C-__u542F_u52A8_Player__u65F6_u6253_u5F00_debug-log__u6587_u4EF6"><a href="#u4E8C-__u542F_u52A8_Player__u65F6_u6253_u5F00_debug-log__u6587_u4EF6" class="headerlink" title="二. 启动 Player 时打开 debug.log 文件"></a>二. 启动 Player 时打开 debug.log 文件</h1><p>因为种种原因, 我的 debug.log 文件没有在 Sublime 工程中, 所以每次想看日志都得在磁盘上找到这个文件, 拖进来, 略显繁琐. 因此萌生了运行 player 时顺带打开 debug.log 文件的需求.</p>
<p>实现起来也十分简单, 查询 api 得知:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">open_file(file_name, &#60;flags&#62;)&#9;&#10;&#9;Opens the named file, and returns the corresponding view. If the file is already opened, it will be brought to the front. Note that as file loading is asynchronous, operations on the returned view won&#39;t be possible until its is_loading() method returns False.&#10;&#9;The optional flags parameter is a bitwise combination of:&#10;&#10;&#9;sublime.ENCODED_POSITION. Indicates the file_name should be searched for a :row or :row:col suffix&#10;&#9;sublime.TRANSIENT. Open the file as a preview only: it won&#39;t have a tab assigned it until modified</span><br></pre></td></tr></table></figure>
<p><code>file_name</code>文件名不说, 后面的 flags 比较有意思: </p>
<ol>
<li><code>sublime.ENCODED_POSITION</code> 选项可以再在打开文件的同时定位到某一行/某一列,非常有用.</li>
<li><code>sublime.TRANSIENT</code> 选项意思是只是预览它, 直到手动改变内容前不创建标签 .</li>
</ol>
<p>下面我们找到启动 Player 的地方, 因为<code>file_name</code>是全路径, 所以我们需要找到工程的路径. 启动 player 时需要传入 <code>-workdir</code> 参数, 我们用这个就行. 实现同样十分简单:</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">workdir = os.path.split(path)[<span class="number">0</span>]</span><br><span class="line">args.append(<span class="string">"-workdir"</span>)</span><br><span class="line">args.append(workdir)</span><br><span class="line"></span><br><span class="line">...</span><br><span class="line"></span><br><span class="line">view.window().open_file(workdir+<span class="string">"/debug.log"</span>)</span><br></pre></td></tr></table></figure>
<h1 id="u4E09-__u9519_u8BEF_u5806_u6808/dump__u7684_u8DF3_u8F6C"><a href="#u4E09-__u9519_u8BEF_u5806_u6808/dump__u7684_u8DF3_u8F6C" class="headerlink" title="三. 错误堆栈/dump 的跳转"></a>三. 错误堆栈/dump 的跳转</h1><p>当我查看debug.log 文件时, 经常会看到类似的语句:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">1.lua &#35821;&#27861;&#38169;&#35823;&#10;/Users/XXXX/scripts/app/MyApp.lua:117: &#39;=&#39; expected near &#39;a&#39;&#10;&#10;2. lua &#36816;&#34892;&#26102;&#38169;&#35823;&#10;Cocos2d: [LUA ERROR] [string &#34;/Users/XXX/app/MyApp.lua&#34;]:118: attempt to index local &#39;a&#39; (a nil value)&#10;&#10;3. dump &#20449;&#24687;&#10;Cocos2d: [0.0724] dump from: [string &#34;/Users/XXX/scripts/app/MyApp.lua&#34;]:117: in function &#39;ctor&#39;</span><br></pre></td></tr></table></figure>
<p>他们之中都包含了文件名+行号信息, 联想到上面提到打开文件时可以跳转到某一行, 是不是隐隐感觉可以做些什么?</p>
<p>没错, 基于这个, 我们能够很容易的实现双击错误信息后跳转到错误位置.</p>
<h2 id="1-__u6DFB_u52A0_u9F20_u6807_u53CC_u51FB_u7684_u54CD_u5E94"><a href="#1-__u6DFB_u52A0_u9F20_u6807_u53CC_u51FB_u7684_u54CD_u5E94" class="headerlink" title="1. 添加鼠标双击的响应"></a>1. 添加鼠标双击的响应</h2><p>这个比较简单, 我们需要在 QuickxDev 文件夹中创建 <code>Default.sublime-mousemap</code> 文件, 内容如下:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">[&#10;&#9;&#123;&#10;&#9;  &#34;button&#34;: &#34;button1&#34;, &#34;count&#34;: 2,&#10;&#9;  &#34;press_command&#34;: &#34;drag_select&#34;,&#10;&#9;  &#34;press_args&#34;: &#123;&#34;by&#34;: &#34;words&#34;&#125;,&#10;&#9;  &#34;command&#34;: &#34;my_special_doubleclick&#34;&#10;&#9;&#125;&#10;]</span><br></pre></td></tr></table></figure>
<p>这样在双击左键的时候会发送 <code>my_special_doubleclick</code> 事件, 我们在 quickx.py 中定义它:</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">MySpecialDoubleclickCommand</span><span class="params">(sublime_plugin.TextCommand)</span>:</span></span><br><span class="line">	<span class="function"><span class="keyword">def</span> <span class="title">run</span><span class="params">(self, edit)</span>:</span></span><br><span class="line">		<span class="keyword">if</span> <span class="keyword">not</span> self.view.file_name():</span><br><span class="line">			<span class="keyword">return</span></span><br><span class="line">		file_path, file_name = os.path.split(self.view.file_name())</span><br><span class="line">		<span class="keyword">if</span> file_name == <span class="string">"debug.log"</span>:</span><br><span class="line">			print(file_path, file_name)</span><br></pre></td></tr></table></figure>
<p>我们双击 debug.log 文件的某一行就会收到<code>MySpecialDoubleclickCommand</code>命令, 进而打印出文件名, 路径!</p>
<h2 id="2-__u83B7_u53D6_u9F20_u6807_u53CC_u51FB_u7684_u6240_u5728_u884C"><a href="#2-__u83B7_u53D6_u9F20_u6807_u53CC_u51FB_u7684_u6240_u5728_u884C" class="headerlink" title="2. 获取鼠标双击的所在行"></a>2. 获取鼠标双击的所在行</h2><p>因为双击会选中某个单词, 所以我们可以使用<code>sublime.View.sel()</code>来获取当前选中的行:</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">for</span> region <span class="keyword">in</span> self.view.sel():</span><br><span class="line">	<span class="keyword">if</span> <span class="keyword">not</span> region.empty():</span><br><span class="line">		line = self.view.substr(self.view.line(region.a))</span><br><span class="line">		<span class="keyword">break</span></span><br><span class="line"></span><br><span class="line">print(<span class="string">"line:"</span>,line)</span><br></pre></td></tr></table></figure>
<h2 id="3-__u8BA1_u7B97_u8DF3_u8F6C_u7684_u6587_u4EF6_u548C_u884C_u53F7"><a href="#3-__u8BA1_u7B97_u8DF3_u8F6C_u7684_u6587_u4EF6_u548C_u884C_u53F7" class="headerlink" title="3. 计算跳转的文件和行号"></a>3. 计算跳转的文件和行号</h2><p>因为不会正则, 只能用一些土办法来计算文件和行号, 代码如下, 比较简单:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">def parseLuaError(line):&#10;&#9;key = &#34;.lua:&#34;&#10;&#9;posKeyStart = line.find(key)&#10;&#9;if posKeyStart == -1:&#10;&#9;&#9;return False,&#34;&#34;&#10;&#9;posKeyEnd = posKeyStart + len(key)&#10;&#9;filename = line[:posKeyStart].strip(&#34; \t&#34;)+&#34;.lua&#34;&#10;&#9;fileline = line[posKeyEnd:line.find(&#34;:&#34;,posKeyEnd)]&#10;&#10;&#9;return True, filename+&#34;:&#34;+fileline&#10;&#10;def parseCocosErrorAndDump(line):&#10;&#9;filename = &#34;&#34;&#10;&#9;fileline = 1&#10;&#9;keyHead = &#34;[string \&#34;&#34;&#10;&#9;posHeadStart = line.find(keyHead)&#10;&#9;if posHeadStart == -1:&#10;&#9;&#9;return False,&#34;&#34;&#10;&#10;&#9;posHeadEnd = posHeadStart + len(keyHead)&#10;&#10;&#9;key = &#34;.lua\&#34;]:&#34;&#10;&#9;posKeyStart = line.find(key,posHeadStart)&#10;&#9;&#10;&#9;if posHeadStart == -1:&#10;&#9;&#9;return False,&#34;&#34;&#10;&#10;&#9;posKeyEnd = posKeyStart + len(key)&#10;&#10;&#9;filename = line[posHeadEnd:posKeyStart]+&#34;.lua&#34;&#10;&#9;fileline = line[posKeyEnd:line.find(&#34;:&#34;,posKeyEnd)]&#10;&#10;&#9;return True, filename+&#34;:&#34;+fileline</span><br></pre></td></tr></table></figure>
<p>想想还是正则会比较简单, 以后有机会在改吧!</p>
<h2 id="3-__u8DF3_u8F6C"><a href="#3-__u8DF3_u8F6C" class="headerlink" title="3. 跳转"></a>3. 跳转</h2><p>在上面的步骤中我们拿到了文件名和行号, 现在我们只需要跳转就OK了!</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">parseLine</span><span class="params">(self, line)</span>:</span></span><br><span class="line">	re,string = self.parseCocosErrorAndDump(line)</span><br><span class="line">	<span class="keyword">if</span> re:</span><br><span class="line">		<span class="keyword">return</span> re,string</span><br><span class="line"></span><br><span class="line">	<span class="keyword">return</span> self.parseLuaError(line)</span><br><span class="line"></span><br><span class="line">re,filename = self.parseLine(line)</span><br><span class="line"><span class="keyword">if</span> re:</span><br><span class="line">	self.view.window().open_file(filename,sublime.ENCODED_POSITION)</span><br></pre></td></tr></table></figure>
<p>是啦,就是这么简单! 意外的发现这个功能对错误堆栈的跳转十分给力! 录了几个小 GIF, 感受一下吧!</p>
<p><a href="/img/2015-03-19-001.gif">演示一</a>,<a href="/img/2015-03-19-002.gif">演示二</a>,<a href="/img/2015-03-19-003.gif">演示三</a>,<a href="http://ww1.sinaimg.cn/large/7f870d23jw1eqb60t0ritg20yc0bie82.gif" target="_blank" rel="external">演示四</a></p>
<p>其实这些功能实现起来都不难, 但是却能令自己感觉很爽很有成就感, 这恐怕就是做游戏所不能体会到的吧! 哈哈!</p>
<p>(本文完)</p>
]]></content>
    </entry>
    
    <entry>
      <title><![CDATA[QuickxDev插件(一) 简介]]></title>
      <url>http://blog.justbilt.com/2015/03/16/quickxdev-1/</url>
      <content type="html"><![CDATA[<h1 id="u4E00-_QuickxDev"><a href="#u4E00-_QuickxDev" class="headerlink" title="一. QuickxDev"></a>一. QuickxDev</h1><p><code>QuickxDev</code>是一个极其好用的Sublime插件, 主要用来开发quick-cocos2d-x, 提供了特别实用的功能:</p>
<a id="more"></a>
<h2 id="1-Run_With_Player"><a href="#1-Run_With_Player" class="headerlink" title="1.Run With Player"></a>1.Run With Player</h2><p><img src="http://ww1.sinaimg.cn/large/7f870d23gw1ehzyjexmtxj209v075wf0.jpg" alt=""></p>
<p>非常实用的功能,这样就不用手动启动Player, 然后选中目录配置参数了. Player自带的<code>Create Launcher</code>一定程度上能够加速启动, 但是因为需要暂时离开开发环境, 所以还是不如这个方便.</p>
<p>这个功能必须在<code>scripts</code>目录上右键才有这个菜单选项.</p>
<!--more-->
<h2 id="2-Goto_Definition"><a href="#2-Goto_Definition" class="headerlink" title="2.Goto Definition"></a>2.Goto Definition</h2><p><img src="http://ww3.sinaimg.cn/large/7f870d23gw1ei1odq1ycgj20gq07zq3z.jpg" alt=""></p>
<p>选中一个字段, <code>ctrl+shift+g</code> 或者右键选择 ‘Goto Definition’ ,就可以跳转到这个字段的定义, 是不是顿时有种IDE的感觉了呢? 如果这个字段多处都有定义, 就会弹出一个列表供你选择, 非常棒的功能.</p>
<p>这个功能必须选中这个字段才会生效.</p>
<h2 id="3-Code_Snippets"><a href="#3-Code_Snippets" class="headerlink" title="3.Code Snippets"></a>3.Code Snippets</h2><p><img src="http://ww3.sinaimg.cn/large/7f870d23gw1ei1oot7o0xj20bu07dwf3.jpg" alt=""></p>
<p>代码提示可能是我们对一个代码编辑器最基本的需求. 如果大家看过QuickDev的源码, 可以在<code>QuickDev/quickxlib</code>下发现代码分为三类</p>
<ol>
<li>quick-cocos2d-x_api 这里是quick-cocos2d-x的提示文件,包含cocos2d-x的提示和framework的提示</li>
<li>snippets 这里是lua一些控制语句的提示,如:<code>if else</code>, <code>while</code></li>
<li>system_api 这里是lua的关键字和常用库的提示,如:<code>io</code>,<code>math</code></li>
</ol>
<p>简直业界良心的有木有!!!</p>
<h2 id="4-Compile_Scripts"><a href="#4-Compile_Scripts" class="headerlink" title="4.Compile Scripts"></a>4.Compile Scripts</h2><p><img src="http://ww4.sinaimg.cn/large/7f870d23gw1ei1tcrqq06j208p087wey.jpg" alt=""></p>
<p>这个功能可以将lua脚本用luajit编译成字节码,运行效率数倍提升.同时可以进行脚本加密, 需要在插件的设置中填写秘钥.</p>
<h1 id="u4E8C-__u5B89_u88C5QuickxDev"><a href="#u4E8C-__u5B89_u88C5QuickxDev" class="headerlink" title="二. 安装QuickxDev"></a>二. 安装QuickxDev</h1><p><code>sublime</code> 安装插件十分容易</p>
<h2 id="1-Package_Control"><a href="#1-Package_Control" class="headerlink" title="1.Package Control"></a>1.Package Control</h2><p>如果安装了<code>Package Control</code>, <code>Cmd+Shift+P</code>打开命令输入框, 输入 <code>Install Package</code>, 回车, 稍等片刻, 在弹出的框中输入<code>QuickxDev</code>回车后等待安装成功.</p>
<h2 id="2-_u6E90_u7801_u5B89_u88C5"><a href="#2-_u6E90_u7801_u5B89_u88C5" class="headerlink" title="2.源码安装"></a>2.源码安装</h2><p>我们也可以直接从 <code>github</code> 上下载 <code>QuickxDev</code> 的源码到Sublime的插件目录, Subilme会自动识别, 十分方便.</p>
<p>其实我的建议多数插件从<code>Package Control</code>安装, 方便, 不需要自己维护, 需要修改的插件从源码安装, 这样可以避免Sublime自动升级插件带来的问题, 而且Sublime3从 Package Control 安装的插件是二进制的,根本无法修改查看.</p>
<h2 id="3-_u63D2_u4EF6_u8BBE_u7F6E"><a href="#3-_u63D2_u4EF6_u8BBE_u7F6E" class="headerlink" title="3.插件设置"></a>3.插件设置</h2><p><img src="/img/QQ20150316-1.jpg" alt=""></p>
<p>按照上图打开<code>QuickXDev.sublime-settings</code>:<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&#123;&#10;    // quick_cocos2dx_root&#10;    &#34;quick_cocos2dx_root&#34;: &#34;/Users/.../quick-cocos2d-x-2.2.5&#34;,&#10;    // you name and email&#10;    &#34;author&#34;: &#34;wangbilt&#60;wangbilt@gmail.com&#62;&#34;,&#10;    // lua template attributes&#10;    &#34;date_format&#34;: &#34;%Y-%m-%d %H:%M:%S&#34;,&#10;    // i.e. peter or peter (peter@gmail.com)&#10;    &#34;author&#34;: &#34;justbilt&#34;,&#10;    // compile_scripts encrypt key,no encrypt when empty&#10;    &#34;compile_scripts_key&#34;: &#34;&#34;&#10;&#125;</span><br></pre></td></tr></table></figure></p>
<p>这里必须要配置就是<code>quick_cocos2dx_root</code>,是你quickx的绝对路径.</p>
<h1 id="u4E09-__u5B9A_u5236_u529F_u80FD"><a href="#u4E09-__u5B9A_u5236_u529F_u80FD" class="headerlink" title="三. 定制功能"></a>三. 定制功能</h1><p><strong>QuickxDev</strong> 已经十分牛逼了, 但还是无法满足每一个人需求, 这时候就需要我们自己去定制一些功能了, 我计划添加以下功能.</p>
<h2 id="1-_u5FEB_u6377_u952E_u542F_u52A8Player"><a href="#1-_u5FEB_u6377_u952E_u542F_u52A8Player" class="headerlink" title="1.快捷键启动Player"></a>1.快捷键启动Player</h2><p>虽然通过右键菜单在Sublime中启动Player已经很方便的了, 但还是感觉欠一些, 必须需要 <code>手离开工作区到指定位置-&gt;右键-&gt;找到菜单项-&gt;选中</code>, 这个操作的时间消耗至少是快捷键启动的5倍以上!</p>
<blockquote>
<p>这个功能最新的QuickxDev已经支持了,十分赞!</p>
</blockquote>
<h2 id="2-_u5BF9debug-log_u6587_u4EF6_u7684_u5904_u7406"><a href="#2-_u5BF9debug-log_u6587_u4EF6_u7684_u5904_u7406" class="headerlink" title="2.对debug.log文件的处理"></a>2.对debug.log文件的处理</h2><p>1).debug.log现在是没有配色的,看着不是很方便.<br>2).启动player的时候自动打开debug.log文件.<br>3).堆栈的跳转,dump的跳转.</p>
<blockquote>
<p>这几点现在已经完全实现, 等整理好后会向官方提交PR.</p>
</blockquote>
<h2 id="3-_u751F_u6210_u4E00_u4E2AJava_u6587_u4EF6_u7684_u51FD_u6570_u7B7E_u540D"><a href="#3-_u751F_u6210_u4E00_u4E2AJava_u6587_u4EF6_u7684_u51FD_u6570_u7B7E_u540D" class="headerlink" title="3.生成一个Java文件的函数签名"></a>3.生成一个Java文件的函数签名</h2><p>平时我们要生成一个Java文件的函数签名比较麻烦,要在命令行中使用<code>javac</code>,<code>javap</code>什么的,比较麻烦,不如通过插件来实现,同时还有生成<code>java native</code>函数的C++实现.</p>
<h1 id="u56DB-_u540E_u8BB0"><a href="#u56DB-_u540E_u8BB0" class="headerlink" title="四.后记"></a>四.后记</h1><p>上面说的这几个功能我都会单独写文章来讲具体的实现. 但在这之前可能是需要大家了解 Sublime 插件开发的一些知识, 因此我会同时会开始写 <strong>Sublime 插件开发的系列文章</strong> .</p>
<p>(本文完)</p>
]]></content>
    </entry>
    
    <entry>
      <title><![CDATA[搭建自己的 wiki 之 jingo 篇]]></title>
      <url>http://blog.justbilt.com/2015/01/29/jingo/</url>
      <content type="html"><![CDATA[<h2 id="u4E00-_Why_jingo__3F"><a href="#u4E00-_Why_jingo__3F" class="headerlink" title="一. Why jingo ?"></a>一. Why jingo ?</h2><p>一直想搭wiki好久了,这期间试了好多个wiki项目,如:<a href="https://www.dokuwiki.org/dokuwiki" target="_blank" rel="external">dokuwiki</a>, <a href="http://simiki.org/" target="_blank" rel="external">simiki</a>, <a href="https://torchpad.com/" target="_blank" rel="external">torchpad</a>, 也慢慢地弄明白了自己真正的需求是什么.</p>
<a id="more"></a>
<blockquote>
<p>git + markdown + (Python or nodejs)</p>
</blockquote>
<p>来说明下为什么:</p>
<ol>
<li><code>git</code>,<code>wiki</code>特别重要的一点就是历史版本,方便回滚,这个用<code>git</code>来简直天作之合.</li>
<li><code>markdown</code>,也不必多说, 当时从离开<code>Wordpress</code>就是因为厌倦了文章排版.</li>
<li><code>Python or nodejs</code>, 根据我的经验,安装方便,配置简单,坑少.</li>
</ol>
<p><a href="https://github.com/claudioc/jingo" target="_blank" rel="external">jingo</a>就符合这些要求, 同时还支持在线编辑的功能,使得你可以随手记,随时记录wiki. 但是jingo没有提供静态界面的生成,也就意味着无法托管到github上.</p>
<p><img src="/img/QQ20150129-1.jpg" alt=""></p>
<h2 id="u4E8C-__u5B89_u88C5_jingo"><a href="#u4E8C-__u5B89_u88C5_jingo" class="headerlink" title="二. 安装 jingo"></a>二. 安装 jingo</h2><p>文档说的是<code>npm install jingo</code>, 不过我推荐加上<code>-g</code>参数,安装到全局,不然会找不到<code>jingo</code>命令, 同时要考虑是否加<code>sudo</code>.</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">npm install jingo -g</span><br></pre></td></tr></table></figure>
<p>安装好之后随便找一个目录:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">jingo -s &#62; config.yaml</span><br></pre></td></tr></table></figure>
<p>生成默认配置, 同时由于<code>jingo</code>需要一个git仓库,所以我们需要在当前目录:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">git init</span><br></pre></td></tr></table></figure>
<p>打开生成的<code>config.yaml</code>,找到<code>repository</code>改为<code>.</code>,使用当前目录作为仓库:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">repository: &#34;.&#34;</span><br></pre></td></tr></table></figure>
<p>保存,然后就可以启动了:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">jingo -c ./config.yaml</span><br></pre></td></tr></table></figure>
<h2 id="u4E09-__u767B_u5F55"><a href="#u4E09-__u767B_u5F55" class="headerlink" title="三. 登录"></a>三. 登录</h2><p>启动之后是不可以修改的, 必须先登录,点击右上角<code>You&#39;re not logged in</code>, 会切换到登录页面:</p>
<p><img src="/img/QQ20150130-1.jpg" alt=""></p>
<p>上面显示不全是什么情况吗? 而且不能注册?</p>
<p>让我们回到终端,<code>Ctrl-c</code>停掉刚才启动的的jingo,继续打开<code>config.yaml</code>看<code>authentication</code>组的配置:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">authentication:&#10;  google:&#10;    enabled: true&#10;    clientId: replace me with the real value&#10;    clientSecret: replace me with the real value&#10;  github:&#10;    enabled: false&#10;    clientId: replace me with the real value&#10;    clientSecret: replace me with the real value&#10;  alone:&#10;    enabled: false&#10;    username: &#34;&#34;&#10;    passwordHash: &#34;&#34;&#10;    email: &#34;&#34;</span><br></pre></td></tr></table></figure>
<p>可以看到默认只开启了google的授权登录, 让我们改为用户名密码登录:<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">alone:&#10;  enabled: true&#10;  username: &#34;XXXX&#34;&#10;  passwordHash: &#34;XXXXX&#34;&#10;  email: &#34;xxxx@gmail.com&#34;</span><br></pre></td></tr></table></figure></p>
<p>需要注意下这个<code>passwordHash</code>,这里不是填密码,而是密码的hash值,<code>jingo</code>提供了生成密码hash的功能,非常方便,终端中键入<code>jingo -# &quot;你的密码&quot;</code>:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">jingo -# &#34;xxxx&#34;&#10;4ad583af22c2e7d40c1c916b2920299155a46464</span><br></pre></td></tr></table></figure>
<p>类似于<code>4ad583af22c2e7d40c1c916b2920299155a46464</code>这个就是你的<code>passwordHash</code>.同时可以关掉google的授权登录,<code>google: enabled: false</code>.</p>
<p>完成后然我们再次启动<code>jingo -c ./config.yaml</code>, 点击登录就可看到这个界面了:</p>
<p><img src="/img/QQ20150130-2.jpg" alt=""></p>
<p>登录之后的操作比较简单,就不做特殊说明了.右上部位有一个蓝底白字<code>Tools</code>, 鼠标放上去之后可以显示工具栏, 啥意思也猜的出来.</p>
<p><img src="/img/QQ20150130-3.jpg" alt=""></p>
<h2 id="u56DB-__u540C_u6B65_u5230_github/oschina"><a href="#u56DB-__u540C_u6B65_u5230_github/oschina" class="headerlink" title="四. 同步到 github/oschina"></a>四. 同步到 github/oschina</h2><p>jingo的一个特色是修改wiki后会自动帮你push到远端仓库, 十分方便.</p>
<p>首先我们要添加remote,在github上或者其他托管网站建立一个repository,复制<code>url</code>,然后在wiki的git目录:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">git remote add origin git@xxxx.git</span><br></pre></td></tr></table></figure>
<p>这里要注意一点,<strong>一定</strong>要使用ssh协议来<code>add remote/clone</code>, 可以避免每次<code>pull/push</code>都需要输入用户名密码, 那样会导致在线编辑的时候网页会卡死.</p>
<p>开启自动push只需要修改<code>application-&gt;remote</code>字段.这里有一个非常坑的地方,我一直以为这里要填远端的<code>url</code>,结果会一直报错:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Error: Remote does not exist (git@xxxx.git)</span><br></pre></td></tr></table></figure>
<p>跟踪js代码才发现,这里要填的是remote的name,如<code>origin</code>之类的,配置如下:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">application:&#10;  remote: &#34;origin&#34;&#10;  pushInterval: 30</span><br></pre></td></tr></table></figure>
<p><code>pushInterval</code>是<code>push</code>的间隔时间,单位为秒,这个有需求的话可以自己改. 上一张oshina <code>commit</code>记录的截图,这些都是自动提交的哦.</p>
<p><img src="/img/QQ20150130-4.jpg" alt=""></p>
<h2 id="u56DB-__u89E3_u51B3_u4E2D_u56FD_u7279_u8272_u95EE_u9898"><a href="#u56DB-__u89E3_u51B3_u4E2D_u56FD_u7279_u8272_u95EE_u9898" class="headerlink" title="四. 解决中国特色问题"></a>四. 解决中国特色问题</h2><p>测试了一下,发现在不翻墙的情况下, 本地访问都会加载好久, 用chrom的分析工具:</p>
<p><img src="/img/Screenshot-2015-01-31-1.jpg" alt=""></p>
<p>可以看到,因为国情的原因,有两个条目加载失败了,让我来解决掉它,打开<code>jingo/views/layout.jade</code>:</p>
<ol>
<li>第<code>9</code>行:<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">link(rel=&#34;stylesheet&#34;, href=&#34;//fonts.googleapis.com/css?family=Ubuntu|Ubuntu+Condensed&#34;)</span><br></pre></td></tr></table></figure>
</li>
</ol>
<p>删除掉.</p>
<ol>
<li>第<code>61</code>行<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">script(src=&#34;http://ajax.googleapis.com/ajax/libs/jquery/1/jquery.min.js&#34;)</span><br></pre></td></tr></table></figure>
</li>
</ol>
<p>改为:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">script(src=&#34;http://lib.sinaapp.com/js/jquery/1.8/jquery.min.js&#34;)</span><br></pre></td></tr></table></figure>
<h2 id="u4E94-__u603B_u7ED3"><a href="#u4E94-__u603B_u7ED3" class="headerlink" title="五. 总结"></a>五. 总结</h2><p>jingo 总体来说还是很不错的, 在线编辑功能十分给力, 配置起来比较简单, 也蛮漂亮的. 但是有一些设定也是比较二的, 有下面几点:</p>
<ol>
<li>不能直接修改目录中的文件, 只能在线编辑</li>
<li>经常出现<code>此网页包含重定向循环</code></li>
<li>界面跳转有逻辑问题,经常出现url拼接错误.</li>
<li>不能自动生成侧边栏, 得自己手动改md文件.</li>
</ol>
<p>综上, <code>jingo</code> 有能力的同学自己改改还何以用, 挂在自己服务器也是可以的, 要不只能用来玩玩了.</p>
<p>(本文完)</p>
]]></content>
    </entry>
    
    <entry>
      <title><![CDATA[svn commit 守则]]></title>
      <url>http://blog.justbilt.com/2014/12/15/svn/</url>
      <content type="html"><![CDATA[<p>晚上实在是睡不着, 起来把这个坑填了. 其实想写这篇文章好久了, 因为一些不好的习惯吃了一些亏, 加上团队中发现的一些问题, 记下来, 时刻提醒下自己.</p>
<a id="more"></a>
<h3 id="1-__u63D0_u4EA4_u65E5_u5FD7"><a href="#1-__u63D0_u4EA4_u65E5_u5FD7" class="headerlink" title="1. 提交日志"></a>1. 提交日志</h3><p><strong>必要性:</strong>这个我想应该不需要强调吧, 最基本的东西, 一般稍微严格些的团队都会有硬性的要求. 这是一个利人利己的工作, 想知道自己几周前干了什么, 看log是最佳的方式了. </p>
<p><strong>准确性:</strong>提交信息应该是准确的描述你这次提交干了些什么, 其他的前戏和废话则不要有. 如果有需要强调的地方, 还应该备注出来. 而且一个团队应该有约定的格式, 比如 <code>fix issue xxx</code>, <code>add xxx</code>,这样会在后期日志定位时非常的方便.</p>
<h3 id="2-__u4E00_u6B21_u63D0_u4EA4_u53EA_u505A_u4E00_u4EF6_u4E8B"><a href="#2-__u4E00_u6B21_u63D0_u4EA4_u53EA_u505A_u4E00_u4EF6_u4E8B" class="headerlink" title="2. 一次提交只做一件事"></a>2. 一次提交只做一件事</h3><p>这样子是为了方便以后<code>revert</code> 和 <code>merge</code> 操作, 举个栗子,比如你一次提交了两个功能, 但是其中的一个功能可能被砍掉或者会引发一个非常严重的bug, 改动的文件非常多, 必须使用<code>revert</code>操作, 然后就傻逼了, 另外一个功能也被回滚掉了.再比如, 你需要<code>merge</code>同事的代码, 但他的一个功能目前你不需要或者合并后会出现问题, 这时候肯定会在内心问候对方的. </p>
<p>因此, 需要我们掌握的一个技巧就是<strong>分多次提交工作区的更改</strong>, 是的, 我见过一个同事每次必须一次性吧所有更改都提交完, 然后在日志里写: <code>1.xxx 2.xxx 3.xxx</code>, 何必呢! 分多次提交可能会导致某一个版本无法正常运行, 因此一定要仔细检查.</p>
<h3 id="3-_review__u4F60_u7684_u66F4_u6539"><a href="#3-_review__u4F60_u7684_u66F4_u6539" class="headerlink" title="3. review 你的更改"></a>3. review 你的更改</h3><p>这点中的<strong>十分重要</strong>, 但也是最容易忽略的一些. <strong>一定要在提交前挨个对比文件的每一处更改</strong>, 这个可能会花费你的一些时间, 但相比与带来的好处这的不值一提. 在这一步你会发现一些隐藏的bug.</p>
<h3 id="4-__u907F_u514D_u65E0_u610F_u4E49_u7684_u63D0_u4EA4"><a href="#4-__u907F_u514D_u65E0_u610F_u4E49_u7684_u63D0_u4EA4" class="headerlink" title="4. 避免无意义的提交"></a>4. 避免无意义的提交</h3><p>这是什么意思呢, 就是某些更改可能是没有意义的, 包扩一些空格, 换行, 测试代码. 这些都应该在提交前的review中删除掉. 举个栗子,比如工程的config文件中DEBUG变量,默认值为1,你可能在这次提交时改成2, 那次提交时改成3, 最后又改回成1, 这样莫名的config文件在svn上就莫名多了3次版本,而且毫无意义, 这种情况下就不应该提交这个文件.</p>
<h3 id="5-__u786E_u4FDD_u4F60_u7684_u7A0B_u5E8F_u80FD_u591F_u8FD0_u884C"><a href="#5-__u786E_u4FDD_u4F60_u7684_u7A0B_u5E8F_u80FD_u591F_u8FD0_u884C" class="headerlink" title="5. 确保你的程序能够运行"></a>5. 确保你的程序能够运行</h3><p>你可能会说这当然了, 但是你在提交前有运行过你的程序吗? review之后呢? 我想没有什么比更新下来的代码不能运行更蛋疼的事情了. 而且真的有的人在没有做完一个功能运行报错的情况下就提交代码.</p>
<h3 id="6-_clear__u4F60_u7684_u5DE5_u4F5C_u533A"><a href="#6-_clear__u4F60_u7684_u5DE5_u4F5C_u533A" class="headerlink" title="6. clear 你的工作区"></a>6. clear 你的工作区</h3><p>对于提交完还存在于你的工作区更改列表的文件, 你的选择有<code>ignore/revert/delete</code>, 总有一个适合你. 我曾经见到一个同事提交完后svn中还充斥着数十个更改文件, 分散在各个目录中. 导致每次提交都得”精挑细选”下. 一个干净的工作区绝对是一天好心情的开始!!!</p>
<p>因此, 一个最佳的commit流程应该是:</p>
<blockquote>
<p>test –&gt;&gt; review –&gt;&gt; test again –&gt;&gt; commit –&gt;&gt; clear</p>
</blockquote>
<p>我希望被我提到的同事不要生气或愤怒, 因为我坚信一句话: 和聪明的人一起共事最大的好处是不用顾忌对方的自尊心!</p>
]]></content>
    </entry>
    
    <entry>
      <title><![CDATA[quickx CCGraySprite 消失坑 (已更新解决方案)]]></title>
      <url>http://blog.justbilt.com/2014/10/29/quickx-CCGraySprite-invisible/</url>
      <content type="html"><![CDATA[<p>前几天团队中小A遇到了一个非常诡异的问题, 特此记录一下.</p>
<a id="more"></a>
<p><img src="http://ww2.sinaimg.cn/large/7f870d23jw1elry310gmoj20dv090jsl.jpg" alt=""></p>
<p>大家看上图中的一个灰色的精灵, 这个是由<code>CCGraySprite</code>创建出来的, 它被添加了到了CCNode中, 当第一次进入界面是正常, 退出界面, 再次进入改界面就看不见了, 但是只要一移动这个界面就又可以看见了.</p>
<p>这个问题十分的诡异, 出现的条件十分苛刻, 但是复现率是100%, 就比较好解决了. 我猜测有可能是一下几个原因:</p>
<p>第一个可能, 精灵的问题的被释放掉了, 但是这个无法解释 <strong>只要一移动这个界面就又可以看见了</strong>.</p>
<p>第二个可能, lua这边的内存被释放掉了,同样无法解释上边的现象</p>
<p>第三个可能, <code>CCGraySprite</code>的内部实现又问题, 这个比较好证明, <strong>换一种变灰的实现</strong>就可以验证了.</p>
<p>于是我们改用zrong贡献的滤镜来实现变灰的功能:</p>
<figure class="highlight lua"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">-- 创建灰度精灵</span></span><br><span class="line">_spr = CCFilteredSpriteWithOne:createWithTexture(_texture, _rect)</span><br><span class="line"><span class="keyword">local</span> filters = filter.newFilter(<span class="string">"GRAY"</span>)</span><br><span class="line">_spr:setFilter(filters)</span><br></pre></td></tr></table></figure>
<p>验证结果果然是<code>CCGraySprite</code>的问题,用<code>CCFilteredSprite</code>替换可以解决.</p>
<p><del>因为比较着急, 虽然最后解决了, 但没有具体去分析原因, 希望有知道原因的同学可以告知一下.</del></p>
<h3 id="Update_12_u670820_u65E5_3A"><a href="#Update_12_u670820_u65E5_3A" class="headerlink" title="Update 12月20日:"></a>Update 12月20日:</h3><p>今天又遇到了这个bug, 看来得好好研究下了!</p>
<p>Google了一下, 看来不止我一个人遇到了这个问题, <a href="http://www.cocoachina.com/bbs/read.php?tid-217500-page-e-fpage-1.html" target="_blank" rel="external">谁用过CCGraySprite，移除再新建就不会显示了</a>, 虽然没有解决, 但是知道怎么重现了.</p>
<blockquote>
<p>谁用过CCGraySprite，<strong>移除再新建就不会显示了</strong>，不知道大家用什么灰态精灵，求解.</p>
</blockquote>
<p>这个确实容易重现, 测试代码:</p>
<figure class="highlight lua"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">MainScene:ctor</span><span class="params">()</span></span></span><br><span class="line">    ui.newMenu(&#123;ui.newTTFLabelMenuItem(&#123;text = <span class="string">"删除&amp;创建"</span>, listener = handler(self, self.init)&#125;)&#125;)</span><br><span class="line">        :pos(display.cx, display.cy - <span class="number">100</span>)</span><br><span class="line">        :addTo(self)</span><br><span class="line"></span><br><span class="line">    self:init()</span><br><span class="line"><span class="keyword">end</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">MainScene:init</span><span class="params">()</span></span></span><br><span class="line">    <span class="keyword">if</span> self.spr <span class="keyword">then</span></span><br><span class="line">        self.spr:removeFromParent()</span><br><span class="line">    <span class="keyword">end</span></span><br><span class="line"></span><br><span class="line">    self.spr = CCNodeExtend.extend(CCGraySprite:create(<span class="string">"start.png"</span>))</span><br><span class="line">        :pos(display.cx, display.cy)</span><br><span class="line">        :addTo(self)</span><br><span class="line"><span class="keyword">end</span></span><br></pre></td></tr></table></figure>
<p>我们新建一个CCGraySprite, 点击按钮后删除再重新创建, 就真的看不见了!</p>
<p>起初我们猜测是因为删除后立刻创建的问题, 在加了定时器后依然如此, 排除!</p>
<p>然后我们去看CCGraySprite的实现, 既然第二次创建会出现问题, 那么很可能是init的实现有问题, CCGraySprite 的实现最终都会调用 initWithTexture</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">CCGLProgram* pProgram = CCShaderCache::sharedShaderCache()-&gt;programForKey(kCCShader_PositionTextureGray);</span><br><span class="line">setShaderProgram(pProgram);</span><br><span class="line">CHECK_GL_ERROR_DEBUG();</span><br><span class="line"></span><br><span class="line"><span class="comment">//为渲染的顶点流增加属性（顶点属性： position, texCoord, color, normal 等）</span></span><br><span class="line">getShaderProgram()-&gt;addAttribute(kCCAttributeNamePosition, kCCVertexAttrib_Position);</span><br><span class="line">getShaderProgram()-&gt;addAttribute(kCCAttributeNameColor, kCCVertexAttrib_Color);</span><br><span class="line">getShaderProgram()-&gt;addAttribute(kCCAttributeNameTexCoord, kCCVertexAttrib_TexCoords);</span><br><span class="line">CHECK_GL_ERROR_DEBUG();</span><br><span class="line"></span><br><span class="line"><span class="comment">//链接生成shaderProgram，初始化完毕后调用生成才能够在程序中使用 </span></span><br><span class="line">getShaderProgram()-&gt;link();</span><br><span class="line">CHECK_GL_ERROR_DEBUG();</span><br><span class="line"></span><br><span class="line"><span class="comment">//更新2dx自带的几个uniform 值（使之与shader中的变量值同步）</span></span><br><span class="line">getShaderProgram()-&gt;updateUniforms();</span><br><span class="line">CHECK_GL_ERROR_DEBUG();</span><br></pre></td></tr></table></figure>
<p>因为在<code>CCShaderCache::loadDefaultShader</code>中看到过一样的代码, 就怀疑是因为<strong>多次初始化</strong>的原因. 经过排查, 将</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">getShaderProgram()-&gt;link();</span><br></pre></td></tr></table></figure>
<p>这行代码注释掉之后成功! 附图:</p>
<p><img src="http://ww1.sinaimg.cn/large/7f870d23gw1enoa7sayraj20tu0lkjsq.jpg" alt=""></p>
<p>(EOF)</p>
]]></content>
    </entry>
    
    <entry>
      <title><![CDATA[我花在互联网服务上的钱]]></title>
      <url>http://blog.justbilt.com/2014/10/17/spend-money-on-network/</url>
      <content type="html"><![CDATA[<p>瞎逛的时候看到了这篇文章, <a href="http://www.vinkyq.com/posts/212217-a-programmer-a-year-how-much-money-spend-on-products-on-the-internet" target="_blank" rel="external">一个程序员一年会在互联网产品上花多少钱</a>, 作为离互联网最近的一批人, 作为一群有钱又巨抠无比的人, 我们到底回为什么(服务)付费呢?</p>
<a id="more"></a>
<p>这里说说我的情况, 我是一个不会随便为服务花钱的, 我的零花钱基本全部花费在了购买硬件和外设上, 所以能让我付费的服务已经很厉害了!</p>
<h3 id="u66F2_u5F84_28_u7FFB_u5899_u4EE3_u7406_29"><a href="#u66F2_u5F84_28_u7FFB_u5899_u4EE3_u7406_29" class="headerlink" title="曲径(翻墙代理)"></a>曲径(翻墙代理)</h3><p>用官网上的一句话就是:”生命短暂，即买即用”, 这是我买了最不后悔的服务了, 最省心的代理(没有之一).</p>
<p>费用: 130 元/季 * 4 = 520</p>
<h3 id="u4E07_u7F51_u57DF_u540D_u670D_u52A1_28_u57DF_u540D_29"><a href="#u4E07_u7F51_u57DF_u540D_u670D_u52A1_28_u57DF_u540D_29" class="headerlink" title="万网域名服务(域名)"></a>万网域名服务(域名)</h3><p>本博客 (<a href="http://post.justbilt.com/" target="_blank" rel="external">http://post.justbilt.com/</a>) 和另外一个域名的费用. 我的博客是托管在github上的, 所以没有花钱.</p>
<p>费用: 2个 * 一年 55 元 = 110</p>
<h3 id="u8FC5_u96F7_u767D_u91D1_u4F1A_u5458_28_u4E0B_u8F7D_u52A0_u901F_29"><a href="#u8FC5_u96F7_u767D_u91D1_u4F1A_u5458_28_u4E0B_u8F7D_u52A0_u901F_29" class="headerlink" title="迅雷白金会员(下载加速)"></a>迅雷白金会员(下载加速)</h3><p>作为一个电影爱好者(不专指岛国), 迅雷会员怎么能少?</p>
<p>费用: 年费149元（原价180）</p>
<p>共计: 520 + 110 + 149 = 779 RMB</p>
<h3 id="Feedly_Pro__28RSS_29"><a href="#Feedly_Pro__28RSS_29" class="headerlink" title="Feedly Pro (RSS)"></a>Feedly Pro (RSS)</h3><p>作为一个重度的rss患者, Feedly我现在已经离不开了, 尤其是在购买了曲径之后. 现在来说免费功能足够使用, 考虑付费.</p>
<p>费用:  $45 yearly = 276</p>
<h3 id="u65B0_u6D6A_u5FAE_u535A_u4F1A_u5458__28_u88C5B_29"><a href="#u65B0_u6D6A_u5FAE_u535A_u4F1A_u5458__28_u88C5B_29" class="headerlink" title="新浪微博会员 (装B)"></a>新浪微博会员 (装B)</h3><p>这个准备弃坑了, 感觉没有什么实际作用, 还不如买个迅雷绿钻或者优酷会员什么的呢!</p>
<p>费用: 108 元</p>
<p>这些服务加起来一年也就一千多块, 平均到每一天也就几块钱, 与它们所带来的价值来说, 还是十分划算的!</p>
]]></content>
    </entry>
    
    <entry>
      <title><![CDATA[quickx addTo导致tag无效坑]]></title>
      <url>http://blog.justbilt.com/2014/09/11/quickx-addto/</url>
      <content type="html"><![CDATA[<p>前几天遇到了一个十分诡异的bug,分享出来大家看看,代码是这个样子的:</p>
<figure class="highlight lua"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">local</span> a = display.newNode()</span><br><span class="line"><span class="keyword">local</span> b = display.newNode()</span><br><span class="line">b:setTag(<span class="number">10</span>)</span><br><span class="line">b:addTo(a)</span><br><span class="line"><span class="built_in">print</span>(b:getTag())</span><br></pre></td></tr></table></figure>
<a id="more"></a>
<p>这个程序正常的结果应该是<code>10</code>,但实际却是<code>0</code>.这个问题十分诡异,如果是<code>-1</code>的话还说的过去,但<code>0</code>是个什么情况嘛?</p>
<p>仔细想想,大家应该很快能把异常的位置定位到<code>b:addTo(a)</code>这行中,让我们看下下<code>addTo</code>函数的实现:</p>
<figure class="highlight lua"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">CCNodeExtend:addTo</span><span class="params">(target, zorder, tag)</span></span></span><br><span class="line">    target:addChild(self, zorder <span class="keyword">or</span> <span class="number">0</span>, tag <span class="keyword">or</span> <span class="number">0</span>)</span><br><span class="line">    <span class="keyword">return</span> self</span><br><span class="line"><span class="keyword">end</span></span><br></pre></td></tr></table></figure>
<p>不难看出,当你调用addTo函数不传入<code>zorder, tag</code>时会自动帮你设置为<code>0</code>!</p>
<p>知道了原因,解决起来十分容易:</p>
<ol>
<li>使用<code>addChild</code>函数代替<code>addTo</code></li>
<li>在<code>addTo</code>调用时传入<code>tag</code></li>
<li>在<code>addTo</code>调用之后调用<code>setTag</code>函数</li>
</ol>
<p>是不是很简单呢? 这主要是测试代码比较简单的原因,我当时的 setTag 和 addTo 都没有在一个文件里!!!找死我了!!</p>
<p>平复下心情,我们来想想造成这个bug的原因:</p>
<p>首先, <code>shortcodes</code>系列的函数设计的初衷可能是为了连续的调用函数,不建议分开单独使用! 但是我觉得最主要的原因是addTo函数的实现是不够健壮的,如果参考C++ addChild函数的话应该是这样子:</p>
<figure class="highlight lua"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">CCNodeExtend:addTo</span><span class="params">(target, zorder, tag)</span></span></span><br><span class="line">    target:addChild(self, zorder <span class="keyword">or</span> self:getZOrder(), tag <span class="keyword">or</span> self:getTag())</span><br><span class="line">    <span class="keyword">return</span> self</span><br><span class="line"><span class="keyword">end</span></span><br></pre></td></tr></table></figure>
<p>以上</p>
]]></content>
    </entry>
    
    <entry>
      <title><![CDATA[在mac上搭建python环境]]></title>
      <url>http://blog.justbilt.com/2014/07/02/setup_python_on_mac/</url>
      <content type="html"><![CDATA[<p>这两天重新搞了下python的环境，发现好多地方还是容易忘记，因此有了这篇文章，以后方便查看。</p>
<a id="more"></a>
<h1 id="u4E00-__u5B89_u88C5python"><a href="#u4E00-__u5B89_u88C5python" class="headerlink" title="一. 安装python"></a>一. 安装python</h1><blockquote>
<p>其实mac自带的python完全够用, 这一步可以跳过. – by Bin</p>
</blockquote>
<p>mac系统自带了一个python的执行执行环境，但为了获取最新版的python，我们需要重新安装python。这里有两种方案安装：</p>
<p>1.homebrew</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">brew install python</span><br></pre></td></tr></table></figure>
<p>这个方案比较简单,如果出错的话可以给前面加<code>sudo</code>试试,这个安装的python可能不是最新版.</p>
<p>2.从官网下载安装<br>大家可以从<a href="https://www.python.org/download" target="_blank" rel="external">https://www.python.org/download</a>下载安装最新版的python,安装比较无脑,一路按下去就OK,缺点是以后升级,卸载都得自己维护.</p>
<p>这两个方法安装的python的位置是不一样的,大家可以用:</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">which</span> python</span><br></pre></td></tr></table></figure>
<p>来查看安装位置.安装完成后在终端中键入<code>python</code>来验证安装是否成功.</p>
<h2 id="u4E8C-__u5B89_u88C5pip"><a href="#u4E8C-__u5B89_u88C5pip" class="headerlink" title="二. 安装pip"></a>二. 安装pip</h2><p>这里好多文章中说要先安装<code>easy_install</code>, 其实是不用的.</p>
<h2 id="1-_u6211_u4EEC_u5148_u83B7_u53D6pip_u5B89_u88C5_u811A_u672C_3A"><a href="#1-_u6211_u4EEC_u5148_u83B7_u53D6pip_u5B89_u88C5_u811A_u672C_3A" class="headerlink" title="1.我们先获取pip安装脚本:"></a>1.我们先获取pip安装脚本:</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">wget https://bootstrap.pypa.io/get-pip.py</span><br></pre></td></tr></table></figure>
<p>如果没有安装<code>wget</code>可以去<a href="https://bootstrap.pypa.io/get-pip.py" target="_blank" rel="external">这里</a>将所有内容复制下来,新建<code>get-pip.py</code>文件,将内容拷进去就OK了.</p>
<h2 id="2-_u5B89_u88C5pip"><a href="#2-_u5B89_u88C5pip" class="headerlink" title="2.安装pip"></a>2.安装pip</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo python get-pip.py</span><br></pre></td></tr></table></figure>
<p>用python执行刚才获取的脚本,这里sudo可以选择使用,若遇到类似这个报错则必须加sudo:<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Exception:&#10;&#10;Traceback (most recent call last):&#10;&#10;...&#10;&#10;OSError: [Errno 13] Permission denied: &#39;XXX/pip-0.7.2-py2.7.egg/EGG-INFO/dependency_links.txt&#39;&#10;&#10;Storing debug log for failure in /Users/bilt/.pip/pip.log</span><br></pre></td></tr></table></figure></p>
<p>安装成功后可以在终端中键入<code>pip</code>来检测,如果不行重启终端后尝试.</p>
<h2 id="3-_u4FEE_u6539pip_u6E90"><a href="#3-_u4FEE_u6539pip_u6E90" class="headerlink" title="3.修改pip源"></a>3.修改pip源</h2><p>在天朝,由于功夫网的原因,使用pip安装一些模块会特别慢甚至无法下载,因此我们需要修改pip的源到国内的一些镜像地址,特别感谢国内无私奉献的组织~</p>
<p>首先进入HOME路径:</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">cd</span> ~</span><br></pre></td></tr></table></figure>
<p>创建<code>.pip</code>目录:</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">mkdir .pip</span><br></pre></td></tr></table></figure>
<p>创建<code>pip.conf</code>文件:<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">touch pip.conf</span><br></pre></td></tr></table></figure></p>
<p>大家可以用自己喜欢的编辑器打开<code>pip.conf</code>文件,我现在使用的时v2ex的源,所以添加:<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">[global]&#10;index-url = http://pypi.v2ex.com/simple</span><br></pre></td></tr></table></figure></p>
<p>大家可以把<code>index-url</code>的值设置为自己实际源的地址.</p>
<p>至此pip源修改成功,以后使用pip安装模块时都会从这个源去下载安装,大家可以自行测试一下.</p>
<h1 id="u4E09-__u5176_u4ED6_u6A21_u5757_u5B89_u88C5"><a href="#u4E09-__u5176_u4ED6_u6A21_u5757_u5B89_u88C5" class="headerlink" title="三. 其他模块安装"></a>三. 其他模块安装</h1><h2 id="1-Pillow/PIL"><a href="#1-Pillow/PIL" class="headerlink" title="1.Pillow/PIL"></a>1.Pillow/PIL</h2><p>想用python处理图片,自然少不了<code>PIL</code>这个模块, 由于PIL长期没有更新了, 所以有了<code>Pillow</code>这个模块, 依赖于PIL, 新版的<code>pip</code>安装后会自带Pillow, 但是好像没有zlib模块, 所以会报错:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">File &#34;/Library/Python/2.7/site-packages/PIL/Image.py&#34;, line 1105, in paste&#10;    im.load()&#10;&#10;  File &#34;/Library/Python/2.7/site-packages/PIL/ImageFile.py&#34;, line 190, in load&#10;&#10;    d = Image._getdecoder(self.mode, d, a, self.decoderconfig)&#10;&#10;  File &#34;/Library/Python/2.7/site-packages/PIL/Image.py&#34;, line 389, in _getdecoder&#10;&#10;    raise IOError(&#34;decoder %s not available&#34; % decoder_name)&#10;&#10;IOError: decoder zip not available</span><br></pre></td></tr></table></figure>
<p>因此我们需要手动重新安装:<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo pip install -U Pillow</span><br></pre></td></tr></table></figure></p>
<p>(完)</p>
]]></content>
    </entry>
    
    <entry>
      <title><![CDATA[在Player中保存CCRenderTexture到文件]]></title>
      <url>http://blog.justbilt.com/2014/06/10/rtt_savetofile_in_player/</url>
      <content type="html"><![CDATA[<p>在 player 中调用 CCRenderTexture 的 saveToFile 函数会导致player崩溃,crash log 如下:</p>
<p><img src="http://ww2.sinaimg.cn/large/7f870d23gw1eh9yz0coh4j20rs0m8n4d.jpg" alt=""></p>
<a id="more"></a>
<p>从日志中我们可以找到这句话:</p>
<blockquote>
<p>Assertion failed: (false), function saveToFile, file /Users/bilt/Documents/quick-cocos2d-x/lib/cocos2d-x/cocos2dx/platform/mac/CCImage.mm, line 921.</p>
</blockquote>
<p>说的很清楚,CCImage.mm 的 921 行触发了断言失败,嗯,一定是我的用法不太对.</p>
<p>我们打开CCImage.mm看到下面这段代码:</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">bool</span> CCImage::saveToFile(<span class="keyword">const</span> <span class="keyword">char</span> *pszFilePath, <span class="keyword">bool</span> bIsToRGB)</span><br><span class="line">&#123;</span><br><span class="line">	assert(<span class="literal">false</span>);</span><br><span class="line">	<span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>喂,不带这样子的,分明是没有实现嘛.</p>
<p>好吧,我们试着把<code>ios/CCImage.mm</code>中的实现搬过来试试,这里我就不贴大段的代码了,拷过来编译时会出错(预料之中),我OC学的不好大家不要见怪,错误如下:</p>
<figure class="highlight smalltalk"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="class">CGImageRef</span> iref                    = <span class="class">CGImageCreate</span>(m_nWidth, m_nHeight,</span><br><span class="line">                                                    bitsPerComponent, bitsPerPixel, bytesPerRow,</span><br><span class="line">                                                    colorSpaceRef, bitmapInfo, provider,</span><br><span class="line">                                                    <span class="class">NULL</span>, <span class="keyword">false</span>,</span><br><span class="line">                                                    kCGRenderingIntentDefault);</span><br><span class="line"></span><br><span class="line"><span class="class">UIImage</span>* image                    = [[<span class="class">UIImage</span> alloc] <span class="method">initWithCGImage:</span>iref];</span><br></pre></td></tr></table></figure>
<p>这里通过<code>CGImageRef</code> 创建一个 <code>UIImage</code>, 但是 Mac os 上是没有 <code>UIImage</code> 的,首先想到的是可以寻找一个接口替换掉它,短暂Google后放弃.</p>
<p>后来想着能否直接将<code>CGImageRef</code>保存为文件,还真让我找到了,见<code>stackoverflow</code>的这个(<a href="http://stackoverflow.com/questions/1320988/saving-cgimageref-to-a-png-file" target="_blank" rel="external">戳我</a>)问题:<br><figure class="highlight smalltalk"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">void <span class="class">CGImageWriteToFile</span>(<span class="class">CGImageRef</span> image, <span class="class">NSString</span> *path) &#123;</span><br><span class="line">    <span class="class">CFURLRef</span> url = (<span class="class">CFURLRef</span>)[<span class="class">NSURL</span> <span class="method">fileURLWithPath:</span>path];</span><br><span class="line">    <span class="class">CGImageDestinationRef</span> destination = <span class="class">CGImageDestinationCreateWithURL</span>(url, kUTTypePNG, <span class="number">1</span>, <span class="class">NULL</span>);</span><br><span class="line">    <span class="class">CGImageDestinationAddImage</span>(destination, image, <span class="keyword">nil</span>);</span><br><span class="line"></span><br><span class="line">    if (!<span class="class">CGImageDestinationFinalize</span>(destination)) &#123;</span><br><span class="line">        <span class="class">NSLog</span>(@<span class="comment">"Failed to write image to %@"</span>, path);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="class">CFRelease</span>(destination);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>大家可以看到关键的函数是<code>CGImageDestinationCreateWithURL</code> ,大概查了一下这个函数支持的格式还真不少,如下:</p>
<figure class="highlight smalltalk"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">extern const <span class="class">CFStringRef</span> kUTTypeImage                                __OSX_AVAILABLE_STARTING(__MAC_10_4,__IPHONE_3_0);</span><br><span class="line">extern const <span class="class">CFStringRef</span> kUTTypeJPEG                                 __OSX_AVAILABLE_STARTING(__MAC_10_4,__IPHONE_3_0);</span><br><span class="line">extern const <span class="class">CFStringRef</span> kUTTypeJPEG2000                             __OSX_AVAILABLE_STARTING(__MAC_10_4,__IPHONE_3_0);</span><br><span class="line">extern const <span class="class">CFStringRef</span> kUTTypeTIFF                                 __OSX_AVAILABLE_STARTING(__MAC_10_4,__IPHONE_3_0);</span><br><span class="line">extern const <span class="class">CFStringRef</span> kUTTypePICT                                 __OSX_AVAILABLE_STARTING(__MAC_10_4,__IPHONE_3_0);</span><br><span class="line">extern const <span class="class">CFStringRef</span> kUTTypeGIF                                  __OSX_AVAILABLE_STARTING(__MAC_10_4,__IPHONE_3_0);</span><br><span class="line">extern const <span class="class">CFStringRef</span> kUTTypePNG                                  __OSX_AVAILABLE_STARTING(__MAC_10_4,__IPHONE_3_0);</span><br><span class="line">extern const <span class="class">CFStringRef</span> kUTTypeQuickTimeImage                       __OSX_AVAILABLE_STARTING(__MAC_10_4,__IPHONE_3_0);</span><br><span class="line">extern const <span class="class">CFStringRef</span> kUTTypeAppleICNS                            __OSX_AVAILABLE_STARTING(__MAC_10_4,__IPHONE_3_0);</span><br><span class="line">extern const <span class="class">CFStringRef</span> kUTTypeBMP                                  __OSX_AVAILABLE_STARTING(__MAC_10_4,__IPHONE_3_0);</span><br><span class="line">extern const <span class="class">CFStringRef</span> kUTTypeICO                                  __OSX_AVAILABLE_STARTING(__MAC_10_4,__IPHONE_3_0);</span><br></pre></td></tr></table></figure>
<p>这下可爽了,保存<code>png</code>和<code>jpg</code>都可以,我对这个函数进行了微小的改造,将<code>kUTTypePNG</code>作为参数传入,一番修改之后<code>saveToFile</code>函数的关键代码变成了这个样子:<br><figure class="highlight smalltalk"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="class">CGDataProviderRef</span> provider        = <span class="class">CGDataProviderCreateWithData</span>(<span class="class">NULL</span>, pixels, myDataLength, <span class="class">NULL</span>);</span><br><span class="line"><span class="class">CGColorSpaceRef</span> colorSpaceRef    = <span class="class">CGColorSpaceCreateDeviceRGB</span>();</span><br><span class="line"><span class="class">CGImageRef</span> iref                    = <span class="class">CGImageCreate</span>(m_nWidth, m_nHeight,</span><br><span class="line">                                                    bitsPerComponent, bitsPerPixel, bytesPerRow,</span><br><span class="line">                                                    colorSpaceRef, bitmapInfo, provider,</span><br><span class="line">                                                    <span class="class">NULL</span>, <span class="keyword">false</span>,</span><br><span class="line">                                                    kCGRenderingIntentDefault);</span><br><span class="line">if (saveToPNG)</span><br><span class="line">&#123;</span><br><span class="line">    <span class="class">CGImageWriteToFile</span>(iref,[<span class="class">NSString</span> <span class="method">stringWithUTF8String:</span>pszFilePath], kUTTypePNG);</span><br><span class="line">&#125;</span><br><span class="line">else</span><br><span class="line">&#123;</span><br><span class="line">    <span class="class">CGImageWriteToFile</span>(iref,[<span class="class">NSString</span> <span class="method">stringWithUTF8String:</span>pszFilePath], kUTTypeJPEG);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>重新编译运行player,运行<code>samples/cocos2dx_luatest</code>,找到<code>RenderTextureTest</code> 点击 <code>SaveImage</code> ,这下不会崩溃了,在例题的根目录可以找到保存的图片.</p>
<blockquote>
<p>这个更改已经提交pr并且已经merge到了develop分支,详情可以戳<a href="https://github.com/chukong/quick-cocos2d-x/pull/370/files" target="_blank" rel="external">这里</a>.</p>
</blockquote>
<p>这里说下我的感悟:</p>
<ol>
<li><p>Quickx 的 player 真的是个特别棒的东西,这里不得不佩服@廖大 ,绝对是提高效率的利器, 但是我们经常会看到player的一些行为和真机不太一样, 这时不能放弃player, player的本质就是cocos2d-x的Mac版, 根据这个去找寻解决方案会非常的方便.</p>
</li>
<li><p>这个问题是发生在quick 2.2.2 中的, 因为quick的最新版是2.2.3, 所以我会先去那里找看有没有解决这个问题, 发现没有, 然后我会去cocos2d-x 的2.2.3找解决方案,因为本是一家东西, 发现还是没有没有, 接下来我发现cocos2d-x 3.x 版本解决了这个问题, 3.x完全用C++ 实现了保存png,jpg的功能, 在各个平台都管用, 这个非常赞, 但是迁移过来成本太高, 会有一堆依赖改变的地方, 所以不到迫不得已是不会自己实现的.</p>
</li>
<li><p>这个问题好像遇到的人特别少,唯一在官网有一个人提问(看<a href="http://discuss.cocos2d-x.org/t/screenshot-on-mac/8211" target="_blank" rel="external">这里</a>),但是没有回答,看版本是2.1.4,这应该算是历史遗留问题了.</p>
</li>
</ol>
<p>(全文完)</p>
]]></content>
    </entry>
    
    <entry>
      <title><![CDATA[盘点 quick-cocos2d-x Player 粗线的问题]]></title>
      <url>http://blog.justbilt.com/2014/05/17/some_problem_of_player/</url>
      <content type="html"><![CDATA[<h2 id="u4E00-_Mac_u7248_u65E5_u5FD7_u663E_u793A_u4E0D_u5B8C_u6574"><a href="#u4E00-_Mac_u7248_u65E5_u5FD7_u663E_u793A_u4E0D_u5B8C_u6574" class="headerlink" title="一. Mac版日志显示不完整"></a>一. Mac版日志显示不完整</h2><p>不知道大家有没有遇到这样的问题,在输出大量log的时候,Player的日志窗口有时会只输出一部分内容,后面补上<code>...</code>, 而且之后的log就再也无法输出了, 对后面的调试造成很大的不便.</p>
<a id="more"></a>
<p>打开Player的工程,搜索<code>...</code>,可以定位到 <code>ConsoleWindowController.m</code> 的 trace 函数,让我们看下这个代码片段:</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> (traceCount &gt;= SKIP_LINES_COUNT &amp;&amp; [msg length] &gt; MAX_LINE_LEN)</span><br><span class="line">&#123;</span><br><span class="line">    msg = [NSString stringWithFormat:@<span class="string">"%@ ..."</span>, [msg substringToIndex:MAX_LINE_LEN - <span class="number">4</span>]];</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">traceCount++;</span><br></pre></td></tr></table></figure>
<p>大家把这几行注释掉重新编译运行即可解决这个问题.</p>
<h2 id="u4E8C-_Mac_u7248_CCClippingNode__u65E0_u6548"><a href="#u4E8C-_Mac_u7248_CCClippingNode__u65E0_u6548" class="headerlink" title="二. Mac版 CCClippingNode 无效"></a>二. Mac版 CCClippingNode 无效</h2><p>又到了做新手引导的时候了,之前发过两篇关于新手引导的文章:</p>
<p><a href="http://post.justbilt.com/2013/07/12/cocos2d-x-%E6%B8%B8%E6%88%8F%E5%AE%9E%E6%88%98%E7%BB%8F%E9%AA%8C%E4%BA%8C-%E6%96%B0%E6%89%8B%E5%BC%95%E5%AF%BC%E4%B8%8A/" target="_blank" rel="external">cocos2d-x-游戏实战经验三-多分辨率的自适应(上)</a><br><a href="http://post.justbilt.com/2013/08/02/cocos2d-x-%E6%B8%B8%E6%88%8F%E5%AE%9E%E6%88%98%E7%BB%8F%E9%AA%8C%E4%B8%89-%E5%A4%9A%E5%88%86%E8%BE%A8%E7%8E%87%E7%9A%84%E8%87%AA%E9%80%82%E5%BA%94%E4%B8%8B/" target="_blank" rel="external">cocos2d-x-游戏实战经验三-多分辨率的自适应(下)</a></p>
<p>看过的朋友应该知道,想实现屏幕中某一部分高亮需要用到CCClipingNde, 这是一个非常实用的功能类.这设置stencil之后会抠空stencil的内容</p>
<p>但是当我在<strong>quick-cococs2d-x</strong>中用player中运行<strong>CCClipingNde</strong>时,却发现没有任何的变化.</p>
<p>网上搜索 <code>CCClippingNode无效</code> 会找到几篇文章,都一直的指向OpenGL初始化的地方:</p>
<p><img src="http://ww2.sinaimg.cn/large/7f870d23jw1egh5qaaxw7j20i70gngnc.jpg" alt=""></p>
<p>试着用xocde启动项目工程,意外的发现<strong>CCClipingNde</strong>在ios的模拟器是好使的,这样看来问题是出在了Player的身上,打开quick的player工程,不难发现player实质上就是在cocos2d-x的Mac版的基础上做成的,这样的话造成这个问题的原因不外乎有两个:</p>
<ol>
<li>cocos2d-x 的Mac不支持 CCClipingNde </li>
<li>quick-cocos2d-x 的Playe 的openGL初始化有问题</li>
</ol>
<p>运行官方2.2.1版cocos2d-x的mac项目,发现CCClippingNode是没有问题的,正常运行.</p>
<p>在对比两个项目的AppController.mm发现了不一致的地方:</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// player</span></span><br><span class="line">glView = [[EAGLView alloc] initWithFrame:rect];</span><br><span class="line"></span><br><span class="line"><span class="comment">//coco2d-x for mac</span></span><br><span class="line">NSOpenGLPixelFormatAttribute attributes[] = &#123;</span><br><span class="line">	NSOpenGLPFADoubleBuffer,</span><br><span class="line">	NSOpenGLPFADepthSize, <span class="number">24</span>,</span><br><span class="line">	NSOpenGLPFAStencilSize, <span class="number">8</span>,</span><br><span class="line">	<span class="number">0</span></span><br><span class="line">&#125;;</span><br><span class="line">NSOpenGLPixelFormat *pixelFormat = [[[NSOpenGLPixelFormat alloc] initWithAttributes:attributes] autorelease];</span><br><span class="line">glView = [[EAGLView alloc] initWithFrame:rect pixelFormat:pixelFormat];</span><br></pre></td></tr></table></figure>
<p>用官方的实现替换Player的实现,编译运行,一切正常,下面上张图!</p>
<p><img src="http://ww1.sinaimg.cn/large/7f870d23jw1egh68oa3ahj206q08iaa6.jpg" alt=""></p>
<h2 id="u672A_u5B8C"><a href="#u672A_u5B8C" class="headerlink" title="未完"></a>未完</h2><p>暂时只遇到了这两个问题,都比较容易解决,以后遇到问题还会在这里补充!</p>
]]></content>
    </entry>
    
    <entry>
      <title><![CDATA[我的2013]]></title>
      <url>http://blog.justbilt.com/2014/05/01/my-2013/</url>
      <content type="html"><![CDATA[<p>是的,你没有看错,今天是2014年5月1日,我却在写2013的总结,这篇文章无论怎么讲都是有些姗姗来迟的.其实早在2月份就想写了,只是一直苦于没有时间,现在却是有了~</p>
<a id="more"></a>
<h2 id="u5DE5_u4F5C"><a href="#u5DE5_u4F5C" class="headerlink" title="工作"></a>工作</h2><h3 id="A"><a href="#A" class="headerlink" title="A"></a>A</h3><p>2013年5月,我离开了呆了快两年(2011.9~2013.5)的公司A,A是我的第一家公司,是一个相对较大的公司,对A我有着很深的感情,在这里我从一个刚学会写代码的新手慢慢的成长了起来,有几个特别好的朋友.</p>
<p>至于离开A的原因,在一个地方呆久了就会想着出去走走,虽然外面不一定好.</p>
<p><img src="http://ww1.sinaimg.cn/large/7f870d23tw1efylp6ug4zj20ds0alq4c.jpg" alt=""></p>
<p>上一张照片,左一是我,依次是宏ppt,超ppt,还有照相的菲ppt,找到一个一起2的朋友已非易事,我找到了一群.</p>
<p>技术上呢巩固了学校里学的c++,跟着老大学习了一些架构方面的东西,做了一个多人联网的坦克游戏,顺带学习了MFC,做了个地图编辑器.然后跟朋友学会了cocos2d-x,一起做了一两个游戏.</p>
<h3 id="B"><a href="#B" class="headerlink" title="B"></a>B</h3><p>下面我到了公司B,B是一个小公司,之前主要做美术/动画外包,一共不到10个人,程序呢只有我一个人,哈哈,这简直是虎入羊群啊,在这里我获得了极大的自由和极大的权利,程序上的什么东西能做与否都是我一句话,我很享受这种感觉~</p>
<p>在B,公司氛围极好,我真的感觉是为自己做游戏,为了一个功能经常大家加班至深夜,大家为了一个系统会吵得面红耳赤,然后下楼吃饭~</p>
<p>另一面,B的缺点,决策失误,没有运营~ 这直接导致的后果就是产品出来了上不去,在B我们不到3个月就做了一个类似&lt;保卫萝卜&gt;的游戏,但是在发了移动基地后就沦入一个无线修改,无限增删功能,无限立项的循环中~</p>
<p>在B的后面几个月是十分轻松的,大家看到的<a href="/blog.justbilt.com">blog.justbilt.com</a>的大部分文章都是在这端时间写的,在B的这段时间中,我对2dx有了更加深入的了解,一些之前没有关注的问题也有了研究~写博客真的是一件极好的事情,通过博客认识了好多朋友.</p>
<p>种种原因,决定在2013年元旦离开B,有想学习更高技术的原因,也有心凉了的原因~</p>
<p><img src="http://ww1.sinaimg.cn/large/7f870d23tw1efyn0q9u0nj20dq06qmxy.jpg" alt=""></p>
<p>如果说有一张图能代表我在B的这段经历的话,那么就是这张了,感谢你们伴我走过这些天~</p>
<p>技术上呢2dx运用更加熟练,全面,全平台打包,jni,ios混编,ios发布,多分辨率适应~工具制作上我放弃了MFC,学习了下C#,用C#做一些小工具比MFC方便好多,再后来发现用Python写小工具更Easy,就自学了Python,现在已经能用来写小工具了.博客呢放弃了wordpress,投奔了hexo,项目管理改用了git.</p>
<h2 id="u751F_u6D3B"><a href="#u751F_u6D3B" class="headerlink" title="生活"></a>生活</h2><p>有人说,生活就像一杯白开水,平平淡淡最好,我觉得也是.</p>
<p>2013年最重要的事情就是我<code>订婚啦</code>,和我相处了两年的女友我们的关系终于又进了一步,女友的性格和我十分互补,十分懂事,我们一定会幸福的~</p>
<p>其次就是了解并重视了pm2.5,于是在下半年停止了每周的篮球活动,买了3M的口罩,基本上每天都戴,想起以前夏天开着窗户睡觉,大雾天去打篮球,感觉自己真TM在作死~ 其他行业我说不上,但作为一个程序员,你如果不重视pm2.5的话,那就等同于用<code>百度</code>,用<code>ie</code>,对自己好一些吧!</p>
<p>恩,2013年就这样过去了,这一年发生了很多变化,我也成熟了很多,2014一定会更好.</p>
]]></content>
    </entry>
    
    <entry>
      <title><![CDATA[友盟渠道包工具]]></title>
      <url>http://blog.justbilt.com/2014/03/19/umeng_apk_tools/</url>
      <content type="html"><![CDATA[<p>游戏做完了,在国内发android包是一件很痛苦的事情,应用市场多达100多家,不说都上吧,就是上10来个也够咱们喝一壶的了,而且每次更新版本都得这么做:(,想想还是应该有个批量打包的工具!</p>
<a id="more"></a>
<h2 id="1-_u95EE_u9898"><a href="#1-_u95EE_u9898" class="headerlink" title="1.问题"></a>1.问题</h2><p>之前在微博上看到王峰的一张表,里面大概有百八十个渠道,后来找不到了,只找到了下面这张图:</p>
<p><img src="http://ww2.sinaimg.cn/large/7f870d23jw1eekv0hmikaj20dw06vaam.jpg" alt="国内部分应用商店"></p>
<p>实现自动化的思路的大概有两个:</p>
<ol>
<li>使用ant工具,写编译脚本</li>
<li>打出一个Apk包,使用拆包工具分解Apk,修改<code>AndroidManifest.xml</code> 文件后，再重新打包</li>
</ol>
<h2 id="2-_u4E0B_u8F7D_u5B89_u88C5"><a href="#2-_u4E0B_u8F7D_u5B89_u88C5" class="headerlink" title="2.下载安装"></a>2.下载安装</h2><p>友盟渠道打包工具就是按照第二个思路实现的,官方github仓库在<a href="https://github.com/umeng/umeng-muti-channel-build-tool" target="_blank" rel="external">这里</a>,windows版的下载地址在<a href="https://github.com/umeng/umeng-muti-channel-build-tool/blob/master/Downloads/UmengTools(Green)V2.1.zip" target="_blank" rel="external">这里</a>,现在貌似只有windows7版的(偷乐)!</p>
<p>如果你恰好接入了友盟的统计,那么就可以爽了!</p>
<p>下载完成后,解压,运行<code>UmengTools.exe</code>后会检测Java环境,需要安装JDK,可以去<a href="http://www.oracle.com/technetwork/java/javase/downloads/jdk7-downloads-1880260.html" target="_blank" rel="external">这里</a>下,然后把类似这个路径<code>C:\Program Files\Java\jdk1.7.0_45\bin</code>加入到环境变量中去.</p>
<h2 id="3-_u4F7F_u7528"><a href="#3-_u4F7F_u7528" class="headerlink" title="3.使用"></a>3.使用</h2><p>启动<strong>UmengTools</strong>后你就会看到一个非常高大上的界面:</p>
<p><img src="http://ww1.sinaimg.cn/large/7f870d23jw1eekxijxt9tj20m80go0u2.jpg" alt=""></p>
<p>然后点击1位置的扳手图标,会弹出配置界面,如图:</p>
<p><img src="http://ww1.sinaimg.cn/large/7f870d23jw1eekxppu1iej20iw0egmyn.jpg" alt=""></p>
<ol>
<li>KeyStore中填入你签名文件的路径,password栏填入创建签名文件时的密码</li>
<li>Alias栏填入这个应用的名称,password栏填入密码</li>
<li>要添加,删除渠道在渠道栏配置</li>
<li>在配置文件栏填入配置文件名称</li>
<li>点击保存</li>
</ol>
<p>然后将你通过eclipse导出的签名包拖拽到2的位置,点击一键打包可以冲杯咖啡等待成功了!</p>
]]></content>
    </entry>
    
    <entry>
      <title><![CDATA[将一堆小图转化为BMFont工具]]></title>
      <url>http://blog.justbilt.com/2014/02/01/images_to_bmfont/</url>
      <content type="html"><![CDATA[<p>学习了Python也有一段时间了,一直在看书啊什么的,没有写些东西,感觉这样不太好,刚好项目中需要一个CCLabrlTTF但美术妹纸只给了一堆散图,自己写一个小工具吧!<br><a id="more"></a></p>
<blockquote>
<p>2014年4月11日更新:</p>
<ol>
<li>去除了<code>ImageMagick</code>的依赖,改用<code>PIL</code></li>
<li>用<code>Pyinstaller</code>打包出了win32和mac的可执行程序,不用安装任何东西了!</li>
</ol>
</blockquote>
<p>发现之前写的那个脚本依赖的东西太多了,加上最近对Python的了解又有所增加,所以重写了这个工具,变得更加易用了,小伙伴赶紧更新下吧~</p>
<h3 id="u4E00-_u4F7F_u7528"><a href="#u4E00-_u4F7F_u7528" class="headerlink" title="一.使用"></a>一.使用</h3><p>新版的工具已经不需要安装任何附属的东西了,只需两步,就可解脱~</p>
<h4 id="1_29-_u4FEE_u6539_u56FE_u7247_u540D"><a href="#1_29-_u4FEE_u6539_u56FE_u7247_u540D" class="headerlink" title="1).修改图片名"></a>1).修改图片名</h4><p>这一步十分容易,我们约定一个规则,规定图片的命名为<code>x_y.png</code>,这样x就是最终<code>.fnt</code>和<code>.png</code>的名字,而y就是对应字符的ASCII码,这样我的图片最后命名是这个样子的:</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">fighting_header_shuzi_48.png 	<span class="comment">#0</span></span><br><span class="line">fighting_header_shuzi_49.png 	<span class="comment">#1</span></span><br><span class="line">fighting_header_shuzi_50.png 	<span class="comment">#2</span></span><br><span class="line">fighting_header_shuzi_51.png 	<span class="comment">#3</span></span><br><span class="line">fighting_header_shuzi_52.png 	<span class="comment">#4</span></span><br><span class="line">fighting_header_shuzi_53.png 	<span class="comment">#5</span></span><br><span class="line">fighting_header_shuzi_54.png 	<span class="comment">#6</span></span><br><span class="line">fighting_header_shuzi_55.png 	<span class="comment">#7</span></span><br><span class="line">fighting_header_shuzi_56.png 	<span class="comment">#8</span></span><br><span class="line">fighting_header_shuzi_57.png 	<span class="comment">#9</span></span><br><span class="line">fighting_header_shuzi_109.png 	<span class="comment">#m</span></span><br></pre></td></tr></table></figure>
<p>最后一个m是因为我的图片中包含了一个<code>m</code>字样的图片,具体ascii码表可以在<a href="http://www.weste.net/tools/ASCII.asp" target="_blank" rel="external">这里</a>查.</p>
<h4 id="2_29-_u4E0B_u8F7D_u53EF_u6267_u884C_u7A0B_u5E8F"><a href="#2_29-_u4E0B_u8F7D_u53EF_u6267_u884C_u7A0B_u5E8F" class="headerlink" title="2).下载可执行程序"></a>2).下载可执行程序</h4><blockquote>
<p>这两个文件的同级目录我放了一组测试图片,大家可以一并下下来测试~</p>
</blockquote>
<p><strong>windows:</strong></p>
<p>从<a href="https://github.com/justbilt/fnt_convert/blob/master/bin/win32" target="_blank" rel="external">这里</a>下载images2fnt.exe,在你的碎图目录双击运行</p>
<p><strong>mac:</strong></p>
<p>从<a href="https://github.com/justbilt/fnt_convert/blob/master/bin/mac" target="_blank" rel="external">这里</a>下载images2fnt,在你的碎图目录启动终端,键入<code>./images2fnt</code></p>
<p>然后…然后就神奇的东西出现了呢,在<code>output</code>目录下会找到你想要的东西~</p>
<h3 id="u4E8C-_u9879_u76EE"><a href="#u4E8C-_u9879_u76EE" class="headerlink" title="二.项目"></a>二.项目</h3><p>工程已开源到github上,点击<a href="https://github.com/justbilt/fnt_convert" target="_blank" rel="external">这里</a>查看,项目采用Python编写,主要依赖了这几个库:</p>
<ol>
<li>Pillow</li>
<li>Pyinstaller</li>
</ol>
<p>Pillow是Python的图片处理库,前身是Pil,项目使用Pillow拼接图片,获取图片信息.<br>Pyinstaller是Python的一个发布工具,会将代码打包成可执行文件,十分方便.</p>
<h2 id="28_u5168_u6587_u5B8C_29"><a href="#28_u5168_u6587_u5B8C_29" class="headerlink" title="(全文完)"></a>(全文完)</h2>]]></content>
    </entry>
    
    <entry>
      <title><![CDATA[在MacOS上搭建mafiagame版的quick-cocos2d-x]]></title>
      <url>http://blog.justbilt.com/2014/01/26/quickx_on_mac/</url>
      <content type="html"><![CDATA[<h1 id="u4E00-Why_mafiagame_3F"><a href="#u4E00-Why_mafiagame_3F" class="headerlink" title="一.Why mafiagame?"></a>一.Why mafiagame?</h1><p>为什么要用mafiagame版的quick-cocos2d-x(以下简称quick)呢?我在使用quick时候遇到了很多坑,改了quick好多代码,主要还是cocosbuilder(以下简称ccb)方面的,为了方便其他同事,就在quick的基础上做了一个分支,提交我的这些修改,<strong>修改基于quick的最新2.2.1-rc</strong>,关于具体的坑会单独开一篇文章来写,这里就不做赘述了.<br><a id="more"></a></p>
<h1 id="u4E8C-_u514B_u9686_u4ED3_u5E93_u5230_u672C_u5730"><a href="#u4E8C-_u514B_u9686_u4ED3_u5E93_u5230_u672C_u5730" class="headerlink" title="二.克隆仓库到本地"></a>二.克隆仓库到本地</h1><p>Ps:如果你比较熟悉git和github的话,这部分可以跳过了,没有什么技术含量.</p>
<h3 id="1-_u5DE5_u5177_u9009_u62E9"><a href="#1-_u5DE5_u5177_u9009_u62E9" class="headerlink" title="1.工具选择"></a>1.工具选择</h3><ul>
<li><p><strong>Github For Mac</strong>,好多git的新手会选择使用Github For Mac,我不太推荐这么做,因为Github的客户端隐藏了好多东西,非常容易误操作并且对git的使用一点帮助也没有,</p>
</li>
<li><p><strong>git command tool</strong>,我也不推荐一上来就使用git的命令行工具,一来上手难度太大,二来效率太低.</p>
</li>
<li><p><strong>SourceTree</strong>,在使用SourceTree之前我用过gitGUI,感觉差距太大了,SourceTree绝对是Mac上最好用的git GUI工具,没有之一.下面我详细讲述一下使用SourceTree获取最新代码</p>
</li>
</ul>
<h3 id="2-_u5B89_u88C5SourceTree"><a href="#2-_u5B89_u88C5SourceTree" class="headerlink" title="2.安装SourceTree"></a>2.安装SourceTree</h3><p>工具大家可以从<a href="http://sourcetreeapp.com/" target="_blank" rel="external">这里</a>获取,下载完成后安装打开,该同意的同意,能跳过的跳过,大家就能见到这个画面了:<br><img src="http://ww1.sinaimg.cn/large/7f870d23jw1ecx5w2og63j20ho0jcgmf.jpg" alt=""></p>
<p>忽略我上面的东西,点击左上角有<code>+</code>号字样的第一个图标<strong>添加仓库</strong>,就会看到下面这个画面:</p>
<p>在地址栏填入<a href="https://github.com/mafiagame/quick-cocos2d-x.git" target="_blank" rel="external">https://github.com/mafiagame/quick-cocos2d-x.git</a>这个地址,选择clone到<code>/Users/xxxx/Documents/quick-cocos2d-x</code>这个路径下,书签名设置为<code>quick-cocos2d-x</code>,推荐打开下面的高级选项,在brunch框中填入<code>mafiagame</code>,这样可以只迁出mafiagame分支,减少clone的时间:</p>
<p>漫长的等待时间结束后,双击书签<code>quick-cocos2d-x</code>就可以进入这个画面了,进到这里就结束了克隆代码的步骤就结束了.<br><img src="http://ww1.sinaimg.cn/large/7f870d23jw1ecx7e1oywgj21720rk7di.jpg" alt=""></p>
<h3 id="3-_u5207_u6362_u5230mafiagame_u5206_u652F"><a href="#3-_u5207_u6362_u5230mafiagame_u5206_u652F" class="headerlink" title="3.切换到mafiagame分支"></a>3.切换到mafiagame分支</h3><p>如果你上步在brunch框中填入了<code>mafiagame</code>,这步就可略过了,但是如果没有,就需要切换分支了.</p>
<ol>
<li>点击工具栏的<code>Checkout</code></li>
<li>在弹出框中点击<code>Checkout New Branch</code></li>
<li>选择远端的<code>origin/mafiagame</code>分支</li>
<li>点击<code>OK</code>,等待,切换成功,步骤图如下</li>
</ol>
<p><img src="http://ww1.sinaimg.cn/large/7f870d23jw1ecxuv0vkj6j20ta08uju7.jpg" alt=""></p>
<h1 id="u4E09-_u642D_u5EFASublime_u5F00_u53D1_u73AF_u5883"><a href="#u4E09-_u642D_u5EFASublime_u5F00_u53D1_u73AF_u5883" class="headerlink" title="三.搭建Sublime开发环境"></a>三.搭建Sublime开发环境</h1><p>关于Sublime的简介大家可以自行搜索,我们用它作为开发环境的主要原因是<a href="http://my.oschina.net/lonewolf/blog/176266" target="_blank" rel="external">lonewolf</a>小伙伴为Sublime做了非常实用的插件<strong>QuickXDev</strong>,非常屌,大家可以慢慢体会.</p>
<h3 id="1-_u4E0B_u8F7D_u5B89_u88C5"><a href="#1-_u4E0B_u8F7D_u5B89_u88C5" class="headerlink" title="1.下载安装"></a>1.下载安装</h3><p>大家在<a href="http://www.sublimetext.com/" target="_blank" rel="external">这里</a>可以很轻松的获取Sublime的最新版本,安装后打开,可以看到这个画面:<br><img src="http://ww2.sinaimg.cn/large/7f870d23jw1ecx7lzwmtxj20jg0gjdge.jpg" alt=""></p>
<h3 id="2-_u5B89_u88C5package_control_u7EC4_u4EF6"><a href="#2-_u5B89_u88C5package_control_u7EC4_u4EF6" class="headerlink" title="2.安装package control组件"></a>2.安装package control组件</h3><ol>
<li>按<code>Ctrl+` </code>调出console</li>
<li>粘贴以下代码到底部命令行并回车：<br><strong><br>import urllib2,os;pf=’Package Control.sublime-package’;ipp=sublime.installed_packages_path();os.makedirs(ipp) if not os.path.exists(ipp) else None;open(os.path.join(ipp,pf),’wb’).write(urllib2.urlopen(‘<a href="http://sublime.wbond.net/&#39;+pf.replace(" target="_blank" rel="external">http://sublime.wbond.net/&#39;+pf.replace(</a>‘ ‘,’%20’)).read())
</strong></li>
<li>等待一段时间</li>
<li>重启Sublime Text 2。</li>
<li>如果在Perferences-&gt;package settings中看到package control这一项，则安装成功。</li>
</ol>
<h3 id="3-_u5B89_u88C5QuickXDev"><a href="#3-_u5B89_u88C5QuickXDev" class="headerlink" title="3.安装QuickXDev"></a>3.安装QuickXDev</h3><ol>
<li>按<code>⌘+Shift+P</code>键打开<code>package control</code>,在弹出的框中输入<code>Install Package</code>,选择对应条目回车.</li>
<li>稍等片刻后会弹出另一个输入框,输入<code>QuickXDev</code>回车,等待安装成功.</li>
<li>重启Sublime,在<code>Perferences-&gt;package settings</code>中看到QuickXDev这一项，则安装成功。</li>
<li>打开<code>Perferences-&gt;package settings -&gt;QuickXDev -&gt;QuickXDev.sublime-settings</code>,在打开的文本中<br>输入<code>quick_cocos2dx_root</code>,如下图:<br><img src="http://ww2.sinaimg.cn/large/7f870d23jw1ecx868doczj20re0gj402.jpg" alt=""></li>
</ol>
<h3 id="4-_u8FD0_u884C_u793A_u4F8B_u9879_u76EE"><a href="#4-_u8FD0_u884C_u793A_u4F8B_u9879_u76EE" class="headerlink" title="4.运行示例项目"></a>4.运行示例项目</h3><ol>
<li>按<code>⌘+k,b</code>键打开左侧Side Bar</li>
<li>在Finder中找到<code>quick-cocos2d-x</code>目录,拖拽到Side Bar上</li>
<li>在Side Bar上展开<code>quick-cocos2d-x -&gt; samples -&gt; coinflip</code>,在<code>scripts</code>文件夹上右键<code>Run With Player</code>,如下图:<br><img src="http://ww1.sinaimg.cn/large/7f870d23jw1ecxu1qcduzj20c80dddh5.jpg" alt=""></li>
<li>然后就会看到官方的这个示例了,下面开始lua之旅吧</li>
</ol>
<p><img src="http://ww4.sinaimg.cn/large/7f870d23jw1ecxu86hshsj20kw0kljw9.jpg" alt=""></p>
<h3 id="u56DB-_u540E_u8BB0"><a href="#u56DB-_u540E_u8BB0" class="headerlink" title="四.后记"></a>四.后记</h3><p>这里并没有讲Android环境的搭建,是因为quick官网上已经有了详细的教程了,大家去看<a href="http://cn.quick-x.com/?p=415" target="_blank" rel="external">这篇</a>文章就OK,至于为什么不给官方提交<code>pull request</code>,有以下几个原因:</p>
<ol>
<li>我的代码习惯,提交规范和quick不知有无差异</li>
<li>我做的更改多数在ccb方面,quick官方明显排斥ccb</li>
<li>我添加了一些工具类,比较个人化,推广开来可能不适用</li>
</ol>
<p>综上,我没有提交给quick仓库,但是如果quick有需要的话,我还是十分乐意合并过去的.</p>
<h3 id="28_u5168_u6587_u5B8C_29"><a href="#28_u5168_u6587_u5B8C_29" class="headerlink" title="(全文完)"></a>(全文完)</h3>]]></content>
    </entry>
    
    <entry>
      <title><![CDATA[在Command Line中使用TexturePacker]]></title>
      <url>http://blog.justbilt.com/2013/12/12/use_tp_on_command_line/</url>
      <content type="html"><![CDATA[<p>TexturePacker是一个非常好用的小图合并工具,介绍它的文章非常多,多数都是使用GUI工具的,但是:</p>
<ol>
<li>如果原始图片发生了改变,我们就需要重新手动拼接一下,麻烦.</li>
<li>使用GUI界面<strong>非常不高端</strong>,我高大猿族绝对首选使用Command Line啊.</li>
</ol>
<p>安装TexturePacker会附带一个command line工具,让我们一起学习一下如何使用吧.<br><a id="more"></a></p>
<p>##环境搭建<br>我一般首选在Windows下开发(不要打我),这里就只讲Windows环境的配置</p>
<p>1.先去<a href="http://www.codeandweb.com/texturepacker" target="_blank" rel="external">这里</a>下载安装文件,完成后一路无脑下一步,OK.</p>
<p>2.大家在<code>C:\Program Files\TexturePacker\bin</code>目录下可以看到两个exe文件,<code>TexturePacker.exe</code>和<code>TexturePackerGUI.exe</code>,前者是命令行工具,后者是GUI工具.</p>
<p>3.默认<code>TexturePacker</code>是没有加到环境变量中的,我们需要手动来,右键点击<strong>计算机</strong>-&gt;<strong>属性</strong>-&gt;<strong>高级系统设置</strong>-&gt;<strong>环境变量</strong>,找到<code>PATH</code>后将<code>C:\Program Files\TexturePacker\bin</code>添加到末尾,注意要在前面加<code>;</code>.</p>
<p>4.运行cmd,输入<code>TexturePacker</code>大家应该能够看到下面的内容:<br><img src="http://ww1.sinaimg.cn/large/7f870d23jw1ebgr9fza56j20mo08rabj.jpg" alt=""><br>如果不能的话请检查拼写和第<code>2</code>步.大家可以仔细阅读一下内容,写的十分详细,用过TexturePacker的话基本上都能对应起来.</p>
<p>##小试牛刀<br>你过你看完打印出的信息的话可以发下末尾部分有三个示例,如下:<br><img src="http://ww4.sinaimg.cn/large/7f870d23jw1ebgrdsac69j20qj06rgmj.jpg" alt=""><br>看起啦十分简单,让我们试一下吧,感谢微博小伙伴<a href="http://weibo.com/1061005610/A8lXXwagW" target="_blank" rel="external">@sosoayaen</a>发现的小秘密,使得我们可以快速的在任意位置打开命令行.找一个有这一堆图片的文件夹的上层目录,按住<code>Shift</code>点击<code>右键</code>,会发现一个菜单项<code>在当前目录打开命令行</code>,打开后按照示例输入<code>TexturePacker 001/*.png</code>,然后如示例说的:</p>
<blockquote>
<p>creates out.plist and out.png from all png files in assets<br> trimming all files and creating a texture with max. 2048x2048px</p>
</blockquote>
<p>实际情况却不完全是这样的,你可能会得到这样的错误:</p>
<p><img src="http://ww1.sinaimg.cn/large/7f870d23jw1ebgt6ya8d9j20iq0820te.jpg" alt=""><br>卧槽,这是什么情况啊,明明就是按照官方的示例来的嘛,google完全没有任何答案啊,经过一番痛苦的实验后,终于发现了原因所在,这里不能输入:<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">TexturePacker 001/*.png</span><br></pre></td></tr></table></figure></p>
<p>而应该是这个样子:<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">TexturePacker 001</span><br></pre></td></tr></table></figure></p>
<p><strong>这个问题可能是由于我使用的版本太旧或使用Windows导致的,如果你没有遇到,那么最好!</strong></p>
<p>##参数详解<br>本想着把所有参数都讲一遍,写到一半发现卧槽太多了,而且好些都用不到,这里挑一些常用的分析下,<strong>以下内容都有进行测试</strong>,还是比较准确的,如果有问题,欢迎指出.<br>注:</p>
<ol>
<li>选项含有<code>&lt;...&gt;</code>的选项表示含有参数需要填写.</li>
<li>粗体表示比较重要的选项.</li>
</ol>
<h2 id="23_23_23_23_u8F93_u51FA"><a href="#23_23_23_23_u8F93_u51FA" class="headerlink" title="####输出"></a>####输出</h2><p><strong>–sheet</strong> <code>&lt;filename&gt;</code><br>+生成的图片名,支持<strong>png,jpg,pvr,pvr.czz,pvr.gz</strong>格式<br>+示例:<code>--sheet out.png</code></p>
<p><strong>–data</strong> <code>&lt;filename&gt;</code></p>
<ul>
<li>生成的plist文件名 </li>
<li>示例:<code>--data out.plist</code></li>
</ul>
<p><strong>–format</strong> <code>&lt;format&gt;</code></p>
<ul>
<li>生成的plist格式,我们使用cocos2d格式 </li>
<li>示例:<code>--format cocos2d</code></li>
<li>注:其他支持格式见下图:<br><img src="http://ww1.sinaimg.cn/large/7f870d23jw1ebgwbnyra9j20fx083aay.jpg" alt=""></li>
</ul>
<p><strong>–auto-sd</strong></p>
<ul>
<li>自动生成sd资源</li>
<li>示例:<code>--auto-sd</code></li>
<li>注:这个要注意一点,如果要使用这个参数,你输入的<code>sheet</code>和<code>data</code>名必须含有<code>-hd</code>或<code>@2x</code>,TP会自动生成不带后缀的sd数据.</li>
</ul>
<p>–texturepath <code>&lt;path&gt;</code></p>
<ul>
<li>在生成的<code>sheet</code>文件的路径前加你<path></path></li>
<li>示例:<code>--texturepath image/tower</code> 这样在plist文件中<code>realTextureFileName</code>的值为<code>image/tower/out.png</code></li>
<li>注:这个参数主要用在当你的<strong>图片与plist文件不再同一个目录</strong>时使用,不会改变<code>out.png</code>的目录</li>
</ul>
<p>–trim-sprite-name</p>
<ul>
<li>剪裁掉拼接图片的后缀名</li>
<li>示例:<code>--trim-sprite-name</code> 这样在plist文件中<code>&lt;key&gt;001.png&lt;/key&gt;</code>会变成<code>&lt;key&gt;001&lt;/key&gt;</code></li>
<li>注:是剪裁用来拼接的文件而不是生成文件,如果你的资源管理类似于android那样,使用图片时不加后缀名,那么打包时可以使用这个选项</li>
</ul>
<p><strong>–replace</strong> <code>&lt;regexp&gt;=&lt;string&gt;</code></p>
<ul>
<li>按照原文的翻译是使用<code>&lt;string&gt;</code>替换掉拼接图片的文件名中正则表达式匹配的字符串</li>
<li><strong>卧槽,正则表达式啊一听就尼玛高大强啊,可惜老夫不会啊,怎么办呢?回家去翻翻金瓶梅改天告诉大家.</strong></li>
<li>这个TM太有用了,后面我遇到的那个问题,用这个来解决最好不过了</li>
</ul>
<p>–ignore-files <code>&lt;regexp&gt;</code></p>
<ul>
<li>按照原文的翻译是忽略所有满足给定条件的图片(可以使用时间作为条件),你可以使用<code>*</code>或<code>?</code>,但在使用bash时应避免使用通配符.</li>
</ul>
<h2 id="23_23_23_23_u5C3A_u5BF8"><a href="#23_23_23_23_u5C3A_u5BF8" class="headerlink" title="####尺寸"></a>####尺寸</h2><p>先上一张cocos2d-x支持的最大图片尺寸:<br><img src="http://ww4.sinaimg.cn/large/7f870d23jw1ebh3kmq7ebj205i05awej.jpg" alt=""><br>还有官方的这句话:</p>
<blockquote>
<p> For the developers, if you want to cross platforms and run your games smoothly, you should keep your texture size <strong>less than 1024*1024</strong>, that is the lowest restriction for most machines.</p>
</blockquote>
<p><strong>–width/–height</strong> <code>&lt;int&gt;</code></p>
<ul>
<li>两个参数,放在一块说了,设置输出图片的宽度/高度</li>
<li>示例:<code>--width 100</code> <code>--height 100</code></li>
<li>注:这个值设置的大了无所谓,会产生空白区域,但是如果太小,就会报错:<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">error: Could not fit all sprites into the sprite sheet.</span><br></pre></td></tr></table></figure>
</li>
</ul>
<p><strong>–max-width/–max-height/–max-size</strong> <code>&lt;int&gt;</code></p>
<ul>
<li>设置输出图片的最大宽度/高度/尺寸</li>
<li>示例:<code>--max-width 1024</code> <code>--max-height 1024</code> 前面两个等价于后面 <code>--max-size 1024</code></li>
<li>注:<br>  1.和上面两个参数的区别在于告诉TP实际值别超过这个值就OK,而上边那两个参数告诉TP实际值一定是这个.<br>  2.默认值为<code>2048</code><br>  3.如果实际值大于设置的最大值会产生错误:<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">error: Sprite sheet size is too small.</span><br></pre></td></tr></table></figure>
</li>
</ul>
<p><strong>–allow-free-size</strong></p>
<ul>
<li>允许输出图片不是2的幂,以最小尺寸输出</li>
<li>示例:<code>--allow-free-size</code></li>
<li>注:这个一般开启,cocos2d-x2.0开始就已经支持图片不是2的幂了</li>
</ul>
<h2 id="23_23_23_23_u95F4_u8DDD_u548C_u65CB_u8F6C"><a href="#23_23_23_23_u95F4_u8DDD_u548C_u65CB_u8F6C" class="headerlink" title="####间距和旋转"></a>####间距和旋转</h2><p>–shape-padding <code>&lt;int&gt;</code></p>
<ul>
<li>图块之间缝隙的宽度,默认值是<code>2</code></li>
<li>示例:<code>--shape-padding 100</code></li>
</ul>
<p>–border-padding <code>&lt;int&gt;</code></p>
<ul>
<li>可以理解为边框的宽度,默认值为<code>2</code></li>
<li>示例:<code>--border-padding 100</code></li>
</ul>
<p>–padding <int></int></p>
<ul>
<li>间距,这个参数等价于上面两个参数同时同时作用</li>
<li>示例:<code>--padding 100</code></li>
<li>注:如果没有开启<code>--allow-free-size</code>可能和你想象的不太一样</li>
</ul>
<p>–inner-padding <int></int></p>
<ul>
<li>试了一下,这个参数的作用应该是给每个sprite的周围加一个边框,默认值为0</li>
<li>示例:<code>--inner-padding 100</code></li>
<li>注:上面的这几个参数作用都不是很大</li>
</ul>
<p>–enable-rotation/diable-rotation</p>
<ul>
<li>开启/关闭旋转,默认值和输出的格式有关系,cococ2d格式默认enable</li>
<li>示例<code>--enable-rotation</code> <code>--diable-rotation</code></li>
<li>注:这个很好理解,为了排版更密集些,有的图片会被旋转</li>
</ul>
<p><strong>–trim/no-trim</strong></p>
<ul>
<li>剪裁图片,即移除图片周围的透明像素,保留原始尺寸,默认开启</li>
<li>示例:<code>--trim</code> <code>no-trim</code></li>
<li>注:这个要格外注意一下,这个参数略<strong>微有些问题</strong>,如果没有了解带来的后果的话还是使用<code>--no-trim</code>更安全些,我会在后面的仔细讲一下.</li>
</ul>
<p><strong>–crop</strong></p>
<ul>
<li>与上面的一条类似,移除图片四周的透明像素,不保留原始尺寸,保存为一张更小的图片</li>
<li>示例:<code>--crop</code></li>
<li>注:同上,要小心使用,尽量不在这里使用,而是改为前期用其它工具处理</li>
</ul>
<p>–trim-threshold <int></int></p>
<ul>
<li>与Trim类似,只是这个选项有一个参数,表示剪裁掉alpha值小于这个参数的像素,取值<code>0~255</code>,默认为<code>0</code>.</li>
<li>示例:<code>--trim-threshold</code></li>
</ul>
<p><strong>–disable-auto-alias</strong></p>
<ul>
<li>关闭自动命名,什么意思呢?<strong>TP在打包时会自动识别相同的图片,最终在大图里只会保留一张</strong>,这样会更加的节省资源,这个参数将会关闭这个功能</li>
<li>示例:<code>--disable-auto-alias</code></li>
<li>注:这样参数还是<strong>不要设置</strong>的好</li>
</ul>
<h2 id="23_23_23_23_u5176_u4ED6_u5E38_u7528_u9009_u9879"><a href="#23_23_23_23_u5176_u4ED6_u5E38_u7528_u9009_u9879" class="headerlink" title="####其他常用选项"></a>####其他常用选项</h2><p><strong>–opt</strong> <pixelformat></pixelformat></p>
<ul>
<li>设置输出图片的像素格式 一般默认RGBA8888</li>
<li>示例:<code>--opt RGB444</code></li>
<li>注:这个选项一般不做更改,如果想压缩资源体积的话,可以改为RGBA4444这样图片可以减小一半的体积.具体大家可以看下面这张图:<br><img src="http://ww3.sinaimg.cn/large/7f870d23jw1ebi5nnszqmj20po0g0go5.jpg" alt=""></li>
</ul>
<p>##常见问题</p>
<p><strong>错误:</strong> error: Error in sprite: <em>.png: Failed to load image!<br><strong>解决方案:</strong> 去掉目标路径末尾的</em>.png试试.</p>
<p><strong>错误:</strong> error: Could not fit all sprites into the sprite sheet.<br><strong>解决方案:</strong><br>1.查看有无设置<code>--width or --height</code>,这个错误通常是由于输出图片的尺寸太小导致的.<br>2.查看有无<code>--max-width/--max-height/--max-size</code>,没有的话加上,有的话将参数值改大一些.</p>
<p><strong>错误:</strong> error: Sprite sheet size is too small.<br><strong>解决方案:</strong>参见上个错误中的解决方案2,<code>--max-width/--max-height/--max-size</code>默认值为<code>2048</code>,试着改成<code>4096</code>试试,如果解决了,不要高兴,因为大多数移动设备都不支持这个尺寸,可以考虑分开打包.</p>
<p><strong>错误:</strong> error: Unknown argument –XXX - please check parameters or visit <a href="http://www.texturepacker.com" target="_blank" rel="external">http://www.texturepacker.com</a> for newer version<br><strong>解决方案:</strong> 检查XXX的拼写是否正确</p>
<p><strong>问题:</strong> 程序中获得图片的尺寸与打包前不一致<br><strong>解决方案:</strong> 检查参数是否含有<code>--crop</code>,有的话删除,有没有<code>--no-trim</code>,没有的话加上.</p>
<p>##后记<br>讲了那么多参数,其实常用的没有几个,下面这个是我最终使用的命令:<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">TexturePacker --sheet out.png --data out.plist --allow-free-size --no-trim --max-size 1024 --format cocos2d animation</span><br></pre></td></tr></table></figure></p>
<p>文章到这里就要结束了,但其实还没有完,<code>--trim</code>到底为什么不建议使用?使用了会发生什么问题?它和<code>--crop</code>的具体区别在哪里?plist文件中frame的路径和其他plist的重复了怎么办?程序中怎么做才能做到打包和不打包的差异最小化?金瓶梅你什么时候看完?</p>
<p>我后面会再写一篇文章来讲这些东西(逃).</p>
<p><strong>全文完</strong></p>
]]></content>
    </entry>
    
    <entry>
      <title><![CDATA[修改SimpleAudioEngine在win32下的实现]]></title>
      <url>http://blog.justbilt.com/2013/11/29/cocos2dx_simpleaudio/</url>
      <content type="html"><![CDATA[<p>###2013年12月6日更新<br>试着跟OAE的作者联系了下,向他诉苦<strong>必须装vs2013的运行库</strong>的问题,没想到作者竟然回复了,而且很快出了一新的版本:</p>
<blockquote>
<p>I’ve updated the package on: OAE_1_6_0_7,It’s still with Visual Studio 2013, but linked statically. So you don’t need anymore Visual C++ redistributable to run Open Audio Engine.<br>Now it should really more portable :P</p>
</blockquote>
<p>哈哈哈,实乃业界良心啊,这下小伙伴们<strong>再也不用去安装vs2013的运行库了</strong>,实测无误,大家快些更新吧!<br><a id="more"></a></p>
<p>###2013年12月3日更新<br>感谢微博小伙伴<a href="http://weibo.com/1158210694/AlAcdvfWx" target="_blank" rel="external">@Hewen_Xie</a>的纠正,在检测缓冲时没有使用FullPath,可能导致缓冲检测失效,已上传至<a href="https://github.com/justbilt/CocosDenshion_win32/tree/master/win32" target="_blank" rel="external">github</a>,大家更新下就OK!</p>
<p>###2013年12月2日更新<br>之前文章有两个错误,更正下,小伙伴们对不住了!<br>1.<strong>必须装vs2013的运行库</strong>,之前说的那个不用装的方法是错误的,引擎作者很早就使用vs2013开发了,用别人的东西就是蛋疼,改天研究下openAL吧!</p>
<p>2.大量测试后发现OAE引<strong>擎最大支持缓存256个声音,一旦超出后会卡死程序,</strong>我写了缓冲池修复了这个问题,效率也有所提升.</p>
<p>##问题<br>在上篇文章中抱怨了下<strong>SimpleAudioEngine</strong>在win32下的实现,总结一下,有这么几个缺点:</p>
<p>1.<strong>循环播放音效的返回id有问题,与其他平台存在差异.</strong></p>
<p>2.<strong>每次播放音效都会开启一个线程,io操作,声音一多,卡的不成样子</strong></p>
<p>其中第2点是致命的,保卫萝卜1出过一个<a href="http://www.luobo.cn/pc/" target="_blank" rel="external">桌面版</a>,由于声音的问题,<strong>开着声音几乎不可玩</strong>,大家可以下一个感受一下:<br><img src="http://ww2.sinaimg.cn/large/7f870d23jw1eb1z09u9awj20qn0bv0ul.jpg" alt=""></p>
<p>这样来看,难道真如王哲大神所说,<strong>桌面版只是一个用来调试的版本</strong>?</p>
<p>其实不然,因为cocos2d-x是开源的,而<strong>SimpleAudioEngine</strong>在不同平台下又有不同的实现,这样我们可以很容易的去修改win32下的实现.</p>
<p>##解决方案<br>想了下,决定先放出解决方案,下面的文章其实可看可不看的,最终我采用的是<strong>免费不开源</strong>的OAE声音引擎,基于OpenAL的二次封装,OOP,简单易用.大家只需几个步骤即可<strong>完美解决</strong>win32下的声音问题! <del>由于最新版的OAE使用vs2013开发,<strong>必须装vs2013的运行库</strong>!</del> <strong>(已不用安装)</strong></p>
<p><strong>注意:OpenAE有一个缺点,就是只支持ogg文件.</strong></p>
<p>1.解压缩从github将<a href="https://github.com/justbilt/CocosDenshion_win32/archive/master.zip" target="_blank" rel="external">这个</a>拽下来!</p>
<p>2.<strong>32位</strong>系统将<code>lib/x86</code>目录下的<code>OpenAE.dll</code>,<code>OpenAL.dll</code>拷贝到<code>Debug.win32</code>目录下,64位类似.</p>
<p>3.用<code>win32/</code> <strong>替换掉</strong>你工程<code>CocosDenshion/win32</code>目录下的所有文件.</p>
<p>4.大功告成,播放一堆声音试试吧.</p>
<p>5.游戏结束的时候一定要在AppDelegate的析构函数中调用<code>SimpleAudioEngine::end()</code>,不然会因没有释放内存而崩溃,如下:</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">AppDelegate::~AppDelegate()</span><br><span class="line">&#123;</span><br><span class="line">	CocosDenshion::SimpleAudioEngine::end();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>6.将<code>OpenAE.dll</code>,<code>OpenAL.dll</code>拷贝到<code>cocos2dx/platform/third_party/win32/libraries</code>中,这样重新编译时会自动拷贝到<code>Debug.win32</code>目录下.</p>
<p>好了,是不是十分容易,<strong>下面的内容是写当时考虑的一些东西及实现的一些细节</strong>,如果有什么错误和疑问,请指出,谢谢!</p>
<p>##声音引擎的选择<br>好的,如果你对win32下的声音播放比较熟悉的话,你可以看下SimpleAudioEngine现在的实现,试试能否改的更高效些!否则我们只能找一个现成的声音引擎了.</p>
<p>###FMOD<br>说起声音引擎,FMODE必须是首选啊,功能强大,跨平台,个人使用免费,简单易用,久经考验,好多牛逼的游戏引擎都使用它的,<a href="http://www.fmod.org/" target="_blank" rel="external">官方网址</a>,下面是使用它的引擎:</p>
<p><img src="http://ww4.sinaimg.cn/large/7f870d23jw1eb1zrn20prj20ok05ht8z.jpg" alt=""></p>
<p>但是由于商用是收费的,而且我们用不到那么多牛逼的功能,所以这个就pass掉咯~</p>
<p>###OpenAL<br>另一个特别有名的就收OpenAL(Open Audio Library)了,这个也是大名鼎鼎啊,让我们看看维基百科的介绍:</p>
<blockquote>
<p>OpenAL（Open Audio Library）是自由软件界的跨平台音效API。它设计给多通道三维位置音效的特效表现。其 API 风格模仿自 OpenGL。penAL 最初是由 Loki Software 所开发。是为了将 Windows 商业游戏移植到 Linux 上。Loki 倒闭以后，这个项目由自由软件／开放源始码社区继续维护。不过现在最大的主导者（并大量发展）是创新科技，并得到来自 苹果公司 和自由软件／开放源代码爱好者的持续支持。</p>
</blockquote>
<p>现在官方网站貌似打不开,感兴趣的同学可以去<a href="http://kcat.strangesoft.net/openal.html" target="_blank" rel="external">这里</a>看看.OpenAL十分强大,这就意味着要在短时间弄懂它并不容易,这里我们就不考虑它了.</p>
<p>###OpenAE<br>最终我选择了OpenAE(Open Audio Engine),一个基于OpenAL的声音引擎,面向对象,上手十分容易(我只用了10分钟就会用了),虽然不开源但是免费啊,这已经足够了.官方网站在<a href="http://www.openaudioengine.com/" target="_blank" rel="external">这里</a>,同时大家可以看看codeproject上的<a href="http://www.codeproject.com/Tips/674472/Open-Audio-Engine" target="_blank" rel="external">这个示例</a>.</p>
<p><img src="http://ww2.sinaimg.cn/large/7f870d23jw1eb20ikphx4j20u00df75l.jpg" alt=""></p>
<p>##改动<br>其实要改动的地方很多,之前的实现基本要重写,下面我介绍下要点:</p>
<p>1.首先我们要初始化引擎,由于SimpleAudioEngine是单例,所以它的<strong>构造函数</strong>就挺好:</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line">SimpleAudioEngine::SimpleAudioEngine()</span><br><span class="line">&#123;</span><br><span class="line">	HINSTANCE lib = LoadLibrary(<span class="string">"OpenAE.dll"</span>); <span class="comment">//加载引擎</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">	<span class="comment">//得到设备列表地址</span></span><br><span class="line">	oae::Renderer* (*driver)(<span class="keyword">const</span> <span class="keyword">char</span>*,<span class="keyword">const</span> <span class="keyword">unsigned</span>&amp;) = <span class="literal">nullptr</span>;</span><br><span class="line">	driver = (oae::Renderer*(*)(<span class="keyword">const</span> <span class="keyword">char</span>*,<span class="keyword">const</span> <span class="keyword">unsigned</span>&amp;)) </span><br><span class="line">		GetProcAddress(lib, <span class="string">"GetRenderDevice"</span>); </span><br><span class="line"></span><br><span class="line"></span><br><span class="line">	<span class="comment">//得到设备列表</span></span><br><span class="line">	<span class="keyword">const</span> <span class="keyword">char</span>* (*available)(<span class="keyword">unsigned</span> <span class="keyword">int</span>&amp;) = <span class="literal">nullptr</span>;</span><br><span class="line">	available = (<span class="keyword">const</span> <span class="keyword">char</span>*(*)(<span class="keyword">unsigned</span> <span class="keyword">int</span>&amp;)) GetProcAddress(lib, <span class="string">"GetDeviceName"</span>); </span><br><span class="line"></span><br><span class="line">	<span class="comment">//打印可用设备的列表</span></span><br><span class="line">	<span class="keyword">for</span>(<span class="keyword">unsigned</span> j=<span class="number">0</span>; available(j)!=<span class="literal">nullptr</span>; j++)</span><br><span class="line">	&#123;</span><br><span class="line">		CCLog(available(j));</span><br><span class="line">	&#125; </span><br><span class="line"></span><br><span class="line">	<span class="comment">//默认使用第一个设别去创建Renderer,48000是端口号随便填</span></span><br><span class="line">	<span class="keyword">unsigned</span> choice=<span class="number">0</span>; </span><br><span class="line">	oae::Renderer* dev = driver(available(choice), <span class="number">48000</span>);</span><br><span class="line"></span><br><span class="line">	<span class="comment">//这行代码十分诡异,貌似没有什么用处,但是不调用就是无法播放声音</span></span><br><span class="line">	oae::Listener* lis = dev-&gt;GetListener();</span><br><span class="line"></span><br><span class="line">	<span class="comment">//由于创建声音和最终释放资源会用到这两个指针,所以我以static方式存在的MciPlayer中</span></span><br><span class="line">	MciPlayer::lib=lib;</span><br><span class="line">	MciPlayer::dev=dev;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>2.更改MciPlayer的实现,对oae,每一个声音的实例是<code>oae::Screamer</code>,我们在<code>open</code>中去创建它:</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">void</span> MciPlayer::Open(<span class="keyword">const</span> <span class="keyword">char</span>* pFileName, UINT uId)</span><br><span class="line">&#123;</span><br><span class="line">	m_scr=dev-&gt;GetScreamer(pFileName);</span><br><span class="line">	assert(m_scr!=<span class="literal">NULL</span> &amp;&amp; <span class="string">"Only suppost .ogg file!"</span>);</span><br><span class="line">	m_strFileName=pFileName;</span><br><span class="line">	</span><br><span class="line">	m_nSoundID=uId;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>3.更改<code>playEffect</code>返回值streameID的生成方式,变为递增的就OK:<br><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">unsigned</span> <span class="keyword">int</span> _StreameID()</span><br><span class="line">&#123;</span><br><span class="line">	<span class="keyword">static</span> <span class="keyword">unsigned</span> <span class="keyword">int</span> nSteameID=<span class="number">0</span>;</span><br><span class="line">	++nSteameID;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">return</span> nSteameID;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>其他改动的地方也很多,大家可以直接去看源码,下面有下载地址.</p>
<p>##后话</p>
<p>具体实现什么的都在源码里,大家可以看一下,经过本人测试,<strong>没有发现任何问题,并且已经应用到了现在的项目中</strong>,如果遇到了什么问题,留言告诉我.</p>
<p><strong>(全文完)</strong></p>
]]></content>
    </entry>
    
    <entry>
      <title><![CDATA[从保卫萝卜看cocos2d-x循环播放音效的问题]]></title>
      <url>http://blog.justbilt.com/2013/11/28/cocos2dx_loop_sound/</url>
      <content type="html"><![CDATA[<p>##起因<br>保卫萝卜2前几天上ios平台了,立刻下了一个玩,卧槽,各种呆萌蠢贱啊,有一个塔挺有意思,<strong>魔法球</strong>:<br><a id="more"></a><br><img src="http://ww1.sinaimg.cn/large/7f870d23jw1eb0uj0md4qj20sh0ixn32.jpg" alt=""></p>
<p>这种塔的攻击力虽然低,但是攻击速度快啊,而且升级后还能攻击多个目标,用在对付血少速度快的怪物再适合不过了.玩了挺久发现这个塔的音效有些问题:</p>
<ol>
<li><p>屏幕中有多个魔法球塔时,卖掉其中一个可能会导<strong>致所有魔法球塔的音效停止.</strong></p>
</li>
<li><p>有时候卖掉所有的魔法球塔,但<strong>是声音还在播放!</strong></p>
</li>
</ol>
<p>一般情况下我是不会mind这种细节的,但由于保卫萝卜是用cocos2d-x制作的,所以我稍微多想了一下:</p>
<p>猜想1:由于攻击速度十分快,所以我假设魔法球这个塔的音效播放和其他的塔不太一样,可能是这个样子的:<strong>切换为攻击模式时循环播放音效,切换为待机模式时停止音效!</strong><br>猜想2. 如果假设成立,这个音效由于会循环播放,如果声音太吵的话,会<strong>十分的吵</strong>,萝卜显然注意到了这点.<br>猜想3. 所有的魔法球塔会<strong>公用一个特效声音,</strong>要不造的塔多了就根本没法开声音玩了!</p>
<p><strong>细思极恐,其实这座塔的音效播放逻辑十分的复杂!</strong></p>
<p>##验证<br>下面让我验证下我的猜想,看看能否帮萝卜解决这个问题!</p>
<p>###验证1:循环播放音效<br>这个十分简单,我在保卫萝卜2的资源中找到了<code>CarrotFantasy.app\Music\Towers\Ball.mp3</code>,看了时长1s左右,但是魔法球塔的攻击速度绝对大于2次,开2倍速的会大于4次,1s播放4次音效,没有人会这么做!所以魔法球塔是循环播放音效的!</p>
<p>###验证2:音效的特性<br>这个大家听一下就会知道了,魔法球的塔混在其他塔的音效里实在是太弱了!为此,我还<strong>假装很专业</strong>的用GoldWave查看了一下:<br><img src="http://ww1.sinaimg.cn/large/7f870d23jw1eb0xzlrpzxj217s0hv44w.jpg" alt=""><br>图中上面的声音是瓶子炮的声音,下面是魔法球的声音,从图上可以看出,虽然魔法球的声音很长,但是只有在0.65s时声音较大,其他时候声音都很小!</p>
<p>###验证3.公用一个音效</p>
<p>开启循环播放音效十分简单,只需在<code>playEffect(&quot;1.ogg&quot;,true)</code>时第二个参数填true即可,这时playEffect会返回一个<code>unsigned int</code>类型的<code>id</code>,这个id会用于<code>stopEffect(id)</code>,如下:</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">unsigned</span> <span class="keyword">int</span> uID=SimpleAudioEngine::sharedEngine()-&gt;playEffect(<span class="string">"1.ogg"</span>, <span class="literal">true</span>);<span class="comment">//开始循环播放</span></span><br><span class="line"></span><br><span class="line">SimpleAudioEngine::sharedEngine()-&gt;stopEffect(nID);<span class="comment">//停止播放</span></span><br></pre></td></tr></table></figure>
<p>这样看起来似乎很简单嘛,攻击的时候播,顺带记下ID,待机的时候停,这么简单,萝卜的程序太差了吧,这都能写错!其实不然,这只是场景中只有一座塔时的情况!</p>
<p>下面我们来试一下如果我们连续调用多次playEffect,会发生什么问题?我做了测试项目,将每次playEffect的返回ID打在屏幕上,win32截图如下:</p>
<p><img src="http://ww1.sinaimg.cn/large/7f870d23jw1eb0wcy5p7pj20di09l74r.jpg" alt=""></p>
<p>额,你没有看错,win32下播放同一个音效返回的id都是一样的,只要点击一下停止就全部都停了,为什么呢?让我们看一下win32<br>下声音的id是怎么生成的吧,在SimpleAudioEngine中我们可以看到这段代码:<br><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//播放音效的函数</span></span><br><span class="line"><span class="keyword">unsigned</span> <span class="keyword">int</span> SimpleAudioEngine::playEffect(<span class="keyword">const</span> <span class="keyword">char</span>* pszFilePath, <span class="keyword">bool</span> bLoop)</span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">unsigned</span> <span class="keyword">int</span> nRet = _Hash(pszFilePath);<span class="comment">//可以断定nRet就是返回的id</span></span><br><span class="line"></span><br><span class="line">    preloadEffect(pszFilePath);</span><br><span class="line"></span><br><span class="line">    EffectList::iterator p = sharedList().find(nRet);</span><br><span class="line">    <span class="keyword">if</span> (p != sharedList().end())</span><br><span class="line">    &#123;</span><br><span class="line">        p-&gt;second-&gt;Play((bLoop) ? -<span class="number">1</span> : <span class="number">1</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> nRet;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">//生成id的函数</span></span><br><span class="line"><span class="keyword">unsigned</span> <span class="keyword">int</span> _Hash(<span class="keyword">const</span> <span class="keyword">char</span> *key)</span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">unsigned</span> <span class="keyword">int</span> len = <span class="built_in">strlen</span>(key);</span><br><span class="line">    <span class="keyword">const</span> <span class="keyword">char</span> *end=key+len;</span><br><span class="line">    <span class="keyword">unsigned</span> <span class="keyword">int</span> hash;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span> (hash = <span class="number">0</span>; key &lt; end; key++)</span><br><span class="line">    &#123;</span><br><span class="line">        hash *= <span class="number">16777619</span>;</span><br><span class="line">        hash ^= (<span class="keyword">unsigned</span> <span class="keyword">int</span>) (<span class="keyword">unsigned</span> <span class="keyword">char</span>) <span class="built_in">toupper</span>(*key);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> (hash);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>这下明白了吧,<strong>win32下的id是根据音效的路径pszFilePath算出来的</strong>,这一点确实比较坑,大家以后要注意一下!下面我看一下在android上的效果吧!</p>
<p><img src="http://ww3.sinaimg.cn/large/7f870d23jw1eb1p27ln4tj208p0fkmx6.jpg" alt=""></p>
<p>adnroid版是正常的,每次playEffect返回的id会递增,可以明显的听出又多了一个音效,当我音效叠了5层之后已经很乱了,但是萝卜的显然不是如此,所以所有的魔法球共用一个音效是正确的!</p>
<p><strong>注意:这里一定要提前preloadEffect,不然第一次返回的id是0,这样那个音效就永远停不下来了!</strong></p>
<p>##分析<br>基于以上猜想,我们来分析下魔法球塔的逻辑:<br>1.对于单个的魔法球塔,由于多目标,所以要监听目标数量的变化,当<code>target_count&gt;0</code>时,开始播放音效,当<code>target_count=0</code>时,停止播放音效.<br>2.卖掉塔时,如果处于攻击状态,应该调用停止播放音效.<br>3.对于所有的魔法球塔,音效应该采用类此引用计数的方法,每调用一次<code>++m_uReference;</code>,每停止一次<code>--m_uReference;</code>,当<code>m_uReference==0</code>时调用真正的停止音效方法.</p>
<p>嘿嘿,以上纯属个人见解,本人不对此负任何责任!</p>
<p>##总结<br>综上所述,我们在编写游戏音效逻辑的代码时,要注意:<br>1.循环音效多次播放在windows上有问题,可以考虑在android或ios端调试.<br>2.音效一定要preloadEffect.</p>
<p><strong>(全文完)</strong></p>
]]></content>
    </entry>
    
    <entry>
      <title><![CDATA[弯管(拐角)对方向的改变]]></title>
      <url>http://blog.justbilt.com/2013/11/03/elbow/</url>
      <content type="html"><![CDATA[<p>相信大家玩过类似用接水管的游戏:</p>
<p><img src="http://ww4.sinaimg.cn/large/7f870d23jw1ea3z15mhgyj208c069jrj.jpg" alt=""></p>
<p>水流顺着水管的一头流向另一头,但是直管通过,遇到弯管改变方向,那么究竟是如何改变方向的呢?<br>仔细观察一下,不难发现,弯管只是将水流的方向<strong>旋转了90度</strong>,有了规律就好办了!</p>
<a id="more"></a>
<p>1.让我们先定义一个方向的枚举,表示当前水流的方向:</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">enum</span> ETileDirection</span><br><span class="line">&#123;</span><br><span class="line">    ED_UP,</span><br><span class="line">    ED_RIGHT,</span><br><span class="line">    ED_DOWN,</span><br><span class="line">    ED_LEFT,</span><br><span class="line">    ED_TICK_COUNT,</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>
<p>这个枚举定义可以是顺时针,也可以是逆时针,但一定要是<strong>连续</strong>的!</p>
<p>2.当地图编辑好后,我们会获得一个二维数组,通过一个x,y参数就能取得某个坐标上的图块,根据图块的功能,我们可以讲图块分为:<strong>入口</strong>, <strong>出口</strong>, <strong>直管</strong>, <strong>弯管</strong>, 于是我们可以再定义一个枚举:<br><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">enum</span> ETileType</span><br><span class="line">&#123;</span><br><span class="line">    ET_ENTRANCE,</span><br><span class="line">    ET_EXIT,</span><br><span class="line">    ET_STRAIGHT,</span><br><span class="line">    ET_ELBOW,</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure></p>
<p>3.仔细想想,除了直管每一种类型的图块都会有,都会有四个方向,对于入口,会有向左的,向右的,向下的,向上的,终点,弯管也是如此!这样的话,我们一个图块的属性都会有两个,<strong>类型</strong> 和 <strong>方向</strong>,我们用一个结构体来表示:<br><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">struct</span> STile</span><br><span class="line">&#123;</span><br><span class="line">    ETileType eType;</span><br><span class="line">    ETileDirection eDirection;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure></p>
<p>4.如下面这个砖块:</p>
<p><img src="http://ww1.sinaimg.cn/large/7f870d23jw1ea7hnpwq2qj205z062mx5.jpg" alt=""></p>
<p>当水流从右侧进入时水流的方向也是<strong>ED_LEFT</strong>,出去的水流方向是什么呢?是<strong>ED_LEFT+1</strong>,因为方向的可能只有4个,所以我们需要和方向的总数量取余,即<code>(eDir+1)%ED_TICK_COUNT</code>为<strong>ED_UP</strong>.</p>
<p>当水流是从上方进入时方向为<strong>ED_DOWN</strong>,出去时的方向为<strong>ED_DOWN-1</strong>,但是减完有可能会出现负数,所以我们先扩大一个周期在减然后取余,即<code>((eDir+ED_TICK_COUNT)-1)%ED_TICK_COUNT</code>为<strong>ED_RIGHT</strong>.</p>
<p>那么如何区分是顺时针还是逆时针呢?我们之前Tile的<code>eDirection</code>属性就派上用场了,我们将这个图块的方向属性设置为<code>ED_LEFT</code>,细思之后会发现当图块的方向和水流方向一致时<code>+1</code>,不一致时<code>-1</code>.</p>
<p>好吧,说了这么久,让我们来看看具体的逻辑如何写吧?</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="function">ETileDirection <span class="title">changeDirection</span><span class="params">(ETileDirection eDir,<span class="keyword">const</span> STile* pProfile )</span></span><br><span class="line"></span>&#123;</span><br><span class="line">	ASSERT(pProfile-&gt;eType==ET_ELBOW);</span><br><span class="line"></span><br><span class="line">	<span class="keyword">if</span> (pProfile-&gt;eDirection==eDir)</span><br><span class="line">	&#123;</span><br><span class="line">		<span class="keyword">return</span> (ETileDirection)(((eDir+ED_TICK_COUNT)-<span class="number">1</span>)%ED_TICK_COUNT);</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">return</span> (ETileDirection)((eDir+<span class="number">1</span>)%ED_TICK_COUNT);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>如果有什么不明白的,留言告诉我!</p>
<p><strong>全文完</strong></p>
]]></content>
    </entry>
    
    <entry>
      <title><![CDATA[TiledMap Tips]]></title>
      <url>http://blog.justbilt.com/2013/10/16/cocos2d-x-tiledmap-tips/</url>
      <content type="html"><![CDATA[<h3 id="u4E00-_u65AD_u8A00_TMX_3A_Only_1_tileset_per_layer_is_supported__u5D29_u6E83_3A"><a href="#u4E00-_u65AD_u8A00_TMX_3A_Only_1_tileset_per_layer_is_supported__u5D29_u6E83_3A" class="headerlink" title="一.断言 TMX: Only 1 tileset per layer is supported 崩溃:"></a>一.断言 TMX: Only 1 tileset per layer is supported 崩溃:</h3><a id="more"></a>
<p>加载地图时弹出断言失败窗口,跟踪进去发现崩毁地点:<br><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">CCAssert( m_uMaxGID &gt;= m_pTileSet-&gt;m_uFirstGid &amp;&amp;</span><br><span class="line">    m_uMinGID &gt;= m_pTileSet-&gt;m_uFirstGid, <span class="string">"TMX: Only 1 tileset per layer is supported"</span>);</span><br></pre></td></tr></table></figure></p>
<p>从断言中的提示就可以看出:一张图层上只支持一个一个图块集合<br>就是说编辑器中的每一层只能使用一个图块集合中的图块,不能使用其他图块集合中的图块!</p>
<h3 id="u4E8C-tileGIDAt_u8FD4_u56DE_u6570_u636E_u5F02_u5E38_3A"><a href="#u4E8C-tileGIDAt_u8FD4_u56DE_u6570_u636E_u5F02_u5E38_3A" class="headerlink" title="二.tileGIDAt返回数据异常:"></a>二.tileGIDAt返回数据异常:</h3><p>我们用tileGIDAt获取某一层上的某一格对应的图块ID,GID是什么呢?可以理解为全局唯一ID,而我们的图块集合可能会有多个,所以每个的图块的ID不是从该图块集合1,2,3…这样的,而是紧接着上一个图块集合的最后一个ID顺序下来的!</p>
<p>所以我们要获得正确的ID,应该:<br><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">cocos2d::CCTMXLayer *towerLayer = <span class="built_in">map</span>-&gt;layerNamed(<span class="string">"tower"</span>);</span><br><span class="line">cocos2d::CCTMXTilesetInfo *towerSet = towerLayer-&gt;getTileSet();</span><br><span class="line"><span class="keyword">int</span> nGid = towerLayer-&gt;tileGIDAt(ccp(<span class="number">0</span>, <span class="number">0</span>)) - towerSet-&gt;m_uFirstGid;</span><br><span class="line"><span class="keyword">if</span>(nGid &gt;= <span class="number">0</span>)</span><br><span class="line">&#123;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>先获取这一层对应的图块集合的首ID,然后相减就获得了正确的ID.</p>
<h3 id="u4E09-_u62FC_u63A5_u51FA_u73B0_u88C2_u75D5_28_u9ED1_u7EBF_29"><a href="#u4E09-_u62FC_u63A5_u51FA_u73B0_u88C2_u75D5_28_u9ED1_u7EBF_29" class="headerlink" title="三.拼接出现裂痕(黑线)"></a>三.拼接出现裂痕(黑线)</h3><p><strong>1.快速解决方案</strong></p>
<p>修改ccConfig.h中的CC_FIX_ARTIFACTS_BY_STRECHING_TEXEL:<br><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="preprocessor">#<span class="keyword">ifndef</span> CC_FIX_ARTIFACTS_BY_STRECHING_TEXEL</span></span><br><span class="line"><span class="preprocessor">#<span class="keyword">define</span> CC_FIX_ARTIFACTS_BY_STRECHING_TEXEL <span class="number">1</span></span></span><br><span class="line"><span class="preprocessor">#<span class="keyword">endif</span></span></span><br></pre></td></tr></table></figure></p>
<p>大体的作用是用实际图片的99%来创建纹理,这样边缘一些细微化的差距就会被忽略掉!</p>
<p><strong>2.完美解决方案</strong></p>
<p>用1的方法来解决问题是最快的,但是会带来一些副作用,查找下CC_FIX_ARTIFACTS_BY_STRECHING_TEXEL这个宏,会发现有4个地方都用到了:</p>
<p><img src="/img/b39a481b6b66a40162dad2a2c52008f99129cb83.jpg" alt=""></p>
<p>分别是CCSprite,CCLabelAtlas,CCParticleSystemQuad,CCTileMapAtlas,其中只有CCTileMapAtlas的改变使我们想要的,而CCSprite是我们最常用的接口,这将会导致所有的图片都会使用99%来贴图,影响虽然不是很大,但是在某些情况下还是能够看的出来(点击查看大图):</p>
<p>正常:</p>
<p><img src="/img/4220b6514671a4567ca56c6e199f49070b019f31.jpg" alt=""></p>
<p>开启后:</p>
<p><img src="/img/8de1d1d02a2860a7cc0eb5f17f4f99daf7a8a97a.jpg" alt=""></p>
<p>上面的图是放大两倍后的效果,如果你不是太在意这些细节的话,就可以忽略这个问题了.</p>
<p>但是如果你有强迫症的话,可以移步这篇文章:</p>
<p><a href="http://blog.sina.com.cn/s/blog_4508e4860101dzkj.html" target="_blank" rel="external">http://blog.sina.com.cn/s/blog_4508e4860101dzkj.html</a></p>
<p>同时我也修改好了一份,大家可以在文章末尾处下载!</p>
<h3 id="u56DB-_u6EDA_u52A8_u5730_u56FE_u65F6_u4F1A_u6296_u52A8"><a href="#u56DB-_u6EDA_u52A8_u5730_u56FE_u65F6_u4F1A_u6296_u52A8" class="headerlink" title="四.滚动地图时会抖动"></a>四.滚动地图时会抖动</h3><p>这种情况在RPG游戏中的影响很大,看一会眼睛就花了,我们可以给每一个节点的纹理开启抗锯齿来解决这个问题:<br><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//开启抗锯齿</span></span><br><span class="line">CCArray *pChildrenArray = <span class="built_in">map</span>-&gt;getChildren();</span><br><span class="line">CCSpriteBatchNode *child = <span class="literal">NULL</span>;</span><br><span class="line">CCObject *pObject = <span class="literal">NULL</span>;</span><br><span class="line">CCARRAY_FOREACH(pChildrenArray, pObject)</span><br><span class="line">&#123;</span><br><span class="line">	child = (CCSpriteBatchNode *)pObject;</span><br><span class="line">	<span class="keyword">if</span>(!child)</span><br><span class="line">		<span class="keyword">break</span>;</span><br><span class="line">	child-&gt;getTexture()-&gt;setAntiAliasTexParameters();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<h3 id="u4E94-tilemap_HD_u8F6CSD"><a href="#u4E94-tilemap_HD_u8F6CSD" class="headerlink" title="五.tilemap HD转SD"></a>五.tilemap HD转SD</h3><p>感谢<a href="http://weibo.com/1703959697/AdGzcoLTo?type=repost" target="_blank" rel="external">@子龙山人</a> 大大的分享,将tilemap从HD转SD可不是简单的将图片缩小一倍就OK的,地图文件中的网格尺寸啊什么的都要随着改变的!感兴趣的请移步这里:<a href="http://wasabibit.org/WasabiBit/Dev_Notes.html" target="_blank" rel="external">http://wasabibit.org/WasabiBit/Dev_Notes.html</a></p>
<p> [10月25日]</p>
<h3 id="u516D-_u52A0_u8F7D_u5D29_u6E83"><a href="#u516D-_u52A0_u8F7D_u5D29_u6E83" class="headerlink" title="六.加载崩溃"></a>六.加载崩溃</h3><p>崩溃地点如下:<br><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">bool</span> CCTexture2D::hasPremultipliedAlpha()</span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">return</span> m_bHasPremultipliedAlpha;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>原因:地图中有一层为什么都没有,<strong>这是不允许的,要么将这一层删掉,要么刷点东西上去!</strong></p>
<p><strong>附件一:</strong></p>
<p><a href="http://pan.baidu.com/s/1qYnEQ" target="_blank" rel="external">http://pan.baidu.com/s/1qYnEQ</a></p>
<p>下载后解压,覆盖cocos2dx目录下的同名目录:</p>
<p><strong>1.win32下,将CCSpriteTileMap.h和CCSpriteTileMap.cpp添加到libcocos2d工程中就OK!</strong></p>
<p><strong>2.android下,需要往cocos2dx/Android.mk中添加这么一行:</strong><br><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">tilemap_parallax_nodes/CCSpriteTileMap.cpp \</span><br></pre></td></tr></table></figure></p>
<p><strong>3.ios下,需要将CCSpriteTileMap.h和CCSpriteTileMap.cpp添加到XCODE中!</strong></p>
<p>还有什么问题,发留言告诉我!</p>
]]></content>
    </entry>
    
    <entry>
      <title><![CDATA[cocos2d-x 抖动效果 CCShake]]></title>
      <url>http://blog.justbilt.com/2013/09/11/cocos2d-x-ccshake/</url>
      <content type="html"><![CDATA[<p>之前在网上找过一次,但是用起来有些问题,抖动完位置有偏移,就自己修改了下,原文应该是在这里:</p>
<a id="more"></a>
<p><a href="http://blog.csdn.net/qq634416025/article/details/8630189" target="_blank" rel="external">http://blog.csdn.net/qq634416025/article/details/8630189</a></p>
<p>感兴趣的同学可以去看一下,作者特意将抖动做成了CCAction,用起来十分方便,大谢!</p>
<p>效果图(GIF,画质压缩的有点狠,凑活着看吧!):</p>
<p><img src="/img/6527eb984895fca57fd5c7fad00e31b07b7966eb.gif" alt="667"></p>
<p>我把我修改过的版本放在了百度云盘上,下载地址:</p>
<p><a href="http://pan.baidu.com/share/link?shareid=2640816246&amp;uk=2685725110" target="_blank" rel="external">http://pan.baidu.com/share/link?shareid=2640816246&amp;uk=2685725110</a></p>
<p>使用时:</p>
<p><strong>1.先将CCShake.h中的</strong><br><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="preprocessor">#<span class="keyword">include</span> <span class="string">"GameDefine.h"</span></span></span><br></pre></td></tr></table></figure></p>
<p> 注释掉,改为下面这段话:<br><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="preprocessor">#<span class="keyword">include</span> <span class="string">"cocos2d.h"</span></span></span><br><span class="line">USING_NS_CC;</span><br></pre></td></tr></table></figure></p>
<p><strong>2.用法:</strong><br><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">pSprite-&gt;runAction(CCShake::create(<span class="number">0.1f</span>,<span class="number">10</span>));</span><br></pre></td></tr></table></figure></p>
<p> pSprite:想抖动的物体</p>
<p>第一个参数是:抖动的时间</p>
<p>第一个参数是:抖动的幅度</p>
<p><strong>3.注意,这点曾经困扰了我好久!</strong></p>
<p>一个CCNode同时执行多个CCShake动作,或者一个CCShake没有完又执行一个CCShake的话就会出现问题,会出现偏移的现象!</p>
<p>解决方案:</p>
<ol>
<li>不要同时执行多个CCShake动作.</li>
<li>自己外部记录这个CCNode的位置,执行完成后手动setPosition();</li>
</ol>
]]></content>
    </entry>
    
    <entry>
      <title><![CDATA[cocos2d-x 获取系统时间的问题]]></title>
      <url>http://blog.justbilt.com/2013/07/23/cocos2d-x-%E8%8E%B7%E5%8F%96%E7%B3%BB%E7%BB%9F%E6%97%B6%E9%97%B4%E7%9A%84%E9%97%AE%E9%A2%98/</url>
      <content type="html"><![CDATA[<h3 id="u4E00-_u9884_u5907_u77E5_u8BC6"><a href="#u4E00-_u9884_u5907_u77E5_u8BC6" class="headerlink" title="一.预备知识"></a>一.预备知识</h3><p>在看这篇文章之前,大家先可以看下这篇文章:<a href="http://developer.51cto.com/art/201002/182941.htm" target="_blank" rel="external">http://developer.51cto.com/art/201002/182941.htm</a> (C++获得系统时间不同方案介绍)<br><a id="more"></a></p>
<h3 id="u4E8C-_u5982_u4F55_u83B7_u53D6_u7CFB_u7EDF_u65F6_u95F4"><a href="#u4E8C-_u5982_u4F55_u83B7_u53D6_u7CFB_u7EDF_u65F6_u95F4" class="headerlink" title="二.如何获取系统时间."></a>二.如何获取系统时间.</h3><p><strong>1.获取日历时间:</strong><br><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">time_t</span> tt;</span><br><span class="line"><span class="comment">//返回自从 Unix 新纪元（格林威治时间 1970 年 1 月 1 日 00:00:00）到当前时间的秒数。</span></span><br><span class="line">time(&amp;tt);</span><br></pre></td></tr></table></figure></p>
<p><strong> 2.获取之后转化为年月日时间:</strong><br><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">struct</span> tm &#123;</span><br><span class="line">        <span class="keyword">int</span> tm_sec;     <span class="comment">/*秒数 seconds after the minute - [0,59] */</span></span><br><span class="line">        <span class="keyword">int</span> tm_min;     <span class="comment">/*分钟数 minutes after the hour - [0,59] */</span></span><br><span class="line">        <span class="keyword">int</span> tm_hour;    <span class="comment">/*小时 hours since midnight - [0,23] */</span></span><br><span class="line">        <span class="keyword">int</span> tm_mday;    <span class="comment">/*月份中的第几日 day of the month - [1,31] */</span></span><br><span class="line">        <span class="keyword">int</span> tm_mon;     <span class="comment">/*年份中的第几个月，从 0 开始表示一月 months since January - [0,11] */</span></span><br><span class="line">        <span class="keyword">int</span> tm_year;    <span class="comment">/*年份，从 1900 开始 years since 1900 */</span></span><br><span class="line">        <span class="keyword">int</span> tm_wday;    <span class="comment">/*星期中的第几天 days since Sunday - [0,6] */</span></span><br><span class="line">        <span class="keyword">int</span> tm_yday;    <span class="comment">/*一年中的第几天 days since January 1 - [0,365] */</span></span><br><span class="line">        <span class="keyword">int</span> tm_isdst;   <span class="comment">/*夏令时当前是否生效 daylight savings time flag */</span></span><br><span class="line">        &#125;;</span><br></pre></td></tr></table></figure></p>
<p><strong> 3.打印出当前是一年中的第几天:</strong><br><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">struct</span> tm *p;</span><br><span class="line">p = localtime(&amp;tt);</span><br><span class="line">CCLog(<span class="string">"%d"</span>,p-&gt;tm_yday);</span><br></pre></td></tr></table></figure></p>
<h3 id="u4E09-_u6CE8_u610F_u4E8B_u9879_3A"><a href="#u4E09-_u6CE8_u610F_u4E8B_u9879_3A" class="headerlink" title="三.注意事项:"></a><strong>三.注意事项:</strong></h3><p><strong>1.对于下面的代码:</strong><br><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">time_t</span> tt;</span><br><span class="line">time(&amp;tt);</span><br><span class="line"><span class="keyword">struct</span> tm *p1;</span><br><span class="line">p1 = localtime(&amp;tt);</span><br><span class="line"></span><br><span class="line">time(&amp;tt);</span><br><span class="line"><span class="keyword">struct</span> tm *p2;</span><br><span class="line">p2 = localtime(&amp;tt);</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> (p1-&gt;tm_sec!=p2-&gt;tm_sec)</span><br><span class="line">&#123;</span><br><span class="line">	<span class="comment">//do something...</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>大家觉得能否达到效果呢?(假设两次调用localtime的间隔很长)</p>
<p>答案是否定的:因为p1和p2指向了相同的地址,所以条件永远不成立!为什么呢?因为我们没有在调用localtime之前给p1和p2分配空间(栈,堆),而是用一个指针去接函数的返回值,这样的话只有两种可能:</p>
<ul>
<li>每次函数内部都会new一个tm的对象,返回,这样外部必须手动释放才不至于内存泄露!</li>
<li>每次函数都返回同一块内存的指针,这样后一次的调用会覆盖前一次的结果!<br>所以我们必须自己去保存结果:<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">int</span> pre_tm_sec=p1-&gt;tm_sec;</span><br></pre></td></tr></table></figure>
</li>
</ul>
<p><strong>2.不同平台的差异:</strong></p>
<p>time_t在linux上的定义:<br><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="preprocessor">#<span class="keyword">ifndef</span> __TIME_T</span></span><br><span class="line"><span class="preprocessor">#<span class="keyword">define</span> __TIME_T     <span class="comment">/* 避免重复定义 time_t */</span></span></span><br><span class="line"><span class="keyword">typedef</span> <span class="keyword">long</span>     <span class="keyword">time_t</span>;    <span class="comment">/* 时间值time_t 为长整型的别名*/</span></span><br><span class="line"><span class="preprocessor">#<span class="keyword">endif</span></span></span><br></pre></td></tr></table></figure></p>
<p>有此可见time_t就是long,只占4个字节!</p>
<p>而在windows上:<br><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">typedef</span> __int64 <span class="keyword">__time64_t</span>;     <span class="comment">/* 64-bit time value */</span></span><br><span class="line"><span class="keyword">typedef</span> <span class="keyword">__time64_t</span> <span class="keyword">time_t</span>;      <span class="comment">/* time value */</span></span><br></pre></td></tr></table></figure></p>
<p>尼玛?坑爹的windows,这样time_t就是int64,占8个字节!</p>
<p>我曾经用long记下time_t类型的数据写入到存档中,结果就悲剧了,内存越界,死的心都有了!</p>
]]></content>
    </entry>
    
  
  
    
    <entry>
      <title></title>
      <url>http://blog.justbilt.com/404.html</url>
      <content type="html"><![CDATA[<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <title>
        Page not found (404) - Disqus
    </title>
    <script type="text/javascript">
    var totalCount = 8;
    function ChangeIt()
    {
        var num = Math.ceil( Math.random() * totalCount );
        document.body.background = '//media.disquscdn.com/errors/img/'+num+'.gif';
    document.body.style.backgroundRepeat = "repeat";// Background repeat
    }
    window.onload = ChangeIt;
    </script>
    <style>
        html {
            width: 100%;
            height: 100%;
        }

        body {
            position: relative;
            width: 100%;
            height: 100%;
            margin: 0;
            padding: 0;
            font-family: 'Source Sans Pro', 'Helvetica Neue', Helvetica, Arial, sans-serif;

            font-weight: 400;
            -webkit-font-smoothing: antialiased;
            -webkit-background-size: cover;
            -moz-background-size: cover;
            -o-background-size: cover;
            background-size: cover;
            background-repeat: no-repeat;
        }

        body:before {
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            z-index: -1;
            width: 100%;
            height: 700px;
            content: "";
            background: transparent;
            background-size: cover;
        }

        .global-header {
            width: 650px;
            margin: 0 auto;
            padding: 250px 0 50px 0;
            background: transparent;
            font-size: 16px;
        }

        .global-nav {
            text-align: center;
        }

        .logo {
            width:150px;
            margin: 0 auto;
            display: block;
            margin-top: 250px;
            margin-bottom: 50px;
        }

        ul {
            display: none;
        }

        .error-content {
            -moz-box-sizing: border-box;
            -webkit-box-sizing: border-box;
            box-sizing: border-box;
            line-height:24px;
            color:#55595d;
            width:500px;
            display: block;
            margin: 0 auto;
            background: rgba(255,255,255, 0.8);
            padding: 30px 40px;
        }

        h1 {
            text-align: center;
            margin-bottom: 30px;
            color:#546673;
            font-size: 24px;
            font-weight: 600;
        }

        a {
            color: #208be6;
            text-decoration: none;
        }

        a:hover {
            text-decoration: underline;
        }

        footer, .global-footer{
            display: none;

        }

    </style>
</head>

<body>
    <div class="wrapper">
        <div class="error-content">
            
        <h1>Uh oh... Something didn't work.</h1>
        <p>This page doesn't seem to exist. You might have followed a bad link or mistyped the address, feel free to try again.  Alternatively, you can <a href="http://blog.justbilt.com/">return to the home page</a>.</p>

        </div>
    </div>
</body>
</html>]]></content>
    </entry>
    
    <entry>
      <title><![CDATA[tags]]></title>
      <url>http://blog.justbilt.com/tags/index.html</url>
      <content type="html"></content>
    </entry>
    
    <entry>
      <title><![CDATA[读书]]></title>
      <url>http://blog.justbilt.com/reading/index.html</url>
      <content type="html"></content>
    </entry>
    
    <entry>
      <title><![CDATA[克里斯托弗]]></title>
      <url>http://blog.justbilt.com/links/index.html</url>
      <content type="html"><![CDATA[<pre><code>&quot;social&quot;: {
    &quot;weibo&quot;: &quot;http://weibo.com/justbilt&quot;,
    &quot;github&quot;: &quot;https://github.com/justbilt&quot;,
    &quot;rss&quot;: &quot;/atom.xml&quot;
},
&quot;extern&quot;: {
    &quot;Imbahom&quot;: &quot;http://blog.imbahom.com/&quot;,
    &quot;松阳&quot;: &quot;http://www.songyang.net/&quot;,
    &quot;ChildhoodAndy&quot;: &quot;http://dabing1022.github.io/&quot;,
    &quot;子龙山人&quot;: &quot;http://zilongshanren.com/&quot;,
    &quot;奇葩世界&quot;: &quot;http://qipa.world/&quot;
}
</code></pre>]]></content>
    </entry>
    
    <entry>
      <title><![CDATA[关于]]></title>
      <url>http://blog.justbilt.com/about/index.html</url>
      <content type="html"><![CDATA[<p>我是 bilt, 发音应该类似于 “biu油特” , 这个单词最开始是我自造的, 现在如果你词典去查的话, 会有一个 <strong>总胆红素</strong> 素的意思. 因为这个单词比较短, 所以我一般会在前面加一个 just , 这样合起来就是 <code>justbilt</code> 了.</p>
<p><img src="/favicon/logo.png" alt=""></p>
]]></content>
    </entry>
    
  
</search>
