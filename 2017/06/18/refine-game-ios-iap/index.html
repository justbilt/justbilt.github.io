<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge" />
  
  <title>优化游戏在 iOS 上的内购 | Justbilt</title>
  <meta name="description" content="A game developer" />
  <meta name="keywords" content="" />
  <meta name="HandheldFriendly" content="True" />
  <meta name="apple-mobile-web-app-capable" content="yes">
  <link rel="shortcut icon" href="/">
  <link rel="alternate" href="/atom.xml" title="Justbilt">
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
  <meta name="description" content="首先我们看下 iOS 内购的流程, 让我们看下官方的的流程图:">
<meta name="keywords" content="Quick-Cocos2d-x,iOS,IAP">
<meta property="og:type" content="article">
<meta property="og:title" content="优化游戏在 iOS 上的内购">
<meta property="og:url" content="http://blog.justbilt.com/2017/06/18/refine-game-ios-iap/index.html">
<meta property="og:site_name" content="Justbilt">
<meta property="og:description" content="首先我们看下 iOS 内购的流程, 让我们看下官方的的流程图:">
<meta property="og:image" content="https://developer.apple.com/library/content/documentation/NetworkingInternet/Conceptual/StoreKitGuide/Art/remote_store_fetch_2x.png">
<meta property="og:image" content="http://ww1.sinaimg.cn/large/7f870d23ly1fgw9pxzo6ej206q04jt96.jpg">
<meta property="og:image" content="http://ww1.sinaimg.cn/large/7f870d23ly1fgwqn64m5sj20ng09laai.jpg">
<meta property="og:updated_time" content="2017-07-09T03:09:19.000Z">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="优化游戏在 iOS 上的内购">
<meta name="twitter:description" content="首先我们看下 iOS 内购的流程, 让我们看下官方的的流程图:">
<meta name="twitter:image" content="https://developer.apple.com/library/content/documentation/NetworkingInternet/Conceptual/StoreKitGuide/Art/remote_store_fetch_2x.png">
    
  <link href="https://fonts.googleapis.com/css?family=Inconsolata|Titillium+Web" rel="stylesheet">
  <link href="https://fonts.googleapis.com/css?family=Roboto+Mono" rel="stylesheet">
  <link href='//cdn.bootcss.com/node-waves/0.7.5/waves.min.css' rel='stylesheet'>
  <link rel="stylesheet" href="/style.css">
  <script>
    function setLoadingBarProgress(num) {
      document.getElementById('loading-bar').style.width=num+"%";
    }
  </script>
</head>

<body>
  <div id="loading-bar-wrapper">
  <div id="loading-bar"></div>
</div>


  <script>setLoadingBarProgress(20)</script> 
  <header class="l_header">
	<div class='wrapper'>
		<div class="nav-main container container--flex">
			<a class="logo flat-box" href='/' >
				Justbilt
			</a>
			<div class='menu'>
				<ul class='h-list'>
					
						<li>
							<a class='flat-box nav-home' href='/'>
								Home
							</a>
						</li>
					
						<li>
							<a class='flat-box nav-archives' href='/archives'>
								Archives
							</a>
						</li>
					
						<li>
							<a class='flat-box nav-links' href='/links'>
								Links
							</a>
						</li>
					
						<li>
							<a class='flat-box nav-about' href='/about'>
								About
							</a>
						</li>
					
				</ul>
				<div class='underline'></div>
			</div>
			
				<div class="m_search">
					<form name="searchform" class="form u-search-form">
						<input type="text" class="input u-search-input" placeholder="Search" />
						<span class="icon icon-search"></span>
					</form>
				</div>
			
			<ul class='switcher h-list'>
				
					<li class='s-search'><a href='javascript:void(0)'><span class="icon icon-search flat-box"></span></a></li>
				
				<li class='s-menu'><a href='javascript:void(0)'><span class="icon icon-menu flat-box"></span></a></li>
			</ul>
		</div>
		
		<div class='nav-sub container container--flex'>
			<a class="logo" class="flat-box" href='javascript:void(0)'>
				Word of Forks
			</a>

			<ul class='switcher h-list'>
				<li class='s-comment'><a href='javascript:void(0)'><span class="icon icon-chat_bubble_outline flat-box"></span></a></li>
				<li class='s-top'><a href='javascript:void(0)'><span class="icon icon-arrow_upward flat-box"></span></a></li>
				<li class='s-toc'><a href='javascript:void(0)'><span class="icon icon-format_list_numbered flat-box"></span></a></li>
			</ul>
		</div>
	</div>
</header>
<aside class="menu-phone">
	<nav>
		
			<a href="/" class="nav-home nav">
				Home
			</a>
		
			<a href="/archives" class="nav-archives nav">
				Archives
			</a>
		
			<a href="/links" class="nav-links nav">
				Links
			</a>
		
			<a href="/about" class="nav-about nav">
				About
			</a>
		
	</nav>
</aside>

    <script>setLoadingBarProgress(40);</script>
  <div class="l_body">
    <div class='container clearfix'>
      <div class='l_main'>
        <article id="post-refine-game-ios-iap"
  class="post white-box article-type-post"
  itemscope itemprop="blogPost">
	<section class='meta'>
	<h2 class="title">
  	<a href="/2017/06/18/refine-game-ios-iap/">
    	优化游戏在 iOS 上的内购
    </a>
  </h2>
	<time>
	  6月 18, 2017
	</time>
	
	</section>
	
		<section class="toc-wrapper"><ol class="toc"><li class="toc-item toc-level-1"><a class="toc-link" href="#IAP-的代码实现"><span class="toc-number">1.</span> <span class="toc-text">IAP 的代码实现</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#SKPaymentQueue"><span class="toc-number">1.1.</span> <span class="toc-text">SKPaymentQueue</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#SKPaymentTransaction"><span class="toc-number">1.2.</span> <span class="toc-text">SKPaymentTransaction</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#1-添加充值监听"><span class="toc-number">1.3.</span> <span class="toc-text">1. 添加充值监听</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#2-请求商品数据"><span class="toc-number">1.4.</span> <span class="toc-text">2. 请求商品数据</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#3-购买"><span class="toc-number">1.5.</span> <span class="toc-text">3. 购买</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#充值流程的优化"><span class="toc-number">2.</span> <span class="toc-text">充值流程的优化</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#野生蛮长的第一阶段"><span class="toc-number">2.1.</span> <span class="toc-text">野生蛮长的第一阶段</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#始料不及的第二阶段"><span class="toc-number">2.2.</span> <span class="toc-text">始料不及的第二阶段</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#键入佳境的第三阶段"><span class="toc-number">2.3.</span> <span class="toc-text">键入佳境的第三阶段</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#锦上添花的第四阶段"><span class="toc-number">2.4.</span> <span class="toc-text">锦上添花的第四阶段</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#总结"><span class="toc-number">3.</span> <span class="toc-text">总结</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#1-返回-Game-层时因为内存不足游戏重启了怎么办"><span class="toc-number">3.1.</span> <span class="toc-text">1. 返回 Game 层时因为内存不足游戏重启了怎么办 ?</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#2-有玩家反应充值不到账怎么办"><span class="toc-number">3.2.</span> <span class="toc-text">2. 有玩家反应充值不到账怎么办 ?</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#3-如何防-IAP-破解"><span class="toc-number">3.3.</span> <span class="toc-text">3. 如何防 IAP 破解 ?</span></a></li></ol></li></ol></section>
	
	<section class="article typo">
  	<div class="article-entry" itemprop="articleBody">
    	<p>首先我们看下 iOS 内购的流程, 让我们看下官方的的流程图:</p>
<p><img src="https://developer.apple.com/library/content/documentation/NetworkingInternet/Conceptual/StoreKitGuide/Art/remote_store_fetch_2x.png" alt=""></p>
<a id="more"></a>
<p>很简单, 是不是 ? 作为一款游戏来说, 实际情况要复杂的多.首先要思考这么几个问题:</p>
<ol>
<li>返回 Game 层时因为内存不足游戏重启了怎么办 ?</li>
<li>有玩家反应充值不到账怎么办 ?</li>
<li>如何防 IAP 破解 ?</li>
</ol>
<p>作为一款可能在 “国内” 发售的游戏, 如果你们没有考虑过这些问题, 那可能会遇到很多的 “惊喜”. 有一点需要记住, 千万不要低估玩家的 “创造力”. </p>
<p>首先, 请允许用十分简单的几行代码带大家回顾下 IAP 的实现, 因为后面我们要讨论的内容全部是基于这个前提的. </p>
<h1 id="IAP-的代码实现"><a href="#IAP-的代码实现" class="headerlink" title="IAP 的代码实现"></a>IAP 的代码实现</h1><p>要开启内购很简单, 两个对象三个步骤就搞定了. </p>
<p>我们先来说说这两个对象, 分别是 <code>SKPaymentQueue</code> 和 <code>SKPaymentTransaction</code> , 前者是充值订单, 后者是充值队列.</p>
<h2 id="SKPaymentQueue"><a href="#SKPaymentQueue" class="headerlink" title="SKPaymentQueue"></a>SKPaymentQueue</h2><p>它是整个充值的核心, 负责串联充值的各个流程. 可以用这个对象实现发起购买, 恢复已经购买的物品, 结束购买, 监听充值事件等功能.</p>
<h2 id="SKPaymentTransaction"><a href="#SKPaymentTransaction" class="headerlink" title="SKPaymentTransaction"></a>SKPaymentTransaction</h2><p>前面说过它是充值的订单对象, 每一次充值的发起都会产生一个唯一的订单对象, 它记录有这个订单的状态, id, 时间, 收据的信息.</p>
<p>其中收据(<code>transactionReceipt</code>)是最重要的数据, 它是这次充值是否真正扣款成功的唯一条件. 我们要把它发送给我们的游戏服务器, 再向苹果的服务器进行验证.</p>
<p>下面来说说三个步骤:</p>
<h2 id="1-添加充值监听"><a href="#1-添加充值监听" class="headerlink" title="1. 添加充值监听"></a>1. 添加充值监听</h2><p>添加监听的逻辑很简单, 就下面这三行:</p>
<figure class="highlight objc"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">if</span> ([<span class="built_in">SKPaymentQueue</span> defaultQueue]) &#123;</div><div class="line">    [[<span class="built_in">SKPaymentQueue</span> defaultQueue] addTransactionObserver:<span class="keyword">self</span>];</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>但是这个 <code>self</code> 必须是一个实现了 <code>SKPaymentTransactionObserver</code> 的类的实例, 当有充值的事件时, 类的 <code>updatedTransactions</code> 函数会被调用:</p>
<figure class="highlight objc"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div></pre></td><td class="code"><pre><div class="line"><span class="comment">//.h</span></div><div class="line"><span class="class"><span class="keyword">@interface</span> <span class="title">IAPHelper</span> : <span class="title">NSObject</span> &lt;<span class="title">SKPaymentTransactionObserver</span>&gt;</span></div><div class="line"></div><div class="line"><span class="comment">//.m</span></div><div class="line"><span class="class"><span class="keyword">@implementation</span> <span class="title">IAPHelper</span></span></div><div class="line">- (<span class="keyword">void</span>)paymentQueue:(<span class="built_in">SKPaymentQueue</span> *)queue updatedTransactions:(<span class="built_in">NSArray</span> *)transactions</div><div class="line">&#123;</div><div class="line">    <span class="keyword">for</span> (<span class="built_in">SKPaymentTransaction</span> *transaction <span class="keyword">in</span> transactions)</div><div class="line">    &#123;</div><div class="line">        <span class="keyword">switch</span> (transaction.transactionState)</div><div class="line">        &#123;</div><div class="line">            <span class="keyword">case</span> <span class="built_in">SKPaymentTransactionStatePurchased</span>: </div><div class="line">                <span class="comment">// 处理支付成功</span></div><div class="line">                [[<span class="built_in">SKPaymentQueue</span> defaultQueue] finishTransaction: transaction];</div><div class="line">                <span class="keyword">break</span>;</div><div class="line">            <span class="keyword">case</span> <span class="built_in">SKPaymentTransactionStateFailed</span>: <span class="comment">// 支付失败</span></div><div class="line">                <span class="comment">// 处理支付失败</span></div><div class="line">                [[<span class="built_in">SKPaymentQueue</span> defaultQueue] finishTransaction: transaction];</div><div class="line">                <span class="keyword">break</span>;</div><div class="line">            <span class="keyword">case</span> <span class="built_in">SKPaymentTransactionStateRestored</span>: <span class="comment">// 恢复内购</span></div><div class="line">                <span class="comment">// 处理恢复内购</span></div><div class="line">                [[<span class="built_in">SKPaymentQueue</span> defaultQueue] finishTransaction: transaction];</div><div class="line">                <span class="keyword">break</span>;</div><div class="line">            <span class="keyword">default</span>:</div><div class="line">                <span class="keyword">break</span>;</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line">&#125;</div><div class="line"><span class="keyword">@end</span></div></pre></td></tr></table></figure>
<h2 id="2-请求商品数据"><a href="#2-请求商品数据" class="headerlink" title="2. 请求商品数据"></a>2. 请求商品数据</h2><p>在开始购买之前, 我们需要知道商品的数据, 比如价格, 描述之类的, 这就需要我们先请请求商品的数据:</p>
<figure class="highlight objc"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line"><span class="built_in">SKProductsRequest</span>* request = [[<span class="built_in">SKProductsRequest</span> alloc] initWithProductIdentifiers:@[<span class="string">@"com.xxx.xxx.01"</span>, <span class="string">@"com.xxx.xxx.02"</span>]];</div><div class="line">request.delegate = <span class="keyword">self</span>;</div><div class="line">[request start];</div></pre></td></tr></table></figure>
<p>上面就是请求商品的代码, 商品的 id 列表是需要我们自己准备的. 请求的结果会通过一个函数来通知我们, 同样我们需要实现一个代理 <code>SKProductsRequestDelegate</code>:</p>
<figure class="highlight objc"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div></pre></td><td class="code"><pre><div class="line"><span class="comment">//.h</span></div><div class="line"><span class="class"><span class="keyword">@interface</span> <span class="title">IAPHelper</span> : <span class="title">NSObject</span> &lt;<span class="title">SKProductsRequestDelegate</span>&gt;</span></div><div class="line"></div><div class="line"><span class="comment">//.mm</span></div><div class="line"><span class="class"><span class="keyword">@implementation</span> <span class="title">IAPHelper</span></span></div><div class="line">- (<span class="keyword">void</span>)productsRequest:(<span class="built_in">SKProductsRequest</span> *)request didReceiveResponse:(<span class="built_in">SKProductsResponse</span> *)response &#123;</div><div class="line">    <span class="built_in">NSArray</span>* products = response.products;</div><div class="line">    <span class="comment">// products 就是商品的列表</span></div><div class="line">&#125;</div><div class="line"><span class="keyword">@end</span></div></pre></td></tr></table></figure>
<h2 id="3-购买"><a href="#3-购买" class="headerlink" title="3. 购买"></a>3. 购买</h2><p>发起一次购买的逻辑:</p>
<figure class="highlight objc"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line"><span class="built_in">SKPayment</span> *payment = [<span class="built_in">SKPayment</span> paymentWithProduct:<span class="string">@"com.xxx.xxx.01"</span>];</div><div class="line"></div><div class="line"><span class="keyword">if</span> ([<span class="built_in">SKPaymentQueue</span> defaultQueue]) &#123;</div><div class="line">    [[<span class="built_in">SKPaymentQueue</span> defaultQueue] addPayment:payment];</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>下面就会进入到我们之前添加的那个充值状态的监听逻辑中去.</p>
<h1 id="充值流程的优化"><a href="#充值流程的优化" class="headerlink" title="充值流程的优化"></a>充值流程的优化</h1><p>流程方面, 我们大概经过了这么下面几个阶段.</p>
<h2 id="野生蛮长的第一阶段"><a href="#野生蛮长的第一阶段" class="headerlink" title="野生蛮长的第一阶段"></a>野生蛮长的第一阶段</h2><p>这一阶段的特征是: <code>先完成交易, 后处理订单</code>, 如果仔细观察上面 <code>updatedTransactions</code> 的逻辑的话, 可以看到这样的一行代码:</p>
<figure class="highlight objc"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">[[<span class="built_in">SKPaymentQueue</span> defaultQueue] finishTransaction: transaction];</div></pre></td></tr></table></figure>
<p>这行代码的意义就是标记这个订单已经完成了, 苹果从此以后不会再去通知你这个订单的任何消息了. 在调用这行代码之前, 我们会去处理一些充值结果的逻辑, 其中充值成功我们是要去苹果验证收据的.</p>
<p>但是验证的这个过程是异步的, 所以可能发生的问题就是:</p>
<blockquote>
<p>在验证结果回来之前就关闭了订单.</p>
</blockquote>
<p>因此若是验证的过程不够顺利, 比如网络状况不佳, 应用意外退出, 就会导致玩家的这次充值没有到账.</p>
<h2 id="始料不及的第二阶段"><a href="#始料不及的第二阶段" class="headerlink" title="始料不及的第二阶段"></a>始料不及的第二阶段</h2><p>有了上面那个问题, 我们不禁会想 ? 是不是可以等收到验证结果再去完成订单. 答案是肯定的, 我们确实可以这样做, 苹果也很仁义, 没有完成的订单会在下次请求商品时再次通知我们充值成功.</p>
<p>简单验证之后, 我们修改了充值的逻辑, 信心满满的上线了. 上线之初确实很顺利, 反馈充值不到账的玩家数量降低了很多, 我们都陷入了巨大的喜悦之中, 再也不会有玩家反应充值不到账了, oh yeah ! </p>
<p>然后, 后面发生的事情却是我们始料不及的. 我们陆续收到了用户声泪俱下的控诉, 自己是多么多么的热爱这款游戏, 但是却无法享受充值带来的乐趣. 起初还只是可能不到账, 现在则是某一个充值项完全无法购买.</p>
<p>在诸多玩家的控诉中, 我们逐渐还原了问题的成因. 某一次充值成功后游戏重启, 没有收到钻石, 再次购买该商品则会提示:</p>
<p><img src="http://ww1.sinaimg.cn/large/7f870d23ly1fgw9pxzo6ej206q04jt96.jpg" alt=""></p>
<blockquote>
<p>您已购买此 App 内购买项目。此项目将免费恢复。</p>
</blockquote>
<p>根据这个反馈可以很轻易的推断出是因为我们没有 <code>finishTransaction</code> 某一笔订单的原因, 但是却很难重现玩家所遇到的问题. 我们也复现过这个问题, 但是都能够在重启后自动解决. 我们也加了很多埋点去统计玩家的日志, 发现玩家似乎进入了一个卡单的状态, 程序无法获取到某些未完成的订单.</p>
<p>这个问题困扰了我们好久, 而且反馈的玩家越来越多, 有的玩家甚至已经没有可以能够购买的商品了.</p>
<h2 id="键入佳境的第三阶段"><a href="#键入佳境的第三阶段" class="headerlink" title="键入佳境的第三阶段"></a>键入佳境的第三阶段</h2><p>虽然上面的问题我们可以将锅甩给苹果, 但是实在受到损失的是我们, 因此还是需要解决这个问题. 经过讨论之后, 我们将目光又转回了第一阶段的方案, 看能否改进哪个方案. </p>
<blockquote>
<p>我们可以先将订单数据保存在本地, 然后发起验证请求, 关闭订单, 等验证成功后删除本地保存的订单.</p>
</blockquote>
<p>下次启动游戏或者充值时, 我们可以先检查下本地是否有缓存的订单, 有的话就先尝试验证这个订单. 虽然还有一些瑕疵, 比如玩家删除掉应用后就再也找不回之前的订单了, 但是已经是一个很不错的方案了.</p>
<p>下面我们来实现一下:</p>
<figure class="highlight objc"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div></pre></td><td class="code"><pre><div class="line">- (<span class="built_in">NSString</span>*)getRecordTransaction</div><div class="line">&#123;</div><div class="line"><span class="meta">#if USE_ICLOUD_STORAGE</span></div><div class="line">    <span class="built_in">NSUbiquitousKeyValueStore</span> *storage = [<span class="built_in">NSUbiquitousKeyValueStore</span> defaultStore];</div><div class="line"><span class="meta">#else</span></div><div class="line">    <span class="built_in">NSUserDefaults</span> *storage = [<span class="built_in">NSUserDefaults</span> standardUserDefaults];</div><div class="line"><span class="meta">#endif</span></div><div class="line">    </div><div class="line">    <span class="built_in">NSArray</span> *saved_transactions = [storage arrayForKey:<span class="string">@"transactions"</span>];</div><div class="line">    <span class="keyword">if</span> (!saved_transactions or [saved_transactions count] &lt;= <span class="number">0</span>) &#123;</div><div class="line">        <span class="keyword">return</span> nullptr;</div><div class="line">    &#125;</div><div class="line">    <span class="keyword">return</span> [saved_transactions objectAtIndex:<span class="number">0</span>];</div><div class="line">&#125;</div><div class="line"></div><div class="line">- (<span class="keyword">void</span>)recordTransaction:(<span class="built_in">NSString</span> *)transaction</div><div class="line">&#123;</div><div class="line"><span class="meta">#if USE_ICLOUD_STORAGE</span></div><div class="line">    <span class="built_in">NSUbiquitousKeyValueStore</span> *storage = [<span class="built_in">NSUbiquitousKeyValueStore</span> defaultStore];</div><div class="line"><span class="meta">#else</span></div><div class="line">    <span class="built_in">NSUserDefaults</span> *storage = [<span class="built_in">NSUserDefaults</span> standardUserDefaults];</div><div class="line"><span class="meta">#endif</span></div><div class="line">    </div><div class="line">    <span class="built_in">NSArray</span> *saved_transactions = [storage arrayForKey:<span class="string">@"transactions"</span>];</div><div class="line">    <span class="keyword">if</span> (!saved_transactions) &#123;</div><div class="line">        <span class="comment">// Storing the first receipt</span></div><div class="line">        [storage setObject:@[transaction] forKey:<span class="string">@"transactions"</span>];</div><div class="line">    &#125; <span class="keyword">else</span> &#123;</div><div class="line">        <span class="comment">// Adding another receipt</span></div><div class="line">        <span class="built_in">NSArray</span> *updated_transactions = [saved_transactions arrayByAddingObject:transaction];</div><div class="line">        [storage setObject:updated_transactions forKey:<span class="string">@"transactions"</span>];</div><div class="line">    &#125;</div><div class="line">    </div><div class="line">    [storage synchronize];</div><div class="line">&#125;</div><div class="line"></div><div class="line">- (<span class="keyword">void</span>)removeRecordTransaction:(<span class="built_in">NSString</span> *)purchase_id transactionId:(<span class="built_in">NSString</span>*) transaction_id</div><div class="line">&#123;</div><div class="line"><span class="meta">#if USE_ICLOUD_STORAGE</span></div><div class="line">    <span class="built_in">NSUbiquitousKeyValueStore</span> *storage = [<span class="built_in">NSUbiquitousKeyValueStore</span> defaultStore];</div><div class="line"><span class="meta">#else</span></div><div class="line">    <span class="built_in">NSUserDefaults</span> *storage = [<span class="built_in">NSUserDefaults</span> standardUserDefaults];</div><div class="line"><span class="meta">#endif</span></div><div class="line">    </div><div class="line">    <span class="built_in">NSMutableArray</span> *saved_transactions = [<span class="built_in">NSMutableArray</span> arrayWithArray:[storage arrayForKey:<span class="string">@"transactions"</span>]];</div><div class="line">    <span class="keyword">if</span> (!saved_transactions or [saved_transactions count] &lt;= <span class="number">0</span>) &#123;</div><div class="line">        <span class="keyword">return</span>;</div><div class="line">    &#125;</div><div class="line">    </div><div class="line">    <span class="keyword">int</span> index = <span class="number">0</span>;</div><div class="line">    <span class="keyword">for</span> (<span class="built_in">NSString</span>* transaction <span class="keyword">in</span> saved_transactions) &#123;</div><div class="line">        <span class="keyword">if</span> ([transaction rangeOfString:purchase_id].location != <span class="built_in">NSNotFound</span> and (not transaction_id or ([transaction rangeOfString:transaction_id].location != <span class="built_in">NSNotFound</span>))) &#123;</div><div class="line">            [saved_transactions removeObjectAtIndex:index];</div><div class="line">            [storage setObject:saved_transactions forKey:<span class="string">@"transactions"</span>];</div><div class="line">            [storage synchronize];</div><div class="line">            <span class="keyword">return</span>;</div><div class="line">        &#125;</div><div class="line">        index = index + <span class="number">1</span>;</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>这里我们实现了存储, 获取, 删除的逻辑, 只是参数是 <code>NSString</code> 类型而不是 <code>SKPaymentTransaction</code>. 它其实是 Transaction 的一些有用的数据和我们自己的一些信息放的一个到了一个 <code>NSDictionary</code> 中, 然后将这个 dict 转化为 json 的字符串, 这样做是为了方便存储.</p>
<h2 id="锦上添花的第四阶段"><a href="#锦上添花的第四阶段" class="headerlink" title="锦上添花的第四阶段"></a>锦上添花的第四阶段</h2><p>其实第三阶段的逻辑已经很严谨了, 我们为了更好的了解玩家的充值行为, 加了很多的日志在这里:</p>
<ol>
<li>我们存下了玩家的所有充值结果, 成功的, 失败的, 取消的, 异常的.</li>
<li>我们存下了玩家在充值界面的各种操作, 比如点击按钮, 界面跳转等.</li>
</ol>
<p>在合适的时候, 将这些日志发送到服务器. 这些日志将会成为后面分析玩家行为, 解决纠纷的重要依据.</p>
<h1 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h1><p>我用 ProcessOn 制作了一个全新的流程图, 地址在<a href="https://www.processon.com/view/link/594e7af4e4b0ad619ac50bd4" target="_blank" rel="external">这里</a>:</p>
<p><img src="http://ww1.sinaimg.cn/large/7f870d23ly1fgwqn64m5sj20ng09laai.jpg" alt=""></p>
<p>现在在回答下上面提出的几个问题:</p>
<h2 id="1-返回-Game-层时因为内存不足游戏重启了怎么办"><a href="#1-返回-Game-层时因为内存不足游戏重启了怎么办" class="headerlink" title="1. 返回 Game 层时因为内存不足游戏重启了怎么办 ?"></a>1. 返回 Game 层时因为内存不足游戏重启了怎么办 ?</h2><p>答: 我们在本地存储了充值订单, 游戏会重启, 但这个本地存储不会自动删除.</p>
<h2 id="2-有玩家反应充值不到账怎么办"><a href="#2-有玩家反应充值不到账怎么办" class="headerlink" title="2. 有玩家反应充值不到账怎么办 ?"></a>2. 有玩家反应充值不到账怎么办 ?</h2><p>答: 这里我们要解决两个问题:</p>
<ol>
<li>是否真的没有到账 ?</li>
</ol>
<p>可能是实际已经到账了, 只是玩家没有发现, 这个需要后端查询玩家的钻石变化后向玩家解释清楚.</p>
<ol>
<li>是否真的充值成功 ?</li>
</ol>
<p>这个首先要玩家提供苹果充值收据邮件截图, 但是这个是可以伪造的, 但是可以阻挡一部分心怀不轨的玩家. 再根据我们前面收集的日志, 加上这个账号历史行为作出一个判断, 是否要给这个玩家补单.</p>
<h2 id="3-如何防-IAP-破解"><a href="#3-如何防-IAP-破解" class="headerlink" title="3. 如何防 IAP 破解 ?"></a>3. 如何防 IAP 破解 ?</h2><p>这个对于网游来说, 很简单, 就像在服务器端向苹果充值服务器发起验证. 需要注意的是: 服务器端在向苹果验证收据时, 一定要先检查<code>订单的唯一性</code>, <code>充值时间</code>, <code>商品id</code> 是否正常.</p>

  	</div>
	  
	  <div class="article-tags tags">
      
        <a href="/tags/Quick-Cocos2d-x/">Quick-Cocos2d-x</a>
      
        <a href="/tags/iOS/">iOS</a>
      
        <a href="/tags/IAP/">IAP</a>
      
	  </div>
    
	</section>
	
		<section id="comments">
			<div id="disqus_thread"></div>
		</section>
	
</article>
<script>
	window.subData = {
		title: '优化游戏在 iOS 上的内购',
		tools: true
	}
</script>

      </div>
      <aside class='l_side'>
        
  <section class='m_widget about'>

<img class='avatar waves-image' src='/favicon/slogon.gif' />

<div class='header'>justbilt</div>
<div class='content'>
<div class='desc'>"Only learning can make me happy"</div>
</div>
</section>

  
<div class="m_widget tagcloud">
    <div class="header">Tags</div>
    <div class='content'>
        <a href="/tags/Android/" style="font-size: 14px; color: #808080">Android</a> <a href="/tags/CCRenderTexture/" style="font-size: 14px; color: #808080">CCRenderTexture</a> <a href="/tags/EditBox/" style="font-size: 14px; color: #808080">EditBox</a> <a href="/tags/Electron/" style="font-size: 14px; color: #808080">Electron</a> <a href="/tags/FAlign/" style="font-size: 14px; color: #808080">FAlign</a> <a href="/tags/IAB/" style="font-size: 14px; color: #808080">IAB</a> <a href="/tags/IAP/" style="font-size: 14px; color: #808080">IAP</a> <a href="/tags/Lua/" style="font-size: 14.75px; color: #707070">Lua</a> <a href="/tags/MemoryLeak/" style="font-size: 14px; color: #808080">MemoryLeak</a> <a href="/tags/MyGUI/" style="font-size: 14.75px; color: #707070">MyGUI</a> <a href="/tags/PyQt/" style="font-size: 14.75px; color: #707070">PyQt</a> <a href="/tags/Quick-Cocos2d-x/" style="font-size: 20px; color: #000">Quick-Cocos2d-x</a> <a href="/tags/QuickxDev/" style="font-size: 14.75px; color: #707070">QuickxDev</a> <a href="/tags/TableView/" style="font-size: 14px; color: #808080">TableView</a> <a href="/tags/TexturePacker/" style="font-size: 14px; color: #808080">TexturePacker</a> <a href="/tags/TiledMap/" style="font-size: 14px; color: #808080">TiledMap</a> <a href="/tags/Tool/" style="font-size: 18.5px; color: #202020">Tool</a> <a href="/tags/blog/" style="font-size: 14.75px; color: #707070">blog</a> <a href="/tags/cocos2d-x/" style="font-size: 17.75px; color: #303030">cocos2d-x</a> <a href="/tags/code-style/" style="font-size: 14.75px; color: #707070">code-style</a> <a href="/tags/comment/" style="font-size: 14px; color: #808080">comment</a> <a href="/tags/convert2fnt/" style="font-size: 14.75px; color: #707070">convert2fnt</a> <a href="/tags/crash/" style="font-size: 14.75px; color: #707070">crash</a> <a href="/tags/duoshuo/" style="font-size: 14px; color: #808080">duoshuo</a> <a href="/tags/git/" style="font-size: 14px; color: #808080">git</a> <a href="/tags/hotupdate/" style="font-size: 14.75px; color: #707070">hotupdate</a> <a href="/tags/i18n/" style="font-size: 14px; color: #808080">i18n</a> <a href="/tags/iOS/" style="font-size: 19.25px; color: #101010">iOS</a> <a href="/tags/iOS-Dev-Tips/" style="font-size: 17px; color: #404040">iOS-Dev-Tips</a> <a href="/tags/ldoc/" style="font-size: 14px; color: #808080">ldoc</a> <a href="/tags/neat-freak/" style="font-size: 15.5px; color: #606060">neat-freak</a> <a href="/tags/pyqtdeploy/" style="font-size: 14px; color: #808080">pyqtdeploy</a> <a href="/tags/python/" style="font-size: 14px; color: #808080">python</a> <a href="/tags/spine/" style="font-size: 14px; color: #808080">spine</a> <a href="/tags/untp/" style="font-size: 15.5px; color: #606060">untp</a> <a href="/tags/utf8/" style="font-size: 14px; color: #808080">utf8</a> <a href="/tags/videoplayer/" style="font-size: 14px; color: #808080">videoplayer</a> <a href="/tags/优化/" style="font-size: 14.75px; color: #707070">优化</a> <a href="/tags/年结/" style="font-size: 16.25px; color: #505050">年结</a> <a href="/tags/手机游戏攻防/" style="font-size: 15.5px; color: #606060">手机游戏攻防</a> <a href="/tags/批量打包/" style="font-size: 14px; color: #808080">批量打包</a> <a href="/tags/游戏心得/" style="font-size: 18.5px; color: #202020">游戏心得</a> <a href="/tags/生活/" style="font-size: 14.75px; color: #707070">生活</a> <a href="/tags/音效/" style="font-size: 14.75px; color: #707070">音效</a>
    </div>
</div>



      </aside>
      <script>setLoadingBarProgress(60);</script>
    </div>
  </div>
  <footer id="footer" class="clearfix">

	<div class="social-wrapper">
  	
      
        <a href="https://github.com/justbilt" class="social github"
          target="_blank" rel="external">
          <span class="icon icon-github"></span>
        </a>
      
        <a href="https://weibo.com/justbilt" class="social weibo"
          target="_blank" rel="external">
          <span class="icon icon-weibo"></span>
        </a>
      
        <a href="/atom.xml" class="social rss"
          target="_blank" rel="external">
          <span class="icon icon-rss"></span>
        </a>
      
    
  </div>
  
  <div>Theme <a href='https://github.com/stkevintan/hexo-theme-material-flow' class="codename">MaterialFlow</a> designed by <a href="http://keyin.me/" target="_blank">Kevin Tan</a>.</div>
  
</footer>


  <script>setLoadingBarProgress(80);</script>
  
<script>
  var disqus_shortname = 'justbilt';
  
  var disqus_url = 'http://blog.justbilt.com/2017/06/18/refine-game-ios-iap/';
  
  (function(){
    var dsq = document.createElement('script');
    dsq.type = 'text/javascript';
    dsq.async = true;
    dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
    (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
  })();
</script>


<script src="//apps.bdimg.com/libs/jquery/2.1.4/jquery.min.js"></script>
<script src='//cdn.bootcss.com/node-waves/0.7.5/waves.min.js'></script>
<script src="//cdn.bootcss.com/scrollReveal.js/3.3.2/scrollreveal.min.js"></script>
<script src="/js/jquery.fitvids.js"></script>
<script>
	var GOOGLE_CUSTOM_SEARCH_API_KEY = "";
	var GOOGLE_CUSTOM_SEARCH_ENGINE_ID = "";
	var ALGOLIA_API_KEY = "";
	var ALGOLIA_APP_ID = "";
	var ALGOLIA_INDEX_NAME = "";
  var AZURE_SERVICE_NAME = "";
  var AZURE_INDEX_NAME = "";
  var AZURE_QUERY_KEY = "";
  var BAIDU_API_ID = "";
  var SEARCH_SERVICE = "hexo";
  var ROOT = "/"||"/";
  if(!ROOT.endsWith('/'))ROOT += '/';
</script>
<script src="/js/search.js"></script>
<script src="/js/app.js"></script>


  <script>setLoadingBarProgress(100);</script>
</body>
</html>
